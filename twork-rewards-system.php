<?php

/**
 * Plugin Name: T-Work Rewards System
 * Description: Creates a pending reward transaction when an order is placed. Admin can set points. App profile shows "My Points" only.
 * Version: 1.0.0
 * Author: T-Work System
 * Text Domain: twork-rewards
 * Requires at least: 5.0
 * Requires PHP: 7.4
 * WC requires at least: 5.0
 */
if (!defined('ABSPATH')) {
    exit;
}

define('TWORK_REWARDS_VERSION', '1.0.0');
define('TWORK_REWARDS_PLUGIN_DIR', plugin_dir_path(__FILE__));

class TWork_Rewards_System
{
    private static $instance = null;

    private const OPTION_LUCKYBOX_ENABLED = 'twork_rewards_luckybox_enabled';
    private const OPTION_LUCKYBOX_BANNER = 'twork_rewards_luckybox_banner';
    private const USER_META_LUCKYBOX_ENABLED = 'twork_luckybox_enabled';


    // User Page Settings Constants
    private const OPTION_USER_PAGE_PER_PAGE = 'twork_rewards_user_page_per_page';
    private const OPTION_USER_PAGE_DEFAULT_SORT = 'twork_rewards_user_page_default_sort';
    private const OPTION_USER_PAGE_DEFAULT_ORDER = 'twork_rewards_user_page_default_order';
    private const OPTION_USER_PAGE_DEFAULT_ACTIVITY_FILTER = 'twork_rewards_user_page_default_activity_filter';
    private const OPTION_USER_PAGE_INACTIVITY_THRESHOLD = 'twork_rewards_user_page_inactivity_threshold';
    private const OPTION_USER_PAGE_SHOW_STATS = 'twork_rewards_user_page_show_stats';
    private const OPTION_USER_PAGE_SHOW_ACTIVITY_SCORE = 'twork_rewards_user_page_show_activity_score';
    private const OPTION_USER_PAGE_SHOW_PHONE = 'twork_rewards_user_page_show_phone';
    private const OPTION_USER_PAGE_SHOW_LAST_UPDATED = 'twork_rewards_user_page_show_last_updated';
    private const OPTION_USER_PAGE_SHOW_ACTIVITY_BADGE = 'twork_rewards_user_page_show_activity_badge';
    private const OPTION_USER_PAGE_ENABLE_EXPORT = 'twork_rewards_user_page_enable_export';
    private const OPTION_USER_PAGE_EXPORT_FORMAT = 'twork_rewards_user_page_export_format';
    private const OPTION_USER_PAGE_BATCH_SIZE = 'twork_rewards_user_page_batch_size';
    private const OPTION_USER_PAGE_ENABLE_CACHING = 'twork_rewards_user_page_enable_caching';
    private const OPTION_USER_PAGE_CACHE_DURATION = 'twork_rewards_user_page_cache_duration';
    private const OPTION_USER_PAGE_SHOW_SEARCH = 'twork_rewards_user_page_show_search';
    private const OPTION_USER_PAGE_SHOW_FILTERS = 'twork_rewards_user_page_show_filters';
    private const OPTION_USER_PAGE_SHOW_PAGINATION = 'twork_rewards_user_page_show_pagination';
    private const OPTION_USER_PAGE_ACTIVITY_SCORE_WEIGHT_LOGIN = 'twork_rewards_user_page_activity_score_weight_login';
    private const OPTION_USER_PAGE_ACTIVITY_SCORE_WEIGHT_ORDER = 'twork_rewards_user_page_activity_score_weight_order';
    private const OPTION_USER_PAGE_ACTIVITY_SCORE_WEIGHT_TRANSACTION = 'twork_rewards_user_page_activity_score_weight_transaction';
    private const OPTION_USER_PAGE_DATE_FORMAT = 'twork_rewards_user_page_date_format';
    private const OPTION_USER_PAGE_TIME_FORMAT = 'twork_rewards_user_page_time_format';
    private const OPTION_USER_PAGE_SHOW_AVATAR = 'twork_rewards_user_page_show_avatar';
    private const OPTION_USER_PAGE_SHOW_EMAIL = 'twork_rewards_user_page_show_email';
    private const OPTION_USER_PAGE_SHOW_POINTS = 'twork_rewards_user_page_show_points';
    private const OPTION_USER_PAGE_COLUMNS_ORDER = 'twork_rewards_user_page_columns_order';
    private const OPTION_USER_PAGE_ENABLE_BULK_ACTIONS = 'twork_rewards_user_page_enable_bulk_actions';
    private const OPTION_USER_PAGE_SHOW_QUICK_ACTIONS = 'twork_rewards_user_page_show_quick_actions';
    private const OPTION_USER_PAGE_DEFAULT_VIEW = 'twork_rewards_user_page_default_view';
    private const OPTION_USER_PAGE_ENABLE_ADVANCED_FILTERS = 'twork_rewards_user_page_enable_advanced_filters';
    private const OPTION_USER_PAGE_SHOW_USER_TIER = 'twork_rewards_user_page_show_user_tier';
    private const OPTION_USER_PAGE_SHOW_REGISTRATION_DATE = 'twork_rewards_user_page_show_registration_date';
    private const OPTION_USER_PAGE_SHOW_TOTAL_TRANSACTIONS = 'twork_rewards_user_page_show_total_transactions';
    private const OPTION_USER_PAGE_ENABLE_REAL_TIME_UPDATES = 'twork_rewards_user_page_enable_real_time_updates';
    private const OPTION_USER_PAGE_AUTO_REFRESH_INTERVAL = 'twork_rewards_user_page_auto_refresh_interval';

    public static function get_instance()
    {
        if (null === self::$instance) {
            self::$instance = new self();
        }
        return self::$instance;
    }

    private function __construct()
    {
        $this->init_hooks();
    }

    private function init_hooks()
    {
        register_activation_hook(__FILE__, array($this, 'activate'));

        add_action('plugins_loaded', array($this, 'init'));

        // REST API: Register routes early with high priority to ensure they're available
        // Priority 5 ensures routes are registered before most other plugins
        // CRITICAL: Must hook into rest_api_init to register routes
        add_action('rest_api_init', array($this, 'register_all_rest_routes'), 5);

        // WooCommerce: create pending reward transaction when order is placed
        add_action('woocommerce_new_order', array($this, 'create_pending_reward_transaction'), 10, 1);
        add_action('woocommerce_checkout_order_processed', array($this, 'create_pending_reward_transaction'), 20, 1);

        // Admin UI
        add_action('admin_menu', array($this, 'add_admin_menu'));

        // User profile field
        add_action('show_user_profile', array($this, 'render_user_profile_rewards'));
        add_action('edit_user_profile', array($this, 'render_user_profile_rewards'));
        add_action('personal_options_update', array($this, 'save_user_profile_rewards'));
        add_action('edit_user_profile_update', array($this, 'save_user_profile_rewards'));

        // REST API: inject my_points into user endpoint (for the app profile)
        add_filter('rest_prepare_user', array($this, 'add_custom_fields_to_user_rest_api'), 10, 3);

        // Form handlers
        add_action('admin_post_twork_rewards_save_settings', array($this, 'handle_settings_save'));
        add_action('admin_post_twork_rewards_update_transaction', array($this, 'handle_transaction_update'));
        add_action('admin_post_twork_rewards_update_user_luckybox', array($this, 'handle_user_luckybox_update'));
        add_action('admin_post_twork_rewards_save_code', array($this, 'handle_code_save'));
        add_action('admin_post_twork_rewards_delete_code', array($this, 'handle_code_delete'));
        add_action('admin_post_twork_rewards_handle_exchange', array($this, 'handle_exchange_action'));
        add_action('admin_post_twork_rewards_save_exchange', array($this, 'handle_exchange_save'));
        add_action('admin_post_twork_rewards_bulk_exchange_action', array($this, 'handle_bulk_exchange_action'));
        add_action('admin_post_twork_rewards_test_notification', array($this, 'handle_test_notification'));

        // PROFESSIONAL FEATURE: Point Tiers System handlers
        add_action('admin_post_twork_rewards_save_tier', array($this, 'handle_tier_save'));
        add_action('admin_post_twork_rewards_delete_tier', array($this, 'handle_tier_delete'));
        add_action('admin_post_twork_rewards_assign_user_tier', array($this, 'handle_user_tier_assign'));
        add_action('admin_post_twork_rewards_recalculate_tiers', array($this, 'handle_recalculate_tiers'));
        add_action('admin_post_twork_rewards_initialize_tiers', array($this, 'handle_initialize_tiers'));
        add_action('admin_post_twork_rewards_bulk_tier_action', array($this, 'handle_bulk_tier_action'));
        add_action('admin_post_twork_rewards_bulk_user_tier_action', array($this, 'handle_bulk_user_tier_action'));
        add_action('admin_post_twork_rewards_export_tiers', array($this, 'handle_export_tiers'));
        add_action('admin_post_twork_rewards_export_user_tiers', array($this, 'handle_export_user_tiers'));
        add_action('admin_post_twork_rewards_export_tier_history', array($this, 'handle_export_tier_history'));


        // Transaction delete handlers
        add_action('admin_post_twork_rewards_delete_transaction', array($this, 'handle_transaction_delete'));
        add_action('admin_post_twork_rewards_restore_transaction', array($this, 'handle_transaction_restore'));
        add_action('admin_post_twork_rewards_permanent_delete_transaction', array($this, 'handle_transaction_permanent_delete'));
        add_action('admin_post_twork_rewards_bulk_transaction_action', array($this, 'handle_bulk_transaction_action'));

        // Engagement Hub handlers
        add_action('admin_post_twork_rewards_save_engagement_item', array($this, 'handle_engagement_item_save'));
        add_action('admin_post_twork_rewards_delete_engagement_item', array($this, 'handle_engagement_item_delete'));
        add_action('admin_post_twork_rewards_save_engagement_settings', array($this, 'handle_engagement_settings_save'));
        add_action('admin_post_twork_rewards_save_page_content', array($this, 'handle_page_content_save'));
        add_action('admin_post_twork_rewards_save_faq', array($this, 'handle_faq_save'));
        add_action('admin_post_twork_rewards_delete_faq', array($this, 'handle_faq_delete'));
        add_action('admin_post_twork_rewards_save_about_us', array($this, 'handle_about_us_save'));

        // Usage tracking handlers
        add_action('admin_post_twork_rewards_export_usage', array($this, 'handle_usage_export'));
        add_action('admin_post_twork_rewards_create_usage_table', array($this, 'handle_create_usage_table'));

        // User Activity Tracking Hooks
        add_action('wp_login', array($this, 'track_user_login'), 10, 2);
        add_action('rest_api_init', array($this, 'track_rest_api_activity'), 999);  // High priority to catch all REST calls

        // Bulk operations handlers
        add_action('admin_post_twork_rewards_bulk_activity_action', array($this, 'handle_bulk_activity_action'));

        // Activity initialization handler
        add_action('admin_post_twork_rewards_initialize_activity', array($this, 'handle_initialize_activity'));

        // PROFESSIONAL FCM INTEGRATION: Invalidate token cache when FCM tokens are updated
        // This ensures notifications use fresh tokens from twork-fcm-notify plugin
        add_action('updated_user_meta', array($this, 'invalidate_fcm_cache_on_token_update'), 10, 4);
        add_action('added_user_meta', array($this, 'invalidate_fcm_cache_on_token_update'), 10, 4);
    }

    /**
     * Invalidate FCM token cache when tokens are updated
     *
     * PROFESSIONAL INTEGRATION: Works with twork-fcm-notify plugin
     * When tokens are registered via /twork/v1/register-token endpoint,
     * this hook ensures the cache is invalidated so fresh tokens are used
     *
     * @param int $meta_id Meta ID
     * @param int $user_id User ID
     * @param string $meta_key Meta key
     * @param mixed $meta_value Meta value
     */
    public function invalidate_fcm_cache_on_token_update($meta_id, $user_id, $meta_key, $meta_value)
    {
        // Only invalidate cache for FCM token updates (same meta key used by twork-fcm-notify plugin)
        if ($meta_key === 'twork_fcm_tokens') {
            $this->invalidate_fcm_token_cache($user_id);

            // Log for debugging
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf(
                    'T-Work Rewards: FCM token cache invalidated for user %d (tokens updated)',
                    $user_id
                ));
            }
        }
    }

    /**
     * Check if FCM notify plugin is active and functional
     *
     * @return bool True if FCM plugin is available
     */
    private function is_fcm_plugin_available()
    {
        // Check if twork_send_fcm function exists (from twork-fcm-notify plugin)
        $available = function_exists('twork_send_fcm');

        // Enhanced debugging
        if (defined('WP_DEBUG') && WP_DEBUG && !$available) {
            // Check if plugin might be loaded later
            if (did_action('plugins_loaded')) {
                error_log('T-Work Rewards: FCM plugin not available - twork_send_fcm function not found');
            }
        }

        return $available;
    }

    /**
     * Get notification system status for diagnostics
     *
     * @return array Status information
     */
    private function get_notification_system_status()
    {
        $status = array(
            'fcm_plugin_available' => $this->is_fcm_plugin_available(),
            'webhook_url_configured' => !empty(get_option('twork_rewards_webhook_url', '')),
            'webhook_url' => get_option('twork_rewards_webhook_url', ''),
            'total_users_with_tokens' => 0,
            'total_tokens' => 0,
        );

        // Count users with FCM tokens
        global $wpdb;
        $users_with_tokens = $wpdb->get_var(
            "SELECT COUNT(DISTINCT user_id) FROM {$wpdb->usermeta} WHERE meta_key = 'twork_fcm_tokens' AND meta_value != '' AND meta_value != 'a:0:{}'"
        );
        $status['total_users_with_tokens'] = (int) $users_with_tokens;

        // Count total tokens
        $all_tokens = $wpdb->get_results(
            "SELECT meta_value FROM {$wpdb->usermeta} WHERE meta_key = 'twork_fcm_tokens' AND meta_value != '' AND meta_value != 'a:0:{}'"
        );

        $total_tokens = 0;
        foreach ($all_tokens as $token_meta) {
            $tokens = maybe_unserialize($token_meta->meta_value);
            if (is_array($tokens)) {
                $total_tokens += count($tokens);
            }
        }
        $status['total_tokens'] = $total_tokens;

        return $status;
    }

    public function init()
    {
        if (!class_exists('WooCommerce')) {
            return;
        }
        // OPTIMIZED: Only run migrations once per day or when forced via option
        // This prevents expensive database queries on every page load
        $migration_version = get_option('twork_rewards_migration_version', '0');
        $current_version = '1.0.7';  // Increment when schema changes (added point tiers system)

        if ($migration_version !== $current_version) {
            // Run migrations on init to ensure columns exist (handles cases where table was created before migration was added)
            $this->run_migrations();
            // Also run code migrations to ensure codes table exists
            $this->run_code_migrations();
            // PROFESSIONAL FIX: Run exchange migrations for admin action tracking
            $this->run_exchange_migrations();
            // Ensure exchange requests table exists
            $this->ensure_exchange_requests_table();
            // Ensure engagement tables exist
            $this->create_engagement_tables();
            // Ensure usage tracking table exists
            $this->create_usage_tracking_table();
            // PROFESSIONAL FEATURE: Ensure point tiers tables exist
            $this->create_point_tiers_tables();
            // Mark migrations as complete
            update_option('twork_rewards_migration_version', $current_version);
        } else {
            // Even if migrations are up to date, run exchange migrations (idempotent)
            // This ensures columns exist even if migration was missed
            $this->run_exchange_migrations();
            // PROFESSIONAL FEATURE: Always ensure tier tables exist (idempotent)
            $this->create_point_tiers_tables();
        }

        // CRITICAL: Always run engagement migrations (idempotent - safe to run multiple times)
        // This ensures rotation_duration column exists even if migration was missed or failed
        $this->run_engagement_migrations();
    }

    public function activate()
    {
        $this->create_tables();
        $this->run_migrations();

        // CRITICAL: Flush rewrite rules to ensure REST API routes are registered
        // This is essential for custom REST API endpoints to work
        flush_rewrite_rules();

        // Also ensure engagement tables exist
        $this->create_engagement_tables();

        // Ensure usage tracking table exists
        $this->create_usage_tracking_table();

        // PROFESSIONAL FEATURE: Ensure point tiers tables exist
        $this->create_point_tiers_tables();
    }

    private function table_name()
    {
        global $wpdb;
        return $wpdb->prefix . 'twork_reward_transactions';
    }

    private function codes_table_name()
    {
        global $wpdb;
        return $wpdb->prefix . 'twork_reward_codes';
    }

    private function exchange_requests_table_name()
    {
        global $wpdb;
        return $wpdb->prefix . 'twork_reward_exchange_requests';
    }

    private function usage_tracking_table_name()
    {
        global $wpdb;
        return $wpdb->prefix . 'twork_user_usage_sessions';
    }

    private function page_content_table_name()
    {
        global $wpdb;
        return $wpdb->prefix . 'twork_page_content';
    }

    private function faq_table_name()
    {
        global $wpdb;
        return $wpdb->prefix . 'twork_faq_items';
    }

    private function about_us_table_name()
    {
        global $wpdb;
        return $wpdb->prefix . 'twork_about_us_content';
    }

    /**
     * PROFESSIONAL FEATURE: Point Tiers System
     * Get table name for point tiers configuration
     */
    private function point_tiers_table_name()
    {
        global $wpdb;
        return $wpdb->prefix . 'twork_point_tiers';
    }

    /**
     * Get table name for user tier assignments
     */
    private function user_tiers_table_name()
    {
        global $wpdb;
        return $wpdb->prefix . 'twork_user_tiers';
    }

    /**
     * Get table name for tier history
     */
    private function tier_history_table_name()
    {
        global $wpdb;
        return $wpdb->prefix . 'twork_tier_history';
    }


    private function create_tables()
    {
        global $wpdb;
        $charset_collate = $wpdb->get_charset_collate();
        $table_name = $this->table_name();

        $sql = "CREATE TABLE IF NOT EXISTS $table_name (
            id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
            user_id bigint(20) UNSIGNED NOT NULL,
            order_id varchar(255) DEFAULT NULL,
            status varchar(20) NOT NULL DEFAULT 'pending',
            points_value varchar(255) DEFAULT NULL,
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            updated_at datetime NULL DEFAULT NULL,
            deleted_at datetime NULL DEFAULT NULL,
            created_by bigint(20) UNSIGNED NULL DEFAULT NULL,
            approved_by bigint(20) UNSIGNED NULL DEFAULT NULL,
            updated_by bigint(20) UNSIGNED NULL DEFAULT NULL,
            PRIMARY KEY (id),
            KEY idx_user_id (user_id),
            KEY idx_order_id (order_id),
            KEY idx_status (status),
            KEY idx_updated_at (updated_at),
            KEY idx_deleted_at (deleted_at),
            KEY idx_created_by (created_by),
            KEY idx_approved_by (approved_by),
            KEY idx_updated_by (updated_by),
            UNIQUE KEY uniq_user_order (user_id, order_id)
        ) $charset_collate;";

        require_once (ABSPATH . 'wp-admin/includes/upgrade.php');
        dbDelta($sql);

        // Create code prefixes table
        $this->create_codes_table();

        // Create exchange requests table
        $this->create_exchange_requests_table();

        // Create engagement tables (Banner, Quiz, Interactions)
        $this->create_engagement_tables();

        // Create usage tracking table
        $this->create_usage_tracking_table();

        // Create page content table
        $this->create_page_content_table();

        // Create FAQ table
        $this->create_faq_table();

        // Create About Us content table
        $this->create_about_us_table();

        // PROFESSIONAL FEATURE: Create Point Tiers System tables
        $this->create_point_tiers_tables();


        // Migrate existing codes to add max_uses and current_uses columns if they don't exist
        $this->run_code_migrations();

        // PROFESSIONAL FIX: Run exchange table migrations for admin action tracking
        $this->run_exchange_migrations();
    }

    /**
     * Create the codes table if it doesn't exist
     */
    private function create_codes_table()
    {
        global $wpdb;
        $charset_collate = $wpdb->get_charset_collate();
        $codes_table = $this->codes_table_name();

        $codes_sql = "CREATE TABLE IF NOT EXISTS $codes_table (
            id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
            code_prefix varchar(255) NOT NULL,
            points_value varchar(255) DEFAULT NULL,
            description text DEFAULT NULL,
            max_uses int(11) DEFAULT NULL,
            current_uses int(11) DEFAULT 0,
            is_active tinyint(1) DEFAULT 1,
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            updated_at datetime NULL DEFAULT NULL,
            PRIMARY KEY (id),
            UNIQUE KEY uniq_code_prefix (code_prefix),
            KEY idx_is_active (is_active)
        ) $charset_collate;";

        require_once (ABSPATH . 'wp-admin/includes/upgrade.php');
        dbDelta($codes_sql);
    }

    /**
     * Create the exchange requests table if it doesn't exist
     */
    private function create_exchange_requests_table()
    {
        global $wpdb;
        $charset_collate = $wpdb->get_charset_collate();
        $exchange_table = $this->exchange_requests_table_name();

        $exchange_sql = "CREATE TABLE IF NOT EXISTS $exchange_table (
            id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
            user_id bigint(20) UNSIGNED NOT NULL,
            type varchar(20) NOT NULL DEFAULT 'points',
            points_value varchar(255) DEFAULT NULL,
            phone varchar(255) DEFAULT NULL,
            note text DEFAULT NULL,
            status varchar(20) NOT NULL DEFAULT 'pending',
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            updated_at datetime NULL DEFAULT NULL,
            approved_by bigint(20) UNSIGNED NULL DEFAULT NULL,
            approved_at datetime NULL DEFAULT NULL,
            rejected_by bigint(20) UNSIGNED NULL DEFAULT NULL,
            rejected_at datetime NULL DEFAULT NULL,
            updated_by bigint(20) UNSIGNED NULL DEFAULT NULL,
            PRIMARY KEY (id),
            KEY idx_user_id (user_id),
            KEY idx_status (status),
            KEY idx_type (type),
            KEY idx_created_at (created_at),
            KEY idx_approved_by (approved_by),
            KEY idx_approved_at (approved_at),
            KEY idx_rejected_by (rejected_by),
            KEY idx_rejected_at (rejected_at),
            KEY idx_updated_by (updated_by)
        ) $charset_collate;";

        require_once (ABSPATH . 'wp-admin/includes/upgrade.php');
        dbDelta($exchange_sql);
    }

    /**
     * Create engagement tables for Interactive Hub (Banners, Quizzes)
     */
    private function create_engagement_tables()
    {
        global $wpdb;
        $charset_collate = $wpdb->get_charset_collate();

        $engagement_items_table = $wpdb->prefix . 'twork_engagement_items';
        $user_interactions_table = $wpdb->prefix . 'twork_user_interactions';

        $sql_items = "CREATE TABLE IF NOT EXISTS $engagement_items_table (
            id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
            type varchar(50) NOT NULL, -- 'banner', 'quiz', 'poll', 'announcement'
            title varchar(255),
            media_url text, -- Image/Video URL
            content longtext, -- HTML content or Description
            quiz_data longtext, -- JSON data { 'question': '...', 'options': ['A', 'B'], 'correct_index': 0 }
            reward_points int(11) DEFAULT 0, -- Points for correct answer
            rotation_duration int(11) DEFAULT NULL, -- Rotation duration in seconds (1-60, NULL = use default 5s)
            start_date datetime,
            end_date datetime,
            status varchar(20) DEFAULT 'active', -- active, draft
            priority int(11) DEFAULT 0,
            target_audience longtext, -- JSON data
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            KEY idx_type (type),
            KEY idx_status (status),
            KEY idx_dates (start_date, end_date),
            KEY idx_priority (priority)
        ) $charset_collate;";

        $sql_interactions = "CREATE TABLE IF NOT EXISTS $user_interactions_table (
            id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
            user_id bigint(20) UNSIGNED NOT NULL,
            item_id bigint(20) UNSIGNED NOT NULL,
            interaction_type varchar(50), -- 'quiz_answer', 'click', 'view'
            interaction_value text, -- User answer or value
            is_correct boolean DEFAULT FALSE,
            points_awarded int(11) DEFAULT 0,
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            UNIQUE KEY user_item_unique (user_id, item_id),
            KEY idx_user_id (user_id),
            KEY idx_item_id (item_id)
        ) $charset_collate;";

        require_once (ABSPATH . 'wp-admin/includes/upgrade.php');
        dbDelta($sql_items);
        dbDelta($sql_interactions);
    }

    /**
     * Run migrations for engagement tables
     * Adds rotation_duration column if it doesn't exist
     *
     * This is a critical migration that must run before any save operations
     * Uses multiple fallback methods to ensure reliability across different MySQL/MariaDB versions
     */
    private function run_engagement_migrations()
    {
        global $wpdb;
        $engagement_items_table = $wpdb->prefix . 'twork_engagement_items';

        // Method 1: Check if table exists using SHOW TABLES (works in all MySQL versions)
        $table_exists = $wpdb->get_var($wpdb->prepare(
            'SHOW TABLES LIKE %s',
            $engagement_items_table
        ));

        if (!$table_exists) {
            // Table doesn't exist, create it (which will include rotation_duration)
            $this->create_engagement_tables();
            return;
        }

        // Method 2: Check if rotation_duration column exists using SHOW COLUMNS (most compatible)
        $column_exists = false;
        // Use esc_sql for table name since SHOW COLUMNS doesn't work well with prepare() for LIKE clause
        $safe_table_name = esc_sql($engagement_items_table);
        $columns = $wpdb->get_results("SHOW COLUMNS FROM `{$safe_table_name}` LIKE 'rotation_duration'");

        if (!empty($columns) && count($columns) > 0) {
            $column_exists = true;
        }

        // If SHOW COLUMNS didn't work, try INFORMATION_SCHEMA as fallback
        if (!$column_exists && defined('DB_NAME')) {
            $column_check = $wpdb->get_var($wpdb->prepare(
                "SELECT COUNT(*) 
                 FROM information_schema.columns 
                 WHERE table_schema = %s 
                 AND table_name = %s 
                 AND column_name = 'rotation_duration'",
                DB_NAME,
                $engagement_items_table
            ));
            $column_exists = ($column_check > 0);
        }

        // If column doesn't exist, add it
        if (!$column_exists) {
            // Try with AFTER clause first (preferred for column ordering)
            $sql = sprintf(
                'ALTER TABLE `%s` ADD COLUMN `rotation_duration` int(11) DEFAULT NULL AFTER `reward_points`',
                esc_sql($engagement_items_table)
            );

            $result = $wpdb->query($sql);

            if ($result !== false) {
                // Success - log if debug mode is on
                if (defined('WP_DEBUG') && WP_DEBUG) {
                    error_log('T-Work Rewards: Successfully added rotation_duration column to engagement_items table');
                }
            } else {
                // Failed - try alternative method without AFTER clause (in case MySQL version doesn't support it)
                $error_msg = $wpdb->last_error ? $wpdb->last_error : 'Unknown database error';

                // Try without AFTER clause
                $sql_alt = sprintf(
                    'ALTER TABLE `%s` ADD COLUMN `rotation_duration` int(11) DEFAULT NULL',
                    esc_sql($engagement_items_table)
                );
                $result_alt = $wpdb->query($sql_alt);

                if ($result_alt !== false) {
                    // Success with alternative method
                    if (defined('WP_DEBUG') && WP_DEBUG) {
                        error_log('T-Work Rewards: Successfully added rotation_duration column using alternative method (without AFTER clause)');
                    }
                } else {
                    // Both methods failed - log detailed error
                    $alt_error = $wpdb->last_error ? $wpdb->last_error : 'Unknown database error';
                    error_log('T-Work Rewards: CRITICAL - Failed to add rotation_duration column. Original error: ' . $error_msg);
                    error_log('T-Work Rewards: Alternative method also failed: ' . $alt_error);
                    error_log('T-Work Rewards: SQL queries attempted:');
                    error_log('  1. ' . $sql);
                    error_log('  2. ' . $sql_alt);
                }
            }
        }
    }

    /**
     * Create page content table for storing dynamic page content
     * Stores About Us, FAQ, Terms, Privacy Policy, etc.
     */
    private function create_page_content_table()
    {
        global $wpdb;
        $charset_collate = $wpdb->get_charset_collate();
        $table_name = $this->page_content_table_name();

        $sql = "CREATE TABLE IF NOT EXISTS $table_name (
            id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
            page_slug varchar(100) NOT NULL,
            title varchar(255) NOT NULL,
            content longtext NOT NULL,
            meta_data longtext DEFAULT NULL, -- JSON for additional data (icon, color, etc.)
            status varchar(20) DEFAULT 'active', -- active, draft
            display_order int(11) DEFAULT 0,
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            UNIQUE KEY uniq_page_slug (page_slug),
            KEY idx_status (status),
            KEY idx_display_order (display_order)
        ) $charset_collate;";

        require_once (ABSPATH . 'wp-admin/includes/upgrade.php');
        $result = dbDelta($sql);

        // PROFESSIONAL FIX: Log table creation result for debugging
        if (defined('WP_DEBUG') && WP_DEBUG) {
            if ($wpdb->last_error) {
                error_log('T-Work Rewards: Page content table creation error: ' . $wpdb->last_error);
            } else {
                error_log('T-Work Rewards: Page content table created successfully');
            }
        }

        // PROFESSIONAL FIX: Add display_order column if table exists but column is missing (migration)
        $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
        if ($table_exists === $table_name) {
            $existing_columns = $wpdb->get_col("DESCRIBE $table_name");
            $columns_lower = array_map('strtolower', $existing_columns);

            if (!in_array('display_order', $columns_lower)) {
                $result = $wpdb->query("ALTER TABLE $table_name ADD COLUMN display_order int(11) DEFAULT 0 AFTER status");
                if ($result !== false) {
                    // Add index for display_order
                    $wpdb->query("ALTER TABLE $table_name ADD INDEX idx_display_order (display_order)");
                    if (defined('WP_DEBUG') && WP_DEBUG) {
                        error_log('T-Work Rewards: Added display_order column to page content table');
                    }
                } else {
                    if (defined('WP_DEBUG') && WP_DEBUG) {
                        error_log('T-Work Rewards: Failed to add display_order column. Error: ' . $wpdb->last_error);
                    }
                }
            }
        }

        // Insert default pages if they don't exist
        $this->initialize_default_pages();
    }

    /**
     * Initialize default pages with placeholder content
     */
    private function initialize_default_pages()
    {
        global $wpdb;
        $table_name = $this->page_content_table_name();

        $default_pages = array(
            array(
                'page_slug' => 'about-us',
                'title' => 'About Us',
                'content' => "<h2>Welcome to PLANETmm</h2><p>PLANETmm is Myanmar's premier all-in-one network platform, bringing together lifestyle, commerce, and rewards in a seamless digital experience.</p><p>We are committed to providing the best services and creating value for our customers through innovative solutions and exceptional customer service.</p>",
                'meta_data' => json_encode(array('icon' => 'info_outline', 'color' => '#667eea')),
                'status' => 'active',
                'display_order' => 1,
            ),
            array(
                'page_slug' => 'terms-of-use',
                'title' => 'Terms of Use',
                'content' => '<h2>Terms of Use</h2><p>Please read these terms carefully before using our service.</p><p>By accessing or using our platform, you agree to be bound by these terms.</p>',
                'meta_data' => json_encode(array('icon' => 'description_outlined', 'color' => '#667eea')),
                'status' => 'active',
                'display_order' => 2,
            ),
            array(
                'page_slug' => 'privacy-policy',
                'title' => 'Privacy Policy',
                'content' => '<h2>Privacy Policy</h2><p>We respect your privacy and are committed to protecting your personal data.</p><p>This privacy policy explains how we collect, use, and protect your information.</p>',
                'meta_data' => json_encode(array('icon' => 'privacy_tip_outlined', 'color' => '#764ba2')),
                'status' => 'active',
                'display_order' => 3,
            ),
            array(
                'page_slug' => 'license',
                'title' => 'License',
                'content' => '<h2>License Information</h2><p>License details will be displayed here.</p>',
                'meta_data' => json_encode(array('icon' => 'copyright_outlined', 'color' => '#ff9800')),
                'status' => 'active',
                'display_order' => 4,
            ),
            array(
                'page_slug' => 'seller-policy',
                'title' => 'Seller Policy',
                'content' => '<h2>Seller Policy</h2><p>Seller guidelines and policies will be displayed here.</p>',
                'meta_data' => json_encode(array('icon' => 'store_outlined', 'color' => '#4caf50')),
                'status' => 'active',
                'display_order' => 5,
            ),
            array(
                'page_slug' => 'return-policy',
                'title' => 'Return Policy',
                'content' => '<h2>Return Policy</h2><p>Return and refund policies will be displayed here.</p>',
                'meta_data' => json_encode(array('icon' => 'assignment_return_outlined', 'color' => '#009688')),
                'status' => 'active',
                'display_order' => 6,
            ),
        );

        foreach ($default_pages as $page) {
            // Check if page already exists
            $exists = $wpdb->get_var($wpdb->prepare(
                "SELECT COUNT(*) FROM $table_name WHERE page_slug = %s",
                $page['page_slug']
            ));

            if ($exists == 0) {
                $result = $wpdb->insert($table_name, $page);
                if ($result === false && defined('WP_DEBUG') && WP_DEBUG) {
                    error_log('T-Work Rewards: Failed to insert default page ' . $page['page_slug'] . ': ' . $wpdb->last_error);
                } elseif ($result !== false && defined('WP_DEBUG') && WP_DEBUG) {
                    error_log('T-Work Rewards: Successfully inserted default page: ' . $page['page_slug']);
                }
            } else {
                // Update existing page to ensure status is active
                $wpdb->update(
                    $table_name,
                    array('status' => 'active'),
                    array('page_slug' => $page['page_slug']),
                    array('%s'),
                    array('%s')
                );
            }
        }
    }

    /**
     * Create FAQ table for storing FAQ items in plugin database
     * Alternative to WordPress posts - allows direct management in plugin
     */
    private function create_faq_table()
    {
        global $wpdb;
        $charset_collate = $wpdb->get_charset_collate();
        $table_name = $this->faq_table_name();

        // PROFESSIONAL FIX: Check if table already exists to avoid unnecessary operations
        $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
        if ($table_exists === $table_name) {
            // Table already exists
            return;
        }

        $sql = "CREATE TABLE IF NOT EXISTS $table_name (
            id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
            question text NOT NULL,
            answer longtext NOT NULL,
            display_order int(11) DEFAULT 0,
            status varchar(20) DEFAULT 'active',
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            KEY idx_status (status),
            KEY idx_display_order (display_order)
        ) $charset_collate;";

        require_once (ABSPATH . 'wp-admin/includes/upgrade.php');
        $result = dbDelta($sql);

        // PROFESSIONAL FIX: Log table creation result for debugging
        if (defined('WP_DEBUG') && WP_DEBUG) {
            if ($wpdb->last_error) {
                error_log('T-Work Rewards: FAQ table creation error: ' . $wpdb->last_error);
            } else {
                error_log('T-Work Rewards: FAQ table created successfully');
            }
        }
    }

    /**
     * Create About Us content table
     * Stores structured About Us content with separate fields for better management
     */
    private function create_about_us_table()
    {
        global $wpdb;
        $charset_collate = $wpdb->get_charset_collate();
        $table_name = $this->about_us_table_name();

        // PROFESSIONAL FIX: Check if table already exists to avoid unnecessary operations
        $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
        if ($table_exists === $table_name) {
            // Table already exists
            return;
        }

        $sql = "CREATE TABLE IF NOT EXISTS $table_name (
            id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
            company_name varchar(255) DEFAULT 'PLANETmm',
            tagline varchar(255) DEFAULT 'Pansy & Lincoln',
            subtitle varchar(255) DEFAULT 'All-in-One Network Myanmar',
            logo_url varchar(500) DEFAULT NULL,
            about_body_1 text NOT NULL,
            about_body_2 text NOT NULL,
            mission text NOT NULL,
            vision text NOT NULL,
            email varchar(255) DEFAULT NULL,
            phone varchar(100) DEFAULT NULL,
            address text DEFAULT NULL,
            version varchar(50) DEFAULT '1.0.2',
            status varchar(20) DEFAULT 'active',
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            PRIMARY KEY (id)
        ) $charset_collate;";

        require_once (ABSPATH . 'wp-admin/includes/upgrade.php');
        $result = dbDelta($sql);

        // PROFESSIONAL FIX: Log table creation result for debugging
        if (defined('WP_DEBUG') && WP_DEBUG) {
            if ($wpdb->last_error) {
                error_log('T-Work Rewards: About Us table creation error: ' . $wpdb->last_error);
            } else {
                error_log('T-Work Rewards: About Us table created successfully');
            }
        }

        // Initialize with default data if table was just created and is empty
        $table_exists_after = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
        if ($table_exists_after === $table_name) {
            $count = $wpdb->get_var("SELECT COUNT(*) FROM $table_name");
            if ($count == 0) {
                $default_data = array(
                    'company_name' => 'PLANETmm',
                    'tagline' => 'Pansy & Lincoln',
                    'subtitle' => 'All-in-One Network Myanmar',
                    'logo_url' => '',
                    'about_body_1' => "PLANETmm is Myanmar's premier all-in-one digital network platform, bringing together lifestyle, commerce, rewards, and community into a single seamless experience for users across the country.",
                    'about_body_2' => 'Our platform is built to connect people, businesses, and services in a modern, convenient, and secure way. We focus on delivering real value through exclusive promotions, smart loyalty points, easy payments, and a smooth shopping journey. With a strong technical foundation and a customer-first mindset, we are continuously improving to match the needs of Myanmar users in the digital age.',
                    'mission' => "To empower Myanmar's digital economy by connecting people, businesses, and communities through innovative technology, reliable services, and a rewarding experience that adds real value to everyday life.",
                    'vision' => "To become Myanmar's leading all-in-one digital platform, transforming how people shop, earn rewards, communicate, and live â€” by combining technology, creativity, and local understanding into a single powerful ecosystem.",
                    'email' => 'support@planetmm.com',
                    'phone' => '+95 9 123 456 789',
                    'address' => 'No. 123, Example Street, Yangon, Myanmar',
                    'version' => '1.0.2',
                    'status' => 'active',
                );
                $wpdb->insert($table_name, $default_data);
                if (defined('WP_DEBUG') && WP_DEBUG && $wpdb->last_error) {
                    error_log('T-Work Rewards: Failed to insert default About Us data: ' . $wpdb->last_error);
                }
            }
        }
    }

    /**
     * PROFESSIONAL FEATURE: Create Point Tiers System tables
     * Creates three tables:
     * 1. twork_point_tiers - Tier configurations (Bronze, Silver, Gold)
     * 2. twork_user_tiers - User tier assignments
     * 3. twork_tier_history - Tier change history for audit trail
     *
     * @since 1.0.0
     */
    private function create_point_tiers_tables()
    {
        global $wpdb;
        $charset_collate = $wpdb->get_charset_collate();

        // Table 1: Tier configurations
        $tiers_table = $this->point_tiers_table_name();
        $tiers_sql = "CREATE TABLE IF NOT EXISTS $tiers_table (
            id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
            tier_name varchar(50) NOT NULL,
            tier_slug varchar(50) NOT NULL,
            tier_level int(11) NOT NULL DEFAULT 0,
            min_points int(11) NOT NULL DEFAULT 0,
            max_points int(11) DEFAULT NULL,
            earning_multiplier decimal(5,2) DEFAULT 1.00,
            badge_icon varchar(255) DEFAULT NULL,
            badge_color varchar(50) DEFAULT '#666666',
            description text DEFAULT NULL,
            benefits longtext DEFAULT NULL,
            is_active tinyint(1) DEFAULT 1,
            display_order int(11) DEFAULT 0,
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            UNIQUE KEY uniq_tier_slug (tier_slug),
            KEY idx_tier_level (tier_level),
            KEY idx_is_active (is_active),
            KEY idx_display_order (display_order)
        ) $charset_collate;";

        // Table 2: User tier assignments
        $user_tiers_table = $this->user_tiers_table_name();
        $user_tiers_sql = "CREATE TABLE IF NOT EXISTS $user_tiers_table (
            id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
            user_id bigint(20) UNSIGNED NOT NULL,
            tier_id bigint(20) UNSIGNED NOT NULL,
            assigned_at datetime DEFAULT CURRENT_TIMESTAMP,
            assigned_by bigint(20) UNSIGNED NULL DEFAULT NULL,
            assignment_type varchar(20) DEFAULT 'automatic',
            points_at_assignment int(11) DEFAULT 0,
            is_active tinyint(1) DEFAULT 1,
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            UNIQUE KEY uniq_user_tier (user_id, tier_id),
            KEY idx_user_id (user_id),
            KEY idx_tier_id (tier_id),
            KEY idx_is_active (is_active),
            KEY idx_assigned_at (assigned_at)
        ) $charset_collate;";

        // Table 3: Tier history (audit trail)
        $tier_history_table = $this->tier_history_table_name();
        $tier_history_sql = "CREATE TABLE IF NOT EXISTS $tier_history_table (
            id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
            user_id bigint(20) UNSIGNED NOT NULL,
            old_tier_id bigint(20) UNSIGNED NULL DEFAULT NULL,
            new_tier_id bigint(20) UNSIGNED NOT NULL,
            change_type varchar(20) DEFAULT 'upgrade',
            points_at_change int(11) DEFAULT 0,
            changed_by bigint(20) UNSIGNED NULL DEFAULT NULL,
            change_reason text DEFAULT NULL,
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            KEY idx_user_id (user_id),
            KEY idx_old_tier_id (old_tier_id),
            KEY idx_new_tier_id (new_tier_id),
            KEY idx_change_type (change_type),
            KEY idx_created_at (created_at)
        ) $charset_collate;";

        require_once (ABSPATH . 'wp-admin/includes/upgrade.php');
        dbDelta($tiers_sql);
        dbDelta($user_tiers_sql);
        dbDelta($tier_history_sql);

        // Initialize default tiers if table is empty
        $this->initialize_default_tiers();

        // PROFESSIONAL: Log table creation
        if (defined('WP_DEBUG') && WP_DEBUG) {
            if ($wpdb->last_error) {
                error_log('T-Work Rewards: Point Tiers tables creation error: ' . $wpdb->last_error);
            } else {
                error_log('T-Work Rewards: Point Tiers tables created successfully');
            }
        }
    }

    /**
     * Initialize default tiers (Bronze, Silver, Gold)
     * Only inserts if tiers don't exist
     */
    private function initialize_default_tiers()
    {
        global $wpdb;
        $tiers_table = $this->point_tiers_table_name();

        // PROFESSIONAL OPTIMIZATION: Check if table exists first using SHOW TABLES LIKE (more compatible, faster)
        $table_check = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $tiers_table));
        $table_exists = ($table_check === $tiers_table);

        if (!$table_exists) {
            // Table doesn't exist, create it first (only once)
            $this->create_point_tiers_tables();
            // Re-check after creation (single check)
            $table_check = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $tiers_table));
            $table_exists = ($table_check === $tiers_table);
            if (!$table_exists) {
                if (defined('WP_DEBUG') && WP_DEBUG) {
                    error_log('T-Work Rewards: Failed to create tiers table for initialization');
                }
                return false;
            }
        }

        // PROFESSIONAL OPTIMIZATION: Check option first to avoid unnecessary query
        $tiers_initialized = get_option('twork_rewards_tiers_initialized', false);
        if ($tiers_initialized) {
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: Tiers already initialized (option check), skipping');
            }
            return true;  // Already initialized
        }

        // Check if tiers already exist (only if option not set)
        $existing_count = $wpdb->get_var("SELECT COUNT(*) FROM $tiers_table");
        if ($existing_count > 0) {
            // Mark as initialized to avoid future checks
            update_option('twork_rewards_tiers_initialized', true);
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: Tiers already exist, marking as initialized');
            }
            return true;  // Tiers already exist
        }

        $default_tiers = array(
            array(
                'tier_name' => 'Bronze',
                'tier_slug' => 'bronze',
                'tier_level' => 1,
                'min_points' => 0,
                'max_points' => 999,
                'earning_multiplier' => 1.0,
                'badge_icon' => 'bronze-medal',
                'badge_color' => '#CD7F32',
                'description' => 'Bronze tier members earn standard points on all purchases and activities.',
                'benefits' => json_encode(array(
                    'Standard earning rate',
                    'Access to basic rewards',
                    'Regular customer support'
                )),
                'is_active' => 1,
                'display_order' => 1,
            ),
            array(
                'tier_name' => 'Silver',
                'tier_slug' => 'silver',
                'tier_level' => 2,
                'min_points' => 1000,
                'max_points' => 4999,
                'earning_multiplier' => 1.25,
                'badge_icon' => 'silver-medal',
                'badge_color' => '#C0C0C0',
                'description' => 'Silver tier members earn 25% bonus points on all purchases and activities.',
                'benefits' => json_encode(array(
                    '25% bonus earning rate',
                    'Access to exclusive rewards',
                    'Priority customer support',
                    'Special promotions'
                )),
                'is_active' => 1,
                'display_order' => 2,
            ),
            array(
                'tier_name' => 'Gold',
                'tier_slug' => 'gold',
                'tier_level' => 3,
                'min_points' => 5000,
                'max_points' => NULL,
                'earning_multiplier' => 1.5,
                'badge_icon' => 'gold-medal',
                'badge_color' => '#FFD700',
                'description' => 'Gold tier members earn 50% bonus points on all purchases and activities.',
                'benefits' => json_encode(array(
                    '50% bonus earning rate',
                    'Access to premium rewards',
                    'VIP customer support',
                    'Exclusive promotions',
                    'Early access to new features'
                )),
                'is_active' => 1,
                'display_order' => 3,
            ),
        );

        // PROFESSIONAL OPTIMIZATION: Use bulk insert for better performance
        $inserted_count = 0;
        foreach ($default_tiers as $tier) {
            $result = $wpdb->insert($tiers_table, $tier);
            if ($result !== false) {
                $inserted_count++;
            } else {
                if (defined('WP_DEBUG') && WP_DEBUG) {
                    error_log('T-Work Rewards: Failed to insert tier: ' . $tier['tier_name'] . ' - ' . $wpdb->last_error);
                }
            }
        }

        // Mark as initialized only if successful
        if ($inserted_count > 0) {
            update_option('twork_rewards_tiers_initialized', true);
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf('T-Work Rewards: Default tiers initialized successfully. Inserted %d tiers (Bronze, Silver, Gold)', $inserted_count));
            }
        } else {
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: Failed to initialize default tiers. Check database permissions.');
            }
        }

        return $inserted_count > 0;
    }


    /**
     * Create usage tracking table for app session tracking
     * Tracks when users open/close the app and calculates usage duration
     */
    private function create_usage_tracking_table()
    {
        global $wpdb;
        $charset_collate = $wpdb->get_charset_collate();
        $usage_table = $this->usage_tracking_table_name();

        $sql = "CREATE TABLE IF NOT EXISTS $usage_table (
            id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
            user_id bigint(20) UNSIGNED NOT NULL,
            session_start datetime NOT NULL,
            session_end datetime DEFAULT NULL,
            duration_seconds int(11) DEFAULT NULL,
            device_info varchar(255) DEFAULT NULL,
            app_version varchar(50) DEFAULT NULL,
            country_code varchar(2) DEFAULT NULL,
            country_name varchar(100) DEFAULT NULL,
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            updated_at datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            KEY idx_user_id (user_id),
            KEY idx_session_start (session_start),
            KEY idx_session_end (session_end),
            KEY idx_duration (duration_seconds),
            KEY idx_country_code (country_code),
            KEY idx_created_at (created_at)
        ) $charset_collate;";

        require_once (ABSPATH . 'wp-admin/includes/upgrade.php');
        dbDelta($sql);

        // Professional: Run migration to add country columns if they don't exist
        $this->migrate_usage_tracking_table();
    }

    /**
     * Migrate usage tracking table to add country columns
     * Professional: Handles existing tables by adding missing columns
     */
    private function migrate_usage_tracking_table()
    {
        global $wpdb;
        $usage_table = $this->usage_tracking_table_name();

        // Check if table exists
        $table_exists = $wpdb->get_var($wpdb->prepare(
            'SHOW TABLES LIKE %s',
            $usage_table
        ));

        if (!$table_exists) {
            return;  // Table doesn't exist yet, will be created by create_usage_tracking_table
        }

        // Get existing columns
        $existing_columns = $wpdb->get_col("DESCRIBE $usage_table");
        $columns_lower = array_map('strtolower', $existing_columns);

        // Add country_code column if it doesn't exist
        if (!in_array('country_code', $columns_lower)) {
            $result = $wpdb->query("ALTER TABLE $usage_table ADD COLUMN country_code varchar(2) DEFAULT NULL AFTER app_version");
            if ($result !== false) {
                error_log('T-Work Rewards: Added country_code column to usage tracking table');
            } else {
                error_log('T-Work Rewards: Failed to add country_code column. Error: ' . $wpdb->last_error);
            }
        }

        // Add country_name column if it doesn't exist
        if (!in_array('country_name', $columns_lower)) {
            $result = $wpdb->query("ALTER TABLE $usage_table ADD COLUMN country_name varchar(100) DEFAULT NULL AFTER country_code");
            if ($result !== false) {
                error_log('T-Work Rewards: Added country_name column to usage tracking table');
            } else {
                error_log('T-Work Rewards: Failed to add country_name column. Error: ' . $wpdb->last_error);
            }
        }

        // Add index for country_code if it doesn't exist
        $indexes = $wpdb->get_results("SHOW INDEX FROM $usage_table WHERE Key_name = 'idx_country_code'");
        if (empty($indexes)) {
            $result = $wpdb->query("ALTER TABLE $usage_table ADD INDEX idx_country_code (country_code)");
            if ($result !== false) {
                error_log('T-Work Rewards: Added idx_country_code index to usage tracking table');
            }
        }
    }

    /**
     * Ensure exchange requests table exists
     * OPTIMIZED: Uses faster table existence check
     */
    private function ensure_exchange_requests_table()
    {
        global $wpdb;
        $exchange_table = $this->exchange_requests_table_name();

        // OPTIMIZED: Check if table exists using a faster method
        $table_exists = $wpdb->get_var($wpdb->prepare(
            'SHOW TABLES LIKE %s',
            $exchange_table
        ));

        if (!$table_exists) {
            // Table doesn't exist, create it
            $this->create_exchange_requests_table();
        }
    }

    /**
     * Run migrations for code prefixes table
     * OPTIMIZED: Uses faster column checks
     */
    private function run_code_migrations()
    {
        global $wpdb;
        $codes_table = $this->codes_table_name();

        // OPTIMIZED: Check if table exists using a faster method
        $table_exists = $wpdb->get_var($wpdb->prepare(
            'SHOW TABLES LIKE %s',
            $codes_table
        ));

        if (!$table_exists) {
            // Table doesn't exist, create it
            $this->create_codes_table();
            return;
        }

        // OPTIMIZED: Get all columns in one query instead of multiple SHOW COLUMNS queries
        $existing_columns = $wpdb->get_col("DESCRIBE $codes_table");
        $columns_lower = array_map('strtolower', $existing_columns);

        // Check if max_uses column exists
        if (!in_array('max_uses', $columns_lower)) {
            $result = $wpdb->query("ALTER TABLE $codes_table ADD COLUMN max_uses int(11) DEFAULT NULL AFTER description");
            if ($result !== false) {
                error_log('T-Work Rewards: Added missing max_uses column to ' . $codes_table);
            } else {
                error_log('T-Work Rewards: Failed to add max_uses column. Error: ' . $wpdb->last_error);
            }
        }

        // Check if current_uses column exists
        if (!in_array('current_uses', $columns_lower)) {
            $result = $wpdb->query("ALTER TABLE $codes_table ADD COLUMN current_uses int(11) DEFAULT 0 AFTER max_uses");
            if ($result !== false) {
                error_log('T-Work Rewards: Added missing current_uses column to ' . $codes_table);
            } else {
                error_log('T-Work Rewards: Failed to add current_uses column. Error: ' . $wpdb->last_error);
            }
        }
    }

    /**
     * Run database migrations to add missing columns
     * OPTIMIZED: Uses cached column checks to avoid expensive queries
     */
    private function run_migrations()
    {
        global $wpdb;
        $table = $this->table_name();

        // OPTIMIZED: Check if table exists using a faster method
        $table_exists = $wpdb->get_var($wpdb->prepare(
            'SHOW TABLES LIKE %s',
            $table
        ));

        if (!$table_exists) {
            // Table doesn't exist, create it
            $this->create_tables();
            return;
        }

        // OPTIMIZED: Get all columns in one query instead of multiple SHOW COLUMNS queries
        $existing_columns = $wpdb->get_col("DESCRIBE $table");
        $columns_lower = array_map('strtolower', $existing_columns);

        // Check if points_value column exists
        if (!in_array('points_value', $columns_lower)) {
            // Add points_value column if it doesn't exist
            $result = $wpdb->query("ALTER TABLE $table ADD COLUMN points_value varchar(255) DEFAULT NULL AFTER status");
            if ($result !== false) {
                error_log('T-Work Rewards: Added missing points_value column to ' . $table);
            } else {
                error_log('T-Work Rewards: Failed to add points_value column. Error: ' . $wpdb->last_error);
            }
        }

        // Check if updated_at column exists (safety check)
        if (!in_array('updated_at', $columns_lower)) {
            // Add updated_at column if it doesn't exist
            $result = $wpdb->query("ALTER TABLE $table ADD COLUMN updated_at datetime NULL DEFAULT NULL AFTER created_at");
            if ($result !== false) {
                error_log('T-Work Rewards: Added missing updated_at column to ' . $table);
            } else {
                error_log('T-Work Rewards: Failed to add updated_at column. Error: ' . $wpdb->last_error);
            }
        }

        // Check if deleted_at column exists (for trash functionality)
        if (!in_array('deleted_at', $columns_lower)) {
            // Add deleted_at column if it doesn't exist
            $result = $wpdb->query("ALTER TABLE $table ADD COLUMN deleted_at datetime NULL DEFAULT NULL AFTER updated_at");
            if ($result !== false) {
                error_log('T-Work Rewards: Added missing deleted_at column to ' . $table);
                // Add index for deleted_at
                $wpdb->query("ALTER TABLE $table ADD INDEX idx_deleted_at (deleted_at)");
            } else {
                error_log('T-Work Rewards: Failed to add deleted_at column. Error: ' . $wpdb->last_error);
            }
        }

        // PROFESSIONAL FIX: Add admin action tracking columns
        // Track who created, approved, and updated transactions
        if (!in_array('created_by', $columns_lower)) {
            $result = $wpdb->query("ALTER TABLE $table ADD COLUMN created_by bigint(20) UNSIGNED NULL DEFAULT NULL AFTER deleted_at");
            if ($result !== false) {
                error_log('T-Work Rewards: Added created_by column to ' . $table);
                $wpdb->query("ALTER TABLE $table ADD INDEX idx_created_by (created_by)");
            } else {
                error_log('T-Work Rewards: Failed to add created_by column. Error: ' . $wpdb->last_error);
            }
        }

        if (!in_array('approved_by', $columns_lower)) {
            $result = $wpdb->query("ALTER TABLE $table ADD COLUMN approved_by bigint(20) UNSIGNED NULL DEFAULT NULL AFTER created_by");
            if ($result !== false) {
                error_log('T-Work Rewards: Added approved_by column to ' . $table);
                $wpdb->query("ALTER TABLE $table ADD INDEX idx_approved_by (approved_by)");
            } else {
                error_log('T-Work Rewards: Failed to add approved_by column. Error: ' . $wpdb->last_error);
            }
        }

        if (!in_array('updated_by', $columns_lower)) {
            $result = $wpdb->query("ALTER TABLE $table ADD COLUMN updated_by bigint(20) UNSIGNED NULL DEFAULT NULL AFTER approved_by");
            if ($result !== false) {
                error_log('T-Work Rewards: Added updated_by column to ' . $table);
                $wpdb->query("ALTER TABLE $table ADD INDEX idx_updated_by (updated_by)");
            } else {
                error_log('T-Work Rewards: Failed to add updated_by column. Error: ' . $wpdb->last_error);
            }
        }
    }

    /**
     * Run migrations for exchange requests table
     * Adds admin action tracking columns
     *
     * @since 1.0.0
     */
    private function run_exchange_migrations()
    {
        global $wpdb;
        $exchange_table = $this->exchange_requests_table_name();

        // Check if table exists
        $table_exists = $wpdb->get_var($wpdb->prepare(
            'SHOW TABLES LIKE %s',
            $exchange_table
        ));

        if (!$table_exists) {
            return;  // Table doesn't exist yet
        }

        // Get existing columns
        $existing_columns = $wpdb->get_col("DESCRIBE $exchange_table");
        $columns_lower = array_map('strtolower', $existing_columns);

        // Add approved_by column (tracks who approved/rejected the exchange)
        if (!in_array('approved_by', $columns_lower)) {
            $result = $wpdb->query("ALTER TABLE $exchange_table ADD COLUMN approved_by bigint(20) UNSIGNED NULL DEFAULT NULL AFTER updated_at");
            if ($result !== false) {
                error_log('T-Work Rewards: Added approved_by column to ' . $exchange_table);
                $wpdb->query("ALTER TABLE $exchange_table ADD INDEX idx_approved_by (approved_by)");
            } else {
                error_log('T-Work Rewards: Failed to add approved_by column. Error: ' . $wpdb->last_error);
            }
        }

        // Add rejected_by column (tracks who rejected the exchange)
        if (!in_array('rejected_by', $columns_lower)) {
            $result = $wpdb->query("ALTER TABLE $exchange_table ADD COLUMN rejected_by bigint(20) UNSIGNED NULL DEFAULT NULL AFTER approved_by");
            if ($result !== false) {
                error_log('T-Work Rewards: Added rejected_by column to ' . $exchange_table);
                $wpdb->query("ALTER TABLE $exchange_table ADD INDEX idx_rejected_by (rejected_by)");
            } else {
                error_log('T-Work Rewards: Failed to add rejected_by column. Error: ' . $wpdb->last_error);
            }
        }

        // Add updated_by column (tracks who updated the exchange request)
        if (!in_array('updated_by', $columns_lower)) {
            $result = $wpdb->query("ALTER TABLE $exchange_table ADD COLUMN updated_by bigint(20) UNSIGNED NULL DEFAULT NULL AFTER rejected_by");
            if ($result !== false) {
                error_log('T-Work Rewards: Added updated_by column to ' . $exchange_table);
                $wpdb->query("ALTER TABLE $exchange_table ADD INDEX idx_updated_by (updated_by)");
            } else {
                error_log('T-Work Rewards: Failed to add updated_by column. Error: ' . $wpdb->last_error);
            }
        }

        // Add approved_at column (tracks when the exchange was approved)
        if (!in_array('approved_at', $columns_lower)) {
            $result = $wpdb->query("ALTER TABLE $exchange_table ADD COLUMN approved_at datetime NULL DEFAULT NULL AFTER approved_by");
            if ($result !== false) {
                error_log('T-Work Rewards: Added approved_at column to ' . $exchange_table);
                $wpdb->query("ALTER TABLE $exchange_table ADD INDEX idx_approved_at (approved_at)");
            } else {
                error_log('T-Work Rewards: Failed to add approved_at column. Error: ' . $wpdb->last_error);
            }
        }

        // Add rejected_at column (tracks when the exchange was rejected)
        if (!in_array('rejected_at', $columns_lower)) {
            $result = $wpdb->query("ALTER TABLE $exchange_table ADD COLUMN rejected_at datetime NULL DEFAULT NULL AFTER rejected_by");
            if ($result !== false) {
                error_log('T-Work Rewards: Added rejected_at column to ' . $exchange_table);
                $wpdb->query("ALTER TABLE $exchange_table ADD INDEX idx_rejected_at (rejected_at)");
            } else {
                error_log('T-Work Rewards: Failed to add rejected_at column. Error: ' . $wpdb->last_error);
            }
        }
    }

    /**
     * Create a pending transaction when an order is placed.
     */
    public function create_pending_reward_transaction($order_id)
    {
        if (empty($order_id)) {
            return;
        }

        // Avoid duplicates for same order
        if (get_post_meta($order_id, '_twork_reward_txn_created', true)) {
            return;
        }

        $order = wc_get_order($order_id);
        if (!$order) {
            return;
        }

        $user_id = $order->get_user_id();
        if (empty($user_id)) {
            return;
        }

        global $wpdb;
        $table = $this->table_name();

        // Insert (unique key prevents duplicates). If already exists, treat as success.
        $inserted = $wpdb->query(
            $wpdb->prepare(
                "INSERT INTO $table (user_id, order_id, status, created_at, updated_at)
                 VALUES (%d, %s, %s, %s, %s)
                 ON DUPLICATE KEY UPDATE updated_at = VALUES(updated_at)",
                $user_id,
                (string) $order_id,
                'pending',
                current_time('mysql'),
                current_time('mysql')
            )
        );

        if ($inserted !== false) {
            update_post_meta($order_id, '_twork_reward_txn_created', 1);
        }
    }

    /**
     * Admin menu pages
     */
    public function add_admin_menu()
    {
        $capability = current_user_can('manage_woocommerce') ? 'manage_woocommerce' : 'manage_options';
        $parent_slug = 'twork-rewards';

        add_menu_page(
            __('T-Work Rewards', 'twork-rewards'),
            __('T-Work Rewards', 'twork-rewards'),
            $capability,
            $parent_slug,
            array($this, 'render_transactions_page'),
            'dashicons-tickets-alt',
            57
        );

        add_submenu_page(
            $parent_slug,
            __('Engagement Hub', 'twork-rewards'),  // Banner, Quiz, Poll
            __('Engagement Hub', 'twork-rewards'),
            $capability,
            'twork-rewards-engagement',
            array($this, 'render_engagement_page')
        );

        add_submenu_page(
            $parent_slug,
            __('Transactions', 'twork-rewards'),
            __('Transactions', 'twork-rewards'),
            $capability,
            $parent_slug,
            array($this, 'render_transactions_page')
        );

        add_submenu_page(
            $parent_slug,
            __('Users', 'twork-rewards'),
            __('Users', 'twork-rewards'),
            $capability,
            'twork-rewards-users',
            array($this, 'render_users_page')
        );

        add_submenu_page(
            $parent_slug,
            __('Code Prefixes', 'twork-rewards'),
            __('Code Prefixes', 'twork-rewards'),
            $capability,
            'twork-rewards-codes',
            array($this, 'render_codes_page')
        );

        add_submenu_page(
            $parent_slug,
            __('Usage Analytics', 'twork-rewards'),
            __('Usage Analytics', 'twork-rewards'),
            $capability,
            'twork-rewards-usage',
            array($this, 'render_usage_analytics_page')
        );

        add_submenu_page(
            $parent_slug,
            __('Exchange Requests', 'twork-rewards'),
            __('Exchange Requests', 'twork-rewards'),
            $capability,
            'twork-rewards-exchange-requests',
            array($this, 'render_exchange_requests_page')
        );



        add_submenu_page(
            $parent_slug,
            __('Page Content', 'twork-rewards'),
            __('Page Content', 'twork-rewards'),
            $capability,
            'twork-rewards-page-content',
            array($this, 'render_page_content_page')
        );

        add_submenu_page(
            $parent_slug,
            __('FAQ Management', 'twork-rewards'),
            __('FAQ Management', 'twork-rewards'),
            $capability,
            'twork-rewards-faq',
            array($this, 'render_faq_page')
        );

        add_submenu_page(
            $parent_slug,
            __('About Us Management', 'twork-rewards'),
            __('About Us', 'twork-rewards'),
            $capability,
            'twork-rewards-about-us',
            array($this, 'render_about_us_page')
        );

        add_submenu_page(
            $parent_slug,
            __('Point Tiers', 'twork-rewards'),
            __('Point Tiers', 'twork-rewards'),
            $capability,
            'twork-rewards-point-tiers',
            array($this, 'render_point_tiers_page')
        );

        add_submenu_page(
            $parent_slug,
            __('Settings', 'twork-rewards'),
            __('Settings', 'twork-rewards'),
            $capability,
            'twork-rewards-settings',
            array($this, 'render_settings_page')
        );

        // Hidden edit page
        add_submenu_page(
            null,
            __('Edit Reward Transaction', 'twork-rewards'),
            __('Edit Reward Transaction', 'twork-rewards'),
            $capability,
            'twork-rewards-transaction-edit',
            array($this, 'render_transaction_edit_page')
        );

        // Hidden edit page for exchange requests
        add_submenu_page(
            null,
            __('Edit Exchange Request', 'twork-rewards'),
            __('Edit Exchange Request', 'twork-rewards'),
            $capability,
            'twork-rewards-exchange-edit',
            array($this, 'render_exchange_edit_page')
        );

        // Hidden user detail page
        add_submenu_page(
            null,
            __('User Detail', 'twork-rewards'),
            __('User Detail', 'twork-rewards'),
            $capability,
            'twork-rewards-user-detail',
            array($this, 'render_user_detail_page')
        );
    }

    /**
     * PROFESSIONAL FEATURE: Point Tiers Management Page
     * Admin UI for managing point tiers (Bronze, Silver, Gold)
     */
    public function render_point_tiers_page()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('You do not have permission to access this page.', 'twork-rewards'));
        }

        global $wpdb;
        $tiers_table = $this->point_tiers_table_name();
        $user_tiers_table = $this->user_tiers_table_name();

        // PROFESSIONAL OPTIMIZATION: Check table existence once and cache result
        // Use SHOW TABLES LIKE instead of information_schema for better compatibility
        $tiers_table_check = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $tiers_table));
        $tiers_table_exists = ($tiers_table_check === $tiers_table);

        if (!$tiers_table_exists) {
            // Tables don't exist, create them (only once)
            $this->create_point_tiers_tables();
            // Re-check after creation (single check)
            $tiers_table_check = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $tiers_table));
            $tiers_table_exists = ($tiers_table_check === $tiers_table);
        }

        // Get all tiers (single query, no redundant checks)
        // PROFESSIONAL FIX: By default show only active tiers, but allow viewing inactive via filter
        $tiers = array();
        if ($tiers_table_exists) {
            // Check if user wants to see inactive tiers
            $show_inactive = isset($_GET['show_inactive']) && $_GET['show_inactive'] === '1';

            if ($show_inactive) {
                // Show all tiers (active and inactive)
                $tiers = $wpdb->get_results(
                    "SELECT * FROM $tiers_table ORDER BY tier_level ASC",
                    ARRAY_A
                );
            } else {
                // Default: Show only active tiers
                $tiers = $wpdb->get_results(
                    "SELECT * FROM $tiers_table WHERE is_active = 1 ORDER BY tier_level ASC",
                    ARRAY_A
                );
            }

            // PROFESSIONAL OPTIMIZATION: Only initialize if tiers are empty AND not already initialized
            // Check option to prevent repeated initialization attempts
            $tiers_initialized = get_option('twork_rewards_tiers_initialized', false);
            if (empty($tiers) && !$tiers_initialized) {
                $initialized = $this->initialize_default_tiers();
                if ($initialized) {
                    update_option('twork_rewards_tiers_initialized', true);
                    // Re-fetch tiers after initialization (only active)
                    $tiers = $wpdb->get_results(
                        "SELECT * FROM $tiers_table WHERE is_active = 1 ORDER BY tier_level ASC",
                        ARRAY_A
                    );
                }
            }
        }

        // PROFESSIONAL OPTIMIZATION: Get tier statistics in single query (batch operation)
        $tier_stats = array();
        if (!empty($tiers) && $tiers_table_exists) {
            // Check if user_tiers_table exists (single check)
            $user_tiers_table_check = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $user_tiers_table));
            if ($user_tiers_table_check === $user_tiers_table) {
                // OPTIMIZED: Get all tier counts in single query instead of loop
                $tier_ids = array_map(function ($tier) {
                    return $tier['id'];
                }, $tiers);
                if (!empty($tier_ids)) {
                    $tier_ids_placeholders = implode(',', array_fill(0, count($tier_ids), '%d'));
                    $stats_query = $wpdb->prepare(
                        "SELECT tier_id, COUNT(DISTINCT user_id) as user_count 
                         FROM $user_tiers_table 
                         WHERE tier_id IN ($tier_ids_placeholders) AND is_active = 1 
                         GROUP BY tier_id",
                        ...$tier_ids
                    );
                    $stats_results = $wpdb->get_results($stats_query, ARRAY_A);
                    foreach ($stats_results as $stat) {
                        $tier_stats[$stat['tier_id']] = (int) $stat['user_count'];
                    }
                }
                // Initialize missing tier stats to 0
                foreach ($tiers as $tier) {
                    if (!isset($tier_stats[$tier['id']])) {
                        $tier_stats[$tier['id']] = 0;
                    }
                }
            }
        }

        // Handle tab navigation
        $tab = isset($_GET['tab']) ? sanitize_text_field($_GET['tab']) : 'tiers';
        $tier_id = isset($_GET['tier_id']) ? absint($_GET['tier_id']) : 0;
        $action = isset($_GET['action']) ? sanitize_text_field($_GET['action']) : '';

        // Get tier data for edit
        $tier_data = null;
        if (($action === 'edit' || $action === 'duplicate') && $tier_id > 0 && $tiers_table_exists) {
            $tier_data = $wpdb->get_row($wpdb->prepare(
                "SELECT * FROM $tiers_table WHERE id = %d",
                $tier_id
            ), ARRAY_A);

            if (!$tier_data) {
                $action = '';  // Reset action if tier not found
                $tier_id = 0;
            }
        }

        // Show success/error messages
        if (isset($_GET['updated']) && $_GET['updated']) {
            echo '<div class="notice notice-success is-dismissible"><p>' . esc_html__('Tier saved successfully.', 'twork-rewards') . '</p></div>';
        }
        if (isset($_GET['deleted']) && $_GET['deleted']) {
            echo '<div class="notice notice-success is-dismissible"><p>' . esc_html__('Tier deleted successfully.', 'twork-rewards') . '</p></div>';
        }
        if (isset($_GET['recalculated'])) {
            $count = absint($_GET['recalculated']);
            echo '<div class="notice notice-success is-dismissible"><p>' . sprintf(esc_html__('Successfully recalculated tiers for %d users.', 'twork-rewards'), $count) . '</p></div>';
        }

        ?>
        <div class="wrap">
            <h1>
                <?php
                if ($action === 'edit') {
                    esc_html_e('Edit Point Tier', 'twork-rewards');
                } elseif ($action === 'add') {
                    esc_html_e('Add New Point Tier', 'twork-rewards');
                } elseif ($action === 'duplicate') {
                    esc_html_e('Duplicate Point Tier', 'twork-rewards');
                } else {
                    esc_html_e('Point Tiers Management', 'twork-rewards');
                }
                ?>
            </h1>
            
            <?php if ($action === 'edit' || $action === 'add' || $action === 'duplicate'): ?>
                <!-- Edit/Add Form -->
                <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-point-tiers', 'tab' => 'tiers'), admin_url('admin.php'))); ?>" 
                   class="button" style="margin-bottom: 20px;">
                    â† <?php esc_html_e('Back to Tiers List', 'twork-rewards'); ?>
                </a>
                
                <div class="twork-engagement-card" style="max-width: 800px;">
                    <form method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>" id="tier-form">
                        <?php wp_nonce_field('twork_rewards_save_tier'); ?>
                        <input type="hidden" name="action" value="twork_rewards_save_tier" />
                        <?php if ($tier_data && $action === 'edit'): ?>
                            <input type="hidden" name="tier_id" value="<?php echo esc_attr($tier_data['id']); ?>" />
                        <?php elseif ($tier_data && $action === 'duplicate'): ?>
                            <!-- Duplicate mode: Clear tier_id to create new tier, but modify name/slug -->
                            <input type="hidden" name="tier_id" value="0" />
                            <div class="notice notice-info" style="margin-bottom: 20px;">
                                <p><?php esc_html_e('You are duplicating this tier. Please modify the tier name and level to create a new tier.', 'twork-rewards'); ?></p>
                            </div>
                        <?php endif; ?>
                        
                        <table class="form-table">
                            <tr>
                                <th scope="row">
                                    <label for="tier_name"><?php esc_html_e('Tier Name', 'twork-rewards'); ?> <span style="color: red;">*</span></label>
                                </th>
                                <td>
                                    <input type="text" 
                                           id="tier_name" 
                                           name="tier_name" 
                                           value="<?php echo ($tier_data && $action === 'duplicate') ? esc_attr($tier_data['tier_name'] . ' (Copy)') : ($tier_data ? esc_attr($tier_data['tier_name']) : ''); ?>" 
                                           class="regular-text" 
                                           required />
                                    <p class="description"><?php esc_html_e('Display name for this tier (e.g., Bronze, Silver, Gold).', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                            
                            <tr>
                                <th scope="row">
                                    <label for="tier_slug"><?php esc_html_e('Tier Slug', 'twork-rewards'); ?></label>
                                </th>
                                <td>
                                    <input type="text" 
                                           id="tier_slug" 
                                           name="tier_slug" 
                                           value="<?php echo ($tier_data && $action === 'duplicate') ? esc_attr($tier_data['tier_slug'] . '-copy') : ($tier_data ? esc_attr($tier_data['tier_slug']) : ''); ?>" 
                                           class="regular-text" />
                                    <p class="description"><?php esc_html_e('URL-friendly identifier (auto-generated from name if empty).', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                            
                            <tr>
                                <th scope="row">
                                    <label for="tier_level"><?php esc_html_e('Tier Level', 'twork-rewards'); ?> <span style="color: red;">*</span></label>
                                </th>
                                <td>
                                    <input type="number" 
                                           id="tier_level" 
                                           name="tier_level" 
                                           value="<?php echo $tier_data ? esc_attr($tier_data['tier_level']) : ''; ?>" 
                                           class="small-text" 
                                           min="1" 
                                           step="1" 
                                           required />
                                    <p class="description"><?php esc_html_e('Numeric level (1 = lowest, higher = better). Used for sorting and comparison.', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                            
                            <tr>
                                <th scope="row">
                                    <label for="min_points"><?php esc_html_e('Minimum Points', 'twork-rewards'); ?> <span style="color: red;">*</span></label>
                                </th>
                                <td>
                                    <input type="number" 
                                           id="min_points" 
                                           name="min_points" 
                                           value="<?php echo $tier_data ? esc_attr($tier_data['min_points']) : '0'; ?>" 
                                           class="regular-text" 
                                           min="0" 
                                           step="1" 
                                           required />
                                    <p class="description"><?php esc_html_e('Minimum points required to reach this tier.', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                            
                            <tr>
                                <th scope="row">
                                    <label for="max_points"><?php esc_html_e('Maximum Points', 'twork-rewards'); ?></label>
                                </th>
                                <td>
                                    <input type="number" 
                                           id="max_points" 
                                           name="max_points" 
                                           value="<?php echo $tier_data && $tier_data['max_points'] ? esc_attr($tier_data['max_points']) : ''; ?>" 
                                           class="regular-text" 
                                           min="0" 
                                           step="1" />
                                    <p class="description"><?php esc_html_e('Maximum points for this tier (leave empty for unlimited/highest tier).', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                            
                            <tr>
                                <th scope="row">
                                    <label for="earning_multiplier"><?php esc_html_e('Earning Multiplier', 'twork-rewards'); ?> <span style="color: red;">*</span></label>
                                </th>
                                <td>
                                    <input type="number" 
                                           id="earning_multiplier" 
                                           name="earning_multiplier" 
                                           value="<?php echo $tier_data ? esc_attr($tier_data['earning_multiplier']) : '1.00'; ?>" 
                                           class="small-text" 
                                           min="0.01" 
                                           max="10.00" 
                                           step="0.01" 
                                           required />
                                    <p class="description"><?php esc_html_e('Points earning multiplier (e.g., 1.25 = 25% bonus, 1.50 = 50% bonus).', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                            
                            <tr>
                                <th scope="row">
                                    <label for="badge_color"><?php esc_html_e('Badge Color', 'twork-rewards'); ?></label>
                                </th>
                                <td>
                                    <input type="color" 
                                           id="badge_color" 
                                           name="badge_color" 
                                           value="<?php echo $tier_data ? esc_attr($tier_data['badge_color']) : '#666666'; ?>" 
                                           style="width: 100px; height: 35px;" />
                                    <p class="description"><?php esc_html_e('Color for tier badge/icon display.', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                            
                            <tr>
                                <th scope="row">
                                    <label for="badge_icon"><?php esc_html_e('Badge Icon', 'twork-rewards'); ?></label>
                                </th>
                                <td>
                                    <input type="text" 
                                           id="badge_icon" 
                                           name="badge_icon" 
                                           value="<?php echo $tier_data ? esc_attr($tier_data['badge_icon']) : ''; ?>" 
                                           class="regular-text" 
                                           placeholder="e.g., bronze-medal, star, crown" />
                                    <p class="description"><?php esc_html_e('Icon identifier for tier badge (optional).', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                            
                            <tr>
                                <th scope="row">
                                    <label for="description"><?php esc_html_e('Description', 'twork-rewards'); ?></label>
                                </th>
                                <td>
                                    <textarea id="description" 
                                              name="description" 
                                              rows="3" 
                                              class="large-text"><?php echo $tier_data ? esc_textarea($tier_data['description']) : ''; ?></textarea>
                                    <p class="description"><?php esc_html_e('Brief description of this tier.', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                            
                            <tr>
                                <th scope="row">
                                    <label for="benefits"><?php esc_html_e('Benefits', 'twork-rewards'); ?></label>
                                </th>
                                <td>
                                    <?php
                                    $benefits_text = '';
                                    if ($tier_data && !empty($tier_data['benefits'])) {
                                        $benefits_array = json_decode($tier_data['benefits'], true);
                                        if (is_array($benefits_array)) {
                                            $benefits_text = implode("\n", $benefits_array);
                                        }
                                    }
                                    ?>
                                    <textarea id="benefits" 
                                              name="benefits" 
                                              rows="5" 
                                              class="large-text" 
                                              placeholder="<?php esc_attr_e('Enter one benefit per line', 'twork-rewards'); ?>"><?php echo esc_textarea($benefits_text); ?></textarea>
                                    <p class="description"><?php esc_html_e('List of benefits for this tier (one per line).', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                            
                            <tr>
                                <th scope="row">
                                    <label for="display_order"><?php esc_html_e('Display Order', 'twork-rewards'); ?></label>
                                </th>
                                <td>
                                    <input type="number" 
                                           id="display_order" 
                                           name="display_order" 
                                           value="<?php echo $tier_data ? esc_attr($tier_data['display_order']) : '0'; ?>" 
                                           class="small-text" 
                                           min="0" 
                                           step="1" />
                                    <p class="description"><?php esc_html_e('Display order (lower numbers appear first).', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                            
                            <tr>
                                <th scope="row">
                                    <label for="is_active"><?php esc_html_e('Status', 'twork-rewards'); ?></label>
                                </th>
                                <td>
                                    <label>
                                        <input type="checkbox" 
                                               id="is_active" 
                                               name="is_active" 
                                               value="1" 
                                               <?php checked($tier_data ? $tier_data['is_active'] : 1, 1); ?> />
                                        <?php esc_html_e('Active', 'twork-rewards'); ?>
                                    </label>
                                    <p class="description"><?php esc_html_e('Inactive tiers will not be assigned to users.', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                        </table>
                        
                        <p class="submit">
                            <button type="submit" class="button button-primary button-large">
                                <?php echo $tier_data && $action === 'edit' ? esc_html__('Update Tier', 'twork-rewards') : esc_html__('Create Tier', 'twork-rewards'); ?>
                            </button>
                            <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-point-tiers', 'tab' => 'tiers'), admin_url('admin.php'))); ?>" 
                               class="button button-secondary button-large">
                                <?php esc_html_e('Cancel', 'twork-rewards'); ?>
                            </a>
                        </p>
                    </form>
                    
                    <script type="text/javascript">
                    jQuery(document).ready(function($) {
                        // Auto-generate slug from tier name
                        $('#tier_name').on('blur', function() {
                            var slugField = $('#tier_slug');
                            if (!slugField.val() || slugField.data('auto-generated')) {
                                var slug = $(this).val().toLowerCase()
                                    .replace(/[^a-z0-9]+/g, '-')
                                    .replace(/^-+|-+$/g, '');
                                slugField.val(slug);
                                slugField.data('auto-generated', true);
                            }
                        });
                        
                        // Clear auto-generated flag when user manually edits slug
                        $('#tier_slug').on('input', function() {
                            $(this).data('auto-generated', false);
                        });
                        
                        // Form validation
                        $('#tier-form').on('submit', function(e) {
                            var tierName = $('#tier_name').val().trim();
                            var tierLevel = parseInt($('#tier_level').val());
                            var minPoints = parseInt($('#min_points').val());
                            var maxPoints = $('#max_points').val() ? parseInt($('#max_points').val()) : null;
                            var multiplier = parseFloat($('#earning_multiplier').val());
                            
                            if (!tierName) {
                                alert('<?php echo esc_js(__('Tier name is required.', 'twork-rewards')); ?>');
                                e.preventDefault();
                                return false;
                            }
                            
                            if (tierLevel <= 0) {
                                alert('<?php echo esc_js(__('Tier level must be greater than 0.', 'twork-rewards')); ?>');
                                e.preventDefault();
                                return false;
                            }
                            
                            if (multiplier <= 0 || multiplier > 10) {
                                alert('<?php echo esc_js(__('Earning multiplier must be between 0.01 and 10.00.', 'twork-rewards')); ?>');
                                e.preventDefault();
                                return false;
                            }
                            
                            if (maxPoints !== null && maxPoints <= minPoints) {
                                alert('<?php echo esc_js(__('Maximum points must be greater than minimum points.', 'twork-rewards')); ?>');
                                e.preventDefault();
                                return false;
                            }
                        });
                    });
                    </script>
                </div>
            <?php else: ?>
                <!-- Tiers List View -->
                <nav class="nav-tab-wrapper">
                    <a href="<?php echo esc_url(add_query_arg('tab', 'tiers', admin_url('admin.php?page=twork-rewards-point-tiers'))); ?>" 
                       class="nav-tab <?php echo $tab === 'tiers' ? 'nav-tab-active' : ''; ?>">
                        <?php esc_html_e('Tiers Configuration', 'twork-rewards'); ?>
                    </a>
                    <a href="<?php echo esc_url(add_query_arg('tab', 'users', admin_url('admin.php?page=twork-rewards-point-tiers'))); ?>" 
                       class="nav-tab <?php echo $tab === 'users' ? 'nav-tab-active' : ''; ?>">
                        <?php esc_html_e('User Assignments', 'twork-rewards'); ?>
                    </a>
                    <a href="<?php echo esc_url(add_query_arg('tab', 'history', admin_url('admin.php?page=twork-rewards-point-tiers'))); ?>" 
                       class="nav-tab <?php echo $tab === 'history' ? 'nav-tab-active' : ''; ?>">
                        <?php esc_html_e('Tier History', 'twork-rewards'); ?>
                    </a>
                </nav>
                
                <?php if ($tab === 'tiers'): ?>
                <!-- Tiers Configuration Tab -->
                <div class="tab-content" style="margin-top: 20px;">
                    <h2><?php esc_html_e('Point Tiers Configuration', 'twork-rewards'); ?></h2>
                    <p class="description">
                        <?php esc_html_e('Configure point tiers (Bronze, Silver, Gold) with different earning multipliers and benefits.', 'twork-rewards'); ?>
                    </p>
                    
                    <?php
                    // PROFESSIONAL FEATURE: Statistics Dashboard
                    $total_tiers = count($tiers);
                    $active_tiers = 0;
                    $inactive_tiers = 0;
                    $total_users_in_tiers = 0;
                    $avg_multiplier = 0;

                    if (!empty($tiers)) {
                        foreach ($tiers as $tier) {
                            if ($tier['is_active']) {
                                $active_tiers++;
                            } else {
                                $inactive_tiers++;
                            }
                            $total_users_in_tiers += isset($tier_stats[$tier['id']]) ? $tier_stats[$tier['id']] : 0;
                            $avg_multiplier += (float) $tier['earning_multiplier'];
                        }
                        $avg_multiplier = $total_tiers > 0 ? ($avg_multiplier / $total_tiers) : 0;
                    }
                    ?>
                    
                    <!-- Statistics Dashboard -->
                    <div class="twork-stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div class="twork-stat-card" style="background: white; padding: 20px; border-left: 4px solid #2271b1; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 8px;"><?php esc_html_e('Total Tiers', 'twork-rewards'); ?></div>
                            <div style="font-size: 32px; font-weight: bold; color: #2271b1;"><?php echo esc_html(number_format($total_tiers)); ?></div>
                        </div>
                        <div class="twork-stat-card" style="background: white; padding: 20px; border-left: 4px solid #46b450; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 8px;"><?php esc_html_e('Active Tiers', 'twork-rewards'); ?></div>
                            <div style="font-size: 32px; font-weight: bold; color: #46b450;"><?php echo esc_html(number_format($active_tiers)); ?></div>
                        </div>
                        <div class="twork-stat-card" style="background: white; padding: 20px; border-left: 4px solid #d63638; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 8px;"><?php esc_html_e('Inactive Tiers', 'twork-rewards'); ?></div>
                            <div style="font-size: 32px; font-weight: bold; color: #d63638;"><?php echo esc_html(number_format($inactive_tiers)); ?></div>
                        </div>
                        <div class="twork-stat-card" style="background: white; padding: 20px; border-left: 4px solid #f0ad4e; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 8px;"><?php esc_html_e('Total Users', 'twork-rewards'); ?></div>
                            <div style="font-size: 32px; font-weight: bold; color: #f0ad4e;"><?php echo esc_html(number_format($total_users_in_tiers)); ?></div>
                        </div>
                        <div class="twork-stat-card" style="background: white; padding: 20px; border-left: 4px solid #667eea; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 8px;"><?php esc_html_e('Avg Multiplier', 'twork-rewards'); ?></div>
                            <div style="font-size: 32px; font-weight: bold; color: #667eea;"><?php echo esc_html(number_format($avg_multiplier, 2)); ?>x</div>
                        </div>
                    </div>
                    
                    <!-- Search and Filter Bar -->
                    <div style="background: white; padding: 15px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <form method="get" action="" style="display: flex; gap: 10px; align-items: center; flex: 1; min-width: 300px;">
                            <input type="hidden" name="page" value="twork-rewards-point-tiers" />
                            <input type="hidden" name="tab" value="tiers" />
                            <input type="search" 
                                   name="s" 
                                   value="<?php echo isset($_GET['s']) ? esc_attr($_GET['s']) : ''; ?>" 
                                   placeholder="<?php esc_attr_e('Search tiers by name...', 'twork-rewards'); ?>" 
                                   style="flex: 1; min-width: 200px; padding: 6px 10px;" />
                            <select name="status_filter" style="padding: 6px 10px;">
                                <option value=""><?php esc_html_e('All Status', 'twork-rewards'); ?></option>
                                <option value="active" <?php selected(isset($_GET['status_filter']) ? $_GET['status_filter'] : 'active', 'active'); ?>><?php esc_html_e('Active', 'twork-rewards'); ?></option>
                                <option value="inactive" <?php selected(isset($_GET['status_filter']) ? $_GET['status_filter'] : '', 'inactive'); ?>><?php esc_html_e('Inactive', 'twork-rewards'); ?></option>
                            </select>
                            <label style="display: flex; align-items: center; gap: 5px; padding: 6px 10px; background: #f0f0f1; border-radius: 3px;">
                                <input type="checkbox" name="show_inactive" value="1" <?php checked(isset($_GET['show_inactive']) && $_GET['show_inactive'] === '1', true); ?> />
                                <?php esc_html_e('Show Inactive', 'twork-rewards'); ?>
                            </label>
                            <select name="sort_by" style="padding: 6px 10px;">
                                <option value="level" <?php selected(isset($_GET['sort_by']) ? $_GET['sort_by'] : 'level', 'level'); ?>><?php esc_html_e('Sort by Level', 'twork-rewards'); ?></option>
                                <option value="name" <?php selected(isset($_GET['sort_by']) ? $_GET['sort_by'] : '', 'name'); ?>><?php esc_html_e('Sort by Name', 'twork-rewards'); ?></option>
                                <option value="users" <?php selected(isset($_GET['sort_by']) ? $_GET['sort_by'] : '', 'users'); ?>><?php esc_html_e('Sort by Users', 'twork-rewards'); ?></option>
                                <option value="multiplier" <?php selected(isset($_GET['sort_by']) ? $_GET['sort_by'] : '', 'multiplier'); ?>><?php esc_html_e('Sort by Multiplier', 'twork-rewards'); ?></option>
                            </select>
                            <button type="submit" class="button"><?php esc_html_e('Filter', 'twork-rewards'); ?></button>
                            <?php if (isset($_GET['s']) || isset($_GET['status_filter']) || isset($_GET['sort_by'])): ?>
                                <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-point-tiers', 'tab' => 'tiers'), admin_url('admin.php'))); ?>" 
                                   class="button"><?php esc_html_e('Clear', 'twork-rewards'); ?></a>
                            <?php endif; ?>
                        </form>
                        <div style="display: flex; gap: 10px;">
                            <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-point-tiers', 'tab' => 'tiers', 'action' => 'export'), admin_url('admin.php'))); ?>" 
                               class="button button-secondary">
                                <span class="dashicons dashicons-download" style="vertical-align: middle;"></span>
                                <?php esc_html_e('Export', 'twork-rewards'); ?>
                            </a>
                        </div>
                    </div>
                    
                    <?php
                    // PROFESSIONAL FEATURE: Handle export action
                    if (isset($_GET['action']) && $_GET['action'] === 'export' && $tab === 'tiers') {
                        $this->handle_export_tiers();
                        exit;
                    }

                    // PROFESSIONAL FEATURE: Apply filters and sorting
                    $filtered_tiers = $tiers;
                    $search_term = isset($_GET['s']) ? sanitize_text_field($_GET['s']) : '';
                    $status_filter = isset($_GET['status_filter']) ? sanitize_text_field($_GET['status_filter']) : '';
                    $sort_by = isset($_GET['sort_by']) ? sanitize_text_field($_GET['sort_by']) : 'level';

                    // Apply search filter
                    if (!empty($search_term)) {
                        $filtered_tiers = array_filter($filtered_tiers, function ($tier) use ($search_term) {
                            return stripos($tier['tier_name'], $search_term) !== false ||
                                stripos($tier['description'], $search_term) !== false;
                        });
                    }

                    // Apply status filter
                    if (!empty($status_filter)) {
                        $filtered_tiers = array_filter($filtered_tiers, function ($tier) use ($status_filter) {
                            if ($status_filter === 'active') {
                                return (bool) $tier['is_active'];
                            } else {
                                return !(bool) $tier['is_active'];
                            }
                        });
                    }

                    // Apply sorting
                    if ($sort_by === 'name') {
                        usort($filtered_tiers, function ($a, $b) {
                            return strcmp($a['tier_name'], $b['tier_name']);
                        });
                    } elseif ($sort_by === 'users') {
                        usort($filtered_tiers, function ($a, $b) use ($tier_stats) {
                            $a_users = isset($tier_stats[$a['id']]) ? $tier_stats[$a['id']] : 0;
                            $b_users = isset($tier_stats[$b['id']]) ? $tier_stats[$b['id']] : 0;
                            return $b_users - $a_users;  // Descending
                        });
                    } elseif ($sort_by === 'multiplier') {
                        usort($filtered_tiers, function ($a, $b) {
                            return (float) $b['earning_multiplier'] <=> (float) $a['earning_multiplier'];  // Descending
                        });
                    }
                    // Default is by level (already sorted in query)
                    ?>
                    
                    <!-- Bulk Actions -->
                    <form method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>" id="bulk-tiers-form">
                        <?php wp_nonce_field('twork_rewards_bulk_tier_action'); ?>
                        <input type="hidden" name="action" value="twork_rewards_bulk_tier_action" />
                        <div style="background: white; padding: 10px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; gap: 10px; align-items: center;">
                            <select name="bulk_action" id="bulk-action-select" style="padding: 6px 10px;">
                                <option value=""><?php esc_html_e('Bulk Actions', 'twork-rewards'); ?></option>
                                <option value="activate"><?php esc_html_e('Activate', 'twork-rewards'); ?></option>
                                <option value="deactivate"><?php esc_html_e('Deactivate', 'twork-rewards'); ?></option>
                                <option value="delete"><?php esc_html_e('Delete', 'twork-rewards'); ?></option>
                            </select>
                            <button type="submit" class="button" id="bulk-apply-btn"><?php esc_html_e('Apply', 'twork-rewards'); ?></button>
                            <span style="margin-left: 10px; color: #666; font-size: 13px;">
                                <?php printf(esc_html__('Showing %d of %d tiers', 'twork-rewards'), count($filtered_tiers), count($tiers)); ?>
                            </span>
                        </div>
                    
                    <table class="wp-list-table widefat fixed striped">
                        <thead>
                            <tr>
                                <th scope="col" class="manage-column column-cb check-column" style="width: 40px;">
                                    <input type="checkbox" id="cb-select-all-tiers" />
                                </th>
                                <th><?php esc_html_e('Tier Name', 'twork-rewards'); ?></th>
                                <th><?php esc_html_e('Level', 'twork-rewards'); ?></th>
                                <th><?php esc_html_e('Points Range', 'twork-rewards'); ?></th>
                                <th><?php esc_html_e('Multiplier', 'twork-rewards'); ?></th>
                                <th><?php esc_html_e('Users', 'twork-rewards'); ?></th>
                                <th><?php esc_html_e('Status', 'twork-rewards'); ?></th>
                                <th><?php esc_html_e('Actions', 'twork-rewards'); ?></th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php if (empty($filtered_tiers)): ?>
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 20px;">
                                        <?php esc_html_e('No tiers found matching your criteria.', 'twork-rewards'); ?>
                                    </td>
                                </tr>
                            <?php else: ?>
                                <?php
                                foreach ($filtered_tiers as $tier):
                                    $user_count = isset($tier_stats[$tier['id']]) ? $tier_stats[$tier['id']] : 0;
                                    $benefits = !empty($tier['benefits']) ? json_decode($tier['benefits'], true) : array();
                                    ?>
                                    <tr>
                                        <th scope="row" class="check-column">
                                            <input type="checkbox" name="tier_ids[]" value="<?php echo esc_attr($tier['id']); ?>" class="tier-checkbox" />
                                        </th>
                                        <td>
                                            <strong><?php echo esc_html($tier['tier_name']); ?></strong>
                                            <?php if (!empty($tier['badge_color'])): ?>
                                                <span style="display: inline-block; width: 20px; height: 20px; background: <?php echo esc_attr($tier['badge_color']); ?>; border-radius: 50%; margin-left: 10px; vertical-align: middle;"></span>
                                            <?php endif; ?>
                                            <br>
                                            <small style="color: #666;"><?php echo esc_html($tier['description']); ?></small>
                                        </td>
                                        <td><?php echo esc_html($tier['tier_level']); ?></td>
                                        <td>
                                            <?php
                                            echo esc_html(number_format($tier['min_points']));
                                            echo ' - ';
                                            echo $tier['max_points'] ? esc_html(number_format($tier['max_points'])) : esc_html__('âˆž', 'twork-rewards');
                                            ?>
                                        </td>
                                        <td>
                                            <strong style="color: #2271b1;">
                                                <?php echo esc_html(number_format((float) $tier['earning_multiplier'], 2)); ?>x
                                            </strong>
                                            <br>
                                            <small style="color: #666;">
                                                <?php echo esc_html(number_format((((float) $tier['earning_multiplier'] - 1) * 100), 0)); ?>% bonus
                                            </small>
                                        </td>
                                        <td>
                                            <strong><?php echo esc_html(number_format($user_count)); ?></strong>
                                            <?php esc_html_e('users', 'twork-rewards'); ?>
                                        </td>
                                        <td>
                                            <?php if ($tier['is_active']): ?>
                                                <span style="color: #46b450;"><?php esc_html_e('Active', 'twork-rewards'); ?></span>
                                            <?php else: ?>
                                                <span style="color: #d63638;"><?php esc_html_e('Inactive', 'twork-rewards'); ?></span>
                                            <?php endif; ?>
                                        </td>
                                        <td>
                                            <a href="<?php echo esc_url(add_query_arg(array('tab' => 'tiers', 'tier_id' => $tier['id'], 'action' => 'edit'), admin_url('admin.php?page=twork-rewards-point-tiers'))); ?>" 
                                               class="button button-small">
                                                <?php esc_html_e('Edit', 'twork-rewards'); ?>
                                            </a>
                                            <a href="<?php echo esc_url(add_query_arg(array('tab' => 'tiers', 'tier_id' => $tier['id'], 'action' => 'duplicate'), admin_url('admin.php?page=twork-rewards-point-tiers'))); ?>" 
                                               class="button button-small">
                                                <?php esc_html_e('Duplicate', 'twork-rewards'); ?>
                                            </a>
                                            <a href="<?php echo esc_url(admin_url('admin-post.php?action=twork_rewards_delete_tier&tier_id=' . $tier['id'] . '&_wpnonce=' . wp_create_nonce('twork_rewards_delete_tier'))); ?>" 
                                               class="button button-small button-link-delete"
                                               onclick="return confirm('<?php esc_attr_e('Are you sure you want to deactivate this tier?', 'twork-rewards'); ?>');">
                                                <?php esc_html_e('Delete', 'twork-rewards'); ?>
                                            </a>
                                        </td>
                                    </tr>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        </tbody>
                    </table>
                    </form>
                    
                    <!-- Action Buttons -->
                    <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <?php if (empty($tiers)): ?>
                            <a href="<?php echo esc_url(admin_url('admin-post.php?action=twork_rewards_initialize_tiers&_wpnonce=' . wp_create_nonce('twork_rewards_initialize_tiers'))); ?>" 
                               class="button button-primary">
                                <span class="dashicons dashicons-admin-generic" style="vertical-align: middle;"></span>
                                <?php esc_html_e('Initialize Default Tiers', 'twork-rewards'); ?>
                            </a>
                        <?php else: ?>
                            <a href="<?php echo esc_url(add_query_arg(array('tab' => 'tiers', 'action' => 'add'), admin_url('admin.php?page=twork-rewards-point-tiers'))); ?>" 
                               class="button button-primary">
                                <span class="dashicons dashicons-plus-alt" style="vertical-align: middle;"></span>
                                <?php esc_html_e('Add New Tier', 'twork-rewards'); ?>
                            </a>
                        <?php endif; ?>
                        <a href="<?php echo esc_url(admin_url('admin-post.php?action=twork_rewards_recalculate_tiers&_wpnonce=' . wp_create_nonce('twork_rewards_recalculate_tiers'))); ?>" 
                           class="button button-secondary"
                           onclick="return confirm('<?php esc_attr_e('This will recalculate and reassign tiers for all users based on their current points. Continue?', 'twork-rewards'); ?>');">
                            <span class="dashicons dashicons-update" style="vertical-align: middle;"></span>
                            <?php esc_html_e('Recalculate All User Tiers', 'twork-rewards'); ?>
                        </a>
                        <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-point-tiers', 'tab' => 'tiers', 'action' => 'export'), admin_url('admin.php'))); ?>" 
                           class="button button-secondary">
                            <span class="dashicons dashicons-download" style="vertical-align: middle;"></span>
                            <?php esc_html_e('Export CSV', 'twork-rewards'); ?>
                        </a>
                        <button type="button" class="button button-secondary" onclick="window.print();">
                            <span class="dashicons dashicons-printer" style="vertical-align: middle;"></span>
                            <?php esc_html_e('Print', 'twork-rewards'); ?>
                        </button>
                    </div>
                    
                    <script type="text/javascript">
                    jQuery(document).ready(function($) {
                        // Select all checkbox
                        $('#cb-select-all-tiers').on('change', function() {
                            $('.tier-checkbox').prop('checked', $(this).prop('checked'));
                        });
                        
                        // Update select all when individual checkboxes change
                        $('.tier-checkbox').on('change', function() {
                            var total = $('.tier-checkbox').length;
                            var checked = $('.tier-checkbox:checked').length;
                            $('#cb-select-all-tiers').prop('checked', total === checked);
                        });
                        
                        // Bulk form validation and submission
                        $('#bulk-tiers-form').on('submit', function(e) {
                            var bulkAction = $('#bulk-action-select').val();
                            var checked = $('.tier-checkbox:checked').length;
                            
                            if (!bulkAction) {
                                alert('<?php echo esc_js(__('Please select a bulk action.', 'twork-rewards')); ?>');
                                e.preventDefault();
                                return false;
                            }
                            
                            if (checked === 0) {
                                alert('<?php echo esc_js(__('Please select at least one tier.', 'twork-rewards')); ?>');
                                e.preventDefault();
                                return false;
                            }
                            
                            // Remove any existing hidden inputs for tier_ids
                            $('#bulk-tiers-form input[name="tier_ids[]"]').remove();
                            
                            // Add selected tier IDs as hidden inputs to form
                            $('.tier-checkbox:checked').each(function() {
                                var tierId = $(this).val();
                                $('<input>').attr({
                                    type: 'hidden',
                                    name: 'tier_ids[]',
                                    value: tierId
                                }).appendTo('#bulk-tiers-form');
                            });
                            
                            // Confirm before submitting
                            var actionText = $('#bulk-action-select option:selected').text();
                            if (!confirm('<?php echo esc_js(__('Are you sure you want to', 'twork-rewards')); ?> ' + actionText.toLowerCase() + ' <?php echo esc_js(__('the selected tiers?', 'twork-rewards')); ?>')) {
                                e.preventDefault();
                                return false;
                            }
                        });
                    });
                    </script>
                    
                    <?php if (isset($_GET['initialized'])): ?>
                        <div class="notice notice-success is-dismissible" style="margin-top: 15px;">
                            <p><?php esc_html_e('âœ… Default tiers initialized successfully!', 'twork-rewards'); ?></p>
                        </div>
                    <?php endif; ?>
                </div>
            <?php elseif ($tab === 'users'): ?>
                <!-- User Assignments Tab -->
                <div class="tab-content" style="margin-top: 20px;">
                    <h2><?php esc_html_e('User Tier Assignments', 'twork-rewards'); ?></h2>
                    <p class="description">
                        <?php esc_html_e('View and manage tier assignments for users.', 'twork-rewards'); ?>
                    </p>
                    
                    <?php
                    // PROFESSIONAL FEATURE: Handle export action
                    if (isset($_GET['action']) && $_GET['action'] === 'export' && $tab === 'users') {
                        $this->handle_export_user_tiers();
                        exit;
                    }

                    // Get filter parameters
                    $user_search = isset($_GET['user_search']) ? sanitize_text_field($_GET['user_search']) : '';
                    $tier_filter = isset($_GET['tier_filter']) ? absint($_GET['tier_filter']) : 0;
                    $assignment_type_filter = isset($_GET['assignment_type_filter']) ? sanitize_text_field($_GET['assignment_type_filter']) : '';
                    $sort_by = isset($_GET['sort_by']) ? sanitize_text_field($_GET['sort_by']) : 'tier_level';
                    $per_page = isset($_GET['per_page']) ? absint($_GET['per_page']) : 50;
                    $paged = isset($_GET['paged']) ? absint($_GET['paged']) : 1;
                    $offset = ($paged - 1) * $per_page;

                    // Build query
                    $where_clauses = array('ut.is_active = 1');
                    $query_params = array();

                    if (!empty($user_search)) {
                        $where_clauses[] = '(u.display_name LIKE %s OR u.user_email LIKE %s)';
                        $search_term = '%' . $wpdb->esc_like($user_search) . '%';
                        $query_params[] = $search_term;
                        $query_params[] = $search_term;
                    }

                    if ($tier_filter > 0) {
                        $where_clauses[] = 'ut.tier_id = %d';
                        $query_params[] = $tier_filter;
                    }

                    if (!empty($assignment_type_filter)) {
                        $where_clauses[] = 'ut.assignment_type = %s';
                        $query_params[] = $assignment_type_filter;
                    }

                    $where_sql = implode(' AND ', $where_clauses);

                    // Get sort order
                    $order_by = 't.tier_level DESC, ut.assigned_at DESC';
                    if ($sort_by === 'name') {
                        $order_by = 'u.display_name ASC';
                    } elseif ($sort_by === 'tier') {
                        $order_by = 't.tier_level DESC, u.display_name ASC';
                    } elseif ($sort_by === 'assigned') {
                        $order_by = 'ut.assigned_at DESC';
                    } elseif ($sort_by === 'points') {
                        $order_by = 'ut.points_at_assignment DESC';
                    }

                    // Get total count for pagination
                    $count_query = "SELECT COUNT(DISTINCT ut.id) 
                                    FROM $user_tiers_table ut
                                    INNER JOIN $tiers_table t ON ut.tier_id = t.id
                                    INNER JOIN {$wpdb->users} u ON ut.user_id = u.ID
                                    WHERE $where_sql";

                    $total_items = 0;
                    if (!empty($query_params)) {
                        $total_items = $wpdb->get_var($wpdb->prepare($count_query, $query_params));
                    } else {
                        $total_items = $wpdb->get_var($count_query);
                    }
                    $total_pages = ceil($total_items / $per_page);

                    // Get users with tier assignments (only if tables exist)
                    $users_with_tiers = array();
                    $user_tiers_table_check = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $user_tiers_table));
                    if ($user_tiers_table_check === $user_tiers_table && $tiers_table_exists) {
                        $data_query = "SELECT ut.*, t.tier_name, t.tier_slug, t.tier_level, t.earning_multiplier,
                                              t.badge_color, t.badge_icon,
                                              u.display_name, u.user_email
                                       FROM $user_tiers_table ut
                                       INNER JOIN $tiers_table t ON ut.tier_id = t.id
                                       INNER JOIN {$wpdb->users} u ON ut.user_id = u.ID
                                       WHERE $where_sql
                                       ORDER BY $order_by
                                       LIMIT %d OFFSET %d";

                        $query_params[] = $per_page;
                        $query_params[] = $offset;

                        if (!empty($query_params)) {
                            $users_with_tiers = $wpdb->get_results($wpdb->prepare($data_query, $query_params), ARRAY_A);
                        } else {
                            $users_with_tiers = $wpdb->get_results($wpdb->prepare($data_query, $per_page, $offset), ARRAY_A);
                        }
                    }

                    // Get all tiers for filter dropdown
                    $all_tiers_for_filter = array();
                    if ($tiers_table_exists) {
                        $all_tiers_for_filter = $wpdb->get_results(
                            "SELECT id, tier_name, tier_level FROM $tiers_table WHERE is_active = 1 ORDER BY tier_level ASC",
                            ARRAY_A
                        );
                    }
                    ?>
                    
                    <!-- Statistics Dashboard -->
                    <?php
                    $stats_query = "SELECT 
                        COUNT(DISTINCT ut.user_id) as total_users,
                        COUNT(DISTINCT CASE WHEN ut.assignment_type = 'automatic' THEN ut.user_id END) as auto_users,
                        COUNT(DISTINCT CASE WHEN ut.assignment_type = 'manual' THEN ut.user_id END) as manual_users,
                        AVG(t.earning_multiplier) as avg_multiplier
                        FROM $user_tiers_table ut
                        INNER JOIN $tiers_table t ON ut.tier_id = t.id
                        WHERE ut.is_active = 1";
                    $stats = $wpdb->get_row($stats_query, ARRAY_A);
                    ?>
                    <div class="twork-stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div class="twork-stat-card" style="background: white; padding: 20px; border-left: 4px solid #2271b1; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 8px;"><?php esc_html_e('Total Users', 'twork-rewards'); ?></div>
                            <div style="font-size: 32px; font-weight: bold; color: #2271b1;"><?php echo esc_html(number_format($stats ? (int) $stats['total_users'] : 0)); ?></div>
                        </div>
                        <div class="twork-stat-card" style="background: white; padding: 20px; border-left: 4px solid #46b450; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 8px;"><?php esc_html_e('Auto Assigned', 'twork-rewards'); ?></div>
                            <div style="font-size: 32px; font-weight: bold; color: #46b450;"><?php echo esc_html(number_format($stats ? (int) $stats['auto_users'] : 0)); ?></div>
                        </div>
                        <div class="twork-stat-card" style="background: white; padding: 20px; border-left: 4px solid #f0ad4e; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 8px;"><?php esc_html_e('Manual Assigned', 'twork-rewards'); ?></div>
                            <div style="font-size: 32px; font-weight: bold; color: #f0ad4e;"><?php echo esc_html(number_format($stats ? (int) $stats['manual_users'] : 0)); ?></div>
                        </div>
                        <div class="twork-stat-card" style="background: white; padding: 20px; border-left: 4px solid #667eea; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 8px;"><?php esc_html_e('Avg Multiplier', 'twork-rewards'); ?></div>
                            <div style="font-size: 32px; font-weight: bold; color: #667eea;"><?php echo esc_html(number_format($stats ? (float) $stats['avg_multiplier'] : 0, 2)); ?>x</div>
                        </div>
                    </div>
                    
                    <!-- Search and Filter Bar -->
                    <div style="background: white; padding: 15px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <form method="get" action="" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <input type="hidden" name="page" value="twork-rewards-point-tiers" />
                            <input type="hidden" name="tab" value="users" />
                            <input type="search" 
                                   name="user_search" 
                                   value="<?php echo esc_attr($user_search); ?>" 
                                   placeholder="<?php esc_attr_e('Search by name or email...', 'twork-rewards'); ?>" 
                                   style="flex: 1; min-width: 200px; padding: 6px 10px;" />
                            <select name="tier_filter" style="padding: 6px 10px;">
                                <option value=""><?php esc_html_e('All Tiers', 'twork-rewards'); ?></option>
                                <?php foreach ($all_tiers_for_filter as $tier_option): ?>
                                    <option value="<?php echo esc_attr($tier_option['id']); ?>" <?php selected($tier_filter, $tier_option['id']); ?>>
                                        <?php echo esc_html($tier_option['tier_name'] . ' (Level ' . $tier_option['tier_level'] . ')'); ?>
                                    </option>
                                <?php endforeach; ?>
                            </select>
                            <select name="assignment_type_filter" style="padding: 6px 10px;">
                                <option value=""><?php esc_html_e('All Types', 'twork-rewards'); ?></option>
                                <option value="automatic" <?php selected($assignment_type_filter, 'automatic'); ?>><?php esc_html_e('Automatic', 'twork-rewards'); ?></option>
                                <option value="manual" <?php selected($assignment_type_filter, 'manual'); ?>><?php esc_html_e('Manual', 'twork-rewards'); ?></option>
                            </select>
                            <select name="sort_by" style="padding: 6px 10px;">
                                <option value="tier_level" <?php selected($sort_by, 'tier_level'); ?>><?php esc_html_e('Sort by Tier', 'twork-rewards'); ?></option>
                                <option value="name" <?php selected($sort_by, 'name'); ?>><?php esc_html_e('Sort by Name', 'twork-rewards'); ?></option>
                                <option value="assigned" <?php selected($sort_by, 'assigned'); ?>><?php esc_html_e('Sort by Date', 'twork-rewards'); ?></option>
                                <option value="points" <?php selected($sort_by, 'points'); ?>><?php esc_html_e('Sort by Points', 'twork-rewards'); ?></option>
                            </select>
                            <select name="per_page" style="padding: 6px 10px;">
                                <option value="25" <?php selected($per_page, 25); ?>>25</option>
                                <option value="50" <?php selected($per_page, 50); ?>>50</option>
                                <option value="100" <?php selected($per_page, 100); ?>>100</option>
                                <option value="200" <?php selected($per_page, 200); ?>>200</option>
                            </select>
                            <button type="submit" class="button"><?php esc_html_e('Filter', 'twork-rewards'); ?></button>
                            <?php if ($user_search || $tier_filter || $assignment_type_filter): ?>
                                <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-point-tiers', 'tab' => 'users'), admin_url('admin.php'))); ?>" 
                                   class="button"><?php esc_html_e('Clear', 'twork-rewards'); ?></a>
                            <?php endif; ?>
                        </form>
                        <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                            <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-point-tiers', 'tab' => 'users', 'action' => 'export'), admin_url('admin.php'))); ?>" 
                               class="button button-secondary">
                                <span class="dashicons dashicons-download" style="vertical-align: middle;"></span>
                                <?php esc_html_e('Export CSV', 'twork-rewards'); ?>
                            </a>
                            <span style="color: #666; font-size: 13px;">
                                <?php printf(esc_html__('Showing %d-%d of %d users', 'twork-rewards'),
                                    $total_items > 0 ? $offset + 1 : 0,
                                    min($offset + $per_page, $total_items),
                                    $total_items); ?>
                            </span>
                        </div>
                    </div>
                    
                    <!-- Bulk Actions -->
                    <div style="background: white; padding: 10px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <form method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>" id="bulk-user-tiers-form" style="display: flex; gap: 10px; align-items: center;">
                            <?php wp_nonce_field('twork_rewards_bulk_user_tier_action'); ?>
                            <input type="hidden" name="action" value="twork_rewards_bulk_user_tier_action" />
                            <select name="bulk_action" style="padding: 6px 10px;">
                                <option value=""><?php esc_html_e('Bulk Actions', 'twork-rewards'); ?></option>
                                <option value="recalculate"><?php esc_html_e('Recalculate Tiers', 'twork-rewards'); ?></option>
                                <option value="reassign"><?php esc_html_e('Bulk Reassign', 'twork-rewards'); ?></option>
                            </select>
                            <button type="submit" class="button" onclick="return confirm('<?php esc_attr_e('Are you sure?', 'twork-rewards'); ?>');"><?php esc_html_e('Apply', 'twork-rewards'); ?></button>
                        </form>
                    </div>
                    
                    <table class="wp-list-table widefat fixed striped">
                        <thead>
                            <tr>
                                <th scope="col" class="manage-column column-cb check-column" style="width: 40px;">
                                    <input type="checkbox" id="cb-select-all-users" />
                                </th>
                                <th><?php esc_html_e('User', 'twork-rewards'); ?></th>
                                <th><?php esc_html_e('Tier', 'twork-rewards'); ?></th>
                                <th><?php esc_html_e('Points at Assignment', 'twork-rewards'); ?></th>
                                <th><?php esc_html_e('Current Points', 'twork-rewards'); ?></th>
                                <th><?php esc_html_e('Assigned', 'twork-rewards'); ?></th>
                                <th><?php esc_html_e('Type', 'twork-rewards'); ?></th>
                                <th><?php esc_html_e('Actions', 'twork-rewards'); ?></th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php if (empty($users_with_tiers)): ?>
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 20px;">
                                        <?php esc_html_e('No user tier assignments found.', 'twork-rewards'); ?>
                                    </td>
                                </tr>
                            <?php else: ?>
                                <?php
                                // PROFESSIONAL OPTIMIZATION: Batch calculate points for all users to avoid N+1 query problem
                                $user_ids = array_unique(array_column($users_with_tiers, 'user_id'));
                                $points_cache = array();
                                if (!empty($user_ids)) {
                                    // Get points for all users in batch (if possible, otherwise calculate individually)
                                    foreach ($user_ids as $uid) {
                                        $points_cache[$uid] = $this->calculate_points_balance_from_transactions($uid);
                                    }
                                }
                                foreach ($users_with_tiers as $assignment):
                                    $current_points = isset($points_cache[$assignment['user_id']]) ? $points_cache[$assignment['user_id']] : 0;
                                    ?>
                                    <tr>
                                        <th scope="row" class="check-column">
                                            <input type="checkbox" name="user_ids[]" value="<?php echo esc_attr($assignment['user_id']); ?>" class="user-checkbox" />
                                        </th>
                                        <td>
                                            <strong><?php echo esc_html($assignment['display_name']); ?></strong>
                                            <br>
                                            <small style="color: #666;"><?php echo esc_html($assignment['user_email']); ?></small>
                                            <br>
                                            <small style="color: #999;">ID: <?php echo esc_html($assignment['user_id']); ?></small>
                                        </td>
                                        <td>
                                            <strong><?php echo esc_html($assignment['tier_name']); ?></strong>
                                            <?php if (!empty($assignment['badge_color'])): ?>
                                                <span style="display: inline-block; width: 16px; height: 16px; background: <?php echo esc_attr($assignment['badge_color']); ?>; border-radius: 50%; margin-left: 8px; vertical-align: middle;"></span>
                                            <?php endif; ?>
                                            <br>
                                            <small style="color: #666;">
                                                Level <?php echo esc_html($assignment['tier_level']); ?> â€¢ 
                                                <?php echo esc_html(number_format((float) $assignment['earning_multiplier'], 2)); ?>x multiplier
                                            </small>
                                        </td>
                                        <td><?php echo esc_html(number_format($assignment['points_at_assignment'])); ?></td>
                                        <td>
                                            <strong><?php echo esc_html(number_format($current_points)); ?></strong>
                                            <?php if ($current_points != $assignment['points_at_assignment']): ?>
                                                <br>
                                                <small style="color: <?php echo $current_points > $assignment['points_at_assignment'] ? '#46b450' : '#d63638'; ?>;">
                                                    <?php
                                                    $diff = $current_points - $assignment['points_at_assignment'];
                                                    echo ($diff > 0 ? '+' : '') . esc_html(number_format($diff));
                                                    ?>
                                                </small>
                                            <?php endif; ?>
                                        </td>
                                        <td>
                                            <?php echo esc_html(date_i18n(get_option('date_format') . ' ' . get_option('time_format'), strtotime($assignment['assigned_at']))); ?>
                                            <br>
                                            <small style="color: #999;">
                                                <?php
                                                $assigned_time = strtotime($assignment['assigned_at']);
                                                $time_diff = human_time_diff($assigned_time, current_time('timestamp'));
                                                echo sprintf(esc_html__('%s ago', 'twork-rewards'), $time_diff);
                                                ?>
                                            </small>
                                        </td>
                                        <td>
                                            <?php if ($assignment['assignment_type'] === 'automatic'): ?>
                                                <span style="color: #2271b1; font-weight: 600;">
                                                    <span class="dashicons dashicons-update" style="font-size: 16px; vertical-align: middle;"></span>
                                                    <?php esc_html_e('Automatic', 'twork-rewards'); ?>
                                                </span>
                                            <?php else: ?>
                                                <span style="color: #46b450; font-weight: 600;">
                                                    <span class="dashicons dashicons-admin-users" style="font-size: 16px; vertical-align: middle;"></span>
                                                    <?php esc_html_e('Manual', 'twork-rewards'); ?>
                                                </span>
                                            <?php endif; ?>
                                        </td>
                                        <td>
                                            <a href="<?php echo esc_url(add_query_arg(array('tab' => 'users', 'user_id' => $assignment['user_id'], 'action' => 'reassign'), admin_url('admin.php?page=twork-rewards-point-tiers'))); ?>" 
                                               class="button button-small">
                                                <span class="dashicons dashicons-update" style="font-size: 14px; vertical-align: middle;"></span>
                                                <?php esc_html_e('Reassign', 'twork-rewards'); ?>
                                            </a>
                                            <a href="<?php echo esc_url(add_query_arg(array('tab' => 'users', 'user_id' => $assignment['user_id']), admin_url('admin.php?page=twork-rewards-point-tiers'))); ?>" 
                                               class="button button-small">
                                                <span class="dashicons dashicons-visibility" style="font-size: 14px; vertical-align: middle;"></span>
                                                <?php esc_html_e('View', 'twork-rewards'); ?>
                                            </a>
                                        </td>
                                    </tr>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        </tbody>
                    </table>
                    
                    <!-- Pagination -->
                    <?php if ($total_pages > 1): ?>
                        <div class="tablenav bottom" style="margin-top: 15px;">
                            <div class="tablenav-pages">
                                <?php
                                $pagination_args = array(
                                    'base' => add_query_arg('paged', '%#%'),
                                    'format' => '',
                                    'prev_text' => '&laquo;',
                                    'next_text' => '&raquo;',
                                    'total' => $total_pages,
                                    'current' => $paged,
                                );

                                // Preserve filters in pagination
                                if ($user_search) {
                                    $pagination_args['add_args'] = array('user_search' => $user_search);
                                }
                                if ($tier_filter) {
                                    $pagination_args['add_args']['tier_filter'] = $tier_filter;
                                }
                                if ($assignment_type_filter) {
                                    $pagination_args['add_args']['assignment_type_filter'] = $assignment_type_filter;
                                }
                                if ($sort_by) {
                                    $pagination_args['add_args']['sort_by'] = $sort_by;
                                }
                                if ($per_page) {
                                    $pagination_args['add_args']['per_page'] = $per_page;
                                }

                                echo paginate_links($pagination_args);
                                ?>
                            </div>
                        </div>
                    <?php endif; ?>
                    
                    <script type="text/javascript">
                    jQuery(document).ready(function($) {
                        // Select all checkbox
                        $('#cb-select-all-users').on('change', function() {
                            $('.user-checkbox').prop('checked', $(this).prop('checked'));
                        });
                        
                        // Update select all when individual checkboxes change
                        $('.user-checkbox').on('change', function() {
                            var total = $('.user-checkbox').length;
                            var checked = $('.user-checkbox:checked').length;
                            $('#cb-select-all-users').prop('checked', total === checked);
                        });
                        
                        // Bulk form validation
                        $('#bulk-user-tiers-form').on('submit', function(e) {
                            var bulkAction = $('select[name="bulk_action"]').val();
                            var checked = $('.user-checkbox:checked').length;
                            
                            if (!bulkAction) {
                                alert('<?php echo esc_js(__('Please select a bulk action.', 'twork-rewards')); ?>');
                                e.preventDefault();
                                return false;
                            }
                            
                            if (checked === 0) {
                                alert('<?php echo esc_js(__('Please select at least one user.', 'twork-rewards')); ?>');
                                e.preventDefault();
                                return false;
                            }
                            
                            // Add selected user IDs to form
                            $('.user-checkbox:checked').each(function() {
                                $(this).clone().appendTo('#bulk-user-tiers-form');
                            });
                        });
                    });
                    </script>
                </div>
            <?php elseif ($tab === 'history'): ?>
                <!-- Tier History Tab -->
                <div class="tab-content" style="margin-top: 20px;">
                    <h2><?php esc_html_e('Tier Change History', 'twork-rewards'); ?></h2>
                    <p class="description">
                        <?php esc_html_e('View audit trail of all tier changes.', 'twork-rewards'); ?>
                    </p>
                    
                    <?php
                    // Get all tiers for filter dropdown
                    $all_tiers_for_filter = array();
                    if ($tiers_table_exists) {
                        $all_tiers_for_filter = $wpdb->get_results(
                            "SELECT id, tier_name, tier_level FROM $tiers_table WHERE is_active = 1 ORDER BY tier_level ASC",
                            ARRAY_A
                        );
                    }

                    // PROFESSIONAL FEATURE: Handle export action
                    if (isset($_GET['action']) && $_GET['action'] === 'export' && $tab === 'history') {
                        $this->handle_export_tier_history();
                        exit;
                    }

                    $tier_history_table = $this->tier_history_table_name();

                    // Get filter parameters
                    $history_user_search = isset($_GET['history_user_search']) ? sanitize_text_field($_GET['history_user_search']) : '';
                    $history_tier_filter = isset($_GET['history_tier_filter']) ? absint($_GET['history_tier_filter']) : 0;
                    $change_type_filter = isset($_GET['change_type_filter']) ? sanitize_text_field($_GET['change_type_filter']) : '';
                    $date_from = isset($_GET['date_from']) ? sanitize_text_field($_GET['date_from']) : '';
                    $date_to = isset($_GET['date_to']) ? sanitize_text_field($_GET['date_to']) : '';
                    $history_sort_by = isset($_GET['history_sort_by']) ? sanitize_text_field($_GET['history_sort_by']) : 'date';
                    $history_per_page = isset($_GET['history_per_page']) ? absint($_GET['history_per_page']) : 50;
                    $history_paged = isset($_GET['history_paged']) ? absint($_GET['history_paged']) : 1;
                    $history_offset = ($history_paged - 1) * $history_per_page;

                    // Build query
                    $history_where_clauses = array('1=1');
                    $history_query_params = array();

                    if (!empty($history_user_search)) {
                        $history_where_clauses[] = '(u.display_name LIKE %s OR u.user_email LIKE %s)';
                        $history_search_term = '%' . $wpdb->esc_like($history_user_search) . '%';
                        $history_query_params[] = $history_search_term;
                        $history_query_params[] = $history_search_term;
                    }

                    if ($history_tier_filter > 0) {
                        $history_where_clauses[] = '(th.old_tier_id = %d OR th.new_tier_id = %d)';
                        $history_query_params[] = $history_tier_filter;
                        $history_query_params[] = $history_tier_filter;
                    }

                    if (!empty($change_type_filter)) {
                        $history_where_clauses[] = 'th.change_type = %s';
                        $history_query_params[] = $change_type_filter;
                    }

                    if (!empty($date_from)) {
                        $history_where_clauses[] = 'DATE(th.created_at) >= %s';
                        $history_query_params[] = $date_from;
                    }

                    if (!empty($date_to)) {
                        $history_where_clauses[] = 'DATE(th.created_at) <= %s';
                        $history_query_params[] = $date_to;
                    }

                    $history_where_sql = implode(' AND ', $history_where_clauses);

                    // Get sort order
                    $history_order_by = 'th.created_at DESC';
                    if ($history_sort_by === 'user') {
                        $history_order_by = 'u.display_name ASC, th.created_at DESC';
                    } elseif ($history_sort_by === 'tier') {
                        $history_order_by = 'new_t.tier_level DESC, th.created_at DESC';
                    } elseif ($history_sort_by === 'type') {
                        $history_order_by = 'th.change_type ASC, th.created_at DESC';
                    }

                    // Get total count for pagination
                    $history_count_query = "SELECT COUNT(*) 
                                            FROM $tier_history_table th
                                            LEFT JOIN $tiers_table old_t ON th.old_tier_id = old_t.id
                                            INNER JOIN $tiers_table new_t ON th.new_tier_id = new_t.id
                                            INNER JOIN {$wpdb->users} u ON th.user_id = u.ID
                                            WHERE $history_where_sql";

                    $history_total_items = 0;
                    if (!empty($history_query_params)) {
                        $history_total_items = $wpdb->get_var($wpdb->prepare($history_count_query, $history_query_params));
                    } else {
                        $history_total_items = $wpdb->get_var($history_count_query);
                    }
                    $history_total_pages = ceil($history_total_items / $history_per_page);

                    // Get history
                    $history = array();
                    $tier_history_table_check = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $tier_history_table));
                    if ($tier_history_table_check === $tier_history_table && $tiers_table_exists) {
                        $history_data_query = "SELECT th.*, 
                                              old_t.tier_name as old_tier_name,
                                              old_t.tier_level as old_tier_level,
                                              new_t.tier_name as new_tier_name,
                                              new_t.tier_level as new_tier_level,
                                              new_t.badge_color as new_badge_color,
                                              u.display_name, u.user_email
                                       FROM $tier_history_table th
                                       LEFT JOIN $tiers_table old_t ON th.old_tier_id = old_t.id
                                       INNER JOIN $tiers_table new_t ON th.new_tier_id = new_t.id
                                       INNER JOIN {$wpdb->users} u ON th.user_id = u.ID
                                       WHERE $history_where_sql
                                       ORDER BY $history_order_by
                                       LIMIT %d OFFSET %d";

                        $history_query_params[] = $history_per_page;
                        $history_query_params[] = $history_offset;

                        if (!empty($history_query_params)) {
                            $history = $wpdb->get_results($wpdb->prepare($history_data_query, $history_query_params), ARRAY_A);
                        } else {
                            $history = $wpdb->get_results($wpdb->prepare($history_data_query, $history_per_page, $history_offset), ARRAY_A);
                        }
                    }

                    // Get statistics
                    $history_stats_query = "SELECT 
                        COUNT(*) as total_changes,
                        COUNT(DISTINCT CASE WHEN th.change_type = 'upgrade' THEN th.id END) as upgrades,
                        COUNT(DISTINCT CASE WHEN th.change_type = 'downgrade' THEN th.id END) as downgrades,
                        COUNT(DISTINCT CASE WHEN th.change_type = 'manual' THEN th.id END) as manual_changes,
                        COUNT(DISTINCT th.user_id) as unique_users
                        FROM $tier_history_table th
                        WHERE 1=1";
                    $history_stats = $wpdb->get_row($history_stats_query, ARRAY_A);
                    ?>
                    
                    <!-- Statistics Dashboard -->
                    <div class="twork-stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div class="twork-stat-card" style="background: white; padding: 20px; border-left: 4px solid #2271b1; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 8px;"><?php esc_html_e('Total Changes', 'twork-rewards'); ?></div>
                            <div style="font-size: 32px; font-weight: bold; color: #2271b1;"><?php echo esc_html(number_format($history_stats ? (int) $history_stats['total_changes'] : 0)); ?></div>
                        </div>
                        <div class="twork-stat-card" style="background: white; padding: 20px; border-left: 4px solid #46b450; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 8px;"><?php esc_html_e('Upgrades', 'twork-rewards'); ?></div>
                            <div style="font-size: 32px; font-weight: bold; color: #46b450;"><?php echo esc_html(number_format($history_stats ? (int) $history_stats['upgrades'] : 0)); ?></div>
                        </div>
                        <div class="twork-stat-card" style="background: white; padding: 20px; border-left: 4px solid #d63638; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 8px;"><?php esc_html_e('Downgrades', 'twork-rewards'); ?></div>
                            <div style="font-size: 32px; font-weight: bold; color: #d63638;"><?php echo esc_html(number_format($history_stats ? (int) $history_stats['downgrades'] : 0)); ?></div>
                        </div>
                        <div class="twork-stat-card" style="background: white; padding: 20px; border-left: 4px solid #f0ad4e; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 8px;"><?php esc_html_e('Manual Changes', 'twork-rewards'); ?></div>
                            <div style="font-size: 32px; font-weight: bold; color: #f0ad4e;"><?php echo esc_html(number_format($history_stats ? (int) $history_stats['manual_changes'] : 0)); ?></div>
                        </div>
                        <div class="twork-stat-card" style="background: white; padding: 20px; border-left: 4px solid #667eea; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 8px;"><?php esc_html_e('Unique Users', 'twork-rewards'); ?></div>
                            <div style="font-size: 32px; font-weight: bold; color: #667eea;"><?php echo esc_html(number_format($history_stats ? (int) $history_stats['unique_users'] : 0)); ?></div>
                        </div>
                    </div>
                    
                    <!-- Search and Filter Bar -->
                    <div style="background: white; padding: 15px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <form method="get" action="" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <input type="hidden" name="page" value="twork-rewards-point-tiers" />
                            <input type="hidden" name="tab" value="history" />
                            <input type="search" 
                                   name="history_user_search" 
                                   value="<?php echo esc_attr($history_user_search); ?>" 
                                   placeholder="<?php esc_attr_e('Search by user...', 'twork-rewards'); ?>" 
                                   style="flex: 1; min-width: 200px; padding: 6px 10px;" />
                            <select name="history_tier_filter" style="padding: 6px 10px;">
                                <option value=""><?php esc_html_e('All Tiers', 'twork-rewards'); ?></option>
                                <?php foreach ($all_tiers_for_filter as $tier_option): ?>
                                    <option value="<?php echo esc_attr($tier_option['id']); ?>" <?php selected($history_tier_filter, $tier_option['id']); ?>>
                                        <?php echo esc_html($tier_option['tier_name']); ?>
                                    </option>
                                <?php endforeach; ?>
                            </select>
                            <select name="change_type_filter" style="padding: 6px 10px;">
                                <option value=""><?php esc_html_e('All Types', 'twork-rewards'); ?></option>
                                <option value="upgrade" <?php selected($change_type_filter, 'upgrade'); ?>><?php esc_html_e('Upgrade', 'twork-rewards'); ?></option>
                                <option value="downgrade" <?php selected($change_type_filter, 'downgrade'); ?>><?php esc_html_e('Downgrade', 'twork-rewards'); ?></option>
                                <option value="manual" <?php selected($change_type_filter, 'manual'); ?>><?php esc_html_e('Manual', 'twork-rewards'); ?></option>
                                <option value="initial" <?php selected($change_type_filter, 'initial'); ?>><?php esc_html_e('Initial', 'twork-rewards'); ?></option>
                            </select>
                            <input type="date" 
                                   name="date_from" 
                                   value="<?php echo esc_attr($date_from); ?>" 
                                   placeholder="<?php esc_attr_e('From Date', 'twork-rewards'); ?>" 
                                   style="padding: 6px 10px;" />
                            <input type="date" 
                                   name="date_to" 
                                   value="<?php echo esc_attr($date_to); ?>" 
                                   placeholder="<?php esc_attr_e('To Date', 'twork-rewards'); ?>" 
                                   style="padding: 6px 10px;" />
                            <select name="history_sort_by" style="padding: 6px 10px;">
                                <option value="date" <?php selected($history_sort_by, 'date'); ?>><?php esc_html_e('Sort by Date', 'twork-rewards'); ?></option>
                                <option value="user" <?php selected($history_sort_by, 'user'); ?>><?php esc_html_e('Sort by User', 'twork-rewards'); ?></option>
                                <option value="tier" <?php selected($history_sort_by, 'tier'); ?>><?php esc_html_e('Sort by Tier', 'twork-rewards'); ?></option>
                                <option value="type" <?php selected($history_sort_by, 'type'); ?>><?php esc_html_e('Sort by Type', 'twork-rewards'); ?></option>
                            </select>
                            <select name="history_per_page" style="padding: 6px 10px;">
                                <option value="25" <?php selected($history_per_page, 25); ?>>25</option>
                                <option value="50" <?php selected($history_per_page, 50); ?>>50</option>
                                <option value="100" <?php selected($history_per_page, 100); ?>>100</option>
                                <option value="200" <?php selected($history_per_page, 200); ?>>200</option>
                            </select>
                            <button type="submit" class="button"><?php esc_html_e('Filter', 'twork-rewards'); ?></button>
                            <?php if ($history_user_search || $history_tier_filter || $change_type_filter || $date_from || $date_to): ?>
                                <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-point-tiers', 'tab' => 'history'), admin_url('admin.php'))); ?>" 
                                   class="button"><?php esc_html_e('Clear', 'twork-rewards'); ?></a>
                            <?php endif; ?>
                        </form>
                        <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                            <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-point-tiers', 'tab' => 'history', 'action' => 'export'), admin_url('admin.php'))); ?>" 
                               class="button button-secondary">
                                <span class="dashicons dashicons-download" style="vertical-align: middle;"></span>
                                <?php esc_html_e('Export CSV', 'twork-rewards'); ?>
                            </a>
                            <span style="color: #666; font-size: 13px;">
                                <?php printf(esc_html__('Showing %d-%d of %d records', 'twork-rewards'),
                                    $history_total_items > 0 ? $history_offset + 1 : 0,
                                    min($history_offset + $history_per_page, $history_total_items),
                                    $history_total_items); ?>
                            </span>
                        </div>
                    </div>
                    
                    <table class="wp-list-table widefat fixed striped">
                        <thead>
                            <tr>
                                <th><?php esc_html_e('User', 'twork-rewards'); ?></th>
                                <th><?php esc_html_e('Change', 'twork-rewards'); ?></th>
                                <th><?php esc_html_e('Points', 'twork-rewards'); ?></th>
                                <th><?php esc_html_e('Date', 'twork-rewards'); ?></th>
                                <th><?php esc_html_e('Reason', 'twork-rewards'); ?></th>
                                <th><?php esc_html_e('Type', 'twork-rewards'); ?></th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php if (empty($history)): ?>
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 20px;">
                                        <?php esc_html_e('No tier change history found.', 'twork-rewards'); ?>
                                    </td>
                                </tr>
                            <?php else: ?>
                                <?php
                                foreach ($history as $entry):
                                    $change_type_color = '#2271b1';
                                    $change_type_icon = 'update';
                                    if ($entry['change_type'] === 'upgrade') {
                                        $change_type_color = '#46b450';
                                        $change_type_icon = 'arrow-up-alt';
                                    } elseif ($entry['change_type'] === 'downgrade') {
                                        $change_type_color = '#d63638';
                                        $change_type_icon = 'arrow-down-alt';
                                    } elseif ($entry['change_type'] === 'manual') {
                                        $change_type_color = '#f0ad4e';
                                        $change_type_icon = 'admin-users';
                                    }
                                    ?>
                                    <tr>
                                        <td>
                                            <strong><?php echo esc_html($entry['display_name']); ?></strong>
                                            <br>
                                            <small style="color: #666;"><?php echo esc_html($entry['user_email']); ?></small>
                                            <br>
                                            <small style="color: #999;">ID: <?php echo esc_html($entry['user_id']); ?></small>
                                        </td>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <?php if ($entry['old_tier_name']): ?>
                                                    <div style="display: flex; align-items: center; gap: 5px;">
                                                        <?php if (!empty($entry['old_tier_level'])): ?>
                                                            <span style="font-size: 11px; color: #999; background: #f0f0f1; padding: 2px 6px; border-radius: 3px;">
                                                                L<?php echo esc_html($entry['old_tier_level']); ?>
                                                            </span>
                                                        <?php endif; ?>
                                                        <span style="color: #666;"><?php echo esc_html($entry['old_tier_name']); ?></span>
                                                    </div>
                                                    <span style="color: #999; font-weight: bold;">â†’</span>
                                                <?php endif; ?>
                                                <div style="display: flex; align-items: center; gap: 5px;">
                                                    <?php if (!empty($entry['new_badge_color'])): ?>
                                                        <span style="display: inline-block; width: 16px; height: 16px; background: <?php echo esc_attr($entry['new_badge_color']); ?>; border-radius: 50%;"></span>
                                                    <?php endif; ?>
                                                    <?php if (!empty($entry['new_tier_level'])): ?>
                                                        <span style="font-size: 11px; color: #fff; background: <?php echo esc_attr($change_type_color); ?>; padding: 2px 6px; border-radius: 3px; font-weight: bold;">
                                                            L<?php echo esc_html($entry['new_tier_level']); ?>
                                                        </span>
                                                    <?php endif; ?>
                                                    <strong style="color: <?php echo esc_attr($change_type_color); ?>;">
                                                        <?php echo esc_html($entry['new_tier_name']); ?>
                                                    </strong>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <strong><?php echo esc_html(number_format($entry['points_at_change'])); ?></strong>
                                            <br>
                                            <small style="color: #666;"><?php esc_html_e('at change', 'twork-rewards'); ?></small>
                                        </td>
                                        <td>
                                            <?php echo esc_html(date_i18n(get_option('date_format') . ' ' . get_option('time_format'), strtotime($entry['created_at']))); ?>
                                            <br>
                                            <small style="color: #999;">
                                                <?php
                                                $history_time = strtotime($entry['created_at']);
                                                $history_time_diff = human_time_diff($history_time, current_time('timestamp'));
                                                echo sprintf(esc_html__('%s ago', 'twork-rewards'), $history_time_diff);
                                                ?>
                                            </small>
                                        </td>
                                        <td>
                                            <?php echo esc_html($entry['change_reason']); ?>
                                            <?php if (empty($entry['change_reason'])): ?>
                                                <span style="color: #999; font-style: italic;"><?php esc_html_e('N/A', 'twork-rewards'); ?></span>
                                            <?php endif; ?>
                                        </td>
                                        <td>
                                            <span style="color: <?php echo esc_attr($change_type_color); ?>; font-weight: 600; text-transform: capitalize;">
                                                <span class="dashicons dashicons-<?php echo esc_attr($change_type_icon); ?>" style="font-size: 16px; vertical-align: middle;"></span>
                                                <?php echo esc_html($entry['change_type']); ?>
                                            </span>
                                        </td>
                                    </tr>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        </tbody>
                    </table>
                    
                    <!-- Pagination -->
                    <?php if ($history_total_pages > 1): ?>
                        <div class="tablenav bottom" style="margin-top: 15px;">
                            <div class="tablenav-pages">
                                <?php
                                $history_pagination_args = array(
                                    'base' => add_query_arg('history_paged', '%#%'),
                                    'format' => '',
                                    'prev_text' => '&laquo;',
                                    'next_text' => '&raquo;',
                                    'total' => $history_total_pages,
                                    'current' => $history_paged,
                                );

                                // Preserve filters in pagination
                                if ($history_user_search) {
                                    $history_pagination_args['add_args'] = array('history_user_search' => $history_user_search);
                                }
                                if ($history_tier_filter) {
                                    $history_pagination_args['add_args']['history_tier_filter'] = $history_tier_filter;
                                }
                                if ($change_type_filter) {
                                    $history_pagination_args['add_args']['change_type_filter'] = $change_type_filter;
                                }
                                if ($date_from) {
                                    $history_pagination_args['add_args']['date_from'] = $date_from;
                                }
                                if ($date_to) {
                                    $history_pagination_args['add_args']['date_to'] = $date_to;
                                }
                                if ($history_sort_by) {
                                    $history_pagination_args['add_args']['history_sort_by'] = $history_sort_by;
                                }
                                if ($history_per_page) {
                                    $history_pagination_args['add_args']['history_per_page'] = $history_per_page;
                                }

                                echo paginate_links($history_pagination_args);
                                ?>
                            </div>
                        </div>
                    <?php endif; ?>
                </div>
            <?php endif; ?>
            <?php endif; ?>
        </div>
        <?php
    }

    /**
     * Handle tier save (create/update)
     */
    public function handle_tier_save()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }
        check_admin_referer('twork_rewards_save_tier');

        global $wpdb;
        $tiers_table = $this->point_tiers_table_name();

        $tier_id = isset($_POST['tier_id']) ? absint($_POST['tier_id']) : 0;
        $tier_name = isset($_POST['tier_name']) ? sanitize_text_field($_POST['tier_name']) : '';
        $tier_slug = isset($_POST['tier_slug']) ? sanitize_title($_POST['tier_slug']) : '';
        $tier_level = isset($_POST['tier_level']) ? absint($_POST['tier_level']) : 0;
        $min_points = isset($_POST['min_points']) ? absint($_POST['min_points']) : 0;
        $max_points = isset($_POST['max_points']) && !empty($_POST['max_points']) ? absint($_POST['max_points']) : null;
        $earning_multiplier = isset($_POST['earning_multiplier']) ? floatval($_POST['earning_multiplier']) : 1.0;
        $badge_color = isset($_POST['badge_color']) ? sanitize_hex_color($_POST['badge_color']) : '#666666';
        $badge_icon = isset($_POST['badge_icon']) ? sanitize_text_field($_POST['badge_icon']) : '';
        $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
        $benefits = isset($_POST['benefits']) ? sanitize_textarea_field($_POST['benefits']) : '';
        $display_order = isset($_POST['display_order']) ? absint($_POST['display_order']) : 0;
        $is_active = isset($_POST['is_active']) ? 1 : 0;

        // PROFESSIONAL VALIDATION: Validate required fields
        if (empty($tier_name)) {
            wp_die(__('Tier name is required.', 'twork-rewards'));
        }

        if ($tier_level <= 0) {
            wp_die(__('Tier level must be greater than 0.', 'twork-rewards'));
        }

        if ($earning_multiplier <= 0 || $earning_multiplier > 10) {
            wp_die(__('Earning multiplier must be between 0.01 and 10.00.', 'twork-rewards'));
        }

        // Auto-generate slug if empty
        if (empty($tier_slug)) {
            $tier_slug = sanitize_title($tier_name);
        }

        // PROFESSIONAL VALIDATION: Check for duplicate tier_level (if updating, exclude current tier)
        $existing_tier = $wpdb->get_var($wpdb->prepare(
            "SELECT id FROM $tiers_table WHERE tier_level = %d AND id != %d",
            $tier_level,
            $tier_id
        ));

        if ($existing_tier) {
            wp_die(__('A tier with this level already exists. Please choose a different level.', 'twork-rewards'));
        }

        // PROFESSIONAL VALIDATION: Check for duplicate tier_slug (if updating, exclude current tier)
        $existing_slug = $wpdb->get_var($wpdb->prepare(
            "SELECT id FROM $tiers_table WHERE tier_slug = %s AND id != %d",
            $tier_slug,
            $tier_id
        ));

        if ($existing_slug) {
            wp_die(__('A tier with this slug already exists. Please choose a different slug.', 'twork-rewards'));
        }

        // PROFESSIONAL VALIDATION: Validate points range
        if ($max_points !== null && $max_points <= $min_points) {
            wp_die(__('Maximum points must be greater than minimum points.', 'twork-rewards'));
        }

        // Parse benefits (comma-separated or newline-separated)
        $benefits_array = array_filter(array_map('trim', explode("\n", $benefits)));
        $benefits_json = json_encode($benefits_array);

        $data = array(
            'tier_name' => $tier_name,
            'tier_slug' => $tier_slug,
            'tier_level' => $tier_level,
            'min_points' => $min_points,
            'max_points' => $max_points,
            'earning_multiplier' => $earning_multiplier,
            'badge_color' => $badge_color,
            'badge_icon' => $badge_icon,
            'description' => $description,
            'benefits' => $benefits_json,
            'display_order' => $display_order,
            'is_active' => $is_active,
            'updated_at' => current_time('mysql'),
        );

        if ($tier_id > 0) {
            // Update existing tier
            $result = $wpdb->update(
                $tiers_table,
                $data,
                array('id' => $tier_id),
                array('%s', '%s', '%d', '%d', '%d', '%f', '%s', '%s', '%s', '%s', '%d', '%d', '%s'),
                array('%d')
            );

            if ($result === false) {
                wp_die(__('Failed to update tier. Please try again.', 'twork-rewards'));
            }
        } else {
            // Create new tier
            $data['created_at'] = current_time('mysql');
            $result = $wpdb->insert($tiers_table, $data, array('%s', '%s', '%d', '%d', '%d', '%f', '%s', '%s', '%s', '%s', '%d', '%d', '%s', '%s'));

            if ($result === false) {
                wp_die(__('Failed to create tier. Please try again.', 'twork-rewards'));
            }
        }

        // PROFESSIONAL OPTIMIZATION: Invalidate all tier-related caches when tier is saved
        delete_transient('twork_rest_all_tiers');
        delete_transient('twork_tier_thresholds');

        wp_safe_redirect(add_query_arg(array('page' => 'twork-rewards-point-tiers', 'tab' => 'tiers', 'updated' => 1), admin_url('admin.php')));
        exit;
    }

    /**
     * Handle tier deletion
     */
    public function handle_tier_delete()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }
        check_admin_referer('twork_rewards_delete_tier');

        global $wpdb;
        $tiers_table = $this->point_tiers_table_name();
        $tier_id = isset($_GET['tier_id']) ? absint($_GET['tier_id']) : 0;

        if ($tier_id > 0) {
            // PROFESSIONAL FIX: Check if tier exists and get tier name for logging
            $tier = $wpdb->get_row($wpdb->prepare(
                "SELECT tier_name, is_active FROM $tiers_table WHERE id = %d",
                $tier_id
            ), ARRAY_A);

            if ($tier) {
                // Deactivate instead of delete (soft delete)
                $result = $wpdb->update(
                    $tiers_table,
                    array('is_active' => 0, 'updated_at' => current_time('mysql')),
                    array('id' => $tier_id),
                    array('%d', '%s'),
                    array('%d')
                );

                if ($result !== false) {
                    // PROFESSIONAL OPTIMIZATION: Invalidate all tier-related caches when tier is deleted
                    delete_transient('twork_rest_all_tiers');
                    delete_transient('twork_tier_thresholds');

                    // Log for debugging
                    if (defined('WP_DEBUG') && WP_DEBUG) {
                        error_log(sprintf(
                            'T-Work Rewards: Tier deleted (deactivated). Tier ID: %d, Tier Name: %s',
                            $tier_id,
                            $tier['tier_name']
                        ));
                    }
                } else {
                    // Log error if update failed
                    if (defined('WP_DEBUG') && WP_DEBUG) {
                        error_log(sprintf(
                            'T-Work Rewards: Failed to delete tier. Tier ID: %d, Error: %s',
                            $tier_id,
                            $wpdb->last_error
                        ));
                    }
                }
            }
        }

        wp_safe_redirect(add_query_arg(array('page' => 'twork-rewards-point-tiers', 'tab' => 'tiers', 'deleted' => 1), admin_url('admin.php')));
        exit;
    }

    /**
     * Handle user tier assignment (manual)
     */
    public function handle_user_tier_assign()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }
        check_admin_referer('twork_rewards_assign_user_tier');

        $user_id = isset($_POST['user_id']) ? absint($_POST['user_id']) : 0;
        $tier_id = isset($_POST['tier_id']) ? absint($_POST['tier_id']) : 0;

        if ($user_id > 0 && $tier_id > 0) {
            $points_balance = $this->calculate_points_balance_from_transactions($user_id);
            $this->assign_user_tier($user_id, $tier_id, 'manual', $points_balance, get_current_user_id());
        }

        wp_safe_redirect(add_query_arg(array('page' => 'twork-rewards-point-tiers', 'tab' => 'users', 'assigned' => 1), admin_url('admin.php')));
        exit;
    }

    /**
     * Handle recalculate all user tiers
     */
    public function handle_recalculate_tiers()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }
        check_admin_referer('twork_rewards_recalculate_tiers');

        // Get all users
        $users = get_users(array('fields' => 'ID'));
        $recalculated = 0;

        foreach ($users as $user_id) {
            $tier = $this->calculate_user_tier($user_id, true);
            if ($tier) {
                $recalculated++;
            }
        }

        wp_safe_redirect(add_query_arg(array('page' => 'twork-rewards-point-tiers', 'tab' => 'tiers', 'recalculated' => $recalculated), admin_url('admin.php')));
        exit;
    }

    /**
     * Handle initialize default tiers
     */
    public function handle_initialize_tiers()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }
        check_admin_referer('twork_rewards_initialize_tiers');

        // Ensure tables exist
        $this->create_point_tiers_tables();

        // Initialize default tiers (will only insert if table is empty)
        $this->initialize_default_tiers();

        wp_safe_redirect(add_query_arg(array('page' => 'twork-rewards-point-tiers', 'tab' => 'tiers', 'initialized' => 1), admin_url('admin.php')));
        exit;
    }

    /**
     * PROFESSIONAL FEATURE: Handle bulk tier actions (activate, deactivate, delete)
     */
    public function handle_bulk_tier_action()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }
        check_admin_referer('twork_rewards_bulk_tier_action');

        $bulk_action = isset($_POST['bulk_action']) ? sanitize_text_field($_POST['bulk_action']) : '';
        $tier_ids = isset($_POST['tier_ids']) ? array_map('absint', $_POST['tier_ids']) : array();

        if (empty($bulk_action) || empty($tier_ids)) {
            wp_safe_redirect(add_query_arg(array('page' => 'twork-rewards-point-tiers', 'tab' => 'tiers', 'error' => 'no_selection'), admin_url('admin.php')));
            exit;
        }

        global $wpdb;
        $tiers_table = $this->point_tiers_table_name();
        $updated = 0;

        foreach ($tier_ids as $tier_id) {
            if ($tier_id <= 0) {
                continue;
            }

            if ($bulk_action === 'activate') {
                $result = $wpdb->update(
                    $tiers_table,
                    array('is_active' => 1, 'updated_at' => current_time('mysql')),
                    array('id' => $tier_id),
                    array('%d', '%s'),
                    array('%d')
                );
                if ($result !== false) {
                    $updated++;
                }
            } elseif ($bulk_action === 'deactivate') {
                $result = $wpdb->update(
                    $tiers_table,
                    array('is_active' => 0, 'updated_at' => current_time('mysql')),
                    array('id' => $tier_id),
                    array('%d', '%s'),
                    array('%d')
                );
                if ($result !== false) {
                    $updated++;
                }
            } elseif ($bulk_action === 'delete') {
                // Soft delete (deactivate)
                $result = $wpdb->update(
                    $tiers_table,
                    array('is_active' => 0, 'updated_at' => current_time('mysql')),
                    array('id' => $tier_id),
                    array('%d', '%s'),
                    array('%d')
                );
                if ($result !== false) {
                    $updated++;
                }
            }
        }

        $message = 'bulk_updated';
        if ($bulk_action === 'activate') {
            $message = 'bulk_activated';
        } elseif ($bulk_action === 'deactivate') {
            $message = 'bulk_deactivated';
        } elseif ($bulk_action === 'delete') {
            $message = 'bulk_deleted';
        }

        // PROFESSIONAL OPTIMIZATION: Invalidate caches after bulk operations
        if ($updated > 0) {
            delete_transient('twork_rest_all_tiers');
            delete_transient('twork_tier_thresholds');
        }

        wp_safe_redirect(add_query_arg(array('page' => 'twork-rewards-point-tiers', 'tab' => 'tiers', $message => $updated), admin_url('admin.php')));
        exit;
    }

    /**
     * PROFESSIONAL FEATURE: Export tiers to CSV
     */
    public function handle_export_tiers()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }

        global $wpdb;
        $tiers_table = $this->point_tiers_table_name();
        $user_tiers_table = $this->user_tiers_table_name();

        // Get all tiers
        $tiers = $wpdb->get_results("SELECT * FROM $tiers_table ORDER BY tier_level ASC", ARRAY_A);

        // Get user counts for each tier
        $tier_user_counts = array();
        if ($wpdb->get_var("SHOW TABLES LIKE '$user_tiers_table'") === $user_tiers_table) {
            $user_counts = $wpdb->get_results(
                "SELECT tier_id, COUNT(DISTINCT user_id) as user_count 
                 FROM $user_tiers_table 
                 WHERE is_active = 1 
                 GROUP BY tier_id",
                ARRAY_A
            );
            foreach ($user_counts as $count) {
                $tier_user_counts[$count['tier_id']] = $count['user_count'];
            }
        }

        // Set headers for CSV download
        header('Content-Type: text/csv; charset=utf-8');
        header('Content-Disposition: attachment; filename=twork-tiers-' . date('Y-m-d') . '.csv');
        header('Pragma: no-cache');
        header('Expires: 0');

        $output = fopen('php://output', 'w');

        // Add BOM for UTF-8
        fprintf($output, chr(0xEF) . chr(0xBB) . chr(0xBF));

        // CSV Headers
        fputcsv($output, array(
            __('ID', 'twork-rewards'),
            __('Tier Name', 'twork-rewards'),
            __('Slug', 'twork-rewards'),
            __('Level', 'twork-rewards'),
            __('Min Points', 'twork-rewards'),
            __('Max Points', 'twork-rewards'),
            __('Earning Multiplier', 'twork-rewards'),
            __('Badge Color', 'twork-rewards'),
            __('Badge Icon', 'twork-rewards'),
            __('Description', 'twork-rewards'),
            __('Benefits', 'twork-rewards'),
            __('Users Count', 'twork-rewards'),
            __('Status', 'twork-rewards'),
            __('Display Order', 'twork-rewards'),
            __('Created At', 'twork-rewards'),
            __('Updated At', 'twork-rewards'),
        ));

        // CSV Data
        foreach ($tiers as $tier) {
            $benefits = !empty($tier['benefits']) ? json_decode($tier['benefits'], true) : array();
            $benefits_text = is_array($benefits) ? implode('; ', $benefits) : '';
            $user_count = isset($tier_user_counts[$tier['id']]) ? $tier_user_counts[$tier['id']] : 0;

            fputcsv($output, array(
                $tier['id'],
                $tier['tier_name'],
                $tier['tier_slug'],
                $tier['tier_level'],
                $tier['min_points'],
                $tier['max_points'] ? $tier['max_points'] : __('Unlimited', 'twork-rewards'),
                $tier['earning_multiplier'],
                $tier['badge_color'],
                $tier['badge_icon'] ? $tier['badge_icon'] : '',
                $tier['description'],
                $benefits_text,
                $user_count,
                $tier['is_active'] ? __('Active', 'twork-rewards') : __('Inactive', 'twork-rewards'),
                $tier['display_order'],
                $tier['created_at'],
                $tier['updated_at'],
            ));
        }

        fclose($output);
        exit;
    }

    /**
     * PROFESSIONAL FEATURE: Handle bulk user tier actions (assign, remove, recalculate)
     */
    public function handle_bulk_user_tier_action()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }
        check_admin_referer('twork_rewards_bulk_user_tier_action');

        $bulk_action = isset($_POST['bulk_action']) ? sanitize_text_field($_POST['bulk_action']) : '';
        $user_ids = isset($_POST['user_ids']) ? array_map('absint', $_POST['user_ids']) : array();
        $tier_id = isset($_POST['tier_id']) ? absint($_POST['tier_id']) : 0;

        if (empty($bulk_action) || empty($user_ids)) {
            wp_safe_redirect(add_query_arg(array('page' => 'twork-rewards-point-tiers', 'tab' => 'users', 'error' => 'no_selection'), admin_url('admin.php')));
            exit;
        }

        global $wpdb;
        $user_tiers_table = $this->user_tiers_table_name();
        $updated = 0;

        foreach ($user_ids as $user_id) {
            if ($user_id <= 0) {
                continue;
            }

            if ($bulk_action === 'assign' && $tier_id > 0) {
                $points_balance = $this->calculate_points_balance_from_transactions($user_id);
                $result = $this->assign_user_tier($user_id, $tier_id, 'manual', $points_balance, get_current_user_id());
                if ($result) {
                    $updated++;
                }
            } elseif ($bulk_action === 'remove') {
                // Deactivate all tier assignments for user
                $result = $wpdb->update(
                    $user_tiers_table,
                    array('is_active' => 0, 'updated_at' => current_time('mysql')),
                    array('user_id' => $user_id, 'is_active' => 1),
                    array('%d', '%s'),
                    array('%d', '%d')
                );
                if ($result !== false) {
                    $updated++;
                }
            } elseif ($bulk_action === 'recalculate') {
                $tier = $this->calculate_user_tier($user_id, true);
                if ($tier) {
                    $updated++;
                }
            }
        }

        $message = 'bulk_updated';
        if ($bulk_action === 'assign') {
            $message = 'bulk_assigned';
        } elseif ($bulk_action === 'remove') {
            $message = 'bulk_removed';
        } elseif ($bulk_action === 'recalculate') {
            $message = 'bulk_recalculated';
        }

        wp_safe_redirect(add_query_arg(array('page' => 'twork-rewards-point-tiers', 'tab' => 'users', $message => $updated), admin_url('admin.php')));
        exit;
    }

    /**
     * PROFESSIONAL FEATURE: Export user tier assignments to CSV
     */
    public function handle_export_user_tiers()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }

        global $wpdb;
        $user_tiers_table = $this->user_tiers_table_name();
        $tiers_table = $this->point_tiers_table_name();

        // Check if tables exist
        $user_tiers_check = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $user_tiers_table));
        $tiers_check = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $tiers_table));

        if ($user_tiers_check !== $user_tiers_table || $tiers_check !== $tiers_table) {
            wp_die(__('Tier tables do not exist.', 'twork-rewards'));
        }

        // Get all user tier assignments with tier and user details
        $assignments = $wpdb->get_results(
            "SELECT ut.*, t.tier_name, t.tier_slug, t.tier_level, t.earning_multiplier,
                    u.user_login, u.user_email, u.display_name
             FROM $user_tiers_table ut
             INNER JOIN $tiers_table t ON ut.tier_id = t.id
             LEFT JOIN {$wpdb->users} u ON ut.user_id = u.ID
             ORDER BY ut.assigned_at DESC",
            ARRAY_A
        );

        // Set headers for CSV download
        header('Content-Type: text/csv; charset=utf-8');
        header('Content-Disposition: attachment; filename=twork-user-tiers-' . date('Y-m-d') . '.csv');
        header('Pragma: no-cache');
        header('Expires: 0');

        $output = fopen('php://output', 'w');

        // Add BOM for UTF-8
        fprintf($output, chr(0xEF) . chr(0xBB) . chr(0xBF));

        // CSV Headers
        fputcsv($output, array(
            __('User ID', 'twork-rewards'),
            __('Username', 'twork-rewards'),
            __('Email', 'twork-rewards'),
            __('Display Name', 'twork-rewards'),
            __('Tier ID', 'twork-rewards'),
            __('Tier Name', 'twork-rewards'),
            __('Tier Level', 'twork-rewards'),
            __('Earning Multiplier', 'twork-rewards'),
            __('Assignment Type', 'twork-rewards'),
            __('Points at Assignment', 'twork-rewards'),
            __('Assigned By', 'twork-rewards'),
            __('Assigned At', 'twork-rewards'),
            __('Status', 'twork-rewards'),
        ));

        // CSV Data
        foreach ($assignments as $assignment) {
            $assigned_by_user = $assignment['assigned_by'] ? get_userdata($assignment['assigned_by']) : null;
            $assigned_by_name = $assigned_by_user ? $assigned_by_user->display_name : __('System', 'twork-rewards');

            fputcsv($output, array(
                $assignment['user_id'],
                $assignment['user_login'] ?? '',
                $assignment['user_email'] ?? '',
                $assignment['display_name'] ?? '',
                $assignment['tier_id'],
                $assignment['tier_name'],
                $assignment['tier_level'],
                $assignment['earning_multiplier'],
                ucfirst($assignment['assignment_type']),
                $assignment['points_at_assignment'],
                $assigned_by_name,
                $assignment['assigned_at'],
                $assignment['is_active'] ? __('Active', 'twork-rewards') : __('Inactive', 'twork-rewards'),
            ));
        }

        fclose($output);
        exit;
    }

    /**
     * PROFESSIONAL FEATURE: Export tier history to CSV
     */
    public function handle_export_tier_history()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }

        global $wpdb;
        $tier_history_table = $this->tier_history_table_name();
        $tiers_table = $this->point_tiers_table_name();

        // Check if tables exist
        $history_check = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $tier_history_table));
        $tiers_check = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $tiers_table));

        if ($history_check !== $tier_history_table || $tiers_check !== $tiers_table) {
            wp_die(__('Tier history table does not exist.', 'twork-rewards'));
        }

        // Get all tier history with tier and user details
        $history = $wpdb->get_results(
            "SELECT th.*, 
                    old_tier.tier_name as old_tier_name, old_tier.tier_level as old_tier_level,
                    new_tier.tier_name as new_tier_name, new_tier.tier_level as new_tier_level,
                    u.user_login, u.user_email, u.display_name,
                    changed_by_user.display_name as changed_by_name
             FROM $tier_history_table th
             LEFT JOIN $tiers_table old_tier ON th.old_tier_id = old_tier.id
             INNER JOIN $tiers_table new_tier ON th.new_tier_id = new_tier.id
             LEFT JOIN {$wpdb->users} u ON th.user_id = u.ID
             LEFT JOIN {$wpdb->users} changed_by_user ON th.changed_by = changed_by_user.ID
             ORDER BY th.changed_at DESC",
            ARRAY_A
        );

        // Set headers for CSV download
        header('Content-Type: text/csv; charset=utf-8');
        header('Content-Disposition: attachment; filename=twork-tier-history-' . date('Y-m-d') . '.csv');
        header('Pragma: no-cache');
        header('Expires: 0');

        $output = fopen('php://output', 'w');

        // Add BOM for UTF-8
        fprintf($output, chr(0xEF) . chr(0xBB) . chr(0xBF));

        // CSV Headers
        fputcsv($output, array(
            __('ID', 'twork-rewards'),
            __('User ID', 'twork-rewards'),
            __('Username', 'twork-rewards'),
            __('Email', 'twork-rewards'),
            __('Old Tier', 'twork-rewards'),
            __('Old Tier Level', 'twork-rewards'),
            __('New Tier', 'twork-rewards'),
            __('New Tier Level', 'twork-rewards'),
            __('Change Type', 'twork-rewards'),
            __('Points at Change', 'twork-rewards'),
            __('Changed By', 'twork-rewards'),
            __('Change Reason', 'twork-rewards'),
            __('Changed At', 'twork-rewards'),
        ));

        // CSV Data
        foreach ($history as $entry) {
            fputcsv($output, array(
                $entry['id'],
                $entry['user_id'],
                $entry['user_login'] ?? '',
                $entry['user_email'] ?? '',
                $entry['old_tier_name'] ?? __('None', 'twork-rewards'),
                $entry['old_tier_level'] ?? '',
                $entry['new_tier_name'],
                $entry['new_tier_level'],
                ucfirst($entry['change_type']),
                $entry['points_at_change'],
                $entry['changed_by_name'] ?? __('System', 'twork-rewards'),
                $entry['change_reason'],
                $entry['changed_at'],
            ));
        }

        fclose($output);
        exit;
    }

    /**
     * Get User Page settings with defaults
     *
     * @return array Array of User Page settings with default values
     */
    public function get_user_page_settings()
    {
        return array(
            'per_page' => absint(get_option(self::OPTION_USER_PAGE_PER_PAGE, 50)),
            'default_sort' => sanitize_text_field(get_option(self::OPTION_USER_PAGE_DEFAULT_SORT, 'activity')),
            'default_order' => sanitize_text_field(get_option(self::OPTION_USER_PAGE_DEFAULT_ORDER, 'DESC')),
            'default_activity_filter' => sanitize_text_field(get_option(self::OPTION_USER_PAGE_DEFAULT_ACTIVITY_FILTER, 'all')),
            'inactivity_threshold' => absint(get_option(self::OPTION_USER_PAGE_INACTIVITY_THRESHOLD, 30)),
            'show_stats' => (int) get_option(self::OPTION_USER_PAGE_SHOW_STATS, 1),
            'show_activity_score' => (int) get_option(self::OPTION_USER_PAGE_SHOW_ACTIVITY_SCORE, 1),
            'show_phone' => (int) get_option(self::OPTION_USER_PAGE_SHOW_PHONE, 1),
            'show_last_updated' => (int) get_option(self::OPTION_USER_PAGE_SHOW_LAST_UPDATED, 1),
            'show_activity_badge' => (int) get_option(self::OPTION_USER_PAGE_SHOW_ACTIVITY_BADGE, 1),
            'enable_export' => (int) get_option(self::OPTION_USER_PAGE_ENABLE_EXPORT, 1),
            'export_format' => sanitize_text_field(get_option(self::OPTION_USER_PAGE_EXPORT_FORMAT, 'csv')),
            'batch_size' => absint(get_option(self::OPTION_USER_PAGE_BATCH_SIZE, 50)),
            'enable_caching' => (int) get_option(self::OPTION_USER_PAGE_ENABLE_CACHING, 1),
            'cache_duration' => absint(get_option(self::OPTION_USER_PAGE_CACHE_DURATION, 300)),
            'show_search' => (int) get_option(self::OPTION_USER_PAGE_SHOW_SEARCH, 1),
            'show_filters' => (int) get_option(self::OPTION_USER_PAGE_SHOW_FILTERS, 1),
            'show_pagination' => (int) get_option(self::OPTION_USER_PAGE_SHOW_PAGINATION, 1),
            'activity_score_weight_login' => absint(get_option(self::OPTION_USER_PAGE_ACTIVITY_SCORE_WEIGHT_LOGIN, 30)),
            'activity_score_weight_order' => absint(get_option(self::OPTION_USER_PAGE_ACTIVITY_SCORE_WEIGHT_ORDER, 40)),
            'activity_score_weight_transaction' => absint(get_option(self::OPTION_USER_PAGE_ACTIVITY_SCORE_WEIGHT_TRANSACTION, 30)),
            'date_format' => sanitize_text_field(get_option(self::OPTION_USER_PAGE_DATE_FORMAT, 'wp_default')),
            'time_format' => sanitize_text_field(get_option(self::OPTION_USER_PAGE_TIME_FORMAT, 'wp_default')),
            'show_avatar' => (int) get_option(self::OPTION_USER_PAGE_SHOW_AVATAR, 0),
            'show_email' => (int) get_option(self::OPTION_USER_PAGE_SHOW_EMAIL, 1),
            'show_points' => (int) get_option(self::OPTION_USER_PAGE_SHOW_POINTS, 1),
            'columns_order' => sanitize_text_field(get_option(self::OPTION_USER_PAGE_COLUMNS_ORDER, '')),
            'enable_bulk_actions' => (int) get_option(self::OPTION_USER_PAGE_ENABLE_BULK_ACTIONS, 1),
            'show_quick_actions' => (int) get_option(self::OPTION_USER_PAGE_SHOW_QUICK_ACTIONS, 1),
            'default_view' => sanitize_text_field(get_option(self::OPTION_USER_PAGE_DEFAULT_VIEW, 'list')),
            'enable_advanced_filters' => (int) get_option(self::OPTION_USER_PAGE_ENABLE_ADVANCED_FILTERS, 0),
            'show_user_tier' => (int) get_option(self::OPTION_USER_PAGE_SHOW_USER_TIER, 1),
            'show_registration_date' => (int) get_option(self::OPTION_USER_PAGE_SHOW_REGISTRATION_DATE, 0),
            'show_total_transactions' => (int) get_option(self::OPTION_USER_PAGE_SHOW_TOTAL_TRANSACTIONS, 0),
            'enable_real_time_updates' => (int) get_option(self::OPTION_USER_PAGE_ENABLE_REAL_TIME_UPDATES, 0),
            'auto_refresh_interval' => absint(get_option(self::OPTION_USER_PAGE_AUTO_REFRESH_INTERVAL, 30)),
        );
    }

    /**
     * Settings page
     */
    public function render_settings_page()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('You do not have permission to access this page.', 'twork-rewards'));
        }

        $webhook_url = get_option('twork_rewards_webhook_url', '');
        $luckybox_enabled = (int) get_option(self::OPTION_LUCKYBOX_ENABLED, 1);
        $luckybox_banner = get_option(self::OPTION_LUCKYBOX_BANNER, '');
        $min_exchange_points = (int) get_option('twork_rewards_min_exchange_points', 100);
        $app_update_enabled = (int) get_option('twork_rewards_app_update_enabled', 0);
        $app_update_link = get_option('twork_rewards_app_update_link', '');
        $app_update_version = get_option('twork_rewards_app_update_version', '');
        $timezone = get_option('twork_rewards_timezone', 'Asia/Yangon');
        ?>
        <div class="wrap">
            <h1><?php esc_html_e('T-Work Rewards Settings', 'twork-rewards'); ?></h1>
            <form method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>">
                <?php wp_nonce_field('twork_rewards_save_settings'); ?>
                <input type="hidden" name="action" value="twork_rewards_save_settings" />
                <table class="form-table">
                    <tr>
                        <th scope="row">
                            <label for="twork_rewards_min_exchange_points"><?php esc_html_e('Minimum Exchange Points (PNP)', 'twork-rewards'); ?></label>
                        </th>
                        <td>
                            <input type="number" 
                                   class="regular-text" 
                                   name="twork_rewards_min_exchange_points" 
                                   id="twork_rewards_min_exchange_points"
                                   value="<?php echo esc_attr($min_exchange_points); ?>" 
                                   min="0" 
                                   step="1"
                                   placeholder="100" />
                            <p class="description">
                                <?php esc_html_e('Minimum points (PNP) required for users to exchange/withdraw points. Users must have at least this amount of points to create an exchange request.', 'twork-rewards'); ?>
                            </p>
                            <p class="description">
                                <strong><?php esc_html_e('Example:', 'twork-rewards'); ?></strong> 
                                <?php esc_html_e('If set to 100, users need at least 100 PNP in their account to exchange points.', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="twork_rewards_luckybox_enabled"><?php esc_html_e('Lucky Box (Front-end)', 'twork-rewards'); ?></label>
                        </th>
                        <td>
                            <label>
                                <input type="checkbox"
                                       name="twork_rewards_luckybox_enabled"
                                       id="twork_rewards_luckybox_enabled"
                                       value="1" <?php checked($luckybox_enabled, 1); ?> />
                                <?php esc_html_e('Default Lucky Box state for users (can be overridden per user)', 'twork-rewards'); ?>
                            </label>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="twork_rewards_luckybox_banner"><?php esc_html_e('Lucky Box Banner Content', 'twork-rewards'); ?></label>
                        </th>
                        <td>
                            <?php
                            // Use wp_editor for rich text editing
                            wp_editor(
                                $luckybox_banner,
                                'twork_rewards_luckybox_banner',
                                array(
                                    'textarea_name' => 'twork_rewards_luckybox_banner',
                                    'textarea_rows' => 15,
                                    'media_buttons' => true,
                                    'teeny' => false,
                                    'tinymce' => array(
                                        'toolbar1' => 'bold,italic,underline,strikethrough,|,bullist,numlist,|,link,unlink,|,forecolor,backcolor,|,alignleft,aligncenter,alignright,|,code,fullscreen',
                                        'toolbar2' => '',
                                    ),
                                )
                            );
                            ?>
                            <p class="description">
                                <?php esc_html_e('Creative banner content displayed below the Lucky Box button. Supports HTML, CSS, and images. This content will be rendered in the mobile app.', 'twork-rewards'); ?>
                            </p>
                            <p class="description">
                                <strong><?php esc_html_e('Tips:', 'twork-rewards'); ?></strong><br>
                                <?php esc_html_e('â€¢ Use inline CSS for styling', 'twork-rewards'); ?><br>
                                <?php esc_html_e('â€¢ Keep content mobile-friendly', 'twork-rewards'); ?><br>
                                <?php esc_html_e('â€¢ Use relative URLs or full URLs for images', 'twork-rewards'); ?><br>
                                <?php esc_html_e('â€¢ Test on mobile devices for best results', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="twork_rewards_webhook_url"><?php esc_html_e('Webhook URL (FCM server)', 'twork-rewards'); ?></label>
                        </th>
                        <td>
                            <input type="url" class="large-text" name="twork_rewards_webhook_url" id="twork_rewards_webhook_url"
                                   value="<?php echo esc_attr($webhook_url); ?>"
                                   placeholder="<?php esc_attr_e('https://your-server.com/api/webhook/reward-updated', 'twork-rewards'); ?>" />
                            <p class="description">
                                <?php
                                // Check if FCM plugin is available
                                $fcm_available = function_exists('twork_send_fcm');
                                $notification_status = $this->get_notification_system_status();

                                if ($fcm_available) {
                                    esc_html_e('âœ… FCM Notify Plugin is active! Notifications will be sent directly via FCM (more efficient).', 'twork-rewards');
                                    echo '<br>';
                                    esc_html_e('Webhook URL is only used as fallback if FCM plugin is deactivated.', 'twork-rewards');
                                } else {
                                    esc_html_e('âš ï¸ FCM Notify Plugin not detected. Notifications will be sent via webhook server.', 'twork-rewards');
                                    echo '<br>';
                                    esc_html_e('For better performance, install and activate the "T-Work FCM Notify" plugin.', 'twork-rewards');
                                }
                                ?>
                            </p>
                            <?php if ($fcm_available): ?>
                            <p class="description" style="color: #46b450; font-weight: 600;">
                                <?php esc_html_e('âœ¨ Professional Integration: Using direct FCM sending (no external webhook server needed)', 'twork-rewards'); ?>
                            </p>
                            <?php endif; ?>
                            
                            <!-- Notification System Diagnostics -->
                            <div style="margin-top: 15px; padding: 15px; background: #f0f0f1; border-left: 4px solid #2271b1; border-radius: 3px;">
                                <h3 style="margin-top: 0; font-size: 14px; font-weight: 600;">
                                    <span class="dashicons dashicons-info" style="vertical-align: middle;"></span>
                                    <?php esc_html_e('Notification System Status', 'twork-rewards'); ?>
                                </h3>
                                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                                    <tr>
                                        <td style="padding: 5px 0; font-weight: 600; width: 200px;">
                                            <?php esc_html_e('FCM Plugin:', 'twork-rewards'); ?>
                                        </td>
                                        <td style="padding: 5px 0;">
                                            <?php if ($notification_status['fcm_plugin_available']): ?>
                                                <span style="color: #46b450;">âœ… <?php esc_html_e('Available', 'twork-rewards'); ?></span>
                                            <?php else: ?>
                                                <span style="color: #d63638;">âŒ <?php esc_html_e('Not Available', 'twork-rewards'); ?></span>
                                            <?php endif; ?>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 5px 0; font-weight: 600;">
                                            <?php esc_html_e('Webhook URL:', 'twork-rewards'); ?>
                                        </td>
                                        <td style="padding: 5px 0;">
                                            <?php if ($notification_status['webhook_url_configured']): ?>
                                                <span style="color: #46b450;">âœ… <?php esc_html_e('Configured', 'twork-rewards'); ?></span>
                                                <div style="font-size: 11px; color: #666; margin-top: 2px; word-break: break-all;">
                                                    <?php echo esc_html($notification_status['webhook_url']); ?>
                                                </div>
                                            <?php else: ?>
                                                <span style="color: #d63638;">âŒ <?php esc_html_e('Not Configured', 'twork-rewards'); ?></span>
                                            <?php endif; ?>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 5px 0; font-weight: 600;">
                                            <?php esc_html_e('Users with Tokens:', 'twork-rewards'); ?>
                                        </td>
                                        <td style="padding: 5px 0;">
                                            <strong><?php echo esc_html(number_format($notification_status['total_users_with_tokens'])); ?></strong>
                                            <?php esc_html_e('users', 'twork-rewards'); ?>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 5px 0; font-weight: 600;">
                                            <?php esc_html_e('Total FCM Tokens:', 'twork-rewards'); ?>
                                        </td>
                                        <td style="padding: 5px 0;">
                                            <strong><?php echo esc_html(number_format($notification_status['total_tokens'])); ?></strong>
                                            <?php esc_html_e('tokens', 'twork-rewards'); ?>
                                        </td>
                                    </tr>
                                </table>
                                
                                <?php if (!$notification_status['fcm_plugin_available'] && !$notification_status['webhook_url_configured']): ?>
                                    <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-left: 3px solid #f0ad4e; border-radius: 3px;">
                                        <strong style="color: #856404;"><?php esc_html_e('âš ï¸ Warning:', 'twork-rewards'); ?></strong>
                                        <p style="margin: 5px 0 0 0; color: #856404;">
                                            <?php esc_html_e('Notifications are currently disabled. Either install the FCM Notify plugin or configure a webhook URL.', 'twork-rewards'); ?>
                                        </p>
                                    </div>
                                <?php elseif ($notification_status['total_tokens'] === 0): ?>
                                    <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-left: 3px solid #f0ad4e; border-radius: 3px;">
                                        <strong style="color: #856404;"><?php esc_html_e('âš ï¸ Notice:', 'twork-rewards'); ?></strong>
                                        <p style="margin: 5px 0 0 0; color: #856404;">
                                            <?php esc_html_e('No FCM tokens found. Users need to open the mobile app to register their device tokens.', 'twork-rewards'); ?>
                                        </p>
                                    </div>
                                <?php endif; ?>
                                
                                <!-- Test Notification Button -->
                                <div style="margin-top: 15px; padding: 15px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 3px;">
                                    <h3 style="margin-top: 0; font-size: 14px; font-weight: 600;">
                                        <span class="dashicons dashicons-admin-tools" style="vertical-align: middle;"></span>
                                        <?php esc_html_e('Test Notification', 'twork-rewards'); ?>
                                    </h3>
                                    <p style="margin: 10px 0; font-size: 13px; color: #666;">
                                        <?php esc_html_e('Send a test notification to verify the notification system is working correctly.', 'twork-rewards'); ?>
                                    </p>
                                    <form method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                        <?php wp_nonce_field('twork_rewards_test_notification', 'twork_rewards_test_notification_nonce'); ?>
                                        <input type="hidden" name="action" value="twork_rewards_test_notification" />
                                        <input type="number" name="test_user_id" placeholder="<?php esc_attr_e('User ID (optional)', 'twork-rewards'); ?>" 
                                               style="width: 200px; padding: 6px 8px; font-size: 13px;" 
                                               value="<?php echo esc_attr(get_current_user_id()); ?>" min="1" />
                                        <button type="submit" class="button button-secondary">
                                            <span class="dashicons dashicons-email-alt" style="vertical-align: middle; font-size: 16px;"></span>
                                            <?php esc_html_e('Send Test Notification', 'twork-rewards'); ?>
                                        </button>
                                    </form>
                                    <?php if (isset($_GET['test_notification_sent'])): ?>
                                        <div style="margin-top: 10px; padding: 10px; background: #d4edda; border-left: 3px solid #46b450; border-radius: 3px;">
                                            <strong style="color: #155724;"><?php esc_html_e('âœ… Test notification sent!', 'twork-rewards'); ?></strong>
                                            <p style="margin: 5px 0 0 0; color: #155724; font-size: 12px;">
                                                <?php esc_html_e('Check the device to see if the notification was received.', 'twork-rewards'); ?>
                                            </p>
                                        </div>
                                    <?php endif; ?>
                                    <?php if (isset($_GET['test_notification_error'])): ?>
                                        <div style="margin-top: 10px; padding: 10px; background: #f8d7da; border-left: 3px solid #d63638; border-radius: 3px;">
                                            <strong style="color: #721c24;"><?php esc_html_e('âŒ Test notification failed!', 'twork-rewards'); ?></strong>
                                            <p style="margin: 5px 0 0 0; color: #721c24; font-size: 12px;">
                                                <?php echo esc_html(urldecode(sanitize_text_field($_GET['test_notification_error']))); ?>
                                            </p>
                                        </div>
                                    <?php endif; ?>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="twork_rewards_app_update_enabled"><?php esc_html_e('App Update Notification', 'twork-rewards'); ?></label>
                        </th>
                        <td>
                            <label>
                                <input type="checkbox"
                                       name="twork_rewards_app_update_enabled"
                                       id="twork_rewards_app_update_enabled"
                                       value="1" <?php checked($app_update_enabled, 1); ?> />
                                <?php esc_html_e('Enable app update notification in Profile Page', 'twork-rewards'); ?>
                            </label>
                            <p class="description">
                                <?php esc_html_e('When enabled, users will see an update notification in their Profile Page with a link to download the latest version.', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="twork_rewards_app_update_link"><?php esc_html_e('App Update Link', 'twork-rewards'); ?></label>
                        </th>
                        <td>
                            <input type="url" 
                                   class="large-text" 
                                   name="twork_rewards_app_update_link" 
                                   id="twork_rewards_app_update_link"
                                   value="<?php echo esc_attr($app_update_link); ?>" 
                                   placeholder="<?php esc_attr_e('https://play.google.com/store/apps/details?id=com.example.app or https://apps.apple.com/app/id123456789', 'twork-rewards'); ?>" />
                            <p class="description">
                                <?php esc_html_e('Full URL to the app store (Google Play Store or Apple App Store) where users can download the update. This link will open when users tap the update notification.', 'twork-rewards'); ?>
                            </p>
                            <p class="description">
                                <strong><?php esc_html_e('Examples:', 'twork-rewards'); ?></strong><br>
                                <?php esc_html_e('â€¢ Google Play: https://play.google.com/store/apps/details?id=com.example.app', 'twork-rewards'); ?><br>
                                <?php esc_html_e('â€¢ Apple App Store: https://apps.apple.com/app/id123456789', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="twork_rewards_app_update_version"><?php esc_html_e('Update Version (Optional)', 'twork-rewards'); ?></label>
                        </th>
                        <td>
                            <input type="text" 
                                   class="regular-text" 
                                   name="twork_rewards_app_update_version" 
                                   id="twork_rewards_app_update_version"
                                   value="<?php echo esc_attr($app_update_version); ?>" 
                                   placeholder="<?php esc_attr_e('e.g., 1.2.0 or v2.0.1', 'twork-rewards'); ?>" />
                            <p class="description">
                                <?php esc_html_e('Optional: Version number or name to display in the update notification (e.g., "1.2.0" or "v2.0.1"). Leave empty to show generic update message.', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="twork_rewards_timezone"><?php esc_html_e('Display Timezone', 'twork-rewards'); ?></label>
                        </th>
                        <td>
                            <select name="twork_rewards_timezone" id="twork_rewards_timezone" class="regular-text">
                                <?php
                                // Get all timezones
                                $timezones = timezone_identifiers_list();
                                $asia_timezones = array_filter($timezones, function ($tz) {
                                    return strpos($tz, 'Asia/') === 0;
                                });

                                // Popular timezones first
                                $popular_timezones = array(
                                    'Asia/Yangon' => __('Myanmar (Asia/Yangon) - UTC+6:30', 'twork-rewards'),
                                    'Asia/Bangkok' => __('Thailand (Asia/Bangkok) - UTC+7:00', 'twork-rewards'),
                                    'Asia/Singapore' => __('Singapore (Asia/Singapore) - UTC+8:00', 'twork-rewards'),
                                    'Asia/Kuala_Lumpur' => __('Malaysia (Asia/Kuala_Lumpur) - UTC+8:00', 'twork-rewards'),
                                    'Asia/Jakarta' => __('Indonesia (Asia/Jakarta) - UTC+7:00', 'twork-rewards'),
                                    'Asia/Manila' => __('Philippines (Asia/Manila) - UTC+8:00', 'twork-rewards'),
                                );

                                // Display popular timezones first
                                echo '<optgroup label="' . esc_attr__('Popular Timezones', 'twork-rewards') . '">';
                                foreach ($popular_timezones as $tz_value => $tz_label) {
                                    printf(
                                        '<option value="%s" %s>%s</option>',
                                        esc_attr($tz_value),
                                        selected($timezone, $tz_value, false),
                                        esc_html($tz_label)
                                    );
                                }
                                echo '</optgroup>';

                                // Display all Asia timezones
                                echo '<optgroup label="' . esc_attr__('All Asia Timezones', 'twork-rewards') . '">';
                                foreach ($asia_timezones as $tz_value) {
                                    if (!isset($popular_timezones[$tz_value])) {
                                        $tz_display = str_replace('Asia/', '', $tz_value);
                                        printf(
                                            '<option value="%s" %s>%s</option>',
                                            esc_attr($tz_value),
                                            selected($timezone, $tz_value, false),
                                            esc_html($tz_display)
                                        );
                                    }
                                }
                                echo '</optgroup>';

                                // Display other timezones
                                $other_timezones = array_diff($timezones, $asia_timezones);
                                if (!empty($other_timezones)) {
                                    echo '<optgroup label="' . esc_attr__('Other Timezones', 'twork-rewards') . '">';
                                    foreach ($other_timezones as $tz_value) {
                                        printf(
                                            '<option value="%s" %s>%s</option>',
                                            esc_attr($tz_value),
                                            selected($timezone, $tz_value, false),
                                            esc_html($tz_value)
                                        );
                                    }
                                    echo '</optgroup>';
                                }
                                ?>
                            </select>
                            <p class="description">
                                <?php esc_html_e('Select the timezone for displaying dates and times throughout the plugin. Default is Myanmar (Asia/Yangon) timezone (UTC+6:30).', 'twork-rewards'); ?>
                            </p>
                            <p class="description">
                                <strong><?php esc_html_e('Current Setting:', 'twork-rewards'); ?></strong> 
                                <?php
                                try {
                                    $dt = new DateTime('now', new DateTimeZone($timezone));
                                    $offset = $dt->getOffset();
                                    $hours = intval($offset / 3600);
                                    $minutes = abs(intval(($offset % 3600) / 60));
                                    $offset_str = sprintf('%s%02d:%02d', $offset >= 0 ? '+' : '-', abs($hours), $minutes);
                                    printf(
                                        esc_html__('%s (UTC%s)', 'twork-rewards'),
                                        esc_html($timezone),
                                        esc_html($offset_str)
                                    );
                                } catch (Exception $e) {
                                    echo esc_html($timezone);
                                }
                                ?>
                            </p>
                        </td>
                    </tr>
                </table>

                <!-- User Page Settings Section -->
                <h2 class="title" style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                    <?php esc_html_e('User Page Settings', 'twork-rewards'); ?>
                </h2>
                <p class="description" style="margin-bottom: 20px;">
                    <?php esc_html_e('Configure display, filtering, and behavior options for the Users Management page.', 'twork-rewards'); ?>
                </p>

                <?php
                // Get User Page settings with defaults
                $user_page_settings = $this->get_user_page_settings();
                ?>

                <table class="form-table">
                    <!-- Display Settings -->
                    <tr>
                        <th scope="row" colspan="2">
                            <h3 style="margin: 0; padding: 10px 0; border-bottom: 1px solid #e0e0e0; font-size: 16px;">
                                <?php esc_html_e('Display Settings', 'twork-rewards'); ?>
                            </h3>
                        </th>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="<?php echo esc_attr(self::OPTION_USER_PAGE_PER_PAGE); ?>">
                                <?php esc_html_e('Users Per Page', 'twork-rewards'); ?>
                            </label>
                        </th>
                        <td>
                            <input type="number"
                                   class="small-text"
                                   name="<?php echo esc_attr(self::OPTION_USER_PAGE_PER_PAGE); ?>"
                                   id="<?php echo esc_attr(self::OPTION_USER_PAGE_PER_PAGE); ?>"
                                   value="<?php echo esc_attr($user_page_settings['per_page']); ?>"
                                   min="10"
                                   max="500"
                                   step="10" />
                            <p class="description">
                                <?php esc_html_e('Number of users to display per page. Recommended: 50-100 for optimal performance.', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="<?php echo esc_attr(self::OPTION_USER_PAGE_DEFAULT_SORT); ?>">
                                <?php esc_html_e('Default Sort Column', 'twork-rewards'); ?>
                            </label>
                        </th>
                        <td>
                            <select name="<?php echo esc_attr(self::OPTION_USER_PAGE_DEFAULT_SORT); ?>"
                                    id="<?php echo esc_attr(self::OPTION_USER_PAGE_DEFAULT_SORT); ?>"
                                    class="regular-text">
                                <option value="activity" <?php selected($user_page_settings['default_sort'], 'activity'); ?>>
                                    <?php esc_html_e('Activity Status', 'twork-rewards'); ?>
                                </option>
                                <option value="ID" <?php selected($user_page_settings['default_sort'], 'ID'); ?>>
                                    <?php esc_html_e('User ID', 'twork-rewards'); ?>
                                </option>
                                <option value="name" <?php selected($user_page_settings['default_sort'], 'name'); ?>>
                                    <?php esc_html_e('Name', 'twork-rewards'); ?>
                                </option>
                                <option value="email" <?php selected($user_page_settings['default_sort'], 'email'); ?>>
                                    <?php esc_html_e('Email', 'twork-rewards'); ?>
                                </option>
                                <option value="registered" <?php selected($user_page_settings['default_sort'], 'registered'); ?>>
                                    <?php esc_html_e('Registration Date', 'twork-rewards'); ?>
                                </option>
                            </select>
                            <p class="description">
                                <?php esc_html_e('Default column to sort users by when the page loads.', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="<?php echo esc_attr(self::OPTION_USER_PAGE_DEFAULT_ORDER); ?>">
                                <?php esc_html_e('Default Sort Order', 'twork-rewards'); ?>
                            </label>
                        </th>
                        <td>
                            <select name="<?php echo esc_attr(self::OPTION_USER_PAGE_DEFAULT_ORDER); ?>"
                                    id="<?php echo esc_attr(self::OPTION_USER_PAGE_DEFAULT_ORDER); ?>"
                                    class="regular-text">
                                <option value="DESC" <?php selected($user_page_settings['default_order'], 'DESC'); ?>>
                                    <?php esc_html_e('Descending (Newest/Active First)', 'twork-rewards'); ?>
                                </option>
                                <option value="ASC" <?php selected($user_page_settings['default_order'], 'ASC'); ?>>
                                    <?php esc_html_e('Ascending (Oldest/Inactive First)', 'twork-rewards'); ?>
                                </option>
                            </select>
                            <p class="description">
                                <?php esc_html_e('Default sort order (ascending or descending).', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="<?php echo esc_attr(self::OPTION_USER_PAGE_DEFAULT_VIEW); ?>">
                                <?php esc_html_e('Default View', 'twork-rewards'); ?>
                            </label>
                        </th>
                        <td>
                            <select name="<?php echo esc_attr(self::OPTION_USER_PAGE_DEFAULT_VIEW); ?>"
                                    id="<?php echo esc_attr(self::OPTION_USER_PAGE_DEFAULT_VIEW); ?>"
                                    class="regular-text">
                                <option value="list" <?php selected($user_page_settings['default_view'], 'list'); ?>>
                                    <?php esc_html_e('List View', 'twork-rewards'); ?>
                                </option>
                                <option value="grid" <?php selected($user_page_settings['default_view'], 'grid'); ?>>
                                    <?php esc_html_e('Grid View', 'twork-rewards'); ?>
                                </option>
                                <option value="compact" <?php selected($user_page_settings['default_view'], 'compact'); ?>>
                                    <?php esc_html_e('Compact View', 'twork-rewards'); ?>
                                </option>
                            </select>
                            <p class="description">
                                <?php esc_html_e('Default view mode for displaying users.', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>

                    <!-- Filtering Settings -->
                    <tr>
                        <th scope="row" colspan="2">
                            <h3 style="margin: 20px 0 0 0; padding: 10px 0; border-bottom: 1px solid #e0e0e0; font-size: 16px;">
                                <?php esc_html_e('Filtering Settings', 'twork-rewards'); ?>
                            </h3>
                        </th>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="<?php echo esc_attr(self::OPTION_USER_PAGE_DEFAULT_ACTIVITY_FILTER); ?>">
                                <?php esc_html_e('Default Activity Filter', 'twork-rewards'); ?>
                            </label>
                        </th>
                        <td>
                            <select name="<?php echo esc_attr(self::OPTION_USER_PAGE_DEFAULT_ACTIVITY_FILTER); ?>"
                                    id="<?php echo esc_attr(self::OPTION_USER_PAGE_DEFAULT_ACTIVITY_FILTER); ?>"
                                    class="regular-text">
                                <option value="all" <?php selected($user_page_settings['default_activity_filter'], 'all'); ?>>
                                    <?php esc_html_e('All Users', 'twork-rewards'); ?>
                                </option>
                                <option value="active" <?php selected($user_page_settings['default_activity_filter'], 'active'); ?>>
                                    <?php esc_html_e('Active Users Only', 'twork-rewards'); ?>
                                </option>
                                <option value="inactive" <?php selected($user_page_settings['default_activity_filter'], 'inactive'); ?>>
                                    <?php esc_html_e('Inactive Users Only', 'twork-rewards'); ?>
                                </option>
                            </select>
                            <p class="description">
                                <?php esc_html_e('Default activity filter to apply when the page loads.', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="<?php echo esc_attr(self::OPTION_USER_PAGE_INACTIVITY_THRESHOLD); ?>">
                                <?php esc_html_e('Inactivity Threshold (Days)', 'twork-rewards'); ?>
                            </label>
                        </th>
                        <td>
                            <input type="number"
                                   class="small-text"
                                   name="<?php echo esc_attr(self::OPTION_USER_PAGE_INACTIVITY_THRESHOLD); ?>"
                                   id="<?php echo esc_attr(self::OPTION_USER_PAGE_INACTIVITY_THRESHOLD); ?>"
                                   value="<?php echo esc_attr($user_page_settings['inactivity_threshold']); ?>"
                                   min="1"
                                   max="365"
                                   step="1" />
                            <p class="description">
                                <?php esc_html_e('Number of days without activity to consider a user inactive. Default: 30 days.', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="<?php echo esc_attr(self::OPTION_USER_PAGE_ENABLE_ADVANCED_FILTERS); ?>">
                                <?php esc_html_e('Enable Advanced Filters', 'twork-rewards'); ?>
                            </label>
                        </th>
                        <td>
                            <label>
                                <input type="checkbox"
                                       name="<?php echo esc_attr(self::OPTION_USER_PAGE_ENABLE_ADVANCED_FILTERS); ?>"
                                       id="<?php echo esc_attr(self::OPTION_USER_PAGE_ENABLE_ADVANCED_FILTERS); ?>"
                                       value="1" <?php checked($user_page_settings['enable_advanced_filters'], 1); ?> />
                                <?php esc_html_e('Enable advanced filtering options (date range, points range, tier filter, etc.)', 'twork-rewards'); ?>
                            </label>
                            <p class="description">
                                <?php esc_html_e('When enabled, additional filtering options will be available on the Users page.', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>

                    <!-- Column Visibility Settings -->
                    <tr>
                        <th scope="row" colspan="2">
                            <h3 style="margin: 20px 0 0 0; padding: 10px 0; border-bottom: 1px solid #e0e0e0; font-size: 16px;">
                                <?php esc_html_e('Column Visibility Settings', 'twork-rewards'); ?>
                            </h3>
                        </th>
                    </tr>
                    <tr>
                        <th scope="row">
                            <?php esc_html_e('Visible Columns', 'twork-rewards'); ?>
                        </th>
                        <td>
                            <fieldset>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox"
                                           name="<?php echo esc_attr(self::OPTION_USER_PAGE_SHOW_ACTIVITY_BADGE); ?>"
                                           value="1" <?php checked($user_page_settings['show_activity_badge'], 1); ?> />
                                    <?php esc_html_e('Activity Status Badge', 'twork-rewards'); ?>
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox"
                                           name="<?php echo esc_attr(self::OPTION_USER_PAGE_SHOW_AVATAR); ?>"
                                           value="1" <?php checked($user_page_settings['show_avatar'], 1); ?> />
                                    <?php esc_html_e('User Avatar', 'twork-rewards'); ?>
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox"
                                           name="<?php echo esc_attr(self::OPTION_USER_PAGE_SHOW_EMAIL); ?>"
                                           value="1" <?php checked($user_page_settings['show_email'], 1); ?> />
                                    <?php esc_html_e('Email Address', 'twork-rewards'); ?>
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox"
                                           name="<?php echo esc_attr(self::OPTION_USER_PAGE_SHOW_PHONE); ?>"
                                           value="1" <?php checked($user_page_settings['show_phone'], 1); ?> />
                                    <?php esc_html_e('Phone Number', 'twork-rewards'); ?>
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox"
                                           name="<?php echo esc_attr(self::OPTION_USER_PAGE_SHOW_POINTS); ?>"
                                           value="1" <?php checked($user_page_settings['show_points'], 1); ?> />
                                    <?php esc_html_e('Points Balance', 'twork-rewards'); ?>
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox"
                                           name="<?php echo esc_attr(self::OPTION_USER_PAGE_SHOW_ACTIVITY_SCORE); ?>"
                                           value="1" <?php checked($user_page_settings['show_activity_score'], 1); ?> />
                                    <?php esc_html_e('Activity Score', 'twork-rewards'); ?>
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox"
                                           name="<?php echo esc_attr(self::OPTION_USER_PAGE_SHOW_LAST_UPDATED); ?>"
                                           value="1" <?php checked($user_page_settings['show_last_updated'], 1); ?> />
                                    <?php esc_html_e('Last Updated', 'twork-rewards'); ?>
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox"
                                           name="<?php echo esc_attr(self::OPTION_USER_PAGE_SHOW_USER_TIER); ?>"
                                           value="1" <?php checked($user_page_settings['show_user_tier'], 1); ?> />
                                    <?php esc_html_e('User Tier', 'twork-rewards'); ?>
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox"
                                           name="<?php echo esc_attr(self::OPTION_USER_PAGE_SHOW_REGISTRATION_DATE); ?>"
                                           value="1" <?php checked($user_page_settings['show_registration_date'], 1); ?> />
                                    <?php esc_html_e('Registration Date', 'twork-rewards'); ?>
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox"
                                           name="<?php echo esc_attr(self::OPTION_USER_PAGE_SHOW_TOTAL_TRANSACTIONS); ?>"
                                           value="1" <?php checked($user_page_settings['show_total_transactions'], 1); ?> />
                                    <?php esc_html_e('Total Transactions', 'twork-rewards'); ?>
                                </label>
                            </fieldset>
                            <p class="description">
                                <?php esc_html_e('Select which columns to display on the Users page.', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>

                    <!-- UI/UX Settings -->
                    <tr>
                        <th scope="row" colspan="2">
                            <h3 style="margin: 20px 0 0 0; padding: 10px 0; border-bottom: 1px solid #e0e0e0; font-size: 16px;">
                                <?php esc_html_e('UI/UX Settings', 'twork-rewards'); ?>
                            </h3>
                        </th>
                    </tr>
                    <tr>
                        <th scope="row">
                            <?php esc_html_e('Page Elements', 'twork-rewards'); ?>
                        </th>
                        <td>
                            <fieldset>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox"
                                           name="<?php echo esc_attr(self::OPTION_USER_PAGE_SHOW_STATS); ?>"
                                           value="1" <?php checked($user_page_settings['show_stats'], 1); ?> />
                                    <?php esc_html_e('Show Statistics Cards', 'twork-rewards'); ?>
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox"
                                           name="<?php echo esc_attr(self::OPTION_USER_PAGE_SHOW_SEARCH); ?>"
                                           value="1" <?php checked($user_page_settings['show_search'], 1); ?> />
                                    <?php esc_html_e('Show Search Box', 'twork-rewards'); ?>
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox"
                                           name="<?php echo esc_attr(self::OPTION_USER_PAGE_SHOW_FILTERS); ?>"
                                           value="1" <?php checked($user_page_settings['show_filters'], 1); ?> />
                                    <?php esc_html_e('Show Filter Options', 'twork-rewards'); ?>
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox"
                                           name="<?php echo esc_attr(self::OPTION_USER_PAGE_SHOW_PAGINATION); ?>"
                                           value="1" <?php checked($user_page_settings['show_pagination'], 1); ?> />
                                    <?php esc_html_e('Show Pagination', 'twork-rewards'); ?>
                                </label>
                                <label style="display: block; margin-bottom: 8px;">
                                    <input type="checkbox"
                                           name="<?php echo esc_attr(self::OPTION_USER_PAGE_SHOW_QUICK_ACTIONS); ?>"
                                           value="1" <?php checked($user_page_settings['show_quick_actions'], 1); ?> />
                                    <?php esc_html_e('Show Quick Action Buttons', 'twork-rewards'); ?>
                                </label>
                            </fieldset>
                            <p class="description">
                                <?php esc_html_e('Control which UI elements are displayed on the Users page.', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="<?php echo esc_attr(self::OPTION_USER_PAGE_DATE_FORMAT); ?>">
                                <?php esc_html_e('Date Format', 'twork-rewards'); ?>
                            </label>
                        </th>
                        <td>
                            <select name="<?php echo esc_attr(self::OPTION_USER_PAGE_DATE_FORMAT); ?>"
                                    id="<?php echo esc_attr(self::OPTION_USER_PAGE_DATE_FORMAT); ?>"
                                    class="regular-text">
                                <option value="wp_default" <?php selected($user_page_settings['date_format'], 'wp_default'); ?>>
                                    <?php esc_html_e('WordPress Default', 'twork-rewards'); ?> (<?php echo esc_html(get_option('date_format')); ?>)
                                </option>
                                <option value="Y-m-d" <?php selected($user_page_settings['date_format'], 'Y-m-d'); ?>>
                                    <?php echo esc_html(gmdate('Y-m-d')); ?> (YYYY-MM-DD)
                                </option>
                                <option value="d/m/Y" <?php selected($user_page_settings['date_format'], 'd/m/Y'); ?>>
                                    <?php echo esc_html(gmdate('d/m/Y')); ?> (DD/MM/YYYY)
                                </option>
                                <option value="m/d/Y" <?php selected($user_page_settings['date_format'], 'm/d/Y'); ?>>
                                    <?php echo esc_html(gmdate('m/d/Y')); ?> (MM/DD/YYYY)
                                </option>
                                <option value="d M Y" <?php selected($user_page_settings['date_format'], 'd M Y'); ?>>
                                    <?php echo esc_html(gmdate('d M Y')); ?> (DD Mon YYYY)
                                </option>
                                <option value="F j, Y" <?php selected($user_page_settings['date_format'], 'F j, Y'); ?>>
                                    <?php echo esc_html(gmdate('F j, Y')); ?> (Month Day, Year)
                                </option>
                            </select>
                            <p class="description">
                                <?php esc_html_e('Date format for displaying dates on the Users page.', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="<?php echo esc_attr(self::OPTION_USER_PAGE_TIME_FORMAT); ?>">
                                <?php esc_html_e('Time Format', 'twork-rewards'); ?>
                            </label>
                        </th>
                        <td>
                            <select name="<?php echo esc_attr(self::OPTION_USER_PAGE_TIME_FORMAT); ?>"
                                    id="<?php echo esc_attr(self::OPTION_USER_PAGE_TIME_FORMAT); ?>"
                                    class="regular-text">
                                <option value="wp_default" <?php selected($user_page_settings['time_format'], 'wp_default'); ?>>
                                    <?php esc_html_e('WordPress Default', 'twork-rewards'); ?> (<?php echo esc_html(get_option('time_format')); ?>)
                                </option>
                                <option value="H:i" <?php selected($user_page_settings['time_format'], 'H:i'); ?>>
                                    <?php echo esc_html(gmdate('H:i')); ?> (24-hour)
                                </option>
                                <option value="g:i A" <?php selected($user_page_settings['time_format'], 'g:i A'); ?>>
                                    <?php echo esc_html(gmdate('g:i A')); ?> (12-hour with AM/PM)
                                </option>
                                <option value="g:i a" <?php selected($user_page_settings['time_format'], 'g:i a'); ?>>
                                    <?php echo esc_html(gmdate('g:i a')); ?> (12-hour with am/pm)
                                </option>
                            </select>
                            <p class="description">
                                <?php esc_html_e('Time format for displaying times on the Users page.', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>

                    <!-- Activity Score Settings -->
                    <tr>
                        <th scope="row" colspan="2">
                            <h3 style="margin: 20px 0 0 0; padding: 10px 0; border-bottom: 1px solid #e0e0e0; font-size: 16px;">
                                <?php esc_html_e('Activity Score Calculation', 'twork-rewards'); ?>
                            </h3>
                        </th>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="<?php echo esc_attr(self::OPTION_USER_PAGE_ACTIVITY_SCORE_WEIGHT_LOGIN); ?>">
                                <?php esc_html_e('Login Weight (%)', 'twork-rewards'); ?>
                            </label>
                        </th>
                        <td>
                            <input type="number"
                                   class="small-text"
                                   name="<?php echo esc_attr(self::OPTION_USER_PAGE_ACTIVITY_SCORE_WEIGHT_LOGIN); ?>"
                                   id="<?php echo esc_attr(self::OPTION_USER_PAGE_ACTIVITY_SCORE_WEIGHT_LOGIN); ?>"
                                   value="<?php echo esc_attr($user_page_settings['activity_score_weight_login']); ?>"
                                   min="0"
                                   max="100"
                                   step="1" />
                            <p class="description">
                                <?php esc_html_e('Weight percentage for login activity in the activity score calculation (0-100).', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="<?php echo esc_attr(self::OPTION_USER_PAGE_ACTIVITY_SCORE_WEIGHT_ORDER); ?>">
                                <?php esc_html_e('Order Weight (%)', 'twork-rewards'); ?>
                            </label>
                        </th>
                        <td>
                            <input type="number"
                                   class="small-text"
                                   name="<?php echo esc_attr(self::OPTION_USER_PAGE_ACTIVITY_SCORE_WEIGHT_ORDER); ?>"
                                   id="<?php echo esc_attr(self::OPTION_USER_PAGE_ACTIVITY_SCORE_WEIGHT_ORDER); ?>"
                                   value="<?php echo esc_attr($user_page_settings['activity_score_weight_order']); ?>"
                                   min="0"
                                   max="100"
                                   step="1" />
                            <p class="description">
                                <?php esc_html_e('Weight percentage for order activity in the activity score calculation (0-100).', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="<?php echo esc_attr(self::OPTION_USER_PAGE_ACTIVITY_SCORE_WEIGHT_TRANSACTION); ?>">
                                <?php esc_html_e('Transaction Weight (%)', 'twork-rewards'); ?>
                            </label>
                        </th>
                        <td>
                            <input type="number"
                                   class="small-text"
                                   name="<?php echo esc_attr(self::OPTION_USER_PAGE_ACTIVITY_SCORE_WEIGHT_TRANSACTION); ?>"
                                   id="<?php echo esc_attr(self::OPTION_USER_PAGE_ACTIVITY_SCORE_WEIGHT_TRANSACTION); ?>"
                                   value="<?php echo esc_attr($user_page_settings['activity_score_weight_transaction']); ?>"
                                   min="0"
                                   max="100"
                                   step="1" />
                            <p class="description">
                                <?php esc_html_e('Weight percentage for transaction activity in the activity score calculation (0-100).', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>

                    <!-- Export Settings -->
                    <tr>
                        <th scope="row" colspan="2">
                            <h3 style="margin: 20px 0 0 0; padding: 10px 0; border-bottom: 1px solid #e0e0e0; font-size: 16px;">
                                <?php esc_html_e('Export Settings', 'twork-rewards'); ?>
                            </h3>
                        </th>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="<?php echo esc_attr(self::OPTION_USER_PAGE_ENABLE_EXPORT); ?>">
                                <?php esc_html_e('Enable Export', 'twork-rewards'); ?>
                            </label>
                        </th>
                        <td>
                            <label>
                                <input type="checkbox"
                                       name="<?php echo esc_attr(self::OPTION_USER_PAGE_ENABLE_EXPORT); ?>"
                                       id="<?php echo esc_attr(self::OPTION_USER_PAGE_ENABLE_EXPORT); ?>"
                                       value="1" <?php checked($user_page_settings['enable_export'], 1); ?> />
                                <?php esc_html_e('Enable user data export functionality', 'twork-rewards'); ?>
                            </label>
                            <p class="description">
                                <?php esc_html_e('When enabled, administrators can export user data from the Users page.', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="<?php echo esc_attr(self::OPTION_USER_PAGE_EXPORT_FORMAT); ?>">
                                <?php esc_html_e('Default Export Format', 'twork-rewards'); ?>
                            </label>
                        </th>
                        <td>
                            <select name="<?php echo esc_attr(self::OPTION_USER_PAGE_EXPORT_FORMAT); ?>"
                                    id="<?php echo esc_attr(self::OPTION_USER_PAGE_EXPORT_FORMAT); ?>"
                                    class="regular-text">
                                <option value="csv" <?php selected($user_page_settings['export_format'], 'csv'); ?>>
                                    <?php esc_html_e('CSV (Comma Separated Values)', 'twork-rewards'); ?>
                                </option>
                                <option value="xlsx" <?php selected($user_page_settings['export_format'], 'xlsx'); ?>>
                                    <?php esc_html_e('Excel (XLSX)', 'twork-rewards'); ?>
                                </option>
                                <option value="json" <?php selected($user_page_settings['export_format'], 'json'); ?>>
                                    <?php esc_html_e('JSON', 'twork-rewards'); ?>
                                </option>
                            </select>
                            <p class="description">
                                <?php esc_html_e('Default file format for user data exports.', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>

                    <!-- Performance Settings -->
                    <tr>
                        <th scope="row" colspan="2">
                            <h3 style="margin: 20px 0 0 0; padding: 10px 0; border-bottom: 1px solid #e0e0e0; font-size: 16px;">
                                <?php esc_html_e('Performance Settings', 'twork-rewards'); ?>
                            </h3>
                        </th>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="<?php echo esc_attr(self::OPTION_USER_PAGE_BATCH_SIZE); ?>">
                                <?php esc_html_e('Batch Processing Size', 'twork-rewards'); ?>
                            </label>
                        </th>
                        <td>
                            <input type="number"
                                   class="small-text"
                                   name="<?php echo esc_attr(self::OPTION_USER_PAGE_BATCH_SIZE); ?>"
                                   id="<?php echo esc_attr(self::OPTION_USER_PAGE_BATCH_SIZE); ?>"
                                   value="<?php echo esc_attr($user_page_settings['batch_size']); ?>"
                                   min="10"
                                   max="1000"
                                   step="10" />
                            <p class="description">
                                <?php esc_html_e('Number of users to process in each batch for bulk operations. Lower values reduce memory usage but increase processing time.', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="<?php echo esc_attr(self::OPTION_USER_PAGE_ENABLE_CACHING); ?>">
                                <?php esc_html_e('Enable Caching', 'twork-rewards'); ?>
                            </label>
                        </th>
                        <td>
                            <label>
                                <input type="checkbox"
                                       name="<?php echo esc_attr(self::OPTION_USER_PAGE_ENABLE_CACHING); ?>"
                                       id="<?php echo esc_attr(self::OPTION_USER_PAGE_ENABLE_CACHING); ?>"
                                       value="1" <?php checked($user_page_settings['enable_caching'], 1); ?> />
                                <?php esc_html_e('Enable caching for user data and statistics', 'twork-rewards'); ?>
                            </label>
                            <p class="description">
                                <?php esc_html_e('When enabled, user statistics and activity data will be cached to improve page load performance.', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="<?php echo esc_attr(self::OPTION_USER_PAGE_CACHE_DURATION); ?>">
                                <?php esc_html_e('Cache Duration (Seconds)', 'twork-rewards'); ?>
                            </label>
                        </th>
                        <td>
                            <input type="number"
                                   class="small-text"
                                   name="<?php echo esc_attr(self::OPTION_USER_PAGE_CACHE_DURATION); ?>"
                                   id="<?php echo esc_attr(self::OPTION_USER_PAGE_CACHE_DURATION); ?>"
                                   value="<?php echo esc_attr($user_page_settings['cache_duration']); ?>"
                                   min="60"
                                   max="3600"
                                   step="60" />
                            <p class="description">
                                <?php esc_html_e('How long to cache user data in seconds. Recommended: 300-600 seconds (5-10 minutes).', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>

                    <!-- Advanced Features -->
                    <tr>
                        <th scope="row" colspan="2">
                            <h3 style="margin: 20px 0 0 0; padding: 10px 0; border-bottom: 1px solid #e0e0e0; font-size: 16px;">
                                <?php esc_html_e('Advanced Features', 'twork-rewards'); ?>
                            </h3>
                        </th>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="<?php echo esc_attr(self::OPTION_USER_PAGE_ENABLE_BULK_ACTIONS); ?>">
                                <?php esc_html_e('Enable Bulk Actions', 'twork-rewards'); ?>
                            </label>
                        </th>
                        <td>
                            <label>
                                <input type="checkbox"
                                       name="<?php echo esc_attr(self::OPTION_USER_PAGE_ENABLE_BULK_ACTIONS); ?>"
                                       id="<?php echo esc_attr(self::OPTION_USER_PAGE_ENABLE_BULK_ACTIONS); ?>"
                                       value="1" <?php checked($user_page_settings['enable_bulk_actions'], 1); ?> />
                                <?php esc_html_e('Enable bulk actions for selected users', 'twork-rewards'); ?>
                            </label>
                            <p class="description">
                                <?php esc_html_e('When enabled, administrators can perform bulk actions (export, update tier, etc.) on multiple users at once.', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="<?php echo esc_attr(self::OPTION_USER_PAGE_ENABLE_REAL_TIME_UPDATES); ?>">
                                <?php esc_html_e('Enable Real-time Updates', 'twork-rewards'); ?>
                            </label>
                        </th>
                        <td>
                            <label>
                                <input type="checkbox"
                                       name="<?php echo esc_attr(self::OPTION_USER_PAGE_ENABLE_REAL_TIME_UPDATES); ?>"
                                       id="<?php echo esc_attr(self::OPTION_USER_PAGE_ENABLE_REAL_TIME_UPDATES); ?>"
                                       value="1" <?php checked($user_page_settings['enable_real_time_updates'], 1); ?> />
                                <?php esc_html_e('Enable automatic page refresh for real-time updates', 'twork-rewards'); ?>
                            </label>
                            <p class="description">
                                <?php esc_html_e('When enabled, the Users page will automatically refresh at specified intervals to show the latest data.', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="<?php echo esc_attr(self::OPTION_USER_PAGE_AUTO_REFRESH_INTERVAL); ?>">
                                <?php esc_html_e('Auto-refresh Interval (Seconds)', 'twork-rewards'); ?>
                            </label>
                        </th>
                        <td>
                            <input type="number"
                                   class="small-text"
                                   name="<?php echo esc_attr(self::OPTION_USER_PAGE_AUTO_REFRESH_INTERVAL); ?>"
                                   id="<?php echo esc_attr(self::OPTION_USER_PAGE_AUTO_REFRESH_INTERVAL); ?>"
                                   value="<?php echo esc_attr($user_page_settings['auto_refresh_interval']); ?>"
                                   min="10"
                                   max="300"
                                   step="10" />
                            <p class="description">
                                <?php esc_html_e('Interval in seconds for automatic page refresh. Only applies if real-time updates are enabled. Recommended: 30-60 seconds.', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>
                </table>
                <?php submit_button(__('Save Settings', 'twork-rewards')); ?>
            </form>
        </div>
        <?php
    }

    public function handle_settings_save()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }
        check_admin_referer('twork_rewards_save_settings');

        $url = isset($_POST['twork_rewards_webhook_url']) ? esc_url_raw(wp_unslash($_POST['twork_rewards_webhook_url'])) : '';
        update_option('twork_rewards_webhook_url', $url);

        // Get old value before updating
        $old_luckybox_enabled = (int) get_option(self::OPTION_LUCKYBOX_ENABLED, 1);
        $luckybox_enabled = isset($_POST['twork_rewards_luckybox_enabled']) ? 1 : 0;
        update_option(self::OPTION_LUCKYBOX_ENABLED, $luckybox_enabled);

        // Save Lucky Box banner content
        $luckybox_banner = isset($_POST['twork_rewards_luckybox_banner']) ? wp_kses_post(wp_unslash($_POST['twork_rewards_luckybox_banner'])) : '';
        update_option(self::OPTION_LUCKYBOX_BANNER, $luckybox_banner);

        // Save minimum exchange points
        $min_exchange_points = isset($_POST['twork_rewards_min_exchange_points']) ? absint($_POST['twork_rewards_min_exchange_points']) : 100;
        // Validate: must be non-negative
        if ($min_exchange_points < 0) {
            $min_exchange_points = 100;  // Default to 100 if invalid
        }
        update_option('twork_rewards_min_exchange_points', $min_exchange_points);

        // Save app update settings
        $app_update_enabled = isset($_POST['twork_rewards_app_update_enabled']) ? 1 : 0;
        update_option('twork_rewards_app_update_enabled', $app_update_enabled);

        $app_update_link = isset($_POST['twork_rewards_app_update_link']) ? esc_url_raw(wp_unslash($_POST['twork_rewards_app_update_link'])) : '';
        update_option('twork_rewards_app_update_link', $app_update_link);

        $app_update_version = isset($_POST['twork_rewards_app_update_version']) ? sanitize_text_field(wp_unslash($_POST['twork_rewards_app_update_version'])) : '';
        update_option('twork_rewards_app_update_version', $app_update_version);

        // Save timezone setting
        $timezone = isset($_POST['twork_rewards_timezone']) ? sanitize_text_field(wp_unslash($_POST['twork_rewards_timezone'])) : 'Asia/Yangon';
        // Validate timezone
        if (empty($timezone) || !in_array($timezone, timezone_identifiers_list(), true)) {
            $timezone = 'Asia/Yangon';  // Default to Myanmar timezone if invalid
        }
        update_option('twork_rewards_timezone', $timezone);

        // Save User Page Settings
        $this->save_user_page_settings();

        // Send notification if Lucky Box setting changed
        if ($old_luckybox_enabled !== $luckybox_enabled) {
            $this->send_luckybox_settings_notification(array(
                'type' => 'global',
                'enabled' => (bool) $luckybox_enabled,
                'user_id' => null,  // Global setting affects all users
            ));
        }

        wp_safe_redirect(add_query_arg(array('page' => 'twork-rewards-settings', 'updated' => 1), admin_url('admin.php')));
        exit;
    }

    /**
     * Save User Page settings from POST data
     *
     * @return void
     */
    private function save_user_page_settings()
    {
        // Display Settings
        $per_page = isset($_POST[self::OPTION_USER_PAGE_PER_PAGE]) ? absint($_POST[self::OPTION_USER_PAGE_PER_PAGE]) : 50;
        if ($per_page < 10) {
            $per_page = 10;
        }
        if ($per_page > 500) {
            $per_page = 500;
        }
        update_option(self::OPTION_USER_PAGE_PER_PAGE, $per_page);

        $default_sort = isset($_POST[self::OPTION_USER_PAGE_DEFAULT_SORT]) ? sanitize_text_field(wp_unslash($_POST[self::OPTION_USER_PAGE_DEFAULT_SORT])) : 'activity';
        $allowed_sorts = array('activity', 'ID', 'name', 'email', 'registered');
        if (!in_array($default_sort, $allowed_sorts, true)) {
            $default_sort = 'activity';
        }
        update_option(self::OPTION_USER_PAGE_DEFAULT_SORT, $default_sort);

        $default_order = isset($_POST[self::OPTION_USER_PAGE_DEFAULT_ORDER]) ? sanitize_text_field(wp_unslash($_POST[self::OPTION_USER_PAGE_DEFAULT_ORDER])) : 'DESC';
        if (!in_array($default_order, array('ASC', 'DESC'), true)) {
            $default_order = 'DESC';
        }
        update_option(self::OPTION_USER_PAGE_DEFAULT_ORDER, $default_order);

        $default_view = isset($_POST[self::OPTION_USER_PAGE_DEFAULT_VIEW]) ? sanitize_text_field(wp_unslash($_POST[self::OPTION_USER_PAGE_DEFAULT_VIEW])) : 'list';
        $allowed_views = array('list', 'grid', 'compact');
        if (!in_array($default_view, $allowed_views, true)) {
            $default_view = 'list';
        }
        update_option(self::OPTION_USER_PAGE_DEFAULT_VIEW, $default_view);

        // Filtering Settings
        $default_activity_filter = isset($_POST[self::OPTION_USER_PAGE_DEFAULT_ACTIVITY_FILTER]) ? sanitize_text_field(wp_unslash($_POST[self::OPTION_USER_PAGE_DEFAULT_ACTIVITY_FILTER])) : 'all';
        $allowed_filters = array('all', 'active', 'inactive');
        if (!in_array($default_activity_filter, $allowed_filters, true)) {
            $default_activity_filter = 'all';
        }
        update_option(self::OPTION_USER_PAGE_DEFAULT_ACTIVITY_FILTER, $default_activity_filter);

        $inactivity_threshold = isset($_POST[self::OPTION_USER_PAGE_INACTIVITY_THRESHOLD]) ? absint($_POST[self::OPTION_USER_PAGE_INACTIVITY_THRESHOLD]) : 30;
        if ($inactivity_threshold < 1) {
            $inactivity_threshold = 1;
        }
        if ($inactivity_threshold > 365) {
            $inactivity_threshold = 365;
        }
        update_option(self::OPTION_USER_PAGE_INACTIVITY_THRESHOLD, $inactivity_threshold);

        $enable_advanced_filters = isset($_POST[self::OPTION_USER_PAGE_ENABLE_ADVANCED_FILTERS]) ? 1 : 0;
        update_option(self::OPTION_USER_PAGE_ENABLE_ADVANCED_FILTERS, $enable_advanced_filters);

        // Column Visibility Settings
        update_option(self::OPTION_USER_PAGE_SHOW_ACTIVITY_BADGE, isset($_POST[self::OPTION_USER_PAGE_SHOW_ACTIVITY_BADGE]) ? 1 : 0);
        update_option(self::OPTION_USER_PAGE_SHOW_AVATAR, isset($_POST[self::OPTION_USER_PAGE_SHOW_AVATAR]) ? 1 : 0);
        update_option(self::OPTION_USER_PAGE_SHOW_EMAIL, isset($_POST[self::OPTION_USER_PAGE_SHOW_EMAIL]) ? 1 : 0);
        update_option(self::OPTION_USER_PAGE_SHOW_PHONE, isset($_POST[self::OPTION_USER_PAGE_SHOW_PHONE]) ? 1 : 0);
        update_option(self::OPTION_USER_PAGE_SHOW_POINTS, isset($_POST[self::OPTION_USER_PAGE_SHOW_POINTS]) ? 1 : 0);
        update_option(self::OPTION_USER_PAGE_SHOW_ACTIVITY_SCORE, isset($_POST[self::OPTION_USER_PAGE_SHOW_ACTIVITY_SCORE]) ? 1 : 0);
        update_option(self::OPTION_USER_PAGE_SHOW_LAST_UPDATED, isset($_POST[self::OPTION_USER_PAGE_SHOW_LAST_UPDATED]) ? 1 : 0);
        update_option(self::OPTION_USER_PAGE_SHOW_USER_TIER, isset($_POST[self::OPTION_USER_PAGE_SHOW_USER_TIER]) ? 1 : 0);
        update_option(self::OPTION_USER_PAGE_SHOW_REGISTRATION_DATE, isset($_POST[self::OPTION_USER_PAGE_SHOW_REGISTRATION_DATE]) ? 1 : 0);
        update_option(self::OPTION_USER_PAGE_SHOW_TOTAL_TRANSACTIONS, isset($_POST[self::OPTION_USER_PAGE_SHOW_TOTAL_TRANSACTIONS]) ? 1 : 0);

        // UI/UX Settings
        update_option(self::OPTION_USER_PAGE_SHOW_STATS, isset($_POST[self::OPTION_USER_PAGE_SHOW_STATS]) ? 1 : 0);
        update_option(self::OPTION_USER_PAGE_SHOW_SEARCH, isset($_POST[self::OPTION_USER_PAGE_SHOW_SEARCH]) ? 1 : 0);
        update_option(self::OPTION_USER_PAGE_SHOW_FILTERS, isset($_POST[self::OPTION_USER_PAGE_SHOW_FILTERS]) ? 1 : 0);
        update_option(self::OPTION_USER_PAGE_SHOW_PAGINATION, isset($_POST[self::OPTION_USER_PAGE_SHOW_PAGINATION]) ? 1 : 0);
        update_option(self::OPTION_USER_PAGE_SHOW_QUICK_ACTIONS, isset($_POST[self::OPTION_USER_PAGE_SHOW_QUICK_ACTIONS]) ? 1 : 0);

        $date_format = isset($_POST[self::OPTION_USER_PAGE_DATE_FORMAT]) ? sanitize_text_field(wp_unslash($_POST[self::OPTION_USER_PAGE_DATE_FORMAT])) : 'wp_default';
        $allowed_date_formats = array('wp_default', 'Y-m-d', 'd/m/Y', 'm/d/Y', 'd M Y', 'F j, Y');
        if (!in_array($date_format, $allowed_date_formats, true)) {
            $date_format = 'wp_default';
        }
        update_option(self::OPTION_USER_PAGE_DATE_FORMAT, $date_format);

        $time_format = isset($_POST[self::OPTION_USER_PAGE_TIME_FORMAT]) ? sanitize_text_field(wp_unslash($_POST[self::OPTION_USER_PAGE_TIME_FORMAT])) : 'wp_default';
        $allowed_time_formats = array('wp_default', 'H:i', 'g:i A', 'g:i a');
        if (!in_array($time_format, $allowed_time_formats, true)) {
            $time_format = 'wp_default';
        }
        update_option(self::OPTION_USER_PAGE_TIME_FORMAT, $time_format);

        // Activity Score Settings
        $activity_score_weight_login = isset($_POST[self::OPTION_USER_PAGE_ACTIVITY_SCORE_WEIGHT_LOGIN]) ? absint($_POST[self::OPTION_USER_PAGE_ACTIVITY_SCORE_WEIGHT_LOGIN]) : 30;
        if ($activity_score_weight_login > 100) {
            $activity_score_weight_login = 100;
        }
        update_option(self::OPTION_USER_PAGE_ACTIVITY_SCORE_WEIGHT_LOGIN, $activity_score_weight_login);

        $activity_score_weight_order = isset($_POST[self::OPTION_USER_PAGE_ACTIVITY_SCORE_WEIGHT_ORDER]) ? absint($_POST[self::OPTION_USER_PAGE_ACTIVITY_SCORE_WEIGHT_ORDER]) : 40;
        if ($activity_score_weight_order > 100) {
            $activity_score_weight_order = 100;
        }
        update_option(self::OPTION_USER_PAGE_ACTIVITY_SCORE_WEIGHT_ORDER, $activity_score_weight_order);

        $activity_score_weight_transaction = isset($_POST[self::OPTION_USER_PAGE_ACTIVITY_SCORE_WEIGHT_TRANSACTION]) ? absint($_POST[self::OPTION_USER_PAGE_ACTIVITY_SCORE_WEIGHT_TRANSACTION]) : 30;
        if ($activity_score_weight_transaction > 100) {
            $activity_score_weight_transaction = 100;
        }
        update_option(self::OPTION_USER_PAGE_ACTIVITY_SCORE_WEIGHT_TRANSACTION, $activity_score_weight_transaction);

        // Export Settings
        update_option(self::OPTION_USER_PAGE_ENABLE_EXPORT, isset($_POST[self::OPTION_USER_PAGE_ENABLE_EXPORT]) ? 1 : 0);

        $export_format = isset($_POST[self::OPTION_USER_PAGE_EXPORT_FORMAT]) ? sanitize_text_field(wp_unslash($_POST[self::OPTION_USER_PAGE_EXPORT_FORMAT])) : 'csv';
        $allowed_export_formats = array('csv', 'xlsx', 'json');
        if (!in_array($export_format, $allowed_export_formats, true)) {
            $export_format = 'csv';
        }
        update_option(self::OPTION_USER_PAGE_EXPORT_FORMAT, $export_format);

        // Performance Settings
        $batch_size = isset($_POST[self::OPTION_USER_PAGE_BATCH_SIZE]) ? absint($_POST[self::OPTION_USER_PAGE_BATCH_SIZE]) : 50;
        if ($batch_size < 10) {
            $batch_size = 10;
        }
        if ($batch_size > 1000) {
            $batch_size = 1000;
        }
        update_option(self::OPTION_USER_PAGE_BATCH_SIZE, $batch_size);

        update_option(self::OPTION_USER_PAGE_ENABLE_CACHING, isset($_POST[self::OPTION_USER_PAGE_ENABLE_CACHING]) ? 1 : 0);

        $cache_duration = isset($_POST[self::OPTION_USER_PAGE_CACHE_DURATION]) ? absint($_POST[self::OPTION_USER_PAGE_CACHE_DURATION]) : 300;
        if ($cache_duration < 60) {
            $cache_duration = 60;
        }
        if ($cache_duration > 3600) {
            $cache_duration = 3600;
        }
        update_option(self::OPTION_USER_PAGE_CACHE_DURATION, $cache_duration);

        // Advanced Features
        update_option(self::OPTION_USER_PAGE_ENABLE_BULK_ACTIONS, isset($_POST[self::OPTION_USER_PAGE_ENABLE_BULK_ACTIONS]) ? 1 : 0);
        update_option(self::OPTION_USER_PAGE_ENABLE_REAL_TIME_UPDATES, isset($_POST[self::OPTION_USER_PAGE_ENABLE_REAL_TIME_UPDATES]) ? 1 : 0);

        $auto_refresh_interval = isset($_POST[self::OPTION_USER_PAGE_AUTO_REFRESH_INTERVAL]) ? absint($_POST[self::OPTION_USER_PAGE_AUTO_REFRESH_INTERVAL]) : 30;
        if ($auto_refresh_interval < 10) {
            $auto_refresh_interval = 10;
        }
        if ($auto_refresh_interval > 300) {
            $auto_refresh_interval = 300;
        }
        update_option(self::OPTION_USER_PAGE_AUTO_REFRESH_INTERVAL, $auto_refresh_interval);

        // Columns Order (if provided)
        if (isset($_POST[self::OPTION_USER_PAGE_COLUMNS_ORDER])) {
            $columns_order = sanitize_text_field(wp_unslash($_POST[self::OPTION_USER_PAGE_COLUMNS_ORDER]));
            update_option(self::OPTION_USER_PAGE_COLUMNS_ORDER, $columns_order);
        }
    }

    /**
     * Handle test notification
     */
    public function handle_test_notification()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }

        check_admin_referer('twork_rewards_test_notification', 'twork_rewards_test_notification_nonce');

        $test_user_id = isset($_POST['test_user_id']) ? absint($_POST['test_user_id']) : get_current_user_id();

        if ($test_user_id <= 0) {
            wp_safe_redirect(add_query_arg(array(
                'page' => 'twork-rewards-settings',
                'test_notification_error' => urlencode(__('Invalid user ID.', 'twork-rewards')),
            ), admin_url('admin.php')));
            exit;
        }

        // Check if user exists
        $user = get_user_by('ID', $test_user_id);
        if (!$user) {
            wp_safe_redirect(add_query_arg(array(
                'page' => 'twork-rewards-settings',
                'test_notification_error' => urlencode(__('User not found.', 'twork-rewards')),
            ), admin_url('admin.php')));
            exit;
        }

        // Send test notification
        $test_data = array(
            'transaction_id' => 0,
            'points' => '100',
            'description' => __('This is a test notification from T-Work Rewards system.', 'twork-rewards'),
        );

        $sent = $this->send_points_fcm_notification($test_user_id, 'points_earned', $test_data);

        if ($sent) {
            wp_safe_redirect(add_query_arg(array(
                'page' => 'twork-rewards-settings',
                'test_notification_sent' => 1,
            ), admin_url('admin.php')));
        } else {
            // Get notification status for better error message
            $notification_status = $this->get_notification_system_status();
            $tokens = $this->get_user_fcm_tokens($test_user_id);

            $error_msg = __('Test notification failed.', 'twork-rewards');
            if (empty($tokens)) {
                $error_msg .= ' ' . __('User has no FCM tokens registered. User needs to open the mobile app.', 'twork-rewards');
            } elseif (!$notification_status['fcm_plugin_available'] && !$notification_status['webhook_url_configured']) {
                $error_msg .= ' ' . __('Notification system is not configured. Please install FCM plugin or configure webhook URL.', 'twork-rewards');
            }

            wp_safe_redirect(add_query_arg(array(
                'page' => 'twork-rewards-settings',
                'test_notification_error' => urlencode($error_msg),
            ), admin_url('admin.php')));
        }
        exit;
    }

    /**
     * REST API routes for Lucky Box toggle and request flow.
     *
     * Mobile app calls:
     * - GET  /wp-json/twork/v1/luckybox/config/{userId}
     * - POST /wp-json/twork/v1/luckybox/open   body: { "user_id": 123 }
     */
    public function register_luckybox_routes()
    {
        register_rest_route('twork/v1', '/luckybox/config/(?P<user_id>\d+)', array(
            'methods' => 'GET',
            'callback' => array($this, 'rest_luckybox_get_config'),
            // Mobile app uses WooCommerce keys; no WP nonce/session available.
            // Keep public but validate inputs and existence.
            'permission_callback' => '__return_true',
            'args' => array(
                'user_id' => array(
                    'validate_callback' => function ($param) {
                        return absint($param) > 0;
                    }
                ),
            ),
        ));

        register_rest_route('twork/v1', '/luckybox/open', array(
            'methods' => 'POST',
            'callback' => array($this, 'rest_luckybox_open'),
            'permission_callback' => '__return_true',
            'args' => array(
                'user_id' => array(
                    'required' => true,
                    'type' => 'integer',
                    'validate_callback' => function ($param) {
                        return absint($param) > 0;
                    }
                ),
            ),
        ));


        register_rest_route('twork/v1', '/luckybox/banner', array(
            'methods' => 'GET',
            'callback' => array($this, 'rest_luckybox_banner'),
            'permission_callback' => '__return_true',
        ));
    }

    /**
     * Register transactions endpoint for mobile app
     */
    public function register_transactions_route()
    {
        // Transactions endpoint for mobile app
        register_rest_route('twork/v1', '/points/transactions/(?P<user_id>\d+)', array(
            'methods' => 'GET',
            'callback' => array($this, 'rest_get_transactions'),
            'permission_callback' => '__return_true',
            'args' => array(
                'user_id' => array(
                    'required' => true,
                    'validate_callback' => function ($param) {
                        return absint($param) > 0;
                    }
                ),
                'page' => array(
                    'default' => 1,
                    'validate_callback' => function ($param) {
                        return is_numeric($param);
                    }
                ),
                'per_page' => array(
                    'default' => 20,
                    'validate_callback' => function ($param) {
                        return is_numeric($param);
                    }
                ),
                'orderby' => array(
                    'default' => 'created_at',
                    'validate_callback' => function ($param) {
                        $allowed = array('id', 'created_at', 'points', 'type', 'status');
                        return in_array($param, $allowed);
                    }
                ),
                'order' => array(
                    'default' => 'DESC',
                    'validate_callback' => function ($param) {
                        return in_array(strtoupper($param), array('ASC', 'DESC'));
                    }
                ),
            ),
        ));
    }

    /**
     * REST API routes for Code validation and redemption.
     *
     * Mobile app calls:
     * - GET  /wp-json/twork/v1/prize/validate?code=123456789101
     * - POST /wp-json/twork/v1/prize/redeem   body: { "user_id": 123, "code": "123456789101" }
     */
    public function register_code_routes()
    {
        register_rest_route('twork/v1', '/prize/validate', array(
            'methods' => 'GET',
            'callback' => array($this, 'rest_prize_validate'),
            'permission_callback' => '__return_true',
            'args' => array(
                'code' => array(
                    'required' => true,
                    'validate_callback' => function ($param) {
                        return !empty($param) && is_string($param);
                    }
                ),
            ),
        ));

        register_rest_route('twork/v1', '/prize/redeem', array(
            'methods' => 'POST',
            'callback' => array($this, 'rest_prize_redeem'),
            'permission_callback' => '__return_true',
        ));

        // Also register /prize/claim endpoint (app calls this)
        register_rest_route('twork/v1', '/prize/claim', array(
            'methods' => 'POST',
            'callback' => array($this, 'rest_prize_redeem'),
            'permission_callback' => '__return_true',
        ));
    }

    /**
     * REST API routes for Exchange requests
     */
    public function register_exchange_routes()
    {
        register_rest_route('twork/v1', '/rewards/exchange-request', array(
            'methods' => 'POST',
            'callback' => array($this, 'rest_exchange_request'),
            'permission_callback' => '__return_true',
        ));

        // API endpoint to get exchange settings (minimum points)
        register_rest_route('twork/v1', '/rewards/exchange-settings', array(
            'methods' => 'GET',
            'callback' => array($this, 'rest_exchange_settings'),
            'permission_callback' => '__return_true',
        ));

        // API endpoint to get app update settings
        register_rest_route('twork/v1', '/app/update-settings', array(
            'methods' => 'GET',
            'callback' => array($this, 'rest_app_update_settings'),
            'permission_callback' => '__return_true',
        ));
    }

    /**
     * REST API: Get exchange settings (minimum points requirement)
     */
    public function rest_exchange_settings(WP_REST_Request $request)
    {
        $min_exchange_points = (int) get_option('twork_rewards_min_exchange_points', 100);

        return new WP_REST_Response(
            array(
                'success' => true,
                'data' => array(
                    'min_exchange_points' => $min_exchange_points,
                ),
            ),
            200
        );
    }

    /**
     * REST API: Get app update settings
     * Returns update link, enabled status, and version if available
     */
    public function rest_app_update_settings(WP_REST_Request $request)
    {
        $update_enabled = (int) get_option('twork_rewards_app_update_enabled', 0);
        $update_link = get_option('twork_rewards_app_update_link', '');
        $update_version = get_option('twork_rewards_app_update_version', '');

        return new WP_REST_Response(
            array(
                'success' => true,
                'data' => array(
                    'enabled' => (bool) $update_enabled,
                    'update_link' => $update_link,
                    'version' => $update_version,
                ),
            ),
            200
        );
    }

    /**
     * Register all REST API routes in one place
     * Called early with high priority to ensure routes are available
     * This is called from the 'rest_api_init' hook, so REST API is guaranteed to be available
     */
    public function register_all_rest_routes()
    {
        // No need to check - we're called from rest_api_init hook, so REST API is available
        // Register all routes
        $this->register_luckybox_routes();
        $this->register_code_routes();
        $this->register_exchange_routes();
        $this->register_engagement_routes();
        $this->register_usage_tracking_routes();
        $this->register_user_activity_routes();
        $this->register_user_meta_fields();
        $this->register_page_content_routes();
        $this->register_point_tiers_routes();

        // Debug: Log route registration (only in development)
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log('T-Work Rewards: All REST API routes registered');
        }
    }


    /**
     * PROFESSIONAL FEATURE: Register REST API routes for Point Tiers System
     *
     * Mobile app calls:
     * - GET /wp-json/twork/v1/tiers/user/(?P<user_id>\d+) - Get user's current tier
     * - GET /wp-json/twork/v1/tiers/list - Get all available tiers
     */
    public function register_point_tiers_routes()
    {
        // Get user's tier
        register_rest_route('twork/v1', '/tiers/user/(?P<user_id>\d+)', array(
            'methods' => WP_REST_Server::READABLE,
            'callback' => array($this, 'rest_get_user_tier'),
            'permission_callback' => '__return_true',
            'args' => array(
                'user_id' => array(
                    'required' => true,
                    'validate_callback' => function ($param) {
                        return absint($param) > 0;
                    }
                ),
            ),
        ));

        // Get all tiers
        register_rest_route('twork/v1', '/tiers/list', array(
            'methods' => WP_REST_Server::READABLE,
            'callback' => array($this, 'rest_get_all_tiers'),
            'permission_callback' => '__return_true',
        ));

        // Get user's tier progression (current tier + next tier info)
        register_rest_route('twork/v1', '/tiers/progression/(?P<user_id>\d+)', array(
            'methods' => WP_REST_Server::READABLE,
            'callback' => array($this, 'rest_get_user_tier_progression'),
            'permission_callback' => '__return_true',
            'args' => array(
                'user_id' => array(
                    'required' => true,
                    'validate_callback' => function ($param) {
                        return absint($param) > 0;
                    }
                ),
            ),
        ));

        // Get tier benefits
        register_rest_route('twork/v1', '/tiers/(?P<tier_id>\d+)/benefits', array(
            'methods' => WP_REST_Server::READABLE,
            'callback' => array($this, 'rest_get_tier_benefits'),
            'permission_callback' => '__return_true',
            'args' => array(
                'tier_id' => array(
                    'required' => true,
                    'validate_callback' => function ($param) {
                        return absint($param) > 0;
                    }
                ),
            ),
        ));
    }

    /**
     * REST API: Get user's current tier
     */
    public function rest_get_user_tier(WP_REST_Request $request)
    {
        try {
            $user_id = absint($request->get_param('user_id'));

            if ($user_id <= 0) {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Invalid user_id parameter'
                ), 400);
            }

            // Verify user exists
            $user = get_userdata($user_id);
            if (!$user) {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'User not found'
                ), 404);
            }

            // PROFESSIONAL OPTIMIZATION: Cache REST API response (5 minutes)
            // This prevents unnecessary database queries when mobile app polls frequently
            $cache_key = 'twork_rest_tier_' . $user_id;
            $cached_response = get_transient($cache_key);
            if ($cached_response !== false) {
                return new WP_REST_Response($cached_response, 200);
            }

            // PROFESSIONAL OPTIMIZATION: Get user's tier (cached if possible)
            $tier = $this->get_user_tier($user_id);

            // Only calculate if tier not found (avoid unnecessary calculation)
            // But respect rate limiting - don't force recalculation on every API call
            if (!$tier) {
                // Check if we should recalculate (rate limited)
                $recalc_lock_key = 'twork_tier_recalc_lock_' . $user_id;
                $last_recalc_time = get_transient($recalc_lock_key);

                // Only recalculate if not recently done (within last 5 minutes)
                if ($last_recalc_time === false) {
                    // Set rate limit lock
                    set_transient($recalc_lock_key, time(), 5 * MINUTE_IN_SECONDS);
                    // Calculate and assign tier if not assigned (only when needed)
                    $tier = $this->calculate_user_tier($user_id, true);
                }
            }

            if (!$tier) {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'No tier found for user'
                ), 404);
            }

            // PROFESSIONAL OPTIMIZATION: Get user's points balance (already calculated in calculate_user_tier if called)
            // Only calculate if not already available from tier calculation
            $points_balance = $this->calculate_points_balance_from_transactions($user_id);

            // Format response
            $response_data = array(
                'tier_id' => (int) $tier['tier_id'] ?? (int) $tier['id'],
                'tier_name' => $tier['tier_name'],
                'tier_slug' => $tier['tier_slug'],
                'tier_level' => (int) $tier['tier_level'],
                'earning_multiplier' => (float) $tier['earning_multiplier'],
                'badge_icon' => $tier['badge_icon'] ?? null,
                'badge_color' => $tier['badge_color'] ?? '#666666',
                'description' => $tier['description'] ?? '',
                'benefits' => $tier['benefits'] ?? array(),
                'current_points' => $points_balance,
                'assigned_at' => $tier['assigned_at'] ?? null,
            );

            $response = array(
                'success' => true,
                'data' => $response_data
            );

            // Cache the response for 5 minutes
            set_transient($cache_key, $response, 5 * MINUTE_IN_SECONDS);

            return new WP_REST_Response($response, 200);
        } catch (Exception $e) {
            error_log('T-Work Rewards: Error in rest_get_user_tier: ' . $e->getMessage());
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'An error occurred while retrieving tier information',
                'debug' => defined('WP_DEBUG') && WP_DEBUG ? $e->getMessage() : null
            ), 500);
        }
    }

    /**
     * REST API: Get all available tiers
     */
    public function rest_get_all_tiers(WP_REST_Request $request)
    {
        try {
            // PROFESSIONAL OPTIMIZATION: Cache tiers list (30 minutes - tiers don't change often)
            $cache_key = 'twork_rest_all_tiers';
            $cached_response = get_transient($cache_key);
            if ($cached_response !== false) {
                return new WP_REST_Response($cached_response, 200);
            }

            global $wpdb;
            $tiers_table = $this->point_tiers_table_name();

            // Check if table exists using SHOW TABLES LIKE (more compatible)
            $table_check = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $tiers_table));
            $table_exists = ($table_check === $tiers_table);

            if (!$table_exists) {
                $response = array(
                    'success' => true,
                    'data' => array()
                );
                // Cache empty response too
                set_transient($cache_key, $response, 30 * MINUTE_IN_SECONDS);
                return new WP_REST_Response($response, 200);
            }

            // Get all active tiers
            $tiers = $wpdb->get_results(
                "SELECT * FROM $tiers_table WHERE is_active = 1 ORDER BY tier_level ASC",
                ARRAY_A
            );

            // Format response
            $formatted_tiers = array();
            foreach ($tiers as $tier) {
                $benefits = array();
                if (!empty($tier['benefits'])) {
                    $benefits = json_decode($tier['benefits'], true);
                    if (!is_array($benefits)) {
                        $benefits = array();
                    }
                }

                $formatted_tiers[] = array(
                    'id' => (int) $tier['id'],
                    'tier_name' => $tier['tier_name'],
                    'tier_slug' => $tier['tier_slug'],
                    'tier_level' => (int) $tier['tier_level'],
                    'min_points' => (int) $tier['min_points'],
                    'max_points' => $tier['max_points'] ? (int) $tier['max_points'] : null,
                    'earning_multiplier' => (float) $tier['earning_multiplier'],
                    'badge_icon' => $tier['badge_icon'] ?? null,
                    'badge_color' => $tier['badge_color'] ?? '#666666',
                    'description' => $tier['description'] ?? '',
                    'benefits' => $benefits,
                );
            }

            $response = array(
                'success' => true,
                'data' => $formatted_tiers
            );

            // Cache the response for 30 minutes (tiers don't change frequently)
            set_transient($cache_key, $response, 30 * MINUTE_IN_SECONDS);

            return new WP_REST_Response($response, 200);
        } catch (Exception $e) {
            error_log('T-Work Rewards: Error in rest_get_all_tiers: ' . $e->getMessage());
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'An error occurred while retrieving tiers',
                'debug' => defined('WP_DEBUG') && WP_DEBUG ? $e->getMessage() : null
            ), 500);
        }
    }

    /**
     * REST API: Get user's tier progression (current tier + next tier info)
     */
    public function rest_get_user_tier_progression(WP_REST_Request $request)
    {
        try {
            $user_id = absint($request->get_param('user_id'));

            if ($user_id <= 0) {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Invalid user_id parameter'
                ), 400);
            }

            // Verify user exists
            $user = get_userdata($user_id);
            if (!$user) {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'User not found'
                ), 404);
            }

            // PROFESSIONAL OPTIMIZATION: Cache tier progression response (5 minutes)
            $cache_key = 'twork_tier_progression_' . $user_id;
            $cached_response = get_transient($cache_key);
            if ($cached_response !== false) {
                return new WP_REST_Response($cached_response, 200);
            }

            // Get current tier
            $current_tier = $this->get_user_tier($user_id);
            if (!$current_tier) {
                // Check rate limit before calculating
                $recalc_lock_key = 'twork_tier_recalc_lock_' . $user_id;
                $last_recalc_time = get_transient($recalc_lock_key);

                // Only recalculate if not recently done
                if ($last_recalc_time === false) {
                    set_transient($recalc_lock_key, time(), 5 * MINUTE_IN_SECONDS);
                    // Calculate and assign tier if not assigned
                    $current_tier = $this->calculate_user_tier($user_id, true);
                }
            }

            // Get user's points balance
            $points_balance = $this->calculate_points_balance_from_transactions($user_id);

            // Get all active tiers
            global $wpdb;
            $tiers_table = $this->point_tiers_table_name();
            $table_check = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $tiers_table));
            $table_exists = ($table_check === $tiers_table);

            $next_tier = null;
            $progress_to_next = null;
            $points_needed = null;

            if ($table_exists) {
                // Find next tier (higher level than current)
                if ($current_tier) {
                    $next_tier = $wpdb->get_row($wpdb->prepare(
                        "SELECT * FROM $tiers_table 
                         WHERE is_active = 1 
                         AND tier_level > %d 
                         AND min_points > %d
                         ORDER BY tier_level ASC
                         LIMIT 1",
                        $current_tier['tier_level'],
                        $points_balance
                    ), ARRAY_A);

                    if ($next_tier) {
                        $points_needed = max(0, $next_tier['min_points'] - $points_balance);
                        $progress_to_next = $next_tier['min_points'] > 0
                            ? min(100, ($points_balance / $next_tier['min_points']) * 100)
                            : 0;

                        // Parse benefits
                        if (!empty($next_tier['benefits'])) {
                            $next_tier['benefits'] = json_decode($next_tier['benefits'], true);
                            if (!is_array($next_tier['benefits'])) {
                                $next_tier['benefits'] = array();
                            }
                        }
                    }
                } else {
                    // No current tier, find lowest tier
                    $next_tier = $wpdb->get_row(
                        "SELECT * FROM $tiers_table 
                         WHERE is_active = 1 
                         ORDER BY tier_level ASC
                         LIMIT 1",
                        ARRAY_A
                    );

                    if ($next_tier) {
                        $points_needed = max(0, $next_tier['min_points'] - $points_balance);
                        $progress_to_next = $next_tier['min_points'] > 0
                            ? min(100, ($points_balance / $next_tier['min_points']) * 100)
                            : 0;

                        // Parse benefits
                        if (!empty($next_tier['benefits'])) {
                            $next_tier['benefits'] = json_decode($next_tier['benefits'], true);
                            if (!is_array($next_tier['benefits'])) {
                                $next_tier['benefits'] = array();
                            }
                        }
                    }
                }
            }

            // Format current tier
            $current_tier_data = null;
            if ($current_tier) {
                $current_tier_data = array(
                    'tier_id' => (int) ($current_tier['tier_id'] ?? $current_tier['id']),
                    'tier_name' => $current_tier['tier_name'],
                    'tier_slug' => $current_tier['tier_slug'],
                    'tier_level' => (int) $current_tier['tier_level'],
                    'earning_multiplier' => (float) $current_tier['earning_multiplier'],
                    'badge_icon' => $current_tier['badge_icon'] ?? null,
                    'badge_color' => $current_tier['badge_color'] ?? '#666666',
                    'description' => $current_tier['description'] ?? '',
                    'benefits' => $current_tier['benefits'] ?? array(),
                );
            }

            // Format next tier
            $next_tier_data = null;
            if ($next_tier) {
                $next_tier_data = array(
                    'tier_id' => (int) $next_tier['id'],
                    'tier_name' => $next_tier['tier_name'],
                    'tier_slug' => $next_tier['tier_slug'],
                    'tier_level' => (int) $next_tier['tier_level'],
                    'min_points' => (int) $next_tier['min_points'],
                    'earning_multiplier' => (float) $next_tier['earning_multiplier'],
                    'badge_icon' => $next_tier['badge_icon'] ?? null,
                    'badge_color' => $next_tier['badge_color'] ?? '#666666',
                    'description' => $next_tier['description'] ?? '',
                    'benefits' => $next_tier['benefits'] ?? array(),
                );
            }

            return new WP_REST_Response(array(
                'success' => true,
                'data' => array(
                    'current_tier' => $current_tier_data,
                    'next_tier' => $next_tier_data,
                    'current_points' => $points_balance,
                    'points_needed' => $points_needed,
                    'progress_percentage' => $progress_to_next,
                )
            ), 200);
        } catch (Exception $e) {
            error_log('T-Work Rewards: Error in rest_get_user_tier_progression: ' . $e->getMessage());
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'An error occurred while retrieving tier progression',
                'debug' => defined('WP_DEBUG') && WP_DEBUG ? $e->getMessage() : null
            ), 500);
        }
    }

    /**
     * REST API: Get tier benefits
     */
    public function rest_get_tier_benefits(WP_REST_Request $request)
    {
        try {
            $tier_id = absint($request->get_param('tier_id'));

            if ($tier_id <= 0) {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Invalid tier_id parameter'
                ), 400);
            }

            global $wpdb;
            $tiers_table = $this->point_tiers_table_name();

            $table_check = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $tiers_table));
            $table_exists = ($table_check === $tiers_table);

            if (!$table_exists) {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Tier system not available'
                ), 404);
            }

            $tier = $wpdb->get_row($wpdb->prepare(
                "SELECT * FROM $tiers_table WHERE id = %d AND is_active = 1",
                $tier_id
            ), ARRAY_A);

            if (!$tier) {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Tier not found'
                ), 404);
            }

            // Parse benefits
            $benefits = array();
            if (!empty($tier['benefits'])) {
                $benefits = json_decode($tier['benefits'], true);
                if (!is_array($benefits)) {
                    $benefits = array();
                }
            }

            return new WP_REST_Response(array(
                'success' => true,
                'data' => array(
                    'tier_id' => (int) $tier['id'],
                    'tier_name' => $tier['tier_name'],
                    'tier_slug' => $tier['tier_slug'],
                    'tier_level' => (int) $tier['tier_level'],
                    'earning_multiplier' => (float) $tier['earning_multiplier'],
                    'badge_icon' => $tier['badge_icon'] ?? null,
                    'badge_color' => $tier['badge_color'] ?? '#666666',
                    'description' => $tier['description'] ?? '',
                    'benefits' => $benefits,
                )
            ), 200);
        } catch (Exception $e) {
            error_log('T-Work Rewards: Error in rest_get_tier_benefits: ' . $e->getMessage());
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'An error occurred while retrieving tier benefits',
                'debug' => defined('WP_DEBUG') && WP_DEBUG ? $e->getMessage() : null
            ), 500);
        }
    }

    /**
     * REST API routes for Engagement Hub (Banners, Quizzes)
     *
     * Registers endpoints with proper authentication and error handling.
     * Follows same pattern as /points/transactions/(?P<user_id>\d+) for consistency.
     *
     * Mobile app calls:
     * - GET  /wp-json/twork/v1/engagement/feed/123  (user_id in path)
     * - POST /wp-json/twork/v1/engagement/interact   body: { "user_id": 123, "item_id": 1, "answer": "0" }
     */
    public function register_engagement_routes()
    {
        // Feed endpoint - GET only, user_id in path (same pattern as points transactions)
        // Use same permission callback pattern as other working routes
        $feed_result = register_rest_route('twork/v1', '/engagement/feed/(?P<user_id>\d+)', array(
            'methods' => WP_REST_Server::READABLE,  // GET only
            'callback' => array($this, 'rest_engagement_feed'),
            'permission_callback' => '__return_true',  // Same as other working routes
            'args' => array(
                'user_id' => array(
                    'required' => true,
                    'validate_callback' => function ($param) {
                        return absint($param) > 0;
                    }
                ),
            ),
        ));

        // Interaction endpoint (Quiz answer, etc.)
        $interact_result = register_rest_route('twork/v1', '/engagement/interact', array(
            'methods' => WP_REST_Server::CREATABLE,  // POST only
            'callback' => array($this, 'rest_engagement_interact'),
            'permission_callback' => '__return_true',  // Same as other working routes
            'args' => array(
                'user_id' => array(
                    'required' => true,
                    'type' => 'integer',
                    'validate_callback' => function ($param) {
                        return is_numeric($param) && intval($param) > 0;
                    },
                    'sanitize_callback' => 'absint',
                ),
                'item_id' => array(
                    'required' => true,
                    'type' => 'integer',
                    'validate_callback' => function ($param) {
                        return is_numeric($param) && intval($param) > 0;
                    },
                    'sanitize_callback' => 'absint',
                ),
                'answer' => array(
                    'required' => true,
                    'type' => 'string',
                    'sanitize_callback' => 'sanitize_text_field',
                ),
            ),
        ));

        // PROFESSIONAL FEATURE: Poll/Quiz result endpoint with statistics
        $result_result = register_rest_route('twork/v1', '/engagement/result/(?P<item_id>\d+)', array(
            'methods' => WP_REST_Server::READABLE,  // GET only
            'callback' => array($this, 'rest_engagement_result'),
            'permission_callback' => '__return_true',
            'args' => array(
                'item_id' => array(
                    'required' => true,
                    'validate_callback' => function ($param) {
                        return absint($param) > 0;
                    }
                ),
                'user_id' => array(
                    'required' => false,
                    'type' => 'integer',
                    'validate_callback' => function ($param) {
                        return empty($param) || (is_numeric($param) && intval($param) > 0);
                    },
                    'sanitize_callback' => 'absint',
                ),
            ),
        ));

        // Debug: Log route registration results (only in development)
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log('T-Work Rewards: Engagement feed route registered: ' . ($feed_result ? 'SUCCESS' : 'FAILED'));
            error_log('T-Work Rewards: Engagement interact route registered: ' . ($interact_result ? 'SUCCESS' : 'FAILED'));
            error_log('T-Work Rewards: Engagement result route registered: ' . ($result_result ? 'SUCCESS' : 'FAILED'));

            // Also log the actual route to verify it's registered
            global $wp_rest_server;
            if ($wp_rest_server) {
                $routes = $wp_rest_server->get_routes();
                $engagement_routes = array();
                foreach ($routes as $route => $handlers) {
                    if (strpos($route, 'engagement') !== false) {
                        $engagement_routes[] = $route;
                    }
                }
                error_log('T-Work Rewards: Registered engagement routes: ' . print_r($engagement_routes, true));
            }
        }
    }

    /**
     * REST API routes for Usage Tracking
     * Tracks app usage duration for each user session
     *
     * Mobile app calls:
     * - POST /wp-json/twork/v1/usage/start   body: { "user_id": 123, "device_info": "...", "app_version": "1.0.0" }
     * - POST /wp-json/twork/v1/usage/end     body: { "user_id": 123, "session_id": 456 }
     * - GET  /wp-json/twork/v1/usage/stats/(?P<user_id>\d+)  Get usage statistics for user
     */
    public function register_usage_tracking_routes()
    {
        // Start session endpoint
        $start_result = register_rest_route('twork/v1', '/usage/start', array(
            'methods' => WP_REST_Server::CREATABLE,
            'callback' => array($this, 'rest_usage_start'),
            'permission_callback' => '__return_true',
            'args' => array(
                'user_id' => array(
                    'required' => true,
                    'type' => 'integer',
                    'validate_callback' => function ($param) {
                        return is_numeric($param) && intval($param) > 0;
                    },
                    'sanitize_callback' => 'absint',
                ),
                'device_info' => array(
                    'required' => false,
                    'type' => 'string',
                    'sanitize_callback' => 'sanitize_text_field',
                ),
                'app_version' => array(
                    'required' => false,
                    'type' => 'string',
                    'sanitize_callback' => 'sanitize_text_field',
                ),
                'country_code' => array(
                    'required' => false,
                    'type' => 'string',
                    'sanitize_callback' => 'sanitize_text_field',
                    'validate_callback' => function ($param) {
                        // Allow 2-letter country codes (e.g., MM, TH, VN)
                        return empty($param) || (is_string($param) && strlen($param) <= 2);
                    },
                ),
                'country_name' => array(
                    'required' => false,
                    'type' => 'string',
                    'sanitize_callback' => 'sanitize_text_field',
                ),
            ),
        ));

        // End session endpoint
        $end_result = register_rest_route('twork/v1', '/usage/end', array(
            'methods' => WP_REST_Server::CREATABLE,
            'callback' => array($this, 'rest_usage_end'),
            'permission_callback' => '__return_true',
            'args' => array(
                'user_id' => array(
                    'required' => true,
                    'type' => 'integer',
                    'validate_callback' => function ($param) {
                        return is_numeric($param) && intval($param) > 0;
                    },
                    'sanitize_callback' => 'absint',
                ),
                'session_id' => array(
                    'required' => false,
                    'type' => 'integer',
                    'validate_callback' => function ($param) {
                        return is_numeric($param) && intval($param) > 0;
                    },
                    'sanitize_callback' => 'absint',
                ),
            ),
        ));

        // Get usage statistics endpoint
        $stats_result = register_rest_route('twork/v1', '/usage/stats/(?P<user_id>\d+)', array(
            'methods' => WP_REST_Server::READABLE,
            'callback' => array($this, 'rest_usage_stats'),
            'permission_callback' => '__return_true',
            'args' => array(
                'user_id' => array(
                    'required' => true,
                    'validate_callback' => function ($param) {
                        return absint($param) > 0;
                    }
                ),
            ),
        ));

        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log('T-Work Rewards: Usage tracking routes registered');
        }
    }

    /**
     * REST API routes for User Activity Status
     *
     * Mobile app calls:
     * - GET /wp-json/twork/v1/user/activity/(?P<user_id>\d+)  Get activity status for a user
     */
    public function register_user_activity_routes()
    {
        // Get user activity status endpoint
        $activity_result = register_rest_route('twork/v1', '/user/activity/(?P<user_id>\d+)', array(
            'methods' => WP_REST_Server::READABLE,
            'callback' => array($this, 'rest_user_activity'),
            'permission_callback' => '__return_true',
            'args' => array(
                'user_id' => array(
                    'required' => true,
                    'validate_callback' => function ($param) {
                        return absint($param) > 0;
                    }
                ),
            ),
        ));

        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log('T-Work Rewards: User activity routes registered');
        }
    }

    /**
     * REST API endpoint to get user activity status
     *
     * @param WP_REST_Request $request The REST API request
     * @return WP_REST_Response Response with user activity status
     */
    public function rest_user_activity(WP_REST_Request $request)
    {
        try {
            $user_id = absint($request->get_param('user_id'));

            if ($user_id <= 0) {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Invalid user_id parameter'
                ), 400);
            }

            // Verify user exists
            $user = get_userdata($user_id);
            if (!$user) {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'User not found'
                ), 404);
            }

            // Get activity status
            $activity_status = $this->get_user_activity_status($user_id);
            $formatted_activity = $this->get_formatted_user_activity($user_id);

            return new WP_REST_Response(array(
                'success' => true,
                'data' => array(
                    'user_id' => $user_id,
                    'status' => $activity_status['status'],
                    'is_active' => $activity_status['is_active'],
                    'last_activity' => $activity_status['last_activity'],
                    'last_login' => $activity_status['last_login'],
                    'days_inactive' => $activity_status['days_inactive'],
                    'threshold_days' => $activity_status['threshold_days'],
                    'formatted' => $formatted_activity
                )
            ), 200);
        } catch (Exception $e) {
            error_log('T-Work Rewards: Error in rest_user_activity: ' . $e->getMessage());
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'An error occurred while retrieving activity status',
                'debug' => defined('WP_DEBUG') && WP_DEBUG ? $e->getMessage() : null
            ), 500);
        }
    }

    /**
     * Register user meta fields to expose in REST API
     * This makes points_balance available in /wp-json/wp/v2/users/me response
     */
    public function register_user_meta_fields()
    {
        register_rest_field('user', 'points_balance', array(
            'get_callback' => function ($user) {
                $balance = get_user_meta($user['id'], 'points_balance', true);
                return $balance ? $balance : '0';
            },
            'update_callback' => null,  // Read-only
            'schema' => array(
                'description' => __('User points balance', 'twork-rewards'),
                'type' => 'string',
                'context' => array('view', 'edit'),
            ),
        ));

        register_rest_field('user', 'wallet_balance', array(
            'get_callback' => function ($user) {
                $balance = get_user_meta($user['id'], 'wallet_balance', true);
                return $balance ? $balance : '0';
            },
            'update_callback' => null,  // Read-only
            'schema' => array(
                'description' => __('User wallet balance', 'twork-rewards'),
                'type' => 'string',
                'context' => array('view', 'edit'),
            ),
        ));

        // PROFESSIONAL FEATURE: Add tier information to user REST API
        register_rest_field('user', 'point_tier', array(
            'get_callback' => function ($user) {
                $instance = self::get_instance();
                $tier = $instance->get_user_tier($user['id']);

                if (!$tier) {
                    // Calculate and assign if not assigned
                    $tier = $instance->calculate_user_tier($user['id'], true);
                }

                if ($tier) {
                    return array(
                        'tier_id' => (int) ($tier['tier_id'] ?? $tier['id']),
                        'tier_name' => $tier['tier_name'],
                        'tier_slug' => $tier['tier_slug'],
                        'tier_level' => (int) $tier['tier_level'],
                        'earning_multiplier' => (float) $tier['earning_multiplier'],
                        'badge_icon' => $tier['badge_icon'] ?? null,
                        'badge_color' => $tier['badge_color'] ?? '#666666',
                    );
                }

                return null;
            },
            'update_callback' => null,  // Read-only
            'schema' => array(
                'description' => __('User point tier information', 'twork-rewards'),
                'type' => 'object',
                'context' => array('view', 'edit'),
            ),
        ));

        // Note: Activity status is tracked on backend for admin purposes only
        // It is NOT exposed to mobile app via REST API for privacy and performance
    }

    /**
     * REST API routes for Page Content (About, FAQ, Terms, Privacy, etc.)
     *
     * Mobile app calls:
     * - GET /wp-json/twork/v1/page-content/{page_slug}  (e.g., 'about-us', 'faq', 'terms-of-use')
     * - GET /wp-json/twork/v1/faq  (Get all FAQ items)
     */
    public function register_page_content_routes()
    {
        // Get page content by slug
        register_rest_route('twork/v1', '/page-content/(?P<page_slug>[a-zA-Z0-9-]+)', array(
            'methods' => WP_REST_Server::READABLE,
            'callback' => array($this, 'rest_get_page_content'),
            'permission_callback' => '__return_true',  // Public access
            'args' => array(
                'page_slug' => array(
                    'required' => true,
                    'validate_callback' => function ($param) {
                        return !empty($param) && preg_match('/^[a-zA-Z0-9-]+$/', $param);
                    }
                ),
            ),
        ));

        // Get all pages (for dynamic page listing)
        register_rest_route('twork/v1', '/page-content', array(
            'methods' => WP_REST_Server::READABLE,
            'callback' => array($this, 'rest_get_all_pages'),
            'permission_callback' => '__return_true',  // Public access
        ));

        // Get FAQ items
        register_rest_route('twork/v1', '/faq', array(
            'methods' => WP_REST_Server::READABLE,
            'callback' => array($this, 'rest_get_faq'),
            'permission_callback' => '__return_true',  // Public access
        ));

        // Get About Us content
        register_rest_route('twork/v1', '/about-us', array(
            'methods' => WP_REST_Server::READABLE,
            'callback' => array($this, 'rest_get_about_us'),
            'permission_callback' => '__return_true',  // Public access
        ));
    }

    /**
     * REST API endpoint: Get page content by slug
     * Fetches from plugin database table instead of WordPress pages
     *
     * @param WP_REST_Request $request The REST API request
     * @return WP_REST_Response Response with page content
     */
    public function rest_get_page_content(WP_REST_Request $request)
    {
        try {
            global $wpdb;
            $table_name = $this->page_content_table_name();

            // PROFESSIONAL FIX: Ensure table exists before querying
            $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
            if ($table_exists !== $table_name) {
                // Table doesn't exist - create it
                $this->create_page_content_table();
                // Verify table was created
                $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
                if ($table_exists !== $table_name) {
                    // Table creation failed - return placeholder content
                    $page_slug = sanitize_text_field($request->get_param('page_slug'));
                    return new WP_REST_Response(array(
                        'success' => true,
                        'data' => array(
                            'title' => ucwords(str_replace('-', ' ', $page_slug)),
                            'content' => '<p>Content coming soon. Please check back later.</p>',
                            'slug' => $page_slug,
                            'last_modified' => current_time('mysql'),
                        )
                    ), 200);
                }
            }

            $page_slug = sanitize_text_field($request->get_param('page_slug'));

            // Map alternative slugs to standard slugs
            $slug_map = array(
                'terms' => 'terms-of-use',
                'privacy' => 'privacy-policy',
            );

            $actual_slug = isset($slug_map[$page_slug]) ? $slug_map[$page_slug] : $page_slug;

            // Get page from plugin database table
            $page = $wpdb->get_row($wpdb->prepare(
                "SELECT * FROM `$table_name` WHERE page_slug = %s AND status = 'active'",
                $actual_slug
            ), ARRAY_A);

            // Check for database errors
            if ($wpdb->last_error && defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: Page content REST API query error: ' . $wpdb->last_error);
            }

            if ($page) {
                // Process content - apply WordPress filters for proper rendering
                $content = apply_filters('the_content', $page['content']);
                $content = trim($content);

                // Parse meta_data if available
                $meta_data = !empty($page['meta_data']) ? json_decode($page['meta_data'], true) : array();

                return new WP_REST_Response(array(
                    'success' => true,
                    'data' => array(
                        'title' => $page['title'],
                        'content' => $content,  // HTML content ready for display
                        'slug' => $page['page_slug'],
                        'last_modified' => $page['updated_at'] ? $page['updated_at'] : $page['created_at'],
                        'meta' => $meta_data,
                    )
                ), 200);
            } else {
                // Page not found - return placeholder content
                return new WP_REST_Response(array(
                    'success' => true,
                    'data' => array(
                        'title' => ucwords(str_replace('-', ' ', $page_slug)),
                        'content' => '<p>Content coming soon. Please check back later.</p>',
                        'slug' => $page_slug,
                        'last_modified' => current_time('mysql'),
                    )
                ), 200);
            }
        } catch (Exception $e) {
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: Page content error: ' . $e->getMessage());
            }
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'Failed to retrieve page content',
                'data' => null
            ), 500);
        }
    }

    /**
     * REST API endpoint: Get all pages
     * Returns list of all active pages for dynamic rendering
     *
     * @param WP_REST_Request $request The REST API request
     * @return WP_REST_Response Response with list of pages
     */
    public function rest_get_all_pages(WP_REST_Request $request)
    {
        try {
            global $wpdb;
            $table_name = $this->page_content_table_name();

            // PROFESSIONAL FIX: Ensure table exists before querying
            $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
            if ($table_exists !== $table_name) {
                // Table doesn't exist - create it
                $this->create_page_content_table();
                // Verify table was created
                $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
                if ($table_exists !== $table_name) {
                    // Table creation failed - return empty list
                    return new WP_REST_Response(array(
                        'success' => true,
                        'data' => array()
                    ), 200);
                }
            }

            // PROFESSIONAL FIX: Check if display_order column exists before querying
            $columns = $wpdb->get_col("DESCRIBE $table_name");
            $columns_lower = array_map('strtolower', $columns);
            $has_display_order = in_array('display_order', $columns_lower);

            // If display_order doesn't exist, add it via migration
            if (!$has_display_order) {
                $result = $wpdb->query("ALTER TABLE $table_name ADD COLUMN display_order int(11) DEFAULT 0 AFTER status");
                if ($result !== false) {
                    $wpdb->query("ALTER TABLE $table_name ADD INDEX idx_display_order (display_order)");
                    if (defined('WP_DEBUG') && WP_DEBUG) {
                        error_log('T-Work Rewards: Added display_order column to page content table via REST API');
                    }
                    $has_display_order = true;
                }
            }

            // Build query based on whether display_order exists
            if ($has_display_order) {
                $query = "SELECT id, title, page_slug, meta_data, display_order, created_at, updated_at 
                         FROM `$table_name` 
                         WHERE status = 'active' 
                         ORDER BY display_order ASC, title ASC";
            } else {
                // Fallback if column still doesn't exist
                $query = "SELECT id, title, page_slug, meta_data, created_at, updated_at 
                         FROM `$table_name` 
                         WHERE status = 'active' 
                         ORDER BY title ASC";
            }

            // Get all active pages
            $pages = $wpdb->get_results($query, ARRAY_A);

            // Check for database errors
            if ($wpdb->last_error) {
                if (defined('WP_DEBUG') && WP_DEBUG) {
                    error_log('T-Work Rewards: Get all pages REST API query error: ' . $wpdb->last_error);
                    error_log('T-Work Rewards: Query was: ' . $query);
                }
                // Return empty array on error instead of failing
                $pages = array();
            }

            // PROFESSIONAL FIX: If no pages found, ensure default pages are initialized
            if (empty($pages)) {
                if (defined('WP_DEBUG') && WP_DEBUG) {
                    error_log('T-Work Rewards: No pages found in database, initializing default pages');
                }
                // Initialize default pages
                $this->initialize_default_pages();

                // Re-check columns after initialization (display_order might have been added)
                $columns = $wpdb->get_col("DESCRIBE $table_name");
                $columns_lower = array_map('strtolower', $columns);
                $has_display_order = in_array('display_order', $columns_lower);

                // Rebuild query after initialization to ensure it includes display_order if it exists
                if ($has_display_order) {
                    $query = "SELECT id, title, page_slug, meta_data, display_order, created_at, updated_at 
                             FROM `$table_name` 
                             WHERE status = 'active' 
                             ORDER BY display_order ASC, title ASC";
                } else {
                    $query = "SELECT id, title, page_slug, meta_data, created_at, updated_at 
                             FROM `$table_name` 
                             WHERE status = 'active' 
                             ORDER BY title ASC";
                }

                // Retry query after initialization
                $pages = $wpdb->get_results($query, ARRAY_A);
                if ($wpdb->last_error && defined('WP_DEBUG') && WP_DEBUG) {
                    error_log('T-Work Rewards: Error after initialization: ' . $wpdb->last_error);
                } elseif (defined('WP_DEBUG') && WP_DEBUG) {
                    error_log('T-Work Rewards: After initialization, found ' . count($pages) . ' pages');
                }
            }

            // Format pages for response
            $formatted_pages = array();
            foreach ($pages as $page) {
                // Parse meta_data if available
                $meta_data = !empty($page['meta_data']) ? json_decode($page['meta_data'], true) : array();

                $formatted_pages[] = array(
                    'id' => intval($page['id']),
                    'title' => $page['title'],
                    'slug' => $page['page_slug'],
                    'meta' => $meta_data,
                    'display_order' => isset($page['display_order']) ? intval($page['display_order']) : 0,
                    'last_modified' => $page['updated_at'] ? $page['updated_at'] : $page['created_at'],
                );
            }

            // PROFESSIONAL FIX: Log result for debugging
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf(
                    'T-Work Rewards: Get all pages REST API - Found %d pages, Returning %d formatted pages',
                    count($pages),
                    count($formatted_pages)
                ));
            }

            return new WP_REST_Response(array(
                'success' => true,
                'data' => $formatted_pages
            ), 200);
        } catch (Exception $e) {
            error_log('T-Work Rewards: Get all pages REST API error: ' . $e->getMessage());
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'Failed to fetch pages: ' . $e->getMessage(),
                'data' => array()
            ), 500);
        }
    }

    /**
     * REST API endpoint: Get FAQ items
     *
     * FAQ items can be stored as:
     * 1. Plugin database table (twork_faq_items) - PRIMARY METHOD
     * 2. WordPress posts with category 'faq'
     * 3. Custom post type 'faq'
     *
     * Priority: Plugin database > Custom post type > Category posts
     *
     * @param WP_REST_Request $request The REST API request
     * @return WP_REST_Response Response with FAQ items
     */
    public function rest_get_faq(WP_REST_Request $request)
    {
        try {
            global $wpdb;
            $faq_items = array();

            // METHOD 1: Get FAQ items from plugin database table (PRIMARY)
            $faq_table = $this->faq_table_name();
            if ($wpdb->get_var("SHOW TABLES LIKE '$faq_table'") === $faq_table) {
                $plugin_faq_items = $wpdb->get_results(
                    "SELECT * FROM $faq_table WHERE status = 'active' ORDER BY display_order ASC, id ASC",
                    ARRAY_A
                );

                if (!empty($plugin_faq_items)) {
                    foreach ($plugin_faq_items as $item) {
                        $faq_items[] = array(
                            'id' => (int) $item['id'],
                            'question' => $item['question'],
                            'answer' => apply_filters('the_content', $item['answer']),  // Process HTML
                            'order' => (int) $item['display_order'],
                        );
                    }

                    // If plugin database has items, return them (don't check WordPress posts)
                    return new WP_REST_Response(array(
                        'success' => true,
                        'data' => $faq_items
                    ), 200);
                }
            }

            // METHOD 2: Try custom post type 'faq' (fallback if plugin table is empty)
            $faq_posts = get_posts(array(
                'post_type' => 'faq',
                'post_status' => 'publish',
                'posts_per_page' => -1,
                'orderby' => 'menu_order',
                'order' => 'ASC',
            ));

            if (!empty($faq_posts)) {
                foreach ($faq_posts as $post) {
                    $faq_items[] = array(
                        'id' => $post->ID,
                        'question' => $post->post_title,
                        'answer' => apply_filters('the_content', $post->post_content),
                        'order' => $post->menu_order,
                    );
                }
            } else {
                // METHOD 3: Try posts with category 'faq' (fallback)
                $faq_category = get_category_by_slug('faq');
                if ($faq_category) {
                    $faq_posts = get_posts(array(
                        'category' => $faq_category->term_id,
                        'post_status' => 'publish',
                        'posts_per_page' => -1,
                        'orderby' => 'date',
                        'order' => 'DESC',
                    ));

                    foreach ($faq_posts as $post) {
                        $faq_items[] = array(
                            'id' => $post->ID,
                            'question' => $post->post_title,
                            'answer' => apply_filters('the_content', $post->post_content),
                            'order' => 0,
                        );
                    }
                }
            }

            // Return FAQ items (empty array if none found)
            return new WP_REST_Response(array(
                'success' => true,
                'data' => $faq_items
            ), 200);
        } catch (Exception $e) {
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: FAQ error: ' . $e->getMessage());
            }
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'Failed to retrieve FAQ items',
                'data' => array()
            ), 500);
        }
    }

    /**
     * REST API endpoint: Get About Us content
     * Returns structured About Us content from plugin database table
     *
     * @param WP_REST_Request $request The REST API request
     * @return WP_REST_Response Response with About Us content
     */
    public function rest_get_about_us(WP_REST_Request $request)
    {
        try {
            global $wpdb;
            $table_name = $this->about_us_table_name();

            // PROFESSIONAL FIX: Ensure table exists before querying
            $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
            if ($table_exists !== $table_name) {
                // Table doesn't exist - create it
                $this->create_about_us_table();
                // Verify table was created
                $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
                if ($table_exists !== $table_name) {
                    // Table creation failed - return default content
                    return new WP_REST_Response(array(
                        'success' => true,
                        'data' => array(
                            'company_name' => 'PLANETmm',
                            'tagline' => 'Pansy & Lincoln',
                            'subtitle' => 'All-in-One Network Myanmar',
                            'logo_url' => '',
                            'about_body_1' => "PLANETmm is Myanmar's premier all-in-one digital network platform, bringing together lifestyle, commerce, rewards, and community into a single seamless experience for users across the country.",
                            'about_body_2' => 'Our platform is built to connect people, businesses, and services in a modern, convenient, and secure way. We focus on delivering real value through exclusive promotions, smart loyalty points, easy payments, and a smooth shopping journey. With a strong technical foundation and a customer-first mindset, we are continuously improving to match the needs of Myanmar users in the digital age.',
                            'mission' => "To empower Myanmar's digital economy by connecting people, businesses, and communities through innovative technology, reliable services, and a rewarding experience that adds real value to everyday life.",
                            'vision' => "To become Myanmar's leading all-in-one digital platform, transforming how people shop, earn rewards, communicate, and live â€” by combining technology, creativity, and local understanding into a single powerful ecosystem.",
                            'email' => 'support@planetmm.com',
                            'phone' => '+95 9 123 456 789',
                            'address' => 'No. 123, Example Street, Yangon, Myanmar',
                            'version' => '1.0.2',
                        )
                    ), 200);
                }
            }

            // Get active About Us content (there should be only one record)
            $content = $wpdb->get_row(
                "SELECT * FROM `$table_name` WHERE status = 'active' ORDER BY id ASC LIMIT 1",
                ARRAY_A
            );

            // Check for database errors
            if ($wpdb->last_error && defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: About Us REST API query error: ' . $wpdb->last_error);
            }

            if ($content) {
                // PROFESSIONAL FIX: Unescape content before sending to frontend to prevent escaped apostrophes
                // Return structured data
                return new WP_REST_Response(array(
                    'success' => true,
                    'data' => array(
                        'company_name' => wp_unslash($content['company_name'] ?? 'PLANETmm'),
                        'tagline' => wp_unslash($content['tagline'] ?? 'Pansy & Lincoln'),
                        'subtitle' => wp_unslash($content['subtitle'] ?? 'All-in-One Network Myanmar'),
                        'logo_url' => wp_unslash($content['logo_url'] ?? ''),
                        'about_body_1' => wp_unslash($content['about_body_1'] ?? ''),
                        'about_body_2' => wp_unslash($content['about_body_2'] ?? ''),
                        'mission' => wp_unslash($content['mission'] ?? ''),
                        'vision' => wp_unslash($content['vision'] ?? ''),
                        'email' => wp_unslash($content['email'] ?? ''),
                        'phone' => wp_unslash($content['phone'] ?? ''),
                        'address' => wp_unslash($content['address'] ?? ''),
                        'version' => wp_unslash($content['version'] ?? '1.0.2'),
                    )
                ), 200);
            } else {
                // No content found - return default content
                return new WP_REST_Response(array(
                    'success' => true,
                    'data' => array(
                        'company_name' => 'PLANETmm',
                        'tagline' => 'Pansy & Lincoln',
                        'subtitle' => 'All-in-One Network Myanmar',
                        'logo_url' => '',
                        'about_body_1' => "PLANETmm is Myanmar's premier all-in-one digital network platform, bringing together lifestyle, commerce, rewards, and community into a single seamless experience for users across the country.",
                        'about_body_2' => 'Our platform is built to connect people, businesses, and services in a modern, convenient, and secure way. We focus on delivering real value through exclusive promotions, smart loyalty points, easy payments, and a smooth shopping journey. With a strong technical foundation and a customer-first mindset, we are continuously improving to match the needs of Myanmar users in the digital age.',
                        'mission' => "To empower Myanmar's digital economy by connecting people, businesses, and communities through innovative technology, reliable services, and a rewarding experience that adds real value to everyday life.",
                        'vision' => "To become Myanmar's leading all-in-one digital platform, transforming how people shop, earn rewards, communicate, and live â€” by combining technology, creativity, and local understanding into a single powerful ecosystem.",
                        'email' => 'support@planetmm.com',
                        'phone' => '+95 9 123 456 789',
                        'address' => 'No. 123, Example Street, Yangon, Myanmar',
                        'version' => '1.0.2',
                    )
                ), 200);
            }
        } catch (Exception $e) {
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: About Us error: ' . $e->getMessage());
            }
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'Failed to retrieve About Us content',
                'data' => null
            ), 500);
        }
    }

    /**
     * REST API endpoint for engagement feed
     * Returns active engagement items (banners, quizzes, polls, announcements)
     *
     * Follows same pattern as rest_get_transactions - user_id from path parameter
     *
     * @param WP_REST_Request $request The REST API request
     * @return WP_REST_Response|WP_Error Response with engagement items or error
     */
    public function rest_engagement_feed(WP_REST_Request $request)
    {
        global $wpdb;

        try {
            // Get user_id from path parameter (same pattern as points transactions)
            $user_id = intval($request->get_param('user_id'));

            // Validate user_id (required from path)
            if ($user_id <= 0) {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Invalid user ID',
                    'data' => array()
                ), 400);
            }

            $table_items = $wpdb->prefix . 'twork_engagement_items';
            $table_interactions = $wpdb->prefix . 'twork_user_interactions';

            // Verify tables exist (safety check)
            if ($wpdb->get_var("SHOW TABLES LIKE '$table_items'") !== $table_items) {
                if (defined('WP_DEBUG') && WP_DEBUG) {
                    error_log('T-Work Rewards: Engagement items table does not exist');
                }
                return new WP_REST_Response(array(
                    'success' => true,
                    'data' => array(),
                    'message' => 'Engagement system not initialized'
                ), 200);
            }

            // Get active items
            // Note: Date filtering is optional - if start_date/end_date are NULL, item is always active
            $current_time = current_time('mysql');
            $sql = $wpdb->prepare(
                "SELECT * FROM $table_items 
                 WHERE status = 'active' 
                 AND (start_date IS NULL OR start_date <= %s)
                 AND (end_date IS NULL OR end_date >= %s)
                 ORDER BY priority DESC, created_at DESC
                 LIMIT 20",
                $current_time,
                $current_time
            );

            $items = $wpdb->get_results($sql, ARRAY_A);

            // Handle database errors
            if ($items === false) {
                $error_msg = $wpdb->last_error ?: 'Database query failed';
                if (defined('WP_DEBUG') && WP_DEBUG) {
                    error_log('T-Work Rewards: Engagement feed query error: ' . $error_msg);
                }
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Failed to retrieve engagement items',
                    'data' => array()
                ), 500);
            }

            // Debug logging (only in development)
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: Engagement Feed - User ID: ' . $user_id);
                error_log('T-Work Rewards: Engagement Feed - Items Found: ' . count($items));
            }

            // Check for user interactions (e.g. if quiz already answered)
            $user_interactions = array();
            $interaction_sql = $wpdb->prepare(
                "SELECT item_id, interaction_type, is_correct, interaction_value 
                 FROM $table_interactions 
                 WHERE user_id = %d",
                $user_id
            );
            $results = $wpdb->get_results($interaction_sql, ARRAY_A);
            if ($results !== false) {
                foreach ($results as $row) {
                    $user_interactions[$row['item_id']] = $row;
                }
            }

            $feed_data = array();
            foreach ($items as $item) {
                try {
                    $item_id = (int) $item['id'];
                    $has_interacted = isset($user_interactions[$item_id]);
                    $interaction_data = $has_interacted ? $user_interactions[$item_id] : null;

                    // Process data based on type
                    $quiz_data = null;
                    if (!empty($item['quiz_data'])) {
                        $decoded = json_decode($item['quiz_data'], true);
                        if (json_last_error() === JSON_ERROR_NONE && is_array($decoded)) {
                            $quiz_data = $decoded;
                        }
                    }

                    // Remove correct answer from quiz data for client security
                    if ($quiz_data && isset($quiz_data['correct_index'])) {
                        unset($quiz_data['correct_index']);
                    }

                    // Get rotation_duration from database (in seconds, 1-60, NULL = use global default)
                    $rotation_duration = null;
                    if (isset($item['rotation_duration']) && $item['rotation_duration'] !== null) {
                        $rotation_duration = intval($item['rotation_duration']);
                        // Validate: must be between 1-60 seconds
                        if ($rotation_duration < 1 || $rotation_duration > 60) {
                            $rotation_duration = null;  // Invalid value, use global default
                        }
                    }

                    // If item doesn't have rotation_duration, use global setting
                    if ($rotation_duration === null) {
                        $global_rotation_duration = get_option('twork_engagement_global_rotation_duration', 5);
                        $rotation_duration = intval($global_rotation_duration);
                        // Validate global setting
                        if ($rotation_duration < 1 || $rotation_duration > 60) {
                            $rotation_duration = 5;  // Fallback to 5 seconds if invalid
                        }
                    }

                    $feed_item = array(
                        'id' => $item_id,
                        'type' => sanitize_text_field($item['type']),
                        'title' => sanitize_text_field($item['title']),
                        'media_url' => !empty($item['media_url']) ? esc_url_raw($item['media_url']) : null,
                        'content' => wp_kses_post($item['content']),
                        'reward_points' => (int) $item['reward_points'],
                        'has_interacted' => $has_interacted,
                        'rotation_duration' => $rotation_duration,  // Always include rotation_duration (from item or global)
                    );

                    if (($item['type'] === 'quiz' || $item['type'] === 'poll') && $quiz_data !== null) {
                        $feed_item['quiz_data'] = $quiz_data;
                        if ($has_interacted && $interaction_data) {
                            $feed_item['user_answer'] = isset($interaction_data['interaction_value'])
                                ? sanitize_text_field($interaction_data['interaction_value'])
                                : null;
                        }
                    }

                    $feed_data[] = $feed_item;
                } catch (Exception $e) {
                    // Log error but continue processing other items
                    if (defined('WP_DEBUG') && WP_DEBUG) {
                        error_log('T-Work Rewards: Error processing engagement item ' . $item['id'] . ': ' . $e->getMessage());
                    }
                    continue;
                }
            }

            return new WP_REST_Response(array(
                'success' => true,
                'data' => $feed_data
            ), 200);
        } catch (Exception $e) {
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: Engagement feed exception: ' . $e->getMessage());
            }
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'An error occurred while retrieving engagement feed',
                'data' => array()
            ), 500);
        }
    }

    /**
     * PROFESSIONAL FEATURE: Get engagement item statistics (poll/quiz vote counts, percentages)
     *
     * @param int $item_id The engagement item ID
     * @return array|null Statistics array or null if item not found
     */
    private function get_engagement_item_statistics($item_id)
    {
        global $wpdb;

        if (!$item_id || $item_id <= 0) {
            return null;
        }

        $table_items = $wpdb->prefix . 'twork_engagement_items';
        $table_interactions = $wpdb->prefix . 'twork_user_interactions';

        // Get item data
        $item = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $table_items WHERE id = %d",
            $item_id
        ), ARRAY_A);

        if (!$item || ($item['type'] !== 'poll' && $item['type'] !== 'quiz')) {
            return null;
        }

        // Parse quiz/poll data
        $quiz_data = json_decode($item['quiz_data'], true);
        if (!is_array($quiz_data) || !isset($quiz_data['options'])) {
            return null;
        }

        $options = $quiz_data['options'];
        $total_votes = 0;
        $vote_counts = array();
        $vote_percentages = array();

        // Count votes for each option
        foreach ($options as $index => $option) {
            $count = $wpdb->get_var($wpdb->prepare(
                "SELECT COUNT(*) FROM $table_interactions 
                 WHERE item_id = %d AND interaction_value = %s",
                $item_id,
                (string) $index
            ));

            $vote_counts[$index] = (int) $count;
            $total_votes += (int) $count;
        }

        // Calculate percentages
        if ($total_votes > 0) {
            foreach ($vote_counts as $index => $count) {
                $vote_percentages[$index] = round(($count / $total_votes) * 100, 2);
            }
        } else {
            foreach ($vote_counts as $index => $count) {
                $vote_percentages[$index] = 0.0;
            }
        }

        // Get correct answer index if available
        $correct_index = isset($quiz_data['correct_index']) ? (int) $quiz_data['correct_index'] : null;

        return array(
            'total_votes' => $total_votes,
            'vote_counts' => $vote_counts,
            'vote_percentages' => $vote_percentages,
            'options' => $options,
            'correct_index' => $correct_index,
            'has_correct_answer' => $correct_index !== null && $correct_index >= 0,
        );
    }

    /**
     * REST API endpoint for engagement interactions (quiz answers, poll votes)
     *
     * @param WP_REST_Request $request The REST API request
     * @return WP_REST_Response|WP_Error Response with interaction result or error
     */
    public function rest_engagement_interact(WP_REST_Request $request)
    {
        global $wpdb;

        try {
            // Support both JSON body and form data
            $params = $request->get_json_params();
            if (empty($params)) {
                $params = $request->get_params();
            }

            // Support both 'answer' and 'answer_value' for backward compatibility
            $user_id = isset($params['user_id']) ? absint($params['user_id']) : 0;
            $item_id = isset($params['item_id']) ? absint($params['item_id']) : 0;
            $answer = isset($params['answer'])
                ? sanitize_text_field($params['answer'])
                : (isset($params['answer_value']) ? sanitize_text_field($params['answer_value']) : '');

            // Validate required parameters
            if ($user_id <= 0) {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Invalid user_id parameter'
                ), 400);
            }

            if ($item_id <= 0) {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Invalid item_id parameter'
                ), 400);
            }

            $table_items = $wpdb->prefix . 'twork_engagement_items';
            $table_interactions = $wpdb->prefix . 'twork_user_interactions';

            // Verify tables exist
            if ($wpdb->get_var("SHOW TABLES LIKE '$table_items'") !== $table_items) {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Engagement system not initialized'
                ), 500);
            }

            // Check if item exists
            $item = $wpdb->get_row($wpdb->prepare(
                "SELECT * FROM $table_items WHERE id = %d",
                $item_id
            ), ARRAY_A);

            if (!$item) {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Engagement item not found'
                ), 404);
            }

            // Check if item is active
            if ($item['status'] !== 'active') {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'This engagement item is not currently active'
                ), 400);
            }

            // Check if already interacted
            $existing = $wpdb->get_var($wpdb->prepare(
                "SELECT id FROM $table_interactions WHERE user_id = %d AND item_id = %d",
                $user_id, $item_id
            ));

            if ($existing) {
                // Return existing interaction data instead of error
                $existing_interaction = $wpdb->get_row($wpdb->prepare(
                    "SELECT * FROM $table_interactions WHERE user_id = %d AND item_id = %d",
                    $user_id, $item_id
                ), ARRAY_A);

                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'You have already interacted with this item',
                    'data' => array(
                        'is_correct' => (bool) $existing_interaction['is_correct'],
                        'points_earned' => 0,  // Points already awarded
                    )
                ), 400);
            }

            $points_awarded = 0;
            $is_correct = false;
            $message = 'Thanks for participating!';

            // Logic for Quiz
            if ($item['type'] === 'quiz') {
                $quiz_data = json_decode($item['quiz_data'], true);

                if (json_last_error() !== JSON_ERROR_NONE || !is_array($quiz_data)) {
                    return new WP_REST_Response(array(
                        'success' => false,
                        'message' => 'Invalid quiz data'
                    ), 500);
                }

                $correct_index = isset($quiz_data['correct_index']) ? (int) $quiz_data['correct_index'] : -1;

                // Support both string and integer answer values
                $answer_index = is_numeric($answer) ? (int) $answer : -1;

                if ($answer_index === $correct_index && $correct_index >= 0) {
                    $is_correct = true;
                    $points_awarded = (int) $item['reward_points'];
                    $message = 'Correct! You earned ' . $points_awarded . ' points.';
                } else {
                    $message = 'Incorrect answer. Try again next time!';
                }
            } elseif ($item['type'] === 'poll') {
                // PROFESSIONAL FIX: Polls should check for correct answers like quizzes
                $poll_data = json_decode($item['quiz_data'], true);

                if (json_last_error() !== JSON_ERROR_NONE || !is_array($poll_data)) {
                    // If poll data is invalid, treat as participation-only poll
                    $points_awarded = (int) $item['reward_points'];
                    $is_correct = true;
                    $message = 'Thanks for voting!';
                } else {
                    // Check if poll has a correct answer defined
                    $correct_index = isset($poll_data['correct_index']) ? (int) $poll_data['correct_index'] : -1;

                    // Support both string and integer answer values
                    $answer_index = is_numeric($answer) ? (int) $answer : -1;

                    if ($correct_index >= 0) {
                        // Poll has a correct answer - check if user's answer is correct
                        if ($answer_index === $correct_index) {
                            $is_correct = true;
                            $points_awarded = (int) $item['reward_points'];
                            $message = 'Correct! You earned ' . $points_awarded . ' points.';
                        } else {
                            $is_correct = false;
                            $points_awarded = 0;  // No points for incorrect poll answer
                            $message = 'Incorrect answer. The correct answer was: '
                                . (isset($poll_data['options'][$correct_index]) ? esc_html($poll_data['options'][$correct_index]) : 'Option ' . ($correct_index + 1));
                        }
                    } else {
                        // Poll has no correct answer - participation-based (all answers get points)
                        $points_awarded = (int) $item['reward_points'];
                        $is_correct = true;
                        $message = 'Thanks for voting! You earned ' . $points_awarded . ' points.';
                    }
                }
            }

            // Record interaction
            $insert_result = $wpdb->insert(
                $table_interactions,
                array(
                    'user_id' => $user_id,
                    'item_id' => $item_id,
                    'interaction_type' => 'quiz_answer',
                    'interaction_value' => $answer,
                    'is_correct' => $is_correct ? 1 : 0,
                    'points_awarded' => $points_awarded,
                    'created_at' => current_time('mysql')
                ),
                array('%d', '%d', '%s', '%s', '%d', '%d', '%s')
            );

            if ($insert_result === false) {
                $error_msg = $wpdb->last_error ?: 'Failed to record interaction';
                $error_query = $wpdb->last_query ?: 'No query logged';

                // Log detailed error for debugging
                error_log(sprintf(
                    'T-Work Rewards: Failed to insert interaction - Error: %s, Query: %s, User ID: %d, Item ID: %d, Answer: %s',
                    $error_msg,
                    $error_query,
                    $user_id,
                    $item_id,
                    $answer
                ));

                // Check if it's a duplicate key error (shouldn't happen due to pre-check, but handle gracefully)
                if (strpos($error_msg, 'Duplicate entry') !== false || strpos($error_msg, 'UNIQUE constraint') !== false) {
                    // User already interacted (race condition)
                    $existing_interaction = $wpdb->get_row($wpdb->prepare(
                        "SELECT * FROM $table_interactions WHERE user_id = %d AND item_id = %d",
                        $user_id, $item_id
                    ), ARRAY_A);

                    return new WP_REST_Response(array(
                        'success' => false,
                        'message' => 'You have already submitted this quiz',
                        'data' => $existing_interaction ? array(
                            'is_correct' => (bool) $existing_interaction['is_correct'],
                            'points_earned' => (int) $existing_interaction['points_awarded'],
                        ) : null
                    ), 400);
                }

                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Failed to record interaction. Please try again.',
                    'debug' => defined('WP_DEBUG') && WP_DEBUG ? $error_msg : null
                ), 500);
            }

            // PROFESSIONAL FIX: Award points using unified system.
            // For Quiz: points only awarded when answer is correct ($is_correct must be true).
            // For Poll: points awarded for participation ($is_correct is always true for polls).
            $new_balance = 0;
            $item_type = $item['type'] ?? 'unknown';
            $item_title = $item['title'] ?? 'Activity #' . $item_id;

            if ($points_awarded > 0 && $is_correct) {
                // Get current balance before awarding points.
                $current_balance = $this->calculate_points_balance_from_transactions($user_id);

                // Generate order_id and description.
                $order_id = 'engagement:' . $item_type . ':' . $item_id . ':' . time();
                $description = sprintf(
                    '%s reward: %s (+%d points)',
                    ucfirst($item_type),
                    $item_title,
                    $points_awarded
                );

                // Use unified sync function (creates transaction and updates cache).
                $this->sync_user_points($user_id, (float) $points_awarded, $order_id, $description, true);

                // Get new balance after awarding.
                $new_balance = $this->calculate_points_balance_from_transactions($user_id);

                // PROFESSIONAL FCM NOTIFICATION: Send notification for engagement points earned
                $this->send_points_fcm_notification(
                    $user_id,
                    'engagement_points',
                    array(
                        'points' => $points_awarded,
                        'item_type' => $item_type,
                        'item_title' => $item_title,
                        'description' => $description,
                    )
                );

                // Professional logging.
                if (defined('WP_DEBUG') && WP_DEBUG) {
                    error_log(
                        sprintf(
                            'T-Work Rewards: Engagement points awarded. User ID: %d, Item ID: %d, Type: %s, Points: %d, Old Balance: %d, New Balance: %d',
                            $user_id,
                            $item_id,
                            $item_type,
                            $points_awarded,
                            $current_balance,
                            $new_balance
                        )
                    );
                }
            } else {
                // No points awarded (incorrect answer or no reward configured).
                $new_balance = $this->calculate_points_balance_from_transactions($user_id);
            }

            // PROFESSIONAL ENGAGEMENT NOTIFICATIONS: Send acknowledgment notification for all interactions
            // This ensures users receive feedback for their participation, even if no points were earned
            if ($item_type === 'quiz') {
                // Send notification for quiz submission (both correct and incorrect)
                $this->send_engagement_fcm_notification(
                    $user_id,
                    'engagement_quiz_submitted',
                    array(
                        'item_id' => $item_id,
                        'item_type' => $item_type,
                        'item_title' => $item_title,
                        'is_correct' => $is_correct,
                        'points_awarded' => $points_awarded,
                        'current_balance' => $new_balance,
                    )
                );
            } elseif ($item_type === 'poll') {
                // Send notification for poll vote submission
                $this->send_engagement_fcm_notification(
                    $user_id,
                    'engagement_poll_submitted',
                    array(
                        'item_id' => $item_id,
                        'item_type' => $item_type,
                        'item_title' => $item_title,
                        'points_awarded' => $points_awarded,
                        'current_balance' => $new_balance,
                    )
                );
            }

            // Professional logging for dashboard analytics
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf(
                    'T-Work Rewards: Quiz Interaction Recorded - User ID: %d, Item ID: %d, Item Title: "%s", Answer: %s, Correct: %s, Points: %d, New Balance: %d',
                    $user_id,
                    $item_id,
                    $item['title'] ?? 'Unknown',
                    $answer,
                    $is_correct ? 'Yes' : 'No',
                    $points_awarded,
                    $new_balance
                ));
            }

            // PROFESSIONAL FEATURE: Get poll/quiz statistics for result display
            $result_statistics = null;
            if ($item['type'] === 'poll' || $item['type'] === 'quiz') {
                $result_statistics = $this->get_engagement_item_statistics($item_id);
            }

            // PROFESSIONAL FEATURE: Get correct answer and user answer for display
            $result_details = null;
            if ($item['type'] === 'poll' || $item['type'] === 'quiz') {
                $quiz_data = json_decode($item['quiz_data'], true);
                if (is_array($quiz_data)) {
                    $correct_index = isset($quiz_data['correct_index']) ? (int) $quiz_data['correct_index'] : -1;
                    $answer_index = is_numeric($answer) ? (int) $answer : -1;

                    $result_details = array(
                        'user_answer_index' => $answer_index,
                        'user_answer_text' => isset($quiz_data['options'][$answer_index]) ? $quiz_data['options'][$answer_index] : null,
                        'correct_answer_index' => $correct_index >= 0 ? $correct_index : null,
                        'correct_answer_text' => ($correct_index >= 0 && isset($quiz_data['options'][$correct_index])) ? $quiz_data['options'][$correct_index] : null,
                        'has_correct_answer' => $correct_index >= 0,
                    );
                }
            }

            // Return professional response with detailed data for dashboard
            return new WP_REST_Response(array(
                'success' => true,
                'data' => array(
                    'is_correct' => $is_correct,
                    'points_earned' => $points_awarded,
                    'new_balance' => $new_balance,
                    'item_title' => $item['title'] ?? '',
                    'item_type' => $item['type'] ?? '',
                    'interaction_id' => $wpdb->insert_id,
                    'statistics' => $result_statistics,  // Vote counts, percentages, etc.
                    'result_details' => $result_details,  // Correct answer, user answer, etc.
                ),
                'message' => $message
            ), 200);
        } catch (Exception $e) {
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: Engagement interact exception: ' . $e->getMessage());
            }
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'An error occurred while processing your interaction'
            ), 500);
        }
    }

    /**
     * REST API endpoint to start a usage tracking session
     * Called when user opens the app
     *
     * @param WP_REST_Request $request The REST API request
     * @return WP_REST_Response Response with session_id
     */

    /**
     * PROFESSIONAL FEATURE: REST API endpoint for poll/quiz results with statistics
     *
     * GET /wp-json/twork/v1/engagement/result/{item_id}?user_id={user_id}
     *
     * @param WP_REST_Request $request The REST API request
     * @return WP_REST_Response Response with poll/quiz results and statistics
     */
    public function rest_engagement_result(WP_REST_Request $request)
    {
        global $wpdb;

        try {
            $item_id = absint($request->get_param('item_id'));
            $user_id = absint($request->get_param('user_id'));

            if ($item_id <= 0) {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Invalid item_id parameter'
                ), 400);
            }

            $table_items = $wpdb->prefix . 'twork_engagement_items';
            $table_interactions = $wpdb->prefix . 'twork_user_interactions';

            // Verify tables exist
            if ($wpdb->get_var("SHOW TABLES LIKE '$table_items'") !== $table_items) {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Engagement system not initialized'
                ), 500);
            }

            // Get item
            $item = $wpdb->get_row($wpdb->prepare(
                "SELECT * FROM $table_items WHERE id = %d",
                $item_id
            ), ARRAY_A);

            if (!$item) {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Item not found'
                ), 404);
            }

            // Only polls and quizzes have results
            if ($item['type'] !== 'poll' && $item['type'] !== 'quiz') {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'This item type does not have results'
                ), 400);
            }

            // Get statistics
            $statistics = $this->get_engagement_item_statistics($item_id);

            if (!$statistics) {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Could not retrieve statistics'
                ), 500);
            }

            // Get user's answer if user_id provided
            $user_answer = null;
            $user_is_correct = null;
            if ($user_id > 0) {
                $user_interaction = $wpdb->get_row($wpdb->prepare(
                    "SELECT * FROM $table_interactions 
                     WHERE user_id = %d AND item_id = %d 
                     ORDER BY created_at DESC LIMIT 1",
                    $user_id,
                    $item_id
                ), ARRAY_A);

                if ($user_interaction) {
                    $answer_index = is_numeric($user_interaction['interaction_value'])
                        ? (int) $user_interaction['interaction_value']
                        : -1;

                    $user_answer = array(
                        'answer_index' => $answer_index,
                        'answer_text' => isset($statistics['options'][$answer_index])
                            ? $statistics['options'][$answer_index]
                            : null,
                        'is_correct' => (bool) $user_interaction['is_correct'],
                        'points_earned' => (int) $user_interaction['points_awarded'],
                        'answered_at' => $user_interaction['created_at'],
                    );
                    $user_is_correct = (bool) $user_interaction['is_correct'];
                }
            }

            // Parse quiz/poll data for options
            $quiz_data = json_decode($item['quiz_data'], true);
            $correct_index = isset($quiz_data['correct_index']) ? (int) $quiz_data['correct_index'] : null;

            // Build detailed result data
            $result_data = array(
                'item_id' => $item_id,
                'item_title' => $item['title'] ?? '',
                'item_type' => $item['type'],
                'question' => isset($quiz_data['question']) ? $quiz_data['question'] : '',
                'options' => array(),
                'statistics' => array(
                    'total_votes' => $statistics['total_votes'],
                    'vote_counts' => $statistics['vote_counts'],
                    'vote_percentages' => $statistics['vote_percentages'],
                ),
                'correct_answer' => array(
                    'index' => $correct_index !== null && $correct_index >= 0 ? $correct_index : null,
                    'text' => ($correct_index !== null && $correct_index >= 0 && isset($statistics['options'][$correct_index]))
                        ? $statistics['options'][$correct_index]
                        : null,
                    'has_correct_answer' => $correct_index !== null && $correct_index >= 0,
                ),
                'user_answer' => $user_answer,
            );

            // Build options array with statistics
            foreach ($statistics['options'] as $index => $option_text) {
                $result_data['options'][] = array(
                    'index' => $index,
                    'text' => $option_text,
                    'vote_count' => isset($statistics['vote_counts'][$index]) ? $statistics['vote_counts'][$index] : 0,
                    'vote_percentage' => isset($statistics['vote_percentages'][$index]) ? $statistics['vote_percentages'][$index] : 0.0,
                    'is_correct' => ($correct_index !== null && $index === $correct_index),
                    'is_user_answer' => ($user_answer && $user_answer['answer_index'] === $index),
                );
            }

            return new WP_REST_Response(array(
                'success' => true,
                'data' => $result_data
            ), 200);
        } catch (Exception $e) {
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: Engagement result exception: ' . $e->getMessage());
            }
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'An error occurred while retrieving results'
            ), 500);
        }
    }

    public function rest_usage_start(WP_REST_Request $request)
    {
        global $wpdb;

        // DEBUG: Log incoming request
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log('T-Work Rewards: rest_usage_start called');
            error_log('T-Work Rewards: Request method: ' . $request->get_method());
            error_log('T-Work Rewards: Request params: ' . print_r($request->get_params(), true));
            error_log('T-Work Rewards: Request body: ' . $request->get_body());
            error_log('T-Work Rewards: JSON params: ' . print_r($request->get_json_params(), true));
        }

        try {
            // Try to get from JSON body first (for POST requests)
            $json_params = $request->get_json_params();
            if (!empty($json_params)) {
                $user_id = isset($json_params['user_id']) ? absint($json_params['user_id']) : 0;
                $device_info = isset($json_params['device_info']) ? sanitize_text_field($json_params['device_info']) : '';
                $app_version = isset($json_params['app_version']) ? sanitize_text_field($json_params['app_version']) : '';
                $country_code = isset($json_params['country_code']) ? strtoupper(sanitize_text_field($json_params['country_code'])) : '';
                $country_name = isset($json_params['country_name']) ? sanitize_text_field($json_params['country_name']) : '';
            } else {
                // Fallback to get_param (for query params or URL params)
                $user_id = absint($request->get_param('user_id'));
                $device_info = sanitize_text_field($request->get_param('device_info') ?: '');
                $app_version = sanitize_text_field($request->get_param('app_version') ?: '');
                $country_code = strtoupper(sanitize_text_field($request->get_param('country_code') ?: ''));
                $country_name = sanitize_text_field($request->get_param('country_name') ?: '');
            }

            // DEBUG: Log parsed values
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: Parsed user_id: ' . $user_id);
                error_log('T-Work Rewards: Parsed device_info: ' . $device_info);
                error_log('T-Work Rewards: Parsed app_version: ' . $app_version);
            }

            if ($user_id <= 0) {
                error_log('T-Work Rewards: Invalid user_id (0 or negative): ' . $user_id);
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Invalid user_id parameter. Please provide a valid user_id in the request body.',
                    'debug' => defined('WP_DEBUG') && WP_DEBUG ? array(
                        'received_params' => $json_params ?: $request->get_params(),
                        'body' => $request->get_body(),
                    ) : null
                ), 400);
            }

            $usage_table = $this->usage_tracking_table_name();

            // Check if table exists
            if ($wpdb->get_var("SHOW TABLES LIKE '$usage_table'") !== $usage_table) {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Usage tracking system not initialized'
                ), 500);
            }

            // Check if user has an active session (not ended)
            $active_session = $wpdb->get_row($wpdb->prepare(
                "SELECT * FROM $usage_table 
                WHERE user_id = %d AND session_end IS NULL 
                ORDER BY session_start DESC 
                LIMIT 1",
                $user_id
            ));

            if ($active_session) {
                // Return existing active session
                return new WP_REST_Response(array(
                    'success' => true,
                    'data' => array(
                        'session_id' => (int) $active_session->id,
                        'session_start' => $active_session->session_start,
                        'message' => 'Active session found'
                    )
                ), 200);
            }

            // Professional: Get country name from country code if not provided
            if (!empty($country_code) && empty($country_name)) {
                $country_name = $this->get_country_name_from_code($country_code);
            }

            // Create new session
            $session_start = current_time('mysql');
            $result = $wpdb->insert(
                $usage_table,
                array(
                    'user_id' => $user_id,
                    'session_start' => $session_start,
                    'device_info' => $device_info,
                    'app_version' => $app_version,
                    'country_code' => !empty($country_code) ? $country_code : null,
                    'country_name' => !empty($country_name) ? $country_name : null,
                ),
                array('%d', '%s', '%s', '%s', '%s', '%s')
            );

            if ($result === false) {
                error_log('T-Work Rewards: Failed to create usage session. Error: ' . $wpdb->last_error);
                error_log('T-Work Rewards: SQL Query: ' . $wpdb->last_query);
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Failed to start session',
                    'debug' => defined('WP_DEBUG') && WP_DEBUG ? $wpdb->last_error : null
                ), 500);
            }

            $session_id = (int) $wpdb->insert_id;

            // Professional: Store first session country in user meta (for location tracking)
            // This tracks where the user first used the app
            if (!empty($country_code) || !empty($country_name)) {
                $first_country = get_user_meta($user_id, 'twork_first_session_country', true);
                if (empty($first_country)) {
                    // Store first session country
                    update_user_meta($user_id, 'twork_first_session_country', !empty($country_code) ? $country_code : '');
                    update_user_meta($user_id, 'twork_first_session_country_name', !empty($country_name) ? $country_name : '');
                }
            }

            // Track user activity when app session starts
            $this->track_user_activity($user_id);

            // DEBUG: Log successful session creation
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: Usage session created successfully. Session ID: ' . $session_id . ', User ID: ' . $user_id);
            }

            return new WP_REST_Response(array(
                'success' => true,
                'data' => array(
                    'session_id' => $session_id,
                    'session_start' => $session_start,
                    'message' => 'Session started successfully'
                )
            ), 200);
        } catch (Exception $e) {
            error_log('T-Work Rewards: Error in rest_usage_start: ' . $e->getMessage());
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'An error occurred while starting session',
                'debug' => defined('WP_DEBUG') && WP_DEBUG ? $e->getMessage() : null
            ), 500);
        }
    }

    /**
     * REST API endpoint to end a usage tracking session
     * Called when user closes the app or goes to background
     *
     * @param WP_REST_Request $request The REST API request
     * @return WP_REST_Response Response with session duration
     */
    public function rest_usage_end(WP_REST_Request $request)
    {
        global $wpdb;

        // DEBUG: Log incoming request
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log('T-Work Rewards: rest_usage_end called');
            error_log('T-Work Rewards: Request method: ' . $request->get_method());
            error_log('T-Work Rewards: Request params: ' . print_r($request->get_params(), true));
            error_log('T-Work Rewards: Request body: ' . $request->get_body());
            error_log('T-Work Rewards: JSON params: ' . print_r($request->get_json_params(), true));
        }

        try {
            // Try to get from JSON body first (for POST requests)
            $json_params = $request->get_json_params();
            if (!empty($json_params)) {
                $user_id = isset($json_params['user_id']) ? absint($json_params['user_id']) : 0;
                $session_id = isset($json_params['session_id']) ? absint($json_params['session_id']) : 0;
            } else {
                // Fallback to get_param (for query params or URL params)
                $user_id = absint($request->get_param('user_id'));
                $session_id = absint($request->get_param('session_id'));
            }

            // DEBUG: Log parsed values
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: Parsed user_id: ' . $user_id);
                error_log('T-Work Rewards: Parsed session_id: ' . $session_id);
            }

            if ($user_id <= 0) {
                error_log('T-Work Rewards: Invalid user_id (0 or negative): ' . $user_id);
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Invalid user_id parameter. Please provide a valid user_id in the request body.',
                    'debug' => defined('WP_DEBUG') && WP_DEBUG ? array(
                        'received_params' => $json_params ?: $request->get_params(),
                        'body' => $request->get_body(),
                    ) : null
                ), 400);
            }

            $usage_table = $this->usage_tracking_table_name();

            // Check if table exists, create if missing
            if ($wpdb->get_var("SHOW TABLES LIKE '$usage_table'") !== $usage_table) {
                error_log('T-Work Rewards: Usage tracking table not found, creating...');
                $this->create_usage_tracking_table();

                // Verify table was created
                if ($wpdb->get_var("SHOW TABLES LIKE '$usage_table'") !== $usage_table) {
                    error_log('T-Work Rewards: Failed to create usage tracking table');
                    return new WP_REST_Response(array(
                        'success' => false,
                        'message' => 'Usage tracking system not initialized. Please create the table from admin page.'
                    ), 500);
                }
                error_log('T-Work Rewards: Usage tracking table created successfully');
            }

            // Find active session
            $where_clause = 'user_id = %d AND session_end IS NULL';
            $where_values = array($user_id);

            if ($session_id > 0) {
                $where_clause .= ' AND id = %d';
                $where_values[] = $session_id;
            }

            $active_session = $wpdb->get_row($wpdb->prepare(
                "SELECT * FROM $usage_table 
                WHERE $where_clause 
                ORDER BY session_start DESC 
                LIMIT 1",
                ...$where_values
            ));

            if (!$active_session) {
                // DEBUG: Log when no active session found
                if (defined('WP_DEBUG') && WP_DEBUG) {
                    error_log('T-Work Rewards: No active session found for user_id: ' . $user_id . ', session_id: ' . $session_id);
                }
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'No active session found',
                    'debug' => defined('WP_DEBUG') && WP_DEBUG ? array(
                        'user_id' => $user_id,
                        'session_id' => $session_id,
                    ) : null
                ), 404);
            }

            // Calculate duration
            $session_start = strtotime($active_session->session_start);
            $session_end_time = current_time('timestamp');
            $duration_seconds = max(0, $session_end_time - $session_start);  // Ensure non-negative

            // Update session with end time and duration
            $session_end_mysql = current_time('mysql');
            $result = $wpdb->update(
                $usage_table,
                array(
                    'session_end' => $session_end_mysql,
                    'duration_seconds' => $duration_seconds,
                ),
                array('id' => $active_session->id),
                array('%s', '%d'),
                array('%d')
            );

            if ($result === false) {
                error_log('T-Work Rewards: Failed to end usage session. Error: ' . $wpdb->last_error);
                error_log('T-Work Rewards: SQL Query: ' . $wpdb->last_query);
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Failed to end session',
                    'debug' => defined('WP_DEBUG') && WP_DEBUG ? $wpdb->last_error : null
                ), 500);
            }

            // Format duration for response
            $hours = floor($duration_seconds / 3600);
            $minutes = floor(($duration_seconds % 3600) / 60);
            $seconds = $duration_seconds % 60;
            $duration_formatted = sprintf('%d:%02d:%02d', $hours, $minutes, $seconds);

            // DEBUG: Log successful session end
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: Usage session ended successfully. Session ID: ' . $active_session->id . ', Duration: ' . $duration_formatted . ' (' . $duration_seconds . ' seconds)');
            }

            return new WP_REST_Response(array(
                'success' => true,
                'data' => array(
                    'session_id' => (int) $active_session->id,
                    'duration_seconds' => $duration_seconds,
                    'duration_formatted' => $duration_formatted,
                    'session_start' => $active_session->session_start,
                    'session_end' => $session_end_mysql,
                    'message' => 'Session ended successfully'
                )
            ), 200);
        } catch (Exception $e) {
            error_log('T-Work Rewards: Error in rest_usage_end: ' . $e->getMessage());
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'An error occurred while ending session',
                'debug' => defined('WP_DEBUG') && WP_DEBUG ? $e->getMessage() : null
            ), 500);
        }
    }

    /**
     * REST API endpoint to get usage statistics for a user
     *
     * @param WP_REST_Request $request The REST API request
     * @return WP_REST_Response Response with usage statistics
     */
    public function rest_usage_stats(WP_REST_Request $request)
    {
        global $wpdb;

        try {
            $user_id = absint($request->get_param('user_id'));

            if ($user_id <= 0) {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Invalid user_id parameter'
                ), 400);
            }

            $usage_table = $this->usage_tracking_table_name();

            // Check if table exists
            if ($wpdb->get_var("SHOW TABLES LIKE '$usage_table'") !== $usage_table) {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Usage tracking system not initialized'
                ), 500);
            }

            // Get total statistics
            $stats = $wpdb->get_row($wpdb->prepare(
                "SELECT 
                    COUNT(*) as total_sessions,
                    SUM(duration_seconds) as total_duration_seconds,
                    AVG(duration_seconds) as avg_duration_seconds,
                    MIN(session_start) as first_session,
                    MAX(session_start) as last_session
                FROM $usage_table
                WHERE user_id = %d AND session_end IS NOT NULL",
                $user_id
            ));

            // Get active session if exists
            $active_session = $wpdb->get_row($wpdb->prepare(
                "SELECT * FROM $usage_table 
                WHERE user_id = %d AND session_end IS NULL 
                ORDER BY session_start DESC 
                LIMIT 1",
                $user_id
            ));

            // Format statistics
            $total_duration = (int) ($stats->total_duration_seconds ?? 0);
            $avg_duration = (int) ($stats->avg_duration_seconds ?? 0);

            $total_hours = floor($total_duration / 3600);
            $total_minutes = floor(($total_duration % 3600) / 60);

            $avg_hours = floor($avg_duration / 3600);
            $avg_minutes = floor(($avg_duration % 3600) / 60);

            return new WP_REST_Response(array(
                'success' => true,
                'data' => array(
                    'total_sessions' => (int) ($stats->total_sessions ?? 0),
                    'total_duration_seconds' => $total_duration,
                    'total_duration_formatted' => sprintf('%d hours %d minutes', $total_hours, $total_minutes),
                    'avg_duration_seconds' => $avg_duration,
                    'avg_duration_formatted' => sprintf('%d hours %d minutes', $avg_hours, $avg_minutes),
                    'first_session' => $stats->first_session ?? null,
                    'last_session' => $stats->last_session ?? null,
                    'active_session' => $active_session ? array(
                        'session_id' => (int) $active_session->id,
                        'session_start' => $active_session->session_start,
                    ) : null
                )
            ), 200);
        } catch (Exception $e) {
            error_log('T-Work Rewards: Error in rest_usage_stats: ' . $e->getMessage());
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'An error occurred while retrieving statistics',
                'debug' => defined('WP_DEBUG') && WP_DEBUG ? $e->getMessage() : null
            ), 500);
        }
    }

    /**
     * ============================================
     * USER ACTIVITY TRACKING SYSTEM
     * Professional implementation for Active/Inactive User detection
     * ============================================
     */

    /**
     * Track user login activity
     * Hooked into wp_login action
     *
     * @param string $user_login User login name
     * @param WP_User $user User object
     */
    public function track_user_login($user_login, $user)
    {
        if (!isset($user->ID) || $user->ID <= 0) {
            return;
        }

        $user_id = (int) $user->ID;
        $current_time = time();

        // Update last login time
        update_user_meta($user_id, 'twork_last_login', $current_time);

        // Also update last activity (login is considered activity)
        $this->track_user_activity($user_id);

        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log(sprintf('T-Work Rewards: User login tracked - User ID: %d, Login Time: %s',
                $user_id,
                date('Y-m-d H:i:s', $current_time)));
        }
    }

    /**
     * Track REST API activity
     * Hooked into rest_api_init to catch all REST API calls
     * Uses a filter on rest_pre_dispatch to track activity after request is parsed
     */
    public function track_rest_api_activity()
    {
        // Use rest_pre_dispatch filter to track activity after request is parsed
        add_filter('rest_pre_dispatch', array($this, 'track_rest_api_request'), 10, 3);
    }

    /**
     * Track REST API request activity
     * Called via rest_pre_dispatch filter
     *
     * @param mixed $result Response to replace the requested value with
     * @param WP_REST_Server $server Server instance
     * @param WP_REST_Request $request Request used to generate the response
     * @return mixed Unchanged result
     */
    public function track_rest_api_request($result, $server, $request)
    {
        // Only track twork API endpoints
        $route = $request->get_route();
        if (strpos($route, '/twork/v1/') === false) {
            return $result;
        }

        $user_id = 0;

        // Try to get user_id from authenticated user first
        $current_user_id = get_current_user_id();
        if ($current_user_id > 0) {
            $user_id = $current_user_id;
        }

        // If no authenticated user, try to get from request parameters
        if ($user_id <= 0) {
            // Check path parameters (e.g., /twork/v1/user/activity/123)
            $user_id_param = $request->get_param('user_id');
            if (!empty($user_id_param) && is_numeric($user_id_param)) {
                $user_id = absint($user_id_param);
            }

            // Check JSON body
            if ($user_id <= 0) {
                $json_params = $request->get_json_params();
                if (!empty($json_params) && isset($json_params['user_id']) && is_numeric($json_params['user_id'])) {
                    $user_id = absint($json_params['user_id']);
                }
            }

            // Check query parameters
            if ($user_id <= 0) {
                $query_params = $request->get_query_params();
                if (!empty($query_params) && isset($query_params['user_id']) && is_numeric($query_params['user_id'])) {
                    $user_id = absint($query_params['user_id']);
                }
            }
        }

        // Track activity if we have a valid user
        if ($user_id > 0) {
            $this->track_user_activity($user_id);
        }

        return $result;
    }

    /**
     * Track user activity (generic method)
     * Updates last_activity timestamp for a user
     *
     * @param int $user_id User ID
     */
    public function track_user_activity($user_id)
    {
        if (!is_numeric($user_id) || $user_id <= 0) {
            return;
        }

        $user_id = (int) $user_id;
        $current_time = time();

        // Update last activity time
        update_user_meta($user_id, 'twork_last_activity', $current_time);

        // Also update last activity date for easier querying
        update_user_meta($user_id, 'twork_last_activity_date', date('Y-m-d', $current_time));
    }

    /**
     * Initialize activity data for existing users
     * This function backfills activity data based on:
     * 1. Last WooCommerce order date
     * 2. Last reward transaction date
     * 3. User registration date (as fallback)
     *
     * @param int $limit Number of users to process per batch (default: 100)
     * @return array Statistics about the initialization
     */
    public function initialize_user_activity($limit = 100)
    {
        global $wpdb;

        $stats = array(
            'processed' => 0,
            'updated' => 0,
            'skipped' => 0,
            'errors' => 0
        );

        // Get users without activity data (or with very old data)
        $users = get_users(array(
            'number' => $limit,
            'meta_query' => array(
                'relation' => 'OR',
                array(
                    'key' => 'twork_last_activity',
                    'compare' => 'NOT EXISTS'
                ),
                array(
                    'key' => 'twork_last_activity',
                    'value' => '0',
                    'compare' => '='
                )
            )
        ));

        if (empty($users)) {
            return $stats;
        }

        $table_name = $this->table_name();

        foreach ($users as $user) {
            $user_id = (int) $user->ID;
            $most_recent_activity = 0;

            try {
                // 1. Check last WooCommerce order
                if (class_exists('WooCommerce')) {
                    $last_order = wc_get_orders(array(
                        'customer_id' => $user_id,
                        'limit' => 1,
                        'orderby' => 'date',
                        'order' => 'DESC',
                        'status' => array('wc-completed', 'wc-processing', 'wc-on-hold')
                    ));

                    if (!empty($last_order)) {
                        $order_date = $last_order[0]->get_date_created();
                        if ($order_date) {
                            $order_timestamp = $order_date->getTimestamp();
                            if ($order_timestamp > $most_recent_activity) {
                                $most_recent_activity = $order_timestamp;
                            }
                        }
                    }
                }

                // 2. Check last reward transaction
                $last_transaction = $wpdb->get_row($wpdb->prepare(
                    "SELECT created_at FROM $table_name 
                    WHERE user_id = %d AND deleted_at IS NULL 
                    ORDER BY created_at DESC LIMIT 1",
                    $user_id
                ));

                if ($last_transaction && !empty($last_transaction->created_at)) {
                    $transaction_timestamp = strtotime($last_transaction->created_at);
                    if ($transaction_timestamp > $most_recent_activity) {
                        $most_recent_activity = $transaction_timestamp;
                    }
                }

                // 3. Fallback to registration date if no other activity found
                if ($most_recent_activity === 0 && isset($user->user_registered)) {
                    $most_recent_activity = strtotime($user->user_registered);
                }

                // Update activity if we found something
                if ($most_recent_activity > 0) {
                    update_user_meta($user_id, 'twork_last_activity', $most_recent_activity);
                    update_user_meta($user_id, 'twork_last_activity_date', date('Y-m-d', $most_recent_activity));

                    // If no login time exists, use the same as activity
                    if (empty(get_user_meta($user_id, 'twork_last_login', true))) {
                        update_user_meta($user_id, 'twork_last_login', $most_recent_activity);
                    }

                    $stats['updated']++;
                } else {
                    $stats['skipped']++;
                }

                $stats['processed']++;
            } catch (Exception $e) {
                error_log('T-Work Rewards: Error initializing activity for user ' . $user_id . ': ' . $e->getMessage());
                $stats['errors']++;
            }
        }

        return $stats;
    }

    /**
     * Handle activity initialization request
     * Processes users in batches to avoid timeouts
     */
    public function handle_initialize_activity()
    {
        // Security check
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('You do not have permission to perform this action.', 'twork-rewards'));
        }

        check_admin_referer('twork_rewards_initialize_activity');

        $batch = isset($_GET['batch']) ? intval($_GET['batch']) : 1;
        $limit = 100;  // Process 100 users per batch

        $stats = $this->initialize_user_activity($limit);

        // If we processed a full batch, continue to next batch
        if ($stats['processed'] >= $limit) {
            $next_batch = $batch + 1;
            $redirect_url = add_query_arg(array(
                'page' => 'twork-rewards-users',
                'twork_activity_init' => 'processing',
                'batch' => $next_batch,
                'processed' => ($batch - 1) * $limit + $stats['processed'],
                'updated' => isset($_GET['updated']) ? intval($_GET['updated']) + $stats['updated'] : $stats['updated']
            ), admin_url('admin.php'));

            // Auto-redirect to next batch
            echo '<script>
                setTimeout(function() {
                    window.location.href = "' . esc_js($redirect_url) . '";
                }, 100);
            </script>';
            echo '<p>' . sprintf(
                esc_html__('Processing batch %d... Processed: %d users, Updated: %d users', 'twork-rewards'),
                $batch,
                $stats['processed'],
                $stats['updated']
            ) . '</p>';
            echo '<p>' . esc_html__('Please wait, redirecting to next batch...', 'twork-rewards') . '</p>';
            exit;
        } else {
            // All done
            $total_updated = isset($_GET['updated']) ? intval($_GET['updated']) + $stats['updated'] : $stats['updated'];
            $total_processed = ($batch - 1) * $limit + $stats['processed'];

            wp_safe_redirect(add_query_arg(array(
                'page' => 'twork-rewards-users',
                'twork_activity_init' => 'success',
                'processed' => $total_processed,
                'updated' => $total_updated
            ), admin_url('admin.php')));
            exit;
        }
    }

    /**
     * Get user activity status - Professional Enhanced Version
     * Determines if user is Active or Inactive based on multiple criteria and configurable thresholds
     *
     * Criteria considered:
     * 1. Last activity timestamp (REST API calls, app usage)
     * 2. Last login timestamp (WordPress login)
     * 3. Recent orders (WooCommerce orders)
     * 4. Recent transactions (Rewards/Points transactions)
     * 5. User registration date (for new users)
     *
     * @param int $user_id User ID
     * @param array $options Optional configuration:
     *   - 'include_orders' (bool): Check recent orders (default: true)
     *   - 'include_transactions' (bool): Check recent transactions (default: true)
     *   - 'order_days' (int): Days to look back for orders (default: 30)
     *   - 'transaction_days' (int): Days to look back for transactions (default: 30)
     * @return array Array with comprehensive activity data
     */
    public function get_user_activity_status($user_id, $options = array())
    {
        if (!is_numeric($user_id) || $user_id <= 0) {
            return array(
                'status' => 'unknown',
                'last_activity' => null,
                'last_login' => null,
                'last_order' => null,
                'last_transaction' => null,
                'days_inactive' => null,
                'is_active' => false,
                'activity_score' => 0,
                'criteria' => array()
            );
        }

        $user_id = (int) $user_id;

        // Default options
        $defaults = array(
            'include_orders' => true,
            'include_transactions' => true,
            'order_days' => 30,
            'transaction_days' => 30,
        );
        $options = wp_parse_args($options, $defaults);

        // Get configurable inactivity threshold (default: 30 days)
        $inactivity_threshold_days = apply_filters('twork_rewards_inactivity_threshold_days', 30);
        $threshold_seconds = $inactivity_threshold_days * DAY_IN_SECONDS;

        // Get last activity and login times
        $last_activity = get_user_meta($user_id, 'twork_last_activity', true);
        $last_login = get_user_meta($user_id, 'twork_last_login', true);

        // Get recent order activity (if WooCommerce is active)
        $last_order = null;
        if ($options['include_orders'] && class_exists('WooCommerce')) {
            $orders = wc_get_orders(array(
                'customer_id' => $user_id,
                'limit' => 1,
                'orderby' => 'date',
                'order' => 'DESC',
                'date_created' => '>' . (time() - ($options['order_days'] * DAY_IN_SECONDS)),
            ));
            if (!empty($orders)) {
                $last_order = $orders[0]->get_date_created();
                if ($last_order) {
                    $last_order = $last_order->getTimestamp();
                }
            }
        }

        // Get recent transaction activity
        $last_transaction = null;
        if ($options['include_transactions']) {
            global $wpdb;
            $table = $this->table_name();
            $transaction_days_ago = time() - ($options['transaction_days'] * DAY_IN_SECONDS);
            $last_transaction_time = $wpdb->get_var($wpdb->prepare(
                "SELECT UNIX_TIMESTAMP(created_at) 
                FROM $table 
                WHERE user_id = %d 
                AND deleted_at IS NULL
                AND UNIX_TIMESTAMP(created_at) > %d
                ORDER BY created_at DESC 
                LIMIT 1",
                $user_id,
                $transaction_days_ago
            ));
            if ($last_transaction_time) {
                $last_transaction = (int) $last_transaction_time;
            }
        }

        // Collect all activity timestamps
        $activity_timestamps = array();
        $criteria = array();

        if (!empty($last_activity) && is_numeric($last_activity)) {
            $activity_timestamps[] = (int) $last_activity;
            $criteria['last_activity'] = (int) $last_activity;
        }
        if (!empty($last_login) && is_numeric($last_login)) {
            $activity_timestamps[] = (int) $last_login;
            $criteria['last_login'] = (int) $last_login;
        }
        if (!empty($last_order) && is_numeric($last_order)) {
            $activity_timestamps[] = (int) $last_order;
            $criteria['last_order'] = (int) $last_order;
        }
        if (!empty($last_transaction) && is_numeric($last_transaction)) {
            $activity_timestamps[] = (int) $last_transaction;
            $criteria['last_transaction'] = (int) $last_transaction;
        }

        // Get most recent activity
        $most_recent = !empty($activity_timestamps) ? max($activity_timestamps) : 0;

        // Calculate activity score (0-100)
        // Higher score = more recent and diverse activity
        $activity_score = 0;
        $current_time = time();

        if ($most_recent > 0) {
            $seconds_inactive = $current_time - $most_recent;
            $days_inactive = floor($seconds_inactive / DAY_IN_SECONDS);

            // Base score from recency (more recent = higher score)
            if ($days_inactive == 0) {
                $activity_score = 100;  // Active today
            } elseif ($days_inactive <= 7) {
                $activity_score = 80 - ($days_inactive * 5);  // Active this week
            } elseif ($days_inactive <= 30) {
                $activity_score = 45 - (($days_inactive - 7) * 1.5);  // Active this month
            } else {
                $activity_score = max(0, 30 - ($days_inactive - 30));  // Older activity
            }

            // Bonus points for multiple activity types
            $activity_types_count = count($criteria);
            if ($activity_types_count >= 3) {
                $activity_score += 10;  // Multiple activity types
            } elseif ($activity_types_count == 2) {
                $activity_score += 5;
            }

            // Determine active status
            $is_active = ($seconds_inactive <= $threshold_seconds);
        } else {
            // No activity recorded - consider inactive
            $is_active = false;
            $days_inactive = null;

            // Try to get user registration date as fallback
            $user = get_userdata($user_id);
            if ($user && isset($user->user_registered)) {
                $registered_time = strtotime($user->user_registered);
                $days_inactive = floor(($current_time - $registered_time) / DAY_IN_SECONDS);

                // New users (registered within threshold) get minimal score
                if ($days_inactive <= $inactivity_threshold_days) {
                    $activity_score = 10;  // New user, no activity yet
                }
            }
        }

        // Normalize activity score (0-100)
        $activity_score = max(0, min(100, round($activity_score)));

        return array(
            'status' => $is_active ? 'active' : 'inactive',
            'last_activity' => !empty($last_activity) ? (int) $last_activity : null,
            'last_login' => !empty($last_login) ? (int) $last_login : null,
            'last_order' => $last_order,
            'last_transaction' => $last_transaction,
            'most_recent_activity' => $most_recent > 0 ? $most_recent : null,
            'days_inactive' => $days_inactive,
            'is_active' => $is_active,
            'activity_score' => $activity_score,
            'threshold_days' => $inactivity_threshold_days,
            'criteria' => $criteria,
            'activity_types_count' => count($criteria)
        );
    }

    /**
     * Check if user is active
     * Simple boolean check
     *
     * @param int $user_id User ID
     * @return bool True if active, false if inactive
     */
    public function is_user_active($user_id)
    {
        $status = $this->get_user_activity_status($user_id);
        return $status['is_active'];
    }

    /**
     * Get formatted activity information for display
     *
     * @param int $user_id User ID
     * @return array Formatted activity data
     */

    /**
     * Get country name from country code
     * Professional: Converts 2-letter country codes to full country names
     *
     * @param string $country_code 2-letter country code (e.g., 'MM', 'TH', 'VN')
     * @return string Country name or empty string if not found
     */
    private function get_country_name_from_code($country_code)
    {
        if (empty($country_code) || strlen($country_code) !== 2) {
            return '';
        }

        $country_code = strtoupper($country_code);

        // Try to get from WooCommerce countries first
        if (function_exists('WC') && class_exists('WooCommerce')) {
            $countries = WC()->countries->get_countries();
            if (isset($countries[$country_code])) {
                return $countries[$country_code];
            }
        }

        // Fallback: Manual mapping for common countries
        $country_map = array(
            'MM' => 'Myanmar',
            'TH' => 'Thailand',
            'VN' => 'Vietnam',
            'SG' => 'Singapore',
            'MY' => 'Malaysia',
            'ID' => 'Indonesia',
            'PH' => 'Philippines',
            'KH' => 'Cambodia',
            'LA' => 'Laos',
            'CN' => 'China',
            'IN' => 'India',
            'US' => 'United States',
            'GB' => 'United Kingdom',
            'JP' => 'Japan',
            'KR' => 'South Korea',
            'AU' => 'Australia',
            'NZ' => 'New Zealand',
            'CA' => 'Canada',
            'DE' => 'Germany',
            'FR' => 'France',
            'IT' => 'Italy',
            'ES' => 'Spain',
            'NL' => 'Netherlands',
            'BE' => 'Belgium',
            'CH' => 'Switzerland',
            'AT' => 'Austria',
            'SE' => 'Sweden',
            'NO' => 'Norway',
            'DK' => 'Denmark',
            'FI' => 'Finland',
        );

        return isset($country_map[$country_code]) ? $country_map[$country_code] : '';
    }

    /**
     * Get configured timezone for date/time display
     *
     * @return string Timezone identifier (defaults to 'Asia/Yangon' for Myanmar)
     */
    private function get_display_timezone()
    {
        $timezone = get_option('twork_rewards_timezone', 'Asia/Yangon');

        // Validate timezone
        if (empty($timezone) || !in_array($timezone, timezone_identifiers_list(), true)) {
            $timezone = 'Asia/Yangon';  // Default to Myanmar timezone
        }

        return $timezone;
    }

    /**
     * Enhanced user lookup with fallback methods
     * Tries multiple methods to find user data even if WordPress user object is not available
     *
     * @param int $user_id User ID to lookup
     * @return object|null User object with ID, user_login, user_email, display_name properties, or null if not found
     */
    private function get_user_data_enhanced($user_id)
    {
        $user_id = absint($user_id);

        if ($user_id <= 0) {
            return null;
        }

        // Method 1: Try WordPress get_user_by (most reliable)
        $user = get_user_by('ID', $user_id);
        if ($user && isset($user->ID)) {
            return $user;
        }

        // Method 2: Try get_userdata (WordPress function)
        $user = get_userdata($user_id);
        if ($user && isset($user->ID)) {
            return $user;
        }

        // Method 3: Direct database query as fallback
        global $wpdb;
        $user_data = $wpdb->get_row($wpdb->prepare(
            "SELECT ID, user_login, user_email, display_name 
             FROM {$wpdb->users} 
             WHERE ID = %d 
             LIMIT 1",
            $user_id
        ));

        if ($user_data && isset($user_data->ID)) {
            // Create a minimal user object compatible with WordPress user object
            $user = new stdClass();
            $user->ID = (int) $user_data->ID;
            $user->user_login = $user_data->user_login;
            $user->user_email = $user_data->user_email;
            $user->display_name = !empty($user_data->display_name) ? $user_data->display_name : $user_data->user_login;

            // Try to get full user meta for display_name if empty
            if (empty($user->display_name)) {
                $display_name = get_user_meta($user_id, 'display_name', true);
                if (!empty($display_name)) {
                    $user->display_name = $display_name;
                } else {
                    $user->display_name = $user_data->user_login;
                }
            }

            return $user;
        }

        // User not found in any method
        return null;
    }

    /**
     * Format timestamp to Myanmar timezone (Asia/Yangon, UTC+6:30)
     * Professional: Handles both Unix timestamps and datetime strings
     * Uses configurable timezone from settings, defaults to Myanmar timezone
     *
     * @param int|string $timestamp Unix timestamp or datetime string (e.g., '2024-01-01 12:00:00')
     * @param string $format Date format (optional, defaults to WordPress date/time format)
     * @return string|null Formatted date in configured timezone, or null if invalid
     */
    private function format_myanmar_time($timestamp, $format = null)
    {
        if (empty($timestamp)) {
            return null;
        }

        // Professional: Convert datetime string to Unix timestamp if needed
        if (!is_numeric($timestamp)) {
            $timestamp = strtotime($timestamp);
            if ($timestamp === false) {
                return null;  // Invalid datetime string
            }
        }

        // Ensure timestamp is integer
        $timestamp = intval($timestamp);

        if ($format === null) {
            $format = get_option('date_format') . ' ' . get_option('time_format');
        }

        try {
            // Get configured timezone (defaults to Myanmar)
            $timezone = $this->get_display_timezone();

            // Create DateTime object with UTC timezone first
            $date = new DateTime('@' . $timestamp);
            $date->setTimezone(new DateTimeZone($timezone));

            return $date->format($format);
        } catch (Exception $e) {
            // Fallback to WordPress date_i18n if timezone conversion fails
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: format_myanmar_time error: ' . $e->getMessage());
            }
            return date_i18n($format, $timestamp);
        }
    }

    public function get_formatted_user_activity($user_id)
    {
        $status = $this->get_user_activity_status($user_id);

        $formatted = array(
            'status' => $status['status'],
            'status_label' => $status['is_active'] ? __('Active', 'twork-rewards') : __('Inactive', 'twork-rewards'),
            'is_active' => $status['is_active'],
            'last_activity_formatted' => null,
            'last_login_formatted' => null,
            'days_inactive_formatted' => null
        );

        if (!empty($status['last_activity'])) {
            $formatted['last_activity_formatted'] = $this->format_myanmar_time($status['last_activity']);
        }

        if (!empty($status['last_login'])) {
            $formatted['last_login_formatted'] = $this->format_myanmar_time($status['last_login']);
        }

        if ($status['days_inactive'] !== null) {
            if ($status['days_inactive'] == 0) {
                $formatted['days_inactive_formatted'] = __('Today', 'twork-rewards');
            } elseif ($status['days_inactive'] == 1) {
                $formatted['days_inactive_formatted'] = __('1 day ago', 'twork-rewards');
            } else {
                $formatted['days_inactive_formatted'] = sprintf(
                    __('%d days ago', 'twork-rewards'),
                    $status['days_inactive']
                );
            }
        } else {
            $formatted['days_inactive_formatted'] = __('Never', 'twork-rewards');
        }

        return $formatted;
    }

    /**
     * Get activity statistics for all users
     * Professional analytics method for dashboard display
     *
     * @return array Statistics including active/inactive counts and rates
     */
    public function get_activity_statistics()
    {
        global $wpdb;

        // Get inactivity threshold
        $inactivity_threshold_days = apply_filters('twork_rewards_inactivity_threshold_days', 30);
        $threshold_timestamp = time() - ($inactivity_threshold_days * DAY_IN_SECONDS);

        // Get total user count
        $total_count = $wpdb->get_var("SELECT COUNT(*) FROM {$wpdb->users}");

        // Get active users count (users with activity within threshold)
        $active_count = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(DISTINCT u.ID) 
            FROM {$wpdb->users} u
            INNER JOIN {$wpdb->usermeta} um1 ON u.ID = um1.user_id 
            WHERE (um1.meta_key = 'twork_last_activity' AND CAST(um1.meta_value AS UNSIGNED) >= %d)
            OR (um1.meta_key = 'twork_last_login' AND CAST(um1.meta_value AS UNSIGNED) >= %d)",
            $threshold_timestamp,
            $threshold_timestamp
        ));

        // Inactive users = total - active
        $inactive_count = max(0, $total_count - $active_count);

        // Calculate active rate
        $active_rate = $total_count > 0 ? ($active_count / $total_count) * 100 : 0;

        return array(
            'total_count' => (int) $total_count,
            'active_count' => (int) $active_count,
            'inactive_count' => (int) $inactive_count,
            'active_rate' => round($active_rate, 2),
            'threshold_days' => $inactivity_threshold_days
        );
    }

    /**
     * Get users by activity status efficiently
     * Professional method for bulk operations
     *
     * @param string $status 'active' or 'inactive'
     * @param array $args Additional WP_User_Query arguments
     * @return array Array of user IDs
     */
    public function get_users_by_activity_status($status = 'active', $args = array())
    {
        $inactivity_threshold_days = apply_filters('twork_rewards_inactivity_threshold_days', 30);
        $threshold_timestamp = time() - ($inactivity_threshold_days * DAY_IN_SECONDS);

        $defaults = array(
            'number' => -1,  // Get all users
            'fields' => 'ID',  // Only return IDs for efficiency
        );

        $args = wp_parse_args($args, $defaults);

        // Add meta_query for activity filtering
        if ($status === 'active') {
            $args['meta_query'] = array(
                'relation' => 'OR',
                array(
                    'key' => 'twork_last_activity',
                    'value' => $threshold_timestamp,
                    'compare' => '>=',
                    'type' => 'NUMERIC',
                ),
                array(
                    'key' => 'twork_last_login',
                    'value' => $threshold_timestamp,
                    'compare' => '>=',
                    'type' => 'NUMERIC',
                ),
            );
        } else {
            // Inactive: no activity or activity older than threshold
            $args['meta_query'] = array(
                'relation' => 'OR',
                array(
                    'key' => 'twork_last_activity',
                    'value' => $threshold_timestamp,
                    'compare' => '<',
                    'type' => 'NUMERIC',
                ),
                array(
                    'key' => 'twork_last_activity',
                    'compare' => 'NOT EXISTS',
                ),
            );
        }

        $user_query = new WP_User_Query($args);
        return $user_query->get_results();
    }

    /**
     * PROFESSIONAL FIX: Create engagement point transaction in points system
     * This ensures points are properly recorded in twork_point_transactions table
     * for balance calculations and transaction history
     *
     * @param int $user_id User ID
     * @param int $points Points to award
     * @param int $item_id Engagement item ID
     * @param string $item_type Type of engagement (quiz/poll)
     * @param string $item_title Title of the engagement item
     * @return int|false Transaction ID or false on failure
     */
    private function create_engagement_point_transaction($user_id, $points, $item_id, $item_type, $item_title)
    {
        global $wpdb;

        // Check if points system table exists
        $table_name = $wpdb->prefix . 'twork_point_transactions';
        $table_exists = $wpdb->get_var($wpdb->prepare(
            'SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = %s AND table_name = %s',
            DB_NAME,
            $table_name
        ));

        if (!$table_exists) {
            // Points system table doesn't exist, log warning but don't fail
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf(
                    'T-Work Rewards: Points system table not found. Engagement points awarded but not recorded in transaction table. User ID: %d, Points: %d, Item ID: %d',
                    $user_id,
                    $points,
                    $item_id
                ));
            }
            return false;
        }

        // Create unique order_id to prevent duplicates
        // Format: engagement:{type}:{item_id}:{user_id}:{timestamp}
        $order_id = sprintf('engagement:%s:%d:%d:%d', $item_type, $item_id, $user_id, time());

        // Check for duplicate transaction (same user, item, and type within last 5 minutes)
        $five_minutes_ago = date('Y-m-d H:i:s', strtotime('-5 minutes'));
        $existing = $wpdb->get_var($wpdb->prepare(
            "SELECT id FROM $table_name 
             WHERE user_id = %d 
             AND order_id LIKE %s 
             AND type = 'earn'
             AND created_at > %s
             LIMIT 1",
            $user_id,
            'engagement:' . $item_type . ':' . $item_id . ':%',
            $five_minutes_ago
        ));

        if ($existing) {
            // Duplicate transaction prevented
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf(
                    'T-Work Rewards: Duplicate engagement transaction prevented. User ID: %d, Item ID: %d, Existing Transaction ID: %d',
                    $user_id,
                    $item_id,
                    $existing
                ));
            }
            return intval($existing);
        }

        // Create description based on item type
        $description = sprintf(
            'Points earned from %s: %s',
            $item_type === 'quiz' ? 'Quiz' : ($item_type === 'poll' ? 'Poll' : 'Engagement'),
            !empty($item_title) ? $item_title : "Activity #$item_id"
        );

        // Insert transaction into points system table
        $result = $wpdb->insert(
            $table_name,
            array(
                'user_id' => $user_id,
                'type' => 'earn',  // Use 'earn' type for engagement points
                'points' => $points,
                'description' => $description,
                'order_id' => $order_id,
                'expires_at' => null,  // Engagement points don't expire by default
                'created_at' => current_time('mysql'),
                'status' => 'approved',  // Engagement points are auto-approved
            ),
            array('%d', '%s', '%d', '%s', '%s', '%s', '%s', '%s')
        );

        if ($result === false) {
            // Log error but don't fail the entire process
            $error_msg = $wpdb->last_error ?: 'Unknown database error';
            error_log(sprintf(
                'T-Work Rewards: Failed to create engagement point transaction. User ID: %d, Points: %d, Item ID: %d, Error: %s',
                $user_id,
                $points,
                $item_id,
                $error_msg
            ));
            return false;
        }

        $transaction_id = $wpdb->insert_id;

        // Invalidate balance cache for the user
        delete_user_meta($user_id, 'points_balance_cache');
        delete_user_meta($user_id, 'points_balance_cache_time');

        // Professional logging
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log(sprintf(
                'T-Work Rewards: Engagement point transaction created. Transaction ID: %d, User ID: %d, Points: %d, Item ID: %d, Type: %s',
                $transaction_id,
                $user_id,
                $points,
                $item_id,
                $item_type
            ));
        }

        return $transaction_id;
    }

    /**
     * PROFESSIONAL FIX: Create exchange/redeem point transaction in points system
     * This ensures points are properly deducted in twork_point_transactions table
     * for balance calculations and transaction history
     *
     * @param int $user_id User ID
     * @param int $points Points to deduct (positive number)
     * @param int $request_id Exchange request ID
     * @param string $phone Phone number for reference
     * @return int|false Transaction ID or false on failure
     */
    private function create_exchange_point_transaction($user_id, $points, $request_id, $phone = '')
    {
        global $wpdb;

        // Check if points system table exists
        $table_name = $wpdb->prefix . 'twork_point_transactions';
        $table_exists = $wpdb->get_var($wpdb->prepare(
            'SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = %s AND table_name = %s',
            DB_NAME,
            $table_name
        ));

        if (!$table_exists) {
            // Points system table doesn't exist, log warning but don't fail
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf(
                    'T-Work Rewards: Points system table not found. Exchange points deducted but not recorded in transaction table. User ID: %d, Points: %d, Request ID: %d',
                    $user_id,
                    $points,
                    $request_id
                ));
            }
            return false;
        }

        // Create unique order_id to prevent duplicates
        // Format: exchange:{request_id}:{user_id}:{timestamp}
        $order_id = sprintf('exchange:%d:%d:%d', $request_id, $user_id, time());

        // Check for duplicate transaction (same user, request within last 5 minutes)
        $five_minutes_ago = date('Y-m-d H:i:s', strtotime('-5 minutes'));
        $existing = $wpdb->get_var($wpdb->prepare(
            "SELECT id FROM $table_name 
             WHERE user_id = %d 
             AND order_id LIKE %s 
             AND type = 'redeem'
             AND created_at > %s
             LIMIT 1",
            $user_id,
            'exchange:' . $request_id . ':%',
            $five_minutes_ago
        ));

        if ($existing) {
            // Duplicate transaction prevented
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf(
                    'T-Work Rewards: Duplicate exchange transaction prevented. User ID: %d, Request ID: %d, Existing Transaction ID: %d',
                    $user_id,
                    $request_id,
                    $existing
                ));
            }
            return intval($existing);
        }

        // Create description
        $description = sprintf(
            'Points exchanged for reward (Request #%d%s)',
            $request_id,
            !empty($phone) ? ', Phone: ' . $phone : ''
        );

        // Insert transaction into points system table
        // Use 'redeem' type for point deductions
        $result = $wpdb->insert(
            $table_name,
            array(
                'user_id' => $user_id,
                'type' => 'redeem',  // Use 'redeem' type for exchange/redemption
                'points' => $points,
                'description' => $description,
                'order_id' => $order_id,
                'expires_at' => null,  // Redeem transactions don't expire
                'created_at' => current_time('mysql'),
                'status' => 'pending',  // Exchange requests start as pending until admin approves
            ),
            array('%d', '%s', '%d', '%s', '%s', '%s', '%s', '%s')
        );

        if ($result === false) {
            // Log error but don't fail the entire process
            $error_msg = $wpdb->last_error ?: 'Unknown database error';
            error_log(sprintf(
                'T-Work Rewards: Failed to create exchange point transaction. User ID: %d, Points: %d, Request ID: %d, Error: %s',
                $user_id,
                $points,
                $request_id,
                $error_msg
            ));
            return false;
        }

        $transaction_id = $wpdb->insert_id;

        // Invalidate balance cache for the user
        delete_user_meta($user_id, 'points_balance_cache');
        delete_user_meta($user_id, 'points_balance_cache_time');

        // Professional logging
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log(sprintf(
                'T-Work Rewards: Exchange point transaction created. Transaction ID: %d, User ID: %d, Points: %d, Request ID: %d',
                $transaction_id,
                $user_id,
                $points,
                $request_id
            ));
        }

        return $transaction_id;
    }

    /**
     * PROFESSIONAL FIX: Calculate actual deducted points from transactions for an exchange request
     * This ensures we refund exactly what was deducted, not what the request says
     *
     * CRITICAL: This function prevents double refunds by:
     * 1. Finding all redeem transactions for the request
     * 2. Filtering out rejected transactions (they don't affect balance)
     * 3. Using the MAXIMUM single transaction amount (not sum) to prevent duplicate counting
     * 4. Validating against request points_value as safety check
     *
     * @param int $user_id User ID
     * @param int $request_id Exchange request ID
     * @return float|false Total deducted points or false on error
     */
    private function calculate_actual_deducted_points($user_id, $request_id)
    {
        global $wpdb;

        // Check if points system table exists
        $table_name = $wpdb->prefix . 'twork_point_transactions';
        $table_exists = $wpdb->get_var($wpdb->prepare(
            'SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = %s AND table_name = %s',
            DB_NAME,
            $table_name
        ));

        if (!$table_exists) {
            return false;
        }

        // Find all redeem transactions for this exchange request
        // These are the transactions that actually deducted points
        $order_id_pattern = 'exchange:' . $request_id . ':%';
        $transactions = $wpdb->get_results($wpdb->prepare(
            "SELECT id, points, status, type, created_at, order_id 
             FROM $table_name 
             WHERE user_id = %d 
             AND order_id LIKE %s 
             AND type = 'redeem'
             ORDER BY created_at ASC",
            $user_id,
            $order_id_pattern
        ), ARRAY_A);

        if (empty($transactions)) {
            // No transactions found - might be using legacy system
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf(
                    'T-Work Rewards: No redeem transactions found for exchange request. User ID: %d, Request ID: %d',
                    $user_id,
                    $request_id
                ));
            }
            return false;
        }

        // CRITICAL FIX: Filter out rejected transactions (they don't affect balance)
        // Only count transactions that actually affected the balance (pending or approved)
        $valid_transactions = array();
        foreach ($transactions as $txn) {
            $txn_status = $txn['status'];

            // Only count transactions that actually deducted points
            // Pending and approved redeem transactions both deduct points
            // Rejected transactions are ignored (they don't affect balance)
            if (in_array($txn_status, array('pending', 'approved'), true)) {
                $valid_transactions[] = $txn;
            }
        }

        if (empty($valid_transactions)) {
            // All transactions are rejected - nothing was actually deducted
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf(
                    'T-Work Rewards: All redeem transactions are rejected for exchange request. User ID: %d, Request ID: %d, Total Transactions: %d',
                    $user_id,
                    $request_id,
                    count($transactions)
                ));
            }
            return 0.0;  // No points were deducted
        }

        // CRITICAL FIX: Prevent double counting by using the MAXIMUM transaction amount
        // If there are duplicates, we only count the largest one (most likely the correct one)
        // This prevents refunding twice if duplicate transactions exist
        $max_points = 0.0;
        $total_points = 0.0;
        $transaction_details = array();

        foreach ($valid_transactions as $txn) {
            $txn_points = (float) $txn['points'];
            $total_points += $txn_points;
            if ($txn_points > $max_points) {
                $max_points = $txn_points;
            }
            $transaction_details[] = sprintf(
                'ID:%d, Points:%s, Status:%s, OrderID:%s',
                $txn['id'],
                $txn_points,
                $txn['status'],
                $txn['order_id']
            );
        }

        // CRITICAL FIX: If we have multiple transactions, this indicates duplicates
        // In this case, we MUST use the request amount as single source of truth
        // We cannot trust the transaction amounts if duplicates exist
        $unique_amounts = array_unique(array_map(function ($txn) {
            return (float) $txn['points'];
        }, $valid_transactions));

        // Get request points_value to use as single source of truth
        global $wpdb;
        $exchange_table = $this->exchange_requests_table_name();
        $request_data = $wpdb->get_row($wpdb->prepare(
            "SELECT points_value FROM $exchange_table WHERE id = %d",
            $request_id
        ), ARRAY_A);
        $request_points_value = $request_data ? (float) $request_data['points_value'] : 0;

        // CRITICAL PROFESSIONAL FIX: Always use request amount as the ABSOLUTE source of truth
        // This prevents any possibility of double counting or summing duplicate transactions
        // The request amount is what the user actually requested, and that's what should be refunded
        if ($request_points_value > 0) {
            // Use request amount as absolute source of truth (prevents double refunds)
            $total_deducted = $request_points_value;
            
            // Log if we detect discrepancies (for debugging and monitoring)
            if (count($valid_transactions) > 1) {
                error_log(sprintf(
                    'T-Work Rewards: CRITICAL - Multiple redeem transactions found for request. Using request points_value (%s) as absolute source of truth for refund. User ID: %d, Request ID: %d, Transaction Count: %d, Total Sum: %s, Max Amount: %s, Transactions: %s',
                    $request_points_value,
                    $user_id,
                    $request_id,
                    count($valid_transactions),
                    $total_points,
                    $max_points,
                    implode('; ', $transaction_details)
                ));
            } else if (count($valid_transactions) === 1) {
                // Single transaction - validate it matches request (but still use request amount)
                if (abs($max_points - $request_points_value) > ($request_points_value * 0.1)) {
                    error_log(sprintf(
                        'T-Work Rewards: WARNING - Single redeem transaction amount (%s) differs from request amount (%s) by more than 10%%. Using request amount for refund to prevent errors. User ID: %d, Request ID: %d, Transaction: %s',
                        $max_points,
                        $request_points_value,
                        $user_id,
                        $request_id,
                        implode('; ', $transaction_details)
                    ));
                }
            }
        } else {
            // Fallback: If request amount is not available, use max transaction amount
            // But log this as a critical issue since request amount should always be available
            error_log(sprintf(
                'T-Work Rewards: CRITICAL ERROR - Request points_value not found. Using max transaction amount as fallback. User ID: %d, Request ID: %d, Max Amount: %s, Total Sum: %s',
                $user_id,
                $request_id,
                $max_points,
                $total_points
            ));
            $total_deducted = $max_points;
            
            // ABSOLUTE SAFETY: If we're using fallback and there are multiple transactions,
            // we MUST NOT use the sum - use the max to prevent double refund
            if (count($valid_transactions) > 1 && $total_points > $max_points) {
                error_log(sprintf(
                    'T-Work Rewards: CRITICAL SAFETY - Multiple transactions detected but request amount unavailable. Using max amount (%s) instead of sum (%s) to prevent double refund. User ID: %d, Request ID: %d',
                    $max_points,
                    $total_points,
                    $user_id,
                    $request_id
                ));
                $total_deducted = $max_points; // Use max, not sum
            }
        }

        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log(sprintf(
                'T-Work Rewards: Calculated actual deducted points. User ID: %d, Request ID: %d, Total Deducted: %s, Valid Transaction Count: %d, Total Transaction Count: %d, Transactions: %s',
                $user_id,
                $request_id,
                $total_deducted,
                count($valid_transactions),
                count($transactions),
                implode('; ', $transaction_details)
            ));
        }

        return $total_deducted;
    }

    /**
     * PROFESSIONAL FIX: Update exchange point transaction status in points system
     * This ensures transaction status in twork_point_transactions matches exchange request status
     *
     * @param int $user_id User ID
     * @param int $request_id Exchange request ID
     * @param string $status New status (approved/rejected)
     * @return bool Success status
     */
    private function update_exchange_point_transaction_status($user_id, $request_id, $status)
    {
        global $wpdb;

        // Check if points system table exists
        $table_name = $wpdb->prefix . 'twork_point_transactions';
        $table_exists = $wpdb->get_var($wpdb->prepare(
            'SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = %s AND table_name = %s',
            DB_NAME,
            $table_name
        ));

        if (!$table_exists) {
            return false;
        }

        // Find the transaction by order_id pattern
        $order_id_pattern = 'exchange:' . $request_id . ':%';
        $transaction = $wpdb->get_row($wpdb->prepare(
            "SELECT id, status FROM $table_name 
             WHERE user_id = %d 
             AND order_id LIKE %s 
             AND type = 'redeem'
             ORDER BY created_at DESC
             LIMIT 1",
            $user_id,
            $order_id_pattern
        ));

        if (!$transaction) {
            // Transaction not found, log but don't fail
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf(
                    'T-Work Rewards: Exchange point transaction not found for status update. User ID: %d, Request ID: %d',
                    $user_id,
                    $request_id
                ));
            }
            return false;
        }

        // Map exchange request status to transaction status
        // approved -> approved, rejected -> rejected, pending -> pending
        $transaction_status = $status;  // Statuses match

        // Only update if status actually changed
        if ($transaction->status === $transaction_status) {
            return true;  // Already correct status
        }

        // Update transaction status
        $updated = $wpdb->update(
            $table_name,
            array('status' => $transaction_status),
            array('id' => $transaction->id),
            array('%s'),
            array('%d')
        );

        if ($updated === false) {
            $error_msg = $wpdb->last_error ?: 'Unknown database error';
            error_log(sprintf(
                'T-Work Rewards: Failed to update exchange point transaction status. Transaction ID: %d, New Status: %s, Error: %s',
                $transaction->id,
                $transaction_status,
                $error_msg
            ));
            return false;
        }

        // Invalidate balance cache
        delete_user_meta($user_id, 'points_balance_cache');
        delete_user_meta($user_id, 'points_balance_cache_time');

        // Professional logging
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log(sprintf(
                'T-Work Rewards: Exchange point transaction status updated. Transaction ID: %d, User ID: %d, Request ID: %d, Old Status: %s, New Status: %s',
                $transaction->id,
                $user_id,
                $request_id,
                $transaction->status,
                $transaction_status
            ));
        }

        return true;
    }

    /**
     * PROFESSIONAL FIX: Refund points when exchange request is rejected
     * This ensures users get their points back if their exchange request is rejected
     *
     * @param int $user_id User ID
     * @param float $points Points to refund
     * @param int $request_id Exchange request ID
     * @param string $reason Reason for refund
     * @return bool Success status
     */
    private function refund_exchange_points($user_id, $points, $request_id, $reason = '')
    {
        if ($points <= 0) {
            error_log(sprintf(
                'T-Work Rewards: Cannot refund exchange points - invalid points amount. User ID: %d, Points: %s, Request ID: %d',
                $user_id,
                $points,
                $request_id
            ));
            return false;
        }

        // CRITICAL PROFESSIONAL FIX: Validate refund amount against request amount
        // This is the FINAL safety check to prevent double refunds
        // Get the request amount from database as absolute source of truth
        global $wpdb;
        $exchange_table = $this->exchange_requests_table_name();
        $request_data = $wpdb->get_row($wpdb->prepare(
            "SELECT points_value FROM $exchange_table WHERE id = %d",
            $request_id
        ), ARRAY_A);
        
        if ($request_data && !empty($request_data['points_value'])) {
            $request_points_value = (float) $request_data['points_value'];
            
            // ABSOLUTE SAFETY: Never refund more than the request amount
            // If the passed points exceed the request amount, cap it at request amount
            if ($points > $request_points_value) {
                error_log(sprintf(
                    'T-Work Rewards: CRITICAL SAFETY - refund_exchange_points: Refund amount (%s) exceeds request amount (%s). Capping at request amount to prevent double refund. User ID: %d, Request ID: %d',
                    $points,
                    $request_points_value,
                    $user_id,
                    $request_id
                ));
                $points = $request_points_value; // Cap at request amount
            }
        }

        // PROFESSIONAL FIX: Check if a refund transaction already exists for this request
        // This prevents duplicate refunds if the function is called multiple times
        global $wpdb;
        $table_name = $wpdb->prefix . 'twork_point_transactions';
        $table_exists = $wpdb->get_var($wpdb->prepare(
            'SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = %s AND table_name = %s',
            DB_NAME,
            $table_name
        ));

        if (!$table_exists) {
            // CRITICAL FIX: If points system table doesn't exist, we need to manually update user meta
            // This ensures backward compatibility and prevents silent failures
            error_log(sprintf(
                'T-Work Rewards: Points system table not found. Manually updating user meta for refund. User ID: %d, Points: %s, Request ID: %d',
                $user_id,
                $points,
                $request_id
            ));

            // Manually update my_points and points_balance
            $existing_points_raw = get_user_meta($user_id, 'my_points', true);
            $existing_points = ($existing_points_raw === '' || $existing_points_raw === false || $existing_points_raw === null)
                ? 0.0
                : (is_numeric($existing_points_raw) ? (float) $existing_points_raw : 0.0);

            $new_points = max(0.0, $existing_points + (float) $points);
            $stored_points = (floor($new_points) == $new_points)
                ? (string) (int) $new_points
                : (string) $new_points;

            update_user_meta($user_id, 'my_points', $stored_points);
            update_user_meta($user_id, 'my_point', $stored_points);
            update_user_meta($user_id, 'my_points_updated_at', time());

            // Also update points_balance
            $current_balance = (int) get_user_meta($user_id, 'points_balance', true);
            if ($current_balance === false || $current_balance === '') {
                $current_balance = 0;
            }
            $new_balance = max(0, $current_balance + (int) $points);
            update_user_meta($user_id, 'points_balance', $new_balance);

            error_log(sprintf(
                'T-Work Rewards: Exchange points refunded (manual update). User ID: %d, Points: %s, Request ID: %d, Old Balance: %s, New Balance: %s',
                $user_id,
                $points,
                $request_id,
                $existing_points_raw ?: '0',
                $stored_points
            ));

            return true;
        }

        // CRITICAL PROFESSIONAL FIX: Check for existing refund transaction WITHOUT time limit
        // This prevents ANY duplicate refunds, not just recent ones
        // Use a more specific pattern to match exact refund transactions for this request
        $existing_refund = $wpdb->get_var($wpdb->prepare(
            "SELECT id FROM $table_name 
             WHERE user_id = %d 
             AND order_id LIKE %s 
             AND type = 'refund'
             AND status = 'approved'
             LIMIT 1",
            $user_id,
            'exchange_refund:' . $request_id . ':%'
        ));

        if ($existing_refund) {
            // CRITICAL: Refund already exists - log and skip to prevent double refund
            error_log(sprintf(
                'T-Work Rewards: CRITICAL - Exchange request #%d already has a refund transaction (ID: %d). Skipping duplicate refund to prevent 2x refund. User ID: %d, Request ID: %d',
                $request_id,
                $existing_refund,
                $user_id,
                $request_id
            ));
            // CRITICAL FIX: Even if refund exists, refresh cache to ensure balance is correct
            $this->refresh_user_points_cache($user_id);
            return true;  // Already refunded, return success
        }

        // CRITICAL PROFESSIONAL FIX: Double-check for existing refund BEFORE creating
        // This prevents race conditions where two calls happen simultaneously
        $double_check_refund = $wpdb->get_var($wpdb->prepare(
            "SELECT id FROM $table_name 
             WHERE user_id = %d 
             AND order_id LIKE %s 
             AND type = 'refund'
             AND status = 'approved'
             LIMIT 1",
            $user_id,
            'exchange_refund:' . $request_id . ':%'
        ));

        if ($double_check_refund) {
            error_log(sprintf(
                'T-Work Rewards: CRITICAL - Race condition detected: Refund transaction already exists (ID: %d) before creation. Skipping to prevent 2x refund. User ID: %d, Request ID: %d',
                $double_check_refund,
                $user_id,
                $request_id
            ));
            $this->refresh_user_points_cache($user_id);
            return true;  // Already refunded
        }

        // CRITICAL PROFESSIONAL FIX: Final validation before creating refund transaction
        // Get request amount one more time to ensure we're using the correct value
        $exchange_table = $this->exchange_requests_table_name();
        $final_request_check = $wpdb->get_row($wpdb->prepare(
            "SELECT points_value FROM $exchange_table WHERE id = %d",
            $request_id
        ), ARRAY_A);
        
        if ($final_request_check && !empty($final_request_check['points_value'])) {
            $final_request_points = (float) $final_request_check['points_value'];
            
            // ABSOLUTE FINAL SAFETY: If points parameter doesn't match request, use request amount
            if (abs($points - $final_request_points) > 0.01) {
                error_log(sprintf(
                    'T-Work Rewards: CRITICAL - Points parameter (%s) does not match request amount (%s). Using request amount for refund transaction. User ID: %d, Request ID: %d',
                    $points,
                    $final_request_points,
                    $user_id,
                    $request_id
                ));
                $points = $final_request_points; // Use request amount
            }
        }
        
        // CRITICAL LOG: Log exactly what we're about to refund
        error_log(sprintf(
            'T-Work Rewards: Creating refund transaction. User ID: %d, Request ID: %d, Points to Refund: %s, Request Points Value: %s',
            $user_id,
            $request_id,
            $points,
            $final_request_check && !empty($final_request_check['points_value']) ? $final_request_check['points_value'] : 'N/A'
        ));

        // PROFESSIONAL ARCHITECTURE: Create refund transaction (single source of truth).
        $refund_transaction_id = $this->create_exchange_refund_transaction(
            $user_id,
            (int) round($points), // Use round() to ensure proper integer conversion
            $request_id,
            $reason
        );

        // CRITICAL FIX: Validate that refund transaction was created successfully
        if ($refund_transaction_id === false) {
            error_log(sprintf(
                'T-Work Rewards: CRITICAL ERROR - Failed to create refund transaction. User ID: %d, Points: %s, Request ID: %d, Reason: %s',
                $user_id,
                $points,
                $request_id,
                $reason
            ));
            return false;  // Return false if transaction creation failed
        }

        // CRITICAL VERIFICATION: Verify only ONE refund transaction was created
        $refund_count = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(*) FROM $table_name 
             WHERE user_id = %d 
             AND order_id LIKE %s 
             AND type = 'refund'
             AND status = 'approved'",
            $user_id,
            'exchange_refund:' . $request_id . ':%'
        ));

        if ($refund_count > 1) {
            error_log(sprintf(
                'T-Work Rewards: CRITICAL ERROR - Multiple refund transactions detected (%d) for request. This indicates a serious bug. User ID: %d, Request ID: %d, Refund Transaction ID: %d',
                $refund_count,
                $user_id,
                $request_id,
                $refund_transaction_id
            ));
            // Don't fail, but log the critical error for investigation
        }

        // CRITICAL FIX: Update ALL original redeem transactions status to rejected BEFORE refreshing balance
        // This ensures balance calculation doesn't count them twice
        // Update status for ALL transactions matching this request (in case of duplicates)
        $order_id_pattern = 'exchange:' . $request_id . ':%';
        $status_update_result = $wpdb->query($wpdb->prepare(
            "UPDATE $table_name 
             SET status = 'rejected' 
             WHERE user_id = %d 
             AND order_id LIKE %s 
             AND type = 'redeem' 
             AND status IN ('pending', 'approved')",
            $user_id,
            $order_id_pattern
        ));

        if ($status_update_result === false) {
            error_log(sprintf(
                'T-Work Rewards: WARNING - Failed to update original transaction status to rejected. User ID: %d, Request ID: %d. Refund transaction was created (ID: %d), Error: %s',
                $user_id,
                $request_id,
                $refund_transaction_id,
                $wpdb->last_error ?: 'Unknown error'
            ));
            // Don't fail the refund if status update fails - refund transaction is more important
        } else {
            $updated_count = intval($status_update_result);
            if ($updated_count > 1) {
                error_log(sprintf(
                    'T-Work Rewards: WARNING - Updated %d redeem transactions to rejected status (possible duplicates detected). User ID: %d, Request ID: %d. This may indicate duplicate transactions were created.',
                    $updated_count,
                    $user_id,
                    $request_id
                ));
            } else if ($updated_count === 0) {
                error_log(sprintf(
                    'T-Work Rewards: WARNING - No redeem transactions found to update to rejected status. User ID: %d, Request ID: %d. They may already be rejected or not exist.',
                    $user_id,
                    $request_id
                ));
            }
        }

        // CRITICAL: Refresh cache from transactions to ensure balance is updated.
        // This must happen AFTER updating transaction statuses to 'rejected'
        // so that rejected transactions are not counted in balance calculation
        $updated_balance = $this->refresh_user_points_cache($user_id);

        // CRITICAL FIX: Verify that balance was actually updated
        $final_balance = get_user_meta($user_id, 'my_points', true);
        if (empty($final_balance) || !is_numeric($final_balance)) {
            error_log(sprintf(
                'T-Work Rewards: WARNING - Balance refresh may have failed. User ID: %d, Calculated Balance: %d, Stored my_points: %s',
                $user_id,
                $updated_balance,
                $final_balance ?: 'empty'
            ));
        }

        // Professional logging.
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log(
                sprintf(
                    'T-Work Rewards: Exchange points refunded successfully. User ID: %d, Points: %d, Request ID: %d, Reason: %s, New Balance: %d, Refund Transaction ID: %d',
                    $user_id,
                    $points,
                    $request_id,
                    $reason,
                    $updated_balance,
                    $refund_transaction_id
                )
            );
        }

        return true;
    }

    /**
     * PROFESSIONAL FIX: Create refund transaction in points system for exchange rejection
     * This ensures refunds appear in transaction history
     *
     * @param int $user_id User ID
     * @param int $points Points to refund
     * @param int $request_id Exchange request ID
     * @param string $reason Reason for refund
     * @return int|false Transaction ID or false on failure
     */
    private function create_exchange_refund_transaction($user_id, $points, $request_id, $reason = '')
    {
        global $wpdb;

        // Check if points system table exists
        $table_name = $wpdb->prefix . 'twork_point_transactions';
        $table_exists = $wpdb->get_var($wpdb->prepare(
            'SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = %s AND table_name = %s',
            DB_NAME,
            $table_name
        ));

        if (!$table_exists) {
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf(
                    'T-Work Rewards: Points system table not found. Exchange refund not recorded in transaction table. User ID: %d, Points: %d, Request ID: %d',
                    $user_id,
                    $points,
                    $request_id
                ));
            }
            return false;
        }

        // CRITICAL PROFESSIONAL FIX: Check for ANY existing refund transaction for this request
        // Don't use time limit - if a refund exists for this request, NEVER create another one
        // This is the final safeguard to prevent duplicate refunds
        $existing = $wpdb->get_var($wpdb->prepare(
            "SELECT id FROM $table_name 
             WHERE user_id = %d 
             AND order_id LIKE %s 
             AND type = 'refund'
             AND status = 'approved'
             LIMIT 1",
            $user_id,
            'exchange_refund:' . $request_id . ':%'
        ));

        if ($existing) {
            // CRITICAL: Refund already exists - return existing transaction ID
            error_log(sprintf(
                'T-Work Rewards: CRITICAL - Duplicate exchange refund transaction prevented. User ID: %d, Request ID: %d, Existing Transaction ID: %d. This prevents 2x refund issue.',
                $user_id,
                $request_id,
                $existing
            ));
            return intval($existing);
        }

        // Create unique order_id with timestamp to ensure uniqueness
        $order_id = sprintf('exchange_refund:%d:%d:%d', $request_id, $user_id, time());

        // Create description
        $description = sprintf(
            'Points refunded for rejected exchange request #%d%s',
            $request_id,
            !empty($reason) ? ' (' . $reason . ')' : ''
        );

        // CRITICAL FINAL SAFETY: Validate points value one more time before inserting
        // Get request amount to ensure we never insert more than requested
        $exchange_table = $this->exchange_requests_table_name();
        $request_validation = $wpdb->get_row($wpdb->prepare(
            "SELECT points_value FROM $exchange_table WHERE id = %d",
            $request_id
        ), ARRAY_A);
        
        if ($request_validation && !empty($request_validation['points_value'])) {
            $request_validation_points = (float) $request_validation['points_value'];
            if ($points > $request_validation_points) {
                error_log(sprintf(
                    'T-Work Rewards: CRITICAL - create_exchange_refund_transaction: Points (%s) exceed request amount (%s). Capping at request amount. User ID: %d, Request ID: %d',
                    $points,
                    $request_validation_points,
                    $user_id,
                    $request_id
                ));
                $points = (int) round($request_validation_points); // Cap at request amount
            }
        }
        
        // CRITICAL LOG: Log what we're actually inserting
        error_log(sprintf(
            'T-Work Rewards: Inserting refund transaction. User ID: %d, Request ID: %d, Points: %d, Request Points: %s',
            $user_id,
            $request_id,
            $points,
            $request_validation && !empty($request_validation['points_value']) ? $request_validation['points_value'] : 'N/A'
        ));

        // Insert refund transaction
        $result = $wpdb->insert(
            $table_name,
            array(
                'user_id' => $user_id,
                'type' => 'refund',  // Use 'refund' type for refunds
                'points' => $points,  // This should now be capped at request amount
                'description' => $description,
                'order_id' => $order_id,
                'expires_at' => null,  // Refunds don't expire
                'created_at' => current_time('mysql'),
                'status' => 'approved',  // Refunds are auto-approved
            ),
            array('%d', '%s', '%d', '%s', '%s', '%s', '%s', '%s')
        );

        if ($result === false) {
            $error_msg = $wpdb->last_error ?: 'Unknown database error';
            error_log(sprintf(
                'T-Work Rewards: Failed to create exchange refund transaction. User ID: %d, Points: %d, Request ID: %d, Error: %s',
                $user_id,
                $points,
                $request_id,
                $error_msg
            ));
            return false;
        }

        $transaction_id = $wpdb->insert_id;

        // Invalidate balance cache
        delete_user_meta($user_id, 'points_balance_cache');
        delete_user_meta($user_id, 'points_balance_cache_time');

        // Professional logging
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log(sprintf(
                'T-Work Rewards: Exchange refund transaction created. Transaction ID: %d, User ID: %d, Points: %d, Request ID: %d',
                $transaction_id,
                $user_id,
                $points,
                $request_id
            ));
        }

        return $transaction_id;
    }

    private function log_engagement_transaction($user_id, $points, $type, $description)
    {
        global $wpdb;
        $table_name = $this->table_name();

        $wpdb->insert(
            $table_name,
            array(
                'user_id' => $user_id,
                'order_id' => $type . '_' . time() . '_' . mt_rand(100, 999),
                'status' => 'approved',
                'reward_value' => '0',
                'points_value' => $points,
                'created_at' => current_time('mysql')
            )
        );
    }

    /**
     * PROFESSIONAL FEATURE: Point Tiers System - Get User's Current Tier
     *
     * Returns the active tier for a user based on their current points balance
     *
     * @param int $user_id User ID
     * @return array|null Tier data or null if not found
     */
    private function get_user_tier($user_id)
    {
        global $wpdb;

        if (!$user_id || $user_id <= 0) {
            return null;
        }

        // PROFESSIONAL OPTIMIZATION: Check cache first (15 minute cache for better performance)
        $cache_key = 'twork_user_tier_' . $user_id;
        $cached_tier = get_transient($cache_key);
        if ($cached_tier !== false) {
            return $cached_tier;
        }

        $user_tiers_table = $this->user_tiers_table_name();
        $tiers_table = $this->point_tiers_table_name();

        // PROFESSIONAL OPTIMIZATION: Check table existence using SHOW TABLES LIKE (more compatible, faster)
        $user_tiers_check = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $user_tiers_table));
        $tiers_check = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $tiers_table));

        if ($user_tiers_check !== $user_tiers_table || $tiers_check !== $tiers_table) {
            return null;  // Tables don't exist yet
        }

        // Get user's active tier assignment
        $user_tier = $wpdb->get_row($wpdb->prepare(
            "SELECT ut.*, t.tier_name, t.tier_slug, t.tier_level, t.earning_multiplier, 
                    t.badge_icon, t.badge_color, t.description, t.benefits
             FROM $user_tiers_table ut
             INNER JOIN $tiers_table t ON ut.tier_id = t.id
             WHERE ut.user_id = %d AND ut.is_active = 1 AND t.is_active = 1
             ORDER BY t.tier_level DESC
             LIMIT 1",
            $user_id
        ), ARRAY_A);

        if ($user_tier) {
            // Parse benefits JSON
            if (!empty($user_tier['benefits'])) {
                $user_tier['benefits'] = json_decode($user_tier['benefits'], true);
            }
            // Cache for 15 minutes (tier assignments don't change frequently)
            set_transient($cache_key, $user_tier, 15 * MINUTE_IN_SECONDS);
            return $user_tier;
        }

        // PROFESSIONAL OPTIMIZATION: No tier assigned, but don't auto-calculate here
        // Let the caller decide if calculation is needed (avoid unnecessary calculations)
        // This prevents recursive calls and unnecessary tier calculations
        return null;
    }

    /**
     * PROFESSIONAL FEATURE: Invalidate user tier cache
     *
     * Call this when tier assignments change to ensure fresh data
     *
     * @param int $user_id User ID
     */
    private function invalidate_user_tier_cache($user_id)
    {
        if (!$user_id || $user_id <= 0) {
            return;
        }
        $cache_key = 'twork_user_tier_' . $user_id;
        delete_transient($cache_key);

        // Also invalidate REST API cache
        delete_transient('twork_rest_tier_' . $user_id);

        // Invalidate tier progression cache if exists
        delete_transient('twork_tier_progression_' . $user_id);
    }

    /**
     * PROFESSIONAL FEATURE: Calculate and assign tier based on user's points
     *
     * @param int $user_id User ID
     * @param bool $auto_assign Whether to automatically assign the tier
     * @return array|null Tier data
     */
    private function calculate_user_tier($user_id, $auto_assign = true)
    {
        global $wpdb;

        if (!$user_id || $user_id <= 0) {
            return null;
        }

        $tiers_table = $this->point_tiers_table_name();

        // PROFESSIONAL OPTIMIZATION: Check table existence using SHOW TABLES LIKE (faster, more compatible)
        $table_check = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $tiers_table));
        if ($table_check !== $tiers_table) {
            return null;  // Table doesn't exist yet
        }

        // Get user's current points balance
        $points_balance = $this->calculate_points_balance_from_transactions($user_id);

        // Find appropriate tier based on points
        $tier = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $tiers_table 
             WHERE is_active = 1 
             AND min_points <= %d 
             AND (max_points IS NULL OR max_points >= %d)
             ORDER BY tier_level DESC
             LIMIT 1",
            $points_balance,
            $points_balance
        ), ARRAY_A);

        if (!$tier) {
            return null;  // No tier found
        }

        // Parse benefits JSON
        if (!empty($tier['benefits'])) {
            $tier['benefits'] = json_decode($tier['benefits'], true);
        }

        // Auto-assign tier if requested
        if ($auto_assign) {
            $this->assign_user_tier($user_id, $tier['id'], 'automatic', $points_balance);
        }

        return $tier;
    }

    /**
     * PROFESSIONAL FEATURE: Assign tier to user
     *
     * @param int $user_id User ID
     * @param int $tier_id Tier ID
     * @param string $assignment_type 'automatic' or 'manual'
     * @param int $points_at_assignment Points balance when assigned
     * @param int|null $assigned_by Admin user ID (for manual assignments)
     * @return bool Success status
     */
    private function assign_user_tier($user_id, $tier_id, $assignment_type = 'automatic', $points_at_assignment = 0, $assigned_by = null)
    {
        global $wpdb;

        if (!$user_id || !$tier_id) {
            return false;
        }

        $user_tiers_table = $this->user_tiers_table_name();
        $tier_history_table = $this->tier_history_table_name();

        // PROFESSIONAL OPTIMIZATION: Direct query instead of get_user_tier() to avoid unnecessary table checks
        // Get current active tier assignment directly (single query, no function call overhead)
        $old_tier_id = $wpdb->get_var($wpdb->prepare(
            "SELECT tier_id FROM $user_tiers_table WHERE user_id = %d AND is_active = 1 LIMIT 1",
            $user_id
        ));

        // If same tier, don't update (avoid unnecessary database writes)
        if ($old_tier_id == $tier_id) {
            return true;
        }

        // Deactivate old tier assignment
        if ($old_tier_id) {
            $wpdb->update(
                $user_tiers_table,
                array('is_active' => 0, 'updated_at' => current_time('mysql')),
                array('user_id' => $user_id, 'tier_id' => $old_tier_id, 'is_active' => 1),
                array('%d', '%s'),
                array('%d', '%d', '%d')
            );
        }

        // Check if user already has this tier (inactive)
        $existing = $wpdb->get_var($wpdb->prepare(
            "SELECT id FROM $user_tiers_table WHERE user_id = %d AND tier_id = %d",
            $user_id,
            $tier_id
        ));

        if ($existing) {
            // Reactivate existing assignment
            $wpdb->update(
                $user_tiers_table,
                array(
                    'is_active' => 1,
                    'assigned_at' => current_time('mysql'),
                    'assigned_by' => $assigned_by ? $assigned_by : get_current_user_id(),
                    'assignment_type' => $assignment_type,
                    'points_at_assignment' => $points_at_assignment,
                    'updated_at' => current_time('mysql')
                ),
                array('id' => $existing),
                array('%d', '%s', '%d', '%s', '%d', '%s'),
                array('%d')
            );
        } else {
            // Create new assignment
            $wpdb->insert(
                $user_tiers_table,
                array(
                    'user_id' => $user_id,
                    'tier_id' => $tier_id,
                    'assigned_at' => current_time('mysql'),
                    'assigned_by' => $assigned_by ? $assigned_by : get_current_user_id(),
                    'assignment_type' => $assignment_type,
                    'points_at_assignment' => $points_at_assignment,
                    'is_active' => 1
                ),
                array('%d', '%d', '%s', '%d', '%s', '%d', '%d')
            );
        }

        // Record in history
        $change_type = 'upgrade';
        if ($old_tier_id) {
            $old_tier_level = $wpdb->get_var($wpdb->prepare(
                "SELECT tier_level FROM {$this->point_tiers_table_name()} WHERE id = %d",
                $old_tier_id
            ));
            $new_tier_level = $wpdb->get_var($wpdb->prepare(
                "SELECT tier_level FROM {$this->point_tiers_table_name()} WHERE id = %d",
                $tier_id
            ));

            if ($new_tier_level < $old_tier_level) {
                $change_type = 'downgrade';
            } elseif ($new_tier_level == $old_tier_level) {
                $change_type = 'change';
            }
        }

        $wpdb->insert(
            $tier_history_table,
            array(
                'user_id' => $user_id,
                'old_tier_id' => $old_tier_id,
                'new_tier_id' => $tier_id,
                'change_type' => $change_type,
                'points_at_change' => $points_at_assignment,
                'changed_by' => $assigned_by ? $assigned_by : get_current_user_id(),
                'change_reason' => $assignment_type === 'automatic' ? 'Automatic tier calculation' : 'Manual tier assignment'
            ),
            array('%d', '%d', '%d', '%s', '%d', '%d', '%s')
        );

        // Send notification if tier changed
        if ($old_tier_id != $tier_id) {
            $this->send_tier_change_notification($user_id, $old_tier_id, $tier_id, $change_type);
        }

        // PROFESSIONAL OPTIMIZATION: Invalidate tier cache when tier changes
        $this->invalidate_user_tier_cache($user_id);

        // Also invalidate REST API cache for this user
        delete_transient('twork_rest_tier_' . $user_id);

        // Invalidate tier thresholds cache (in case tier definitions changed)
        delete_transient('twork_tier_thresholds');

        // Invalidate all tiers list cache
        delete_transient('twork_rest_all_tiers');

        return true;
    }

    /**
     * PROFESSIONAL FEATURE: Get tier earning multiplier
     *
     * @param int $user_id User ID
     * @return float Multiplier (default 1.0)
     */
    private function get_tier_multiplier($user_id)
    {
        $tier = $this->get_user_tier($user_id);
        if ($tier && isset($tier['earning_multiplier'])) {
            return (float) $tier['earning_multiplier'];
        }
        return 1.0;  // Default multiplier
    }

    /**
     * PROFESSIONAL FEATURE: Send tier change notification
     *
     * @param int $user_id User ID
     * @param int|null $old_tier_id Old tier ID
     * @param int $new_tier_id New tier ID
     * @param string $change_type 'upgrade', 'downgrade', or 'change'
     */
    private function send_tier_change_notification($user_id, $old_tier_id, $new_tier_id, $change_type)
    {
        global $wpdb;

        $tiers_table = $this->point_tiers_table_name();

        $old_tier = null;
        if ($old_tier_id) {
            $old_tier = $wpdb->get_row($wpdb->prepare(
                "SELECT tier_name, tier_slug FROM $tiers_table WHERE id = %d",
                $old_tier_id
            ), ARRAY_A);
        }

        $new_tier = $wpdb->get_row($wpdb->prepare(
            "SELECT tier_name, tier_slug, earning_multiplier FROM $tiers_table WHERE id = %d",
            $new_tier_id
        ), ARRAY_A);

        if (!$new_tier) {
            return;
        }

        $title = '';
        $message = '';

        if ($change_type === 'upgrade') {
            $title = sprintf(__('ðŸŽ‰ Tier Upgrade!', 'twork-rewards'));
            $message = sprintf(
                __('Congratulations! You have been upgraded to %s tier. You now earn %.0f%% bonus points on all purchases!', 'twork-rewards'),
                $new_tier['tier_name'],
                (($new_tier['earning_multiplier'] - 1) * 100)
            );
        } elseif ($change_type === 'downgrade') {
            $title = sprintf(__('Tier Changed', 'twork-rewards'));
            $message = sprintf(
                __('Your tier has been changed to %s tier.', 'twork-rewards'),
                $new_tier['tier_name']
            );
        } else {
            $title = sprintf(__('Tier Updated', 'twork-rewards'));
            $message = sprintf(
                __('Your tier has been updated to %s tier.', 'twork-rewards'),
                $new_tier['tier_name']
            );
        }

        // Send FCM notification
        $this->send_points_fcm_notification($user_id, 'tier_change', array(
            'title' => $title,
            'message' => $message,
            'tier_name' => $new_tier['tier_name'],
            'tier_slug' => $new_tier['tier_slug'],
            'change_type' => $change_type,
            'multiplier' => $new_tier['earning_multiplier']
        ));
    }

    /**
     * PROFESSIONAL ARCHITECTURE: Transaction-Based Point Management
     *
     * SINGLE SOURCE OF TRUTH: twork_point_transactions table
     * Meta fields (my_points, points_balance) are CACHE ONLY
     *
     * This function creates a transaction and updates cache fields
     * Balance is ALWAYS calculated from transactions, not from meta
     *
     * @param int    $user_id          User ID.
     * @param float  $delta            Points to add (positive) or subtract (negative).
     * @param string $order_id         Order ID for transaction tracking.
     * @param string $description      Transaction description.
     * @param bool   $create_transaction Whether to create transaction records.
     * @return bool Success status.
     *
     * @since 1.0.0
     */
    private function sync_user_points($user_id, $delta, $order_id = '', $description = '', $create_transaction = true)
    {
        if (!$user_id || 0 == $delta) {
            return false;
        }

        global $wpdb;

        // PROFESSIONAL FEATURE: Apply tier multiplier for point earning (positive delta only)
        $original_delta = $delta;
        $multiplier_applied = false;
        if ($delta > 0) {
            $multiplier = $this->get_tier_multiplier($user_id);
            if ($multiplier > 1.0) {
                $delta = $delta * $multiplier;
                $multiplier_applied = true;

                // Update description to show multiplier if not already set
                if (empty($description) && $multiplier > 1.0) {
                    $description = sprintf(
                        'Points earned (%.0f%% tier bonus applied)',
                        (($multiplier - 1) * 100)
                    );
                }
            }
        }

        // PROFESSIONAL FIX: Create transaction FIRST (source of truth).
        $transaction_created = false;
        if ($create_transaction) {
            if (empty($order_id)) {
                $order_id = 'manual:' . $user_id . ':' . time();
            }
            if (empty($description)) {
                $description = sprintf(
                    'Manual adjustment (%s %d points)',
                    $delta >= 0 ? '+' : '-',
                    abs((int) $delta)
                );
            }

            // Create transaction in rewards system (legacy table).
            $table = $this->table_name();

            // PROFESSIONAL FIX: Check if created_by column exists and track admin who created this transaction
            $table_columns = $wpdb->get_col("DESCRIBE $table");
            $has_created_by = in_array('created_by', $table_columns);

            // Get current admin user ID if available (for manual adjustments)
            $current_user_id = get_current_user_id();
            $created_by = ($has_created_by && $current_user_id > 0) ? $current_user_id : null;

            $insert_data = array(
                'user_id' => $user_id,
                'order_id' => $order_id,
                'status' => 'approved',
                'reward_value' => null,
                'points_value' => (string) $delta,
                'created_at' => current_time('mysql'),
                'updated_at' => current_time('mysql'),
            );

            $insert_format = array('%d', '%s', '%s', '%s', '%s', '%s', '%s');

            // Add created_by if column exists and we have a current user
            if ($has_created_by && $created_by) {
                $insert_data['created_by'] = $created_by;
                $insert_format[] = '%d';
            }

            $wpdb->insert(
                $table,
                $insert_data,
                $insert_format
            );

            // Create transaction in points system (twork_point_transactions) - PRIMARY TABLE.
            $points_table = $wpdb->prefix . 'twork_point_transactions';
            $points_table_exists = $wpdb->get_var(
                $wpdb->prepare(
                    'SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = %s AND table_name = %s',
                    DB_NAME,
                    $points_table
                )
            );

            if ($points_table_exists) {
                $transaction_type = $delta >= 0 ? 'earn' : 'redeem';
                $points_abs = abs((int) $delta);

                $result = $wpdb->insert(
                    $points_table,
                    array(
                        'user_id' => $user_id,
                        'type' => $transaction_type,
                        'points' => $points_abs,
                        'description' => $description,
                        'order_id' => $order_id,
                        'expires_at' => null,
                        'created_at' => current_time('mysql'),
                        'status' => 'approved',
                    ),
                    array('%d', '%s', '%d', '%s', '%s', '%s', '%s', '%s')
                );

                // CRITICAL DEBUG: Log transaction creation result.
                if (false === $result) {
                    error_log(
                        sprintf(
                            'T-Work Rewards: FAILED to create transaction in points table. User ID: %d, Delta: %s, Error: %s',
                            $user_id,
                            $delta,
                            $wpdb->last_error
                        )
                    );
                } else {
                    $transaction_id = $wpdb->insert_id;
                    $transaction_created = true;
                    error_log(
                        sprintf(
                            'T-Work Rewards: Transaction created successfully. Transaction ID: %d, User ID: %d, Type: %s, Points: %d',
                            $transaction_id,
                            $user_id,
                            $transaction_type,
                            $points_abs
                        )
                    );
                }
            } else {
                // CRITICAL: Table doesn't exist! Use fallback mechanism.
                error_log(
                    sprintf(
                        'T-Work Rewards: Points table does NOT exist! User ID: %d, Delta: %s. Using fallback mechanism.',
                        $user_id,
                        $delta
                    )
                );
            }
        }

        // CRITICAL: Calculate balance from transactions (single source of truth).
        // If table doesn't exist, calculate_points_balance_from_transactions will use fallback.
        $calculated_balance = $this->calculate_points_balance_from_transactions($user_id);

        // FALLBACK: If no transaction was created (table doesn't exist), manually calculate balance.
        if (!$transaction_created && $create_transaction) {
            // Get current balance from meta.
            $current_balance = get_user_meta($user_id, 'points_balance', true);
            if (!is_numeric($current_balance)) {
                $current_balance = 0;
            }

            // Add delta to current balance.
            $calculated_balance = max(0, (int) $current_balance + (int) $delta);

            error_log(
                sprintf(
                    'T-Work Rewards: Using fallback calculation. User ID: %d, Old Balance: %d, Delta: %s, New Balance: %d',
                    $user_id,
                    $current_balance,
                    $delta,
                    $calculated_balance
                )
            );
        }

        // Update cache fields (my_points and points_balance are CACHE ONLY).
        $stored = (string) $calculated_balance;
        update_user_meta($user_id, 'my_points', $stored);
        update_user_meta($user_id, 'my_point', $stored);  // Backward compatibility.
        update_user_meta($user_id, 'points_balance', $calculated_balance);
        update_user_meta($user_id, 'my_points_updated_at', time());

        // Invalidate balance cache.
        delete_user_meta($user_id, 'points_balance_cache');
        delete_user_meta($user_id, 'points_balance_cache_time');

        // PROFESSIONAL FCM NOTIFICATION: Send notification for manual point adjustments
        // Check if this is a manual adjustment (order_id starts with 'manual:')
        $is_manual_adjustment = (strpos($order_id, 'manual:') === 0);

        if ($is_manual_adjustment && $transaction_created) {
            // Get transaction ID from points table if available
            $transaction_id = isset($transaction_id) ? $transaction_id : 0;

            // If transaction_id not set, try to get it from rewards table
            if ($transaction_id <= 0) {
                $rewards_transaction = $wpdb->get_row($wpdb->prepare(
                    "SELECT id FROM {$table} WHERE user_id = %d AND order_id = %s ORDER BY id DESC LIMIT 1",
                    $user_id,
                    $order_id
                ));
                if ($rewards_transaction) {
                    $transaction_id = $rewards_transaction->id;
                }
            }

            // Send notification for manual adjustment
            $this->send_points_fcm_notification(
                $user_id,
                'points_adjusted',
                array(
                    'transaction_id' => $transaction_id,
                    'points' => abs((int) $delta),
                    'points_value' => (string) $delta,
                    'description' => $description,
                    'is_positive' => $delta >= 0,
                )
            );
        }

        // Professional logging.
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log(
                sprintf(
                    'T-Work Rewards: Transaction created and cache updated. User ID: %d, Delta: %s, Calculated Balance: %d, Is Manual: %s',
                    $user_id,
                    $delta,
                    $calculated_balance,
                    $is_manual_adjustment ? 'Yes' : 'No'
                )
            );
        }

        // PROFESSIONAL OPTIMIZATION: Check and update user tier after points change
        // Only check if points were actually changed AND tier system is enabled
        // Skip tier check if delta is 0 or transaction wasn't created (no actual change)
        if ($transaction_created && $delta != 0) {
            // Check if tier tables exist before attempting tier calculation (avoid unnecessary queries)
            $tiers_table = $this->point_tiers_table_name();
            $table_check = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $tiers_table));
            if ($table_check === $tiers_table) {
                // Only recalculate tier if points actually changed (positive or negative)
                $this->calculate_user_tier($user_id, true);
            }
        }

        return true;
    }

    public function rest_luckybox_get_config(WP_REST_Request $request)
    {
        $user_id = absint($request->get_param('user_id'));
        if ($user_id <= 0 || !get_user_by('ID', $user_id)) {
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'Invalid user',
            ), 400);
        }

        // Rate limiting: Prevent abuse (max 60 requests per minute per user)
        $rate_limit_key = 'twork_luckybox_config_' . $user_id;
        $request_count = get_transient($rate_limit_key);

        if ($request_count !== false && $request_count >= 60) {
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'Rate limit exceeded. Please try again later.',
            ), 429);
        }

        // Increment counter
        $new_count = ($request_count === false) ? 1 : ($request_count + 1);
        set_transient($rate_limit_key, $new_count, 60);  // 60 seconds

        // OPTIMIZED: Load all user meta in single query instead of multiple get_user_meta calls
        global $wpdb;
        $meta_keys = array(self::USER_META_LUCKYBOX_ENABLED, 'twork_luckybox_pending');
        $placeholders = implode(',', array_fill(0, count($meta_keys), '%s'));
        $meta_query = $wpdb->prepare(
            "SELECT meta_key, meta_value FROM $wpdb->usermeta WHERE user_id = %d AND meta_key IN ($placeholders)",
            array_merge(array($user_id), $meta_keys)
        );
        $meta_results = $wpdb->get_results($meta_query);
        $user_meta = array();
        foreach ($meta_results as $meta) {
            $user_meta[$meta->meta_key] = $meta->meta_value;
        }

        // Per-user override: if set, it wins. Otherwise fallback to global default.
        $user_enabled_raw = isset($user_meta[self::USER_META_LUCKYBOX_ENABLED]) ? $user_meta[self::USER_META_LUCKYBOX_ENABLED] : '';
        if ($user_enabled_raw === '' || $user_enabled_raw === null) {
            $enabled = ((int) get_option(self::OPTION_LUCKYBOX_ENABLED, 1)) === 1;
        } else {
            $enabled = ((int) $user_enabled_raw) === 1;
        }

        // Check transaction status to determine subtitle
        // Priority: Approved > Pending > Before Click
        $table = $this->table_name();

        // Check for approved transaction first (highest priority) - exclude trashed
        $approved_transaction = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $table WHERE user_id = %d AND (order_id LIKE %s OR order_id = %s) AND status = 'approved' AND deleted_at IS NULL ORDER BY created_at DESC LIMIT 1",
            $user_id,
            'luckybox:%',
            'luckybox'
        ));

        // Check for pending transaction (only if no approved transaction) - exclude trashed
        $pending_transaction = null;
        if (!$approved_transaction) {
            $pending_transaction = $wpdb->get_row($wpdb->prepare(
                "SELECT * FROM $table WHERE user_id = %d AND (order_id LIKE %s OR order_id = %s) AND status = 'pending' AND deleted_at IS NULL ORDER BY created_at DESC LIMIT 1",
                $user_id,
                'luckybox:%',
                'luckybox'
            ));
        }

        // Determine subtitle state with priority: Approved > Pending > Before Click
        $subtitle_state = 'before_click';  // Default: "ðŸŽ Lucky Box á€€á€­á€¯ á€–á€½á€„á€·á€ºá€€á€¼á€Šá€·á€ºá€•á€«"
        $subtitle_text = 'ðŸŽ Lucky Box á€€á€­á€¯ á€–á€½á€„á€·á€ºá€€á€¼á€Šá€·á€ºá€•á€«';

        if ($approved_transaction) {
            // Has approved transaction: "ðŸŽ‰ á€€á€¶á€€á€±á€¬á€„á€ºá€¸á€•á€«á€á€šá€º!" (Highest priority)
            $subtitle_state = 'approved';
            $subtitle_text = 'ðŸŽ‰ á€€á€¶á€€á€±á€¬á€„á€ºá€¸á€•á€«á€á€šá€º!';
        } elseif ($pending_transaction) {
            // Has pending transaction: "â³ á€á€±á€¬á€„á€ºá€¸á€†á€­á€¯á€™á€¾á€¯ á€…á€±á€¬á€„á€·á€ºá€†á€­á€¯á€„á€ºá€¸á€”á€±á€•á€«á€á€šá€º"
            $subtitle_state = 'pending';
            $subtitle_text = 'â³ á€á€±á€¬á€„á€ºá€¸á€†á€­á€¯á€™á€¾á€¯ á€…á€±á€¬á€„á€·á€ºá€†á€­á€¯á€„á€ºá€¸á€”á€±á€•á€«á€á€šá€º';
        }

        return new WP_REST_Response(array(
            'success' => true,
            'enabled' => $enabled,
            'has_pending' => (bool) $pending_transaction,
            'can_open' => $enabled,  // Only depends on backend On/Off setting
            'subtitle_state' => $subtitle_state,  // 'before_click', 'pending', or 'approved'
            'subtitle_text' => $subtitle_text,  // Subtitle text for mobile app
        ), 200);
    }

    /**
     * REST API: Get Point Transactions
     * Returns all transactions for a user (for Point History page)
     */
    public function rest_get_transactions(WP_REST_Request $request)
    {
        global $wpdb;

        $user_id = intval($request->get_param('user_id'));
        $page = intval($request->get_param('page')) ?: 1;
        $per_page = intval($request->get_param('per_page')) ?: 20;
        $offset = ($page - 1) * $per_page;
        
        // PROFESSIONAL FIX: Support orderby and order parameters from frontend
        $orderby_param = sanitize_text_field($request->get_param('orderby')) ?: 'created_at';
        $order = strtoupper(sanitize_text_field($request->get_param('order'))) === 'ASC' ? 'ASC' : 'DESC';
        
        // Validate and map orderby field to prevent SQL injection
        $allowed_orderby = array(
            'id' => 'id',
            'created_at' => 'created_at',
            'points' => 'points',
            'type' => 'type',
            'status' => 'status'
        );
        $orderby = isset($allowed_orderby[$orderby_param]) ? $allowed_orderby[$orderby_param] : 'created_at';

        if ($user_id <= 0) {
            return new WP_Error('invalid_user', 'Invalid user ID', array('status' => 400));
        }

        // PROFESSIONAL FIX: Use twork_point_transactions as SINGLE SOURCE OF TRUTH
        // This table is the primary source for all point transactions
        // Check if points system table exists
        $points_table = $wpdb->prefix . 'twork_point_transactions';
        $points_table_exists = $wpdb->get_var($wpdb->prepare(
            'SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = %s AND table_name = %s',
            DB_NAME,
            $points_table
        ));

        $formatted_transactions = array();
        $total = 0;

        if ($points_table_exists) {
            // PRIMARY: Query from twork_point_transactions (SINGLE SOURCE OF TRUTH)
            // PROFESSIONAL FIX: Use orderby and order parameters from request
            $transactions = $wpdb->get_results($wpdb->prepare(
                "SELECT * FROM $points_table 
                WHERE user_id = %d 
                ORDER BY $orderby $order, id DESC 
                LIMIT %d OFFSET %d",
                $user_id,
                $per_page,
                $offset
            ));

            $total = $wpdb->get_var($wpdb->prepare(
                "SELECT COUNT(*) FROM $points_table WHERE user_id = %d",
                $user_id
            ));

            foreach ($transactions as $transaction) {
                // Points are stored as integer in points table
                // PROFESSIONAL FIX: Preserve actual points value (positive for earn, positive for redeem amount)
                // The app will handle sign display based on transaction type
                $points_int = isset($transaction->points) ? intval($transaction->points) : 0;
                
                // For adjust type, check if points value is stored as negative
                // Adjustments can be positive (add) or negative (subtract)
                if ($transaction->type === 'adjust' && $points_int < 0) {
                    // Keep negative value for negative adjustments
                    // App will display correctly based on formattedPoints getter
                }

                $formatted_transactions[] = array(
                    'id' => $transaction->id,
                    'user_id' => $transaction->user_id,
                    'type' => $transaction->type, // Already in correct format (earn, redeem, adjust, etc.)
                    'points' => $points_int,  // Preserve actual value (positive for earn/redeem amounts, can be negative for adjust)
                    'description' => $transaction->description ?: '',
                    'order_id' => $transaction->order_id,
                    'created_at' => $transaction->created_at,
                    'expires_at' => $transaction->expires_at,
                    'is_expired' => (bool) $transaction->is_expired,
                    'status' => isset($transaction->status) ? $transaction->status : 'approved',
                );
            }
        } else {
            // FALLBACK: If points table doesn't exist, query from rewards table (legacy support)
            $table_name = $wpdb->prefix . 'twork_reward_transactions';

            // PROFESSIONAL FIX: Exclude deleted/trashed transactions from API response
            // Get transactions ordered by newest first, excluding soft-deleted ones
            // PROFESSIONAL FIX: Use orderby and order parameters from request
            $transactions = $wpdb->get_results($wpdb->prepare(
                "SELECT * FROM $table_name 
                WHERE user_id = %d 
                AND deleted_at IS NULL
                ORDER BY $orderby $order, id DESC 
                LIMIT %d OFFSET %d",
                $user_id,
                $per_page,
                $offset
            ));

            $total = $wpdb->get_var($wpdb->prepare(
                "SELECT COUNT(*) FROM $table_name WHERE user_id = %d AND deleted_at IS NULL",
                $user_id
            ));

            foreach ($transactions as $transaction) {
                // PROFESSIONAL FIX: Preserve negative values for adjustments
                // points_value is stored as string, so we need to handle negative values correctly
                $points_value = $transaction->points_value;
                $points_int = 0;

                if ($points_value !== null && $points_value !== '') {
                    // Handle both string and numeric values
                    if (is_numeric($points_value)) {
                        $points_int = (int) floatval($points_value);  // Use floatval first to handle decimals, then cast to int
                    } else {
                        // Try to extract number from string
                        $points_int = intval($points_value);
                    }
                }

                $formatted_transactions[] = array(
                    'id' => $transaction->id,
                    'user_id' => $transaction->user_id,
                    'type' => $this->map_transaction_type($transaction->type, $transaction->order_id),
                    'points' => $points_int,  // Preserve negative values
                    'description' => $transaction->description ?: $this->get_default_description($transaction),
                    'order_id' => $transaction->order_id,
                    'created_at' => $transaction->created_at,
                    'expires_at' => null,  // Not tracked in rewards system
                    'is_expired' => false,
                    'status' => $transaction->status ?: 'approved',
                );
            }
        }

        return rest_ensure_response(array(
            'transactions' => $formatted_transactions,
            'total' => intval($total),
            'page' => $page,
            'per_page' => $per_page,
            'total_pages' => ceil($total / $per_page),
        ));
    }

    /**
     * Map transaction type from rewards system to points system format
     * PROFESSIONAL FIX: Detect manual adjustments and map to 'adjust' type
     */
    private function map_transaction_type($type, $order_id = '')
    {
        // Check if this is a manual adjustment based on order_id
        if (!empty($order_id) && strpos($order_id, 'manual:') === 0) {
            return 'adjust';
        }

        // Map reward transaction types to point transaction types
        $type_map = array(
            'reward' => 'earn',
            'exchange' => 'redeem',
            'luckybox' => 'earn',
            'prize_code' => 'earn',
        );

        return isset($type_map[$type]) ? $type_map[$type] : 'earn';
    }

    /**
     * Get default description for transaction
     */
    private function get_default_description($transaction)
    {
        if (!empty($transaction->order_id)) {
            if (strpos($transaction->order_id, 'luckybox') === 0) {
                return 'Lucky Box Request';
            }
            return 'Order #' . $transaction->order_id;
        }

        if ($transaction->type === 'prize_code') {
            return 'Prize Code Redeemed';
        }

        if ($transaction->type === 'exchange') {
            return 'Points Exchange Request';
        }

        return 'Points Transaction';
    }

    /**
     * REST API: Get Lucky Box Banner Content
     * Returns the banner HTML content to display below the Lucky Box button
     */
    public function rest_luckybox_banner(WP_REST_Request $request)
    {
        $banner_content = get_option(self::OPTION_LUCKYBOX_BANNER, '');

        // If banner content is empty, return empty response
        if (empty($banner_content)) {
            return new WP_REST_Response(array(
                'success' => true,
                'has_banner' => false,
                'content' => '',
            ), 200);
        }

        // Process content - apply WordPress filters for proper rendering
        // This allows shortcodes, auto-embeds, etc. to work
        $processed_content = apply_filters('the_content', $banner_content);

        // Clean up any extra whitespace
        $processed_content = trim($processed_content);

        return new WP_REST_Response(array(
            'success' => true,
            'has_banner' => true,
            'content' => $processed_content,  // HTML content ready for display
        ), 200);
    }

    public function rest_luckybox_open(WP_REST_Request $request)
    {
        // DEBUG: Log incoming request
        error_log('T-Work Rewards: rest_luckybox_open called');
        error_log('T-Work Rewards: Request method: ' . $request->get_method());
        error_log('T-Work Rewards: Request params: ' . print_r($request->get_params(), true));
        error_log('T-Work Rewards: Request body: ' . $request->get_body());
        error_log('T-Work Rewards: JSON params: ' . print_r($request->get_json_params(), true));

        // Try multiple ways to get user_id
        $params = $request->get_json_params();
        if (empty($params)) {
            // Try getting from body directly
            $body = $request->get_body();
            if (!empty($body)) {
                $decoded = json_decode($body, true);
                if ($decoded && isset($decoded['user_id'])) {
                    $params = $decoded;
                }
            }
        }

        // Also try from URL params
        if (empty($params) || !isset($params['user_id'])) {
            $url_user_id = $request->get_param('user_id');
            if ($url_user_id) {
                $params = array('user_id' => $url_user_id);
            }
        }

        $user_id = isset($params['user_id']) ? absint($params['user_id']) : 0;

        error_log('T-Work Rewards: Parsed user_id: ' . $user_id);

        if ($user_id <= 0) {
            error_log('T-Work Rewards: Invalid user_id (0 or negative): ' . $user_id);
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'Invalid user_id. Please provide a valid user_id in the request body.',
                'debug' => array(
                    'received_params' => $params,
                    'body' => $request->get_body(),
                ),
            ), 400);
        }

        $user = get_user_by('ID', $user_id);
        if (!$user) {
            error_log('T-Work Rewards: User not found: ' . $user_id);
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'User not found',
            ), 400);
        }

        // Rate limiting: Prevent abuse (max 10 requests per minute per user)
        $rate_limit_key = 'twork_luckybox_open_' . $user_id;
        $request_count = get_transient($rate_limit_key);

        if ($request_count !== false && $request_count >= 10) {
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'Rate limit exceeded. Please try again later.',
            ), 429);
        }

        // Increment counter
        $new_count = ($request_count === false) ? 1 : ($request_count + 1);
        set_transient($rate_limit_key, $new_count, 60);  // 60 seconds

        // OPTIMIZED: Load all user meta in single query instead of multiple get_user_meta calls
        global $wpdb;
        $meta_keys = array(self::USER_META_LUCKYBOX_ENABLED, 'twork_luckybox_pending');
        $placeholders = implode(',', array_fill(0, count($meta_keys), '%s'));
        $meta_query = $wpdb->prepare(
            "SELECT meta_key, meta_value FROM $wpdb->usermeta WHERE user_id = %d AND meta_key IN ($placeholders)",
            array_merge(array($user_id), $meta_keys)
        );
        $meta_results = $wpdb->get_results($meta_query);
        $user_meta = array();
        foreach ($meta_results as $meta) {
            $user_meta[$meta->meta_key] = $meta->meta_value;
        }

        $user_enabled_raw = isset($user_meta[self::USER_META_LUCKYBOX_ENABLED]) ? $user_meta[self::USER_META_LUCKYBOX_ENABLED] : '';
        if ($user_enabled_raw === '' || $user_enabled_raw === null) {
            $enabled = ((int) get_option(self::OPTION_LUCKYBOX_ENABLED, 1)) === 1;
        } else {
            $enabled = ((int) $user_enabled_raw) === 1;
        }
        if (!$enabled) {
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'Lucky Box is disabled',
            ), 200);
        }

        // Check if there's a pending transaction - if yes, don't create new transaction (exclude trashed)
        $table = $this->table_name();
        $pending_transaction = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $table WHERE user_id = %d AND order_id LIKE %s AND status = 'pending' AND deleted_at IS NULL ORDER BY created_at DESC LIMIT 1",
            $user_id,
            'luckybox:%'
        ));

        if ($pending_transaction) {
            // Already has pending transaction - return pending message
            return new WP_REST_Response(array(
                'success' => true,
                'transaction_id' => $pending_transaction->id,
                'status' => 'pending',
                'subtitle_state' => 'pending',
                'subtitle_text' => 'â³ á€á€±á€¬á€„á€ºá€¸á€†á€­á€¯á€™á€¾á€¯ á€…á€±á€¬á€„á€·á€ºá€†á€­á€¯á€„á€ºá€¸á€”á€±á€•á€«á€á€šá€º',
                'message' => 'â³ á€á€±á€¬á€„á€ºá€¸á€†á€­á€¯á€™á€¾á€¯ á€…á€±á€¬á€„á€·á€ºá€†á€­á€¯á€„á€ºá€¸á€”á€±á€•á€«á€á€šá€º',
            ), 200);
        }

        // Check if there's an approved transaction - if yes, allow creating new transaction
        $approved_transaction = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $table WHERE user_id = %d AND order_id LIKE %s AND status = 'approved' ORDER BY created_at DESC LIMIT 1",
            $user_id,
            'luckybox:%'
        ));

        // Get points value from request (optional - can be set by admin later)
        $points_value = isset($params['points']) ? sanitize_text_field($params['points']) : '';

        // Create pending transaction for Lucky Box
        error_log('T-Work Rewards: Creating lucky box transaction for user ' . $user_id);
        $transaction_id = $this->create_luckybox_transaction($user_id, $points_value);

        if ($transaction_id === false) {
            $error_message = $wpdb->last_error ? $wpdb->last_error : 'Database error occurred';
            error_log('T-Work Rewards: rest_luckybox_open failed to create transaction for user ' . $user_id . '. Error: ' . $error_message);
            error_log('T-Work Rewards: Last query: ' . $wpdb->last_query);

            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'Failed to create transaction. Please try again later.',
                'debug' => $error_message,  // Include in response for debugging
            ), 500);
        }

        error_log('T-Work Rewards: Transaction created successfully. ID: ' . $transaction_id);

        // Set pending flag
        update_user_meta($user_id, 'twork_luckybox_pending', 1);
        update_user_meta($user_id, 'twork_luckybox_pending_at', current_time('mysql'));
        update_user_meta($user_id, 'twork_luckybox_transaction_id', $transaction_id);

        $response = array(
            'success' => true,
            'transaction_id' => $transaction_id,
            'status' => 'pending',
            'subtitle_state' => 'pending',
            'subtitle_text' => 'â³ á€á€±á€¬á€„á€ºá€¸á€†á€­á€¯á€™á€¾á€¯ á€…á€±á€¬á€„á€·á€ºá€†á€­á€¯á€„á€ºá€¸á€”á€±á€•á€«á€á€šá€º',
            'message' => 'Lucky Box opened. Transaction created.',
        );

        error_log('T-Work Rewards: Returning response: ' . print_r($response, true));

        return new WP_REST_Response($response, 200);
    }

    /**
     * REST API: Validate prize code
     */
    public function rest_prize_validate(WP_REST_Request $request)
    {
        $code = trim($request->get_param('code'));

        if (empty($code)) {
            return new WP_REST_Response(array(
                'valid' => false,
                'message' => 'Code is required',
            ), 400);
        }

        global $wpdb;
        $codes_table = $this->codes_table_name();

        // Find matching code prefix
        $matched_code = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $codes_table WHERE code_prefix = %s AND is_active = 1",
            $code
        ));

        if (!$matched_code) {
            return new WP_REST_Response(array(
                'valid' => false,
                'message' => 'Invalid code',
            ), 200);
        }

        // Check if code has reached max uses
        if ($matched_code->max_uses !== null && $matched_code->max_uses > 0) {
            if ($matched_code->current_uses >= $matched_code->max_uses) {
                return new WP_REST_Response(array(
                    'valid' => false,
                    'message' => 'Code has reached maximum uses',
                ), 200);
            }
        }

        return new WP_REST_Response(array(
            'valid' => true,
            'code' => $code,
            'prize_value' => $matched_code->reward_value ?: 0,
            'prize_points' => $matched_code->points_value ?: 0,
            'description' => $matched_code->description ?: 'Prize code redeemed',
            'message' => 'Code is valid',
        ), 200);
    }

    /**
     * REST API: Redeem prize code
     */
    public function rest_prize_redeem(WP_REST_Request $request)
    {
        $params = $request->get_json_params();
        $user_id = isset($params['user_id']) ? absint($params['user_id']) : 0;
        $code = isset($params['code']) ? trim($params['code']) : '';

        if ($user_id <= 0 || !get_user_by('ID', $user_id)) {
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'Invalid user',
            ), 400);
        }

        if (empty($code)) {
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'Code is required',
            ), 400);
        }

        global $wpdb;
        $codes_table = $this->codes_table_name();

        // Find matching code prefix
        $matched_code = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $codes_table WHERE code_prefix = %s AND is_active = 1",
            $code
        ));

        if (!$matched_code) {
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'Invalid code',
            ), 400);
        }

        // Check if code already redeemed by this user (one-time use per user)
        $table = $this->table_name();
        $existing = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(*) FROM $table WHERE user_id = %d AND order_id = %s",
            $user_id,
            'code:' . $code
        ));

        if ($existing > 0) {
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'You have already redeemed this code',
            ), 400);
        }

        // Check if code has reached max uses
        if ($matched_code->max_uses !== null && $matched_code->max_uses > 0) {
            if ($matched_code->current_uses >= $matched_code->max_uses) {
                return new WP_REST_Response(array(
                    'success' => false,
                    'message' => 'Code has reached maximum uses',
                ), 400);
            }
        }

        // Create transaction with approved status
        $transaction_id = $wpdb->insert(
            $table,
            array(
                'user_id' => $user_id,
                'order_id' => 'code:' . $code,
                'status' => 'approved',
                'reward_value' => $matched_code->reward_value,
                'points_value' => $matched_code->points_value,
                'created_at' => current_time('mysql'),
                'updated_at' => current_time('mysql'),
            ),
            array('%d', '%s', '%s', '%s', '%s', '%s', '%s')
        );

        if ($transaction_id === false) {
            return new WP_REST_Response(array(
                'success' => false,
                'message' => 'Failed to create transaction',
            ), 500);
        }

        $transaction_id = $wpdb->insert_id;

        // Increment current_uses for the code
        $wpdb->update(
            $codes_table,
            array(
                'current_uses' => $matched_code->current_uses + 1,
                'updated_at' => current_time('mysql'),
            ),
            array('id' => $matched_code->id),
            array('%d', '%s'),
            array('%d')
        );

        // PROFESSIONAL FIX: Update user points using unified system.
        if (!empty($matched_code->points_value) && is_numeric($matched_code->points_value)) {
            $delta = (float) $matched_code->points_value;
            $order_id = 'code:' . $code . ':' . time();
            $description = sprintf(
                'Reward code redeemed: %s (%s %d points)',
                $code,
                $delta >= 0 ? '+' : '-',
                abs((int) $delta)
            );

            // Use unified sync function (creates transaction and updates cache).
            $this->sync_user_points($user_id, $delta, $order_id, $description, true);

            error_log(
                sprintf(
                    'T-Work Rewards: Reward code redeemed. User ID: %d, Code: %s, Points: %s',
                    $user_id,
                    $code,
                    $matched_code->points_value
                )
            );
        }

        // PROFESSIONAL FCM NOTIFICATION: Send notification for reward code redemption
        // Send legacy webhook notification (for backward compatibility)
        $this->send_reward_update_notification(array(
            'user_id' => $user_id,
            'transaction_id' => $transaction_id,
            'reward_value' => $matched_code->reward_value,
            'points_value' => $matched_code->points_value,
            'status' => 'approved',
        ));

        // Send professional FCM notification for points earned
        if (!empty($matched_code->points_value) && is_numeric($matched_code->points_value)) {
            $this->send_points_fcm_notification(
                $user_id,
                'points_earned',
                array(
                    'transaction_id' => $transaction_id,
                    'points' => (int) $matched_code->points_value,
                    'points_value' => $matched_code->points_value,
                    'description' => sprintf('Reward code redeemed: %s (+%d points)', $code, (int) $matched_code->points_value),
                )
            );
        }

        return new WP_REST_Response(array(
            'success' => true,
            'transaction_id' => $transaction_id,
            'prize_points' => $matched_code->points_value ?: 0,
            'message' => 'Prize claimed successfully!',
        ), 200);
    }

    /**
     * REST API: Handle exchange request from app
     *
     * PROFESSIONAL FIX: Complete rewrite with proper validation, error handling,
     * and WordPress Coding Standards compliance
     *
     * @param WP_REST_Request $request REST API request object.
     * @return WP_REST_Response REST API response object.
     *
     * @since 1.0.0
     */
    public function rest_exchange_request(WP_REST_Request $request)
    {
        // WPCS: Get and sanitize parameters.
        $params = $request->get_json_params();
        $user_id = isset($params['user_id']) ? absint($params['user_id']) : 0;
        $type = isset($params['type']) ? sanitize_text_field($params['type']) : 'points';
        $reward_value = isset($params['reward_value']) ? trim(sanitize_text_field($params['reward_value'])) : '';
        $points_value = isset($params['points_value']) ? trim(sanitize_text_field($params['points_value'])) : '';
        $phone = isset($params['phone']) ? trim(sanitize_text_field($params['phone'])) : '';
        $note = isset($params['note']) ? trim(sanitize_textarea_field($params['note'])) : '';

        // Validate user exists.
        if ($user_id <= 0) {
            error_log(sprintf('T-Work Rewards: Exchange request failed - Invalid user ID: %d', $user_id));
            return new WP_REST_Response(
                array(
                    'success' => false,
                    'message' => __('Invalid user ID provided.', 'twork-rewards'),
                ),
                400
            );
        }

        $user = get_user_by('ID', $user_id);
        if (!$user) {
            error_log(sprintf('T-Work Rewards: Exchange request failed - User not found: %d', $user_id));
            return new WP_REST_Response(
                array(
                    'success' => false,
                    'message' => __('User not found.', 'twork-rewards'),
                ),
                404
            );
        }

        // RESTRICTION: Only allow Points exchange, reject Rewards exchange.
        if ('rewards' === $type || !empty($reward_value)) {
            error_log(sprintf('T-Work Rewards: Exchange request rejected - Rewards exchange not allowed. User ID: %d', $user_id));
            return new WP_REST_Response(
                array(
                    'success' => false,
                    'message' => __('Only points can be exchanged. Rewards exchange is not allowed.', 'twork-rewards'),
                ),
                400
            );
        }

        // Force type to 'points' for consistency.
        $type = 'points';

        // Validate points value is provided.
        if (empty($points_value)) {
            error_log(sprintf('T-Work Rewards: Exchange request failed - Points value missing. User ID: %d', $user_id));
            return new WP_REST_Response(
                array(
                    'success' => false,
                    'message' => __('Points value is required for exchange.', 'twork-rewards'),
                ),
                400
            );
        }

        // Validate points value is numeric and positive.
        if (!is_numeric($points_value) || (float) $points_value <= 0) {
            error_log(sprintf('T-Work Rewards: Exchange request failed - Invalid points value: %s. User ID: %d', $points_value, $user_id));
            return new WP_REST_Response(
                array(
                    'success' => false,
                    'message' => __('Points value must be a positive number.', 'twork-rewards'),
                ),
                400
            );
        }

        // PROFESSIONAL FIX: Calculate current balance from transactions (source of truth).
        $current_balance = $this->calculate_points_balance_from_transactions($user_id);

        // PROFESSIONAL FIX: Check minimum exchange points requirement
        $min_exchange_points = (int) get_option('twork_rewards_min_exchange_points', 100);
        if ($current_balance < $min_exchange_points) {
            error_log(
                sprintf(
                    'T-Work Rewards: Exchange request failed - Insufficient balance for minimum requirement. User ID: %d, Balance: %d, Minimum Required: %d',
                    $user_id,
                    $current_balance,
                    $min_exchange_points
                )
            );
            return new WP_REST_Response(
                array(
                    'success' => false,
                    'message' => sprintf(
                        /* translators: 1: current balance, 2: minimum required */
                        __('Insufficient points balance. You have %1$s points, but minimum %2$s points (PNP) required to exchange.', 'twork-rewards'),
                        number_format($current_balance, 0),
                        number_format($min_exchange_points, 0)
                    ),
                    'min_exchange_points' => $min_exchange_points,
                    'current_balance' => $current_balance,
                ),
                400
            );
        }

        // Validate user has enough points.
        $points_to_exchange = (float) $points_value;
        if ($current_balance < $points_to_exchange) {
            error_log(
                sprintf(
                    'T-Work Rewards: Exchange request failed - Insufficient balance. User ID: %d, Balance: %d, Requested: %s',
                    $user_id,
                    $current_balance,
                    $points_value
                )
            );
            return new WP_REST_Response(
                array(
                    'success' => false,
                    'message' => sprintf(
                        /* translators: 1: current balance, 2: requested points */
                        __('Insufficient points balance. You have %1$s points, but trying to exchange %2$s points.', 'twork-rewards'),
                        number_format($current_balance, 0),
                        number_format($points_to_exchange, 0)
                    ),
                ),
                400
            );
        }

        global $wpdb;
        $exchange_table = $this->exchange_requests_table_name();

        // PROFESSIONAL FIX: Create exchange request in database.
        $inserted = $wpdb->insert(
            $exchange_table,
            array(
                'user_id' => $user_id,
                'type' => 'points',  // Force to points only.
                'reward_value' => null,  // Always null - only points allowed.
                'points_value' => $points_value,
                'phone' => $phone,
                'note' => $note,
                'status' => 'pending',
                'created_at' => current_time('mysql'),
                'updated_at' => current_time('mysql'),
            ),
            array('%d', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s')
        );

        if (false === $inserted) {
            $error_msg = $wpdb->last_error ? $wpdb->last_error : __('Unknown database error occurred.', 'twork-rewards');
            error_log(
                sprintf(
                    'T-Work Rewards: Failed to insert exchange request. User ID: %d, Points: %s, Error: %s',
                    $user_id,
                    $points_value,
                    $error_msg
                )
            );
            return new WP_REST_Response(
                array(
                    'success' => false,
                    'message' => sprintf(
                        /* translators: %s: error message */
                        __('Failed to create exchange request: %s', 'twork-rewards'),
                        $error_msg
                    ),
                ),
                500
            );
        }

        $request_id = $wpdb->insert_id;

        // PROFESSIONAL ARCHITECTURE: Create transaction (single source of truth).
        // Transaction table is the PRIMARY source, meta fields are cache only.
        $points_transaction_id = $this->create_exchange_point_transaction(
            $user_id,
            (int) $points_to_exchange,
            $request_id,
            $phone
        );

        if (false === $points_transaction_id) {
            // Transaction creation failed - rollback exchange request.
            $wpdb->delete(
                $exchange_table,
                array('id' => $request_id),
                array('%d')
            );

            error_log(
                sprintf(
                    'T-Work Rewards: Failed to create point transaction for exchange. Rolling back. User ID: %d, Request ID: %d',
                    $user_id,
                    $request_id
                )
            );

            return new WP_REST_Response(
                array(
                    'success' => false,
                    'message' => __('Failed to process exchange request. Please try again.', 'twork-rewards'),
                ),
                500
            );
        }

        // CRITICAL: Refresh cache from transactions (single source of truth).
        // This ensures meta fields match the transaction table.
        $updated_balance = $this->refresh_user_points_cache($user_id);

        // STEP 2: Also create a transaction in the rewards system table (legacy compatibility).
        $table = $this->table_name();
        $order_id = 'exchange:' . $request_id;

        $txn_inserted = $wpdb->insert(
            $table,
            array(
                'user_id' => $user_id,
                'order_id' => $order_id,
                'status' => 'pending',
                'reward_value' => null,
                'points_value' => $points_value,
                'created_at' => current_time('mysql'),
                'updated_at' => current_time('mysql'),
            ),
            array('%d', '%s', '%s', '%s', '%s', '%s', '%s')
        );

        if (false === $txn_inserted) {
            error_log(
                sprintf(
                    'T-Work Rewards: Failed to create legacy transaction for exchange. User ID: %d, Request ID: %d, Error: %s',
                    $user_id,
                    $request_id,
                    $wpdb->last_error
                )
            );
            // Don't fail the request if legacy transaction creation fails, just log it.
        } else {
            $transaction_id = $wpdb->insert_id;
            // Store transaction ID in exchange request for reference.
            $wpdb->update(
                $exchange_table,
                array('note' => ($note ? $note . "\n" : '') . 'Transaction ID: ' . $transaction_id),
                array('id' => $request_id),
                array('%s'),
                array('%d')
            );
        }

        // PROFESSIONAL FCM NOTIFICATION: Send notification for points redeemed (exchange request created)
        $this->send_points_fcm_notification(
            $user_id,
            'points_redeemed',
            array(
                'request_id' => $request_id,
                'points' => (int) $points_to_exchange,
                'points_value' => $points_value,
                'description' => sprintf('Exchange request created: %d points reserved', (int) $points_to_exchange),
            )
        );

        // Professional logging.
        error_log(
            sprintf(
                'T-Work Rewards: Exchange request created successfully. User ID: %d, Request ID: %d, Points: %s, Old Balance: %d, New Balance: %d',
                $user_id,
                $request_id,
                $points_value,
                $current_balance,
                $updated_balance
            )
        );

        return new WP_REST_Response(
            array(
                'success' => true,
                'request_id' => $request_id,
                'status' => 'pending',
                'message' => __('Points exchange request submitted successfully. Points have been reserved pending admin approval.', 'twork-rewards'),
                'type' => 'points',
                'points_value' => $points_value,
                'previous_balance' => $current_balance,
                'current_points_balance' => $updated_balance,
                'can_exchange' => $updated_balance > 0,
            ),
            200
        );
    }

    /**
     * Create a pending transaction for Lucky Box
     *
     * Note: Always creates a new transaction (multiple clicks allowed).
     * Each click creates a separate pending transaction in the dashboard.
     *
     * @param int $user_id User ID
     * @param string $points_value Points value (optional, can be set by admin later)
     * @return int|false Transaction ID on success, false on failure
     */
    private function create_luckybox_transaction($user_id, $points_value = '')
    {
        global $wpdb;
        $table = $this->table_name();

        error_log('T-Work Rewards: create_luckybox_transaction called for user ' . $user_id . ', table: ' . $table);

        // OPTIMIZED: Migrations are handled in init() with version caching, no need to run here
        // Always create a new transaction (multiple clicks allowed)
        // Removed the check for existing pending transactions to allow multiple entries in dashboard
        $table_columns = $wpdb->get_col("DESCRIBE $table");
        if ($table_columns === false) {
            error_log('T-Work Rewards: Failed to get table columns for ' . $table . '. Error: ' . $wpdb->last_error);
            return false;
        }
        $table_columns_lower = array_map('strtolower', $table_columns);
        $has_points_value = in_array('points_value', $table_columns_lower);

        // FIXED: Use unique order_id with timestamp to allow multiple lucky box transactions per user
        // Format: luckybox:{user_id}_{timestamp} to ensure uniqueness and allow multiple opens
        $timestamp = time();
        $unique_order_id = 'luckybox:' . $user_id . '_' . $timestamp;

        error_log('T-Work Rewards: Creating transaction with order_id: ' . $unique_order_id);

        $insert_data = array(
            'user_id' => $user_id,
            'order_id' => $unique_order_id,  // Unique identifier for each lucky box transaction
            'status' => 'pending',
            'reward_value' => '',  // Use empty string instead of null for compatibility
            'created_at' => current_time('mysql'),
            'updated_at' => current_time('mysql'),
        );

        $insert_format = array('%d', '%s', '%s', '%s', '%s', '%s');

        if ($has_points_value) {
            $insert_data['points_value'] = $points_value ? $points_value : '';
            $insert_format[] = '%s';
        }

        error_log('T-Work Rewards: Insert data: ' . print_r($insert_data, true));
        error_log('T-Work Rewards: Insert format: ' . print_r($insert_format, true));

        $result = $wpdb->insert($table, $insert_data, $insert_format);

        if ($result === false) {
            $error_message = $wpdb->last_error ? $wpdb->last_error : 'Unknown database error';
            error_log('T-Work Rewards: Failed to create lucky box transaction for user ' . $user_id . '. Error: ' . $error_message);
            error_log('T-Work Rewards: Last query: ' . $wpdb->last_query);
            error_log('T-Work Rewards: Insert data: ' . print_r($insert_data, true));
            error_log('T-Work Rewards: Insert format: ' . print_r($insert_format, true));
            error_log('T-Work Rewards: Table: ' . $table);
            return false;
        }

        $insert_id = (int) $wpdb->insert_id;
        error_log('T-Work Rewards: Transaction created successfully. Insert ID: ' . $insert_id);

        return $insert_id;
    }

    /**
     * User profile UI (per-user Lucky Box enable/disable)
     */
    public function save_user_profile_rewards($user_id)
    {
        if (!current_user_can('edit_user', $user_id)) {
            return;
        }

        // Get old value before updating
        $old_enabled_raw = get_user_meta($user_id, self::USER_META_LUCKYBOX_ENABLED, true);
        $old_enabled = ($old_enabled_raw === '' || $old_enabled_raw === null)
            ? ((int) get_option(self::OPTION_LUCKYBOX_ENABLED, 1)) === 1
            : ((int) $old_enabled_raw) === 1;

        // Explicitly store 1/0 so REST can reliably pick up override.
        $enabled = isset($_POST['twork_luckybox_user_enabled']) ? 1 : 0;
        update_user_meta($user_id, self::USER_META_LUCKYBOX_ENABLED, $enabled);

        // PROFESSIONAL FIX: Save My Points with proper synchronization
        // Uses sync_user_points() helper to ensure consistency
        if (isset($_POST['twork_my_points'])) {
            $my_points = trim(sanitize_text_field(wp_unslash($_POST['twork_my_points'])));

            if ($my_points !== '' && is_numeric($my_points)) {
                $delta = (float) $my_points;
                $order_id = 'manual:' . $user_id . ':' . time();
                $description = sprintf(
                    'Manual adjustment by admin (%s %d points)',
                    $delta >= 0 ? '+' : '-',
                    abs((int) $delta)
                );

                // Use helper function to sync points across all systems
                $this->sync_user_points($user_id, $delta, $order_id, $description, true);
            } elseif ($my_points !== '' && !is_numeric($my_points)) {
                // Non-numeric value: overwrite with text (not recommended, but supported for backward compatibility)
                update_user_meta($user_id, 'my_points', $my_points);
                update_user_meta($user_id, 'my_point', $my_points);
                update_user_meta($user_id, 'my_points_updated_at', time());
            }
        }

        // Send notification if user's Lucky Box setting changed
        $new_enabled = (bool) $enabled;
        if ($old_enabled !== $new_enabled) {
            $this->send_luckybox_settings_notification(array(
                'type' => 'user',
                'enabled' => $new_enabled,
                'user_id' => $user_id,
            ));
        }
    }

    /**
     * Transactions list page
     */
    public function render_transactions_page()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('You do not have permission to access this page.', 'twork-rewards'));
        }

        global $wpdb;
        $table = $this->table_name();

        $status = isset($_GET['status']) ? sanitize_text_field(wp_unslash($_GET['status'])) : '';
        $user_id = isset($_GET['user_id']) ? absint($_GET['user_id']) : 0;
        $order_id = isset($_GET['order_id']) ? sanitize_text_field(wp_unslash($_GET['order_id'])) : '';
        $show_trash = isset($_GET['status']) && $_GET['status'] === 'trash';

        $where = array('1=1');
        $params = array();

        // Handle trash filter
        if ($show_trash) {
            $where[] = 'deleted_at IS NOT NULL';
        } else {
            // Exclude trashed items by default
            $where[] = 'deleted_at IS NULL';
        }

        if (!empty($status) && $status !== 'trash') {
            $where[] = 'status = %s';
            $params[] = $status;
        }
        if ($user_id > 0) {
            $where[] = 'user_id = %d';
            $params[] = $user_id;
        }
        if (!empty($order_id)) {
            $where[] = 'order_id = %s';
            $params[] = $order_id;
        }

        // Pagination to prevent memory issues
        $paged = isset($_GET['paged']) ? max(1, intval($_GET['paged'])) : 1;
        $per_page = isset($_GET['per_page']) ? intval($_GET['per_page']) : 50;
        $per_page = ($per_page > 0) ? min(100, $per_page) : 50;
        $offset = ($paged - 1) * $per_page;

        // Get total count
        $count_sql = "SELECT COUNT(*) FROM $table WHERE " . implode(' AND ', $where);
        if (!empty($params)) {
            $count_sql = $wpdb->prepare($count_sql, $params);
        }
        $total = (int) $wpdb->get_var($count_sql);

        // Get paginated transactions
        $sql = "SELECT * FROM $table WHERE " . implode(' AND ', $where) . ' ORDER BY id DESC LIMIT %d OFFSET %d';
        $params_with_pagination = array_merge($params, array($per_page, $offset));
        $sql = $wpdb->prepare($sql, $params_with_pagination);

        $transactions = $wpdb->get_results($sql, ARRAY_A);

        $total_pages = $per_page > 0 ? (int) ceil(max(0, $total) / $per_page) : 1;

        // Show success messages
        if (isset($_GET['deleted']) && intval($_GET['deleted']) > 0) {
            $count = intval($_GET['deleted']);
            echo '<div class="notice notice-success is-dismissible"><p>'
                . sprintf(esc_html(_n('Transaction moved to trash.', '%d transactions moved to trash.', $count, 'twork-rewards')), $count)
                . '</p></div>';
        }
        if (isset($_GET['restored']) && intval($_GET['restored']) > 0) {
            $count = intval($_GET['restored']);
            echo '<div class="notice notice-success is-dismissible"><p>'
                . sprintf(esc_html(_n('Transaction restored.', '%d transactions restored.', $count, 'twork-rewards')), $count)
                . '</p></div>';
        }
        if (isset($_GET['permanent_deleted']) && intval($_GET['permanent_deleted']) > 0) {
            $count = intval($_GET['permanent_deleted']);
            echo '<div class="notice notice-success is-dismissible"><p>'
                . sprintf(esc_html(_n('Transaction permanently deleted.', '%d transactions permanently deleted.', $count, 'twork-rewards')), $count)
                . '</p></div>';
        }
        ?>
        <div class="wrap">
            <h1 class="wp-heading-inline"><?php esc_html_e('Reward Transactions', 'twork-rewards'); ?></h1>
            <?php if ($show_trash): ?>
                <a class="page-title-action" href="<?php echo esc_url(admin_url('admin.php?page=twork-rewards')); ?>"><?php esc_html_e('View All', 'twork-rewards'); ?></a>
            <?php else: ?>
                <a class="page-title-action" href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards', 'status' => 'trash'), admin_url('admin.php'))); ?>"><?php esc_html_e('Trash', 'twork-rewards'); ?></a>
            <?php endif; ?>
            <hr class="wp-header-end" />

            <form method="get" style="margin: 12px 0;">
                <input type="hidden" name="page" value="twork-rewards" />
                <select name="status">
                    <option value=""><?php esc_html_e('All statuses', 'twork-rewards'); ?></option>
                    <option value="pending" <?php selected($status, 'pending'); ?>><?php esc_html_e('Pending', 'twork-rewards'); ?></option>
                    <option value="approved" <?php selected($status, 'approved'); ?>><?php esc_html_e('Approved', 'twork-rewards'); ?></option>
                    <option value="rejected" <?php selected($status, 'rejected'); ?>><?php esc_html_e('Rejected', 'twork-rewards'); ?></option>
                    <option value="trash" <?php selected($status, 'trash'); ?>><?php esc_html_e('Trash', 'twork-rewards'); ?></option>
                </select>
                <input type="number" name="user_id" placeholder="<?php esc_attr_e('User ID', 'twork-rewards'); ?>" value="<?php echo esc_attr($user_id ?: ''); ?>" />
                <input type="text" name="order_id" placeholder="<?php esc_attr_e('Order ID', 'twork-rewards'); ?>" value="<?php echo esc_attr($order_id); ?>" />
                <?php submit_button(__('Filter', 'twork-rewards'), 'secondary', '', false); ?>
                <a class="button button-secondary" href="<?php echo esc_url(admin_url('admin.php?page=twork-rewards')); ?>"><?php esc_html_e('Reset', 'twork-rewards'); ?></a>
            </form>

            <form method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>" id="bulk-action-form" style="margin: 12px 0;">
                <input type="hidden" name="action" value="twork_rewards_bulk_transaction_action" />
                <?php wp_nonce_field('twork_rewards_bulk_transaction_action', 'twork_rewards_bulk_nonce'); ?>
                <div class="tablenav top">
                    <div class="alignleft actions bulkactions">
                        <select name="bulk_action" id="bulk-action-selector">
                            <option value=""><?php esc_html_e('Bulk Actions', 'twork-rewards'); ?></option>
                            <?php if ($show_trash): ?>
                                <option value="restore"><?php esc_html_e('Restore', 'twork-rewards'); ?></option>
                                <option value="permanent_delete"><?php esc_html_e('Delete Permanently', 'twork-rewards'); ?></option>
                            <?php else: ?>
                                <option value="delete"><?php esc_html_e('Move to Trash', 'twork-rewards'); ?></option>
                            <?php endif; ?>
                        </select>
                        <input type="submit" class="button action" value="<?php esc_attr_e('Apply', 'twork-rewards'); ?>" />
                    </div>
                </div>
            </form>

            <table class="wp-list-table widefat fixed striped">
                <thead>
                <tr>
                    <td class="manage-column column-cb check-column"><input type="checkbox" id="cb-select-all" /></td>
                    <th><?php esc_html_e('ID', 'twork-rewards'); ?></th>
                    <th><?php esc_html_e('Date', 'twork-rewards'); ?></th>
                    <th><?php esc_html_e('User', 'twork-rewards'); ?></th>
                    <th><?php esc_html_e('Order', 'twork-rewards'); ?></th>
                    <th><?php esc_html_e('Status', 'twork-rewards'); ?></th>
                    <th><?php esc_html_e('Points', 'twork-rewards'); ?></th>
                    <th><?php esc_html_e('Created By', 'twork-rewards'); ?></th>
                    <th><?php esc_html_e('Approved By', 'twork-rewards'); ?></th>
                    <th><?php esc_html_e('Updated By', 'twork-rewards'); ?></th>
                    <th><?php esc_html_e('Actions', 'twork-rewards'); ?></th>
                </tr>
                </thead>
                <tbody>
                <?php
                if (!empty($transactions)):
                    // Batch load users to prevent N+1 queries
                    $user_ids = array_unique(array_column($transactions, 'user_id'));
                    $users_cache = array();
                    if (!empty($user_ids)) {
                        $users_query = new WP_User_Query(array(
                            'include' => $user_ids,
                            'number' => count($user_ids),
                        ));
                        foreach ($users_query->get_results() as $user_obj) {
                            $users_cache[$user_obj->ID] = $user_obj;
                        }
                    }

                    // PROFESSIONAL FIX: Batch load admin users for action tracking
                    $admin_user_ids = array();
                    foreach ($transactions as $txn) {
                        if (!empty($txn['created_by'])) {
                            $admin_user_ids[] = (int) $txn['created_by'];
                        }
                        if (!empty($txn['approved_by'])) {
                            $admin_user_ids[] = (int) $txn['approved_by'];
                        }
                        if (!empty($txn['updated_by'])) {
                            $admin_user_ids[] = (int) $txn['updated_by'];
                        }
                    }
                    $admin_user_ids = array_unique($admin_user_ids);
                    $admin_users_cache = array();
                    if (!empty($admin_user_ids)) {
                        $admin_users_query = new WP_User_Query(array(
                            'include' => $admin_user_ids,
                            'number' => count($admin_user_ids),
                        ));
                        foreach ($admin_users_query->get_results() as $admin_user_obj) {
                            $admin_users_cache[$admin_user_obj->ID] = $admin_user_obj;
                        }
                    }

                    // PROFESSIONAL FIX: Batch fetch exchange requests for exchange request transactions
                    $exchange_table = $this->exchange_requests_table_name();
                    $exchange_request_ids = array();
                    $exchange_request_map = array(); // Maps transaction order_id to exchange request data
                    foreach ($transactions as $txn) {
                        if (!empty($txn['order_id'])) {
                            $order_id_str = (string) $txn['order_id'];
                            if (strpos($order_id_str, 'exchange:') === 0) {
                                // Extract exchange request ID (format: exchange:123 or exchange:123:456:789)
                                $parts = explode(':', $order_id_str);
                                $exchange_request_id = isset($parts[1]) ? absint($parts[1]) : 0;
                                if ($exchange_request_id > 0) {
                                    $exchange_request_ids[] = $exchange_request_id;
                                }
                            }
                        }
                    }
                    $exchange_request_ids = array_unique($exchange_request_ids);
                    if (!empty($exchange_request_ids)) {
                        $exchange_ids_placeholders = implode(',', array_fill(0, count($exchange_request_ids), '%d'));
                        $exchange_requests = $wpdb->get_results($wpdb->prepare(
                            "SELECT id, approved_by, rejected_by, status FROM $exchange_table WHERE id IN ($exchange_ids_placeholders)",
                            ...$exchange_request_ids
                        ), ARRAY_A);
                        foreach ($exchange_requests as $ex_req) {
                            $exchange_request_map['exchange:' . $ex_req['id']] = $ex_req;
                        }
                        // Also add admin users from exchange requests to cache
                        $exchange_admin_user_ids = array();
                        foreach ($exchange_requests as $ex_req) {
                            if (!empty($ex_req['approved_by'])) {
                                $exchange_admin_user_ids[] = (int) $ex_req['approved_by'];
                            }
                            if (!empty($ex_req['rejected_by'])) {
                                $exchange_admin_user_ids[] = (int) $ex_req['rejected_by'];
                            }
                        }
                        $exchange_admin_user_ids = array_unique($exchange_admin_user_ids);
                        if (!empty($exchange_admin_user_ids)) {
                            $additional_admin_user_ids = array_diff($exchange_admin_user_ids, $admin_user_ids);
                            if (!empty($additional_admin_user_ids)) {
                                $additional_admin_users_query = new WP_User_Query(array(
                                    'include' => $additional_admin_user_ids,
                                    'number' => count($additional_admin_user_ids),
                                ));
                                foreach ($additional_admin_users_query->get_results() as $admin_user_obj) {
                                    $admin_users_cache[$admin_user_obj->ID] = $admin_user_obj;
                                }
                            }
                        }
                    }
                    ?>
                    <?php
                    foreach ($transactions as $txn):
                        $user = isset($users_cache[$txn['user_id']]) ? $users_cache[$txn['user_id']] : null;
                        $order_link = '';
                        $is_exchange_request = false;
                        $exchange_request_id = null;

                        if (!empty($txn['order_id'])) {
                            $order_id_str = (string) $txn['order_id'];

                            // Check for exchange request
                            if (strpos($order_id_str, 'exchange:') === 0) {
                                $is_exchange_request = true;
                                // Extract exchange request ID from order_id (format: exchange:123 or exchange:123:456:789)
                                // Get the first number after "exchange:"
                                $parts = explode(':', $order_id_str);
                                $exchange_request_id = isset($parts[1]) ? absint($parts[1]) : 0;
                                $order_link = '<span style="color: #3b82f6; font-weight: 500;">' . esc_html__('Exchange Request', 'twork-rewards') . '</span>';
                            }
                            // Check for manual reward adjustment
                            elseif (strpos($order_id_str, 'manual_reward:') === 0) {
                                $order_link = '<span style="color: #10b981; font-weight: 500;">' . esc_html__('Reward Adjustment', 'twork-rewards') . '</span>';
                            }
                            // Check for manual point adjustment
                            elseif (strpos($order_id_str, 'manual:') === 0) {
                                $order_link = '<span style="color: #f59e0b; font-weight: 500;">' . esc_html__('Point Adjustment', 'twork-rewards') . '</span>';
                            }
                            // Check for code redemption
                            elseif (strpos($order_id_str, 'code:') === 0) {
                                $order_link = '<span style="color: #8b5cf6; font-weight: 500;">' . esc_html__('Code Redemption', 'twork-rewards') . '</span>';
                            }
                            // Check for lucky box (format: luckybox:{user_id}_{timestamp} or old format: luckybox)
                            elseif (strpos($order_id_str, 'luckybox:') === 0 || $order_id_str === 'luckybox') {
                                $order_link = '<span style="color: #667eea; font-weight: 500;">' . esc_html__('Lucky Box', 'twork-rewards') . '</span>';
                            }
                            // Check for regular order ID (numeric)
                            else {
                                $display_order_id = preg_replace('/[^0-9]/', '', $order_id_str);
                                if (!empty($display_order_id)) {
                                    $order_link = '<a href="' . esc_url(admin_url('post.php?post=' . absint($display_order_id) . '&action=edit')) . '">#' . esc_html($display_order_id) . '</a>';
                                } else {
                                    $order_link = esc_html($order_id_str);
                                }
                            }
                        }

                        // For exchange requests, link to exchange request edit page instead of transaction edit
                        if ($is_exchange_request && $exchange_request_id > 0) {
                            $action_url = add_query_arg(array(
                                'page' => 'twork-rewards-exchange-edit',
                                'id' => $exchange_request_id,
                            ), admin_url('admin.php'));
                            $action_text = esc_html__('View Exchange Request', 'twork-rewards');
                        } else {
                            $action_url = add_query_arg(array(
                                'page' => 'twork-rewards-transaction-edit',
                                'transaction_id' => absint($txn['id']),
                            ), admin_url('admin.php'));
                            $action_text = esc_html__('Edit', 'twork-rewards');
                        }

                        $is_trashed = !empty($txn['deleted_at']);
                        ?>
                        <tr<?php echo $is_trashed ? ' style="opacity: 0.6;"' : ''; ?>>
                            <th scope="row" class="check-column">
                                <input type="checkbox" name="transaction_ids[]" value="<?php echo esc_attr($txn['id']); ?>" form="bulk-action-form" />
                            </th>
                            <td><?php echo esc_html($txn['id']); ?></td>
                            <td><?php
                        // Professional: Display transaction date in Myanmar timezone
                        $formatted_date = $this->format_myanmar_time($txn['created_at']);
                        echo esc_html($formatted_date ?: $txn['created_at']);
                        ?></td>
                            <td>
                                <?php if ($user): ?>
                                    <a href="<?php echo esc_url(get_edit_user_link($user->ID)); ?>">
                                        <?php echo esc_html($user->display_name ?: $user->user_email); ?>
                                    </a>
                                    <div class="description"><?php echo esc_html(sprintf(__('User ID: %d', 'twork-rewards'), $user->ID)); ?></div>
                                <?php else: ?>
                                    <?php esc_html_e('Unknown user', 'twork-rewards'); ?>
                                <?php endif; ?>
                            </td>
                            <td><?php echo $order_link ? wp_kses_post($order_link) : '&mdash;'; ?></td>
                            <td><?php echo esc_html(ucfirst($txn['status'])); ?></td>
                            <td><?php echo !empty($txn['points_value']) ? esc_html($txn['points_value']) : '&mdash;'; ?></td>
                            <td>
                                <?php
                                // PROFESSIONAL FIX: Display who created the transaction
                                if (!empty($txn['created_by'])) {
                                    $created_by_user = isset($admin_users_cache[$txn['created_by']]) ? $admin_users_cache[$txn['created_by']] : null;
                                    if ($created_by_user) {
                                        echo '<a href="' . esc_url(get_edit_user_link($created_by_user->ID)) . '">';
                                        echo esc_html($created_by_user->display_name ?: $created_by_user->user_email);
                                        echo '</a>';
                                    } else {
                                        echo esc_html(sprintf(__('User ID: %d', 'twork-rewards'), $txn['created_by']));
                                    }
                                } else {
                                    echo '&mdash;';
                                }
                                ?>
                            </td>
                            <td>
                                <?php
                                // PROFESSIONAL FIX: For exchange requests, show approver/rejector from exchange request table
                                // CRITICAL FIX: Check status first, then show approver/rejector if available
                                if ($is_exchange_request && !empty($exchange_request_id)) {
                                    $exchange_request_data = isset($exchange_request_map['exchange:' . $exchange_request_id]) ? $exchange_request_map['exchange:' . $exchange_request_id] : null;
                                    if ($exchange_request_data) {
                                        // Normalize status to lowercase for comparison
                                        $ex_status = strtolower(trim($exchange_request_data['status']));
                                        
                                        // CRITICAL FIX: Check status first, regardless of approved_by/rejected_by
                                        // This ensures we show the correct status even if tracking fields are empty
                                        if ($ex_status === 'approved') {
                                            // PROFESSIONAL FIX: Show approver name - try cache first, then direct lookup
                                            if (!empty($exchange_request_data['approved_by'])) {
                                                $approver_user = isset($admin_users_cache[$exchange_request_data['approved_by']]) ? $admin_users_cache[$exchange_request_data['approved_by']] : null;
                                                // Fallback: fetch user directly if not in cache
                                                if (!$approver_user) {
                                                    $approver_user = get_user_by('ID', $exchange_request_data['approved_by']);
                                                    if ($approver_user) {
                                                        // Add to cache for future use
                                                        $admin_users_cache[$approver_user->ID] = $approver_user;
                                                    }
                                                }
                                                if ($approver_user) {
                                                    echo '<a href="' . esc_url(get_edit_user_link($approver_user->ID)) . '">';
                                                    echo esc_html($approver_user->display_name ?: $approver_user->user_email);
                                                    echo '</a>';
                                                } else {
                                                    echo esc_html(sprintf(__('User ID: %d', 'twork-rewards'), $exchange_request_data['approved_by']));
                                                }
                                            } else {
                                                echo '&mdash;';
                                            }
                                        } elseif ($ex_status === 'rejected') {
                                            // PROFESSIONAL FIX: Show rejector name - try cache first, then direct lookup
                                            if (!empty($exchange_request_data['rejected_by'])) {
                                                $rejector_user = isset($admin_users_cache[$exchange_request_data['rejected_by']]) ? $admin_users_cache[$exchange_request_data['rejected_by']] : null;
                                                // Fallback: fetch user directly if not in cache
                                                if (!$rejector_user) {
                                                    $rejector_user = get_user_by('ID', $exchange_request_data['rejected_by']);
                                                    if ($rejector_user) {
                                                        // Add to cache for future use
                                                        $admin_users_cache[$rejector_user->ID] = $rejector_user;
                                                    }
                                                }
                                                if ($rejector_user) {
                                                    echo '<a href="' . esc_url(get_edit_user_link($rejector_user->ID)) . '">';
                                                    echo esc_html($rejector_user->display_name ?: $rejector_user->user_email);
                                                    echo '</a>';
                                                } else {
                                                    echo esc_html(sprintf(__('User ID: %d', 'twork-rewards'), $exchange_request_data['rejected_by']));
                                                }
                                            } else {
                                                echo '&mdash;';
                                            }
                                        } else {
                                            // Status is pending or unknown
                                            echo '&mdash;';
                                        }
                                    } else {
                                        // Exchange request not found in map - try to fetch directly as fallback
                                        $exchange_table = $this->exchange_requests_table_name();
                                        $fallback_exchange = $wpdb->get_row($wpdb->prepare(
                                            "SELECT status, approved_by, rejected_by FROM $exchange_table WHERE id = %d",
                                            $exchange_request_id
                                        ), ARRAY_A);
                                        
                                        if ($fallback_exchange) {
                                            $ex_status = strtolower(trim($fallback_exchange['status']));
                                            if ($ex_status === 'approved') {
                                                // PROFESSIONAL FIX: Show approver name - try cache first, then direct lookup
                                                if (!empty($fallback_exchange['approved_by'])) {
                                                    $approver_user = isset($admin_users_cache[$fallback_exchange['approved_by']]) ? $admin_users_cache[$fallback_exchange['approved_by']] : null;
                                                    // Fallback: fetch user directly if not in cache
                                                    if (!$approver_user) {
                                                        $approver_user = get_user_by('ID', $fallback_exchange['approved_by']);
                                                        if ($approver_user) {
                                                            // Add to cache for future use
                                                            $admin_users_cache[$approver_user->ID] = $approver_user;
                                                        }
                                                    }
                                                    if ($approver_user) {
                                                        echo '<a href="' . esc_url(get_edit_user_link($approver_user->ID)) . '">';
                                                        echo esc_html($approver_user->display_name ?: $approver_user->user_email);
                                                        echo '</a>';
                                                    } else {
                                                        echo esc_html(sprintf(__('User ID: %d', 'twork-rewards'), $fallback_exchange['approved_by']));
                                                    }
                                                } else {
                                                    echo '&mdash;';
                                                }
                                            } elseif ($ex_status === 'rejected') {
                                                // PROFESSIONAL FIX: Show rejector name - try cache first, then direct lookup
                                                if (!empty($fallback_exchange['rejected_by'])) {
                                                    $rejector_user = isset($admin_users_cache[$fallback_exchange['rejected_by']]) ? $admin_users_cache[$fallback_exchange['rejected_by']] : null;
                                                    // Fallback: fetch user directly if not in cache
                                                    if (!$rejector_user) {
                                                        $rejector_user = get_user_by('ID', $fallback_exchange['rejected_by']);
                                                        if ($rejector_user) {
                                                            // Add to cache for future use
                                                            $admin_users_cache[$rejector_user->ID] = $rejector_user;
                                                        }
                                                    }
                                                    if ($rejector_user) {
                                                        echo '<a href="' . esc_url(get_edit_user_link($rejector_user->ID)) . '">';
                                                        echo esc_html($rejector_user->display_name ?: $rejector_user->user_email);
                                                        echo '</a>';
                                                    } else {
                                                        echo esc_html(sprintf(__('User ID: %d', 'twork-rewards'), $fallback_exchange['rejected_by']));
                                                    }
                                                } else {
                                                    echo '&mdash;';
                                                }
                                            } else {
                                                echo '&mdash;';
                                            }
                                        } else {
                                            // Exchange request not found - fallback to transaction approved_by
                                            if (!empty($txn['approved_by'])) {
                                                $approved_by_user = isset($admin_users_cache[$txn['approved_by']]) ? $admin_users_cache[$txn['approved_by']] : null;
                                                if ($approved_by_user) {
                                                    echo '<a href="' . esc_url(get_edit_user_link($approved_by_user->ID)) . '">';
                                                    echo esc_html($approved_by_user->display_name ?: $approved_by_user->user_email);
                                                    echo '</a>';
                                                } else {
                                                    echo esc_html(sprintf(__('User ID: %d', 'twork-rewards'), $txn['approved_by']));
                                                }
                                            } else {
                                                echo '&mdash;';
                                            }
                                        }
                                    }
                                } else {
                                    // PROFESSIONAL FIX: Display who approved the transaction (non-exchange requests)
                                    if (!empty($txn['approved_by'])) {
                                        $approved_by_user = isset($admin_users_cache[$txn['approved_by']]) ? $admin_users_cache[$txn['approved_by']] : null;
                                        if ($approved_by_user) {
                                            echo '<a href="' . esc_url(get_edit_user_link($approved_by_user->ID)) . '">';
                                            echo esc_html($approved_by_user->display_name ?: $approved_by_user->user_email);
                                            echo '</a>';
                                        } else {
                                            echo esc_html(sprintf(__('User ID: %d', 'twork-rewards'), $txn['approved_by']));
                                        }
                                    } else {
                                        echo '&mdash;';
                                    }
                                }
                                ?>
                            </td>
                            <td>
                                <?php
                                // PROFESSIONAL FIX: Display who updated the transaction
                                if (!empty($txn['updated_by'])) {
                                    $updated_by_user = isset($admin_users_cache[$txn['updated_by']]) ? $admin_users_cache[$txn['updated_by']] : null;
                                    if ($updated_by_user) {
                                        echo '<a href="' . esc_url(get_edit_user_link($updated_by_user->ID)) . '">';
                                        echo esc_html($updated_by_user->display_name ?: $updated_by_user->user_email);
                                        echo '</a>';
                                    } else {
                                        echo esc_html(sprintf(__('User ID: %d', 'twork-rewards'), $txn['updated_by']));
                                    }
                                } else {
                                    echo '&mdash;';
                                }
                                ?>
                            </td>
                            <td>
                                <?php if (!$is_trashed): ?>
                                    <a href="<?php echo esc_url($action_url); ?>"><?php echo $action_text; ?></a> |
                                    <a href="<?php echo esc_url(wp_nonce_url(add_query_arg(array('action' => 'twork_rewards_delete_transaction', 'transaction_id' => $txn['id']), admin_url('admin-post.php')), 'twork_rewards_delete_transaction', 'twork_rewards_delete_nonce')); ?>" 
                                       onclick="return confirm('<?php esc_attr_e('Are you sure you want to move this transaction to trash?', 'twork-rewards'); ?>');"
                                       style="color: #a00;"><?php esc_html_e('Delete', 'twork-rewards'); ?></a>
                                <?php else: ?>
                                    <a href="<?php echo esc_url(wp_nonce_url(add_query_arg(array('action' => 'twork_rewards_restore_transaction', 'transaction_id' => $txn['id']), admin_url('admin-post.php')), 'twork_rewards_restore_transaction', 'twork_rewards_restore_nonce')); ?>"><?php esc_html_e('Restore', 'twork-rewards'); ?></a> |
                                    <a href="<?php echo esc_url(wp_nonce_url(add_query_arg(array('action' => 'twork_rewards_permanent_delete_transaction', 'transaction_id' => $txn['id']), admin_url('admin-post.php')), 'twork_rewards_permanent_delete_transaction', 'twork_rewards_permanent_delete_nonce')); ?>" 
                                       onclick="return confirm('<?php esc_attr_e('Are you sure you want to permanently delete this transaction? This action cannot be undone.', 'twork-rewards'); ?>');"
                                       style="color: #a00;"><?php esc_html_e('Delete Permanently', 'twork-rewards'); ?></a>
                                <?php endif; ?>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                <?php else: ?>
                    <tr><td colspan="8"><?php esc_html_e('No transactions found.', 'twork-rewards'); ?></td></tr>
                <?php endif; ?>
                </tbody>
            </table>
        </div>
        <script>
        jQuery(document).ready(function($) {
            $('#cb-select-all').on('click', function() {
                $('input[name="transaction_ids[]"]').prop('checked', this.checked);
            });
        });
        </script>
        <?php
    }

    /**
     * Single transaction edit page
     */
    public function render_transaction_edit_page()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('You do not have permission to access this page.', 'twork-rewards'));
        }

        $transaction_id = isset($_GET['transaction_id']) ? absint($_GET['transaction_id']) : 0;
        if ($transaction_id <= 0) {
            wp_die(__('Missing transaction_id.', 'twork-rewards'));
        }

        global $wpdb;
        $table = $this->table_name();
        $txn = $wpdb->get_row($wpdb->prepare("SELECT * FROM $table WHERE id = %d", $transaction_id));
        if (!$txn) {
            wp_die(__('Transaction not found.', 'twork-rewards'));
        }

        // Check if transaction is trashed
        if (!empty($txn->deleted_at)) {
            wp_die(__('This transaction is in trash and cannot be edited. Please restore it first.', 'twork-rewards'));
        }

        // Check if this transaction is related to an exchange request
        // If so, redirect to exchange request edit page instead
        if (!empty($txn->order_id)) {
            $order_id_str = (string) $txn->order_id;
            if (strpos($order_id_str, 'exchange:') === 0) {
                // Extract exchange request ID from order_id (format: exchange:123)
                $exchange_request_id = str_replace('exchange:', '', $order_id_str);
                $exchange_request_id = absint($exchange_request_id);

                if ($exchange_request_id > 0) {
                    // Redirect to exchange request edit page
                    wp_safe_redirect(add_query_arg(array(
                        'page' => 'twork-rewards-exchange-edit',
                        'id' => $exchange_request_id,
                    ), admin_url('admin.php')));
                    exit;
                }
            }
        }

        $user = get_user_by('ID', $txn->user_id);
        $order_link = '&mdash;';
        if (!empty($txn->order_id)) {
            $display_order_id = preg_replace('/[^0-9]/', '', (string) $txn->order_id);
            if (!empty($display_order_id)) {
                $order_link = '<a href="' . esc_url(admin_url('post.php?post=' . absint($display_order_id) . '&action=edit')) . '">#' . esc_html($display_order_id) . '</a>';
            }
        }
        ?>
        <div class="wrap">
            <h1>
                <?php
                printf(
                    esc_html__('Edit Reward Transaction #%d', 'twork-rewards'),
                    intval($txn->id)
                );
                ?>
            </h1>

            <?php if (isset($_GET['updated']) && intval($_GET['updated']) === 1): ?>
                <div class="notice notice-success is-dismissible">
                    <p><?php esc_html_e('Reward transaction updated.', 'twork-rewards'); ?></p>
                </div>
            <?php endif; ?>

            <p>
                <a class="button" href="<?php echo esc_url(admin_url('admin.php?page=twork-rewards')); ?>">
                    <?php esc_html_e('Back to transactions', 'twork-rewards'); ?>
                </a>
            </p>

            <form method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>">
                <?php wp_nonce_field('twork_rewards_update_transaction', 'twork_rewards_txn_nonce'); ?>
                <input type="hidden" name="action" value="twork_rewards_update_transaction" />
                <input type="hidden" name="transaction_id" value="<?php echo esc_attr($txn->id); ?>" />

                <table class="form-table">
                    <tr>
                        <th scope="row"><?php esc_html_e('User', 'twork-rewards'); ?></th>
                        <td>
                            <?php if ($user): ?>
                                <a href="<?php echo esc_url(get_edit_user_link($user->ID)); ?>">
                                    <?php echo esc_html($user->display_name ?: $user->user_email); ?>
                                </a>
                                <p class="description"><?php echo esc_html(sprintf(__('User ID: %d', 'twork-rewards'), $user->ID)); ?></p>
                            <?php else: ?>
                                <?php esc_html_e('Unknown user', 'twork-rewards'); ?>
                            <?php endif; ?>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row"><?php esc_html_e('Order', 'twork-rewards'); ?></th>
                        <td><?php echo wp_kses_post($order_link); ?></td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="twork_rewards_status"><?php esc_html_e('Status', 'twork-rewards'); ?></label>
                        </th>
                        <td>
                            <select name="status" id="twork_rewards_status">
                                <option value="pending" <?php selected($txn->status, 'pending'); ?>><?php esc_html_e('Pending', 'twork-rewards'); ?></option>
                                <option value="approved" <?php selected($txn->status, 'approved'); ?>><?php esc_html_e('Approved', 'twork-rewards'); ?></option>
                                <option value="rejected" <?php selected($txn->status, 'rejected'); ?>><?php esc_html_e('Rejected', 'twork-rewards'); ?></option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="twork_rewards_points"><?php esc_html_e('Points Value', 'twork-rewards'); ?></label>
                        </th>
                        <td>
                            <input type="text" class="regular-text" name="points_value" id="twork_rewards_points"
                                   value=""
                                   placeholder="<?php esc_attr_e('Enter points to add/subtract (e.g., 50 or -20)', 'twork-rewards'); ?>" />
                            <p class="description">
                                <?php esc_html_e('When approved, this value will be added to existing points. Use positive numbers (e.g., 50) to add points, negative numbers (e.g., -20) to subtract points. Non-numeric values will be stored as text. Leave blank to keep current value.', 'twork-rewards'); ?>
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row"><?php esc_html_e('Created at', 'twork-rewards'); ?></th>
                        <td><?php
        // Professional: Display transaction date in Myanmar timezone
        $formatted_date = $this->format_myanmar_time($txn->created_at);
        echo esc_html($formatted_date ?: $txn->created_at);
        ?></td>
                    </tr>
                </table>

                <?php submit_button(__('Save', 'twork-rewards')); ?>
            </form>
        </div>
        <?php
    }

    public function handle_transaction_update()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }
        check_admin_referer('twork_rewards_update_transaction', 'twork_rewards_txn_nonce');

        $transaction_id = isset($_POST['transaction_id']) ? absint($_POST['transaction_id']) : 0;
        $status = isset($_POST['status']) ? sanitize_text_field(wp_unslash($_POST['status'])) : 'pending';
        $points_value = isset($_POST['points_value']) ? trim(sanitize_text_field(wp_unslash($_POST['points_value']))) : '';

        if ($transaction_id <= 0) {
            wp_die(__('Missing transaction_id.', 'twork-rewards'));
        }

        if (!in_array($status, array('pending', 'approved', 'rejected'), true)) {
            $status = 'pending';
        }

        global $wpdb;
        $table = $this->table_name();
        $txn = $wpdb->get_row($wpdb->prepare("SELECT * FROM $table WHERE id = %d", $transaction_id));
        if (!$txn) {
            wp_die(__('Transaction not found.', 'twork-rewards'));
        }

        // Store old status to check if it changed to approved
        $old_status = isset($txn->status) ? $txn->status : 'pending';
        $is_being_approved = ($old_status !== 'approved' && $status === 'approved');

        // PROFESSIONAL FIX: Get current admin user ID for action tracking
        $current_user_id = get_current_user_id();

        // OPTIMIZED: Migrations are handled in init() with version caching, no need to run here
        // Check which columns exist in the table
        $table_columns = $wpdb->get_col("DESCRIBE $table");
        $has_reward_value = in_array('reward_value', $table_columns);
        $has_points_value = in_array('points_value', $table_columns);
        $has_updated_at = in_array('updated_at', $table_columns);
        $has_approved_by = in_array('approved_by', $table_columns);
        $has_updated_by = in_array('updated_by', $table_columns);

        // Prepare update data - only include columns that exist
        $update_data = array(
            'status' => $status,
        );

        // Only add columns if they exist in the table
        // Note: reward_value is no longer used, but kept in database for historical records
        if ($has_reward_value) {
            $update_data['reward_value'] = '';  // Keep as empty string - rewards no longer supported
        }
        if ($has_points_value) {
            $update_data['points_value'] = $points_value;  // Keep as empty string if empty, not NULL
        }
        if ($has_updated_at) {
            $update_data['updated_at'] = current_time('mysql');
        }

        // PROFESSIONAL FIX: Track admin actions
        // Track who approved the transaction
        if ($has_approved_by && $status === 'approved' && $old_status !== 'approved') {
            $update_data['approved_by'] = $current_user_id;
        }

        // Track who updated the transaction (always update this when transaction is modified)
        if ($has_updated_by) {
            $update_data['updated_by'] = $current_user_id;
        }

        // Build format specifiers dynamically based on what columns we're updating
        $format = array('%s');  // status is always first
        if ($has_reward_value) {
            $format[] = '%s';
        }
        if ($has_points_value) {
            $format[] = '%s';
        }
        if ($has_updated_at) {
            $format[] = '%s';
        }
        if ($has_approved_by && isset($update_data['approved_by'])) {
            $format[] = '%d';
        }
        if ($has_updated_by) {
            $format[] = '%d';
        }

        // Perform the update using wpdb->update()
        $update_result = $wpdb->update(
            $table,
            $update_data,
            array('id' => $transaction_id),
            $format,
            array('%d')
        );

        // Check for actual database errors
        // Note: $wpdb->update() returns:
        // - false on error
        // - 0 if no rows were changed (data is the same)
        // - number of rows affected on success
        if ($update_result === false) {
            $error_message = $wpdb->last_error ? $wpdb->last_error : __('Unknown database error', 'twork-rewards');
            error_log('T-Work Rewards Update Error: ' . $error_message);
            error_log('Update Data: ' . print_r($update_data, true));
            error_log('Format: ' . print_r($format, true));
            error_log('Table: ' . $table);
            error_log('Transaction ID: ' . $transaction_id);
            error_log('Last Query: ' . $wpdb->last_query);
            wp_die(
                sprintf(
                    __('Failed to update transaction. Database error: %s', 'twork-rewards'),
                    esc_html($error_message)
                )
            );
        }

        // Log if no rows were affected (data might be identical)
        if ($update_result === 0) {
            error_log('T-Work Rewards: Update returned 0 rows affected for transaction ID: ' . $transaction_id . ' (data may be unchanged)');
        }

        // PROFESSIONAL FIX: Only after APPROVED, sync points using unified system.
        if (!empty($txn->user_id) && 'approved' === $status) {
            $user_id = (int) $txn->user_id;

            // CRITICAL: Use sync_user_points() for Lucky Box transactions.
            // This ensures points are properly recorded in transaction table.
            if ($points_value !== '' && is_numeric($points_value)) {
                $delta = (float) $points_value;

                // Generate order_id and description based on transaction type.
                $order_id = !empty($txn->order_id) ? $txn->order_id : 'transaction:' . $transaction_id . ':' . time();

                // Determine transaction type from order_id.
                $transaction_type = 'Unknown';
                if (strpos($order_id, 'luckybox:') === 0) {
                    $transaction_type = 'Lucky Box';
                } elseif (strpos($order_id, 'manual:') === 0) {
                    $transaction_type = 'Manual Adjustment';
                } elseif (strpos($order_id, 'order:') === 0) {
                    $transaction_type = 'Order';
                } elseif (strpos($order_id, 'code:') === 0) {
                    $transaction_type = 'Reward Code';
                }

                $description = sprintf(
                    '%s (%s %d points)',
                    $transaction_type,
                    $delta >= 0 ? '+' : '-',
                    abs((int) $delta)
                );

                // Use unified sync function (creates transaction and updates cache).
                $this->sync_user_points($user_id, $delta, $order_id, $description, true);

                error_log(
                    sprintf(
                        'T-Work Rewards: Transaction approved and points synced. Transaction ID: %d, User ID: %d, Type: %s, Points: %s',
                        $transaction_id,
                        $user_id,
                        $transaction_type,
                        $points_value
                    )
                );
            }

            // PROFESSIONAL FCM NOTIFICATION: Send notification when status changes to approved
            if ($is_being_approved) {
                // Send legacy webhook notification (for backward compatibility)
                $this->send_reward_update_notification(array(
                    'user_id' => (int) $txn->user_id,
                    'transaction_id' => (int) $transaction_id,
                    'points_value' => $points_value,
                    'status' => $status,
                ));

                // Send professional FCM notification for points approved
                if (!empty($points_value) && is_numeric($points_value)) {
                    $this->send_points_fcm_notification(
                        (int) $txn->user_id,
                        'points_approved',
                        array(
                            'transaction_id' => (int) $transaction_id,
                            'points' => (int) $points_value,
                            'points_value' => $points_value,
                            'description' => $description ?? sprintf('Points approved: +%d points', (int) $points_value),
                        )
                    );
                }
            }

            // FIXED: Clear lucky box pending flag when transaction is approved
            // This allows mobile app to show "ðŸŽ‰ á€€á€¶á€€á€±á€¬á€„á€ºá€¸á€•á€«á€á€šá€º!" subtitle
            if (!empty($txn->order_id) && strpos($txn->order_id, 'luckybox:') === 0) {
                // This is a lucky box transaction - clear pending flag so app can show approved state
                update_user_meta($user_id, 'twork_luckybox_pending', 0);
                delete_user_meta($user_id, 'twork_luckybox_pending_at');
                delete_user_meta($user_id, 'twork_luckybox_transaction_id');
            }
        } elseif ($status !== 'approved' && !empty($txn->user_id)) {
            // If status is changed from approved to something else, optionally clear user meta
            // (Comment out if you want to keep the values even when rejected)
            // update_user_meta((int) $txn->user_id, 'my_rewards', '');
            // update_user_meta((int) $txn->user_id, 'my_points', '');
        }

        wp_safe_redirect(add_query_arg(array(
            'page' => 'twork-rewards-transaction-edit',
            'transaction_id' => $transaction_id,
            'updated' => 1,
        ), admin_url('admin.php')));
        exit;
    }

    /**
     * Handle transaction delete (move to trash)
     */
    public function handle_transaction_delete()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }

        check_admin_referer('twork_rewards_delete_transaction', 'twork_rewards_delete_nonce');

        $transaction_id = isset($_GET['transaction_id']) ? absint($_GET['transaction_id']) : 0;
        if ($transaction_id <= 0) {
            wp_die(__('Missing transaction_id.', 'twork-rewards'));
        }

        global $wpdb;
        $table = $this->table_name();

        // Check if transaction exists and is not already trashed
        $txn = $wpdb->get_row($wpdb->prepare("SELECT * FROM $table WHERE id = %d", $transaction_id));
        if (!$txn) {
            wp_die(__('Transaction not found.', 'twork-rewards'));
        }

        // Move to trash by setting deleted_at
        $result = $wpdb->update(
            $table,
            array('deleted_at' => current_time('mysql')),
            array('id' => $transaction_id),
            array('%s'),
            array('%d')
        );

        if ($result === false) {
            wp_die(__('Failed to delete transaction.', 'twork-rewards'));
        }

        wp_safe_redirect(add_query_arg(array(
            'page' => 'twork-rewards',
            'deleted' => 1,
        ), admin_url('admin.php')));
        exit;
    }

    /**
     * Handle transaction restore (from trash)
     */
    public function handle_transaction_restore()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }

        check_admin_referer('twork_rewards_restore_transaction', 'twork_rewards_restore_nonce');

        $transaction_id = isset($_GET['transaction_id']) ? absint($_GET['transaction_id']) : 0;
        if ($transaction_id <= 0) {
            wp_die(__('Missing transaction_id.', 'twork-rewards'));
        }

        global $wpdb;
        $table = $this->table_name();

        // Check if transaction exists and is trashed
        $txn = $wpdb->get_row($wpdb->prepare("SELECT * FROM $table WHERE id = %d", $transaction_id));
        if (!$txn) {
            wp_die(__('Transaction not found.', 'twork-rewards'));
        }

        // Restore by clearing deleted_at
        $result = $wpdb->update(
            $table,
            array('deleted_at' => null),
            array('id' => $transaction_id),
            array('%s'),
            array('%d')
        );

        if ($result === false) {
            wp_die(__('Failed to restore transaction.', 'twork-rewards'));
        }

        wp_safe_redirect(add_query_arg(array(
            'page' => 'twork-rewards',
            'restored' => 1,
        ), admin_url('admin.php')));
        exit;
    }

    /**
     * Handle permanent delete (from trash)
     */
    public function handle_transaction_permanent_delete()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }

        check_admin_referer('twork_rewards_permanent_delete_transaction', 'twork_rewards_permanent_delete_nonce');

        $transaction_id = isset($_GET['transaction_id']) ? absint($_GET['transaction_id']) : 0;
        if ($transaction_id <= 0) {
            wp_die(__('Missing transaction_id.', 'twork-rewards'));
        }

        global $wpdb;
        $table = $this->table_name();

        // Check if transaction exists and is trashed
        $txn = $wpdb->get_row($wpdb->prepare("SELECT * FROM $table WHERE id = %d AND deleted_at IS NOT NULL", $transaction_id));
        if (!$txn) {
            wp_die(__('Transaction not found or not in trash.', 'twork-rewards'));
        }

        // Permanently delete
        $result = $wpdb->delete(
            $table,
            array('id' => $transaction_id),
            array('%d')
        );

        if ($result === false) {
            wp_die(__('Failed to permanently delete transaction.', 'twork-rewards'));
        }

        wp_safe_redirect(add_query_arg(array(
            'page' => 'twork-rewards',
            'status' => 'trash',
            'permanent_deleted' => 1,
        ), admin_url('admin.php')));
        exit;
    }

    /**
     * Handle bulk transaction actions
     */
    public function handle_bulk_transaction_action()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }

        check_admin_referer('twork_rewards_bulk_transaction_action', 'twork_rewards_bulk_nonce');

        $action = isset($_POST['bulk_action']) ? sanitize_text_field(wp_unslash($_POST['bulk_action'])) : '';
        $transaction_ids = isset($_POST['transaction_ids']) ? array_map('absint', (array) $_POST['transaction_ids']) : array();

        if (empty($action) || empty($transaction_ids)) {
            wp_safe_redirect(add_query_arg(array(
                'page' => 'twork-rewards',
            ), admin_url('admin.php')));
            exit;
        }

        global $wpdb;
        $table = $this->table_name();
        $deleted_count = 0;
        $restored_count = 0;
        $permanent_deleted_count = 0;

        foreach ($transaction_ids as $transaction_id) {
            if ($transaction_id <= 0) {
                continue;
            }

            switch ($action) {
                case 'delete':
                    // Move to trash
                    $result = $wpdb->update(
                        $table,
                        array('deleted_at' => current_time('mysql')),
                        array('id' => $transaction_id),
                        array('%s'),
                        array('%d')
                    );
                    if ($result !== false) {
                        $deleted_count++;
                    }
                    break;

                case 'restore':
                    // Restore from trash
                    $result = $wpdb->query($wpdb->prepare(
                        "UPDATE $table SET deleted_at = NULL WHERE id = %d AND deleted_at IS NOT NULL",
                        $transaction_id
                    ));
                    if ($result !== false && $result > 0) {
                        $restored_count++;
                    }
                    break;

                case 'permanent_delete':
                    // Permanently delete (only if in trash)
                    $result = $wpdb->query($wpdb->prepare(
                        "DELETE FROM $table WHERE id = %d AND deleted_at IS NOT NULL",
                        $transaction_id
                    ));
                    if ($result !== false && $result > 0) {
                        $permanent_deleted_count++;
                    }
                    break;
            }
        }

        $redirect_args = array('page' => 'twork-rewards');
        if ($deleted_count > 0) {
            $redirect_args['deleted'] = $deleted_count;
        }
        if ($restored_count > 0) {
            $redirect_args['restored'] = $restored_count;
        }
        if ($permanent_deleted_count > 0) {
            $redirect_args['permanent_deleted'] = $permanent_deleted_count;
        }

        wp_safe_redirect(add_query_arg($redirect_args, admin_url('admin.php')));
        exit;
    }

    /**
     * Handle bulk activity actions (mark as active/inactive, export, etc.)
     * Professional bulk operations for user activity management
     */
    public function handle_bulk_activity_action()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }

        check_admin_referer('twork_rewards_bulk_activity_action', 'twork_rewards_bulk_activity_nonce');

        $action = isset($_POST['bulk_action']) ? sanitize_text_field(wp_unslash($_POST['bulk_action'])) : '';
        $user_ids = isset($_POST['user_ids']) ? array_map('absint', (array) $_POST['user_ids']) : array();

        if (empty($action) || empty($user_ids)) {
            wp_safe_redirect(add_query_arg(array(
                'page' => 'twork-rewards-users',
            ), admin_url('admin.php')));
            exit;
        }

        $processed_count = 0;

        switch ($action) {
            case 'mark_active':
                // Force mark users as active by updating their activity timestamp
                foreach ($user_ids as $user_id) {
                    if ($user_id > 0) {
                        update_user_meta($user_id, 'twork_last_activity', time());
                        $processed_count++;
                    }
                }
                break;

            case 'mark_inactive':
                // Mark users as inactive by setting old activity timestamp
                $old_timestamp = time() - (90 * DAY_IN_SECONDS);  // 90 days ago
                foreach ($user_ids as $user_id) {
                    if ($user_id > 0) {
                        update_user_meta($user_id, 'twork_last_activity', $old_timestamp);
                        $processed_count++;
                    }
                }
                break;

            case 'export':
                // Export user activity data to CSV
                $this->export_user_activity_csv($user_ids);
                return;  // Exit early, CSV download handled
        }

        $redirect_args = array(
            'page' => 'twork-rewards-users',
            'bulk_action' => $action,
            'processed' => $processed_count,
        );

        wp_safe_redirect(add_query_arg($redirect_args, admin_url('admin.php')));
        exit;
    }

    /**
     * Export user activity data to CSV
     * Professional export functionality for analytics
     *
     * @param array $user_ids Array of user IDs to export
     */
    private function export_user_activity_csv($user_ids)
    {
        if (empty($user_ids)) {
            return;
        }

        // Set headers for CSV download
        header('Content-Type: text/csv; charset=utf-8');
        header('Content-Disposition: attachment; filename=user_activity_' . date('Y-m-d_His') . '.csv');
        header('Pragma: no-cache');
        header('Expires: 0');

        // Output BOM for UTF-8 Excel compatibility
        echo "\u{FEFF}";

        $output = fopen('php://output', 'w');

        // CSV Headers
        fputcsv($output, array(
            'User ID',
            'Email',
            'Display Name',
            'Status',
            'Activity Score',
            'Last Activity',
            'Last Login',
            'Last Order',
            'Last Transaction',
            'Days Inactive',
            'Activity Types Count'
        ));

        // Export data for each user
        foreach ($user_ids as $user_id) {
            $user = get_userdata($user_id);
            if (!$user) {
                continue;
            }

            $activity_status = $this->get_user_activity_status($user_id);
            $formatted = $this->get_formatted_user_activity($user_id);

            fputcsv($output, array(
                $user_id,
                $user->user_email,
                $user->display_name ?: $user->user_login,
                $activity_status['status'],
                $activity_status['activity_score'] ?? 0,
                $formatted['last_activity_formatted'] ?: 'Never',
                $formatted['last_login_formatted'] ?: 'Never',
                $activity_status['last_order'] ? $this->format_myanmar_time($activity_status['last_order'], 'Y-m-d H:i:s') : 'Never',
                $activity_status['last_transaction'] ? $this->format_myanmar_time($activity_status['last_transaction'], 'Y-m-d H:i:s') : 'Never',
                $activity_status['days_inactive'] ?? 'N/A',
                $activity_status['activity_types_count'] ?? 0
            ));
        }

        fclose($output);
        exit;
    }

    /**
     * PROFESSIONAL FCM NOTIFICATION SERVICE
     *
     * Comprehensive notification system for point-related events with:
     * - Token caching to minimize database reads
     * - Batch processing support
     * - Proper error handling and retry logic
     * - Rate limiting to prevent duplicates
     * - Support for all point event types
     *
     * @since 1.0.0
     */

    /**
     * Cache for FCM tokens to avoid repeated database reads
     * @var array
     */
    private static $fcm_token_cache = array();

    /**
     * Cache expiration time (5 minutes)
     */
    private const FCM_TOKEN_CACHE_TTL = 300;

    /**
     * Get FCM tokens for a user (with caching)
     *
     * @param int $user_id User ID
     * @return array Array of tokens with platform info
     */
    private function get_user_fcm_tokens($user_id)
    {
        // Check cache first
        $cache_key = 'fcm_tokens_' . $user_id;
        if (isset(self::$fcm_token_cache[$cache_key])) {
            $cached = self::$fcm_token_cache[$cache_key];
            if (isset($cached['expires']) && $cached['expires'] > time()) {
                return $cached['tokens'];
            }
        }

        // Check transient cache
        $transient_key = 'twork_fcm_tokens_cache_' . $user_id;
        $cached_tokens = get_transient($transient_key);
        if ($cached_tokens !== false && is_array($cached_tokens)) {
            // Update in-memory cache
            self::$fcm_token_cache[$cache_key] = array(
                'tokens' => $cached_tokens,
                'expires' => time() + self::FCM_TOKEN_CACHE_TTL
            );
            return $cached_tokens;
        }

        // Fetch from database (single query)
        $meta_key = 'twork_fcm_tokens';
        $tokens = get_user_meta($user_id, $meta_key, true);

        // Normalize tokens array
        if (!is_array($tokens)) {
            $tokens = array();
        }

        // Filter out invalid/expired tokens (older than 30 days)
        $valid_tokens = array();
        $thirty_days_ago = time() - (30 * DAY_IN_SECONDS);

        foreach ($tokens as $token_data) {
            if (!isset($token_data['token']) || empty($token_data['token'])) {
                continue;
            }

            // Check if token is too old (optional cleanup)
            $updated_at = isset($token_data['updated_at']) ? (int) $token_data['updated_at'] : 0;
            if ($updated_at > 0 && $updated_at < $thirty_days_ago) {
                continue;  // Skip very old tokens
            }

            $valid_tokens[] = array(
                'token' => sanitize_text_field($token_data['token']),
                'platform' => isset($token_data['platform']) ? sanitize_text_field($token_data['platform']) : 'android',
            );
        }

        // Update caches
        self::$fcm_token_cache[$cache_key] = array(
            'tokens' => $valid_tokens,
            'expires' => time() + self::FCM_TOKEN_CACHE_TTL
        );
        set_transient($transient_key, $valid_tokens, self::FCM_TOKEN_CACHE_TTL);

        return $valid_tokens;
    }

    /**
     * Invalidate FCM token cache for a user
     *
     * @param int $user_id User ID
     */
    private function invalidate_fcm_token_cache($user_id)
    {
        $cache_key = 'fcm_tokens_' . $user_id;
        unset(self::$fcm_token_cache[$cache_key]);
        delete_transient('twork_fcm_tokens_cache_' . $user_id);
    }

    /**
     * Send professional FCM notification for engagement hub events
     *
     * PROFESSIONAL ENGAGEMENT NOTIFICATIONS: Handles all engagement hub activities
     * including quiz submissions, poll votes, banner views, announcements, number views, and new item notifications
     *
     * @param int $user_id User ID
     * @param string $type Notification type: 'engagement_quiz_submitted', 'engagement_poll_submitted',
     *                     'engagement_banner_viewed', 'engagement_announcement_viewed', 'engagement_number_viewed', 'engagement_new_item'
     * @param array $data Notification data
     * @return bool Success status
     */
    private function send_engagement_fcm_notification($user_id, $type, $data = array())
    {
        // Validate user ID
        if (empty($user_id) || !is_numeric($user_id)) {
            return false;
        }

        // PROFESSIONAL INTEGRATION: Check if FCM notify plugin is available
        if (!$this->is_fcm_plugin_available()) {
            // Fallback to webhook if FCM plugin not available
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: FCM plugin not available for engagement notification, using webhook fallback');
            }
            return $this->send_engagement_fcm_notification_via_webhook($user_id, $type, $data);
        }

        // Rate limiting: Prevent duplicate notifications within 30 seconds
        $item_id = isset($data['item_id']) ? absint($data['item_id']) : 0;
        $rate_limit_key = 'twork_engagement_fcm_' . $type . '_' . $user_id . '_' . $item_id;
        $last_sent = get_transient($rate_limit_key);

        if ($last_sent !== false) {
            return true;  // Already sent recently
        }

        // Get FCM tokens (cached)
        $tokens = $this->get_user_fcm_tokens($user_id);

        if (empty($tokens)) {
            // Enhanced logging for missing tokens
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf(
                    'T-Work Rewards: No FCM tokens found for user %d (engagement notification type: %s). User may need to open the mobile app to register device.',
                    $user_id,
                    $type
                ));
            }
            return false;  // No tokens available
        }

        // Prepare notification content based on type
        $notification_content = $this->prepare_engagement_notification_content($type, $data, $user_id);

        if (empty($notification_content)) {
            return false;  // Invalid content
        }

        // Send notification to all tokens using FCM notify plugin's function
        $success_count = 0;
        $error_count = 0;
        $errors = array();

        foreach ($tokens as $token_data) {
            if (isset($token_data['token']) && !empty($token_data['token'])) {
                try {
                    // Use FCM notify plugin's function directly
                    $result = twork_send_fcm(
                        $token_data['token'],
                        $notification_content['title'],
                        $notification_content['body'],
                        $notification_content['data']
                    );

                    // Check if function returned success (some implementations return boolean)
                    if ($result === true || $result === null) {
                        $success_count++;
                    } else {
                        $error_count++;
                        $errors[] = 'Token failed: ' . substr($token_data['token'], 0, 20) . '...';
                    }
                } catch (Exception $e) {
                    $error_count++;
                    $errors[] = 'Exception: ' . $e->getMessage();
                    if (defined('WP_DEBUG') && WP_DEBUG) {
                        error_log('T-Work Rewards: Engagement FCM notification exception: ' . $e->getMessage());
                    }
                } catch (Error $e) {
                    $error_count++;
                    $errors[] = 'Error: ' . $e->getMessage();
                    if (defined('WP_DEBUG') && WP_DEBUG) {
                        error_log('T-Work Rewards: Engagement FCM notification error: ' . $e->getMessage());
                    }
                }
            }
        }

        // Set rate limit (30 seconds)
        set_transient($rate_limit_key, time(), 30);

        // Enhanced logging for debugging
        if (defined('WP_DEBUG') && WP_DEBUG) {
            if ($success_count > 0) {
                error_log(sprintf(
                    'T-Work Rewards: Engagement FCM notification sent. Type: %s, User: %d, Success: %d, Errors: %d',
                    $type,
                    $user_id,
                    $success_count,
                    $error_count
                ));
            }
            if ($error_count > 0 && !empty($errors)) {
                error_log('T-Work Rewards: Engagement FCM notification errors: ' . implode(', ', array_slice($errors, 0, 3)));
            }
        }

        // Log if no tokens were processed
        if (empty($tokens)) {
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf(
                    'T-Work Rewards: No FCM tokens found for user %d (engagement notification type: %s)',
                    $user_id,
                    $type
                ));
            }
        }

        return $success_count > 0;
    }

    /**
     * Fallback: Send engagement FCM notification via webhook (if FCM plugin not available)
     *
     * @param int $user_id User ID
     * @param string $type Notification type
     * @param array $data Notification data
     * @return bool Success status
     */
    private function send_engagement_fcm_notification_via_webhook($user_id, $type, $data = array())
    {
        // Get webhook URL
        $webhook_base_url = get_option('twork_rewards_webhook_url', '');
        if (empty($webhook_base_url) || !is_string($webhook_base_url)) {
            return false;
        }

        // Build full webhook URL for engagement event endpoint
        $webhook_url = rtrim($webhook_base_url, '/') . '/api/webhook/engagement-event';

        // Rate limiting: Prevent duplicate notifications within 30 seconds
        $item_id = isset($data['item_id']) ? absint($data['item_id']) : 0;
        $rate_limit_key = 'twork_engagement_fcm_webhook_' . $type . '_' . $user_id . '_' . $item_id;
        $last_sent = get_transient($rate_limit_key);

        if ($last_sent !== false) {
            return true;  // Already sent recently
        }

        // Prepare payload
        $payload = $this->prepare_engagement_notification_payload($type, $data, $user_id);

        if (empty($payload)) {
            return false;
        }

        // Send notification via webhook (non-blocking)
        $response = wp_remote_post($webhook_url, array(
            'method' => 'POST',
            'timeout' => 10,  // Increased timeout for better reliability
            'redirection' => 0,
            'httpversion' => '1.1',
            'headers' => array(
                'Content-Type' => 'application/json',
                'User-Agent' => 'T-Work-Rewards-Plugin/1.0',
            ),
            'body' => wp_json_encode($payload),
            'blocking' => false,
            'sslverify' => true,
        ));

        // Set rate limit (30 seconds)
        set_transient($rate_limit_key, time(), 30);

        // Enhanced error logging for debugging
        if (is_wp_error($response)) {
            $error_message = $response->get_error_message();
            $error_code = $response->get_error_code();

            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf(
                    'T-Work Rewards: Engagement webhook notification error. Type: %s, User: %d, Error: %s (Code: %s), URL: %s',
                    $type,
                    $user_id,
                    $error_message,
                    $error_code,
                    $webhook_url
                ));
            }
            return false;
        }

        // Check HTTP response code (even for non-blocking requests)
        $response_code = wp_remote_retrieve_response_code($response);
        if ($response_code && ($response_code < 200 || $response_code >= 300)) {
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf(
                    'T-Work Rewards: Engagement webhook notification returned error code. Type: %s, User: %d, HTTP Code: %d, URL: %s',
                    $type,
                    $user_id,
                    $response_code,
                    $webhook_url
                ));
            }
            return false;
        }

        // Log success for debugging
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log(sprintf(
                'T-Work Rewards: Engagement webhook notification sent successfully. Type: %s, User: %d, URL: %s',
                $type,
                $user_id,
                $webhook_url
            ));
        }

        return true;
    }

    /**
     * Notify all active users about a new engagement item
     *
     * PROFESSIONAL ENGAGEMENT NOTIFICATIONS: Broadcasts new engagement items to all users
     * Uses efficient batch processing to minimize database load
     *
     * @param int $item_id Engagement item ID
     * @param string $item_type Item type (quiz, poll, banner, announcement)
     * @param string $item_title Item title
     * @param int $reward_points Reward points for the item
     * @return void
     */
    private function notify_users_about_new_engagement_item($item_id, $item_type, $item_title, $reward_points, $additional_data = array())
    {
        // Only notify for active items
        if (empty($item_id) || empty($item_type)) {
            return;
        }

        // Get all users with FCM tokens (active users)
        // Use efficient query to get users with tokens
        global $wpdb;
        $users_with_tokens = $wpdb->get_col(
            "SELECT DISTINCT user_id 
             FROM {$wpdb->usermeta} 
             WHERE meta_key = 'twork_fcm_tokens' 
             AND meta_value != '' 
             AND meta_value != 'a:0:{}'
             LIMIT 1000"
        );

        if (empty($users_with_tokens)) {
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: No users with FCM tokens found for new engagement item notification');
            }
            return;
        }

        // Send notification to each user (non-blocking)
        $notified_count = 0;
        foreach ($users_with_tokens as $user_id) {
            $user_id = absint($user_id);
            if ($user_id <= 0) {
                continue;
            }

            // Send notification (non-blocking, uses rate limiting internally)
            // PROFESSIONAL FIX: Include additional data (like number_value for number type)
            $notification_data = array_merge(array(
                'item_id' => $item_id,
                'item_type' => $item_type,
                'item_title' => $item_title,
                'points_awarded' => $reward_points,
            ), $additional_data);

            $sent = $this->send_engagement_fcm_notification(
                $user_id,
                'engagement_new_item',
                $notification_data
            );

            if ($sent) {
                $notified_count++;
            }
        }

        // Log for debugging
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log(sprintf(
                'T-Work Rewards: New engagement item notification sent. Item ID: %d, Type: %s, Notified: %d users',
                $item_id,
                $item_type,
                $notified_count
            ));
        }
    }

    /**
     * PROFESSIONAL ENGAGEMENT NOTIFICATIONS: Broadcasts updated engagement items to all users
     * Notifies users when existing engagement items are updated (content, points, etc.)
     *
     * @param int $item_id Engagement item ID
     * @param string $item_type Item type (quiz, poll, banner, announcement, number)
     * @param string $item_title Item title
     * @param int $reward_points Reward points for the item
     * @param array $additional_data Additional data for notification (optional)
     * @return void
     */
    private function notify_users_about_updated_engagement_item($item_id, $item_type, $item_title, $reward_points, $additional_data = array())
    {
        // Only notify for active items
        if (empty($item_id) || empty($item_type)) {
            return;
        }

        // Get all users with FCM tokens (active users)
        global $wpdb;
        $users_with_tokens = $wpdb->get_col(
            "SELECT DISTINCT user_id 
             FROM {$wpdb->usermeta} 
             WHERE meta_key = 'twork_fcm_tokens' 
             AND meta_value != '' 
             AND meta_value != 'a:0:{}'
             LIMIT 1000"
        );

        if (empty($users_with_tokens)) {
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: No users with FCM tokens found for updated engagement item notification');
            }
            return;
        }

        // Send notification to each user (non-blocking)
        $notified_count = 0;
        foreach ($users_with_tokens as $user_id) {
            $user_id = absint($user_id);
            if ($user_id <= 0) {
                continue;
            }

            // Send notification (non-blocking, uses rate limiting internally)
            // PROFESSIONAL FIX: Use 'engagement_item_updated' type for updates
            $notification_data = array_merge(array(
                'item_id' => $item_id,
                'item_type' => $item_type,
                'item_title' => $item_title,
                'points_awarded' => $reward_points,
            ), $additional_data);

            $sent = $this->send_engagement_fcm_notification(
                $user_id,
                'engagement_item_updated',
                $notification_data
            );

            if ($sent) {
                $notified_count++;
            }
        }

        // Log for debugging
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log(sprintf(
                'T-Work Rewards: Updated engagement item notification sent. Item ID: %d, Type: %s, Notified: %d users',
                $item_id,
                $item_type,
                $notified_count
            ));
        }
    }

    /**
     * Send professional FCM notification for point events
     *
     * PROFESSIONAL INTEGRATION: Uses twork-fcm-notify plugin's twork_send_fcm() function
     * for direct FCM sending (more efficient than webhook approach)
     *
     * @param int $user_id User ID
     * @param string $type Notification type: 'points_earned', 'points_approved', 'points_redeemed', 'exchange_approved', 'exchange_rejected', 'engagement_points'
     * @param array $data Notification data
     * @return bool Success status
     */
    private function send_points_fcm_notification($user_id, $type, $data = array())
    {
        // Validate user ID
        if (empty($user_id) || !is_numeric($user_id)) {
            return false;
        }

        // PROFESSIONAL INTEGRATION: Check if FCM notify plugin is available
        // Prefer direct FCM sending (more efficient) over webhook approach
        if (!$this->is_fcm_plugin_available()) {
            // Fallback to webhook if FCM plugin not available
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: FCM plugin not available, using webhook fallback');
            }
            return $this->send_points_fcm_notification_via_webhook($user_id, $type, $data);
        }

        // Rate limiting: Prevent duplicate notifications within 30 seconds
        $rate_limit_key = 'twork_points_fcm_' . $type . '_' . $user_id . '_' . (isset($data['transaction_id']) ? $data['transaction_id'] : (isset($data['request_id']) ? $data['request_id'] : ''));
        $last_sent = get_transient($rate_limit_key);

        if ($last_sent !== false) {
            return true;  // Already sent recently
        }

        // Get FCM tokens (cached)
        $tokens = $this->get_user_fcm_tokens($user_id);

        if (empty($tokens)) {
            // Enhanced logging for missing tokens
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf(
                    'T-Work Rewards: No FCM tokens found for user %d (notification type: %s). User may need to open the mobile app to register device.',
                    $user_id,
                    $type
                ));
            }
            return false;  // No tokens available
        }

        // Prepare notification content based on type
        $notification_content = $this->prepare_points_notification_content($type, $data, $user_id);

        if (empty($notification_content)) {
            return false;  // Invalid content
        }

        // Send notification to all tokens using FCM notify plugin's function
        $success_count = 0;
        $error_count = 0;
        $errors = array();

        foreach ($tokens as $token_data) {
            if (isset($token_data['token']) && !empty($token_data['token'])) {
                try {
                    // Use FCM notify plugin's function directly
                    $result = twork_send_fcm(
                        $token_data['token'],
                        $notification_content['title'],
                        $notification_content['body'],
                        $notification_content['data']
                    );

                    // Check if function returned success (some implementations return boolean)
                    if ($result === true || $result === null) {
                        $success_count++;
                    } else {
                        $error_count++;
                        $errors[] = 'Token failed: ' . substr($token_data['token'], 0, 20) . '...';
                    }
                } catch (Exception $e) {
                    $error_count++;
                    $errors[] = 'Exception: ' . $e->getMessage();
                    if (defined('WP_DEBUG') && WP_DEBUG) {
                        error_log('T-Work Rewards: FCM notification exception: ' . $e->getMessage());
                    }
                } catch (Error $e) {
                    $error_count++;
                    $errors[] = 'Error: ' . $e->getMessage();
                    if (defined('WP_DEBUG') && WP_DEBUG) {
                        error_log('T-Work Rewards: FCM notification error: ' . $e->getMessage());
                    }
                }
            }
        }

        // Set rate limit (30 seconds)
        set_transient($rate_limit_key, time(), 30);

        // Enhanced logging for debugging
        if (defined('WP_DEBUG') && WP_DEBUG) {
            if ($success_count > 0) {
                error_log(sprintf(
                    'T-Work Rewards: FCM notification sent via FCM plugin. Type: %s, User: %d, Success: %d, Errors: %d',
                    $type,
                    $user_id,
                    $success_count,
                    $error_count
                ));
            }
            if ($error_count > 0 && !empty($errors)) {
                error_log('T-Work Rewards: FCM notification errors: ' . implode(', ', array_slice($errors, 0, 3)));
            }
        }

        // Log if no tokens were processed
        if (empty($tokens)) {
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf(
                    'T-Work Rewards: No FCM tokens found for user %d (notification type: %s)',
                    $user_id,
                    $type
                ));
            }
        }

        return $success_count > 0;
    }

    /**
     * Fallback: Send FCM notification via webhook (if FCM plugin not available)
     *
     * @param int $user_id User ID
     * @param string $type Notification type
     * @param array $data Notification data
     * @return bool Success status
     */
    private function send_points_fcm_notification_via_webhook($user_id, $type, $data = array())
    {
        // Get webhook URL
        $webhook_base_url = get_option('twork_rewards_webhook_url', '');
        if (empty($webhook_base_url) || !is_string($webhook_base_url)) {
            return false;
        }

        // Build full webhook URL for points event endpoint
        $webhook_url = rtrim($webhook_base_url, '/') . '/api/webhook/points-event';

        // Validate URL format
        if (!filter_var($webhook_url, FILTER_VALIDATE_URL)) {
            return false;
        }

        // Prevent self-referencing URLs
        $site_url = site_url();
        $parsed_webhook = parse_url($webhook_url);
        $parsed_site = parse_url($site_url);

        if ($parsed_webhook && $parsed_site) {
            $webhook_host = strtolower(trim($parsed_webhook['host'], '/'));
            $site_host = strtolower(trim($parsed_site['host'], '/'));

            if ($webhook_host === $site_host ||
                    $webhook_host === 'localhost' ||
                    $webhook_host === '127.0.0.1' ||
                    strpos($webhook_host, '.local') !== false) {
                return false;
            }
        }

        // Rate limiting
        $rate_limit_key = 'twork_points_fcm_' . $type . '_' . $user_id . '_' . (isset($data['transaction_id']) ? $data['transaction_id'] : '');
        $last_sent = get_transient($rate_limit_key);

        if ($last_sent !== false) {
            return true;
        }

        // Prepare notification payload
        $payload = $this->prepare_points_notification_payload($type, $data, $user_id);

        if (empty($payload)) {
            return false;
        }

        // Send notification via webhook (non-blocking)
        $response = wp_remote_post($webhook_url, array(
            'method' => 'POST',
            'timeout' => 10,  // Increased timeout for better reliability
            'redirection' => 0,
            'httpversion' => '1.1',
            'headers' => array(
                'Content-Type' => 'application/json',
                'User-Agent' => 'T-Work-Rewards-Plugin/1.0',
            ),
            'body' => wp_json_encode($payload),
            'blocking' => false,
            'sslverify' => true,
        ));

        // Set rate limit (30 seconds)
        set_transient($rate_limit_key, time(), 30);

        // Enhanced error logging for debugging
        if (is_wp_error($response)) {
            $error_message = $response->get_error_message();
            $error_code = $response->get_error_code();

            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf(
                    'T-Work Rewards: Webhook notification error. Type: %s, User: %d, Error: %s (Code: %s), URL: %s',
                    $type,
                    $user_id,
                    $error_message,
                    $error_code,
                    $webhook_url
                ));
            }
            return false;
        }

        // Check HTTP response code (even for non-blocking requests)
        $response_code = wp_remote_retrieve_response_code($response);
        if ($response_code && ($response_code < 200 || $response_code >= 300)) {
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf(
                    'T-Work Rewards: Webhook notification returned error code. Type: %s, User: %d, HTTP Code: %d, URL: %s',
                    $type,
                    $user_id,
                    $response_code,
                    $webhook_url
                ));
            }
            return false;
        }

        // Log success for debugging
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log(sprintf(
                'T-Work Rewards: Webhook notification sent successfully. Type: %s, User: %d, URL: %s',
                $type,
                $user_id,
                $webhook_url
            ));
        }

        return true;
    }

    /**
     * Prepare notification content (title, body, data) for FCM notify plugin
     *
     * @param string $type Notification type
     * @param array $data Event data
     * @param int $user_id User ID
     * @return array|null Prepared content or null if invalid
     */
    private function prepare_points_notification_content($type, $data, $user_id)
    {
        // Get current balance (cached calculation)
        $current_balance = $this->calculate_points_balance_from_transactions($user_id);

        $points = isset($data['points']) ? absint($data['points']) : (isset($data['points_value']) ? absint($data['points_value']) : 0);
        $transaction_id = isset($data['transaction_id']) ? absint($data['transaction_id']) : 0;
        $request_id = isset($data['request_id']) ? absint($data['request_id']) : 0;
        $description = isset($data['description']) ? sanitize_text_field($data['description']) : '';
        $item_type = isset($data['item_type']) ? sanitize_text_field($data['item_type']) : '';
        $item_title = isset($data['item_title']) ? sanitize_text_field($data['item_title']) : '';
        $reason = isset($data['reason']) ? sanitize_text_field($data['reason']) : '';

        $base_data = array(
            'type' => $type,
            'userId' => (string) $user_id,
            'currentBalance' => (string) $current_balance,
        );

        switch ($type) {
            case 'points_earned':
                if ($points <= 0) {
                    return null;
                }
                $formatted_balance = number_format($current_balance);
                return array(
                    'title' => sprintf('ðŸŽ‰ Congratulations! %d PNP Earned', $points),
                    'body' => $description ?: sprintf("Great news! You've earned %d PNP. Your current balance is %s PNP.", $points, $formatted_balance),
                    'data' => array_merge($base_data, array(
                        'transactionId' => $transaction_id > 0 ? (string) $transaction_id : '',
                        'points' => (string) $points,
                        'description' => $description,
                    )),
                );

            case 'points_approved':
                if ($points <= 0 || $transaction_id <= 0) {
                    return null;
                }
                $formatted_balance = number_format($current_balance);
                return array(
                    'title' => sprintf('âœ… %d PNP Successfully Approved', $points),
                    'body' => $description ?: sprintf('Your %d PNP transaction has been approved and added to your account. Current balance: %s PNP.', $points, $formatted_balance),
                    'data' => array_merge($base_data, array(
                        'transactionId' => (string) $transaction_id,
                        'points' => (string) $points,
                        'description' => $description,
                    )),
                );

            case 'points_redeemed':
                if ($points <= 0) {
                    return null;
                }
                $formatted_balance = number_format($current_balance);
                return array(
                    'title' => 'ðŸ’Ž Exchange Request Submitted',
                    'body' => $description ?: sprintf('Your exchange request for %d PNP has been submitted and is pending review. Your balance: %s PNP.', $points, $formatted_balance),
                    'data' => array_merge($base_data, array(
                        'requestId' => $request_id > 0 ? (string) $request_id : '',
                        'points' => (string) $points,
                        'description' => $description,
                    )),
                );

            case 'exchange_approved':
                if ($request_id <= 0) {
                    return null;
                }
                return array(
                    'title' => 'âœ… Exchange Request Approved',
                    'body' => $description ?: 'Your exchange request has been approved and is being processed. You will receive your reward shortly.',
                    'data' => array_merge($base_data, array(
                        'requestId' => (string) $request_id,
                        'points' => $points > 0 ? (string) $points : '',
                        'description' => $description,
                    )),
                );

            case 'exchange_rejected':
                if ($request_id <= 0) {
                    return null;
                }
                $formatted_balance = number_format($current_balance);

                // If points > 0, clearly communicate that PNP have been refunded.
                // If points == 0, avoid saying "refunded" to prevent confusion when balance is unchanged.
                if ($points > 0) {
                    $rejection_message = $reason
                        ? sprintf('Your exchange request was not approved. Reason: %s. Your %d PNP have been refunded to your account.', $reason, $points)
                        : sprintf('Your exchange request was not approved. Your %d PNP have been refunded. Current balance: %s PNP.', $points, $formatted_balance);
                } else {
                    $rejection_message = $reason
                        ? sprintf('Your exchange request was not approved. Reason: %s. Your PNP balance remains unchanged.', $reason)
                        : sprintf('Your exchange request was not approved. Your PNP balance remains unchanged. Current balance: %s PNP.', $formatted_balance);
                }

                return array(
                    'title' => 'âš ï¸ Exchange Request Update',
                    'body' => $description ?: $rejection_message,
                    'data' => array_merge($base_data, array(
                        'requestId' => (string) $request_id,
                        'points' => $points > 0 ? (string) $points : '',
                        'reason' => $reason,
                        'description' => $description,
                    )),
                );

            case 'engagement_points':
                if ($points <= 0) {
                    return null;
                }
                $activity_name = $item_title ?: $item_type ?: 'this activity';
                $formatted_balance = number_format($current_balance);
                return array(
                    'title' => sprintf('ðŸŽ¯ %d PNP from Activity', $points),
                    'body' => $description ?: sprintf('Thank you for your participation! You earned %d PNP from %s. Your balance is now %s PNP.', $points, $activity_name, $formatted_balance),
                    'data' => array_merge($base_data, array(
                        'points' => (string) $points,
                        'itemType' => $item_type,
                        'itemTitle' => $item_title,
                        'description' => $description,
                    )),
                );

            case 'points_adjusted':
                if ($points <= 0) {
                    return null;
                }
                $is_positive = isset($data['is_positive']) ? (bool) $data['is_positive'] : true;
                $adjust_type = $is_positive ? 'increased' : 'decreased';
                $adjust_verb = $is_positive ? 'added' : 'deducted';
                $formatted_balance = number_format($current_balance);

                return array(
                    'title' => 'ðŸ“Š Points Balance Adjusted',
                    'body' => $description ?: sprintf('Your points balance has been %s. %d PNP has been %s. Your current balance is %s PNP.', $adjust_type, $points, $adjust_verb, $formatted_balance),
                    'data' => array_merge($base_data, array(
                        'transactionId' => $transaction_id > 0 ? (string) $transaction_id : '',
                        'points' => (string) $points,
                        'description' => $description,
                        'isPositive' => $is_positive ? '1' : '0',
                    )),
                );

            default:
                return null;
        }
    }

    /**
     * Prepare notification payload based on event type
     *
     * @param string $type Notification type
     * @param array $data Event data
     * @param int $user_id User ID
     * @return array|null Prepared payload or null if invalid
     */
    private function prepare_points_notification_payload($type, $data, $user_id)
    {
        // Get current balance (cached calculation)
        $current_balance = $this->calculate_points_balance_from_transactions($user_id);

        $base_payload = array(
            'userId' => (string) $user_id,
            'type' => $type,
            'timestamp' => current_time('mysql'),
        );

        switch ($type) {
            case 'points_earned':
            case 'points_approved':
                $points = isset($data['points']) ? absint($data['points']) : (isset($data['points_value']) ? absint($data['points_value']) : 0);
                $transaction_id = isset($data['transaction_id']) ? absint($data['transaction_id']) : 0;
                $description = isset($data['description']) ? sanitize_text_field($data['description']) : '';

                if ($points <= 0 || $transaction_id <= 0) {
                    return null;
                }

                return array_merge($base_payload, array(
                    'transactionId' => (string) $transaction_id,
                    'points' => (string) $points,
                    'currentBalance' => (string) $current_balance,
                    'description' => $description ?: sprintf('You earned %d points', $points),
                ));

            case 'points_redeemed':
                $points = isset($data['points']) ? absint($data['points']) : (isset($data['points_value']) ? absint($data['points_value']) : 0);
                $request_id = isset($data['request_id']) ? absint($data['request_id']) : 0;

                if ($points <= 0) {
                    return null;
                }

                return array_merge($base_payload, array(
                    'requestId' => $request_id > 0 ? (string) $request_id : '',
                    'points' => (string) $points,
                    'currentBalance' => (string) $current_balance,
                    'description' => sprintf('You redeemed %d points', $points),
                ));

            case 'exchange_approved':
                $points = isset($data['points']) ? absint($data['points']) : (isset($data['points_value']) ? absint($data['points_value']) : 0);
                $request_id = isset($data['request_id']) ? absint($data['request_id']) : 0;

                if ($request_id <= 0) {
                    return null;
                }

                return array_merge($base_payload, array(
                    'requestId' => (string) $request_id,
                    'points' => $points > 0 ? (string) $points : '',
                    'currentBalance' => (string) $current_balance,
                    'description' => 'Your exchange request has been approved',
                ));

            case 'exchange_rejected':
                $points = isset($data['points']) ? absint($data['points']) : (isset($data['points_value']) ? absint($data['points_value']) : 0);
                $request_id = isset($data['request_id']) ? absint($data['request_id']) : 0;
                $reason = isset($data['reason']) ? sanitize_text_field($data['reason']) : '';

                if ($request_id <= 0) {
                    return null;
                }

                return array_merge($base_payload, array(
                    'requestId' => (string) $request_id,
                    'points' => $points > 0 ? (string) $points : '',
                    'currentBalance' => (string) $current_balance,
                    'description' => $reason ?: 'Your exchange request has been rejected',
                    'reason' => $reason,
                ));

            case 'engagement_points':
                $points = isset($data['points']) ? absint($data['points']) : 0;
                $item_type = isset($data['item_type']) ? sanitize_text_field($data['item_type']) : '';
                $item_title = isset($data['item_title']) ? sanitize_text_field($data['item_title']) : '';

                if ($points <= 0) {
                    return null;
                }

                return array_merge($base_payload, array(
                    'points' => (string) $points,
                    'currentBalance' => (string) $current_balance,
                    'itemType' => $item_type,
                    'itemTitle' => $item_title,
                    'description' => sprintf('You earned %d points from %s', $points, $item_title ?: 'engagement activity'),
                ));

            case 'points_adjusted':
                $points = isset($data['points']) ? absint($data['points']) : (isset($data['points_value']) ? absint($data['points_value']) : 0);
                $transaction_id = isset($data['transaction_id']) ? absint($data['transaction_id']) : 0;
                $description = isset($data['description']) ? sanitize_text_field($data['description']) : '';
                $is_positive = isset($data['is_positive']) ? (bool) $data['is_positive'] : true;

                if ($points <= 0) {
                    return null;
                }

                return array_merge($base_payload, array(
                    'transactionId' => $transaction_id > 0 ? (string) $transaction_id : '',
                    'points' => (string) $points,
                    'currentBalance' => (string) $current_balance,
                    'description' => $description ?: sprintf('Your points have been %s by %d points', $is_positive ? 'increased' : 'decreased', $points),
                    'isPositive' => $is_positive ? '1' : '0',
                ));

            default:
                return null;
        }
    }

    /**
     * Prepare professional engagement notification content (title, body, data)
     *
     * PROFESSIONAL ENGAGEMENT NOTIFICATIONS: Creates user-friendly, professional messages
     * for all engagement hub activities with proper context and encouragement
     *
     * @param string $type Notification type
     * @param array $data Event data
     * @param int $user_id User ID
     * @return array|null Prepared content or null if invalid
     */
    private function prepare_engagement_notification_content($type, $data, $user_id)
    {
        // Get current balance (cached calculation)
        $current_balance = $this->calculate_points_balance_from_transactions($user_id);

        $item_id = isset($data['item_id']) ? absint($data['item_id']) : 0;
        $item_type = isset($data['item_type']) ? sanitize_text_field($data['item_type']) : '';
        $item_title = isset($data['item_title']) ? sanitize_text_field($data['item_title']) : '';
        $points_awarded = isset($data['points_awarded']) ? absint($data['points_awarded']) : 0;
        $is_correct = isset($data['is_correct']) ? (bool) $data['is_correct'] : false;

        $base_data = array(
            'type' => $type,
            'userId' => (string) $user_id,
            'currentBalance' => (string) $current_balance,
            'itemId' => $item_id > 0 ? (string) $item_id : '',
            'itemType' => $item_type,
            'itemTitle' => $item_title,
        );

        switch ($type) {
            case 'engagement_quiz_submitted':
                $formatted_balance = number_format($current_balance);
                if ($is_correct && $points_awarded > 0) {
                    return array(
                        'title' => sprintf('ðŸŽ‰ Great Job! %d PNP Earned', $points_awarded),
                        'body' => sprintf('Congratulations! Your answer to "%s" was correct. You earned %d PNP. Your balance is now %s PNP.',
                            $item_title ?: 'the quiz',
                            $points_awarded,
                            $formatted_balance),
                        'data' => array_merge($base_data, array(
                            'points' => (string) $points_awarded,
                            'isCorrect' => '1',
                        )),
                    );
                } else {
                    return array(
                        'title' => 'ðŸ’ª Keep Trying!',
                        'body' => sprintf('Thank you for participating in "%s"! Your answer wasn\'t quite right this time, but keep engaging to earn more points. Your current balance: %s PNP.',
                            $item_title ?: 'the quiz',
                            $formatted_balance),
                        'data' => array_merge($base_data, array(
                            'points' => '0',
                            'isCorrect' => '0',
                        )),
                    );
                }

            case 'engagement_poll_submitted':
                $formatted_balance = number_format($current_balance);
                if ($points_awarded > 0) {
                    return array(
                        'title' => sprintf('âœ… Vote Recorded! %d PNP Earned', $points_awarded),
                        'body' => sprintf('Thank you for voting on "%s"! Your opinion matters. You earned %d PNP for participating. Your balance is now %s PNP.',
                            $item_title ?: 'the poll',
                            $points_awarded,
                            $formatted_balance),
                        'data' => array_merge($base_data, array(
                            'points' => (string) $points_awarded,
                        )),
                    );
                } else {
                    return array(
                        'title' => 'âœ… Vote Recorded!',
                        'body' => sprintf('Thank you for voting on "%s"! Your opinion helps us improve. Your current balance: %s PNP.',
                            $item_title ?: 'the poll',
                            $formatted_balance),
                        'data' => array_merge($base_data, array(
                            'points' => '0',
                        )),
                    );
                }

            case 'engagement_banner_viewed':
                return array(
                    'title' => 'ðŸ“¢ New Content Available',
                    'body' => sprintf('Check out our latest banner: "%s". Tap to view and discover exciting offers!',
                        $item_title ?: 'Special Offer'),
                    'data' => $base_data,
                );

            case 'engagement_announcement_viewed':
                return array(
                    'title' => 'ðŸ“¢ Important Announcement',
                    'body' => sprintf('New announcement: "%s". Stay informed with the latest updates!',
                        $item_title ?: 'Important Update'),
                    'data' => $base_data,
                );

            case 'engagement_number_viewed':
                $number_value = isset($data['number_value']) ? sanitize_text_field($data['number_value']) : '';
                $number_display = $number_value ? sprintf(' (Number: %s)', $number_value) : '';
                $formatted_balance = number_format($current_balance);

                if ($points_awarded > 0) {
                    return array(
                        'title' => sprintf('ðŸ”¢ Number Challenge Viewed! %d PNP Earned', $points_awarded),
                        'body' => sprintf('You viewed the Number challenge: "%s"%s. You earned %d PNP! Your balance is now %s PNP.',
                            $item_title ?: 'Number Challenge',
                            $number_display,
                            $points_awarded,
                            $formatted_balance),
                        'data' => array_merge($base_data, array(
                            'points' => (string) $points_awarded,
                            'numberValue' => $number_value,
                        )),
                    );
                } else {
                    return array(
                        'title' => 'ðŸ”¢ Number Challenge Viewed',
                        'body' => sprintf('You viewed the Number challenge: "%s"%s. Keep engaging to earn more points! Your current balance: %s PNP.',
                            $item_title ?: 'Number Challenge',
                            $number_display,
                            $formatted_balance),
                        'data' => array_merge($base_data, array(
                            'points' => '0',
                            'numberValue' => $number_value,
                        )),
                    );
                }

            case 'engagement_new_item':
                $item_type_label = ucfirst($item_type);
                if ($item_type === 'quiz') {
                    $item_type_label = 'Quiz';
                } elseif ($item_type === 'poll') {
                    $item_type_label = 'Poll';
                } elseif ($item_type === 'banner') {
                    $item_type_label = 'Banner';
                } elseif ($item_type === 'announcement') {
                    $item_type_label = 'Announcement';
                } elseif ($item_type === 'number') {
                    $item_type_label = 'Number';
                }

                $points_text = '';
                if ($points_awarded > 0) {
                    $points_text = sprintf(' Earn up to %d PNP by participating!', $points_awarded);
                }

                // PROFESSIONAL FIX: Special message for Number type
                if ($item_type === 'number') {
                    $number_value = isset($data['number_value']) ? sanitize_text_field($data['number_value']) : '';
                    $number_display = $number_value ? sprintf(' (Number: %s)', $number_value) : '';

                    return array(
                        'title' => sprintf('ðŸ”¢ New Number Challenge Available!', $item_type_label),
                        'body' => sprintf('A new Number challenge is now available: "%s"%s.%s Check it out in the Engagement Hub!',
                            $item_title ?: 'Number Challenge',
                            $number_display,
                            $points_text),
                        'data' => array_merge($base_data, array(
                            'points' => $points_awarded > 0 ? (string) $points_awarded : '0',
                            'numberValue' => $number_value,
                            'actionUrl' => '/engagement/item/' . $item_id,  // PROFESSIONAL FIX: Add navigation URL
                        )),
                    );
                }

                return array(
                    'title' => sprintf('ðŸŽ¯ New %s Available!', $item_type_label),
                    'body' => sprintf('A new %s is now available: "%s".%s Check it out in the Engagement Hub!',
                        strtolower($item_type_label),
                        $item_title ?: 'Activity',
                        $points_text),
                    'data' => array_merge($base_data, array(
                        'points' => $points_awarded > 0 ? (string) $points_awarded : '0',
                        'actionUrl' => '/engagement/item/' . $item_id,  // PROFESSIONAL FIX: Add navigation URL
                    )),
                );

            case 'engagement_item_updated':
                $item_type_label = ucfirst($item_type);
                if ($item_type === 'quiz') {
                    $item_type_label = 'Quiz';
                } elseif ($item_type === 'poll') {
                    $item_type_label = 'Poll';
                } elseif ($item_type === 'banner') {
                    $item_type_label = 'Banner';
                } elseif ($item_type === 'announcement') {
                    $item_type_label = 'Announcement';
                } elseif ($item_type === 'number') {
                    $item_type_label = 'Number';
                }

                $points_text = '';
                if ($points_awarded > 0) {
                    $points_text = sprintf(' Earn up to %d PNP by participating!', $points_awarded);
                }

                // PROFESSIONAL FIX: Special message for Number type updates
                if ($item_type === 'number') {
                    $number_value = isset($data['number_value']) ? sanitize_text_field($data['number_value']) : '';
                    $number_display = $number_value ? sprintf(' (Number: %s)', $number_value) : '';

                    return array(
                        'title' => sprintf('ðŸ”„ Number Challenge Updated!', $item_type_label),
                        'body' => sprintf('The Number challenge "%s"%s has been updated.%s Check it out in the Engagement Hub!',
                            $item_title ?: 'Number Challenge',
                            $number_display,
                            $points_text),
                        'data' => array_merge($base_data, array(
                            'points' => $points_awarded > 0 ? (string) $points_awarded : '0',
                            'numberValue' => $number_value,
                            'actionUrl' => '/engagement/item/' . $item_id,  // PROFESSIONAL FIX: Add navigation URL
                        )),
                    );
                }

                return array(
                    'title' => sprintf('ðŸ”„ %s Updated!', $item_type_label),
                    'body' => sprintf('The %s "%s" has been updated.%s Check it out in the Engagement Hub!',
                        strtolower($item_type_label),
                        $item_title ?: 'Activity',
                        $points_text),
                    'data' => array_merge($base_data, array(
                        'points' => $points_awarded > 0 ? (string) $points_awarded : '0',
                        'actionUrl' => '/engagement/item/' . $item_id,  // PROFESSIONAL FIX: Add navigation URL
                    )),
                );

            default:
                return null;
        }
    }

    /**
     * Prepare engagement notification payload for webhook
     *
     * @param string $type Notification type
     * @param array $data Event data
     * @param int $user_id User ID
     * @return array|null Prepared payload or null if invalid
     */
    private function prepare_engagement_notification_payload($type, $data, $user_id)
    {
        // Get current balance (cached calculation)
        $current_balance = $this->calculate_points_balance_from_transactions($user_id);

        $base_payload = array(
            'userId' => (string) $user_id,
            'type' => $type,
            'timestamp' => current_time('mysql'),
        );

        $item_id = isset($data['item_id']) ? absint($data['item_id']) : 0;
        $item_type = isset($data['item_type']) ? sanitize_text_field($data['item_type']) : '';
        $item_title = isset($data['item_title']) ? sanitize_text_field($data['item_title']) : '';
        $points_awarded = isset($data['points_awarded']) ? absint($data['points_awarded']) : 0;
        $is_correct = isset($data['is_correct']) ? (bool) $data['is_correct'] : false;

        return array_merge($base_payload, array(
            'itemId' => $item_id > 0 ? (string) $item_id : '',
            'itemType' => $item_type,
            'itemTitle' => $item_title,
            'points' => (string) $points_awarded,
            'currentBalance' => (string) $current_balance,
            'isCorrect' => $is_correct ? '1' : '0',
        ));
    }

    /**
     * Send reward update notification via webhook.
     *
     * Security and performance improvements:
     * - Only uses explicitly configured webhook URLs (no auto-detection)
     * - Prevents self-referencing URLs to avoid loops
     * - Rate limiting to prevent duplicate calls
     * - Proper error handling and validation
     *
     * @param array $data Transaction data
     * @return bool Success status
     */
    private function send_reward_update_notification($data)
    {
        // Only use explicitly configured webhook URL - NO auto-detection
        $webhook_url = get_option('twork_rewards_webhook_url', '');

        // If no webhook URL is configured, silently skip (don't auto-detect)
        if (empty($webhook_url) || !is_string($webhook_url)) {
            return false;
        }

        // Validate URL format
        if (!filter_var($webhook_url, FILTER_VALIDATE_URL)) {
            return false;
        }

        // CRITICAL: Prevent self-referencing URLs to avoid infinite loops
        $site_url = site_url();
        $parsed_webhook = parse_url($webhook_url);
        $parsed_site = parse_url($site_url);

        if ($parsed_webhook && $parsed_site) {
            $webhook_host = strtolower(trim($parsed_webhook['host'], '/'));
            $site_host = strtolower(trim($parsed_site['host'], '/'));

            // Block if webhook points to same domain (prevents loops)
            if ($webhook_host === $site_host ||
                    $webhook_host === 'localhost' ||
                    $webhook_host === '127.0.0.1' ||
                    strpos($webhook_host, '.local') !== false) {
                // Log for debugging but don't make the request
                error_log('T-Work Rewards: Blocked self-referencing webhook URL: ' . $webhook_url);
                return false;
            }
        }

        // Validate required data
        $transaction_id = isset($data['transaction_id']) ? absint($data['transaction_id']) : 0;
        $user_id = isset($data['user_id']) ? absint($data['user_id']) : 0;

        if (empty($user_id) || empty($transaction_id)) {
            return false;
        }

        // Rate limiting: Prevent duplicate calls for same transaction within 60 seconds
        $rate_limit_key = 'twork_webhook_sent_' . $transaction_id;
        $last_sent = get_transient($rate_limit_key);

        if ($last_sent !== false) {
            // Already sent recently, skip to prevent duplicate calls
            return true;  // Return true as it was already sent
        }

        // Prepare payload
        $payload = array(
            'userId' => (string) $user_id,
            'transactionId' => (string) $transaction_id,
            'pointsValue' => isset($data['points_value']) ? sanitize_text_field($data['points_value']) : '',
            'status' => isset($data['status']) ? sanitize_text_field($data['status']) : 'pending',
            'timestamp' => current_time('mysql'),
        );

        // Make non-blocking request with proper timeout and error handling
        $response = wp_remote_post($webhook_url, array(
            'method' => 'POST',
            'timeout' => 5,  // Reduced from 10 to 5 seconds
            'redirection' => 0,  // Don't follow redirects
            'httpversion' => '1.1',
            'headers' => array(
                'Content-Type' => 'application/json',
                'User-Agent' => 'T-Work-Rewards-Plugin/1.0',
            ),
            'body' => wp_json_encode($payload),
            'blocking' => false,  // Non-blocking to not slow admin UI
            'sslverify' => true,  // Verify SSL certificates
        ));

        // Set rate limit transient (60 seconds) to prevent duplicate calls
        set_transient($rate_limit_key, time(), 60);

        // Log errors for debugging (but don't fail silently)
        if (is_wp_error($response)) {
            error_log('T-Work Rewards Webhook Error: ' . $response->get_error_message());
            return false;
        }

        return true;
    }

    /**
     * Send Lucky Box settings change notification via webhook.
     *
     * Notifies the app when Lucky Box is enabled/disabled (globally or per-user).
     *
     * @param array $data Settings change data
     *   - type: 'global' or 'user'
     *   - enabled: bool - whether Lucky Box is enabled
     *   - user_id: int|null - user ID (null for global, int for per-user)
     * @return bool Success status
     */
    private function send_luckybox_settings_notification($data)
    {
        // Only use explicitly configured webhook URL
        $webhook_url = get_option('twork_rewards_webhook_url', '');

        // If no webhook URL is configured, silently skip
        if (empty($webhook_url) || !is_string($webhook_url)) {
            return false;
        }

        // Validate URL format
        if (!filter_var($webhook_url, FILTER_VALIDATE_URL)) {
            return false;
        }

        // CRITICAL: Prevent self-referencing URLs to avoid infinite loops
        $site_url = site_url();
        $parsed_webhook = parse_url($webhook_url);
        $parsed_site = parse_url($site_url);

        if ($parsed_webhook && $parsed_site) {
            $webhook_host = strtolower(trim($parsed_webhook['host'], '/'));
            $site_host = strtolower(trim($parsed_site['host'], '/'));

            // Block if webhook points to same domain (prevents loops)
            if ($webhook_host === $site_host ||
                    $webhook_host === 'localhost' ||
                    $webhook_host === '127.0.0.1' ||
                    strpos($webhook_host, '.local') !== false) {
                error_log('T-Work Rewards: Blocked self-referencing webhook URL: ' . $webhook_url);
                return false;
            }
        }

        // Validate required data
        $type = isset($data['type']) ? $data['type'] : '';
        $enabled = isset($data['enabled']) ? (bool) $data['enabled'] : false;
        $user_id = isset($data['user_id']) ? absint($data['user_id']) : null;

        if (!in_array($type, array('global', 'user'), true)) {
            return false;
        }

        // Rate limiting: Prevent duplicate calls within 10 seconds
        $rate_limit_key = 'twork_luckybox_settings_' . $type . '_' . ($user_id ?: 'global');
        $last_sent = get_transient($rate_limit_key);

        if ($last_sent !== false) {
            // Already sent recently, skip to prevent duplicate calls
            return true;
        }

        // Prepare payload
        $payload = array(
            'event' => 'luckybox_settings_changed',
            'type' => $type,
            'enabled' => $enabled,
            'timestamp' => current_time('mysql'),
        );

        if ($type === 'user' && $user_id) {
            $payload['userId'] = (string) $user_id;
        } elseif ($type === 'global') {
            $payload['userId'] = null;  // Global setting affects all users
        }

        // Make non-blocking request
        $response = wp_remote_post($webhook_url, array(
            'method' => 'POST',
            'timeout' => 5,
            'redirection' => 0,
            'httpversion' => '1.1',
            'headers' => array(
                'Content-Type' => 'application/json',
                'User-Agent' => 'T-Work-Rewards-Plugin/1.0',
            ),
            'body' => wp_json_encode($payload),
            'blocking' => false,  // Non-blocking to not slow admin UI
            'sslverify' => true,
        ));

        // Set rate limit transient (10 seconds) to prevent duplicate calls
        set_transient($rate_limit_key, time(), 10);

        // Log errors for debugging
        if (is_wp_error($response)) {
            error_log('T-Work Rewards Lucky Box Settings Webhook Error: ' . $response->get_error_message());
            return false;
        }

        return true;
    }

    /**
     * Users page (show my_rewards) - Optimized for memory efficiency
     */
    public function render_users_page()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('You do not have permission to access this page.', 'twork-rewards'));
        }

        // Get User Page settings
        $settings = $this->get_user_page_settings();

        $search = isset($_GET['s']) ? sanitize_text_field(wp_unslash($_GET['s'])) : '';
        $activity_filter = isset($_GET['activity_status']) ? sanitize_text_field($_GET['activity_status']) : $settings['default_activity_filter'];
        $days_inactive_filter = isset($_GET['days_inactive']) ? intval($_GET['days_inactive']) : 0;
        $orderby = isset($_GET['orderby']) ? sanitize_text_field($_GET['orderby']) : $settings['default_sort'];
        $order = isset($_GET['order']) && strtoupper($_GET['order']) === 'ASC' ? 'ASC' : $settings['default_order'];

        // Pagination using settings
        $paged = isset($_GET['paged']) ? max(1, intval($_GET['paged'])) : 1;
        $per_page = $settings['per_page'];
        $offset = ($paged - 1) * $per_page;

        // Get inactivity threshold from settings
        $inactivity_threshold_days = apply_filters('twork_rewards_inactivity_threshold_days', $settings['inactivity_threshold']);
        $threshold_timestamp = time() - ($inactivity_threshold_days * DAY_IN_SECONDS);

        $args = array(
            'number' => $per_page,
            'offset' => $offset,
            'orderby' => 'ID',  // Default, will be sorted after if needed
            'order' => 'DESC',
            'count_total' => true,  // Enable total count for pagination
        );

        if (!empty($search)) {
            $args['search'] = '*' . $search . '*';
            $args['search_columns'] = array('user_login', 'user_email', 'display_name');
        }

        // Professional: Use meta_query for efficient filtering by activity status
        // This filters at database level instead of post-processing
        if ($activity_filter !== 'all') {
            $args['meta_query'] = array(
                'relation' => 'OR',
                array(
                    'key' => 'twork_last_activity',
                    'value' => $threshold_timestamp,
                    'compare' => $activity_filter === 'active' ? '>=' : '<',
                    'type' => 'NUMERIC',
                ),
                array(
                    'key' => 'twork_last_login',
                    'value' => $threshold_timestamp,
                    'compare' => $activity_filter === 'active' ? '>=' : '<',
                    'type' => 'NUMERIC',
                ),
            );

            // For inactive users, also include users with no activity recorded
            if ($activity_filter === 'inactive') {
                $args['meta_query'][] = array(
                    'key' => 'twork_last_activity',
                    'compare' => 'NOT EXISTS',
                );
                $args['meta_query'][] = array(
                    'key' => 'twork_last_login',
                    'compare' => 'NOT EXISTS',
                );
            }
        }

        // Filter by days inactive if specified
        if ($days_inactive_filter > 0) {
            $days_inactive_timestamp = time() - ($days_inactive_filter * DAY_IN_SECONDS);
            if (!isset($args['meta_query'])) {
                $args['meta_query'] = array();
            }
            $args['meta_query'][] = array(
                'relation' => 'AND',
                array(
                    'key' => 'twork_last_activity',
                    'value' => $days_inactive_timestamp,
                    'compare' => '<=',
                    'type' => 'NUMERIC',
                ),
            );
        }

        $user_query = new WP_User_Query($args);
        $users = $user_query->get_results();
        $total_users = $user_query->get_total();
        $total_pages = ceil($total_users / $per_page);

        // Batch load user meta to prevent N+1 queries
        $user_meta_cache = array();
        $user_activity_cache = array();
        if (!empty($users)) {
            $user_ids = array_map(function ($user) {
                return $user->ID;
            }, $users);
            global $wpdb;

            // Load all user meta in one query instead of individual calls
            // Professional: Use proper WordPress escaping for IN clauses
            $meta_keys = array(
                'my_points',
                'my_points_updated_at',
                'billing_phone',
                'billing_address_1',
                'billing_address_2',
                'billing_city',
                'billing_state',
                'billing_postcode',
                'billing_country',
                'shipping_address_1',
                'shipping_address_2',
                'shipping_city',
                'shipping_state',
                'shipping_postcode',
                'shipping_country',
                'twork_last_activity',
                'twork_last_login'
            );

            // Professional: Use $wpdb->prepare() for proper SQL injection protection
            // Build placeholders for user IDs and meta keys
            $user_ids_placeholders = implode(',', array_fill(0, count($user_ids), '%d'));
            $meta_keys_placeholders = implode(',', array_fill(0, count($meta_keys), '%s'));

            // Professional: Build query with $wpdb->prepare() for security
            $meta_query = $wpdb->prepare(
                "SELECT user_id, meta_key, meta_value 
                FROM $wpdb->usermeta 
                WHERE user_id IN ($user_ids_placeholders) 
                AND meta_key IN ($meta_keys_placeholders)",
                array_merge($user_ids, $meta_keys)
            );

            // Professional: Execute query with error handling
            $meta_results = $wpdb->get_results($meta_query);

            // Professional: Log errors if query fails (only in debug mode)
            if ($wpdb->last_error && defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: User meta query error: ' . $wpdb->last_error);
                error_log('T-Work Rewards: Query: ' . $meta_query);
            }

            // Organize meta by user_id
            if ($meta_results && is_array($meta_results)) {
                foreach ($meta_results as $meta) {
                    if (!isset($user_meta_cache[$meta->user_id])) {
                        $user_meta_cache[$meta->user_id] = array();
                    }
                    $user_meta_cache[$meta->user_id][$meta->meta_key] = $meta->meta_value;
                }
            }

            // Professional: Fallback - if cache is empty, try individual queries for debugging
            // This should rarely happen, but helps identify issues
            if (empty($user_meta_cache) && defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: User meta cache is empty. User IDs: ' . implode(', ', $user_ids));
                error_log('T-Work Rewards: Meta keys requested: ' . implode(', ', $meta_keys));
            }

            // Get activity status for all users (using enhanced method)
            foreach ($user_ids as $uid) {
                $activity_status = $this->get_user_activity_status($uid);
                $user_activity_cache[$uid] = $this->get_formatted_user_activity($uid);
                // Store full activity status for sorting
                $user_activity_cache[$uid]['_full_status'] = $activity_status;
            }

            // Professional: Sort users by activity status if requested
            if ($orderby === 'activity') {
                usort($users, function ($a, $b) use ($user_activity_cache, $order) {
                    $a_status = isset($user_activity_cache[$a->ID]['_full_status']) ? $user_activity_cache[$a->ID]['_full_status'] : array('is_active' => false, 'most_recent_activity' => 0);
                    $b_status = isset($user_activity_cache[$b->ID]['_full_status']) ? $user_activity_cache[$b->ID]['_full_status'] : array('is_active' => false, 'most_recent_activity' => 0);

                    // First sort by active/inactive
                    if ($a_status['is_active'] !== $b_status['is_active']) {
                        return $order === 'DESC'
                            ? ($a_status['is_active'] ? -1 : 1)
                            : ($a_status['is_active'] ? 1 : -1);
                    }

                    // Then sort by most recent activity
                    $a_recent = $a_status['most_recent_activity'] ?? 0;
                    $b_recent = $b_status['most_recent_activity'] ?? 0;

                    return $order === 'DESC'
                        ? ($b_recent <=> $a_recent)
                        : ($a_recent <=> $b_recent);
                });
            } elseif ($orderby === 'name') {
                usort($users, function ($a, $b) use ($order) {
                    $a_name = strtolower($a->display_name ?: $a->user_email);
                    $b_name = strtolower($b->display_name ?: $b->user_email);
                    return $order === 'DESC'
                        ? strcmp($b_name, $a_name)
                        : strcmp($a_name, $b_name);
                });
            } elseif ($orderby === 'email') {
                usort($users, function ($a, $b) use ($order) {
                    return $order === 'DESC'
                        ? strcmp(strtolower($b->user_email), strtolower($a->user_email))
                        : strcmp(strtolower($a->user_email), strtolower($b->user_email));
                });
            }
        }
        ?>
        <div class="wrap">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h1 class="wp-heading-inline"><?php esc_html_e('Users Management', 'twork-rewards'); ?></h1>
                    <p class="description" style="margin-top: 5px; color: #666;">
                        <?php esc_html_e('View and manage user activity status, points, and rewards', 'twork-rewards'); ?>
                    </p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-users', 'activity_status' => 'active'), admin_url('admin.php'))); ?>" 
                       class="button" 
                       style="background: #46b450; border-color: #46b450; color: white; font-weight: 500;">
                        <?php esc_html_e('Active Users', 'twork-rewards'); ?>
                    </a>
                    <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-users', 'activity_status' => 'inactive'), admin_url('admin.php'))); ?>" 
                       class="button" 
                       style="background: #dc3232; border-color: #dc3232; color: white; font-weight: 500;">
                        <?php esc_html_e('Inactive Users', 'twork-rewards'); ?>
                    </a>
                </div>
            </div>
            <hr class="wp-header-end" />
            
            <?php
            // Display initialization messages
            if (isset($_GET['twork_activity_init'])) {
                if ($_GET['twork_activity_init'] === 'success') {
                    $processed = isset($_GET['processed']) ? intval($_GET['processed']) : 0;
                    $updated = isset($_GET['updated']) ? intval($_GET['updated']) : 0;
                    ?>
                    <div class="notice notice-success is-dismissible" style="margin: 15px 0;">
                        <p><strong><?php esc_html_e('Activity Initialization Complete', 'twork-rewards'); ?></strong></p>
                        <p><?php
                    printf(
                        esc_html__('Processed %d users and updated activity data for %d users.', 'twork-rewards'),
                        $processed,
                        $updated
                    );
                    ?></p>
                    </div>
                    <?php
                } elseif ($_GET['twork_activity_init'] === 'processing') {
                    ?>
                    <div class="notice notice-info" style="margin: 15px 0;">
                        <p><strong><?php esc_html_e('Initializing Activity Data', 'twork-rewards'); ?></strong></p>
                        <p><?php esc_html_e('Please wait while we process users in batches. This page will automatically refresh.', 'twork-rewards'); ?></p>
                    </div>
                    <?php
                }
            }

            // Check if initialization is needed (users without activity data)
            $users_without_activity = get_users(array(
                'number' => 1,
                'meta_query' => array(
                    'relation' => 'OR',
                    array(
                        'key' => 'twork_last_activity',
                        'compare' => 'NOT EXISTS'
                    ),
                    array(
                        'key' => 'twork_last_activity',
                        'value' => '0',
                        'compare' => '='
                    )
                )
            ));

            if (!empty($users_without_activity) && !isset($_GET['twork_activity_init'])):
                ?>
            <div class="notice notice-warning" style="margin: 15px 0;">
                <p><strong><?php esc_html_e('Activity Data Initialization Required', 'twork-rewards'); ?></strong></p>
                <p><?php esc_html_e('Some users do not have activity data yet. Click the button below to initialize activity data based on their orders, transactions, and registration dates.', 'twork-rewards'); ?></p>
                <p>
                    <a href="<?php echo esc_url(wp_nonce_url(
                    add_query_arg(array(
                        'action' => 'twork_rewards_initialize_activity',
                        'batch' => 1
                    ), admin_url('admin-post.php')),
                    'twork_rewards_initialize_activity'
                )); ?>" 
                       class="button button-primary">
                        <?php esc_html_e('Initialize Activity Data', 'twork-rewards'); ?>
                    </a>
                </p>
            </div>
            <?php endif; ?>

            <?php if ($settings['show_search'] || $settings['show_filters']): ?>
            <form method="get" style="margin: 12px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <input type="hidden" name="page" value="twork-rewards-users" />
                <input type="hidden" name="orderby" value="<?php echo esc_attr($orderby); ?>" />
                <input type="hidden" name="order" value="<?php echo esc_attr($order); ?>" />
                <?php if ($settings['show_search']): ?>
                <input type="search" name="s" placeholder="<?php esc_attr_e('Search usersâ€¦', 'twork-rewards'); ?>" value="<?php echo esc_attr($search); ?>" style="flex: 1; min-width: 200px;" />
                <?php endif; ?>
                <?php if ($settings['show_filters']): ?>
                <select name="activity_status" style="min-width: 160px; padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="all" <?php selected($activity_filter, 'all'); ?>>
                        <?php esc_html_e('All Users', 'twork-rewards'); ?>
                    </option>
                    <option value="active" <?php selected($activity_filter, 'active'); ?>>
                        <?php esc_html_e('Active Users', 'twork-rewards'); ?>
                    </option>
                    <option value="inactive" <?php selected($activity_filter, 'inactive'); ?>>
                        <?php esc_html_e('Inactive Users', 'twork-rewards'); ?>
                    </option>
                </select>
                <select name="days_inactive" style="min-width: 160px; padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="0" <?php selected($days_inactive_filter, 0); ?>>
                        <?php esc_html_e('Any Days Inactive', 'twork-rewards'); ?>
                    </option>
                    <option value="7" <?php selected($days_inactive_filter, 7); ?>>
                        <?php esc_html_e('7+ Days Inactive', 'twork-rewards'); ?>
                    </option>
                    <option value="30" <?php selected($days_inactive_filter, 30); ?>>
                        <?php esc_html_e('30+ Days Inactive', 'twork-rewards'); ?>
                    </option>
                    <option value="60" <?php selected($days_inactive_filter, 60); ?>>
                        <?php esc_html_e('60+ Days Inactive', 'twork-rewards'); ?>
                    </option>
                    <option value="90" <?php selected($days_inactive_filter, 90); ?>>
                        <?php esc_html_e('90+ Days Inactive', 'twork-rewards'); ?>
                    </option>
                </select>
                <?php submit_button(__('Filter', 'twork-rewards'), 'secondary', '', false); ?>
                <?php if (!empty($search) || $activity_filter !== 'all' || $days_inactive_filter > 0): ?>
                    <a href="<?php echo esc_url(admin_url('admin.php?page=twork-rewards-users')); ?>" 
                       class="button" 
                       style="background: #666; border-color: #666; color: white;">
                        <?php esc_html_e('Clear Filters', 'twork-rewards'); ?>
                    </a>
                <?php endif; ?>
                <?php endif; // End show_filters check ?>
            </form>
            <?php endif; // End show_search || show_filters check ?>
            
            <?php
            // Display activity statistics with professional design (if enabled)
            if ($settings['show_stats']):
                $activity_stats = $this->get_activity_statistics();
                if (!empty($activity_stats)):
                $active_percentage = $activity_stats['total_count'] > 0 ? ($activity_stats['active_count'] / $activity_stats['total_count']) * 100 : 0;
                $inactive_percentage = $activity_stats['total_count'] > 0 ? ($activity_stats['inactive_count'] / $activity_stats['total_count']) * 100 : 0;
                ?>
            <style>
                .twork-activity-stats-container {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 15px;
                    margin: 20px 0;
                }
                .twork-activity-stat-card {
                    background: white;
                    border-radius: 8px;
                    padding: 20px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                    border-left: 4px solid;
                    transition: transform 0.2s, box-shadow 0.2s;
                }
                .twork-activity-stat-card:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
                }
                .twork-activity-stat-card.active {
                    border-left-color: #46b450;
                    background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
                }
                .twork-activity-stat-card.inactive {
                    border-left-color: #dc3232;
                    background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);
                }
                .twork-activity-stat-card.total {
                    border-left-color: #3b82f6;
                    background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%);
                }
                .twork-activity-stat-card.rate {
                    border-left-color: #f59e0b;
                    background: linear-gradient(135deg, #fffbeb 0%, #ffffff 100%);
                }
                .twork-activity-stat-card .stat-label {
                    font-size: 12px;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    color: #666;
                    margin-bottom: 8px;
                    font-weight: 600;
                }
                .twork-activity-stat-card .stat-label span {
                    display: none; /* Remove emoji indicators */
                }
                .twork-activity-stat-card .stat-value {
                    font-size: 32px;
                    font-weight: 700;
                    margin: 0;
                    line-height: 1.2;
                }
                .twork-activity-stat-card.active .stat-value { color: #46b450; }
                .twork-activity-stat-card.inactive .stat-value { color: #dc3232; }
                .twork-activity-stat-card.total .stat-value { color: #3b82f6; }
                .twork-activity-stat-card.rate .stat-value { color: #f59e0b; }
                .twork-activity-stat-card .stat-description {
                    font-size: 12px;
                    color: #999;
                    margin-top: 6px;
                }
                .twork-activity-progress-bar {
                    width: 100%;
                    height: 6px;
                    background: #e5e7eb;
                    border-radius: 3px;
                    margin-top: 10px;
                    overflow: hidden;
                }
                .twork-activity-progress-fill {
                    height: 100%;
                    border-radius: 3px;
                    transition: width 0.3s ease;
                }
                .twork-activity-progress-fill.active {
                    background: linear-gradient(90deg, #46b450 0%, #3fa048 100%);
                }
                .twork-activity-progress-fill.inactive {
                    background: linear-gradient(90deg, #dc3232 0%, #c42d2d 100%);
                }
            </style>
            <div class="twork-activity-stats-container">
                <div class="twork-activity-stat-card active">
                    <div class="stat-label">
                        <?php esc_html_e('Active Users', 'twork-rewards'); ?>
                    </div>
                    <div class="stat-value"><?php echo esc_html(number_format($activity_stats['active_count'])); ?></div>
                    <div class="stat-description">
                        <?php printf(esc_html__('Users active within last %d days', 'twork-rewards'), $activity_stats['threshold_days']); ?>
                    </div>
                    <div class="twork-activity-progress-bar">
                        <div class="twork-activity-progress-fill active" style="width: <?php echo esc_attr($active_percentage); ?>%;"></div>
                    </div>
                </div>
                <div class="twork-activity-stat-card inactive">
                    <div class="stat-label">
                        <?php esc_html_e('Inactive Users', 'twork-rewards'); ?>
                    </div>
                    <div class="stat-value"><?php echo esc_html(number_format($activity_stats['inactive_count'])); ?></div>
                    <div class="stat-description">
                        <?php printf(esc_html__('Users inactive for %d+ days', 'twork-rewards'), $activity_stats['threshold_days']); ?>
                    </div>
                    <div class="twork-activity-progress-bar">
                        <div class="twork-activity-progress-fill inactive" style="width: <?php echo esc_attr($inactive_percentage); ?>%;"></div>
                    </div>
                </div>
                <div class="twork-activity-stat-card total">
                    <div class="stat-label">
                        <?php esc_html_e('Total Users', 'twork-rewards'); ?>
                    </div>
                    <div class="stat-value"><?php echo esc_html(number_format($activity_stats['total_count'])); ?></div>
                    <div class="stat-description">
                        <?php esc_html_e('All registered users', 'twork-rewards'); ?>
                    </div>
                </div>
                <div class="twork-activity-stat-card rate">
                    <div class="stat-label">
                        <?php esc_html_e('Active Rate', 'twork-rewards'); ?>
                    </div>
                    <div class="stat-value"><?php echo esc_html(number_format($activity_stats['active_rate'], 1)); ?>%</div>
                    <div class="stat-description">
                        <?php esc_html_e('Percentage of active users', 'twork-rewards'); ?>
                    </div>
                    <div class="twork-activity-progress-bar">
                        <div class="twork-activity-progress-fill active" style="width: <?php echo esc_attr($activity_stats['active_rate']); ?>%;"></div>
                    </div>
                </div>
            </div>
            <?php endif; // End activity_stats check ?>
            <?php endif; // End show_stats check ?>

            <?php if ($total_users > 0): ?>
                <div style="margin: 12px 0;">
                    <?php
                    printf(
                        esc_html__('Showing %d-%d of %d users', 'twork-rewards'),
                        $offset + 1,
                        min($offset + $per_page, $total_users),
                        $total_users
                    );
                    ?>
                </div>
            <?php endif; ?>

            <style>
                /* Professional Activity Status Styling */
                .twork-activity-status-badge {
                    display: inline-flex;
                    align-items: center;
                    gap: 6px;
                    padding: 4px 12px;
                    border-radius: 4px;
                    font-size: 12px;
                    font-weight: 600;
                    text-transform: uppercase;
                    letter-spacing: 0.3px;
                    border: 1px solid;
                    transition: opacity 0.2s ease;
                }
                .twork-activity-status-badge:hover {
                    opacity: 0.9;
                }
                .twork-activity-status-badge.active {
                    background: #f0fdf4;
                    color: #166534;
                    border-color: #46b450;
                }
                .twork-activity-status-badge.inactive {
                    background: #fef2f2;
                    color: #991b1b;
                    border-color: #dc3232;
                }
                .twork-activity-score {
                    display: inline-block;
                    padding: 2px 8px;
                    border-radius: 3px;
                    font-size: 11px;
                    font-weight: 500;
                    margin-top: 4px;
                    border: 1px solid;
                }
                .twork-activity-score.high { 
                    background: #f0fdf4; 
                    color: #166534; 
                    border-color: #86efac;
                }
                .twork-activity-score.medium { 
                    background: #fffbeb; 
                    color: #92400e; 
                    border-color: #fde68a;
                }
                .twork-activity-score.low { 
                    background: #fef2f2; 
                    color: #991b1b; 
                    border-color: #fca5a5;
                }
                .twork-activity-indicator {
                    display: inline-block;
                    width: 8px;
                    height: 8px;
                    border-radius: 50%;
                    margin-right: 4px;
                    vertical-align: middle;
                }
            </style>
            <table class="wp-list-table widefat fixed striped">
                <thead>
                <tr>
                    <?php if ($settings['show_activity_badge']): ?>
                    <th style="width: 140px;">
                        <a href="<?php echo esc_url(add_query_arg(array('orderby' => 'activity', 'order' => $orderby === 'activity' && $order === 'DESC' ? 'ASC' : 'DESC'), remove_query_arg(array('paged')))); ?>" 
                           style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 5px; font-weight: 600;">
                            <?php esc_html_e('Activity Status', 'twork-rewards'); ?>
                            <?php if ($orderby === 'activity'): ?>
                                <span style="font-size: 11px; color: #2271b1;"><?php echo $order === 'DESC' ? 'â†“' : 'â†‘'; ?></span>
                            <?php endif; ?>
                        </a>
                    </th>
                    <?php endif; ?>
                    <?php if ($settings['show_avatar']): ?>
                    <th style="width: 50px;"><?php esc_html_e('Avatar', 'twork-rewards'); ?></th>
                    <?php endif; ?>
                    <th>
                        <a href="<?php echo esc_url(add_query_arg(array('orderby' => 'name', 'order' => $orderby === 'name' && $order === 'DESC' ? 'ASC' : 'DESC'), remove_query_arg(array('paged')))); ?>" 
                           style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 5px; font-weight: 600;">
                            <?php esc_html_e('User', 'twork-rewards'); ?>
                            <?php if ($orderby === 'name'): ?>
                                <span style="font-size: 11px; color: #2271b1;"><?php echo $order === 'DESC' ? 'â†“' : 'â†‘'; ?></span>
                            <?php endif; ?>
                        </a>
                    </th>
                    <?php if ($settings['show_email']): ?>
                    <th>
                        <a href="<?php echo esc_url(add_query_arg(array('orderby' => 'email', 'order' => $orderby === 'email' && $order === 'DESC' ? 'ASC' : 'DESC'), remove_query_arg(array('paged')))); ?>" 
                           style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 5px; font-weight: 600;">
                            <?php esc_html_e('Email', 'twork-rewards'); ?>
                            <?php if ($orderby === 'email'): ?>
                                <span style="font-size: 11px; color: #2271b1;"><?php echo $order === 'DESC' ? 'â†“' : 'â†‘'; ?></span>
                            <?php endif; ?>
                        </a>
                    </th>
                    <?php endif; ?>
                    <?php if ($settings['show_phone']): ?>
                    <th><?php esc_html_e('Phone', 'twork-rewards'); ?></th>
                    <?php endif; ?>
                    <?php if ($settings['show_user_tier']): ?>
                    <th><?php esc_html_e('Tier', 'twork-rewards'); ?></th>
                    <?php endif; ?>
                    <th><?php esc_html_e('Last Activity', 'twork-rewards'); ?></th>
                    <?php if ($settings['show_activity_score']): ?>
                    <th><?php esc_html_e('Activity Score', 'twork-rewards'); ?></th>
                    <?php endif; ?>
                    <?php if ($settings['show_points']): ?>
                    <th><?php esc_html_e('My Points', 'twork-rewards'); ?></th>
                    <?php endif; ?>
                    <?php if ($settings['show_total_transactions']): ?>
                    <th><?php esc_html_e('Transactions', 'twork-rewards'); ?></th>
                    <?php endif; ?>
                    <?php if ($settings['show_registration_date']): ?>
                    <th><?php esc_html_e('Registered', 'twork-rewards'); ?></th>
                    <?php endif; ?>
                    <?php if ($settings['show_last_updated']): ?>
                    <th><?php esc_html_e('Last Updated', 'twork-rewards'); ?></th>
                    <?php endif; ?>
                </tr>
                </thead>
                <tbody>
                <?php if (!empty($users)): ?>
                    <?php
                    foreach ($users as $user):
                        // Get meta from cache instead of individual queries
                        $user_meta = isset($user_meta_cache[$user->ID]) ? $user_meta_cache[$user->ID] : array();
                        $points = isset($user_meta['my_points']) ? $user_meta['my_points'] : '';
                        $updated_at = isset($user_meta['my_points_updated_at']) ? $user_meta['my_points_updated_at'] : '';
                        $phone = isset($user_meta['billing_phone']) ? $user_meta['billing_phone'] : '';

                        // Get activity status (using enhanced method)
                        $activity_status = $this->get_user_activity_status($user->ID);
                        $activity = isset($user_activity_cache[$user->ID]) ? $user_activity_cache[$user->ID] : $this->get_formatted_user_activity($user->ID);
                        $is_active = $activity['is_active'];
                        $activity_score = isset($activity_status['activity_score']) ? $activity_status['activity_score'] : 0;

                        // Determine activity score class
                        $score_class = 'high';
                        if ($activity_score < 30) {
                            $score_class = 'low';
                        } elseif ($activity_score < 60) {
                            $score_class = 'medium';
                        }
                        ?>
                        <tr>
                            <?php if ($settings['show_activity_badge']): ?>
                            <td style="vertical-align: middle;">
                                <div class="twork-activity-status-badge <?php echo $is_active ? 'active' : 'inactive'; ?>">
                                    <?php echo esc_html($activity['status_label']); ?>
                                </div>
                                <?php if (!empty($activity_status['days_inactive']) && $activity_status['days_inactive'] > 0): ?>
                                    <div style="margin-top: 4px; font-size: 11px; color: #666; font-weight: 500;">
                                        <?php
                                        if ($activity_status['days_inactive'] == 0) {
                                            echo esc_html__('Active Today', 'twork-rewards');
                                        } else {
                                            echo sprintf(esc_html__('%d days ago', 'twork-rewards'), $activity_status['days_inactive']);
                                        }
                                        ?>
                                    </div>
                                <?php endif; ?>
                            </td>
                            <?php endif; ?>
                            <?php if ($settings['show_avatar']): ?>
                            <td style="vertical-align: middle;">
                                <?php echo get_avatar($user->ID, 32, '', '', array('class' => 'avatar')); ?>
                            </td>
                            <?php endif; ?>
                            <td>
                                <strong>
                                    <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-user-detail', 'user_id' => $user->ID), admin_url('admin.php'))); ?>">
                                        <?php echo esc_html($user->display_name ?: $user->user_email); ?>
                                    </a>
                                </strong>
                            </td>
                            <?php if ($settings['show_email']): ?>
                            <td><?php echo esc_html($user->user_email); ?></td>
                            <?php endif; ?>
                            <?php if ($settings['show_phone']): ?>
                            <td><?php echo $phone ? esc_html($phone) : '&mdash;'; ?></td>
                            <?php endif; ?>
                            <?php if ($settings['show_user_tier']): ?>
                            <td>
                                <?php
                                $user_tier = $this->get_user_tier($user->ID);
                                if ($user_tier) {
                                    echo esc_html($user_tier['name']);
                                } else {
                                    echo '<span style="color: #999;">&mdash;</span>';
                                }
                                ?>
                            </td>
                            <?php endif; ?>
                            <td>
                                <?php if (!empty($activity['last_activity_formatted'])): ?>
                                    <div style="font-weight: 500;">
                                        <?php echo esc_html($activity['last_activity_formatted']); ?>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 2px;">
                                        <?php echo esc_html($activity['days_inactive_formatted']); ?>
                                    </div>
                                    <?php if (!empty($activity_status['last_login']) && $activity_status['last_login'] != $activity_status['last_activity']): ?>
                                        <div style="font-size: 11px; color: #999; margin-top: 2px;">
                                            <?php esc_html_e('Last Login:', 'twork-rewards'); ?> 
                                            <?php echo esc_html($activity['last_login_formatted']); ?>
                                        </div>
                                    <?php endif; ?>
                                <?php else: ?>
                                    <span style="color: #999; font-style: italic;"><?php esc_html_e('No Activity Recorded', 'twork-rewards'); ?></span>
                                <?php endif; ?>
                            </td>
                            <?php if ($settings['show_activity_score']): ?>
                            <td>
                                <?php if ($activity_score > 0): ?>
                                    <div class="twork-activity-score <?php echo esc_attr($score_class); ?>">
                                        <?php printf(esc_html__('%d/100', 'twork-rewards'), $activity_score); ?>
                                    </div>
                                <?php else: ?>
                                    <span style="color: #999;">&mdash;</span>
                                <?php endif; ?>
                            </td>
                            <?php endif; ?>
                            <?php if ($settings['show_points']): ?>
                            <td>
                                <strong style="color: #f59e0b; font-size: 14px;">
                                    <?php echo $points !== '' ? esc_html($points) : '0'; ?>
                                </strong>
                            </td>
                            <?php endif; ?>
                            <?php if ($settings['show_total_transactions']): ?>
                            <td>
                                <?php
                                global $wpdb;
                                $table = $this->table_name();
                                $transaction_count = $wpdb->get_var($wpdb->prepare(
                                    "SELECT COUNT(*) FROM $table WHERE user_id = %d",
                                    $user->ID
                                ));
                                echo esc_html(number_format((int) $transaction_count));
                                ?>
                            </td>
                            <?php endif; ?>
                            <?php if ($settings['show_registration_date']): ?>
                            <td>
                                <?php
                                $registered_date = $user->user_registered;
                                if ($registered_date) {
                                    $date_format = ($settings['date_format'] === 'wp_default') ? get_option('date_format') : $settings['date_format'];
                                    echo esc_html(gmdate($date_format, strtotime($registered_date)));
                                } else {
                                    echo '<span style="color: #999;">&mdash;</span>';
                                }
                                ?>
                            </td>
                            <?php endif; ?>
                            <?php if ($settings['show_last_updated']): ?>
                            <td>
                                <?php
                                // Professional: Display Last Updated using settings format
                                if (!empty($updated_at)) {
                                    $formatted_time = $this->format_myanmar_time($updated_at);
                                    if ($formatted_time) {
                                        echo esc_html($formatted_time);
                                    } else {
                                        echo '<span style="color: #999;">&mdash;</span>';
                                    }
                                } else {
                                    echo '<span style="color: #999;">&mdash;</span>';
                                }
                                ?>
                            </td>
                            <?php endif; ?>
                        </tr>
                    <?php endforeach; ?>
                <?php else: ?>
                    <?php
                    // Calculate column count dynamically
                    $col_count = 1; // User column is always shown
                    if ($settings['show_activity_badge']) $col_count++;
                    if ($settings['show_avatar']) $col_count++;
                    if ($settings['show_email']) $col_count++;
                    if ($settings['show_phone']) $col_count++;
                    if ($settings['show_user_tier']) $col_count++;
                    $col_count++; // Last Activity is always shown
                    if ($settings['show_activity_score']) $col_count++;
                    if ($settings['show_points']) $col_count++;
                    if ($settings['show_total_transactions']) $col_count++;
                    if ($settings['show_registration_date']) $col_count++;
                    if ($settings['show_last_updated']) $col_count++;
                    ?>
                    <tr><td colspan="<?php echo esc_attr($col_count); ?>" style="text-align: center; padding: 40px;">
                        <p style="color: #666; font-size: 14px;"><?php esc_html_e('No users found matching your criteria.', 'twork-rewards'); ?></p>
                    </td></tr>
                <?php endif; ?>
                </tbody>
            </table>
            
            <?php if ($settings['show_pagination'] && $total_pages > 1): ?>
                <div class="tablenav">
                    <div class="tablenav-pages">
                        <?php
                        $page_links = paginate_links(array(
                            'base' => add_query_arg('paged', '%#%'),
                            'format' => '',
                            'prev_text' => __('&laquo;'),
                            'next_text' => __('&raquo;'),
                            'total' => $total_pages,
                            'current' => $paged,
                        ));
                        echo $page_links;
                        ?>
                    </div>
                </div>
            <?php endif; ?>
        </div>
        <?php
    }

    /**
     * User detail page (plugin's own page) - Professional Design
     */
    public function render_user_detail_page()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('You do not have permission to access this page.', 'twork-rewards'));
        }

        $user_id = isset($_GET['user_id']) ? absint($_GET['user_id']) : 0;
        if ($user_id <= 0) {
            wp_die(__('Missing user_id.', 'twork-rewards'));
        }

        $user = get_user_by('ID', $user_id);
        if (!$user) {
            wp_die(__('User not found.', 'twork-rewards'));
        }

        $points = get_user_meta($user_id, 'my_points', true);
        $luckybox_enabled = get_user_meta($user_id, self::USER_META_LUCKYBOX_ENABLED, true);
        $luckybox_enabled = ($luckybox_enabled === '' || $luckybox_enabled === null)
            ? (int) get_option(self::OPTION_LUCKYBOX_ENABLED, 1)
            : (int) $luckybox_enabled;

        // Get user transactions for summary
        global $wpdb;
        $table = $this->table_name();
        $user_transactions = $wpdb->get_results($wpdb->prepare(
            "SELECT * FROM $table WHERE user_id = %d ORDER BY created_at DESC LIMIT 10",
            $user_id
        ), ARRAY_A);

        $total_transactions = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(*) FROM $table WHERE user_id = %d",
            $user_id
        ));

        $pending_count = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(*) FROM $table WHERE user_id = %d AND status = 'pending'",
            $user_id
        ));

        $approved_count = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(*) FROM $table WHERE user_id = %d AND status = 'approved'",
            $user_id
        ));

        // Get user activity status
        $activity = $this->get_formatted_user_activity($user_id);
        $activity_status = $this->get_user_activity_status($user_id);

        // Add custom CSS for professional design
        ?>
        <style>
            /* Professional notice styling - works immediately without body class */
            .wrap .notice,
            body.twork-rewards-admin-page .wrap .notice {
                margin: 20px 0 20px 0 !important;
                padding: 12px 15px !important;
                border-left: 4px solid #46b450 !important;
                background: #f7fff7 !important; /* Light green background for visibility */
                box-shadow: 0 1px 1px rgba(0,0,0,.04) !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                color: #23282d !important; /* Dark text for readability */
                border-radius: 4px !important;
            }
            .wrap .notice.notice-success,
            body.twork-rewards-admin-page .wrap .notice.notice-success {
                border-left-color: #46b450 !important;
                background: #f7fff7 !important; /* Light green background */
            }
            .wrap .notice p,
            body.twork-rewards-admin-page .wrap .notice p {
                margin: 0 !important;
                padding: 0 !important;
                color: #23282d !important; /* Dark text color for visibility */
                font-size: 14px !important;
                font-weight: 500 !important;
                line-height: 1.5 !important;
            }
            .wrap .notice.is-dismissible,
            body.twork-rewards-admin-page .wrap .notice.is-dismissible {
                padding-right: 38px !important; /* Space for dismiss button */
            }
            /* Ensure notice is visible even on white backgrounds */
            .wrap .notice::before {
                content: '';
                display: none;
            }
            .twork-user-detail-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 30px;
                border-radius: 8px;
                margin-bottom: 20px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }
            .twork-user-detail-header h1 {
                color: white;
                margin: 0 0 10px 0;
                font-size: 28px;
                font-weight: 600;
            }
            .twork-user-detail-header .user-info {
                display: flex;
                align-items: center;
                gap: 20px;
                margin-top: 15px;
            }
            .twork-user-detail-header .user-avatar {
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: rgba(255,255,255,0.2);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                font-weight: bold;
            }
            .twork-user-detail-header .user-details {
                flex: 1;
            }
            .twork-user-detail-header .user-details strong {
                display: block;
                margin-bottom: 5px;
                font-size: 16px;
            }
            .twork-user-detail-header .user-details span {
                opacity: 0.9;
                font-size: 14px;
            }
            .twork-stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            .twork-stat-card {
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                padding: 20px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                transition: transform 0.2s, box-shadow 0.2s;
            }
            .twork-stat-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }
            .twork-stat-card .stat-label {
                color: #666;
                font-size: 13px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 8px;
            }
            .twork-stat-card .stat-value {
                font-size: 32px;
                font-weight: 700;
                color: #333;
                margin: 0;
            }
            .twork-stat-card.points .stat-value { color: #f59e0b; }
            .twork-stat-card.rewards .stat-value { color: #10b981; }
            .twork-stat-card.transactions .stat-value { color: #3b82f6; }
            .twork-stat-card.pending .stat-value { color: #ef4444; }
            .twork-form-card {
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                padding: 25px;
                margin-bottom: 30px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            .twork-form-card h2 {
                margin-top: 0;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 2px solid #f0f0f0;
                font-size: 20px;
                color: #333;
            }
            .twork-form-section {
                margin-bottom: 25px;
                padding-bottom: 25px;
                border-bottom: 1px solid #f0f0f0;
            }
            .twork-form-section:last-child {
                border-bottom: none;
                margin-bottom: 0;
                padding-bottom: 0;
            }
            .twork-form-section label {
                display: block;
                font-weight: 600;
                margin-bottom: 8px;
                color: #333;
                font-size: 14px;
            }
            .twork-form-section input[type="text"] {
                width: 100%;
                max-width: 500px;
                padding: 10px 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
                transition: border-color 0.2s;
            }
            .twork-form-section input[type="text"]:focus {
                border-color: #667eea;
                outline: none;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }
            .twork-form-section .description {
                margin-top: 6px;
                color: #666;
                font-size: 13px;
                line-height: 1.5;
            }
            .twork-checkbox-wrapper {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 12px;
                background: #f9fafb;
                border-radius: 6px;
                border: 1px solid #e5e7eb;
            }
            .twork-checkbox-wrapper input[type="checkbox"] {
                width: 20px;
                height: 20px;
                cursor: pointer;
            }
            .twork-checkbox-wrapper label {
                cursor: pointer;
                margin: 0;
                font-weight: 500;
            }
            .twork-transactions-table {
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            .twork-transactions-table h2 {
                padding: 20px 25px;
                margin: 0;
                border-bottom: 1px solid #e0e0e0;
                background: #f9fafb;
                font-size: 18px;
                color: #333;
            }
            .twork-action-buttons {
                display: flex;
                gap: 10px;
                margin-bottom: 25px;
                flex-wrap: wrap;
            }
            .twork-action-buttons .button {
                padding: 8px 16px;
                border-radius: 6px;
                text-decoration: none;
                font-weight: 500;
                transition: all 0.2s;
            }
            .twork-action-buttons .button-primary {
                background: #667eea;
                border-color: #667eea;
                color: white;
            }
            .twork-action-buttons .button-primary:hover {
                background: #5568d3;
                border-color: #5568d3;
            }
        </style>
        <script>
            // Add body class to scope CSS
            document.addEventListener('DOMContentLoaded', function() {
                document.body.classList.add('twork-rewards-admin-page');
            });
        </script>
        <div class="wrap">
            <?php if (isset($_GET['updated']) && intval($_GET['updated']) === 1): ?>
                <div class="notice notice-success is-dismissible" style="margin: 20px 0 !important; padding: 12px 15px !important; border-left: 4px solid #46b450 !important; background: #f7fff7 !important; color: #23282d !important; box-shadow: 0 1px 1px rgba(0,0,0,.04) !important; border-radius: 4px !important;">
                    <p style="margin: 0 !important; padding: 0 !important; color: #23282d !important; font-size: 14px !important; font-weight: 500 !important; line-height: 1.5 !important;"><?php esc_html_e('User settings updated.', 'twork-rewards'); ?></p>
                </div>
            <?php endif; ?>
            <!-- Header Section -->
            <div class="twork-user-detail-header">
                <h1><?php esc_html_e('User Details', 'twork-rewards'); ?></h1>
                <div class="user-info">
                    <div class="user-avatar">
                        <?php echo esc_html(strtoupper(substr($user->display_name ?: $user->user_email, 0, 1))); ?>
                    </div>
                    <div class="user-details">
                        <strong><?php echo esc_html($user->display_name ?: $user->user_email); ?></strong>
                        <span><?php echo esc_html($user->user_email); ?></span>
                        <span style="display: block; margin-top: 5px; font-size: 12px;">User ID: <?php echo esc_html($user_id); ?></span>
                        <div style="margin-top: 10px;">
                            <span style="
                                display: inline-block;
                                padding: 6px 12px;
                                border-radius: 16px;
                                font-size: 13px;
                                font-weight: 600;
                                background-color: <?php echo $activity['is_active'] ? 'rgba(70, 180, 80, 0.2)' : 'rgba(220, 50, 50, 0.2)'; ?>;
                                color: <?php echo $activity['is_active'] ? '#46b450' : '#dc3232'; ?>;
                                border: 1px solid <?php echo $activity['is_active'] ? 'rgba(70, 180, 80, 0.4)' : 'rgba(220, 50, 50, 0.4)'; ?>;
                            ">
                                <?php echo esc_html($activity['status_label']); ?>
                            </span>
                            <?php if (!empty($activity['last_activity_formatted'])): ?>
                                <span style="display: block; margin-top: 5px; font-size: 12px; opacity: 0.9;">
                                    <?php esc_html_e('Last Activity:', 'twork-rewards'); ?> <?php echo esc_html($activity['last_activity_formatted']); ?>
                                    (<?php echo esc_html($activity['days_inactive_formatted']); ?>)
                                </span>
                            <?php endif; ?>
                        </div>
                    </div>
                    <div>
                        <a class="button" href="<?php echo esc_url(admin_url('admin.php?page=twork-rewards-users')); ?>" style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white;">
                            <?php esc_html_e('â† Back', 'twork-rewards'); ?>
                        </a>
                        <a class="button" href="<?php echo esc_url(get_edit_user_link($user_id)); ?>" target="_blank" style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white; margin-left: 10px;">
                            <?php esc_html_e('WP Profile', 'twork-rewards'); ?>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Activity Status Section - Prominent Display -->
            <div class="twork-form-card" style="background: <?php echo $activity['is_active'] ? '#f0fdf4' : '#fef2f2'; ?>; border-left: 4px solid <?php echo $activity['is_active'] ? '#46b450' : '#dc3232'; ?>; margin-bottom: 30px;">
                <h2 style="margin-top: 0; display: flex; align-items: center; gap: 10px; font-size: 18px; font-weight: 600; color: #333;">
                    <?php esc_html_e('User Activity Status', 'twork-rewards'); ?>
                </h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div style="padding: 20px; background: white; border-radius: 8px; border: 2px solid <?php echo $activity['is_active'] ? '#46b450' : '#dc3232'; ?>;">
                        <div style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: #666; margin-bottom: 10px; font-weight: 600;">
                            <?php esc_html_e('Current Status', 'twork-rewards'); ?>
                        </div>
                        <div class="twork-activity-status-badge <?php echo $activity['is_active'] ? 'active' : 'inactive'; ?>" style="font-size: 13px; padding: 6px 14px;">
                            <?php echo esc_html($activity['status_label']); ?>
                        </div>
                        <?php if (isset($activity_status['activity_score']) && $activity_status['activity_score'] > 0): ?>
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                                    <?php esc_html_e('Activity Score', 'twork-rewards'); ?>
                                </div>
                                <div style="font-size: 28px; font-weight: 700; color: <?php
            echo $activity_status['activity_score'] >= 60 ? '#46b450' : ($activity_status['activity_score'] >= 30 ? '#ff9800' : '#dc3232');
            ?>;">
                                    <?php echo esc_html($activity_status['activity_score']); ?>/100
                                </div>
                                <div style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; margin-top: 8px; overflow: hidden;">
                                    <div style="
                                        width: <?php echo esc_attr($activity_status['activity_score']); ?>%;
                                        height: 100%;
                                        background: linear-gradient(90deg, 
                                            <?php echo $activity_status['activity_score'] >= 60 ? '#46b450' : ($activity_status['activity_score'] >= 30 ? '#ff9800' : '#dc3232'); ?> 0%, 
                                            <?php echo $activity_status['activity_score'] >= 60 ? '#3fa048' : ($activity_status['activity_score'] >= 30 ? '#e68900' : '#c42d2d'); ?> 100%
                                        );
                                        transition: width 0.3s ease;
                                    "></div>
                                </div>
                            </div>
                        <?php endif; ?>
                    </div>
                    <div style="padding: 20px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <div style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: #666; margin-bottom: 15px; font-weight: 600;">
                            <?php esc_html_e('Activity Timeline', 'twork-rewards'); ?>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <?php if (!empty($activity['last_activity_formatted'])): ?>
                                <div>
                                    <div style="font-size: 11px; color: #999; margin-bottom: 4px;">
                                        <?php esc_html_e('Last Activity', 'twork-rewards'); ?>
                                    </div>
                                    <div style="font-size: 14px; font-weight: 600; color: #333;">
                                        <?php echo esc_html($activity['last_activity_formatted']); ?>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 2px;">
                                        <?php echo esc_html($activity['days_inactive_formatted']); ?>
                                    </div>
                                </div>
                            <?php else: ?>
                                <div style="color: #999; font-style: italic;">
                                    <?php esc_html_e('No activity recorded', 'twork-rewards'); ?>
                                </div>
                            <?php endif; ?>
                            
                            <?php if (!empty($activity['last_login_formatted'])): ?>
                                <div style="padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                    <div style="font-size: 11px; color: #999; margin-bottom: 4px;">
                                        <?php esc_html_e('Last Login', 'twork-rewards'); ?>
                                    </div>
                                    <div style="font-size: 14px; font-weight: 600; color: #333;">
                                        <?php echo esc_html($activity['last_login_formatted']); ?>
                                    </div>
                                </div>
                            <?php endif; ?>
                            
                            <?php if (isset($activity_status['last_order']) && !empty($activity_status['last_order'])): ?>
                                <div style="padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                    <div style="font-size: 11px; color: #999; margin-bottom: 4px;">
                                        <?php esc_html_e('Last Order', 'twork-rewards'); ?>
                                    </div>
                                    <div style="font-size: 14px; font-weight: 600; color: #333;">
                                        <?php echo esc_html($this->format_myanmar_time($activity_status['last_order'])); ?>
                                    </div>
                                </div>
                            <?php endif; ?>
                            
                            <?php if (isset($activity_status['last_transaction']) && !empty($activity_status['last_transaction'])): ?>
                                <div style="padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                    <div style="font-size: 11px; color: #999; margin-bottom: 4px;">
                                        <?php esc_html_e('Last Transaction', 'twork-rewards'); ?>
                                    </div>
                                    <div style="font-size: 14px; font-weight: 600; color: #333;">
                                        <?php echo esc_html($this->format_myanmar_time($activity_status['last_transaction'])); ?>
                                    </div>
                                </div>
                            <?php endif; ?>
                        </div>
                    </div>
                    
                    <!-- User Location Section -->
                    <?php
                    // Get user location information
                    $billing_address_1 = get_user_meta($user_id, 'billing_address_1', true);
                    $billing_address_2 = get_user_meta($user_id, 'billing_address_2', true);
                    $billing_city = get_user_meta($user_id, 'billing_city', true);
                    $billing_state = get_user_meta($user_id, 'billing_state', true);
                    $billing_postcode = get_user_meta($user_id, 'billing_postcode', true);
                    $billing_country = get_user_meta($user_id, 'billing_country', true);
                    $billing_phone = get_user_meta($user_id, 'billing_phone', true);
                    $billing_email = get_user_meta($user_id, 'billing_email', true);

                    $shipping_address_1 = get_user_meta($user_id, 'shipping_address_1', true);
                    $shipping_address_2 = get_user_meta($user_id, 'shipping_address_2', true);
                    $shipping_city = get_user_meta($user_id, 'shipping_city', true);
                    $shipping_state = get_user_meta($user_id, 'shipping_state', true);
                    $shipping_postcode = get_user_meta($user_id, 'shipping_postcode', true);
                    $shipping_country = get_user_meta($user_id, 'shipping_country', true);

                    $has_billing = !empty($billing_address_1) || !empty($billing_city);
                    $has_shipping = !empty($shipping_address_1) || !empty($shipping_city);
                    ?>
                    <?php if ($has_billing || $has_shipping): ?>
                        <div style="padding: 20px; background: white; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 20px;">
                            <div style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: #666; margin-bottom: 15px; font-weight: 600;">
                                <?php esc_html_e('User Location', 'twork-rewards'); ?>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                <?php if ($has_billing): ?>
                                    <div style="padding: 15px; background: #f9fafb; border-radius: 6px; border-left: 3px solid #667eea;">
                                        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #999; margin-bottom: 10px; font-weight: 600;">
                                            <?php esc_html_e('Billing Address', 'twork-rewards'); ?>
                                        </div>
                                        <div style="font-size: 14px; line-height: 1.6; color: #333;">
                                            <?php if (!empty($billing_address_1)): ?>
                                                <div style="font-weight: 500; margin-bottom: 4px;"><?php echo esc_html($billing_address_1); ?></div>
                                            <?php endif; ?>
                                            <?php if (!empty($billing_address_2)): ?>
                                                <div style="margin-bottom: 4px;"><?php echo esc_html($billing_address_2); ?></div>
                                            <?php endif; ?>
                                            <?php
                                            $city_parts = array();
                                            if (!empty($billing_city))
                                                $city_parts[] = $billing_city;
                                            if (!empty($billing_state))
                                                $city_parts[] = $billing_state;
                                            if (!empty($billing_postcode))
                                                $city_parts[] = $billing_postcode;
                                            if (!empty($city_parts)) {
                                                echo '<div style="margin-bottom: 4px;">' . esc_html(implode(', ', $city_parts)) . '</div>';
                                            }
                                            if (!empty($billing_country) && $billing_country !== 'MM') {
                                                echo '<div>' . esc_html($billing_country) . '</div>';
                                            }
                                            ?>
                                            <?php if (!empty($billing_phone)): ?>
                                                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb; font-size: 12px; color: #666;">
                                                    <strong><?php esc_html_e('Phone:', 'twork-rewards'); ?></strong> <?php echo esc_html($billing_phone); ?>
                                                </div>
                                            <?php endif; ?>
                                            <?php if (!empty($billing_email) && $billing_email !== $user->user_email): ?>
                                                <div style="margin-top: 4px; font-size: 12px; color: #666;">
                                                    <strong><?php esc_html_e('Email:', 'twork-rewards'); ?></strong> <?php echo esc_html($billing_email); ?>
                                                </div>
                                            <?php endif; ?>
                                        </div>
                                    </div>
                                <?php endif; ?>
                                
                                <?php if ($has_shipping): ?>
                                    <div style="padding: 15px; background: #f9fafb; border-radius: 6px; border-left: 3px solid #10b981;">
                                        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #999; margin-bottom: 10px; font-weight: 600;">
                                            <?php esc_html_e('Shipping Address', 'twork-rewards'); ?>
                                        </div>
                                        <div style="font-size: 14px; line-height: 1.6; color: #333;">
                                            <?php if (!empty($shipping_address_1)): ?>
                                                <div style="font-weight: 500; margin-bottom: 4px;"><?php echo esc_html($shipping_address_1); ?></div>
                                            <?php endif; ?>
                                            <?php if (!empty($shipping_address_2)): ?>
                                                <div style="margin-bottom: 4px;"><?php echo esc_html($shipping_address_2); ?></div>
                                            <?php endif; ?>
                                            <?php
                                            $city_parts = array();
                                            if (!empty($shipping_city))
                                                $city_parts[] = $shipping_city;
                                            if (!empty($shipping_state))
                                                $city_parts[] = $shipping_state;
                                            if (!empty($shipping_postcode))
                                                $city_parts[] = $shipping_postcode;
                                            if (!empty($city_parts)) {
                                                echo '<div style="margin-bottom: 4px;">' . esc_html(implode(', ', $city_parts)) . '</div>';
                                            }
                                            if (!empty($shipping_country) && $shipping_country !== 'MM') {
                                                echo '<div>' . esc_html($shipping_country) . '</div>';
                                            }
                                            ?>
                                        </div>
                                    </div>
                                <?php endif; ?>
                            </div>
                        </div>
                    <?php endif; ?>
                    
                    <div style="padding: 20px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <div style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: #666; margin-bottom: 15px; font-weight: 600;">
                            <?php esc_html_e('Activity Summary', 'twork-rewards'); ?>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <?php if (isset($activity_status['days_inactive']) && $activity_status['days_inactive'] !== null): ?>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f9fafb; border-radius: 6px;">
                                    <span style="font-size: 13px; color: #666;">
                                        <?php esc_html_e('Days Inactive', 'twork-rewards'); ?>
                                    </span>
                                    <span style="font-size: 16px; font-weight: 700; color: <?php echo $activity_status['days_inactive'] <= 7 ? '#46b450' : ($activity_status['days_inactive'] <= 30 ? '#ff9800' : '#dc3232'); ?>;">
                                        <?php echo esc_html($activity_status['days_inactive']); ?>
                                    </span>
                                </div>
                            <?php endif; ?>
                            
                            <?php if (isset($activity_status['activity_types_count'])): ?>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f9fafb; border-radius: 6px;">
                                    <span style="font-size: 13px; color: #666;">
                                        <?php esc_html_e('Activity Types', 'twork-rewards'); ?>
                                    </span>
                                    <span style="font-size: 16px; font-weight: 700; color: #3b82f6;">
                                        <?php echo esc_html($activity_status['activity_types_count']); ?>
                                    </span>
                                </div>
                            <?php endif; ?>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f9fafb; border-radius: 6px;">
                                <span style="font-size: 13px; color: #666;">
                                    <?php esc_html_e('Threshold', 'twork-rewards'); ?>
                                </span>
                                <span style="font-size: 16px; font-weight: 700; color: #666;">
                                    <?php echo esc_html($activity_status['threshold_days'] ?? 30); ?> <?php esc_html_e('days', 'twork-rewards'); ?>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="twork-stats-grid">
                <div class="twork-stat-card points">
                    <div class="stat-label"><?php esc_html_e('Total Points', 'twork-rewards'); ?></div>
                    <div class="stat-value"><?php echo esc_html($points !== '' ? $points : '0'); ?></div>
                </div>
                <div class="twork-stat-card transactions">
                    <div class="stat-label"><?php esc_html_e('Total Transactions', 'twork-rewards'); ?></div>
                    <div class="stat-value"><?php echo esc_html($total_transactions); ?></div>
                </div>
                <div class="twork-stat-card pending">
                    <div class="stat-label"><?php esc_html_e('Pending', 'twork-rewards'); ?></div>
                    <div class="stat-value"><?php echo esc_html($pending_count); ?></div>
                </div>
                <div class="twork-stat-card approved">
                    <div class="stat-label"><?php esc_html_e('Approved', 'twork-rewards'); ?></div>
                    <div class="stat-value"><?php echo esc_html($approved_count); ?></div>
                </div>
            </div>

            <!-- Settings Form -->
            <div class="twork-form-card">
                <h2><?php esc_html_e('User Settings', 'twork-rewards'); ?></h2>
                <form method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>">
                    <?php wp_nonce_field('twork_rewards_update_user_luckybox', 'twork_rewards_user_nonce'); ?>
                    <input type="hidden" name="action" value="twork_rewards_update_user_luckybox" />
                    <input type="hidden" name="user_id" value="<?php echo esc_attr($user_id); ?>" />

                    <div class="twork-form-section">
                        <label for="twork_luckybox_user_enabled"><?php esc_html_e('Lucky Box Feature', 'twork-rewards'); ?></label>
                        <div class="twork-checkbox-wrapper">
                            <input type="checkbox"
                                   name="twork_luckybox_user_enabled"
                                   id="twork_luckybox_user_enabled"
                                   value="1" <?php checked($luckybox_enabled, 1); ?> />
                            <label for="twork_luckybox_user_enabled"><?php esc_html_e('Enable Lucky Box for this user', 'twork-rewards'); ?></label>
                        </div>
                        <p class="description">
                            <?php esc_html_e('When enabled, the mobile app will show the Lucky Box button for this user. When disabled, the button will be hidden.', 'twork-rewards'); ?>
                        </p>
                    </div>

                    <div class="twork-form-section">
                        <label for="twork_my_points"><?php esc_html_e('My Points', 'twork-rewards'); ?></label>
                        <input type="text" 
                               class="regular-text" 
                               name="twork_my_points" 
                               id="twork_my_points"
                               value=""
                               placeholder="<?php esc_attr_e('Enter points to add/subtract (e.g., 50 or -20)', 'twork-rewards'); ?>" />
                        <p class="description">
                            <?php esc_html_e('This value will be added to existing points. Use positive numbers (e.g., 50) to add points, negative numbers (e.g., -20) to subtract points. Non-numeric values will be stored as text. Leave blank to keep current value.', 'twork-rewards'); ?>
                        </p>
                    </div>

                    <?php submit_button(__('Save Changes', 'twork-rewards'), 'primary', 'submit', false, array('style' => 'margin-top: 10px;')); ?>
                </form>
            </div>

            <!-- Recent Transactions -->
            <?php if (!empty($user_transactions)): ?>
                <div class="twork-transactions-table">
                    <h2><?php esc_html_e('Recent Transactions', 'twork-rewards'); ?> (<?php echo esc_html($total_transactions); ?> <?php esc_html_e('total', 'twork-rewards'); ?>)</h2>
                    <table class="wp-list-table widefat fixed striped" style="margin: 0;">
                        <thead>
                        <tr>
                            <th style="width: 80px;"><?php esc_html_e('ID', 'twork-rewards'); ?></th>
                            <th style="width: 150px;"><?php esc_html_e('Date', 'twork-rewards'); ?></th>
                            <th><?php esc_html_e('Order/Type', 'twork-rewards'); ?></th>
                            <th style="width: 100px;"><?php esc_html_e('Status', 'twork-rewards'); ?></th>
                            <th style="width: 100px;"><?php esc_html_e('Points', 'twork-rewards'); ?></th>
                            <th style="width: 80px;"><?php esc_html_e('Action', 'twork-rewards'); ?></th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php
                        foreach ($user_transactions as $txn):
                            $edit_url = add_query_arg(array(
                                'page' => 'twork-rewards-transaction-edit',
                                'transaction_id' => absint($txn['id']),
                            ), admin_url('admin.php'));
                            $order_link = '&mdash;';
                            if (!empty($txn['order_id'])) {
                                $order_id_str = (string) $txn['order_id'];

                                // Check for manual reward adjustment
                                if (strpos($order_id_str, 'manual_reward:') === 0) {
                                    $order_link = '<span style="color: #10b981; font-weight: 500;">' . esc_html__('Reward Adjustment', 'twork-rewards') . '</span>';
                                }
                                // Check for manual point adjustment
                                elseif (strpos($order_id_str, 'manual:') === 0) {
                                    $order_link = '<span style="color: #f59e0b; font-weight: 500;">' . esc_html__('Point Adjustment', 'twork-rewards') . '</span>';
                                }
                                // Check for exchange request
                                elseif (strpos($order_id_str, 'exchange:') === 0) {
                                    $order_link = '<span style="color: #3b82f6; font-weight: 500;">' . esc_html__('Exchange Request', 'twork-rewards') . '</span>';
                                }
                                // Check for code redemption
                                elseif (strpos($order_id_str, 'code:') === 0) {
                                    $order_link = '<span style="color: #8b5cf6; font-weight: 500;">' . esc_html__('Code Redemption', 'twork-rewards') . '</span>';
                                }
                                // Check for lucky box (format: luckybox:{user_id}_{timestamp} or old format: luckybox)
                                elseif (strpos($order_id_str, 'luckybox:') === 0 || $order_id_str === 'luckybox') {
                                    $order_link = '<span style="color: #667eea; font-weight: 500;">' . esc_html__('Lucky Box', 'twork-rewards') . '</span>';
                                }
                                // Check for regular order ID (numeric)
                                else {
                                    $display_order_id = preg_replace('/[^0-9]/', '', $order_id_str);
                                    if (!empty($display_order_id)) {
                                        $order_link = '<a href="' . esc_url(admin_url('post.php?post=' . absint($display_order_id) . '&action=edit')) . '">#' . esc_html($display_order_id) . '</a>';
                                    } else {
                                        $order_link = esc_html($order_id_str);
                                    }
                                }
                            }
                            $status_color = '';
                            if ($txn['status'] === 'approved') {
                                $status_color = 'color: #10b981; font-weight: 600;';
                            } elseif ($txn['status'] === 'pending') {
                                $status_color = 'color: #f59e0b; font-weight: 600;';
                            } elseif ($txn['status'] === 'rejected') {
                                $status_color = 'color: #ef4444; font-weight: 600;';
                            }
                            ?>
                            <tr>
                                <td><?php echo esc_html($txn['id']); ?></td>
                                <td><?php
                            // Professional: Display transaction date in Myanmar timezone
                            $formatted_date = $this->format_myanmar_time($txn['created_at']);
                            echo esc_html($formatted_date ?: $txn['created_at']);
                            ?></td>
                                <td><?php echo wp_kses_post($order_link); ?></td>
                                <td style="<?php echo esc_attr($status_color); ?>"><?php echo esc_html(ucfirst($txn['status'])); ?></td>
                                <td style="font-weight: 600; color: #f59e0b;"><?php echo !empty($txn['points_value']) ? esc_html($txn['points_value']) : '&mdash;'; ?></td>
                                <td><a href="<?php echo esc_url($edit_url); ?>" class="button button-small"><?php esc_html_e('Edit', 'twork-rewards'); ?></a></td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                    <?php if ($total_transactions > 10): ?>
                        <div style="padding: 15px 25px; border-top: 1px solid #e0e0e0; background: #f9fafb;">
                            <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards', 'user_id' => $user_id), admin_url('admin.php'))); ?>" class="button">
                                <?php esc_html_e('View All Transactions', 'twork-rewards'); ?>
                            </a>
                        </div>
                    <?php endif; ?>
                </div>
            <?php else: ?>
                <div class="twork-transactions-table">
                    <h2><?php esc_html_e('Transactions', 'twork-rewards'); ?></h2>
                    <div style="padding: 40px; text-align: center; color: #666;">
                        <p><?php esc_html_e('No transactions found for this user.', 'twork-rewards'); ?></p>
                    </div>
                </div>
            <?php endif; ?>
        </div>
        <?php
    }

    /**
     * Handle user Lucky Box toggle update
     */
    public function handle_user_luckybox_update()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }
        check_admin_referer('twork_rewards_update_user_luckybox', 'twork_rewards_user_nonce');

        $user_id = isset($_POST['user_id']) ? absint($_POST['user_id']) : 0;
        if ($user_id <= 0) {
            wp_die(__('Missing user_id.', 'twork-rewards'));
        }

        // Get old value before updating
        $old_enabled_raw = get_user_meta($user_id, self::USER_META_LUCKYBOX_ENABLED, true);
        $old_enabled = ($old_enabled_raw === '' || $old_enabled_raw === null)
            ? ((int) get_option(self::OPTION_LUCKYBOX_ENABLED, 1)) === 1
            : ((int) $old_enabled_raw) === 1;

        $enabled = isset($_POST['twork_luckybox_user_enabled']) ? 1 : 0;
        update_user_meta($user_id, self::USER_META_LUCKYBOX_ENABLED, $enabled);

        // PROFESSIONAL FIX: Save My Points with proper synchronization
        // Uses sync_user_points() helper to ensure consistency
        if (isset($_POST['twork_my_points'])) {
            $my_points = trim(sanitize_text_field(wp_unslash($_POST['twork_my_points'])));

            if ($my_points !== '' && is_numeric($my_points)) {
                $delta = (float) $my_points;
                $order_id = 'manual:' . $user_id . ':' . time();
                $description = sprintf(
                    'Manual adjustment by admin (%s %d points)',
                    $delta >= 0 ? '+' : '-',
                    abs((int) $delta)
                );

                // Use helper function to sync points across all systems
                $this->sync_user_points($user_id, $delta, $order_id, $description, true);
            } elseif ($my_points !== '' && !is_numeric($my_points)) {
                // Non-numeric value: overwrite with text (not recommended, but supported for backward compatibility)
                update_user_meta($user_id, 'my_points', $my_points);
                update_user_meta($user_id, 'my_point', $my_points);
                update_user_meta($user_id, 'my_points_updated_at', time());
            }
        }

        // Send notification if user's Lucky Box setting changed
        $new_enabled = (bool) $enabled;
        if ($old_enabled !== $new_enabled) {
            $this->send_luckybox_settings_notification(array(
                'type' => 'user',
                'enabled' => $new_enabled,
                'user_id' => $user_id,
            ));
        }

        wp_safe_redirect(add_query_arg(array(
            'page' => 'twork-rewards-user-detail',
            'user_id' => $user_id,
            'updated' => 1,
        ), admin_url('admin.php')));
        exit;
    }

    /**
     * Show My Points on WP user profile screen
     */
    public function render_user_profile_rewards($user)
    {
        $points = get_user_meta($user->ID, 'my_points', true);
        $luckybox_enabled = get_user_meta($user->ID, self::USER_META_LUCKYBOX_ENABLED, true);
        $luckybox_enabled = ($luckybox_enabled === '' || $luckybox_enabled === null)
            ? (int) get_option(self::OPTION_LUCKYBOX_ENABLED, 1)
            : (int) $luckybox_enabled;
        ?>
        <h2><?php esc_html_e('My Points', 'twork-rewards'); ?></h2>
        <table class="form-table">
            <tr>
                <th><label for="twork_luckybox_user_enabled"><?php esc_html_e('Lucky Box', 'twork-rewards'); ?></label></th>
                <td>
                    <label>
                        <input type="checkbox"
                               name="twork_luckybox_user_enabled"
                               id="twork_luckybox_user_enabled"
                               value="1" <?php checked($luckybox_enabled, 1); ?> />
                        <?php esc_html_e('Enable Lucky Box for this user (per-user on/off)', 'twork-rewards'); ?>
                    </label>
                    <p class="description"><?php esc_html_e('This controls whether the mobile app shows Lucky Box for this user.', 'twork-rewards'); ?></p>
                </td>
            </tr>
            <tr>
                <th><label for="twork_my_points_profile"><?php esc_html_e('My Points', 'twork-rewards'); ?></label></th>
                <td>
                    <input type="text" 
                           class="regular-text" 
                           name="twork_my_points" 
                           id="twork_my_points_profile"
                           value="<?php echo esc_attr($points); ?>" />
                    <p class="description"><?php esc_html_e('Enter points value (number/text). This will be shown in the user profile as "My Points".', 'twork-rewards'); ?></p>
                </td>
            </tr>
        </table>
        <?php
    }

    /**
     * PROFESSIONAL ARCHITECTURE: Refresh user point cache from transactions
     *
     * This function recalculates balance from transactions and updates cache fields
     * Call this after any operation that might affect balance
     *
     * @param int $user_id User ID.
     * @return int Updated balance.
     *
     * @since 1.0.0
     */
    private function refresh_user_points_cache($user_id)
    {
        if (!$user_id) {
            return 0;
        }

        // Get previous balance for comparison
        $previous_balance = (int) get_user_meta($user_id, 'points_balance', true);
        if (!is_numeric($previous_balance)) {
            $previous_balance = 0;
        }

        // Calculate from transactions (single source of truth).
        $calculated_balance = $this->calculate_points_balance_from_transactions($user_id);

        // Update cache fields.
        $stored = (string) $calculated_balance;
        update_user_meta($user_id, 'my_points', $stored);
        update_user_meta($user_id, 'my_point', $stored);
        update_user_meta($user_id, 'points_balance', $calculated_balance);
        update_user_meta($user_id, 'my_points_updated_at', time());

        // Invalidate old cache.
        delete_user_meta($user_id, 'points_balance_cache');
        delete_user_meta($user_id, 'points_balance_cache_time');

        // PROFESSIONAL FEATURE: Auto-recalculate tier if points changed significantly
        // Only recalculate if balance changed and tier system is available
        if ($calculated_balance != $previous_balance) {
            $this->maybe_recalculate_user_tier($user_id, $previous_balance, $calculated_balance);
        }

        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log(
                sprintf(
                    'T-Work Rewards: Point cache refreshed. User ID: %d, Balance: %d (was: %d)',
                    $user_id,
                    $calculated_balance,
                    $previous_balance
                )
            );
        }

        return $calculated_balance;
    }

    /**
     * PROFESSIONAL FEATURE: Conditionally recalculate user tier based on point changes
     *
     * This function intelligently decides when to recalculate tiers:
     * - Always recalculate if user has no tier assigned
     * - Recalculate if points changed significantly (crossed tier thresholds)
     * - Skip recalculation for minor changes to avoid unnecessary database queries
     * - Rate limiting: Prevent too frequent recalculations (max once per 5 minutes per user)
     *
     * @param int $user_id User ID
     * @param int $previous_balance Previous points balance
     * @param int $current_balance Current points balance
     */
    private function maybe_recalculate_user_tier($user_id, $previous_balance, $current_balance)
    {
        global $wpdb;

        if (!$user_id || $user_id <= 0) {
            return;
        }

        // PROFESSIONAL OPTIMIZATION: Rate limiting - prevent too frequent recalculations
        // Check if we recently recalculated for this user (within last 5 minutes)
        $recalc_lock_key = 'twork_tier_recalc_lock_' . $user_id;
        $last_recalc_time = get_transient($recalc_lock_key);

        if ($last_recalc_time !== false) {
            // Recently recalculated, skip to prevent unnecessary database queries
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(
                    sprintf(
                        'T-Work Rewards: Tier recalculation skipped for user %d (rate limited). Last recalc: %s',
                        $user_id,
                        date('Y-m-d H:i:s', $last_recalc_time)
                    )
                );
            }
            return;
        }

        $tiers_table = $this->point_tiers_table_name();
        $table_check = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $tiers_table));

        if ($table_check !== $tiers_table) {
            return;  // Tier system not available
        }

        // Get current tier assignment (uses cache, so it's fast)
        $current_tier = $this->get_user_tier($user_id);

        // Always recalculate if no tier assigned (but still respect rate limit)
        if (!$current_tier) {
            // Set rate limit lock before calculation
            set_transient($recalc_lock_key, time(), 5 * MINUTE_IN_SECONDS);
            $this->calculate_user_tier($user_id, true);
            return;
        }

        // Check if points crossed any tier threshold
        // PROFESSIONAL OPTIMIZATION: Cache tier thresholds (they don't change often)
        $thresholds_cache_key = 'twork_tier_thresholds';
        $tier_thresholds = get_transient($thresholds_cache_key);

        if ($tier_thresholds === false) {
            $tier_thresholds = $wpdb->get_col(
                "SELECT DISTINCT min_points FROM $tiers_table WHERE is_active = 1 AND min_points > 0 ORDER BY min_points ASC"
            );
            // Cache thresholds for 1 hour (they rarely change)
            set_transient($thresholds_cache_key, $tier_thresholds, HOUR_IN_SECONDS);
        }

        $should_recalculate = false;

        // Check if we crossed any threshold
        foreach ($tier_thresholds as $threshold) {
            $threshold = (int) $threshold;
            // Crossed threshold going up or down
            if (($previous_balance < $threshold && $current_balance >= $threshold) ||
                    ($previous_balance >= $threshold && $current_balance < $threshold)) {
                $should_recalculate = true;
                break;
            }
        }

        // Also recalculate if change is significant (more than 10% of current balance or 1000 points)
        $change_amount = abs($current_balance - $previous_balance);
        $significant_change = $change_amount >= 1000 ||
            ($current_balance > 0 && $change_amount >= ($current_balance * 0.1));

        if ($should_recalculate || $significant_change) {
            // Set rate limit lock before calculation
            set_transient($recalc_lock_key, time(), 5 * MINUTE_IN_SECONDS);
            $this->calculate_user_tier($user_id, true);

            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(
                    sprintf(
                        'T-Work Rewards: Tier recalculated for user %d. Previous: %d, Current: %d, Change: %d',
                        $user_id,
                        $previous_balance,
                        $current_balance,
                        $change_amount
                    )
                );
            }
        }
    }

    /**
     * PROFESSIONAL FIX: Calculate user's point balance from transactions
     * This is the PRIMARY source of truth for point balance
     *
     * CRITICAL: This function determines the actual balance shown in the app
     * It calculates from transaction history, not from stored meta values
     *
     * @param int $user_id User ID
     * @return int Calculated balance
     */
    private function calculate_points_balance_from_transactions($user_id)
    {
        global $wpdb;

        // Check if points system table exists
        $table_name = $wpdb->prefix . 'twork_point_transactions';
        $table_exists = $wpdb->get_var($wpdb->prepare(
            'SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = %s AND table_name = %s',
            DB_NAME,
            $table_name
        ));

        if (!$table_exists) {
            // FALLBACK: Table doesn't exist, use points_balance meta as source of truth
            // This ensures backward compatibility with older installations
            $balance = get_user_meta($user_id, 'points_balance', true);
            $calculated = is_numeric($balance) ? max(0, (int) $balance) : 0;

            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log(sprintf(
                    'T-Work Rewards: Points table not found. Using points_balance meta. User ID: %d, Balance: %d',
                    $user_id,
                    $calculated
                ));
            }

            return $calculated;
        }

        // PROFESSIONAL FIX: Calculate balance from transactions
        // Include approved transactions AND pending redeem transactions
        // Why? When user exchanges points, we deduct immediately (pending redeem)
        // This prevents double-spending while waiting for admin approval
        //
        // Transaction types:
        // - earn (approved): Add points
        // - refund (approved): Add points back
        // - redeem (approved): Subtract points (admin approved exchange)
        // - redeem (pending): Subtract points (user requested exchange, not yet approved)
        // - redeem (rejected): Ignored (will have corresponding refund transaction)
        $balance = $wpdb->get_var($wpdb->prepare(
            "SELECT 
                COALESCE(SUM(
                    CASE 
                        WHEN type = 'earn' AND status = 'approved' THEN points
                        WHEN type = 'refund' AND status = 'approved' THEN points
                        WHEN type = 'redeem' AND status = 'approved' THEN -points
                        WHEN type = 'redeem' AND status = 'pending' THEN -points
                        ELSE 0
                    END
                ), 0) as balance
            FROM $table_name
            WHERE user_id = %d 
            AND (expires_at IS NULL OR expires_at > NOW())",
            $user_id
        ));

        $calculated = max(0, (int) $balance);

        // CRITICAL DEBUG: Log balance calculation for troubleshooting.
        if (defined('WP_DEBUG') && WP_DEBUG) {
            // Get transaction count and breakdown for debugging.
            $txn_count = $wpdb->get_var(
                $wpdb->prepare(
                    "SELECT COUNT(*) FROM $table_name WHERE user_id = %d",
                    $user_id
                )
            );

            // Get transaction breakdown.
            $breakdown = $wpdb->get_results(
                $wpdb->prepare(
                    "SELECT type, status, SUM(points) as total_points, COUNT(*) as count
                     FROM $table_name 
                     WHERE user_id = %d 
                     GROUP BY type, status",
                    $user_id
                ),
                ARRAY_A
            );

            error_log(
                sprintf(
                    'T-Work Rewards: Balance calculated. User ID: %d, Balance: %d, Transaction Count: %d',
                    $user_id,
                    $calculated,
                    $txn_count
                )
            );

            if (!empty($breakdown)) {
                error_log('T-Work Rewards: Transaction breakdown:');
                foreach ($breakdown as $item) {
                    error_log(
                        sprintf(
                            '  - Type: %s, Status: %s, Total Points: %d, Count: %d',
                            $item['type'],
                            $item['status'],
                            $item['total_points'],
                            $item['count']
                        )
                    );
                }
            } else {
                error_log('T-Work Rewards: No transactions found for this user.');
            }
        }

        return $calculated;
    }

    /**
     * Add custom field to user REST response so the app can display it
     *
     * This appears in Profile > Additional Information section in the app
     */
    public function add_custom_fields_to_user_rest_api($response, $user, $request)
    {
        if (!($response instanceof WP_REST_Response)) {
            return $response;
        }
        $data = $response->get_data();

        // Ensure custom_fields array exists
        if (!isset($data['custom_fields']) || !is_array($data['custom_fields'])) {
            $data['custom_fields'] = array();
        }

        // PROFESSIONAL ARCHITECTURE: Refresh cache from transactions
        //
        // SINGLE SOURCE OF TRUTH: twork_point_transactions table
        // Meta fields (my_points, points_balance) are CACHE ONLY
        //
        // This is called every time app requests user data
        // It ensures app always shows the correct balance from transaction history
        $calculated_balance = $this->refresh_user_points_cache($user->ID);
        $my_points = (string) $calculated_balance;

        // Add to custom_fields
        $data['custom_fields']['my_points'] = is_string($my_points) ? $my_points : '';
        // Also add my_point (singular) for backward compatibility
        $data['custom_fields']['my_point'] = is_string($my_points) ? $my_points : '';

        // Note: Activity status is tracked on backend for admin purposes only
        // It is NOT exposed to mobile app via REST API for privacy and performance reasons
        // Backend tracks: twork_last_activity, twork_last_login (stored in user meta)
        // Admin can view activity status in WordPress admin panel only

        // Also add to meta for backward compatibility and easier access
        if (!isset($data['meta']) || !is_array($data['meta'])) {
            $data['meta'] = array();
        }
        $data['meta']['my_points'] = is_string($my_points) ? $my_points : '';

        $response->set_data($data);
        return $response;
    }

    /**
     * Code Prefixes management page
     */
    public function render_codes_page()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('You do not have permission to access this page.', 'twork-rewards'));
        }

        global $wpdb;
        $codes_table = $this->codes_table_name();

        // Pagination for codes to prevent memory issues
        $paged = isset($_GET['paged']) ? max(1, intval($_GET['paged'])) : 1;
        $per_page = isset($_GET['per_page']) ? intval($_GET['per_page']) : 50;
        $per_page = ($per_page > 0) ? min(200, $per_page) : 50;
        $offset = ($paged - 1) * $per_page;

        // Get total count
        $total = (int) $wpdb->get_var("SELECT COUNT(*) FROM $codes_table");

        // Get paginated codes, ordered by most recent first
        $codes = $wpdb->get_results($wpdb->prepare(
            "SELECT * FROM $codes_table ORDER BY created_at DESC, id DESC LIMIT %d OFFSET %d",
            $per_page,
            $offset
        ));

        $total_pages = $per_page > 0 ? (int) ceil(max(0, $total) / $per_page) : 1;

        $saved_code_prefix = '';
        if (isset($_GET['updated']) && intval($_GET['updated']) === 1) {
            // Get the saved code prefix from URL or recent code
            if (isset($_GET['code']) && !empty($_GET['code'])) {
                $saved_code_prefix = sanitize_text_field($_GET['code']);
            } elseif (!empty($codes)) {
                $saved_code_prefix = $codes[0]->code_prefix;
            }
        }

        $edit_id = isset($_GET['edit']) ? absint($_GET['edit']) : 0;
        $edit_code = null;
        if ($edit_id > 0) {
            $edit_code = $wpdb->get_row($wpdb->prepare("SELECT * FROM $codes_table WHERE id = %d", $edit_id));
        }
        ?>
        <style>
            /* Scope all styles to only affect this plugin's admin page */
            body.twork-rewards-admin-page .twork-codes-notice {
                margin: 20px 0 !important;
                padding: 15px 20px !important;
                background: #fff !important;
                border-left: 4px solid #46b450 !important;
                box-shadow: 0 1px 1px rgba(0,0,0,.04) !important;
            }
            body.twork-rewards-admin-page .twork-codes-notice strong {
                color: #46b450;
                font-size: 16px;
            }
            body.twork-rewards-admin-page .twork-codes-list {
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 20px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            body.twork-rewards-admin-page .twork-codes-list h2 {
                margin-top: 0;
                padding-bottom: 15px;
                border-bottom: 2px solid #f0f0f0;
            }
            body.twork-rewards-admin-page .twork-codes-form {
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                padding: 20px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            body.twork-rewards-admin-page .twork-codes-form h2 {
                margin-top: 0;
                padding-bottom: 15px;
                border-bottom: 2px solid #f0f0f0;
            }
            body.twork-rewards-admin-page .twork-code-row.newly-added {
                background: #f0f9ff !important;
                border-left: 4px solid #46b450 !important;
                animation: highlightFade 3s ease-out;
            }
            @keyframes highlightFade {
                0% { background: #d4edda; }
                100% { background: #f0f9ff; }
            }
        </style>
        <script>
            // Add body class to scope CSS
            document.addEventListener('DOMContentLoaded', function() {
                document.body.classList.add('twork-rewards-admin-page');
            });
        </script>
        <div class="wrap">
            <h1 class="wp-heading-inline"><?php esc_html_e('Code Prefixes', 'twork-rewards'); ?></h1>
            <a href="<?php echo esc_url(admin_url('admin.php?page=twork-rewards-codes')); ?>" class="page-title-action"><?php esc_html_e('Add New', 'twork-rewards'); ?></a>
            <hr class="wp-header-end">

            <?php if (isset($_GET['updated']) && intval($_GET['updated']) === 1): ?>
                <div class="twork-codes-notice notice notice-success is-dismissible">
                    <p>
                        <strong><?php esc_html_e('âœ“ Code saved successfully!', 'twork-rewards'); ?></strong>
                        <?php if (!empty($saved_code_prefix)): ?>
                            <br><?php printf(esc_html__('Code "%s" has been saved. You can see it in the list below.', 'twork-rewards'), esc_html($saved_code_prefix)); ?>
                        <?php endif; ?>
                    </p>
                </div>
            <?php endif; ?>

            <?php if (isset($_GET['deleted']) && intval($_GET['deleted']) === 1): ?>
                <div class="twork-codes-notice notice notice-success is-dismissible">
                    <p><strong><?php esc_html_e('âœ“ Code deleted successfully!', 'twork-rewards'); ?></strong></p>
                </div>
            <?php endif; ?>

            <!-- Codes List (Top) -->
            <div class="twork-codes-list">
                <h2><?php esc_html_e('All Codes', 'twork-rewards'); ?> (<?php echo number_format($total); ?>)</h2>
                <?php if (!empty($codes)): ?>
                    <table class="wp-list-table widefat fixed striped">
                        <thead>
                        <tr>
                            <th style="width: 200px;"><?php esc_html_e('Code', 'twork-rewards'); ?></th>
                            <th><?php esc_html_e('Points', 'twork-rewards'); ?></th>
                            <th style="width: 120px;"><?php esc_html_e('Uses', 'twork-rewards'); ?></th>
                            <th style="width: 100px;"><?php esc_html_e('Status', 'twork-rewards'); ?></th>
                            <th style="width: 150px;"><?php esc_html_e('Actions', 'twork-rewards'); ?></th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php
                        foreach ($codes as $code):
                            $is_newly_added = isset($_GET['updated']) && !empty($saved_code_prefix) && $code->code_prefix === $saved_code_prefix;
                            ?>
                            <tr class="<?php echo $is_newly_added ? 'twork-code-row newly-added' : ''; ?>" id="code-<?php echo esc_attr($code->id); ?>">
                                <td><strong style="font-family: monospace; font-size: 14px;"><?php echo esc_html($code->code_prefix); ?></strong></td>
                                <td><?php echo esc_html($code->points_value ?: 'â€”'); ?></td>
                                <td>
                                    <?php
                                    $current_uses = isset($code->current_uses) ? (int) $code->current_uses : 0;
                                    $max_uses = isset($code->max_uses) && $code->max_uses > 0 ? (int) $code->max_uses : null;
                                    echo esc_html($current_uses);
                                    if ($max_uses !== null) {
                                        echo ' / ' . esc_html($max_uses);
                                        if ($current_uses >= $max_uses) {
                                            echo ' <span style="color: #dc3232; font-weight: bold;">(' . esc_html__('Full', 'twork-rewards') . ')</span>';
                                        }
                                    } else {
                                        echo ' <span style="color: #666;">(' . esc_html__('Unlimited', 'twork-rewards') . ')</span>';
                                    }
                                    ?>
                                </td>
                                <td>
                                    <span style="color: <?php echo $code->is_active ? '#46b450' : '#dc3232'; ?>; font-weight: 600;">
                                        <?php echo $code->is_active ? esc_html__('Active', 'twork-rewards') : esc_html__('Inactive', 'twork-rewards'); ?>
                                    </span>
                                </td>
                                <td>
                                    <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-codes', 'edit' => $code->id), admin_url('admin.php'))); ?>" class="button button-small"><?php esc_html_e('Edit', 'twork-rewards'); ?></a>
                                    <a href="<?php echo esc_url(wp_nonce_url(add_query_arg(array('action' => 'twork_rewards_delete_code', 'delete' => $code->id), admin_url('admin-post.php')), 'delete_code_' . $code->id)); ?>" 
                                       onclick="return confirm('<?php esc_attr_e('Are you sure you want to delete this code?', 'twork-rewards'); ?>');" 
                                       class="button button-small" style="color: #dc3232;"><?php esc_html_e('Delete', 'twork-rewards'); ?></a>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                        </tbody>
                    </table>
                    
                    <?php
                    // Pagination links
                    if ($total_pages > 1) {
                        $pagination_args = array(
                            'base' => add_query_arg('paged', '%#%'),
                            'format' => '',
                            'prev_text' => __('&laquo;'),
                            'next_text' => __('&raquo;'),
                            'total' => $total_pages,
                            'current' => $paged,
                        );
                        echo '<div class="tablenav"><div class="tablenav-pages">';
                        echo paginate_links($pagination_args);
                        echo '</div></div>';
                    }
                    ?>
                    
                    <?php if (isset($_GET['updated']) && !empty($saved_code_prefix)):
                        // Find the saved code ID to scroll to
                        $saved_code_id = null;
                        foreach ($codes as $code) {
                            if ($code->code_prefix === $saved_code_prefix) {
                                $saved_code_id = $code->id;
                                break;
                            }
                        }
                        if ($saved_code_id): ?>
                        <script>
                            setTimeout(function() {
                                var row = document.getElementById('code-<?php echo esc_js($saved_code_id); ?>');
                                if (row) {
                                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                            }, 100);
                        </script>
                        <?php endif; ?>
                    <?php endif; ?>
                <?php else: ?>
                    <p style="padding: 20px; text-align: center; color: #666;">
                        <?php esc_html_e('No codes found. Add your first code using the form below.', 'twork-rewards'); ?>
                    </p>
                <?php endif; ?>
            </div>

            <!-- Add/Edit Form (Bottom) -->
            <div class="twork-codes-form">
                    <h2><?php echo $edit_id > 0 ? esc_html__('Edit Code', 'twork-rewards') : esc_html__('Add New Code', 'twork-rewards'); ?></h2>
                    <form method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>">
                        <?php wp_nonce_field('twork_rewards_save_code', 'twork_rewards_code_nonce'); ?>
                        <input type="hidden" name="action" value="twork_rewards_save_code" />
                        <?php if ($edit_id > 0): ?>
                            <input type="hidden" name="code_id" value="<?php echo esc_attr($edit_id); ?>" />
                        <?php endif; ?>

                        <table class="form-table">
                            <tr>
                                <th scope="row">
                                    <label for="code_prefix"><?php esc_html_e('Code Prefix', 'twork-rewards'); ?></label>
                                </th>
                                <td>
                                    <input type="text" 
                                           class="regular-text" 
                                           name="code_prefix" 
                                           id="code_prefix"
                                           value="<?php echo $edit_code ? esc_attr($edit_code->code_prefix) : ''; ?>"
                                           required />
                                    <p class="description"><?php esc_html_e('Enter the code prefix (e.g., 1234656789101). Users will enter this exact code to redeem.', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">
                                    <label for="points_value"><?php esc_html_e('Points Value', 'twork-rewards'); ?></label>
                                </th>
                                <td>
                                    <input type="text" 
                                           class="regular-text" 
                                           name="points_value" 
                                           id="points_value"
                                           value="<?php echo $edit_code ? esc_attr($edit_code->points_value) : ''; ?>"
                                           placeholder="<?php esc_attr_e('e.g., 1', 'twork-rewards'); ?>" />
                                    <p class="description"><?php esc_html_e('Points to add when code is redeemed (e.g., 1). Leave empty if no points.', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">
                                    <label for="description"><?php esc_html_e('Description', 'twork-rewards'); ?></label>
                                </th>
                                <td>
                                    <textarea name="description" 
                                              id="description" 
                                              class="large-text" 
                                              rows="3"><?php echo $edit_code ? esc_textarea($edit_code->description) : ''; ?></textarea>
                                    <p class="description"><?php esc_html_e('Optional description for this code.', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">
                                    <label for="max_uses"><?php esc_html_e('Max Uses', 'twork-rewards'); ?></label>
                                </th>
                                <td>
                                    <input type="number" 
                                           class="small-text" 
                                           name="max_uses" 
                                           id="max_uses"
                                           value="<?php echo $edit_code ? esc_attr($edit_code->max_uses) : ''; ?>"
                                           min="1"
                                           placeholder="<?php esc_attr_e('Unlimited', 'twork-rewards'); ?>" />
                                    <p class="description"><?php esc_html_e('Maximum number of users who can claim this code. Leave empty for unlimited. Each user can only claim once.', 'twork-rewards'); ?></p>
                                    <?php if ($edit_code && isset($edit_code->current_uses)): ?>
                                        <p class="description" style="color: #666; margin-top: 5px;">
                                            <strong><?php esc_html_e('Current Uses:', 'twork-rewards'); ?></strong> 
                                            <?php echo esc_html($edit_code->current_uses); ?>
                                            <?php if ($edit_code->max_uses > 0): ?>
                                                / <?php echo esc_html($edit_code->max_uses); ?>
                                            <?php endif; ?>
                                        </p>
                                    <?php endif; ?>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">
                                    <label for="is_active"><?php esc_html_e('Active', 'twork-rewards'); ?></label>
                                </th>
                                <td>
                                    <label>
                                        <input type="checkbox" 
                                               name="is_active" 
                                               id="is_active"
                                               value="1" <?php checked($edit_code ? $edit_code->is_active : 1, 1); ?> />
                                        <?php esc_html_e('Enable this code', 'twork-rewards'); ?>
                                    </label>
                                    <p class="description"><?php esc_html_e('Only active codes can be redeemed.', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                        </table>

                        <?php submit_button($edit_id > 0 ? __('Update Code', 'twork-rewards') : __('Add Code', 'twork-rewards')); ?>
                        <?php if ($edit_id > 0): ?>
                            <a href="<?php echo esc_url(admin_url('admin.php?page=twork-rewards-codes')); ?>" class="button"><?php esc_html_e('Cancel', 'twork-rewards'); ?></a>
                        <?php endif; ?>
                    </form>
                </div>
            </div>
        </div>
        <?php
    }

    /**
     * Handle code save
     */
    public function handle_code_save()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }
        check_admin_referer('twork_rewards_save_code', 'twork_rewards_code_nonce');

        $code_id = isset($_POST['code_id']) ? absint($_POST['code_id']) : 0;
        $code_prefix = isset($_POST['code_prefix']) ? trim(sanitize_text_field(wp_unslash($_POST['code_prefix']))) : '';
        $points_value = isset($_POST['points_value']) ? trim(sanitize_text_field(wp_unslash($_POST['points_value']))) : '';
        $description = isset($_POST['description']) ? trim(sanitize_textarea_field(wp_unslash($_POST['description']))) : '';
        $max_uses = isset($_POST['max_uses']) && !empty($_POST['max_uses']) ? absint($_POST['max_uses']) : null;
        $is_active = isset($_POST['is_active']) ? 1 : 0;

        if (empty($code_prefix)) {
            wp_die(__('Code prefix is required.', 'twork-rewards'));
        }

        global $wpdb;
        $codes_table = $this->codes_table_name();

        if ($code_id > 0) {
            // Update existing
            // Check if code prefix already exists for another code
            $existing = $wpdb->get_var($wpdb->prepare(
                "SELECT id FROM $codes_table WHERE code_prefix = %s AND id != %d",
                $code_prefix,
                $code_id
            ));
            if ($existing) {
                wp_die(sprintf(__('Code prefix "%s" already exists. Please use a different code.', 'twork-rewards'), esc_html($code_prefix)));
            }

            $update_result = $wpdb->update(
                $codes_table,
                array(
                    'code_prefix' => $code_prefix,
                    'points_value' => $points_value,
                    'description' => $description,
                    'max_uses' => $max_uses,
                    'is_active' => $is_active,
                    'updated_at' => current_time('mysql'),
                ),
                array('id' => $code_id),
                array('%s', '%s', '%s', '%d', '%d', '%s'),
                array('%d')
            );

            if ($update_result === false) {
                $error_msg = $wpdb->last_error ? $wpdb->last_error : __('Unknown database error occurred.', 'twork-rewards');
                error_log('T-Work Rewards: Failed to update code. Error: ' . $error_msg);
                wp_die(sprintf(__('Failed to update code. Error: %s', 'twork-rewards'), esc_html($error_msg)));
            }
        } else {
            // Insert new - Check for duplicate code prefix first
            $existing = $wpdb->get_var($wpdb->prepare(
                "SELECT id FROM $codes_table WHERE code_prefix = %s",
                $code_prefix
            ));
            if ($existing) {
                wp_die(sprintf(__('Code prefix "%s" already exists. Please use a different code.', 'twork-rewards'), esc_html($code_prefix)));
            }

            // Insert new - build insert with proper handling of null/empty values
            $insert_data = array(
                'code_prefix' => $code_prefix,
                'current_uses' => 0,
                'is_active' => $is_active,
                'created_at' => current_time('mysql'),
                'updated_at' => current_time('mysql'),
            );

            $format_array = array('%s', '%d', '%d', '%s', '%s');

            // Add optional fields - use empty string instead of null for better compatibility
            if (!empty($points_value)) {
                $insert_data['points_value'] = $points_value;
            }
            if (!empty($description)) {
                $insert_data['description'] = $description;
            }
            if ($max_uses !== null && $max_uses > 0) {
                $insert_data['max_uses'] = $max_uses;
            }

            // Rebuild arrays in correct order with matching formats
            $ordered_data = array();
            $ordered_format = array();
            $field_order = array('code_prefix', 'points_value', 'description', 'max_uses', 'current_uses', 'is_active', 'created_at', 'updated_at');

            foreach ($field_order as $field) {
                if (isset($insert_data[$field])) {
                    $ordered_data[$field] = $insert_data[$field];
                    // Determine format based on field type
                    if (in_array($field, array('code_prefix', 'points_value', 'description', 'created_at', 'updated_at'))) {
                        $ordered_format[] = '%s';
                    } elseif (in_array($field, array('max_uses', 'current_uses', 'is_active'))) {
                        $ordered_format[] = '%d';
                    }
                }
            }

            $insert_result = $wpdb->insert(
                $codes_table,
                $ordered_data,
                $ordered_format
            );

            // Check if insert was successful
            if ($insert_result === false) {
                $error_msg = $wpdb->last_error ? $wpdb->last_error : __('Unknown database error occurred.', 'twork-rewards');
                error_log('T-Work Rewards: Failed to insert code. Error: ' . $error_msg);
                error_log('T-Work Rewards: Insert data - code_prefix: ' . $code_prefix . ', points_value: ' . $points_value);
                wp_die(sprintf(__('Failed to save code. Error: %s. Please check the error logs for more details.', 'twork-rewards'), esc_html($error_msg)));
            }
        }

        // Get the saved code prefix for redirect
        $saved_code_prefix = $code_prefix;
        wp_safe_redirect(add_query_arg(array(
            'page' => 'twork-rewards-codes',
            'updated' => 1,
            'code' => urlencode($saved_code_prefix)
        ), admin_url('admin.php')));
        exit;
    }

    /**
     * Handle code delete
     */
    public function handle_code_delete()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }

        $code_id = isset($_GET['delete']) ? absint($_GET['delete']) : 0;
        if ($code_id <= 0) {
            wp_die(__('Invalid code ID.', 'twork-rewards'));
        }

        check_admin_referer('delete_code_' . $code_id);

        global $wpdb;
        $codes_table = $this->codes_table_name();
        $wpdb->delete($codes_table, array('id' => $code_id), array('%d'));

        wp_safe_redirect(add_query_arg(array('page' => 'twork-rewards-codes', 'deleted' => 1), admin_url('admin.php')));
        exit;
    }

    /**
     * Render exchange requests management page
     */
    public function render_engagement_page()
    {
        if (!current_user_can('manage_woocommerce') && !current_user_can('manage_options')) {
            wp_die(__('You do not have permission to access this page.', 'twork-rewards'));
        }

        // Enqueue media uploader
        wp_enqueue_media();

        global $wpdb;
        $table_name = $wpdb->prefix . 'twork_engagement_items';
        $interactions_table = $wpdb->prefix . 'twork_user_interactions';
        $action = isset($_GET['action']) ? sanitize_text_field($_GET['action']) : 'list';
        $id = isset($_GET['id']) ? absint($_GET['id']) : 0;

        ?>
        <style>
            /* Professional Engagement Hub Styling */
            body.twork-engagement-admin .wrap {
                max-width: 1400px;
            }
            .twork-engagement-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 25px 30px;
                border-radius: 8px;
                margin-bottom: 25px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }
            .twork-engagement-header h1 {
                color: white;
                margin: 0;
                font-size: 28px;
                font-weight: 600;
            }
            .twork-engagement-header .page-title-action {
                background: rgba(255,255,255,0.2);
                border: 1px solid rgba(255,255,255,0.3);
                color: white;
                padding: 8px 16px;
                border-radius: 6px;
                text-decoration: none;
                font-weight: 500;
                transition: all 0.3s;
                margin-left: 15px;
            }
            .twork-engagement-header .page-title-action:hover {
                background: rgba(255,255,255,0.3);
                transform: translateY(-1px);
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            }
            .twork-engagement-card {
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                padding: 25px;
                margin-bottom: 25px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                transition: box-shadow 0.3s;
            }
            .twork-engagement-card:hover {
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }
            .twork-engagement-card h2 {
                margin-top: 0;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 2px solid #f0f0f0;
                font-size: 20px;
                color: #333;
                font-weight: 600;
            }
            .twork-stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            .twork-stat-card {
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                padding: 20px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                transition: all 0.3s;
                border-left: 4px solid #667eea;
            }
            .twork-stat-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }
            .twork-stat-card.blue { border-left-color: #2196F3; }
            .twork-stat-card.green { border-left-color: #4CAF50; }
            .twork-stat-card.orange { border-left-color: #FF9800; }
            .twork-stat-card.amber { border-left-color: #F59E0B; }
            .twork-stat-label {
                font-size: 12px;
                color: #666;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 8px;
                font-weight: 500;
            }
            .twork-stat-value {
                font-size: 28px;
                font-weight: 700;
                color: #333;
                margin: 0;
            }
            .twork-engagement-table {
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            .twork-engagement-table table {
                margin: 0;
                border: none;
            }
            .twork-engagement-table thead th {
                background: #f9fafb;
                padding: 15px;
                font-weight: 600;
                color: #333;
                border-bottom: 2px solid #e0e0e0;
                text-transform: uppercase;
                font-size: 12px;
                letter-spacing: 0.5px;
            }
            .twork-engagement-table tbody td {
                padding: 15px;
                border-bottom: 1px solid #f0f0f0;
                vertical-align: middle;
            }
            .twork-engagement-table tbody tr:hover {
                background: #f9fafb;
            }
            .twork-type-badge {
                display: inline-block;
                padding: 4px 12px;
                border-radius: 12px;
                font-size: 11px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            .twork-type-badge.quiz {
                background: #e3f2fd;
                color: #1976d2;
            }
            .twork-type-badge.poll {
                background: #fff3e0;
                color: #f57c00;
            }
            .twork-type-badge.banner {
                background: #f3e5f5;
                color: #7b1fa2;
            }
            .twork-type-badge.announcement {
                background: #e8f5e9;
                color: #388e3c;
            }
            .twork-status-badge {
                display: inline-block;
                padding: 4px 12px;
                border-radius: 12px;
                font-size: 11px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            .twork-status-badge.active {
                background: #d4edda;
                color: #155724;
            }
            .twork-status-badge.draft {
                background: #fff3cd;
                color: #856404;
            }
            .twork-status-badge.archived {
                background: #f8d7da;
                color: #721c24;
            }
            .twork-action-buttons {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
            }
            .twork-action-buttons .button {
                padding: 6px 12px;
                border-radius: 6px;
                font-size: 12px;
                font-weight: 500;
                text-decoration: none;
                transition: all 0.2s;
                border: 1px solid;
            }
            .twork-action-buttons .button.button-small {
                padding: 6px 12px;
                height: auto;
                line-height: 1.4;
            }
            .twork-action-buttons .button-primary {
                background: #667eea;
                border-color: #667eea;
                color: white;
            }
            .twork-action-buttons .button-primary:hover {
                background: #5568d3;
                border-color: #5568d3;
                transform: translateY(-1px);
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            }
            .twork-action-buttons .button-link-delete {
                color: #dc3545;
                border-color: #dc3545;
                background: transparent;
            }
            .twork-action-buttons .button-link-delete:hover {
                background: #dc3545;
                color: white;
            }
            .twork-interaction-stats {
                font-size: 13px;
                color: #666;
            }
            .twork-interaction-stats strong {
                color: #333;
                font-weight: 600;
            }
            .twork-interaction-stats .correct {
                color: #4CAF50;
                font-weight: 600;
            }
            .twork-interaction-stats .incorrect {
                color: #FF9800;
                font-weight: 600;
            }
            .twork-nav-tabs {
                border-bottom: 2px solid #e0e0e0;
                margin-bottom: 25px;
            }
            .twork-nav-tabs .nav-tab {
                padding: 12px 20px;
                margin-right: 5px;
                border: none;
                border-bottom: 3px solid transparent;
                background: transparent;
                color: #666;
                font-weight: 500;
                transition: all 0.3s;
            }
            .twork-nav-tabs .nav-tab:hover {
                color: #667eea;
                background: #f9fafb;
            }
            .twork-nav-tabs .nav-tab-active {
                color: #667eea;
                border-bottom-color: #667eea;
                background: transparent;
            }
            .twork-form-card {
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                padding: 30px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            .twork-form-card .form-table th {
                font-weight: 600;
                color: #333;
                padding: 15px 10px 15px 0;
            }
            .twork-form-card .form-table td {
                padding: 15px 10px;
            }
            .twork-form-card input[type="text"],
            .twork-form-card input[type="number"],
            .twork-form-card input[type="url"],
            .twork-form-card select,
            .twork-form-card textarea {
                border: 1px solid #ddd;
                border-radius: 6px;
                padding: 8px 12px;
                transition: border-color 0.3s;
            }
            .twork-form-card input:focus,
            .twork-form-card select:focus,
            .twork-form-card textarea:focus {
                border-color: #667eea;
                outline: none;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }
            .twork-back-button {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 10px 20px;
                background: #f9fafb;
                border: 1px solid #e0e0e0;
                border-radius: 6px;
                color: #333;
                text-decoration: none;
                font-weight: 500;
                transition: all 0.2s;
                margin-bottom: 20px;
            }
            .twork-back-button:hover {
                background: #f0f0f0;
                border-color: #667eea;
                color: #667eea;
            }
            @media (max-width: 782px) {
                .twork-stats-grid {
                    grid-template-columns: 1fr;
                }
                .twork-action-buttons {
                    flex-direction: column;
                }
                .twork-action-buttons .button {
                    width: 100%;
                    text-align: center;
                }
            }
        </style>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                document.body.classList.add('twork-engagement-admin');
            });
        </script>
        <div class="wrap">
            <?php if ($action === 'list'): ?>
                <div class="twork-engagement-header">
                    <h1 class="wp-heading-inline" style="color: white; margin: 0;">
                        <?php echo __('Engagement Hub', 'twork-rewards'); ?>
                    </h1>
                    <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-engagement', 'action' => 'add'), admin_url('admin.php'))); ?>" class="page-title-action">
                        <?php esc_html_e('+ Add New', 'twork-rewards'); ?>
                    </a>
                </div>
            <?php else: ?>
                <h1 class="wp-heading-inline">
                    <?php
                    if ($action === 'edit')
                        echo __('Edit Engagement Item', 'twork-rewards');
                    elseif ($action === 'add')
                        echo __('Add New Engagement Item', 'twork-rewards');
                    else
                        echo __('Engagement Hub', 'twork-rewards');
                    ?>
                </h1>
            <?php endif; ?>
            <hr class="wp-header-end">

            <?php
            // Show notifications
            if (isset($_GET['updated']) && $_GET['updated']) {
                echo '<div class="notice notice-success is-dismissible"><p>' . esc_html__('Item saved successfully.', 'twork-rewards') . '</p></div>';
            }
            if (isset($_GET['deleted']) && $_GET['deleted']) {
                echo '<div class="notice notice-success is-dismissible"><p>' . esc_html__('Item deleted successfully.', 'twork-rewards') . '</p></div>';
            }
            if (isset($_GET['settings_updated']) && $_GET['settings_updated']) {
                echo '<div class="notice notice-success is-dismissible"><p>' . esc_html__('Settings saved successfully.', 'twork-rewards') . '</p></div>';
            }

            // Global Rotation Duration Settings (only show in list view)
            if ($action === 'list') {
                $global_rotation_duration = get_option('twork_engagement_global_rotation_duration', 5);
                ?>
                <div class="twork-engagement-card" style="margin-bottom: 25px;">
                    <h2 style="margin-top: 0; margin-bottom: 20px; font-size: 20px; color: #333; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                        <span class="dashicons dashicons-admin-settings" style="vertical-align: middle; margin-right: 8px;"></span>
                        <?php esc_html_e('Global Rotation Settings', 'twork-rewards'); ?>
                    </h2>
                    <form method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>" style="max-width: 600px;">
                        <input type="hidden" name="action" value="twork_rewards_save_engagement_settings">
                        <?php wp_nonce_field('twork_rewards_save_engagement_settings'); ?>
                        
                        <table class="form-table">
                            <tr>
                                <th scope="row">
                                    <label for="global_rotation_duration">
                                        <?php esc_html_e('Default Rotation Duration', 'twork-rewards'); ?>
                                    </label>
                                </th>
                                <td>
                                    <input 
                                        type="number" 
                                        name="global_rotation_duration" 
                                        id="global_rotation_duration" 
                                        value="<?php echo esc_attr($global_rotation_duration); ?>" 
                                        min="1" 
                                        max="60" 
                                        step="1"
                                        class="regular-text"
                                        style="width: 100px;"
                                        required
                                    >
                                    <span style="margin-left: 10px; color: #666;">
                                        <?php esc_html_e('seconds (1-60)', 'twork-rewards'); ?>
                                    </span>
                                    <p class="description" style="margin-top: 8px;">
                                        <?php esc_html_e("This setting applies to all engagement items that don't have an individual rotation duration set. Individual items can override this value.", 'twork-rewards'); ?>
                                    </p>
                                </td>
                            </tr>
                        </table>
                        
                        <p class="submit">
                            <button type="submit" class="button button-primary">
                                <?php esc_html_e('Save Settings', 'twork-rewards'); ?>
                            </button>
                        </p>
                    </form>
                </div>
                <?php
            }

            // View Results for specific item
            if ($action === 'view_results' && $id > 0) {
                $item = $wpdb->get_row($wpdb->prepare("SELECT * FROM $table_name WHERE id = %d", $id));
                if (!$item) {
                    echo '<div class="notice notice-error"><p>' . esc_html__('Item not found.', 'twork-rewards') . '</p></div>';
                } else {
                    $interactions = $wpdb->get_results($wpdb->prepare(
                        "SELECT i.*, 
                         u.display_name as user_name, u.user_email,
                         u.ID as user_id
                         FROM $interactions_table i
                         LEFT JOIN {$wpdb->users} u ON i.user_id = u.ID
                         WHERE i.item_id = %d
                         ORDER BY i.created_at DESC",
                        $id
                    ));

                    // PROFESSIONAL FIX: Calculate statistics with real-time correct answer checking
                    $quiz_data = json_decode($item->quiz_data, true);
                    $correct_index = null;
                    if (is_array($quiz_data) && isset($quiz_data['correct_index'])) {
                        $correct_index = (int) $quiz_data['correct_index'];
                    }

                    // Get all interactions for this item
                    $all_interactions_for_stats = $wpdb->get_results($wpdb->prepare(
                        "SELECT interaction_value, is_correct, points_awarded 
                         FROM $interactions_table 
                         WHERE item_id = %d",
                        $id
                    ));

                    // Calculate statistics with real-time checking
                    $total = count($all_interactions_for_stats);
                    $correct_count = 0;
                    $total_points = 0;

                    foreach ($all_interactions_for_stats as $interaction_stat) {
                        $answer_index = (int) $interaction_stat->interaction_value;
                        $is_correct = false;

                        // Real-time check for poll/quiz
                        if (($item->type === 'poll' || $item->type === 'quiz') && $correct_index !== null) {
                            if ($correct_index >= 0) {
                                $is_correct = ($answer_index === $correct_index);
                            } else {
                                // No correct answer - all are correct (participation-based)
                                $is_correct = true;
                            }
                        } else {
                            // Use database value as fallback
                            $is_correct = (bool) $interaction_stat->is_correct;
                        }

                        if ($is_correct) {
                            $correct_count++;
                        }
                        $total_points += (int) $interaction_stat->points_awarded;
                    }

                    // Create stats object for compatibility
                    $stats = (object) array(
                        'total' => $total,
                        'correct_count' => $correct_count,
                        'total_points' => $total_points
                    );
                    ?>
                    <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-engagement'), admin_url('admin.php'))); ?>" class="twork-back-button">
                        â† Back to List
                    </a>
                    
                    <div class="twork-engagement-card">
                        <h2><?php echo esc_html($item->title); ?> - Results</h2>
                        
                        <div class="twork-stats-grid">
                            <div class="twork-stat-card blue">
                                <div class="twork-stat-label">Total Responses</div>
                                <div class="twork-stat-value"><?php echo (int) $stats->total; ?></div>
                            </div>
                            <div class="twork-stat-card green">
                                <div class="twork-stat-label">Correct Answers</div>
                                <div class="twork-stat-value"><?php echo (int) $stats->correct_count; ?></div>
                            </div>
                            <div class="twork-stat-card orange">
                                <div class="twork-stat-label">Incorrect Answers</div>
                                <div class="twork-stat-value"><?php echo (int) $stats->total - (int) $stats->correct_count; ?></div>
                            </div>
                            <div class="twork-stat-card amber">
                                <div class="twork-stat-label">Total Points Awarded</div>
                                <div class="twork-stat-value"><?php echo (int) $stats->total_points; ?></div>
                            </div>
                        </div>
                        
                        <h3 style="margin-top: 30px; margin-bottom: 15px; font-size: 18px; color: #333;">Detailed Results</h3>
                        <div class="twork-engagement-table">
                            <table class="wp-list-table widefat fixed striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>User</th>
                                        <th>Answer</th>
                                        <th>Result</th>
                                        <th>Points</th>
                                        <th>Date & Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php
                                    if ($interactions):
                                        foreach ($interactions as $interaction):
                                            $quiz_data = json_decode($item->quiz_data, true);
                                            $answer_index = (int) $interaction->interaction_value;
                                            $answer_text = 'Option ' . ($answer_index + 1);
                                            if ($quiz_data && isset($quiz_data['options'][$answer_index])) {
                                                $answer_text = $quiz_data['options'][$answer_index];
                                            }

                                            // PROFESSIONAL FIX: Real-time check for correct answer (don't trust database value for old data)
                                            $is_correct_display = false;
                                            if ($item->type === 'poll' || $item->type === 'quiz') {
                                                if (is_array($quiz_data) && isset($quiz_data['correct_index'])) {
                                                    $correct_index = (int) $quiz_data['correct_index'];
                                                    // Only check if correct_index is valid (>= 0)
                                                    if ($correct_index >= 0) {
                                                        $is_correct_display = ($answer_index === $correct_index);
                                                    } else {
                                                        // No correct answer defined - treat as participation (all correct)
                                                        $is_correct_display = true;
                                                    }
                                                } else {
                                                    // Invalid quiz data - use database value as fallback
                                                    $is_correct_display = (bool) $interaction->is_correct;
                                                }
                                            } else {
                                                // Not a poll/quiz - use database value
                                                $is_correct_display = (bool) $interaction->is_correct;
                                            }
                                            ?>
                                        <tr>
                                            <td><?php echo $interaction->id; ?></td>
                                            <td>
                                                <strong><?php echo esc_html($interaction->user_name ?: 'User #' . $interaction->user_id); ?></strong><br>
                                                <small style="color: #666;"><?php echo esc_html($interaction->user_email); ?></small>
                                            </td>
                                            <td><?php echo esc_html($answer_text); ?></td>
                                            <td>
                                                <?php if ($is_correct_display): ?>
                                                    <span style="color: green; font-weight: bold;">âœ“ Correct</span>
                                                <?php else: ?>
                                                    <span style="color: red; font-weight: bold;">âœ— Incorrect</span>
                                                <?php endif; ?>
                                            </td>
                                            <td>
                                                <?php if ($interaction->points_awarded > 0): ?>
                                                    <strong style="color: green;">+<?php echo $interaction->points_awarded; ?></strong>
                                                <?php else: ?>
                                                    <span style="color: #999;">0</span>
                                                <?php endif; ?>
                                            </td>
                                            <td><?php
                                            // Professional: Display interaction date in Myanmar timezone
                                            $formatted_datetime = $this->format_myanmar_time($interaction->created_at);
                                            echo esc_html($formatted_datetime ?: $interaction->created_at);
                                            ?></td>
                                        </tr>
                                    <?php endforeach;
                                    else: ?>
                                        <tr><td colspan="6" style="text-align: center; padding: 40px; color: #999;">No results found for this item.</td></tr>
                                    <?php endif; ?>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <?php
                }
            } elseif ($action === 'add' || $action === 'edit') {
                $item = null;
                if ($action === 'edit' && $id > 0) {
                    $item = $wpdb->get_row($wpdb->prepare("SELECT * FROM $table_name WHERE id = %d", $id));
                }

                $quiz_data = ($item && !empty($item->quiz_data)) ? json_decode($item->quiz_data, true) : array();

                // Form UI
                ?>
                <div class="twork-form-card">
                    <form method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>">
                        <input type="hidden" name="action" value="twork_rewards_save_engagement_item">
                        <?php wp_nonce_field('twork_rewards_save_engagement_item'); ?>
                        <?php if ($item): ?>
                            <input type="hidden" name="item_id" value="<?php echo esc_attr($item->id); ?>">
                        <?php endif; ?>

                        <table class="form-table">
                        <tr>
                            <th scope="row"><label for="type"><?php esc_html_e('Type', 'twork-rewards'); ?></label></th>
                            <td>
                                <select name="type" id="type">
                                    <option value="banner" <?php selected($item ? $item->type : '', 'banner'); ?>>Banner</option>
                                    <option value="quiz" <?php selected($item ? $item->type : '', 'quiz'); ?>>Quiz</option>
                                    <option value="poll" <?php selected($item ? $item->type : '', 'poll'); ?>>Poll</option>
                                    <option value="announcement" <?php selected($item ? $item->type : '', 'announcement'); ?>>Announcement</option>
                                    <option value="number" <?php selected($item ? $item->type : '', 'number'); ?>>Number</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row"><label for="title"><?php esc_html_e('Title', 'twork-rewards'); ?></label></th>
                            <td>
                                <input type="text" name="title" id="title" class="regular-text" value="<?php echo esc_attr($item ? $item->title : ''); ?>" required>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row"><label for="media_url"><?php esc_html_e('Media URL (Image/GIF/Video)', 'twork-rewards'); ?></label></th>
                            <td>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="url" name="media_url" id="media_url" class="regular-text" value="<?php echo esc_url($item ? $item->media_url : ''); ?>" placeholder="https://example.com/media.jpg">
                                    <button type="button" class="button" id="upload-media-button"><?php esc_html_e('Select Media', 'twork-rewards'); ?></button>
                                </div>
                                <div id="media-preview" style="margin-top: 10px;"></div>
                                <p class="description">
                                    <?php esc_html_e('URL of the media to display. Supports images (JPG, PNG), GIFs, and videos (MP4, WebM, MOV). You can upload or select from media library, or enter a direct URL.', 'twork-rewards'); ?>
                                </p>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row"><label for="content"><?php esc_html_e('Content / Description', 'twork-rewards'); ?></label></th>
                            <td>
                                <div id="content-wrapper">
                                <?php wp_editor($item ? $item->content : '', 'content', array('textarea_rows' => 5)); ?>
                                </div>
                                <div id="number-content-wrapper" style="display:none;">
                                    <input type="number" name="number_content" id="number_content" class="regular-text" value="<?php echo esc_attr($item && $item->type === 'number' ? $item->content : ''); ?>" placeholder="Enter number (e.g., 55)" min="0" step="1">
                                    <p class="description"><?php esc_html_e('Enter a numeric value to display prominently in the app.', 'twork-rewards'); ?></p>
                                </div>
                            </td>
                        </tr>
                        
                        <!-- Quiz Specific Fields -->
                        <tr class="quiz-field" style="display:none;">
                            <th scope="row"><label for="reward_points"><?php esc_html_e('Reward Points', 'twork-rewards'); ?></label></th>
                            <td>
                                <input type="number" name="reward_points" id="reward_points" value="<?php echo esc_attr($item ? $item->reward_points : 0); ?>">
                            </td>
                        </tr>
                        <tr class="quiz-field" style="display:none;">
                            <th scope="row"><label><?php esc_html_e('Quiz Question', 'twork-rewards'); ?></label></th>
                            <td>
                                <input type="text" name="quiz_question" class="large-text" value="<?php echo esc_attr(isset($quiz_data['question']) ? $quiz_data['question'] : ''); ?>" placeholder="Enter question here">
                            </td>
                        </tr>
                        <tr class="quiz-field" style="display:none;">
                            <th scope="row"><label><?php esc_html_e('Options', 'twork-rewards'); ?></label></th>
                            <td>
                                <div id="quiz-options-container">
                                    <?php
                                    $options = isset($quiz_data['options']) ? $quiz_data['options'] : array('', '');
                                    $correct = isset($quiz_data['correct_index']) ? (int) $quiz_data['correct_index'] : 0;
                                    foreach ($options as $idx => $opt):
                                        ?>
                                        <div class="quiz-option" style="margin-bottom: 10px;">
                                            <input type="radio" name="correct_index" value="<?php echo $idx; ?>" <?php checked($correct, $idx); ?>>
                                            <input type="text" name="quiz_options[]" class="regular-text" value="<?php echo esc_attr($opt); ?>" placeholder="Option <?php echo $idx + 1; ?>">
                                        </div>
                                    <?php endforeach; ?>
                                </div>
                                <button type="button" class="button" id="add-option">Add Option</button>
                            </td>
                        </tr>

                        <tr>
                            <th scope="row"><label for="status"><?php esc_html_e('Status', 'twork-rewards'); ?></label></th>
                            <td>
                                <select name="status" id="status">
                                    <option value="active" <?php selected($item ? $item->status : '', 'active'); ?>>Active</option>
                                    <option value="draft" <?php selected($item ? $item->status : '', 'draft'); ?>>Draft</option>
                                    <option value="archived" <?php selected($item ? $item->status : '', 'archived'); ?>>Archived</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row"><label for="priority"><?php esc_html_e('Priority', 'twork-rewards'); ?></label></th>
                            <td>
                                <input type="number" name="priority" id="priority" value="<?php echo esc_attr($item ? $item->priority : 0); ?>" min="0" max="999" step="1">
                                <p class="description"><?php esc_html_e('Higher number shows first. Items are ordered by priority (DESC) then by creation date (DESC). Default: 0', 'twork-rewards'); ?></p>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">
                                <label for="rotation_duration">
                                    <?php esc_html_e('Rotation Duration', 'twork-rewards'); ?>
                                </label>
                            </th>
                            <td>
                                <?php
                                $global_rotation = get_option('twork_engagement_global_rotation_duration', 5);
                                $item_rotation = $item ? $item->rotation_duration : null;
                                ?>
                                <input 
                                    type="number" 
                                    name="rotation_duration" 
                                    id="rotation_duration" 
                                    value="<?php echo esc_attr($item_rotation !== null ? $item_rotation : ''); ?>" 
                                    min="1" 
                                    max="60" 
                                    step="1"
                                    class="regular-text"
                                    style="width: 100px;"
                                    placeholder="<?php echo esc_attr($global_rotation); ?>"
                                >
                                <span style="margin-left: 10px; color: #666;">
                                    <?php esc_html_e('seconds (1-60)', 'twork-rewards'); ?>
                                </span>
                                <p class="description">
                                    <?php esc_html_e('Leave empty to use global setting (currently: ', 'twork-rewards'); ?>
                                    <strong><?php echo esc_html($global_rotation); ?> seconds</strong>).
                                    <?php esc_html_e(' Set a value (1-60) to override the global setting for this item.', 'twork-rewards'); ?>
                                </p>
                            </td>
                        </tr>
                        </table>
                        
                        <?php submit_button(__('Save Item', 'twork-rewards'), 'primary', 'submit', false, array('style' => 'margin-top: 20px; padding: 10px 20px; font-size: 14px; font-weight: 600;')); ?>
                    </form>
                </div>

                <script>
                jQuery(document).ready(function($) {
                    // Function to detect media type and show appropriate preview
                    function getMediaType(url) {
                        if (!url) return 'unknown';
                        var lowerUrl = url.toLowerCase();
                        if (lowerUrl.endsWith('.gif') || lowerUrl.indexOf('.gif?') !== -1) {
                            return 'gif';
                        } else if (lowerUrl.endsWith('.mp4') || lowerUrl.endsWith('.webm') || 
                                   lowerUrl.endsWith('.mov') || lowerUrl.endsWith('.m4v') ||
                                   lowerUrl.indexOf('.mp4?') !== -1 || lowerUrl.indexOf('.webm?') !== -1 ||
                                   lowerUrl.indexOf('.mov?') !== -1 || lowerUrl.indexOf('video') !== -1) {
                            return 'video';
                        } else {
                            return 'image';
                        }
                    }
                    
                    // Function to escape HTML to prevent XSS
                    function escapeHtml(text) {
                        var map = {
                            '&': '&amp;',
                            '<': '&lt;',
                            '>': '&gt;',
                            '"': '&quot;',
                            "'": '&#039;'
                        };
                        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
                    }
                    
                    // Function to render media preview
                    function renderMediaPreview(url) {
                        if (!url) {
                            $('#media-preview').html('');
                            return;
                        }
                        
                        // Escape URL for safe HTML attribute usage
                        var safeUrl = escapeHtml(url);
                        var mediaType = getMediaType(url);
                        var previewHtml = '';
                        
                        if (mediaType === 'video') {
                            previewHtml = '<div style="max-width: 300px; border: 1px solid #ccc; padding: 3px; background: #000; position: relative;">' +
                                '<video src="' + safeUrl + '" controls style="width: 100%; max-height: 200px; display: block;" preload="metadata"></video>' +
                                '<div style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: #fff; padding: 2px 6px; font-size: 11px; border-radius: 3px;">VIDEO</div>' +
                                '</div>';
                        } else if (mediaType === 'gif') {
                            previewHtml = '<div style="max-width: 200px; border: 1px solid #ccc; padding: 3px; position: relative;">' +
                                '<img src="' + safeUrl + '" alt="GIF preview" style="max-width: 200px; max-height: 200px; display: block;">' +
                                '<div style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: #fff; padding: 2px 6px; font-size: 11px; border-radius: 3px;">GIF</div>' +
                                '</div>';
                        } else {
                            previewHtml = '<img src="' + safeUrl + '" alt="Image preview" style="max-width: 200px; max-height: 200px; border: 1px solid #ccc; padding: 3px; display: block;">';
                        }
                        
                        $('#media-preview').html(previewHtml);
                    }
                    
                    // Render preview for existing media URL on page load
                    var existingUrl = $('#media_url').val();
                    if (existingUrl && existingUrl.trim() !== '') {
                        renderMediaPreview(existingUrl);
                    }
                    
                    // Update preview when URL changes manually
                    $('#media_url').on('input blur', function() {
                        var url = $(this).val();
                        if (url && url.trim() !== '') {
                            renderMediaPreview(url);
                        } else {
                            $('#media-preview').html('');
                        }
                    });
                    
                    // Media Uploader - Enhanced to support all media types
                    var mediaUploader;
                    $('#upload-media-button').click(function(e) {
                        e.preventDefault();
                        if (mediaUploader) {
                            mediaUploader.open();
                            return;
                        }
                        mediaUploader = wp.media.frames.file_frame = wp.media({
                            title: '<?php esc_html_e('Choose Media', 'twork-rewards'); ?>',
                            button: {
                                text: '<?php esc_html_e('Choose Media', 'twork-rewards'); ?>'
                            },
                            library: {
                                type: ['image', 'video'] // Allow both images and videos
                            },
                            multiple: false
                        });
                        mediaUploader.on('select', function() {
                            var attachment = mediaUploader.state().get('selection').first().toJSON();
                            $('#media_url').val(attachment.url);
                            renderMediaPreview(attachment.url);
                        });
                        mediaUploader.open();
                    });

                    function toggleFields() {
                        var type = $('#type').val();
                        if (type === 'quiz' || type === 'poll') {
                            $('.quiz-field').show();
                        } else {
                            $('.quiz-field').hide();
                        }
                        
                        // Handle number type - show number input, hide rich text editor
                        if (type === 'number') {
                            $('#content-wrapper').hide();
                            $('#number-content-wrapper').show();
                            // Copy value from rich editor to number input if switching to number type
                            var editorContent = tinyMCE.get('content') ? tinyMCE.get('content').getContent() : $('#content').val();
                            var numericValue = editorContent.replace(/[^0-9]/g, '');
                            if (numericValue) {
                                $('#number_content').val(numericValue);
                            }
                        } else {
                            $('#content-wrapper').show();
                            $('#number-content-wrapper').hide();
                            // Copy value from number input to rich editor if switching from number type
                            if (type !== 'number' && $('#number_content').val()) {
                                if (tinyMCE.get('content')) {
                                    tinyMCE.get('content').setContent($('#number_content').val());
                                } else {
                                    $('#content').val($('#number_content').val());
                                }
                            }
                        }
                    }
                    $('#type').change(toggleFields);
                    toggleFields();

                    $('#add-option').click(function() {
                        var count = $('.quiz-option').length;
                        var html = '<div class="quiz-option" style="margin-bottom: 10px;">' +
                                   '<input type="radio" name="correct_index" value="' + count + '"> ' +
                                   '<input type="text" name="quiz_options[]" class="regular-text" placeholder="Option ' + (count+1) + '">' +
                                   '</div>';
                        $('#quiz-options-container').append(html);
                    });
                });
                </script>
                <?php
            } else {
                // List View
                $items = $wpdb->get_results("SELECT * FROM $table_name ORDER BY priority DESC, created_at DESC");
                $interactions_table = $wpdb->prefix . 'twork_user_interactions';

                // Get interaction counts for each item
                $interaction_counts = array();
                if ($items) {
                    $item_ids = array_map(function ($item) {
                        return $item->id;
                    }, $items);
                    $placeholders = implode(',', array_fill(0, count($item_ids), '%d'));
                    $interactions = $wpdb->get_results($wpdb->prepare(
                        "SELECT item_id, COUNT(*) as total, 
                         SUM(CASE WHEN is_correct = 1 THEN 1 ELSE 0 END) as correct_count,
                         SUM(points_awarded) as total_points
                         FROM $interactions_table 
                         WHERE item_id IN ($placeholders)
                         GROUP BY item_id",
                        ...$item_ids
                    ));

                    foreach ($interactions as $interaction) {
                        $interaction_counts[$interaction->item_id] = array(
                            'total' => (int) $interaction->total,
                            'correct' => (int) $interaction->correct_count,
                            'points' => (int) $interaction->total_points
                        );
                    }
                }
                ?>
                
                <!-- Tabs for Items and Results -->
                <div class="twork-nav-tabs nav-tab-wrapper">
                    <a href="#items-tab" class="nav-tab nav-tab-active" onclick="showTab('items'); return false;">Engagement Items</a>
                    <a href="#results-tab" class="nav-tab" onclick="showTab('results'); return false;">Quiz Results</a>
                </div>
                
                <!-- Items Tab -->
                <div id="items-tab-content" class="tab-content">
                    <div class="twork-engagement-table">
                        <table class="wp-list-table widefat fixed striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Priority</th>
                                <th>Interactions</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php
                            if ($items):
                                foreach ($items as $item):
                                    $stats = isset($interaction_counts[$item->id]) ? $interaction_counts[$item->id] : array('total' => 0, 'correct' => 0, 'points' => 0);
                                    ?>
                                <tr>
                                    <td><strong>#<?php echo $item->id; ?></strong></td>
                                    <td><strong><?php echo esc_html($item->title); ?></strong></td>
                                    <td><span class="twork-type-badge <?php echo esc_attr($item->type); ?>"><?php echo ucfirst($item->type); ?></span></td>
                                    <td><span class="twork-status-badge <?php echo esc_attr($item->status); ?>"><?php echo ucfirst($item->status); ?></span></td>
                                    <td><strong><?php echo $item->priority; ?></strong></td>
                                    <td>
                                        <?php if ($stats['total'] > 0): ?>
                                            <div class="twork-interaction-stats">
                                                <strong><?php echo $stats['total']; ?></strong> total
                                                <?php if ($item->type === 'quiz'): ?>
                                                    (<span class="correct"><?php echo $stats['correct']; ?></span> correct, 
                                                    <span class="incorrect"><?php echo $stats['total'] - $stats['correct']; ?></span> incorrect)
                                                <?php endif; ?>
                                            </div>
                                        <?php else: ?>
                                            <span style="color: #999; font-style: italic;">No interactions</span>
                                        <?php endif; ?>
                                    </td>
                                    <td><?php
                                    // Professional: Display created date in Myanmar timezone
                                    $formatted_date = $this->format_myanmar_time($item->created_at, 'M d, Y');
                                    echo esc_html($formatted_date ?: $item->created_at);
                                    ?></td>
                                    <td>
                                        <div class="twork-action-buttons">
                                            <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-engagement', 'action' => 'edit', 'id' => $item->id), admin_url('admin.php'))); ?>" class="button button-small button-primary">Edit</a>
                                            <?php if ($item->type === 'quiz' || $item->type === 'poll'): ?>
                                                <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-engagement', 'action' => 'view_results', 'id' => $item->id), admin_url('admin.php'))); ?>" class="button button-small button-primary">View Results</a>
                                            <?php endif; ?>
                                            <form method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>" style="display:inline-block;" onsubmit="return confirm('Are you sure you want to delete this item?');">
                                                <input type="hidden" name="action" value="twork_rewards_delete_engagement_item">
                                                <input type="hidden" name="item_id" value="<?php echo $item->id; ?>">
                                                <?php wp_nonce_field('twork_rewards_delete_engagement_item'); ?>
                                                <button type="submit" class="button button-small button-link-delete">Delete</button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            <?php endforeach;
                            else: ?>
                                <tr><td colspan="8" style="text-align: center; padding: 40px; color: #999; font-style: italic;">No engagement items found. <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-engagement', 'action' => 'add'), admin_url('admin.php'))); ?>">Create your first item</a>.</td></tr>
                            <?php endif; ?>
                        </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Results Tab -->
                <div id="results-tab-content" class="tab-content" style="display:none;">
                    <?php
                    $all_interactions = $wpdb->get_results(
                        "SELECT i.*, 
                         u.display_name as user_name, u.user_email,
                         e.title as item_title, e.type as item_type
                         FROM $interactions_table i
                         LEFT JOIN {$wpdb->users} u ON i.user_id = u.ID
                         LEFT JOIN $table_name e ON i.item_id = e.id
                         ORDER BY i.created_at DESC
                         LIMIT 100"
                    );
                    ?>
                    <div class="twork-engagement-table">
                        <table class="wp-list-table widefat fixed striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>User</th>
                                <th>Quiz/Item</th>
                                <th>Type</th>
                                <th>Answer</th>
                                <th>Result</th>
                                <th>Points</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php if ($all_interactions):
                                foreach ($all_interactions as $interaction): ?>
                                <tr>
                                    <td><?php echo $interaction->id; ?></td>
                                    <td>
                                        <strong><?php echo esc_html($interaction->user_name ?: 'User #' . $interaction->user_id); ?></strong><br>
                                        <small style="color: #666;"><?php echo esc_html($interaction->user_email); ?></small>
                                    </td>
                                    <td><strong><?php echo esc_html($interaction->item_title ?: 'Item #' . $interaction->item_id); ?></strong></td>
                                    <td><span class="twork-type-badge <?php echo esc_attr($interaction->item_type ?: 'unknown'); ?>"><?php echo ucfirst($interaction->item_type ?: 'unknown'); ?></span></td>
                                    <td>
                                        <?php
                                        $answer_index = (int) $interaction->interaction_value;
                                        if ($interaction->item_type === 'quiz' || $interaction->item_type === 'poll') {
                                            $item_data = $wpdb->get_var($wpdb->prepare(
                                                "SELECT quiz_data FROM $table_name WHERE id = %d",
                                                $interaction->item_id
                                            ));
                                            if ($item_data) {
                                                $quiz_data = json_decode($item_data, true);
                                                if ($quiz_data && isset($quiz_data['options'][$answer_index])) {
                                                    echo esc_html($quiz_data['options'][$answer_index]);
                                                } else {
                                                    echo 'Option ' . ($answer_index + 1);
                                                }
                                            } else {
                                                echo 'Option ' . ($answer_index + 1);
                                            }
                                        } else {
                                            echo esc_html($interaction->interaction_value);
                                        }
                                        ?>
                                    </td>
                                    <td>
                                        <?php if ($interaction->is_correct): ?>
                                            <span style="color: #4CAF50; font-weight: 600;">âœ“ Correct</span>
                                        <?php else: ?>
                                            <span style="color: #f44336; font-weight: 600;">âœ— Incorrect</span>
                                        <?php endif; ?>
                                    </td>
                                    <td>
                                        <?php if ($interaction->points_awarded > 0): ?>
                                            <strong style="color: #4CAF50; font-size: 14px;">+<?php echo $interaction->points_awarded; ?></strong>
                                        <?php else: ?>
                                            <span style="color: #999;">0</span>
                                        <?php endif; ?>
                                    </td>
                                    <td><?php
                                    // Professional: Display interaction date in Myanmar timezone
                                    $formatted_datetime = $this->format_myanmar_time($interaction->created_at, 'M d, Y H:i');
                                    echo esc_html($formatted_datetime ?: $interaction->created_at);
                                    ?></td>
                                </tr>
                            <?php endforeach;
                            else: ?>
                                <tr><td colspan="8" style="text-align: center; padding: 40px; color: #999; font-style: italic;">No quiz results found.</td></tr>
                            <?php endif; ?>
                        </tbody>
                        </table>
                    </div>
                </div>
                
                <script>
                function showTab(tab) {
                    // Hide all tabs
                    document.querySelectorAll('.tab-content').forEach(function(el) {
                        el.style.display = 'none';
                    });
                    document.querySelectorAll('.nav-tab').forEach(function(el) {
                        el.classList.remove('nav-tab-active');
                    });
                    
                    // Show selected tab
                    document.getElementById(tab + '-tab-content').style.display = 'block';
                    event.target.classList.add('nav-tab-active');
                }
                </script>
                
                <style>
                .tab-content {
                    margin-top: 20px;
                }
                .nav-tab-wrapper {
                    margin: 20px 0 0 0;
                }
                </style>
                <?php
            }
            ?>
        </div>
        <?php
    }

    public function handle_engagement_item_save()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die('Insufficient permissions');
        }
        check_admin_referer('twork_rewards_save_engagement_item');

        // CRITICAL: Ensure migration runs before save to prevent "column doesn't exist" errors
        $this->run_engagement_migrations();

        global $wpdb;
        $table_name = $wpdb->prefix . 'twork_engagement_items';

        $id = isset($_POST['item_id']) ? absint($_POST['item_id']) : 0;
        $type = isset($_POST['type']) ? sanitize_text_field($_POST['type']) : 'banner';
        $title = isset($_POST['title']) ? sanitize_text_field($_POST['title']) : '';
        $media_url = isset($_POST['media_url']) ? esc_url_raw($_POST['media_url']) : '';

        // Handle content based on type - for number type, use number_content field
        if ($type === 'number' && isset($_POST['number_content'])) {
            // Validate and sanitize numeric input
            $number_content = sanitize_text_field($_POST['number_content']);
            // Ensure it's a valid number
            $content = is_numeric($number_content) ? $number_content : '';
        } else {
            $content = isset($_POST['content']) ? wp_kses_post($_POST['content']) : '';
        }

        $status = isset($_POST['status']) ? sanitize_text_field($_POST['status']) : 'active';
        $priority = isset($_POST['priority']) ? intval($_POST['priority']) : 0;
        $reward_points = isset($_POST['reward_points']) ? intval($_POST['reward_points']) : 0;

        // Get rotation_duration (can be empty to use global setting)
        $rotation_duration = null;
        if (isset($_POST['rotation_duration']) && $_POST['rotation_duration'] !== '') {
            $rotation_duration = intval($_POST['rotation_duration']);
            // Validate: must be between 1-60 seconds
            if ($rotation_duration < 1 || $rotation_duration > 60) {
                $rotation_duration = null;  // Invalid value, use global setting
            }
        }

        $quiz_data = null;
        if ($type === 'quiz' || $type === 'poll') {
            $options = isset($_POST['quiz_options']) ? array_map('sanitize_text_field', $_POST['quiz_options']) : array();
            // Filter out empty options
            $options = array_filter($options);
            $quiz_question = isset($_POST['quiz_question']) ? sanitize_text_field($_POST['quiz_question']) : '';
            $correct_index = isset($_POST['correct_index']) ? intval($_POST['correct_index']) : 0;
            $quiz_data = json_encode(array(
                'question' => $quiz_question,
                'options' => array_values($options),
                'correct_index' => $correct_index
            ));
        }

        $data = array(
            'type' => $type,
            'title' => $title,
            'media_url' => $media_url,
            'content' => $content,
            'status' => $status,
            'priority' => $priority,
            'reward_points' => $reward_points,
            'quiz_data' => $quiz_data,
            'rotation_duration' => $rotation_duration,  // NULL = use global setting
        );

        $is_new_item = false;
        if ($id > 0) {
            // Update existing item
            $result = $wpdb->update($table_name, $data, array('id' => $id));
            if ($result === false) {
                wp_die(__('Error updating engagement item. Database error: ', 'twork-rewards') . $wpdb->last_error);
            }
        } else {
            // Insert new item
            $result = $wpdb->insert($table_name, $data);
            if ($result === false) {
                wp_die(__('Error creating engagement item. Database error: ', 'twork-rewards') . $wpdb->last_error);
            }
            $is_new_item = true;
            $id = $wpdb->insert_id;
        }

        // PROFESSIONAL ENGAGEMENT NOTIFICATIONS: Notify all users when engagement item is created or updated
        if ($status === 'active') {
            // Prepare notification data with number value if it's a number type
            $notification_data = array();

            // PROFESSIONAL FIX: Include number value for number type notifications
            if ($type === 'number' && !empty($content)) {
                $notification_data['number_value'] = $content;
            }

            if ($is_new_item) {
                // Notify all active users about the new engagement item
                $this->notify_users_about_new_engagement_item($id, $type, $title, $reward_points, $notification_data);
            } else {
                // PROFESSIONAL FIX: Notify users when existing item is updated
                $this->notify_users_about_updated_engagement_item($id, $type, $title, $reward_points, $notification_data);
            }
        }

        wp_safe_redirect(add_query_arg(array('page' => 'twork-rewards-engagement', 'updated' => 1), admin_url('admin.php')));
        exit;
    }

    public function handle_engagement_item_delete()
    {
        if (!current_user_can('manage_options') && !current_user_can('manage_woocommerce')) {
            wp_die('Insufficient permissions');
        }
        check_admin_referer('twork_rewards_delete_engagement_item');

        $id = absint($_POST['item_id']);
        if ($id > 0) {
            global $wpdb;
            $table_name = $wpdb->prefix . 'twork_engagement_items';
            $wpdb->delete($table_name, array('id' => $id));
        }

        wp_safe_redirect(add_query_arg(array('page' => 'twork-rewards-engagement', 'deleted' => 1), admin_url('admin.php')));
        exit;
    }

    /**
     * Handle engagement settings save (global rotation duration)
     */
    public function handle_engagement_settings_save()
    {
        if (!current_user_can('manage_woocommerce') && !current_user_can('manage_options')) {
            wp_die(__('You do not have permission to access this page.', 'twork-rewards'));
        }
        check_admin_referer('twork_rewards_save_engagement_settings');

        $rotation_duration = isset($_POST['global_rotation_duration']) ? intval($_POST['global_rotation_duration']) : 5;

        // Validate: must be between 1-60 seconds
        if ($rotation_duration < 1 || $rotation_duration > 60) {
            wp_safe_redirect(add_query_arg(array('page' => 'twork-rewards-engagement', 'error' => 'invalid_duration'), admin_url('admin.php')));
            exit;
        }

        update_option('twork_engagement_global_rotation_duration', $rotation_duration);

        wp_safe_redirect(add_query_arg(array('page' => 'twork-rewards-engagement', 'settings_updated' => 1), admin_url('admin.php')));
        exit;
    }

    /**
     * Render Page Content Management Page
     * Professional admin interface for managing dynamic page content
     */
    public function render_page_content_page()
    {
        // PROFESSIONAL FIX: Wrap in try-catch to prevent critical errors
        try {
            if (!current_user_can('manage_woocommerce') && !current_user_can('manage_options')) {
                wp_die(__('You do not have permission to access this page.', 'twork-rewards'));
            }

            global $wpdb;
            $table_name = $this->page_content_table_name();

            // PROFESSIONAL FIX: Ensure table exists before proceeding
            $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
            if ($table_exists !== $table_name) {
                // Table doesn't exist - create it
                $this->create_page_content_table();
                // Verify table was created
                $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
                if ($table_exists !== $table_name) {
                    throw new Exception(__('Failed to create page content table. Please check database permissions.', 'twork-rewards'));
                }
            }

            $action = isset($_GET['action']) ? sanitize_text_field($_GET['action']) : 'list';
            $id = isset($_GET['id']) ? absint($_GET['id']) : 0;

            // Handle messages
            if (isset($_GET['updated']) && $_GET['updated'] == '1') {
                echo '<div class="notice notice-success is-dismissible"><p>' . esc_html__('Page content saved successfully.', 'twork-rewards') . '</p></div>';
            }
            if (isset($_GET['deleted']) && $_GET['deleted'] == '1') {
                echo '<div class="notice notice-success is-dismissible"><p>' . esc_html__('Page content deleted successfully.', 'twork-rewards') . '</p></div>';
            }

            if ($action === 'edit' && $id > 0) {
                $this->render_page_content_edit_form($id);
            } else if ($action === 'edit') {
                $this->render_page_content_edit_form(0);
            } else {
                $this->render_page_content_list();
            }
        } catch (Exception $e) {
            // PROFESSIONAL FIX: Display user-friendly error instead of critical error
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: Page Content page error: ' . $e->getMessage());
                error_log('T-Work Rewards: Page Content page stack trace: ' . $e->getTraceAsString());
            }

            echo '<div class="wrap">';
            echo '<h1>' . esc_html__('Page Content Management', 'twork-rewards') . '</h1>';
            echo '<div class="notice notice-error"><p>';
            echo esc_html__('An error occurred while loading the Page Content Management page. Please try again or contact support if the problem persists.', 'twork-rewards');
            if (defined('WP_DEBUG') && WP_DEBUG) {
                echo '<br><strong>Debug Info:</strong> ' . esc_html($e->getMessage());
            }
            echo '</p></div>';
            echo '<p><a href="' . esc_url(admin_url('admin.php?page=twork-rewards-page-content')) . '" class="button">' . esc_html__('Try Again', 'twork-rewards') . '</a></p>';
            echo '</div>';
        }
    }

    /**
     * Render page content list
     */
    private function render_page_content_list()
    {
        global $wpdb;
        $table_name = $this->page_content_table_name();

        // PROFESSIONAL FIX: Ensure table exists before querying
        $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
        if ($table_exists !== $table_name) {
            // Table doesn't exist - create it
            $this->create_page_content_table();
            // Verify table was created
            $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
            if ($table_exists !== $table_name) {
                echo '<div class="notice notice-error"><p>' . esc_html__('Failed to create page content table. Please check database permissions.', 'twork-rewards') . '</p></div>';
                return;
            }
        }

        // PROFESSIONAL FIX: Query with error handling
        $pages = $wpdb->get_results("SELECT * FROM `$table_name` ORDER BY page_slug ASC", ARRAY_A);

        // Check for database errors
        if ($wpdb->last_error) {
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: Page content query error: ' . $wpdb->last_error);
                error_log('T-Work Rewards: Page content query: ' . $wpdb->last_query);
            }
            // Set empty array on error
            $pages = array();
        }

        // Ensure $pages is an array
        if (!is_array($pages)) {
            $pages = array();
        }

        ?>
        <div class="wrap">
            <h1 class="wp-heading-inline"><?php esc_html_e('Page Content Management', 'twork-rewards'); ?></h1>
            <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-page-content', 'action' => 'edit'), admin_url('admin.php'))); ?>" class="page-title-action">
                <?php esc_html_e('Add New Page', 'twork-rewards'); ?>
            </a>
            <hr class="wp-header-end">

            <p><?php esc_html_e('Manage dynamic page content for About Us, FAQ, Terms, Privacy Policy, and other pages. Content is stored in the plugin database and can be updated without creating WordPress pages.', 'twork-rewards'); ?></p>

            <table class="wp-list-table widefat fixed striped">
                <thead>
                    <tr>
                        <th scope="col" class="manage-column column-title"><?php esc_html_e('Page Slug', 'twork-rewards'); ?></th>
                        <th scope="col" class="manage-column"><?php esc_html_e('Title', 'twork-rewards'); ?></th>
                        <th scope="col" class="manage-column"><?php esc_html_e('Status', 'twork-rewards'); ?></th>
                        <th scope="col" class="manage-column"><?php esc_html_e('Last Updated', 'twork-rewards'); ?></th>
                        <th scope="col" class="manage-column"><?php esc_html_e('Actions', 'twork-rewards'); ?></th>
                    </tr>
                </thead>
                <tbody>
                    <?php if (empty($pages)): ?>
                        <tr>
                            <td colspan="5"><?php esc_html_e('No pages found. Click "Add New Page" to create one.', 'twork-rewards'); ?></td>
                        </tr>
                    <?php else: ?>
                        <?php foreach ($pages as $page): ?>
                            <tr>
                                <td><strong><?php echo esc_html($page['page_slug']); ?></strong></td>
                                <td><?php echo esc_html($page['title']); ?></td>
                                <td>
                                    <span class="status-<?php echo esc_attr($page['status']); ?>">
                                        <?php echo esc_html(ucfirst($page['status'])); ?>
                                    </span>
                                </td>
                                <td><?php
                // Professional: Display last updated/created date in Myanmar timezone
                $timestamp_str = $page['updated_at'] ? $page['updated_at'] : $page['created_at'];
                if (!empty($timestamp_str)) {
                    $formatted_date = $this->format_myanmar_time($timestamp_str);
                    echo esc_html($formatted_date ?: $timestamp_str);
                } else {
                    echo '<span style="color: #999;">&mdash;</span>';
                }
                ?></td>
                                <td>
                                    <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-page-content', 'action' => 'edit', 'id' => $page['id']), admin_url('admin.php'))); ?>" class="button button-small">
                                        <?php esc_html_e('Edit', 'twork-rewards'); ?>
                                    </a>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    <?php endif; ?>
                </tbody>
            </table>
        </div>
        <?php
    }

    /**
     * Render page content edit form
     */
    private function render_page_content_edit_form($id = 0)
    {
        global $wpdb;
        $table_name = $this->page_content_table_name();

        // PROFESSIONAL FIX: Ensure table exists before querying
        $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
        if ($table_exists !== $table_name) {
            // Table doesn't exist - create it
            $this->create_page_content_table();
            // Verify table was created
            $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
            if ($table_exists !== $table_name) {
                echo '<div class="notice notice-error"><p>' . esc_html__('Failed to create page content table. Please check database permissions.', 'twork-rewards') . '</p></div>';
                return;
            }
        }

        $page = null;
        if ($id > 0) {
            $page = $wpdb->get_row($wpdb->prepare("SELECT * FROM `$table_name` WHERE id = %d", $id), ARRAY_A);
            if ($wpdb->last_error && defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: Page content get_row error: ' . $wpdb->last_error);
            }
        }

        $page_slug = $page ? $page['page_slug'] : '';
        $title = $page ? $page['title'] : '';
        $content = $page ? $page['content'] : '';
        $status = $page ? $page['status'] : 'active';

        // Enqueue editor
        wp_enqueue_editor();
        wp_enqueue_media();
        ?>
        <div class="wrap">
            <h1><?php echo $id > 0 ? esc_html__('Edit Page Content', 'twork-rewards') : esc_html__('Add New Page Content', 'twork-rewards'); ?></h1>
            
            <form method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>">
                <?php wp_nonce_field('twork_rewards_save_page_content'); ?>
                <input type="hidden" name="action" value="twork_rewards_save_page_content">
                <input type="hidden" name="page_id" value="<?php echo esc_attr($id); ?>">
                
                <table class="form-table">
                    <tr>
                        <th scope="row"><label for="page_slug"><?php esc_html_e('Page Slug', 'twork-rewards'); ?></label></th>
                        <td>
                            <?php if ($id > 0): ?>
                                <input type="text" id="page_slug" name="page_slug" value="<?php echo esc_attr($page_slug); ?>" class="regular-text" readonly>
                                <p class="description"><?php esc_html_e('Page slug cannot be changed after creation.', 'twork-rewards'); ?></p>
                            <?php else: ?>
                                <input type="text" id="page_slug" name="page_slug" value="<?php echo esc_attr($page_slug); ?>" class="regular-text" required>
                                <p class="description"><?php esc_html_e('Unique identifier for the page (e.g., about-us, terms-of-use, privacy-policy). Use lowercase letters and hyphens only.', 'twork-rewards'); ?></p>
                            <?php endif; ?>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row"><label for="title"><?php esc_html_e('Title', 'twork-rewards'); ?></label></th>
                        <td>
                            <input type="text" id="title" name="title" value="<?php echo esc_attr($title); ?>" class="regular-text" required>
                            <p class="description"><?php esc_html_e('Display title for the page.', 'twork-rewards'); ?></p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row"><label for="content"><?php esc_html_e('Content', 'twork-rewards'); ?></label></th>
                        <td>
                            <?php
                            wp_editor($content, 'content', array(
                                'textarea_rows' => 15,
                                'media_buttons' => true,
                                'teeny' => false,
                            ));
                            ?>
                            <p class="description"><?php esc_html_e('Page content. HTML is supported. Use the editor to format text, add images, links, etc.', 'twork-rewards'); ?></p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row"><label for="status"><?php esc_html_e('Status', 'twork-rewards'); ?></label></th>
                        <td>
                            <select id="status" name="status">
                                <option value="active" <?php selected($status, 'active'); ?>><?php esc_html_e('Active', 'twork-rewards'); ?></option>
                                <option value="draft" <?php selected($status, 'draft'); ?>><?php esc_html_e('Draft', 'twork-rewards'); ?></option>
                            </select>
                            <p class="description"><?php esc_html_e('Only active pages are displayed in the mobile app.', 'twork-rewards'); ?></p>
                        </td>
                    </tr>
                </table>
                
                <p class="submit">
                    <input type="submit" name="submit" id="submit" class="button button-primary" value="<?php esc_attr_e('Save Page Content', 'twork-rewards'); ?>">
                    <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-page-content'), admin_url('admin.php'))); ?>" class="button">
                        <?php esc_html_e('Cancel', 'twork-rewards'); ?>
                    </a>
                </p>
            </form>
        </div>
        <?php
    }

    /**
     * Handle page content save
     */
    public function handle_page_content_save()
    {
        if (!current_user_can('manage_woocommerce') && !current_user_can('manage_options')) {
            wp_die(__('You do not have permission to perform this action.', 'twork-rewards'));
        }

        check_admin_referer('twork_rewards_save_page_content');

        global $wpdb;
        $table_name = $this->page_content_table_name();

        // PROFESSIONAL FIX: Ensure table exists before saving
        $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
        if ($table_exists !== $table_name) {
            // Table doesn't exist - create it
            $this->create_page_content_table();
            // Verify table was created
            $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
            if ($table_exists !== $table_name) {
                wp_die(__('Failed to create page content table. Please check database permissions.', 'twork-rewards'));
            }
        }

        $id = isset($_POST['page_id']) ? absint($_POST['page_id']) : 0;
        $page_slug = sanitize_text_field($_POST['page_slug']);
        $title = sanitize_text_field($_POST['title']);
        $content = wp_kses_post($_POST['content']);  // Allow HTML but sanitize
        $status = sanitize_text_field($_POST['status']);

        // Validate page_slug format
        if (!preg_match('/^[a-z0-9-]+$/', $page_slug)) {
            wp_die(__('Invalid page slug. Use only lowercase letters, numbers, and hyphens.', 'twork-rewards'));
        }

        $data = array(
            'page_slug' => $page_slug,
            'title' => $title,
            'content' => $content,
            'status' => $status,
        );

        if ($id > 0) {
            // Update existing page
            $result = $wpdb->update($table_name, $data, array('id' => $id));
            if ($result === false) {
                if (defined('WP_DEBUG') && WP_DEBUG) {
                    error_log('T-Work Rewards: Page content update error: ' . $wpdb->last_error);
                    error_log('T-Work Rewards: Page content update query: ' . $wpdb->last_query);
                }
                wp_die(__('Error updating page content. Database error: ', 'twork-rewards') . $wpdb->last_error);
            }
        } else {
            // Check if slug already exists
            $exists = $wpdb->get_var($wpdb->prepare(
                "SELECT COUNT(*) FROM `$table_name` WHERE page_slug = %s",
                $page_slug
            ));

            if ($exists > 0) {
                wp_die(__('Page slug already exists. Please choose a different slug.', 'twork-rewards'));
            }

            // Insert new page
            $result = $wpdb->insert($table_name, $data);
            if ($result === false) {
                if (defined('WP_DEBUG') && WP_DEBUG) {
                    error_log('T-Work Rewards: Page content insert error: ' . $wpdb->last_error);
                    error_log('T-Work Rewards: Page content insert query: ' . $wpdb->last_query);
                }
                wp_die(__('Error creating page content. Database error: ', 'twork-rewards') . $wpdb->last_error);
            }
        }

        wp_safe_redirect(add_query_arg(array('page' => 'twork-rewards-page-content', 'updated' => 1), admin_url('admin.php')));
        exit;
    }

    /**
     * Render FAQ Management Page
     * Professional admin interface for managing FAQ items
     */
    public function render_faq_page()
    {
        // PROFESSIONAL FIX: Wrap in try-catch to prevent critical errors
        try {
            if (!current_user_can('manage_woocommerce') && !current_user_can('manage_options')) {
                wp_die(__('You do not have permission to access this page.', 'twork-rewards'));
            }

            global $wpdb;
            $table_name = $this->faq_table_name();

            // PROFESSIONAL FIX: Ensure table exists before proceeding
            $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
            if ($table_exists !== $table_name) {
                // Table doesn't exist - create it
                $this->create_faq_table();
                // Verify table was created
                $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
                if ($table_exists !== $table_name) {
                    throw new Exception(__('Failed to create FAQ table. Please check database permissions.', 'twork-rewards'));
                }
            }

            $action = isset($_GET['action']) ? sanitize_text_field($_GET['action']) : 'list';
            $id = isset($_GET['id']) ? absint($_GET['id']) : 0;

            // Handle messages
            if (isset($_GET['updated']) && $_GET['updated'] == '1') {
                echo '<div class="notice notice-success is-dismissible"><p>' . esc_html__('FAQ item saved successfully.', 'twork-rewards') . '</p></div>';
            }
            if (isset($_GET['deleted']) && $_GET['deleted'] == '1') {
                echo '<div class="notice notice-success is-dismissible"><p>' . esc_html__('FAQ item deleted successfully.', 'twork-rewards') . '</p></div>';
            }

            if ($action === 'edit' && $id > 0) {
                $this->render_faq_edit_form($id);
            } else if ($action === 'edit') {
                $this->render_faq_edit_form(0);
            } else {
                $this->render_faq_list();
            }
        } catch (Exception $e) {
            // PROFESSIONAL FIX: Display user-friendly error instead of critical error
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: FAQ page error: ' . $e->getMessage());
                error_log('T-Work Rewards: FAQ page stack trace: ' . $e->getTraceAsString());
            }

            echo '<div class="wrap">';
            echo '<h1>' . esc_html__('FAQ Management', 'twork-rewards') . '</h1>';
            echo '<div class="notice notice-error"><p>';
            echo esc_html__('An error occurred while loading the FAQ Management page. Please try again or contact support if the problem persists.', 'twork-rewards');
            if (defined('WP_DEBUG') && WP_DEBUG) {
                echo '<br><strong>Debug Info:</strong> ' . esc_html($e->getMessage());
            }
            echo '</p></div>';
            echo '<p><a href="' . esc_url(admin_url('admin.php?page=twork-rewards-faq')) . '" class="button">' . esc_html__('Try Again', 'twork-rewards') . '</a></p>';
            echo '</div>';
        }
    }

    /**
     * Render FAQ list
     */
    private function render_faq_list()
    {
        global $wpdb;
        $table_name = $this->faq_table_name();

        // PROFESSIONAL FIX: Ensure table exists before querying
        // This handles cases where plugin was activated before FAQ table was added
        $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
        if ($table_exists !== $table_name) {
            // Table doesn't exist - create it
            $this->create_faq_table();
            // Verify table was created
            $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
            if ($table_exists !== $table_name) {
                // Table creation failed
                echo '<div class="notice notice-error"><p>' . esc_html__('Failed to create FAQ table. Please check database permissions.', 'twork-rewards') . '</p></div>';
                return;
            }
        }

        // PROFESSIONAL FIX: Query with error handling
        // Note: Table names cannot be used in prepared statements, so we use backticks for safety
        $faq_items = $wpdb->get_results("SELECT * FROM `$table_name` ORDER BY display_order ASC, id ASC", ARRAY_A);

        // Check for database errors
        if ($wpdb->last_error) {
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: FAQ query error: ' . $wpdb->last_error);
                error_log('T-Work Rewards: FAQ query: ' . $wpdb->last_query);
            }
            // Set empty array on error
            $faq_items = array();
        }

        // Ensure $faq_items is an array
        if (!is_array($faq_items)) {
            $faq_items = array();
        }

        ?>
        <div class="wrap">
            <h1 class="wp-heading-inline"><?php esc_html_e('FAQ Management', 'twork-rewards'); ?></h1>
            <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-faq', 'action' => 'edit'), admin_url('admin.php'))); ?>" class="page-title-action">
                <?php esc_html_e('Add New FAQ', 'twork-rewards'); ?>
            </a>
            <hr class="wp-header-end">

            <p><?php esc_html_e('Manage FAQ items that are displayed in the mobile app. FAQ items can also be managed through WordPress Posts with category "faq" or custom post type "faq".', 'twork-rewards'); ?></p>

            <table class="wp-list-table widefat fixed striped">
                <thead>
                    <tr>
                        <th scope="col" class="manage-column column-order" style="width: 80px;"><?php esc_html_e('Order', 'twork-rewards'); ?></th>
                        <th scope="col" class="manage-column column-question"><?php esc_html_e('Question', 'twork-rewards'); ?></th>
                        <th scope="col" class="manage-column column-status" style="width: 100px;"><?php esc_html_e('Status', 'twork-rewards'); ?></th>
                        <th scope="col" class="manage-column column-updated" style="width: 150px;"><?php esc_html_e('Last Updated', 'twork-rewards'); ?></th>
                        <th scope="col" class="manage-column column-actions" style="width: 100px;"><?php esc_html_e('Actions', 'twork-rewards'); ?></th>
                    </tr>
                </thead>
                <tbody>
                    <?php if (empty($faq_items)): ?>
                        <tr>
                            <td colspan="5"><?php esc_html_e('No FAQ items found. Click "Add New FAQ" to create one.', 'twork-rewards'); ?></td>
                        </tr>
                    <?php else: ?>
                        <?php foreach ($faq_items as $item): ?>
                            <tr>
                                <td><?php echo esc_html($item['display_order']); ?></td>
                                <td><strong><?php echo esc_html(wp_trim_words($item['question'], 50)); ?></strong></td>
                                <td>
                                    <span class="status-<?php echo esc_attr($item['status']); ?>">
                                        <?php echo esc_html(ucfirst($item['status'])); ?>
                                    </span>
                                </td>
                                <td><?php
                // Professional: Display FAQ date in Myanmar timezone
                $faq_date = $item['updated_at'] ? $item['updated_at'] : $item['created_at'];
                $formatted_date = $this->format_myanmar_time($faq_date);
                echo esc_html($formatted_date ?: $faq_date);
                ?></td>
                                <td>
                                    <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-faq', 'action' => 'edit', 'id' => $item['id']), admin_url('admin.php'))); ?>" class="button button-small">
                                        <?php esc_html_e('Edit', 'twork-rewards'); ?>
                                    </a>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    <?php endif; ?>
                </tbody>
            </table>
        </div>
        <?php
    }

    /**
     * Render FAQ edit form
     */
    private function render_faq_edit_form($id = 0)
    {
        global $wpdb;
        $table_name = $this->faq_table_name();

        // PROFESSIONAL FIX: Ensure table exists before querying
        $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
        if ($table_exists !== $table_name) {
            // Table doesn't exist - create it
            $this->create_faq_table();
            // Verify table was created
            $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
            if ($table_exists !== $table_name) {
                echo '<div class="notice notice-error"><p>' . esc_html__('Failed to create FAQ table. Please check database permissions.', 'twork-rewards') . '</p></div>';
                return;
            }
        }

        $item = null;
        if ($id > 0) {
            $item = $wpdb->get_row($wpdb->prepare("SELECT * FROM `$table_name` WHERE id = %d", $id), ARRAY_A);
            if ($wpdb->last_error && defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: FAQ get_row error: ' . $wpdb->last_error);
            }
        }

        $question = $item ? $item['question'] : '';
        $answer = $item ? $item['answer'] : '';
        $display_order = $item ? $item['display_order'] : 0;
        $status = $item ? $item['status'] : 'active';

        // Enqueue editor
        wp_enqueue_editor();
        wp_enqueue_media();
        ?>
        <div class="wrap">
            <h1><?php echo $id > 0 ? esc_html__('Edit FAQ Item', 'twork-rewards') : esc_html__('Add New FAQ Item', 'twork-rewards'); ?></h1>
            
            <form method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>">
                <?php wp_nonce_field('twork_rewards_save_faq'); ?>
                <input type="hidden" name="action" value="twork_rewards_save_faq">
                <input type="hidden" name="faq_id" value="<?php echo esc_attr($id); ?>">
                
                <table class="form-table">
                    <tr>
                        <th scope="row"><label for="question"><?php esc_html_e('Question', 'twork-rewards'); ?></label></th>
                        <td>
                            <input type="text" id="question" name="question" value="<?php echo esc_attr($question); ?>" class="regular-text" required>
                            <p class="description"><?php esc_html_e('The FAQ question that will be displayed.', 'twork-rewards'); ?></p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row"><label for="answer"><?php esc_html_e('Answer', 'twork-rewards'); ?></label></th>
                        <td>
                            <?php
                            wp_editor($answer, 'answer', array(
                                'textarea_rows' => 10,
                                'media_buttons' => true,
                                'teeny' => false,
                            ));
                            ?>
                            <p class="description"><?php esc_html_e('The FAQ answer. HTML is supported. Use the editor to format text, add images, links, etc.', 'twork-rewards'); ?></p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row"><label for="display_order"><?php esc_html_e('Display Order', 'twork-rewards'); ?></label></th>
                        <td>
                            <input type="number" id="display_order" name="display_order" value="<?php echo esc_attr($display_order); ?>" class="small-text" min="0">
                            <p class="description"><?php esc_html_e('Lower numbers appear first. Items with the same order are sorted by ID.', 'twork-rewards'); ?></p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row"><label for="status"><?php esc_html_e('Status', 'twork-rewards'); ?></label></th>
                        <td>
                            <select id="status" name="status">
                                <option value="active" <?php selected($status, 'active'); ?>><?php esc_html_e('Active', 'twork-rewards'); ?></option>
                                <option value="draft" <?php selected($status, 'draft'); ?>><?php esc_html_e('Draft', 'twork-rewards'); ?></option>
                            </select>
                            <p class="description"><?php esc_html_e('Only active FAQ items are displayed in the mobile app.', 'twork-rewards'); ?></p>
                        </td>
                    </tr>
                </table>
                
                <p class="submit">
                    <input type="submit" name="submit" id="submit" class="button button-primary" value="<?php esc_attr_e('Save FAQ Item', 'twork-rewards'); ?>">
                    <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-faq'), admin_url('admin.php'))); ?>" class="button">
                        <?php esc_html_e('Cancel', 'twork-rewards'); ?>
                    </a>
                </p>
            </form>
        </div>
        <?php
    }

    /**
     * Handle FAQ save
     */
    public function handle_faq_save()
    {
        if (!current_user_can('manage_woocommerce') && !current_user_can('manage_options')) {
            wp_die(__('You do not have permission to perform this action.', 'twork-rewards'));
        }

        check_admin_referer('twork_rewards_save_faq');

        global $wpdb;
        $table_name = $this->faq_table_name();

        // PROFESSIONAL FIX: Ensure table exists before saving
        $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
        if ($table_exists !== $table_name) {
            // Table doesn't exist - create it
            $this->create_faq_table();
            // Verify table was created
            $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
            if ($table_exists !== $table_name) {
                wp_die(__('Failed to create FAQ table. Please check database permissions.', 'twork-rewards'));
            }
        }

        // PROFESSIONAL FIX: Validate required fields
        if (empty($_POST['question'])) {
            wp_die(__('Question is required.', 'twork-rewards'));
        }
        if (empty($_POST['answer'])) {
            wp_die(__('Answer is required.', 'twork-rewards'));
        }

        $id = isset($_POST['faq_id']) ? absint($_POST['faq_id']) : 0;
        $question = sanitize_text_field($_POST['question']);
        $answer = wp_kses_post($_POST['answer']);  // Allow HTML but sanitize
        $display_order = isset($_POST['display_order']) ? absint($_POST['display_order']) : 0;
        $status = isset($_POST['status']) ? sanitize_text_field($_POST['status']) : 'active';

        $data = array(
            'question' => $question,
            'answer' => $answer,
            'display_order' => $display_order,
            'status' => $status,
        );

        if ($id > 0) {
            // Update existing FAQ
            $result = $wpdb->update($table_name, $data, array('id' => $id));
            if ($result === false) {
                wp_die(__('Error updating FAQ item. Database error: ', 'twork-rewards') . $wpdb->last_error);
            }
        } else {
            // Insert new FAQ
            $result = $wpdb->insert($table_name, $data);
            if ($result === false) {
                wp_die(__('Error creating FAQ item. Database error: ', 'twork-rewards') . $wpdb->last_error);
            }
        }

        wp_safe_redirect(add_query_arg(array('page' => 'twork-rewards-faq', 'updated' => 1), admin_url('admin.php')));
        exit;
    }

    /**
     * Handle FAQ delete
     */
    public function handle_faq_delete()
    {
        if (!current_user_can('manage_woocommerce') && !current_user_can('manage_options')) {
            wp_die(__('You do not have permission to perform this action.', 'twork-rewards'));
        }

        check_admin_referer('twork_rewards_delete_faq');

        global $wpdb;
        $table_name = $this->faq_table_name();

        // PROFESSIONAL FIX: Ensure table exists before deleting
        $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
        if ($table_exists !== $table_name) {
            // Table doesn't exist - nothing to delete
            wp_safe_redirect(add_query_arg(array('page' => 'twork-rewards-faq', 'deleted' => 1), admin_url('admin.php')));
            exit;
        }

        $id = isset($_POST['faq_id']) ? absint($_POST['faq_id']) : 0;
        if ($id > 0) {
            $result = $wpdb->delete($table_name, array('id' => $id), array('%d'));
            if ($result === false && defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: Failed to delete FAQ item. Error: ' . $wpdb->last_error);
            }
        }

        wp_safe_redirect(add_query_arg(array('page' => 'twork-rewards-faq', 'deleted' => 1), admin_url('admin.php')));
        exit;
    }

    /**
     * Render About Us Management Page
     * Professional admin interface for managing About Us content
     */
    public function render_about_us_page()
    {
        // PROFESSIONAL FIX: Wrap in try-catch to prevent critical errors
        try {
            if (!current_user_can('manage_woocommerce') && !current_user_can('manage_options')) {
                wp_die(__('You do not have permission to access this page.', 'twork-rewards'));
            }

            global $wpdb;
            $table_name = $this->about_us_table_name();

            // PROFESSIONAL FIX: Ensure table exists before proceeding
            $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
            if ($table_exists !== $table_name) {
                // Table doesn't exist - create it
                $this->create_about_us_table();
                // Verify table was created
                $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
                if ($table_exists !== $table_name) {
                    throw new Exception(__('Failed to create About Us table. Please check database permissions.', 'twork-rewards'));
                }
            }

            // Handle messages
            if (isset($_GET['updated']) && $_GET['updated'] == '1') {
                echo '<div class="notice notice-success is-dismissible"><p>' . esc_html__('About Us content saved successfully.', 'twork-rewards') . '</p></div>';
            }

            // Get existing content (there should be only one record)
            $content = $wpdb->get_row(
                "SELECT * FROM `$table_name` WHERE status = 'active' ORDER BY id ASC LIMIT 1",
                ARRAY_A
            );

            // Check for database errors
            if ($wpdb->last_error && defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: About Us query error: ' . $wpdb->last_error);
            }

            // Set default values if no content exists
            // PROFESSIONAL FIX: Unescape content retrieved from database to prevent double/triple escaping
            $company_name = $content ? wp_unslash($content['company_name']) : 'PLANETmm';
            $tagline = $content ? wp_unslash($content['tagline']) : 'Pansy & Lincoln';
            $subtitle = $content ? wp_unslash($content['subtitle']) : 'All-in-One Network Myanmar';
            $logo_url = $content ? wp_unslash($content['logo_url']) : '';
            $about_body_1 = $content ? wp_unslash($content['about_body_1']) : '';
            $about_body_2 = $content ? wp_unslash($content['about_body_2']) : '';
            $mission = $content ? wp_unslash($content['mission']) : '';
            $vision = $content ? wp_unslash($content['vision']) : '';
            $email = $content ? wp_unslash($content['email']) : '';
            $phone = $content ? wp_unslash($content['phone']) : '';
            $address = $content ? wp_unslash($content['address']) : '';
            $version = $content ? wp_unslash($content['version']) : '1.0.2';
            $status = $content ? wp_unslash($content['status']) : 'active';
            $content_id = $content ? $content['id'] : 0;

            // Enqueue editor
            wp_enqueue_editor();
            wp_enqueue_media();
            ?>
            <div class="wrap">
                <h1><?php esc_html_e('About Us Management', 'twork-rewards'); ?></h1>
                
                <p><?php esc_html_e('Manage the About Us page content that is displayed in the mobile app. All fields are editable and will be shown on the About Us page.', 'twork-rewards'); ?></p>
                
                <form method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>">
                    <?php wp_nonce_field('twork_rewards_save_about_us'); ?>
                    <input type="hidden" name="action" value="twork_rewards_save_about_us">
                    <input type="hidden" name="about_us_id" value="<?php echo esc_attr($content_id); ?>">
                    
                    <h2 class="nav-tab-wrapper">
                        <a href="#basic-info" class="nav-tab nav-tab-active"><?php esc_html_e('Basic Information', 'twork-rewards'); ?></a>
                        <a href="#about-content" class="nav-tab"><?php esc_html_e('About Content', 'twork-rewards'); ?></a>
                        <a href="#mission-vision" class="nav-tab"><?php esc_html_e('Mission & Vision', 'twork-rewards'); ?></a>
                        <a href="#contact-info" class="nav-tab"><?php esc_html_e('Contact Information', 'twork-rewards'); ?></a>
                    </h2>
                    
                    <div id="basic-info" class="tab-content">
                        <table class="form-table">
                            <tr>
                                <th scope="row"><label for="company_name"><?php esc_html_e('Company Name', 'twork-rewards'); ?></label></th>
                                <td>
                                    <input type="text" id="company_name" name="company_name" value="<?php echo esc_attr($company_name); ?>" class="regular-text" required>
                                    <p class="description"><?php esc_html_e('The main company name displayed in the header.', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row"><label for="tagline"><?php esc_html_e('Tagline', 'twork-rewards'); ?></label></th>
                                <td>
                                    <input type="text" id="tagline" name="tagline" value="<?php echo esc_attr($tagline); ?>" class="regular-text">
                                    <p class="description"><?php esc_html_e('Short tagline or company subtitle.', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row"><label for="subtitle"><?php esc_html_e('Subtitle', 'twork-rewards'); ?></label></th>
                                <td>
                                    <input type="text" id="subtitle" name="subtitle" value="<?php echo esc_attr($subtitle); ?>" class="regular-text">
                                    <p class="description"><?php esc_html_e('Additional subtitle text.', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row"><label for="logo_url"><?php esc_html_e('Logo URL', 'twork-rewards'); ?></label></th>
                                <td>
                                    <input type="url" id="logo_url" name="logo_url" value="<?php echo esc_attr($logo_url); ?>" class="regular-text">
                                    <p class="description"><?php esc_html_e('URL to the company logo image. Leave empty to use default logo from assets.', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row"><label for="version"><?php esc_html_e('App Version', 'twork-rewards'); ?></label></th>
                                <td>
                                    <input type="text" id="version" name="version" value="<?php echo esc_attr($version); ?>" class="small-text">
                                    <p class="description"><?php esc_html_e('App version number displayed at the bottom of the About Us page.', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <div id="about-content" class="tab-content" style="display:none;">
                        <table class="form-table">
                            <tr>
                                <th scope="row"><label for="about_body_1"><?php esc_html_e('About Body Text 1', 'twork-rewards'); ?></label></th>
                                <td>
                                    <?php
                                    wp_editor($about_body_1, 'about_body_1', array(
                                        'textarea_rows' => 6,
                                        'media_buttons' => false,
                                        'teeny' => true,
                                    ));
                                    ?>
                                    <p class="description"><?php esc_html_e('First paragraph of the About Us section.', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row"><label for="about_body_2"><?php esc_html_e('About Body Text 2', 'twork-rewards'); ?></label></th>
                                <td>
                                    <?php
                                    wp_editor($about_body_2, 'about_body_2', array(
                                        'textarea_rows' => 6,
                                        'media_buttons' => false,
                                        'teeny' => true,
                                    ));
                                    ?>
                                    <p class="description"><?php esc_html_e('Second paragraph of the About Us section.', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <div id="mission-vision" class="tab-content" style="display:none;">
                        <table class="form-table">
                            <tr>
                                <th scope="row"><label for="mission"><?php esc_html_e('Mission', 'twork-rewards'); ?></label></th>
                                <td>
                                    <?php
                                    wp_editor($mission, 'mission', array(
                                        'textarea_rows' => 6,
                                        'media_buttons' => false,
                                        'teeny' => true,
                                    ));
                                    ?>
                                    <p class="description"><?php esc_html_e('Company mission statement.', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row"><label for="vision"><?php esc_html_e('Vision', 'twork-rewards'); ?></label></th>
                                <td>
                                    <?php
                                    wp_editor($vision, 'vision', array(
                                        'textarea_rows' => 6,
                                        'media_buttons' => false,
                                        'teeny' => true,
                                    ));
                                    ?>
                                    <p class="description"><?php esc_html_e('Company vision statement.', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <div id="contact-info" class="tab-content" style="display:none;">
                        <table class="form-table">
                            <tr>
                                <th scope="row"><label for="email"><?php esc_html_e('Email', 'twork-rewards'); ?></label></th>
                                <td>
                                    <input type="email" id="email" name="email" value="<?php echo esc_attr($email); ?>" class="regular-text">
                                    <p class="description"><?php esc_html_e('Contact email address.', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row"><label for="phone"><?php esc_html_e('Phone', 'twork-rewards'); ?></label></th>
                                <td>
                                    <input type="text" id="phone" name="phone" value="<?php echo esc_attr($phone); ?>" class="regular-text">
                                    <p class="description"><?php esc_html_e('Contact phone number.', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row"><label for="address"><?php esc_html_e('Address', 'twork-rewards'); ?></label></th>
                                <td>
                                    <textarea id="address" name="address" rows="3" class="large-text"><?php echo esc_textarea($address); ?></textarea>
                                    <p class="description"><?php esc_html_e('Company address.', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row"><label for="status"><?php esc_html_e('Status', 'twork-rewards'); ?></label></th>
                                <td>
                                    <select id="status" name="status">
                                        <option value="active" <?php selected($status, 'active'); ?>><?php esc_html_e('Active', 'twork-rewards'); ?></option>
                                        <option value="draft" <?php selected($status, 'draft'); ?>><?php esc_html_e('Draft', 'twork-rewards'); ?></option>
                                    </select>
                                    <p class="description"><?php esc_html_e('Only active content is displayed in the mobile app.', 'twork-rewards'); ?></p>
                                </td>
                            </tr>
                        </table>
                    </div>
                    
                    <p class="submit">
                        <input type="submit" name="submit" id="submit" class="button button-primary" value="<?php esc_attr_e('Save About Us Content', 'twork-rewards'); ?>">
                    </p>
                </form>
            </div>
            
            <script>
            jQuery(document).ready(function($) {
                // Tab switching
                $('.nav-tab-wrapper a').on('click', function(e) {
                    e.preventDefault();
                    var target = $(this).attr('href');
                    $('.nav-tab').removeClass('nav-tab-active');
                    $(this).addClass('nav-tab-active');
                    $('.tab-content').hide();
                    $(target).show();
                });
            });
            </script>
            <?php
        } catch (Exception $e) {
            // PROFESSIONAL FIX: Display user-friendly error instead of critical error
            if (defined('WP_DEBUG') && WP_DEBUG) {
                error_log('T-Work Rewards: About Us page error: ' . $e->getMessage());
                error_log('T-Work Rewards: About Us page stack trace: ' . $e->getTraceAsString());
            }

            echo '<div class="wrap">';
            echo '<h1>' . esc_html__('About Us Management', 'twork-rewards') . '</h1>';
            echo '<div class="notice notice-error"><p>';
            echo esc_html__('An error occurred while loading the About Us Management page. Please try again or contact support if the problem persists.', 'twork-rewards');
            if (defined('WP_DEBUG') && WP_DEBUG) {
                echo '<br><strong>Debug Info:</strong> ' . esc_html($e->getMessage());
            }
            echo '</p></div>';
            echo '<p><a href="' . esc_url(admin_url('admin.php?page=twork-rewards-about-us')) . '" class="button">' . esc_html__('Try Again', 'twork-rewards') . '</a></p>';
            echo '</div>';
        }
    }

    /**
     * Handle About Us save
     */
    public function handle_about_us_save()
    {
        if (!current_user_can('manage_woocommerce') && !current_user_can('manage_options')) {
            wp_die(__('You do not have permission to perform this action.', 'twork-rewards'));
        }

        check_admin_referer('twork_rewards_save_about_us');

        global $wpdb;
        $table_name = $this->about_us_table_name();

        // PROFESSIONAL FIX: Ensure table exists before saving
        $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
        if ($table_exists !== $table_name) {
            // Table doesn't exist - create it
            $this->create_about_us_table();
            // Verify table was created
            $table_exists = $wpdb->get_var($wpdb->prepare('SHOW TABLES LIKE %s', $table_name));
            if ($table_exists !== $table_name) {
                wp_die(__('Failed to create About Us table. Please check database permissions.', 'twork-rewards'));
            }
        }

        // PROFESSIONAL FIX: Validate required fields
        if (empty($_POST['company_name'])) {
            wp_die(__('Company name is required.', 'twork-rewards'));
        }

        $id = isset($_POST['about_us_id']) ? absint($_POST['about_us_id']) : 0;
        // PROFESSIONAL FIX: Use wp_unslash() before sanitization to remove WordPress magic quotes
        // This prevents double/triple escaping of apostrophes and other special characters
        $data = array(
            'company_name' => sanitize_text_field(wp_unslash($_POST['company_name'] ?? '')),
            'tagline' => sanitize_text_field(wp_unslash($_POST['tagline'] ?? '')),
            'subtitle' => sanitize_text_field(wp_unslash($_POST['subtitle'] ?? '')),
            'logo_url' => esc_url_raw(wp_unslash($_POST['logo_url'] ?? '')),
            'about_body_1' => wp_kses_post(wp_unslash($_POST['about_body_1'] ?? '')),
            'about_body_2' => wp_kses_post(wp_unslash($_POST['about_body_2'] ?? '')),
            'mission' => wp_kses_post(wp_unslash($_POST['mission'] ?? '')),
            'vision' => wp_kses_post(wp_unslash($_POST['vision'] ?? '')),
            'email' => sanitize_email(wp_unslash($_POST['email'] ?? '')),
            'phone' => sanitize_text_field(wp_unslash($_POST['phone'] ?? '')),
            'address' => sanitize_textarea_field(wp_unslash($_POST['address'] ?? '')),
            'version' => sanitize_text_field(wp_unslash($_POST['version'] ?? '1.0.2')),
            'status' => sanitize_text_field(wp_unslash($_POST['status'] ?? 'active')),
        );

        if ($id > 0) {
            // Update existing content
            $result = $wpdb->update($table_name, $data, array('id' => $id));
            if ($result === false) {
                wp_die(__('Error updating About Us content. Database error: ', 'twork-rewards') . $wpdb->last_error);
            }
        } else {
            // Insert new content
            $result = $wpdb->insert($table_name, $data);
            if ($result === false) {
                wp_die(__('Error creating About Us content. Database error: ', 'twork-rewards') . $wpdb->last_error);
            }
        }

        wp_safe_redirect(add_query_arg(array('page' => 'twork-rewards-about-us', 'updated' => 1), admin_url('admin.php')));
        exit;
    }

    public function render_exchange_requests_page()
    {
        if (!current_user_can('manage_woocommerce') && !current_user_can('manage_options')) {
            wp_die(__('You do not have permission to access this page.', 'twork-rewards'));
        }

        global $wpdb;
        $exchange_table = $this->exchange_requests_table_name();

        // Get user preference for per_page
        $current_user_id = get_current_user_id();
        $saved_per_page = get_user_meta($current_user_id, 'twork_exchange_requests_per_page', true);
        $default_per_page = !empty($saved_per_page) ? absint($saved_per_page) : 25;

        // Get filter parameters
        $status = isset($_GET['status']) ? sanitize_text_field($_GET['status']) : '';
        $user_id = isset($_GET['user_id']) ? intval($_GET['user_id']) : 0;
        $type = isset($_GET['type']) ? sanitize_text_field($_GET['type']) : '';
        $phone_search = isset($_GET['phone']) ? sanitize_text_field($_GET['phone']) : '';
        $date_from = isset($_GET['date_from']) ? sanitize_text_field($_GET['date_from']) : '';
        $date_to = isset($_GET['date_to']) ? sanitize_text_field($_GET['date_to']) : '';
        $points_min = isset($_GET['points_min']) ? floatval($_GET['points_min']) : 0;
        $points_max = isset($_GET['points_max']) ? floatval($_GET['points_max']) : 0;
        $orderby = isset($_GET['orderby']) ? sanitize_text_field($_GET['orderby']) : 'created_at';
        $order = isset($_GET['order']) && strtoupper($_GET['order']) === 'ASC' ? 'ASC' : 'DESC';
        $paged = isset($_GET['paged']) ? max(1, intval($_GET['paged'])) : 1;
        $per_page = isset($_GET['per_page']) ? intval($_GET['per_page']) : $default_per_page;
        $per_page = ($per_page > 0) ? min(200, $per_page) : $default_per_page;

        // Save per_page preference
        if (isset($_GET['per_page']) && $per_page != $saved_per_page) {
            update_user_meta($current_user_id, 'twork_exchange_requests_per_page', $per_page);
        }

        $offset = ($paged - 1) * $per_page;

        // Build WHERE clause
        $where = array();
        $params = array();

        if ($status !== '') {
            $where[] = 'status = %s';
            $params[] = $status;
        }

        if ($user_id > 0) {
            $where[] = 'user_id = %d';
            $params[] = $user_id;
        }

        if ($type !== '') {
            $where[] = 'type = %s';
            $params[] = $type;
        }

        if ($phone_search !== '') {
            $where[] = 'phone LIKE %s';
            $params[] = '%' . $wpdb->esc_like($phone_search) . '%';
        }

        if ($date_from !== '') {
            $where[] = 'DATE(created_at) >= %s';
            $params[] = $date_from;
        }

        if ($date_to !== '') {
            $where[] = 'DATE(created_at) <= %s';
            $params[] = $date_to;
        }

        if ($points_min > 0) {
            $where[] = 'CAST(points_value AS DECIMAL(10,2)) >= %f';
            $params[] = $points_min;
        }

        if ($points_max > 0) {
            $where[] = 'CAST(points_value AS DECIMAL(10,2)) <= %f';
            $params[] = $points_max;
        }

        $where_sql = '';
        if (!empty($where)) {
            $where_sql = 'WHERE ' . implode(' AND ', $where);
        }

        // Validate orderby
        $allowed_orderby = array('id', 'created_at', 'updated_at', 'points_value', 'status', 'type', 'user_id');
        if (!in_array($orderby, $allowed_orderby, true)) {
            $orderby = 'created_at';
        }

        // Get statistics
        $stats = array(
            'total' => (int) $wpdb->get_var("SELECT COUNT(*) FROM $exchange_table"),
            'pending' => (int) $wpdb->get_var($wpdb->prepare("SELECT COUNT(*) FROM $exchange_table WHERE status = %s", 'pending')),
            'approved' => (int) $wpdb->get_var($wpdb->prepare("SELECT COUNT(*) FROM $exchange_table WHERE status = %s", 'approved')),
            'rejected' => (int) $wpdb->get_var($wpdb->prepare("SELECT COUNT(*) FROM $exchange_table WHERE status = %s", 'rejected')),
        );

        // Get total points
        $total_points_pending = $wpdb->get_var($wpdb->prepare(
            "SELECT SUM(CAST(points_value AS DECIMAL(10,2))) FROM $exchange_table WHERE status = %s",
            'pending'
        ));
        $total_points_pending = $total_points_pending ? floatval($total_points_pending) : 0;

        // Get total
        $total_sql = "SELECT COUNT(*) FROM $exchange_table $where_sql";
        $total = (int) $wpdb->get_var($wpdb->prepare($total_sql, $params));

        // Get rows with ordering
        $orderby_sql = esc_sql($orderby);
        $order_sql = esc_sql($order);
        $query_sql = "SELECT * FROM $exchange_table $where_sql ORDER BY $orderby_sql $order_sql LIMIT %d OFFSET %d";
        $rows = $wpdb->get_results($wpdb->prepare($query_sql, array_merge($params, array($per_page, $offset))));

        $total_pages = $per_page > 0 ? (int) ceil(max(0, $total) / $per_page) : 1;

        if ($total_pages > 0 && $paged > $total_pages) {
            $paged = $total_pages;
            $offset = ($paged - 1) * $per_page;
            $rows = $wpdb->get_results($wpdb->prepare($query_sql, array_merge($params, array($per_page, $offset))));
        }

        $pagination_links = '';
        if ($total_pages > 1) {
            $base_args = array(
                'page' => 'twork-rewards-exchange-requests',
                'status' => $status,
                'user_id' => $user_id,
                'type' => $type,
                'phone' => $phone_search,
                'date_from' => $date_from,
                'date_to' => $date_to,
                'points_min' => $points_min > 0 ? $points_min : '',
                'points_max' => $points_max > 0 ? $points_max : '',
                'orderby' => $orderby,
                'order' => $order,
                'per_page' => $per_page,
            );

            $pagination_links = paginate_links(array(
                'base' => add_query_arg(array_merge($base_args, array('paged' => '%#%')), admin_url('admin.php')),
                'format' => '',
                'current' => $paged,
                'total' => max(1, $total_pages),
                'prev_text' => __('Â« Previous', 'twork-rewards'),
                'next_text' => __('Next Â»', 'twork-rewards'),
            ));
        }

        $requests = $rows;
        $currentPage = $paged;

        // Handle export
        if (isset($_GET['export']) && $_GET['export'] === 'csv') {
            $this->handle_exchange_export();
            return;  // Exit early, export handles output
        }

        // Build export URL
        $export_args = array(
            'page' => 'twork-rewards-exchange-requests',
            'status' => $status,
            'user_id' => $user_id,
            'type' => $type,
            'phone' => $phone_search,
            'date_from' => $date_from,
            'date_to' => $date_to,
            'points_min' => $points_min > 0 ? $points_min : '',
            'points_max' => $points_max > 0 ? $points_max : '',
            'export' => 'csv',
        );
        $export_url = add_query_arg($export_args, admin_url('admin.php'));

        // Show success/error messages
        if (isset($_GET['bulk_approved'])) {
            echo '<div class="notice notice-success is-dismissible"><p>';
            printf(esc_html__('%d request(s) approved successfully.', 'twork-rewards'), absint($_GET['bulk_approved']));
            echo '</p></div>';
        }
        if (isset($_GET['bulk_rejected'])) {
            echo '<div class="notice notice-success is-dismissible"><p>';
            printf(esc_html__('%d request(s) rejected successfully.', 'twork-rewards'), absint($_GET['bulk_rejected']));
            echo '</p></div>';
        }
        if (isset($_GET['bulk_errors'])) {
            echo '<div class="notice notice-error is-dismissible"><p>';
            printf(esc_html__('%d request(s) could not be processed.', 'twork-rewards'), absint($_GET['bulk_errors']));
            echo '</p></div>';
        }
        if (isset($_GET['refund_error']) && intval($_GET['refund_error']) === 1) {
            $request_id = isset($_GET['request_id']) ? absint($_GET['request_id']) : 0;
            echo '<div class="notice notice-error is-dismissible"><p>';
            if ($request_id > 0) {
                printf(
                    esc_html__('CRITICAL: Exchange request #%d was rejected, but the points refund failed. Please check the error logs and manually refund the points to the user.', 'twork-rewards'),
                    $request_id
                );
            } else {
                esc_html_e('CRITICAL: Exchange request was rejected, but the points refund failed. Please check the error logs and manually refund the points to the user.', 'twork-rewards');
            }
            echo '</p></div>';
        }
        ?>
        <div class="wrap">
            <h1 class="wp-heading-inline"><?php esc_html_e('Exchange Requests', 'twork-rewards'); ?></h1>
            <a href="<?php echo esc_url($export_url); ?>" class="page-title-action">
                <?php esc_html_e('Export CSV', 'twork-rewards'); ?>
            </a>
            <hr class="wp-header-end">

            <!-- Statistics Cards -->
            <div class="twork-stats-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
                <div class="stat-card" style="background: #fff; border: 1px solid #ddd; border-left: 4px solid #2271b1; padding: 20px; border-radius: 4px;">
                    <div style="font-size: 32px; font-weight: bold; color: #2271b1; margin-bottom: 5px;">
                        <?php echo esc_html(number_format($stats['total'])); ?>
                    </div>
                    <div style="color: #666; font-size: 14px;">
                        <?php esc_html_e('Total Requests', 'twork-rewards'); ?>
                    </div>
                </div>
                <div class="stat-card" style="background: #fff; border: 1px solid #ddd; border-left: 4px solid #f0ad4e; padding: 20px; border-radius: 4px;">
                    <div style="font-size: 32px; font-weight: bold; color: #f0ad4e; margin-bottom: 5px;">
                        <?php echo esc_html(number_format($stats['pending'])); ?>
                    </div>
                    <div style="color: #666; font-size: 14px;">
                        <?php esc_html_e('Pending', 'twork-rewards'); ?>
                    </div>
                    <?php if ($total_points_pending > 0): ?>
                        <div style="color: #999; font-size: 12px; margin-top: 5px;">
                            <?php echo esc_html(number_format($total_points_pending, 2)); ?> <?php esc_html_e('PNP', 'twork-rewards'); ?>
                        </div>
                    <?php endif; ?>
                </div>
                <div class="stat-card" style="background: #fff; border: 1px solid #ddd; border-left: 4px solid #5cb85c; padding: 20px; border-radius: 4px;">
                    <div style="font-size: 32px; font-weight: bold; color: #5cb85c; margin-bottom: 5px;">
                        <?php echo esc_html(number_format($stats['approved'])); ?>
                    </div>
                    <div style="color: #666; font-size: 14px;">
                        <?php esc_html_e('Approved', 'twork-rewards'); ?>
                    </div>
                </div>
                <div class="stat-card" style="background: #fff; border: 1px solid #ddd; border-left: 4px solid #d9534f; padding: 20px; border-radius: 4px;">
                    <div style="font-size: 32px; font-weight: bold; color: #d9534f; margin-bottom: 5px;">
                        <?php echo esc_html(number_format($stats['rejected'])); ?>
                    </div>
                    <div style="color: #666; font-size: 14px;">
                        <?php esc_html_e('Rejected', 'twork-rewards'); ?>
                    </div>
                </div>
            </div>

            <p class="description">
                <?php esc_html_e('Requests submitted from the mobile app when customers want to exchange their rewards or points. Approve a request to complete the exchange, or reject it to refund the deducted points back to the customer.', 'twork-rewards'); ?>
            </p>

            <!-- Advanced Filter Form - Compact Professional Design -->
            <div class="twork-filter-panel" style="background: #fff; border: 1px solid #ddd; padding: 15px; margin: 20px 0; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <h2 style="margin: 0; font-size: 16px; font-weight: 600; color: #23282d;">
                        <span class="dashicons dashicons-filter" style="vertical-align: middle; margin-right: 5px;"></span>
                        <?php esc_html_e('Advanced Filters', 'twork-rewards'); ?>
                    </h2>
                    <button type="button" class="button button-small" id="twork-toggle-filters" style="margin: 0;">
                        <span class="dashicons dashicons-arrow-down-alt2" style="vertical-align: middle;"></span>
                        <span class="toggle-text"><?php esc_html_e('Show Filters', 'twork-rewards'); ?></span>
                    </button>
                </div>
                
                <form method="get" action="" class="twork-filter-form" id="twork-filter-form">
                    <input type="hidden" name="page" value="twork-rewards-exchange-requests" />
                    
                    <div class="twork-filter-details" style="display: none; border-top: 1px solid #eee; padding-top: 15px;">
                        <!-- First Row: Quick Filters -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 12px;">
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #555;">
                                    <?php esc_html_e('Status', 'twork-rewards'); ?>
                                </label>
                                <select name="status" style="width: 100%; padding: 6px 8px; font-size: 13px;">
                                    <option value=""><?php esc_html_e('All', 'twork-rewards'); ?></option>
                                    <option value="pending" <?php selected($status, 'pending'); ?>><?php esc_html_e('Pending', 'twork-rewards'); ?></option>
                                    <option value="approved" <?php selected($status, 'approved'); ?>><?php esc_html_e('Approved', 'twork-rewards'); ?></option>
                                    <option value="rejected" <?php selected($status, 'rejected'); ?>><?php esc_html_e('Rejected', 'twork-rewards'); ?></option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #555;">
                                    <?php esc_html_e('Type', 'twork-rewards'); ?>
                                </label>
                                <select name="type" style="width: 100%; padding: 6px 8px; font-size: 13px;">
                                    <option value=""><?php esc_html_e('All Types', 'twork-rewards'); ?></option>
                                    <option value="points" <?php selected($type, 'points'); ?>><?php esc_html_e('Points', 'twork-rewards'); ?></option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #555;">
                                    <?php esc_html_e('User ID', 'twork-rewards'); ?>
                                </label>
                                <input type="number" name="user_id" style="width: 100%; padding: 6px 8px; font-size: 13px;" 
                                       placeholder="<?php esc_attr_e('User ID', 'twork-rewards'); ?>" 
                                       value="<?php echo esc_attr($user_id ?: ''); ?>" />
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #555;">
                                    <?php esc_html_e('Phone', 'twork-rewards'); ?>
                                </label>
                                <input type="text" name="phone" style="width: 100%; padding: 6px 8px; font-size: 13px;" 
                                       placeholder="<?php esc_attr_e('Search by phone', 'twork-rewards'); ?>" 
                                       value="<?php echo esc_attr($phone_search); ?>" />
                            </div>
                        </div>
                        
                        <!-- Second Row: Date Range -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 12px;">
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #555;">
                                    <?php esc_html_e('Date From', 'twork-rewards'); ?>
                                </label>
                                <input type="date" name="date_from" style="width: 100%; padding: 6px 8px; font-size: 13px;" 
                                       value="<?php echo esc_attr($date_from); ?>" />
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #555;">
                                    <?php esc_html_e('Date To', 'twork-rewards'); ?>
                                </label>
                                <input type="date" name="date_to" style="width: 100%; padding: 6px 8px; font-size: 13px;" 
                                       value="<?php echo esc_attr($date_to); ?>" />
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #555;">
                                    <?php esc_html_e('Points Min', 'twork-rewards'); ?>
                                </label>
                                <input type="number" name="points_min" style="width: 100%; padding: 6px 8px; font-size: 13px;" step="0.01" min="0"
                                       placeholder="<?php esc_attr_e('Min', 'twork-rewards'); ?>" 
                                       value="<?php echo esc_attr($points_min > 0 ? $points_min : ''); ?>" />
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #555;">
                                    <?php esc_html_e('Points Max', 'twork-rewards'); ?>
                                </label>
                                <input type="number" name="points_max" style="width: 100%; padding: 6px 8px; font-size: 13px;" step="0.01" min="0"
                                       placeholder="<?php esc_attr_e('Max', 'twork-rewards'); ?>" 
                                       value="<?php echo esc_attr($points_max > 0 ? $points_max : ''); ?>" />
                            </div>
                        </div>
                        
                        <!-- Third Row: Sort & Display Options -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 12px;">
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #555;">
                                    <?php esc_html_e('Sort By', 'twork-rewards'); ?>
                                </label>
                                <select name="orderby" style="width: 100%; padding: 6px 8px; font-size: 13px;">
                                    <option value="created_at" <?php selected($orderby, 'created_at'); ?>><?php esc_html_e('Date', 'twork-rewards'); ?></option>
                                    <option value="id" <?php selected($orderby, 'id'); ?>><?php esc_html_e('ID', 'twork-rewards'); ?></option>
                                    <option value="points_value" <?php selected($orderby, 'points_value'); ?>><?php esc_html_e('Points', 'twork-rewards'); ?></option>
                                    <option value="status" <?php selected($orderby, 'status'); ?>><?php esc_html_e('Status', 'twork-rewards'); ?></option>
                                    <option value="user_id" <?php selected($orderby, 'user_id'); ?>><?php esc_html_e('User ID', 'twork-rewards'); ?></option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #555;">
                                    <?php esc_html_e('Order', 'twork-rewards'); ?>
                                </label>
                                <select name="order" style="width: 100%; padding: 6px 8px; font-size: 13px;">
                                    <option value="DESC" <?php selected($order, 'DESC'); ?>><?php esc_html_e('Descending', 'twork-rewards'); ?></option>
                                    <option value="ASC" <?php selected($order, 'ASC'); ?>><?php esc_html_e('Ascending', 'twork-rewards'); ?></option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #555;">
                                    <?php esc_html_e('Per Page', 'twork-rewards'); ?>
                                </label>
                                <select name="per_page" style="width: 100%; padding: 6px 8px; font-size: 13px;">
                                    <option value="10" <?php selected($per_page, 10); ?>>10</option>
                                    <option value="25" <?php selected($per_page, 25); ?>>25</option>
                                    <option value="50" <?php selected($per_page, 50); ?>>50</option>
                                    <option value="100" <?php selected($per_page, 100); ?>>100</option>
                                    <option value="200" <?php selected($per_page, 200); ?>>200</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; padding-top: 12px; border-top: 1px solid #eee;">
                            <?php submit_button(__('Apply Filters', 'twork-rewards'), 'primary', '', false, array('style' => 'margin: 0;')); ?>
                            <a class="button button-secondary" href="<?php echo esc_url(admin_url('admin.php?page=twork-rewards-exchange-requests')); ?>" style="margin: 0;">
                                <?php esc_html_e('Reset All', 'twork-rewards'); ?>
                            </a>
                            <?php if (!empty($status) || !empty($user_id) || !empty($type) || !empty($phone_search) || !empty($date_from) || !empty($date_to) || $points_min > 0 || $points_max > 0): ?>
                                <span style="color: #666; font-size: 13px; margin-left: auto;">
                                    <strong><?php printf(esc_html__('Showing %d result(s)', 'twork-rewards'), $total); ?></strong>
                                </span>
                            <?php endif; ?>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Bulk Actions Form -->
            <form method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>" id="twork-bulk-actions-form" style="margin: 20px 0;">
                <?php wp_nonce_field('twork_rewards_bulk_exchange_action', 'twork_rewards_bulk_exchange_nonce'); ?>
                <input type="hidden" name="action" value="twork_rewards_bulk_exchange_action" />
                
                <div class="tablenav top">
                    <div class="alignleft actions bulkactions">
                        <select name="bulk_action" id="bulk-action-selector">
                            <option value=""><?php esc_html_e('Bulk Actions', 'twork-rewards'); ?></option>
                            <option value="approve"><?php esc_html_e('Approve', 'twork-rewards'); ?></option>
                            <option value="reject"><?php esc_html_e('Reject', 'twork-rewards'); ?></option>
                        </select>
                        <input type="submit" class="button action" value="<?php esc_attr_e('Apply', 'twork-rewards'); ?>" />
                    </div>
                    <?php if ($pagination_links): ?>
                        <div class="tablenav-pages">
                            <?php echo $pagination_links; ?>
                        </div>
                    <?php endif; ?>
                </div>

                <?php if (!empty($requests)): ?>
                    <table class="wp-list-table widefat fixed striped">
                        <thead>
                            <tr>
                                <td class="manage-column column-cb check-column">
                                    <input type="checkbox" id="cb-select-all" />
                                </td>
                                <th class="manage-column column-id sortable <?php echo $orderby === 'id' ? 'sorted ' . strtolower($order) : ''; ?>">
                                    <a href="<?php echo esc_url(add_query_arg(array('orderby' => 'id', 'order' => $orderby === 'id' && $order === 'ASC' ? 'DESC' : 'ASC'), remove_query_arg(array('paged')))); ?>">
                                        <?php esc_html_e('ID', 'twork-rewards'); ?>
                                    </a>
                                </th>
                                <th class="manage-column column-date sortable <?php echo $orderby === 'created_at' ? 'sorted ' . strtolower($order) : ''; ?>">
                                    <a href="<?php echo esc_url(add_query_arg(array('orderby' => 'created_at', 'order' => $orderby === 'created_at' && $order === 'ASC' ? 'DESC' : 'ASC'), remove_query_arg(array('paged')))); ?>">
                                        <?php esc_html_e('Date', 'twork-rewards'); ?>
                                    </a>
                                </th>
                                <th class="manage-column column-user">
                                    <?php esc_html_e('User', 'twork-rewards'); ?>
                                </th>
                                <th class="manage-column column-type">
                                    <?php esc_html_e('Type', 'twork-rewards'); ?>
                                </th>
                                <th class="manage-column column-points sortable <?php echo $orderby === 'points_value' ? 'sorted ' . strtolower($order) : ''; ?>">
                                    <a href="<?php echo esc_url(add_query_arg(array('orderby' => 'points_value', 'order' => $orderby === 'points_value' && $order === 'ASC' ? 'DESC' : 'ASC'), remove_query_arg(array('paged')))); ?>">
                                        <?php esc_html_e('Points Value', 'twork-rewards'); ?>
                                    </a>
                                </th>
                                <th class="manage-column column-phone">
                                    <?php esc_html_e('Phone', 'twork-rewards'); ?>
                                </th>
                                <th class="manage-column column-status sortable <?php echo $orderby === 'status' ? 'sorted ' . strtolower($order) : ''; ?>">
                                    <a href="<?php echo esc_url(add_query_arg(array('orderby' => 'status', 'order' => $orderby === 'status' && $order === 'ASC' ? 'DESC' : 'ASC'), remove_query_arg(array('paged')))); ?>">
                                        <?php esc_html_e('Status', 'twork-rewards'); ?>
                                    </a>
                                </th>
                                <th class="manage-column column-actions">
                                    <?php esc_html_e('Actions', 'twork-rewards'); ?>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php
                            foreach ($requests as $req):
                                // PROFESSIONAL: Enhanced user lookup with fallback methods
                                $user_id = absint($req->user_id);
                                $user = $this->get_user_data_enhanced($user_id);

                                $user_points = 0;
                                if ($user_id > 0) {
                                    $user_points = get_user_meta($user_id, 'my_points', true);
                                    $user_points = $user_points ? floatval($user_points) : 0;
                                }
                                ?>
                                <tr>
                                    <th scope="row" class="check-column">
                                        <input type="checkbox" name="request_ids[]" value="<?php echo esc_attr($req->id); ?>" />
                                    </th>
                                    <td>
                                        <strong>#<?php echo esc_html($req->id); ?></strong>
                                    </td>
                                    <td>
                                        <?php
                                        // Professional: Display exchange request date in Myanmar timezone
                                        $formatted_date = $this->format_myanmar_time($req->created_at);
                                        echo esc_html($formatted_date ?: $req->created_at);
                                        ?>
                                        <?php if (!empty($req->updated_at) && $req->updated_at !== $req->created_at): ?>
                                            <div class="description" style="font-size: 11px; color: #999;">
                                                <?php esc_html_e('Updated:', 'twork-rewards'); ?> 
                                                <?php
                                                $formatted_updated = $this->format_myanmar_time($req->updated_at);
                                                echo esc_html($formatted_updated ?: $req->updated_at);
                                                ?>
                                            </div>
                                        <?php endif; ?>
                                    </td>
                                    <td>
                                        <?php if ($user && isset($user->ID)): ?>
                                            <a href="<?php echo esc_url(admin_url('user-edit.php?user_id=' . $user->ID)); ?>" style="font-weight: 600;">
                                                <?php echo esc_html($user->display_name ?: ($user->user_login ?? __('User', 'twork-rewards'))); ?>
                                            </a>
                                            <div class="description">
                                                <?php echo esc_html(sprintf(__('ID: %d', 'twork-rewards'), $user->ID)); ?>
                                                <?php if (isset($user->user_email) && !empty($user->user_email)): ?>
                                                    | <?php echo esc_html($user->user_email); ?>
                                                <?php endif; ?>
                                                <?php if ($user_points > 0): ?>
                                                    | <?php echo esc_html(number_format($user_points, 2)); ?> <?php esc_html_e('PNP', 'twork-rewards'); ?>
                                                <?php endif; ?>
                                            </div>
                                        <?php else: ?>
                                            <span style="color: #d63638; font-weight: 600;">
                                                <span class="dashicons dashicons-warning" style="vertical-align: middle; font-size: 16px;"></span>
                                                <?php esc_html_e('User Not Found', 'twork-rewards'); ?>
                                            </span>
                                            <div class="description" style="margin-top: 4px;">
                                                <?php echo esc_html(sprintf(__('User ID: %d (User may have been deleted)', 'twork-rewards'), $req->user_id)); ?>
                                            </div>
                                        <?php endif; ?>
                                    </td>
                                    <td>
                                        <span class="dashicons dashicons-star-filled" style="color: #f0ad4e;"></span>
                                        <?php echo esc_html(ucfirst($req->type ?: 'points')); ?>
                                    </td>
                                    <td>
                                        <strong style="color: #f59e0b; font-size: 14px;">
                                            <?php echo esc_html(number_format(floatval($req->points_value ?: 0), 2)); ?> <?php esc_html_e('PNP', 'twork-rewards'); ?>
                                        </strong>
                                    </td>
                                    <td>
                                        <?php if (!empty($req->phone)): ?>
                                            <a href="tel:<?php echo esc_attr($req->phone); ?>" style="text-decoration: none;">
                                                <?php echo esc_html($req->phone); ?>
                                            </a>
                                        <?php else: ?>
                                            <span style="color: #999;">&mdash;</span>
                                        <?php endif; ?>
                                    </td>
                                    <td>
                                        <span class="status-<?php echo esc_attr($req->status); ?>" style="padding: 4px 8px; border-radius: 3px; font-size: 12px; font-weight: 600;">
                                            <?php echo esc_html(ucfirst($req->status)); ?>
                                        </span>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                            <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-exchange-edit', 'id' => $req->id), admin_url('admin.php'))); ?>" 
                                               class="button button-small" 
                                               title="<?php esc_attr_e('View/Edit Details', 'twork-rewards'); ?>">
                                                <?php esc_html_e('View', 'twork-rewards'); ?>
                                            </a>
                                            <?php if ($req->status === 'pending'): ?>
                                                <form method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>" style="display: inline;">
                                                    <?php wp_nonce_field('twork_rewards_handle_exchange', 'twork_rewards_exchange_nonce'); ?>
                                                    <input type="hidden" name="action" value="twork_rewards_handle_exchange" />
                                                    <input type="hidden" name="request_id" value="<?php echo esc_attr($req->id); ?>" />
                                                    <input type="hidden" name="action_type" value="approve" />
                                                    <button type="submit" class="button button-small button-primary" 
                                                            onclick="return confirm('<?php esc_attr_e('Are you sure you want to approve this request?', 'twork-rewards'); ?>');"
                                                            title="<?php esc_attr_e('Approve Request', 'twork-rewards'); ?>">
                                                        <?php esc_html_e('Approve', 'twork-rewards'); ?>
                                                    </button>
                                                </form>
                                                <form method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>" style="display: inline;">
                                                    <?php wp_nonce_field('twork_rewards_handle_exchange', 'twork_rewards_exchange_nonce'); ?>
                                                    <input type="hidden" name="action" value="twork_rewards_handle_exchange" />
                                                    <input type="hidden" name="request_id" value="<?php echo esc_attr($req->id); ?>" />
                                                    <input type="hidden" name="action_type" value="reject" />
                                                    <button type="submit" class="button button-small" 
                                                            style="color: #d63638;"
                                                            onclick="return confirm('<?php esc_attr_e('Are you sure you want to reject this request? Points will be refunded.', 'twork-rewards'); ?>');"
                                                            title="<?php esc_attr_e('Reject Request', 'twork-rewards'); ?>">
                                                        <?php esc_html_e('Reject', 'twork-rewards'); ?>
                                                    </button>
                                                </form>
                                            <?php endif; ?>
                                        </div>
                                    </td>
                                </tr>
                                <?php if (!empty($req->note)): ?>
                                    <tr>
                                        <td colspan="9" style="padding: 10px 40px; font-style: italic; color: #666; background: #f9f9f9; border-left: 3px solid #2271b1;">
                                            <strong><?php esc_html_e('Note:', 'twork-rewards'); ?></strong> <?php echo esc_html($req->note); ?>
                                        </td>
                                    </tr>
                                <?php endif; ?>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                    
                    <div class="tablenav bottom">
                        <div class="alignleft actions bulkactions">
                            <select name="bulk_action" id="bulk-action-selector-bottom">
                                <option value=""><?php esc_html_e('Bulk Actions', 'twork-rewards'); ?></option>
                                <option value="approve"><?php esc_html_e('Approve', 'twork-rewards'); ?></option>
                                <option value="reject"><?php esc_html_e('Reject', 'twork-rewards'); ?></option>
                            </select>
                            <input type="submit" class="button action" value="<?php esc_attr_e('Apply', 'twork-rewards'); ?>" />
                        </div>
                        <?php if ($pagination_links): ?>
                            <div class="tablenav-pages">
                                <?php echo $pagination_links; ?>
                            </div>
                        <?php endif; ?>
                    </div>
                </form>

            <?php else: ?>
                <div style="text-align: center; padding: 60px 20px; background: #fff; border: 1px solid #ddd; border-radius: 4px; margin: 20px 0;">
                    <p style="font-size: 18px; color: #666; margin: 0;">
                        <?php esc_html_e('No exchange requests found.', 'twork-rewards'); ?>
                    </p>
                    <?php if (!empty($status) || !empty($user_id) || !empty($type) || !empty($phone_search) || !empty($date_from) || !empty($date_to) || $points_min > 0 || $points_max > 0): ?>
                        <p style="margin-top: 10px;">
                            <a href="<?php echo esc_url(admin_url('admin.php?page=twork-rewards-exchange-requests')); ?>" class="button">
                                <?php esc_html_e('Clear Filters', 'twork-rewards'); ?>
                            </a>
                        </p>
                    <?php endif; ?>
                </div>
            <?php endif; ?>
        </div>
        
        <style>
            .status-pending { 
                color: #f0ad4e; 
                font-weight: bold; 
                background: #fff3cd;
                padding: 4px 8px;
                border-radius: 3px;
                display: inline-block;
            }
            .status-approved { 
                color: #5cb85c; 
                font-weight: bold; 
                background: #d4edda;
                padding: 4px 8px;
                border-radius: 3px;
                display: inline-block;
            }
            .status-rejected { 
                color: #d9534f; 
                font-weight: bold; 
                background: #f8d7da;
                padding: 4px 8px;
                border-radius: 3px;
                display: inline-block;
            }
            .twork-filter-panel {
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            .twork-stats-cards .stat-card {
                transition: transform 0.2s, box-shadow 0.2s;
            }
            .twork-stats-cards .stat-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }
            .wp-list-table th.sortable a {
                text-decoration: none;
                color: #2271b1;
            }
            .wp-list-table th.sortable a:hover {
                color: #135e96;
            }
            .wp-list-table th.sorted a::after {
                content: " \2193";
                font-size: 12px;
            }
            .wp-list-table th.sorted.asc a::after {
                content: " \2191";
            }
        </style>
        
        <script>
        jQuery(document).ready(function($) {
            // Filter toggle functionality
            var filterDetails = $('.twork-filter-details');
            var toggleBtn = $('#twork-toggle-filters');
            var toggleText = toggleBtn.find('.toggle-text');
            var toggleIcon = toggleBtn.find('.dashicons');
            
            // Check if filters are active (any filter has value)
            var hasActiveFilters = <?php echo (!empty($status) || !empty($user_id) || !empty($type) || !empty($phone_search) || !empty($date_from) || !empty($date_to) || $points_min > 0 || $points_max > 0) ? 'true' : 'false'; ?>;
            
            // Show filters if active filters exist
            if (hasActiveFilters) {
                filterDetails.show();
                toggleText.text('<?php echo esc_js(__('Hide Filters', 'twork-rewards')); ?>');
                toggleIcon.removeClass('dashicons-arrow-down-alt2').addClass('dashicons-arrow-up-alt2');
            }
            
            // Toggle button click
            toggleBtn.on('click', function(e) {
                e.preventDefault();
                filterDetails.slideToggle(300, function() {
                    if (filterDetails.is(':visible')) {
                        toggleText.text('<?php echo esc_js(__('Hide Filters', 'twork-rewards')); ?>');
                        toggleIcon.removeClass('dashicons-arrow-down-alt2').addClass('dashicons-arrow-up-alt2');
                    } else {
                        toggleText.text('<?php echo esc_js(__('Show Filters', 'twork-rewards')); ?>');
                        toggleIcon.removeClass('dashicons-arrow-up-alt2').addClass('dashicons-arrow-down-alt2');
                    }
                });
            });
            
            // Select all checkbox
            $('#cb-select-all').on('click', function() {
                $('input[name="request_ids[]"]').prop('checked', this.checked);
            });
            
            // Sync bottom bulk action with top
            $('#bulk-action-selector-bottom').on('change', function() {
                $('#bulk-action-selector').val($(this).val());
            });
            $('#bulk-action-selector').on('change', function() {
                $('#bulk-action-selector-bottom').val($(this).val());
            });
            
            // Bulk form submission
            $('#twork-bulk-actions-form').on('submit', function(e) {
                var action = $('#bulk-action-selector').val();
                if (!action) {
                    e.preventDefault();
                    alert('<?php echo esc_js(__('Please select a bulk action.', 'twork-rewards')); ?>');
                    return false;
                }
                
                var checked = $('input[name="request_ids[]"]:checked').length;
                if (checked === 0) {
                    e.preventDefault();
                    alert('<?php echo esc_js(__('Please select at least one request.', 'twork-rewards')); ?>');
                    return false;
                }
                
                var confirmMsg = action === 'approve' 
                    ? '<?php echo esc_js(__('Are you sure you want to approve the selected requests?', 'twork-rewards')); ?>'
                    : '<?php echo esc_js(__('Are you sure you want to reject the selected requests? Points will be refunded.', 'twork-rewards')); ?>';
                
                if (!confirm(confirmMsg)) {
                    e.preventDefault();
                    return false;
                }
            });
        });
        </script>
        <?php
    }

    /**
     * Handle approve/reject actions for exchange requests
     */
    public function handle_exchange_action()
    {
        if (!current_user_can('manage_woocommerce') && !current_user_can('manage_options')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }

        check_admin_referer('twork_rewards_handle_exchange', 'twork_rewards_exchange_nonce');

        $request_id = isset($_POST['request_id']) ? absint($_POST['request_id']) : 0;
        $action_type = isset($_POST['action_type']) ? sanitize_text_field($_POST['action_type']) : '';

        if ($request_id <= 0 || !in_array($action_type, array('approve', 'reject'))) {
            wp_safe_redirect(add_query_arg(array(
                'page' => 'twork-rewards-exchange-requests',
                'error' => 1,
            ), admin_url('admin.php')));
            exit;
        }

        global $wpdb;
        $exchange_table = $this->exchange_requests_table_name();

        // Get the request
        $request = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $exchange_table WHERE id = %d",
            $request_id
        ));

        if (!$request) {
            wp_safe_redirect(add_query_arg(array(
                'page' => 'twork-rewards-exchange-requests',
                'error' => 1,
            ), admin_url('admin.php')));
            exit;
        }

        // PROFESSIONAL FIX: Allow rejecting approved requests (not just pending)
        // This enables admins to reverse approvals if needed
        // Only prevent action if already rejected (can't reject twice)
        if ($request->status === 'rejected' && $action_type === 'reject') {
            wp_safe_redirect(add_query_arg(array(
                'page' => 'twork-rewards-exchange-requests',
                'error' => 2,
            ), admin_url('admin.php')));
            exit;
        }

        // Allow approving rejected requests (reversing rejection)
        // Allow rejecting approved requests (reversing approval)
        $new_status = $action_type === 'approve' ? 'approved' : 'rejected';

        // PROFESSIONAL FIX: Get current admin user ID for action tracking
        $current_user_id = get_current_user_id();

        // Check which columns exist in the table
        $table_columns = $wpdb->get_col("DESCRIBE $exchange_table");
        $has_approved_by = in_array('approved_by', $table_columns);
        $has_approved_at = in_array('approved_at', $table_columns);
        $has_rejected_by = in_array('rejected_by', $table_columns);
        $has_rejected_at = in_array('rejected_at', $table_columns);
        $has_updated_by = in_array('updated_by', $table_columns);

        // Prepare update data
        $update_data = array(
            'status' => $new_status,
            'updated_at' => current_time('mysql'),
        );

        // PROFESSIONAL FIX: Track admin actions with timestamps
        // Track who approved the exchange request and when
        if ($new_status === 'approved') {
            if ($has_approved_by) {
                $update_data['approved_by'] = $current_user_id;
            }
            if ($has_approved_at) {
                $update_data['approved_at'] = current_time('mysql');
            }
            // Clear rejected fields when approving
            if ($has_rejected_by) {
                $update_data['rejected_by'] = null;
            }
            if ($has_rejected_at) {
                $update_data['rejected_at'] = null;
            }
        }

        // Track who rejected the exchange request and when
        if ($new_status === 'rejected') {
            if ($has_rejected_by) {
                $update_data['rejected_by'] = $current_user_id;
            }
            if ($has_rejected_at) {
                $update_data['rejected_at'] = current_time('mysql');
            }
            // Clear approved fields when rejecting
            if ($has_approved_by) {
                $update_data['approved_by'] = null;
            }
            if ($has_approved_at) {
                $update_data['approved_at'] = null;
            }
        }

        // Track who updated the exchange request (always update this when request is modified)
        if ($has_updated_by) {
            $update_data['updated_by'] = $current_user_id;
        }

        // Build format specifiers dynamically
        $format = array('%s', '%s');  // status and updated_at
        if ($has_approved_by && isset($update_data['approved_by'])) {
            $format[] = '%d';  // approved_by
        } elseif ($has_approved_by && array_key_exists('approved_by', $update_data)) {
            $format[] = '%s';  // NULL for approved_by
        }
        if ($has_approved_at && isset($update_data['approved_at'])) {
            $format[] = '%s';  // approved_at
        } elseif ($has_approved_at && array_key_exists('approved_at', $update_data)) {
            $format[] = '%s';  // NULL for approved_at
        }
        if ($has_rejected_by && isset($update_data['rejected_by'])) {
            $format[] = '%d';  // rejected_by
        } elseif ($has_rejected_by && array_key_exists('rejected_by', $update_data)) {
            $format[] = '%s';  // NULL for rejected_by
        }
        if ($has_rejected_at && isset($update_data['rejected_at'])) {
            $format[] = '%s';  // rejected_at
        } elseif ($has_rejected_at && array_key_exists('rejected_at', $update_data)) {
            $format[] = '%s';  // NULL for rejected_at
        }
        if ($has_updated_by) {
            $format[] = '%d';  // updated_by
        }

        // Update status with admin action tracking
        $wpdb->update(
            $exchange_table,
            $update_data,
            array('id' => $request_id),
            $format,
            array('%d')
        );

        $user_id = $request->user_id;

        // PROFESSIONAL FIX: Update transaction table status when exchange request is approved/rejected
        // This ensures Transaction Page shows the correct status
        $table = $this->table_name();
        $order_id = 'exchange:' . $request_id;
        $transaction = $wpdb->get_row($wpdb->prepare(
            "SELECT id, status FROM $table WHERE order_id = %s",
            $order_id
        ));
        
        if ($transaction) {
            $txn_status = $new_status === 'approved' ? 'approved' : ($new_status === 'rejected' ? 'rejected' : 'pending');
            $wpdb->update(
                $table,
                array(
                    'status' => $txn_status,
                    'updated_at' => current_time('mysql'),
                ),
                array('id' => $transaction->id),
                array('%s', '%s'),
                array('%d')
            );
        }

        // PROFESSIONAL FIX: Points are already deducted when request was created
        // When rejected: Points ARE refunded (fair to users - they should get their points back)
        // When approved: Points remain deducted (already deducted on creation, which is correct)
        if ($new_status === 'rejected') {
            // PROFESSIONAL FIX: Refund points when admin rejects exchange request
            // This is fair to users - if their request is rejected, they should get their points back
            if ($request->type === 'points' && !empty($request->points_value)) {
                // CRITICAL PROFESSIONAL FIX: Get request amount DIRECTLY from database
                // Don't trust the object - read from database as single source of truth
                $db_request = $wpdb->get_row($wpdb->prepare(
                    "SELECT points_value FROM $exchange_table WHERE id = %d",
                    $request_id
                ), ARRAY_A);
                
                if ($db_request && !empty($db_request['points_value'])) {
                    $request_points = (float) $db_request['points_value'];
                    error_log(sprintf(
                        'T-Work Rewards: Reject - Using request points from database. User ID: %d, Request ID: %d, Database Points: %s, Object Points: %s',
                        $user_id,
                        $request_id,
                        $request_points,
                        $request->points_value
                    ));
                } else {
                    // Fallback to object value if database read fails
                    $request_points = (float) $request->points_value;
                    error_log(sprintf(
                        'T-Work Rewards: WARNING - Could not read request from database, using object value. User ID: %d, Request ID: %d, Points: %s',
                        $user_id,
                        $request_id,
                        $request_points
                    ));
                }
                
                // Calculate actual deducted for logging and validation.
                // IMPORTANT: Only refund if we can confirm that points were actually deducted for this request.
                $actual_deducted = $this->calculate_actual_deducted_points($user_id, $request_id);

                // Default to no refund until we positively detect a deduction.
                $points_to_refund = 0.0;

                if ($actual_deducted !== false && $actual_deducted > 0) {
                    // Never refund more than the request amount even if transactions show a higher deduction.
                    $points_to_refund = min((float) $actual_deducted, (float) $request_points);

                    if (abs($actual_deducted - $request_points) > ($request_points * 0.05)) {
                        // Log warning if there's a significant discrepancy (for debugging)
                        error_log(sprintf(
                            'T-Work Rewards: WARNING - Calculated deducted amount (%s) differs from request amount (%s) by more than 5%%. Using min(deducted,request)=%s for refund. User ID: %d, Request ID: %d',
                            $actual_deducted,
                            $request_points,
                            $points_to_refund,
                            $user_id,
                            $request_id
                        ));
                    } else {
                        error_log(sprintf(
                            'T-Work Rewards: Refund calculation - Request Points: %s, Calculated Deducted: %s, Refunding: %s. User ID: %d, Request ID: %d',
                            $request_points,
                            $actual_deducted,
                            $points_to_refund,
                            $user_id,
                            $request_id
                        ));
                    }
                } else {
                    // No matching deduction transaction found â€“ do NOT refund to avoid free / double PNP.
                    error_log(sprintf(
                        'T-Work Rewards: No deducted points found for exchange reject. Skipping refund to prevent double PNP. User ID: %d, Request ID: %d, Request Points: %s',
                        $user_id,
                        $request_id,
                        $request_points
                    ));
                }

                // CRITICAL: Get balance before refund for verification
                $balance_before = get_user_meta($user_id, 'my_points', true);
                $balance_before = ($balance_before === '' || $balance_before === false || $balance_before === null)
                    ? 0.0
                    : (is_numeric($balance_before) ? (float) $balance_before : 0.0);

                // ABSOLUTE SAFETY: Final validation - ensure refund never exceeds request
                // This is a redundant check but critical for preventing any edge cases
                if ($points_to_refund > $request_points) {
                    error_log(sprintf(
                        'T-Work Rewards: CRITICAL SAFETY TRIGGERED - Refund amount (%s) exceeds request amount (%s). Capping at request amount. User ID: %d, Request ID: %d',
                        $points_to_refund,
                        $request_points,
                        $user_id,
                        $request_id
                    ));
                    $points_to_refund = $request_points;
                }

                if ($points_to_refund > 0) {
                    // Refund points (this method handles everything: balance updates, transaction creation, status update)
                    $refund_success = $this->refund_exchange_points(
                        $user_id,
                        $points_to_refund,
                        $request_id,
                        'Exchange request rejected via admin action'
                    );

                    // Note: refund_exchange_points already calls update_exchange_point_transaction_status internally

                    // CRITICAL: Verify refund was successful by checking balance
                    $balance_after = get_user_meta($user_id, 'my_points', true);
                    $balance_after = ($balance_after === '' || $balance_after === false || $balance_after === null)
                        ? 0.0
                        : (is_numeric($balance_after) ? (float) $balance_after : 0.0);

                    $expected_balance = $balance_before + $points_to_refund;
                    $refund_verified = ($refund_success && abs($balance_after - $expected_balance) < 0.01);  // Allow small floating point differences

                    if ($refund_success && $refund_verified) {
                        error_log(sprintf(
                            'T-Work Rewards: Exchange request rejected successfully. User %d refunded %s points (actual deducted: %s, request: %s). Balance: %s -> %s',
                            $user_id,
                            $points_to_refund,
                            $actual_deducted !== false ? $actual_deducted : 'N/A',
                            $request->points_value,
                            $balance_before,
                            $balance_after
                        ));
                    } else {
                        // CRITICAL ERROR: Refund failed or balance not updated correctly
                        error_log(sprintf(
                            'T-Work Rewards: CRITICAL ERROR - Exchange request rejected but refund failed or balance not updated correctly. User %d, Refund Amount: %s, Request Points: %s, Actual Deducted: %s, Balance Before: %s, Balance After: %s, Expected: %s, Refund Success: %s',
                            $user_id,
                            $points_to_refund,
                            $request->points_value,
                            $actual_deducted !== false ? $actual_deducted : 'N/A',
                            $balance_before,
                            $balance_after,
                            $expected_balance,
                            $refund_success ? 'true' : 'false'
                        ));

                        // Add error flag to redirect so admin knows there was an issue
                        wp_safe_redirect(add_query_arg(array(
                            'page' => 'twork-rewards-exchange-requests',
                            'updated' => 1,
                            'refund_error' => 1,
                            'request_id' => $request_id,
                        ), admin_url('admin.php')));
                        exit;
                    }
                } else {
                    // No safe refund amount determined â€“ status is still updated to rejected, but points stay unchanged.
                    error_log(sprintf(
                        'T-Work Rewards: Exchange request rejected with no refund applied because no prior deduction was detected. User %d, Request ID: %d, Request Points: %s',
                        $user_id,
                        $request_id,
                        $request->points_value
                    ));
                }
            }
        } elseif ($new_status === 'approved') {
            // PROFESSIONAL FIX: Handle different approval scenarios
            if ($request->type === 'points' && !empty($request->points_value)) {
                $points_to_deduct = (float) $request->points_value;

                // If request was previously rejected, points were refunded.
                // So we need to deduct them again when approving.
                if ('rejected' === $request->status) {
                    // Rejected -> Approved: Create new deduction transaction.
                    $this->create_exchange_point_transaction(
                        $user_id,
                        (int) $points_to_deduct,
                        $request_id,
                        ''
                    );

                    // Refresh cache from transactions.
                    $updated_balance = $this->refresh_user_points_cache($user_id);

                    error_log(
                        sprintf(
                            'T-Work Rewards: Exchange request approved (was rejected). User %d deducted %s points again. New balance: %d',
                            $user_id,
                            $request->points_value,
                            $updated_balance
                        )
                    );
                } else {
                    // Pending -> Approved: Points were already deducted on creation.
                    // Just update transaction status, no balance change needed.
                    $current_balance = $this->calculate_points_balance_from_transactions($user_id);
                    error_log(
                        sprintf(
                            'T-Work Rewards: Exchange request approved. User %d exchanged %s points. Current balance: %d (points already deducted on creation)',
                            $user_id,
                            $request->points_value,
                            $current_balance
                        )
                    );
                }
            }
        }

        wp_safe_redirect(add_query_arg(array(
            'page' => 'twork-rewards-exchange-requests',
            'updated' => 1,
        ), admin_url('admin.php')));
        exit;
    }

    /**
     * Handle bulk exchange actions (approve/reject multiple requests)
     */
    public function handle_bulk_exchange_action()
    {
        if (!current_user_can('manage_woocommerce') && !current_user_can('manage_options')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }

        check_admin_referer('twork_rewards_bulk_exchange_action', 'twork_rewards_bulk_exchange_nonce');

        $action = isset($_POST['bulk_action']) ? sanitize_text_field(wp_unslash($_POST['bulk_action'])) : '';
        $request_ids = isset($_POST['request_ids']) ? array_map('absint', (array) $_POST['request_ids']) : array();

        if (empty($action) || empty($request_ids) || !in_array($action, array('approve', 'reject'), true)) {
            wp_safe_redirect(add_query_arg(array(
                'page' => 'twork-rewards-exchange-requests',
                'error' => 1,
            ), admin_url('admin.php')));
            exit;
        }

        global $wpdb;
        $exchange_table = $this->exchange_requests_table_name();
        $processed = 0;
        $errors = 0;

        foreach ($request_ids as $request_id) {
            // Get the request
            $request = $wpdb->get_row($wpdb->prepare(
                "SELECT * FROM $exchange_table WHERE id = %d",
                $request_id
            ));

            if (!$request) {
                $errors++;
                continue;
            }

            // Skip if already in target state (unless rejecting rejected or approving approved)
            if ($action === 'approve' && $request->status === 'approved') {
                continue;
            }
            if ($action === 'reject' && $request->status === 'rejected') {
                continue;
            }

            // Process the action using existing handler logic
            $new_status = $action === 'approve' ? 'approved' : 'rejected';

            // PROFESSIONAL FIX: Get current admin user ID for action tracking
            $current_user_id = get_current_user_id();

            // Check which columns exist in the table
            $table_columns = $wpdb->get_col("DESCRIBE $exchange_table");
            $has_approved_by = in_array('approved_by', $table_columns);
            $has_approved_at = in_array('approved_at', $table_columns);
            $has_rejected_by = in_array('rejected_by', $table_columns);
            $has_rejected_at = in_array('rejected_at', $table_columns);
            $has_updated_by = in_array('updated_by', $table_columns);

            // Prepare update data with admin tracking
            $update_data = array(
                'status' => $new_status,
                'updated_at' => current_time('mysql'),
            );

            // Track who approved/rejected and when
            if ($new_status === 'approved') {
                if ($has_approved_by) {
                    $update_data['approved_by'] = $current_user_id;
                }
                if ($has_approved_at) {
                    $update_data['approved_at'] = current_time('mysql');
                }
                // Clear rejected fields when approving
                if ($has_rejected_by) {
                    $update_data['rejected_by'] = null;
                }
                if ($has_rejected_at) {
                    $update_data['rejected_at'] = null;
                }
            } else {
                if ($has_rejected_by) {
                    $update_data['rejected_by'] = $current_user_id;
                }
                if ($has_rejected_at) {
                    $update_data['rejected_at'] = current_time('mysql');
                }
                // Clear approved fields when rejecting
                if ($has_approved_by) {
                    $update_data['approved_by'] = null;
                }
                if ($has_approved_at) {
                    $update_data['approved_at'] = null;
                }
            }

            // Track who updated the exchange request
            if ($has_updated_by) {
                $update_data['updated_by'] = $current_user_id;
            }

            // Build format specifiers dynamically
            $format = array('%s', '%s');  // status and updated_at
            if ($has_approved_by && isset($update_data['approved_by'])) {
                $format[] = '%d';
            } elseif ($has_approved_by && array_key_exists('approved_by', $update_data)) {
                $format[] = '%s';  // NULL
            }
            if ($has_approved_at && isset($update_data['approved_at'])) {
                $format[] = '%s';
            } elseif ($has_approved_at && array_key_exists('approved_at', $update_data)) {
                $format[] = '%s';  // NULL
            }
            if ($has_rejected_by && isset($update_data['rejected_by'])) {
                $format[] = '%d';
            } elseif ($has_rejected_by && array_key_exists('rejected_by', $update_data)) {
                $format[] = '%s';  // NULL
            }
            if ($has_rejected_at && isset($update_data['rejected_at'])) {
                $format[] = '%s';
            } elseif ($has_rejected_at && array_key_exists('rejected_at', $update_data)) {
                $format[] = '%s';  // NULL
            }
            if ($has_updated_by) {
                $format[] = '%d';
            }

            // Update status with admin action tracking
            $wpdb->update(
                $exchange_table,
                $update_data,
                array('id' => $request_id),
                $format,
                array('%d')
            );

            $user_id = $request->user_id;

            // PROFESSIONAL FIX: Update transaction table status when exchange request is approved/rejected
            // This ensures Transaction Page shows the correct status
            $table = $this->table_name();
            $order_id = 'exchange:' . $request_id;
            $transaction = $wpdb->get_row($wpdb->prepare(
                "SELECT id, status FROM $table WHERE order_id = %s",
                $order_id
            ));
            
            if ($transaction) {
                $txn_status = $new_status === 'approved' ? 'approved' : ($new_status === 'rejected' ? 'rejected' : 'pending');
                $wpdb->update(
                    $table,
                    array(
                        'status' => $txn_status,
                        'updated_at' => current_time('mysql'),
                    ),
                    array('id' => $transaction->id),
                    array('%s', '%s'),
                    array('%d')
                );
            }

            // Handle points based on action
            if ($new_status === 'rejected') {
                // Refund points
                if ($request->type === 'points' && !empty($request->points_value)) {
                    // CRITICAL PROFESSIONAL FIX: Get request amount DIRECTLY from database
                    // Don't trust the object - read from database as single source of truth
                    $db_request = $wpdb->get_row($wpdb->prepare(
                        "SELECT points_value FROM $exchange_table WHERE id = %d",
                        $request_id
                    ), ARRAY_A);
                    
                    if ($db_request && !empty($db_request['points_value'])) {
                        $request_points = (float) $db_request['points_value'];
                        error_log(sprintf(
                            'T-Work Rewards: Bulk Reject - Using request points from database. User ID: %d, Request ID: %d, Database Points: %s, Object Points: %s',
                            $user_id,
                            $request_id,
                            $request_points,
                            $request->points_value
                        ));
                    } else {
                        // Fallback to object value if database read fails
                        $request_points = (float) $request->points_value;
                        error_log(sprintf(
                            'T-Work Rewards: WARNING - Bulk reject: Could not read request from database, using object value. User ID: %d, Request ID: %d, Points: %s',
                            $user_id,
                            $request_id,
                            $request_points
                        ));
                    }
                    
                    // Calculate actual deducted for logging and validation.
                    // IMPORTANT: Only refund if we can confirm that points were actually deducted for this request.
                    $actual_deducted = $this->calculate_actual_deducted_points($user_id, $request_id);
                    
                    // Default to no refund until we positively detect a deduction.
                    $points_to_refund = 0.0;
                    
                    if ($actual_deducted !== false && $actual_deducted > 0) {
                        // Refund at most the original requested amount.
                        $points_to_refund = min((float) $actual_deducted, (float) $request_points);
                        
                        if (abs($actual_deducted - $request_points) > ($request_points * 0.05)) {
                            error_log(sprintf(
                                'T-Work Rewards: WARNING - Bulk reject: Calculated deducted amount (%s) differs from request amount (%s) by more than 5%%. Using min(deducted,request)=%s for refund. User ID: %d, Request ID: %d',
                                $actual_deducted,
                                $request_points,
                                $points_to_refund,
                                $user_id,
                                $request_id
                            ));
                        }
                    } else {
                        // No matching deduction transaction found â€“ do NOT refund to avoid free / double PNP.
                        error_log(sprintf(
                            'T-Work Rewards: Bulk reject - No deducted points found for this request. Skipping refund to prevent double PNP. User ID: %d, Request ID: %d, Request Points: %s',
                            $user_id,
                            $request_id,
                            $request_points
                        ));
                    }

                    // ABSOLUTE SAFETY: Final validation - ensure refund never exceeds request
                    if ($points_to_refund > $request_points) {
                        error_log(sprintf(
                            'T-Work Rewards: CRITICAL SAFETY TRIGGERED - Bulk reject: Refund amount (%s) exceeds request amount (%s). Capping at request amount. User ID: %d, Request ID: %d',
                            $points_to_refund,
                            $request_points,
                            $user_id,
                            $request_id
                        ));
                        $points_to_refund = $request_points;
                    }

                    // CRITICAL: Get balance before refund for verification
                    $balance_before = get_user_meta($user_id, 'my_points', true);
                    $balance_before = ($balance_before === '' || $balance_before === false || $balance_before === null)
                        ? 0.0
                        : (is_numeric($balance_before) ? (float) $balance_before : 0.0);

                    if ($points_to_refund > 0) {
                        $refund_success = $this->refund_exchange_points(
                            $user_id,
                            $points_to_refund,
                            $request_id,
                            'Exchange request rejected via bulk action'
                        );

                        // CRITICAL: Verify refund was successful
                        $balance_after = get_user_meta($user_id, 'my_points', true);
                        $balance_after = ($balance_after === '' || $balance_after === false || $balance_after === null)
                            ? 0.0
                            : (is_numeric($balance_after) ? (float) $balance_after : 0.0);

                        $expected_balance = $balance_before + $points_to_refund;
                        $refund_verified = ($refund_success && abs($balance_after - $expected_balance) < 0.01);

                        if (!$refund_success || !$refund_verified) {
                            $errors++;
                            error_log(sprintf(
                                'T-Work Rewards: CRITICAL ERROR - Bulk reject: Exchange request #%d rejected but refund failed. User %d, Refund Amount: %s, Request Points: %s, Actual Deducted: %s, Balance Before: %s, Balance After: %s, Expected: %s',
                                $request_id,
                                $user_id,
                                $points_to_refund,
                                $request->points_value,
                                $actual_deducted !== false ? $actual_deducted : 'N/A',
                                $balance_before,
                                $balance_after,
                                $expected_balance
                            ));
                        }
                    } else {
                        // No safe refund amount determined â€“ status is still updated to rejected, but points stay unchanged.
                        error_log(sprintf(
                            'T-Work Rewards: Bulk reject - Exchange request #%d rejected with no refund applied because no prior deduction was detected. User %d, Request Points: %s',
                            $request_id,
                            $user_id,
                            $request->points_value
                        ));
                    }
                }
            } elseif ($new_status === 'approved') {
                // If was rejected, deduct points again
                if ($request->status === 'rejected' && $request->type === 'points' && !empty($request->points_value)) {
                    $points_to_deduct = (float) $request->points_value;
                    $this->create_exchange_point_transaction(
                        $user_id,
                        (int) $points_to_deduct,
                        $request_id,
                        ''
                    );
                    $this->refresh_user_points_cache($user_id);
                }
                // Update transaction status
                $this->update_exchange_point_transaction_status($user_id, $request_id, 'approved');
            }

            $processed++;
        }

        $redirect_args = array(
            'page' => 'twork-rewards-exchange-requests',
        );

        if ($processed > 0) {
            $redirect_args['bulk_' . $action . 'ed'] = $processed;
        }
        if ($errors > 0) {
            $redirect_args['bulk_errors'] = $errors;
        }

        wp_safe_redirect(add_query_arg($redirect_args, admin_url('admin.php')));
        exit;
    }

    /**
     * Handle CSV export for exchange requests
     */
    public function handle_exchange_export()
    {
        if (!current_user_can('manage_woocommerce') && !current_user_can('manage_options')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }

        // Get filter parameters (same as render page)
        $status = isset($_GET['status']) ? sanitize_text_field($_GET['status']) : '';
        $user_id = isset($_GET['user_id']) ? intval($_GET['user_id']) : 0;
        $type = isset($_GET['type']) ? sanitize_text_field($_GET['type']) : '';
        $phone_search = isset($_GET['phone']) ? sanitize_text_field($_GET['phone']) : '';
        $date_from = isset($_GET['date_from']) ? sanitize_text_field($_GET['date_from']) : '';
        $date_to = isset($_GET['date_to']) ? sanitize_text_field($_GET['date_to']) : '';
        $points_min = isset($_GET['points_min']) ? floatval($_GET['points_min']) : 0;
        $points_max = isset($_GET['points_max']) ? floatval($_GET['points_max']) : 0;

        global $wpdb;
        $exchange_table = $this->exchange_requests_table_name();

        // Build WHERE clause (same as render page)
        $where = array();
        $params = array();

        if ($status !== '') {
            $where[] = 'status = %s';
            $params[] = $status;
        }

        if ($user_id > 0) {
            $where[] = 'user_id = %d';
            $params[] = $user_id;
        }

        if ($type !== '') {
            $where[] = 'type = %s';
            $params[] = $type;
        }

        if ($phone_search !== '') {
            $where[] = 'phone LIKE %s';
            $params[] = '%' . $wpdb->esc_like($phone_search) . '%';
        }

        if ($date_from !== '') {
            $where[] = 'DATE(created_at) >= %s';
            $params[] = $date_from;
        }

        if ($date_to !== '') {
            $where[] = 'DATE(created_at) <= %s';
            $params[] = $date_to;
        }

        if ($points_min > 0) {
            $where[] = 'CAST(points_value AS DECIMAL(10,2)) >= %f';
            $params[] = $points_min;
        }

        if ($points_max > 0) {
            $where[] = 'CAST(points_value AS DECIMAL(10,2)) <= %f';
            $params[] = $points_max;
        }

        $where_sql = '';
        if (!empty($where)) {
            $where_sql = 'WHERE ' . implode(' AND ', $where);
        }

        // Get all matching rows (no pagination for export)
        $query_sql = "SELECT * FROM $exchange_table $where_sql ORDER BY created_at DESC";
        $rows = $wpdb->get_results($wpdb->prepare($query_sql, $params));

        // Set headers for CSV download
        $filename = 'exchange-requests-' . date('Y-m-d-H-i-s') . '.csv';
        header('Content-Type: text/csv; charset=utf-8');
        header('Content-Disposition: attachment; filename=' . $filename);
        header('Pragma: no-cache');
        header('Expires: 0');

        // Output BOM for UTF-8
        echo "\u{FEFF}";

        // Open output stream
        $output = fopen('php://output', 'w');

        // CSV headers
        fputcsv($output, array(
            __('ID', 'twork-rewards'),
            __('Date', 'twork-rewards'),
            __('User ID', 'twork-rewards'),
            __('User Name', 'twork-rewards'),
            __('User Email', 'twork-rewards'),
            __('Type', 'twork-rewards'),
            __('Points Value', 'twork-rewards'),
            __('Phone', 'twork-rewards'),
            __('Status', 'twork-rewards'),
            __('Note', 'twork-rewards'),
            __('Created At', 'twork-rewards'),
            __('Updated At', 'twork-rewards'),
        ));

        // Output data rows
        foreach ($rows as $req) {
            $user = get_user_by('ID', $req->user_id);
            $formatted_date = $this->format_myanmar_time($req->created_at);

            fputcsv($output, array(
                $req->id,
                $formatted_date ?: $req->created_at,
                $req->user_id,
                $user ? ($user->display_name ?: $user->user_login) : __('Unknown', 'twork-rewards'),
                $user ? $user->user_email : '',
                ucfirst($req->type ?: 'points'),
                $req->points_value ?: '0',
                $req->phone ?: '',
                ucfirst($req->status),
                $req->note ?: '',
                $req->created_at,
                $req->updated_at ?: '',
            ));
        }

        fclose($output);
        exit;
    }

    /**
     * Render exchange request edit page
     */
    public function render_exchange_edit_page()
    {
        if (!current_user_can('manage_woocommerce') && !current_user_can('manage_options')) {
            wp_die(__('You do not have permission to access this page.', 'twork-rewards'));
        }

        $request_id = isset($_GET['id']) ? absint($_GET['id']) : 0;
        if ($request_id <= 0) {
            wp_die(__('Invalid request ID.', 'twork-rewards'));
        }

        global $wpdb;
        $exchange_table = $this->exchange_requests_table_name();
        $request = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $exchange_table WHERE id = %d",
            $request_id
        ));

        if (!$request) {
            wp_die(__('Exchange request not found.', 'twork-rewards'));
        }

        // PROFESSIONAL: Approved/Rejected requests are VIEW ONLY - cannot be edited
        $is_view_only = in_array($request->status, array('approved', 'rejected'), true);
        $is_pending = ($request->status === 'pending');

        // PROFESSIONAL: Enhanced user lookup with fallback methods
        $user_id = absint($request->user_id);
        $user = $this->get_user_data_enhanced($user_id);

        // Get associated transaction
        $table = $this->table_name();
        $transaction = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $table WHERE order_id = %s",
            'exchange:' . $request_id
        ));

        if (isset($_GET['updated']) && intval($_GET['updated']) === 1) {
            ?>
            <div class="notice notice-success is-dismissible">
                <p><?php esc_html_e('Exchange request updated.', 'twork-rewards'); ?></p>
            </div>
            <?php
        }
        ?>
        <div class="wrap">
            <h1>
                <?php if ($is_view_only): ?>
                    <?php echo esc_html(sprintf(__('View Exchange Request #%d', 'twork-rewards'), $request_id)); ?>
                    <span class="status-<?php echo esc_attr($request->status); ?>" style="margin-left: 10px; padding: 4px 12px; border-radius: 3px; font-size: 14px;">
                        <?php echo esc_html(ucfirst($request->status)); ?>
                    </span>
                <?php else: ?>
                    <?php echo esc_html(sprintf(__('Edit Exchange Request #%d', 'twork-rewards'), $request_id)); ?>
                <?php endif; ?>
            </h1>
            <a class="button" href="<?php echo esc_url(admin_url('admin.php?page=twork-rewards-exchange-requests')); ?>">
                <?php esc_html_e('Back to Exchange Requests', 'twork-rewards'); ?>
            </a>
            <hr class="wp-header-end">

            <?php if ($is_view_only): ?>
                <div class="notice notice-info" style="margin: 20px 0;">
                    <p>
                        <strong><?php esc_html_e('View Only Mode', 'twork-rewards'); ?></strong><br>
                        <?php esc_html_e('This exchange request has been', 'twork-rewards'); ?> 
                        <strong><?php echo esc_html(ucfirst($request->status)); ?></strong>. 
                        <?php esc_html_e('It cannot be edited. This is a read-only view for reference purposes.', 'twork-rewards'); ?>
                    </p>
                </div>
            <?php endif; ?>

            <form method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>" <?php echo $is_view_only ? 'onsubmit="return false;"' : ''; ?>>
                <?php if (!$is_view_only): ?>
                    <?php wp_nonce_field('twork_rewards_save_exchange', 'twork_rewards_exchange_save_nonce'); ?>
                    <input type="hidden" name="action" value="twork_rewards_save_exchange" />
                    <input type="hidden" name="request_id" value="<?php echo esc_attr($request_id); ?>" />
                <?php endif; ?>

                <table class="form-table">
                    <tr>
                        <th scope="row"><?php esc_html_e('User', 'twork-rewards'); ?></th>
                        <td>
                            <?php if ($user && isset($user->ID)): ?>
                                <a href="<?php echo esc_url(admin_url('user-edit.php?user_id=' . $user->ID)); ?>" style="font-weight: 600;">
                                    <?php echo esc_html($user->display_name ?: ($user->user_login ?? __('User', 'twork-rewards'))); ?>
                                </a>
                                <div class="description">
                                    <?php echo esc_html(sprintf(__('User ID: %d', 'twork-rewards'), $user->ID)); ?>
                                    <?php if (isset($user->user_email) && !empty($user->user_email)): ?>
                                        | <?php echo esc_html($user->user_email); ?>
                                    <?php endif; ?>
                                    <?php if (isset($user->user_login) && !empty($user->user_login)): ?>
                                        | <?php echo esc_html(sprintf(__('Login: %s', 'twork-rewards'), $user->user_login)); ?>
                                    <?php endif; ?>
                                </div>
                            <?php else: ?>
                                <span style="color: #d63638; font-weight: 600;">
                                    <span class="dashicons dashicons-warning" style="vertical-align: middle; font-size: 16px;"></span>
                                    <?php esc_html_e('User Not Found', 'twork-rewards'); ?>
                                </span>
                                <div class="description" style="margin-top: 4px;">
                                    <?php echo esc_html(sprintf(__('User ID: %d (User may have been deleted from WordPress)', 'twork-rewards'), $request->user_id)); ?>
                                </div>
                            <?php endif; ?>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row"><?php esc_html_e('Type', 'twork-rewards'); ?></th>
                        <td>
                            <div style="padding: 8px 12px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 3px; display: inline-block;">
                                <span class="dashicons dashicons-star-filled" style="color: #f0ad4e; vertical-align: middle;"></span>
                                <?php echo esc_html(ucfirst($request->type ?: 'points')); ?>
                            </div>
                            <?php if (!$is_view_only): ?>
                                <input type="hidden" name="type" value="points" />
                                <p class="description" style="color: #666; margin-top: 8px;">
                                    <?php esc_html_e('Only Points exchange is supported.', 'twork-rewards'); ?>
                                </p>
                            <?php endif; ?>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="points_value"><?php esc_html_e('Points Value', 'twork-rewards'); ?></label>
                        </th>
                        <td>
                            <?php if ($is_view_only): ?>
                                <div style="padding: 8px 12px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 3px; display: inline-block; font-weight: 600; color: #f59e0b; font-size: 16px;">
                                    <?php echo esc_html(number_format(floatval($request->points_value ?: 0), 2)); ?> <?php esc_html_e('PNP', 'twork-rewards'); ?>
                                </div>
                            <?php else: ?>
                                <input type="text" class="regular-text" name="points_value" id="points_value"
                                       value="<?php echo esc_attr($request->points_value); ?>" />
                                <p class="description"><?php esc_html_e('Enter points value to exchange. You can edit this value even after approval - the user balance will be automatically adjusted.', 'twork-rewards'); ?></p>
                            <?php endif; ?>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="phone"><?php esc_html_e('Phone', 'twork-rewards'); ?></label>
                        </th>
                        <td>
                            <?php if ($is_view_only): ?>
                                <div style="padding: 8px 12px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 3px; display: inline-block;">
                                    <?php if (!empty($request->phone)): ?>
                                        <a href="tel:<?php echo esc_attr($request->phone); ?>" style="text-decoration: none;">
                                            <?php echo esc_html($request->phone); ?>
                                        </a>
                                    <?php else: ?>
                                        <span style="color: #999;">&mdash;</span>
                                    <?php endif; ?>
                                </div>
                            <?php else: ?>
                                <input type="text" class="regular-text" name="phone" id="phone"
                                       value="<?php echo esc_attr($request->phone); ?>" />
                            <?php endif; ?>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">
                            <label for="note"><?php esc_html_e('Note', 'twork-rewards'); ?></label>
                        </th>
                        <td>
                            <?php if ($is_view_only): ?>
                                <div style="padding: 12px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 3px; min-height: 60px;">
                                    <?php echo !empty($request->note) ? esc_html($request->note) : '<span style="color: #999;">' . esc_html__('No note', 'twork-rewards') . '</span>'; ?>
                                </div>
                            <?php else: ?>
                                <textarea name="note" id="note" rows="4" class="large-text"><?php echo esc_textarea($request->note); ?></textarea>
                            <?php endif; ?>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row"><?php esc_html_e('Status', 'twork-rewards'); ?></th>
                        <td>
                            <?php if ($is_view_only): ?>
                                <div style="padding: 8px 12px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 3px; display: inline-block;">
                                    <span class="status-<?php echo esc_attr($request->status); ?>" style="padding: 4px 8px; border-radius: 3px; font-size: 12px; font-weight: 600;">
                                        <?php echo esc_html(ucfirst($request->status)); ?>
                                    </span>
                                </div>
                                <p class="description" style="margin-top: 8px; color: #666;">
                                    <?php esc_html_e('This request has been finalized and cannot be modified.', 'twork-rewards'); ?>
                                </p>
                            <?php else: ?>
                                <select name="status" id="exchange_status">
                                    <option value="pending" <?php selected($request->status, 'pending'); ?>><?php esc_html_e('Pending', 'twork-rewards'); ?></option>
                                    <option value="approved" <?php selected($request->status, 'approved'); ?>><?php esc_html_e('Approved', 'twork-rewards'); ?></option>
                                    <option value="rejected" <?php selected($request->status, 'rejected'); ?>><?php esc_html_e('Rejected', 'twork-rewards'); ?></option>
                                </select>
                                <p class="description">
                                    <strong><?php esc_html_e('Important:', 'twork-rewards'); ?></strong><br>
                                    <?php esc_html_e('â€¢ Points are deducted immediately when exchange request is created', 'twork-rewards'); ?><br>
                                    <?php esc_html_e('â€¢ If you reject: Points WILL be automatically refunded to the user', 'twork-rewards'); ?><br>
                                    <?php esc_html_e('â€¢ If you approve with same amount: No refund needed (already deducted)', 'twork-rewards'); ?><br>
                                    <?php esc_html_e('â€¢ If you approve with less points: The difference will be automatically refunded', 'twork-rewards'); ?><br>
                                    <em><?php esc_html_e('Example: User requested 12 points, you approve 10 points â†’ 2 points will be refunded', 'twork-rewards'); ?></em>
                                </p>
                            <?php endif; ?>
                        </td>
                    </tr>
                    <?php if ($transaction): ?>
                    <tr>
                        <th scope="row"><?php esc_html_e('Transaction', 'twork-rewards'); ?></th>
                        <td>
                            <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-transaction-edit', 'id' => $transaction->id), admin_url('admin.php'))); ?>">
                                <?php echo esc_html(sprintf(__('View Transaction #%d', 'twork-rewards'), $transaction->id)); ?>
                            </a>
                        </td>
                    </tr>
                    <?php endif; ?>
                    <tr>
                        <th scope="row"><?php esc_html_e('Created At', 'twork-rewards'); ?></th>
                        <td>
                            <?php
                            // Professional: Display exchange request created date in Myanmar timezone
                            $formatted_date = $this->format_myanmar_time($request->created_at);
                            echo esc_html($formatted_date ?: $request->created_at);
                            ?>
                        </td>
                    </tr>
                    <?php if (!empty($request->updated_at)): ?>
                    <tr>
                        <th scope="row"><?php esc_html_e('Updated At', 'twork-rewards'); ?></th>
                        <td>
                            <?php
                            // Professional: Display exchange request updated date in Myanmar timezone
                            $formatted_date = $this->format_myanmar_time($request->updated_at);
                            echo esc_html($formatted_date ?: $request->updated_at);
                            ?>
                        </td>
                    </tr>
                    <?php endif; ?>
                    <?php if (!empty($request->approved_by)): ?>
                    <tr>
                        <th scope="row"><?php esc_html_e('Approved By', 'twork-rewards'); ?></th>
                        <td>
                            <?php
                            $approver = get_user_by('ID', $request->approved_by);
                            if ($approver) {
                                echo '<a href="' . esc_url(get_edit_user_link($approver->ID)) . '">';
                                echo esc_html($approver->display_name ?: $approver->user_login);
                                echo '</a>';
                                echo ' <span class="description">(' . esc_html(sprintf(__('User ID: %d', 'twork-rewards'), $approver->ID)) . ')</span>';
                            } else {
                                echo esc_html(sprintf(__('User ID: %d (User not found)', 'twork-rewards'), $request->approved_by));
                            }
                            ?>
                        </td>
                    </tr>
                    <?php endif; ?>
                    <?php if (!empty($request->approved_at)): ?>
                    <tr>
                        <th scope="row"><?php esc_html_e('Approved At', 'twork-rewards'); ?></th>
                        <td>
                            <?php
                            // Professional: Display approval date in Myanmar timezone
                            $formatted_date = $this->format_myanmar_time($request->approved_at);
                            echo esc_html($formatted_date ?: $request->approved_at);
                            ?>
                        </td>
                    </tr>
                    <?php endif; ?>
                    <?php if (!empty($request->rejected_by)): ?>
                    <tr>
                        <th scope="row"><?php esc_html_e('Rejected By', 'twork-rewards'); ?></th>
                        <td>
                            <?php
                            $rejector = get_user_by('ID', $request->rejected_by);
                            if ($rejector) {
                                echo '<a href="' . esc_url(get_edit_user_link($rejector->ID)) . '">';
                                echo esc_html($rejector->display_name ?: $rejector->user_login);
                                echo '</a>';
                                echo ' <span class="description">(' . esc_html(sprintf(__('User ID: %d', 'twork-rewards'), $rejector->ID)) . ')</span>';
                            } else {
                                echo esc_html(sprintf(__('User ID: %d (User not found)', 'twork-rewards'), $request->rejected_by));
                            }
                            ?>
                        </td>
                    </tr>
                    <?php endif; ?>
                    <?php if (!empty($request->rejected_at)): ?>
                    <tr>
                        <th scope="row"><?php esc_html_e('Rejected At', 'twork-rewards'); ?></th>
                        <td>
                            <?php
                            // Professional: Display rejection date in Myanmar timezone
                            $formatted_date = $this->format_myanmar_time($request->rejected_at);
                            echo esc_html($formatted_date ?: $request->rejected_at);
                            ?>
                        </td>
                    </tr>
                    <?php endif; ?>
                </table>

                <?php if ($is_view_only): ?>
                    <p class="description" style="padding: 15px; background: #fff3cd; border-left: 4px solid #f0ad4e; margin: 20px 0;">
                        <strong><?php esc_html_e('View Only:', 'twork-rewards'); ?></strong> 
                        <?php esc_html_e('This exchange request has been', 'twork-rewards'); ?> 
                        <strong><?php echo esc_html(ucfirst($request->status)); ?></strong>. 
                        <?php esc_html_e('Editing is disabled to maintain data integrity. If you need to make changes, please contact a system administrator.', 'twork-rewards'); ?>
                    </p>
                <?php else: ?>
                    <?php submit_button(__('Update Exchange Request', 'twork-rewards')); ?>
                <?php endif; ?>
            </form>
        </div>
        
        <style>
            .status-pending { 
                color: #f0ad4e; 
                font-weight: bold; 
                background: #fff3cd;
                padding: 4px 8px;
                border-radius: 3px;
                display: inline-block;
            }
            .status-approved { 
                color: #5cb85c; 
                font-weight: bold; 
                background: #d4edda;
                padding: 4px 8px;
                border-radius: 3px;
                display: inline-block;
            }
            .status-rejected { 
                color: #d9534f; 
                font-weight: bold; 
                background: #f8d7da;
                padding: 4px 8px;
                border-radius: 3px;
                display: inline-block;
            }
        </style>
        <?php
    }

    /**
     * Handle exchange request save
     */
    public function handle_exchange_save()
    {
        if (!current_user_can('manage_woocommerce') && !current_user_can('manage_options')) {
            wp_die(__('Insufficient permissions.', 'twork-rewards'));
        }

        check_admin_referer('twork_rewards_save_exchange', 'twork_rewards_exchange_save_nonce');

        $request_id = isset($_POST['request_id']) ? absint($_POST['request_id']) : 0;
        if ($request_id <= 0) {
            wp_die(__('Invalid request ID.', 'twork-rewards'));
        }

        global $wpdb;
        $exchange_table = $this->exchange_requests_table_name();

        // Get current request
        $current_request = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $exchange_table WHERE id = %d",
            $request_id
        ));

        if (!$current_request) {
            wp_die(__('Exchange request not found.', 'twork-rewards'));
        }

        // Only points exchange is supported
        $type = 'points';  // Always points
        $points_value = isset($_POST['points_value']) ? trim(sanitize_text_field($_POST['points_value'])) : '';
        $phone = isset($_POST['phone']) ? trim(sanitize_text_field($_POST['phone'])) : '';
        $note = isset($_POST['note']) ? trim(sanitize_textarea_field($_POST['note'])) : '';
        $status = isset($_POST['status']) ? sanitize_text_field($_POST['status']) : 'pending';

        if (!in_array($status, array('pending', 'approved', 'rejected'), true)) {
            $status = 'pending';
        }

        // PROFESSIONAL: Prevent editing of approved/rejected requests
        // Once approved or rejected, the request becomes view-only
        if (in_array($current_request->status, array('approved', 'rejected'), true)) {
            wp_die(
                __('This exchange request has been finalized and cannot be edited. It is in view-only mode.', 'twork-rewards'),
                __('Edit Not Allowed', 'twork-rewards'),
                array('back_link' => true)
            );
        }

        // Store old status to check if it changed
        $old_status = $current_request->status;

        // PROFESSIONAL FIX: Allow status transitions between approved and rejected
        // This enables admins to reverse decisions if needed
        // Only prevent invalid transitions (e.g., approved/rejected -> something other than pending/approved/rejected)
        $final_status = $status;
        $valid_statuses = array('pending', 'approved', 'rejected');
        if (!in_array($status, $valid_statuses, true)) {
            // Invalid status, keep original
            $final_status = $old_status;
        } else {
            // Valid status transition - allow it
            // This enables:
            // - pending -> approved/rejected (normal flow)
            // - approved -> rejected (reversing approval, will refund points)
            // - rejected -> approved (reversing rejection, will deduct points)
            // - approved/rejected -> pending (reset to pending)
            $final_status = $status;
        }

        // Store old values before update for comparison
        $old_points_value = $current_request->points_value;
        $old_type = $current_request->type;
        $user_id = $current_request->user_id;

        // PROFESSIONAL FIX: Get current admin user ID for action tracking
        $current_user_id = get_current_user_id();

        // Check which columns exist in the table
        $table_columns = $wpdb->get_col("DESCRIBE $exchange_table");
        $has_approved_by = in_array('approved_by', $table_columns);
        $has_approved_at = in_array('approved_at', $table_columns);
        $has_rejected_by = in_array('rejected_by', $table_columns);
        $has_rejected_at = in_array('rejected_at', $table_columns);
        $has_updated_by = in_array('updated_by', $table_columns);

        // Update exchange request
        $update_data = array(
            'type' => 'points',  // Force to points only
            'points_value' => $points_value,
            'phone' => $phone,
            'note' => $note,
            'status' => $final_status,
            'updated_at' => current_time('mysql'),
        );

        // PROFESSIONAL FIX: Track admin actions with timestamps when status changes
        // Only update approved_by/rejected_by if status actually changed
        if ($old_status !== $final_status) {
            if ($final_status === 'approved') {
                if ($has_approved_by) {
                    $update_data['approved_by'] = $current_user_id;
                }
                if ($has_approved_at) {
                    $update_data['approved_at'] = current_time('mysql');
                }
                // Clear rejected fields when approving
                if ($has_rejected_by) {
                    $update_data['rejected_by'] = null;
                }
                if ($has_rejected_at) {
                    $update_data['rejected_at'] = null;
                }
            } elseif ($final_status === 'rejected') {
                if ($has_rejected_by) {
                    $update_data['rejected_by'] = $current_user_id;
                }
                if ($has_rejected_at) {
                    $update_data['rejected_at'] = current_time('mysql');
                }
                // Clear approved fields when rejecting
                if ($has_approved_by) {
                    $update_data['approved_by'] = null;
                }
                if ($has_approved_at) {
                    $update_data['approved_at'] = null;
                }
            } elseif ($final_status === 'pending') {
                // When resetting to pending, clear both approved and rejected fields
                if ($has_approved_by) {
                    $update_data['approved_by'] = null;
                }
                if ($has_approved_at) {
                    $update_data['approved_at'] = null;
                }
                if ($has_rejected_by) {
                    $update_data['rejected_by'] = null;
                }
                if ($has_rejected_at) {
                    $update_data['rejected_at'] = null;
                }
            }
        }

        // Track who updated the exchange request
        if ($has_updated_by) {
            $update_data['updated_by'] = $current_user_id;
        }

        // Build format specifiers dynamically
        $format = array('%s', '%s', '%s', '%s', '%s', '%s');  // type, points_value, phone, note, status, updated_at
        if ($has_approved_by && isset($update_data['approved_by'])) {
            $format[] = '%d';  // approved_by
        } elseif ($has_approved_by && array_key_exists('approved_by', $update_data)) {
            $format[] = '%s';  // NULL for approved_by
        }
        if ($has_approved_at && isset($update_data['approved_at'])) {
            $format[] = '%s';  // approved_at
        } elseif ($has_approved_at && array_key_exists('approved_at', $update_data)) {
            $format[] = '%s';  // NULL for approved_at
        }
        if ($has_rejected_by && isset($update_data['rejected_by'])) {
            $format[] = '%d';  // rejected_by
        } elseif ($has_rejected_by && array_key_exists('rejected_by', $update_data)) {
            $format[] = '%s';  // NULL for rejected_by
        }
        if ($has_rejected_at && isset($update_data['rejected_at'])) {
            $format[] = '%s';  // rejected_at
        } elseif ($has_rejected_at && array_key_exists('rejected_at', $update_data)) {
            $format[] = '%s';  // NULL for rejected_at
        }
        if ($has_updated_by) {
            $format[] = '%d';  // updated_by
        }

        $updated = $wpdb->update(
            $exchange_table,
            $update_data,
            array('id' => $request_id),
            $format,
            array('%d')
        );

        if ($updated === false) {
            $error_msg = $wpdb->last_error ? $wpdb->last_error : __('Unknown database error occurred.', 'twork-rewards');
            error_log('T-Work Rewards: Failed to update exchange request. Error: ' . $error_msg);
            error_log('T-Work Rewards: Update data - ' . print_r($update_data, true));
            wp_die(sprintf(__('Failed to update exchange request. Error: %s. Please check the error logs for more details.', 'twork-rewards'), esc_html($error_msg)));
        }

        // CRITICAL: Update point balance whenever point value is changed
        // This ensures point balance is always updated regardless of status
        if ($type === 'points' && !empty($points_value) && is_numeric($points_value)) {
            // Check if point value actually changed
            $points_value_changed = ($old_points_value !== $points_value);

            if ($points_value_changed) {
                // Get current point balance
                $existing_points = get_user_meta($user_id, 'my_points', true);
                if (empty($existing_points) || !is_numeric($existing_points)) {
                    $existing_points = 0.0;
                } else {
                    $existing_points = is_numeric($existing_points) ? (float) $existing_points : 0.0;
                }

                // Calculate difference
                $old_points = !empty($old_points_value) && is_numeric($old_points_value) ? (float) $old_points_value : 0.0;
                $new_points = (float) $points_value;
                $difference = $new_points - $old_points;

                // Adjust balance based on difference
                // If new value is less than old, refund the difference
                // If new value is more than old, deduct the additional amount
                $new_total = (float) $existing_points - $difference;
                if ($new_total < 0) {
                    error_log(sprintf(
                        'T-Work Rewards: Warning - Points adjustment would result in negative balance. User ID: %d, Existing: %s, Difference: %s, Setting to 0',
                        $user_id,
                        $existing_points,
                        $difference
                    ));
                    $new_total = 0.0;
                }

                $stored = (floor($new_total) == $new_total)
                    ? (string) (int) $new_total
                    : (string) $new_total;

                // PROFESSIONAL FIX: Update both my_points and points_balance
                update_user_meta($user_id, 'my_points', $stored);
                update_user_meta($user_id, 'my_points_updated_at', time());
                update_user_meta($user_id, 'my_point', $stored);

                // Also update points_balance
                $current_balance = (int) get_user_meta($user_id, 'points_balance', true);
                if ($current_balance === false || $current_balance === '') {
                    $current_balance = 0;
                }
                $new_balance = max(0, $current_balance - (int) $difference);
                update_user_meta($user_id, 'points_balance', $new_balance);

                error_log(sprintf(
                    'T-Work Rewards: Updated point balance after exchange request point value change. User ID: %d, Old Value: %s, New Value: %s, Difference: %s, Old Balance: %s, New Balance: %s, New points_balance: %d',
                    $user_id,
                    $old_points_value,
                    $points_value,
                    $difference,
                    $existing_points,
                    $stored,
                    $new_balance
                ));
            }
        }

        // Update or create associated transaction
        $table = $this->table_name();
        $transaction = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $table WHERE order_id = %s",
            'exchange:' . $request_id
        ));

        // If transaction doesn't exist, create it
        if (!$transaction) {
            // Determine values for transaction (only points supported)
            $txn_points_value = !empty($points_value) ? $points_value : null;

            $txn_status = $final_status === 'approved' ? 'approved' : ($final_status === 'rejected' ? 'rejected' : 'pending');

            $txn_inserted = $wpdb->insert(
                $table,
                array(
                    'user_id' => $current_request->user_id,
                    'order_id' => 'exchange:' . $request_id,
                    'status' => $txn_status,
                    'points_value' => $txn_points_value,
                    'created_at' => current_time('mysql'),
                    'updated_at' => current_time('mysql'),
                ),
                array('%d', '%s', '%s', '%s', '%s', '%s')
            );

            if ($txn_inserted !== false) {
                $transaction = $wpdb->get_row($wpdb->prepare(
                    "SELECT * FROM $table WHERE order_id = %s",
                    'exchange:' . $request_id
                ));
            }
        }

        if ($transaction) {
            // Determine values for transaction (only points supported)
            $txn_points_value = !empty($points_value) ? $points_value : null;

            $txn_status = $final_status === 'approved' ? 'approved' : ($final_status === 'rejected' ? 'rejected' : 'pending');

            $wpdb->update(
                $table,
                array(
                    'status' => $txn_status,
                    'points_value' => $txn_points_value,
                    'updated_at' => current_time('mysql'),
                ),
                array('id' => $transaction->id),
                array('%s', '%s', '%s'),
                array('%d')
            );

            // Handle value changes for already-approved requests
            // If request was already approved and values changed, adjust user balance
            if ($old_status === 'approved' && $final_status === 'approved') {
                // Store old values for comparison
                $old_points_value = $current_request->points_value;
                $old_type = $current_request->type;

                // Special handling for points: If approved amount is reduced, refund the difference
                // This handles the case where admin edits an already-approved request and reduces the amount
                if ($type === 'points' &&
                        !empty($points_value) &&
                        is_numeric($points_value) &&
                        !empty($old_points_value) &&
                        is_numeric($old_points_value)) {
                    $old_approved = (float) $old_points_value;
                    $new_approved = (float) $points_value;

                    // If new approved amount is less than old approved amount, refund the difference
                    if ($new_approved < $old_approved) {
                        $refund_amount = $old_approved - $new_approved;

                        $existing_points = get_user_meta($user_id, 'my_points', true);
                        if (empty($existing_points) || !is_numeric($existing_points)) {
                            $existing_points = 0;
                        }

                        // Refund the difference
                        $new_total = (float) $existing_points + $refund_amount;
                        $stored = (floor($new_total) == $new_total)
                            ? (string) (int) $new_total
                            : (string) $new_total;

                        update_user_meta($user_id, 'my_points', $stored);
                        update_user_meta($user_id, 'my_points_updated_at', time());
                        update_user_meta($user_id, 'my_point', $stored);

                        error_log(sprintf(
                            'T-Work Rewards: Exchange request approved amount reduced. User %d, Old Approved: %s, New Approved: %s, Refunded: %s, New balance: %s',
                            $user_id,
                            $old_approved,
                            $new_approved,
                            $refund_amount,
                            $stored
                        ));

                        // Mark that we've already handled this, so skip the normal adjustment logic below
                        // Continue to next section
                    } else if ($new_approved > $old_approved) {
                        // New approved amount is greater - deduct the additional amount
                        $additional_amount = $new_approved - $old_approved;

                        $existing_points = get_user_meta($user_id, 'my_points', true);
                        if (empty($existing_points) || !is_numeric($existing_points)) {
                            $existing_points = 0;
                        }

                        // PROFESSIONAL FIX: Deduct additional amount from both my_points and points_balance
                        $new_total = (float) $existing_points - $additional_amount;
                        if ($new_total < 0) {
                            $new_total = 0.0;
                        }
                        $stored = (floor($new_total) == $new_total)
                            ? (string) (int) $new_total
                            : (string) $new_total;

                        update_user_meta($user_id, 'my_points', $stored);
                        update_user_meta($user_id, 'my_points_updated_at', time());
                        update_user_meta($user_id, 'my_point', $stored);

                        // Also update points_balance
                        $current_balance = (int) get_user_meta($user_id, 'points_balance', true);
                        if ($current_balance === false || $current_balance === '') {
                            $current_balance = 0;
                        }
                        $new_balance = max(0, $current_balance - (int) $additional_amount);
                        update_user_meta($user_id, 'points_balance', $new_balance);

                        error_log(sprintf(
                            'T-Work Rewards: Exchange request approved amount increased. User %d, Old Approved: %s, New Approved: %s, Additional Deducted: %s, New balance: %s',
                            $user_id,
                            $old_approved,
                            $new_approved,
                            $additional_amount,
                            $stored
                        ));
                    }
                }

                // Check if points value changed
                $points_value_changed = ($old_points_value !== $points_value);
                $type_changed = ($old_type !== $type);

                // Determine if we need to adjust balances
                // We need to adjust if:
                // 1. Type changed (points only now)
                // 2. Points value changed (and old or new type is points)
                $needs_adjustment = $type_changed ||
                    ($points_value_changed && ($old_type === 'points' || $type === 'points'));

                // If values changed, revert old deduction and apply new deduction
                if ($needs_adjustment) {
                    // Validate new values before processing
                    if ($type === 'points' && !empty($points_value) && !is_numeric($points_value)) {
                        error_log(sprintf(
                            'T-Work Rewards: Invalid points value for exchange edit. Request ID: %d, Value: %s',
                            $request_id,
                            $points_value
                        ));
                        // Continue with old value if new value is invalid
                        $points_value = $old_points_value;
                    }

                    // Skip points adjustment if we already handled it above (for approved->approved with amount change)
                    $points_already_handled = ($type === 'points' &&
                        !empty($points_value) &&
                        is_numeric($points_value) &&
                        !empty($old_points_value) &&
                        is_numeric($old_points_value));

                    if ($old_type === 'points' && !empty($old_points_value) && is_numeric($old_points_value) && !$points_already_handled) {
                        $existing_points = get_user_meta($user_id, 'my_points', true);
                        if ($existing_points === '' || $existing_points === false || $existing_points === null) {
                            $existing_points = 0.0;
                        } else {
                            $existing_points = is_numeric($existing_points) ? (float) $existing_points : 0.0;
                        }

                        // PROFESSIONAL FIX: Add back the old deducted value to both my_points and points_balance
                        $reverted_total = (float) $existing_points + (float) $old_points_value;
                        $stored = (floor($reverted_total) == $reverted_total)
                            ? (string) (int) $reverted_total
                            : (string) $reverted_total;
                        update_user_meta($user_id, 'my_points', $stored);
                        update_user_meta($user_id, 'my_point', $stored);

                        // Also update points_balance
                        $current_balance = (int) get_user_meta($user_id, 'points_balance', true);
                        if ($current_balance === false || $current_balance === '') {
                            $current_balance = 0;
                        }
                        $new_balance = $current_balance + (int) $old_points_value;
                        update_user_meta($user_id, 'points_balance', $new_balance);
                        error_log(sprintf(
                            'T-Work Rewards: Reverted old points deduction for exchange edit. User ID: %d, Added back: %s, New Total: %s',
                            $user_id,
                            $old_points_value,
                            $stored
                        ));
                    }

                    // Skip points adjustment if we already handled it above (for approved->approved with amount change)
                    if ($type === 'points' && !empty($points_value) && is_numeric($points_value) && !$points_already_handled) {
                        $existing_points = get_user_meta($user_id, 'my_points', true);
                        if ($existing_points === '' || $existing_points === false || $existing_points === null) {
                            $existing_points = 0.0;
                        } else {
                            $existing_points = is_numeric($existing_points) ? (float) $existing_points : 0.0;
                        }

                        $new_total = (float) $existing_points - (float) $points_value;
                        if ($new_total < 0) {
                            error_log(sprintf(
                                'T-Work Rewards: Warning - Points deduction would result in negative balance. User ID: %d, Existing: %s, Deducted: %s, Setting to 0',
                                $user_id,
                                $existing_points,
                                $points_value
                            ));
                            $new_total = 0.0;
                        }
                        $stored = (floor($new_total) == $new_total)
                            ? (string) (int) $new_total
                            : (string) $new_total;
                        update_user_meta($user_id, 'my_points', $stored);
                        update_user_meta($user_id, 'my_points_updated_at', time());
                        update_user_meta($user_id, 'my_point', $stored);
                        error_log(sprintf(
                            'T-Work Rewards: Applied new points deduction for exchange edit. User ID: %d, Deducted: %s, New Total: %s',
                            $user_id,
                            $points_value,
                            $stored
                        ));
                    }
                }
            }
        }

        // PROFESSIONAL FIX: Points are deducted immediately when exchange request is created
        // So we need to handle status changes differently:
        // - pending -> approved: Don't deduct again (already deducted)
        // - pending -> rejected: Points ARE refunded (fair to users)
        // - approved -> rejected: Points ARE refunded (fair to users)

        // Handle status change to rejected (points ARE refunded)
        if ($final_status === 'rejected' && $old_status !== 'rejected') {
            // PROFESSIONAL FIX: Refund points when admin rejects exchange request
            // This is fair to users - if their request is rejected, they should get their points back
            $points_for_notification = 0;

            if ($type === 'points') {
                // CRITICAL FIX: Calculate ACTUAL deducted amount from transactions, not from request.
                // Only refund when we can prove a deduction actually happened for this request.
                $actual_deducted = $this->calculate_actual_deducted_points($user_id, $request_id);

                $points_to_refund = 0.0;
                $original_points_value = !empty($old_points_value) && is_numeric($old_points_value) ? (float) $old_points_value : 0.0;

                if ($actual_deducted !== false && $actual_deducted > 0) {
                    // Refund at most the original requested amount.
                    $points_to_refund = $actual_deducted;
                    if ($original_points_value > 0 && $points_to_refund > $original_points_value) {
                        error_log(sprintf(
                            'T-Work Rewards: CRITICAL SAFETY TRIGGERED - Admin edit reject: Refund amount (%s) exceeds original amount (%s). Using original amount to prevent double refund. User ID: %d, Request ID: %d, Actual Deducted: %s',
                            $points_to_refund,
                            $original_points_value,
                            $user_id,
                            $request_id,
                            $actual_deducted
                        ));
                        $points_to_refund = $original_points_value;
                    }

                    // Final double-check
                    if ($original_points_value > 0 && $points_to_refund > $original_points_value) {
                        $points_to_refund = $original_points_value;
                    }

                    $points_for_notification = (int) $points_to_refund;

                    if ($points_to_refund > 0) {
                        // PROFESSIONAL FIX: Refund points (updates both my_points and points_balance)
                        // Note: refund_exchange_points() handles:
                        // - Refunding to my_points and points_balance
                        // - Creating refund transaction in points system
                        // - Updating original redeem transaction status to rejected
                        $refund_success = $this->refund_exchange_points(
                            $user_id,
                            $points_to_refund,
                            $request_id,
                            'Exchange request rejected via admin edit'
                        );

                        $current_points = get_user_meta($user_id, 'my_points', true);
                        $current_balance = get_user_meta($user_id, 'points_balance', true);
                        if ($refund_success) {
                            error_log(sprintf(
                                'T-Work Rewards: Exchange request rejected via admin edit. User %d refunded %s points (actual deducted: %s, original: %s). New my_points: %s, New points_balance: %s',
                                $user_id,
                                $points_to_refund,
                                $actual_deducted,
                                $original_points_value,
                                $current_points ?: '0',
                                $current_balance ?: '0'
                            ));
                        } else {
                            error_log(sprintf(
                                'T-Work Rewards: Exchange request rejected via admin edit but refund failed. User %d, Refund Amount: %s, Original Points: %s, Actual Deducted: %s, Current my_points: %s, Current points_balance: %s',
                                $user_id,
                                $points_to_refund,
                                $original_points_value,
                                $actual_deducted,
                                $current_points ?: '0',
                                $current_balance ?: '0'
                            ));
                        }
                    }
                } else {
                    // No matching deduction transaction found â€“ do NOT refund to avoid free/double PNP.
                    error_log(sprintf(
                        'T-Work Rewards: Admin edit reject - No deducted points found, skipping refund to prevent double PNP. User ID: %d, Request ID: %d, Original Points: %s',
                        $user_id,
                        $request_id,
                        $original_points_value
                    ));
                }
            }

            // PROFESSIONAL FCM NOTIFICATION: Send notification for exchange rejected.
            // If $points_for_notification is 0, the mobile app text will show "balance unchanged".
            $this->send_points_fcm_notification(
                $user_id,
                'exchange_rejected',
                array(
                    'request_id'  => $request_id,
                    'points'      => $points_for_notification,
                    'points_value'=> $points_for_notification,
                    'reason'      => $note ?: 'Exchange request rejected',
                    'description' => $note ?: ($points_for_notification > 0
                        ? 'Your exchange request has been rejected. Points have been refunded.'
                        : 'Your exchange request has been rejected. Your PNP balance remains unchanged.'),
                )
            );
        }

        // PROFESSIONAL FIX: Update points system transaction status when status changes
        // This ensures transaction history reflects the correct status
        if ($type === 'points' && !empty($points_value)) {
            $this->update_exchange_point_transaction_status($user_id, $request_id, $final_status);
        }

        // Handle status change to approved
        // PROFESSIONAL FIX: Handle different approval scenarios
        // - pending -> approved: Points already deducted on creation, may need to refund difference if approved amount < requested
        // - rejected -> approved: Points were refunded when rejected, need to deduct again
        if ($old_status !== 'approved' && $final_status === 'approved') {
            // PROFESSIONAL FCM NOTIFICATION: Send notification for exchange approved
            $this->send_points_fcm_notification(
                $user_id,
                'exchange_approved',
                array(
                    'request_id' => $request_id,
                    'points' => !empty($points_value) && is_numeric($points_value) ? (int) $points_value : 0,
                    'points_value' => $points_value,
                    'description' => 'Your exchange request has been approved',
                )
            );

            if ($type === 'points' && !empty($points_value) && is_numeric($points_value)) {
                $approved_amount = (float) $points_value;  // What admin approved (may be edited)

                // PROFESSIONAL FIX: Handle rejected -> approved transition
                // If request was rejected, points were refunded, so we need to deduct again
                if ($old_status === 'rejected') {
                    // Rejected -> Approved: Deduct points again (they were refunded when rejected)
                    $existing_points_raw = get_user_meta($user_id, 'my_points', true);
                    $existing_points = ($existing_points_raw === '' || $existing_points_raw === false || $existing_points_raw === null)
                        ? 0.0
                        : (is_numeric($existing_points_raw) ? (float) $existing_points_raw : 0.0);

                    $new_my_points = max(0.0, $existing_points - $approved_amount);
                    $stored_my_points = (floor($new_my_points) == $new_my_points)
                        ? (string) (int) $new_my_points
                        : (string) $new_my_points;

                    update_user_meta($user_id, 'my_points', $stored_my_points);
                    update_user_meta($user_id, 'my_point', $stored_my_points);
                    update_user_meta($user_id, 'my_points_updated_at', time());

                    // Also update points_balance
                    $current_balance = (int) get_user_meta($user_id, 'points_balance', true);
                    if ($current_balance === false || $current_balance === '') {
                        $current_balance = 0;
                    }
                    $new_balance = max(0, $current_balance - (int) $approved_amount);
                    update_user_meta($user_id, 'points_balance', $new_balance);

                    error_log(sprintf(
                        'T-Work Rewards: Exchange request approved via admin edit (was rejected). User %d deducted %s points again. New my_points: %s, New points_balance: %d',
                        $user_id,
                        $approved_amount,
                        $stored_my_points,
                        $new_balance
                    ));
                } else {
                    // Pending -> Approved: Points already deducted on creation
                    // Get original requested amount (what user originally requested)
                    $original_requested = !empty($old_points_value) && is_numeric($old_points_value) ? (float) $old_points_value : 0;
                    $requested_amount = $original_requested;  // What user originally requested

                    // If approved amount is less than requested amount, refund the difference
                    // Example: User requested 12, admin approves 10 â†’ Refund 2 points
                    if ($approved_amount < $requested_amount) {
                        $refund_amount = $requested_amount - $approved_amount;

                        $existing_points = get_user_meta($user_id, 'my_points', true);
                        if (empty($existing_points) || !is_numeric($existing_points)) {
                            $existing_points = 0;
                        }

                        // PROFESSIONAL FIX: Refund the difference to both my_points and points_balance
                        $new_total = (float) $existing_points + $refund_amount;
                        $stored = (floor($new_total) == $new_total)
                            ? (string) (int) $new_total
                            : (string) $new_total;

                        update_user_meta($user_id, 'my_points', $stored);
                        update_user_meta($user_id, 'my_points_updated_at', time());
                        update_user_meta($user_id, 'my_point', $stored);

                        // Also update points_balance
                        $current_balance = (int) get_user_meta($user_id, 'points_balance', true);
                        if ($current_balance === false || $current_balance === '') {
                            $current_balance = 0;
                        }
                        $new_balance = $current_balance + (int) $refund_amount;
                        update_user_meta($user_id, 'points_balance', $new_balance);

                        error_log(sprintf(
                            'T-Work Rewards: Exchange request approved with reduced amount. User %d, Requested: %s, Approved: %s, Refunded: %s, New balance: %s',
                            $user_id,
                            $requested_amount,
                            $approved_amount,
                            $refund_amount,
                            $stored
                        ));
                    } else if ($approved_amount == $requested_amount) {
                        // Approved amount equals requested amount - no refund needed
                        // Points were already deducted on creation, so nothing to do
                        $current_points = get_user_meta($user_id, 'my_points', true);
                        error_log(sprintf(
                            'T-Work Rewards: Exchange request approved with full amount. User %d, Requested: %s, Approved: %s, Current balance: %s (points already deducted on creation, no refund needed)',
                            $user_id,
                            $requested_amount,
                            $approved_amount,
                            $current_points ?: '0'
                        ));
                    } else {
                        // Approved amount exceeds requested (shouldn't normally happen, but handle gracefully)
                        // This would mean admin increased the amount, which would require additional deduction
                        // But since we're in approval flow, we'll just log it
                        $current_points = get_user_meta($user_id, 'my_points', true);
                        error_log(sprintf(
                            'T-Work Rewards: Exchange request approved with increased amount. User %d, Requested: %s, Approved: %s, Current balance: %s (Note: Additional deduction may be needed)',
                            $user_id,
                            $requested_amount,
                            $approved_amount,
                            $current_points ?: '0'
                        ));
                    }
                }
            }
        }

        wp_safe_redirect(add_query_arg(array(
            'page' => 'twork-rewards-exchange-edit',
            'id' => $request_id,
            'updated' => 1,
        ), admin_url('admin.php')));
        exit;
    }

    /**
     * Render Usage Analytics admin page
     * Displays app usage statistics for all users
     */
    public function render_usage_analytics_page()
    {
        if (!current_user_can('manage_woocommerce') && !current_user_can('manage_options')) {
            wp_die(__('You do not have permission to access this page.', 'twork-rewards'));
        }

        // Handle CSV export
        if (isset($_GET['export']) && $_GET['export'] === 'csv') {
            $this->export_analytics_csv();
            return;
        }

        global $wpdb;
        $usage_table = $this->usage_tracking_table_name();

        // Check if table exists
        $table_exists = $wpdb->get_var("SHOW TABLES LIKE '$usage_table'") === $usage_table;

        // Handle manual table creation
        if (isset($_GET['create_table']) && $_GET['create_table'] === '1') {
            $this->create_usage_tracking_table();
            $table_exists = $wpdb->get_var("SHOW TABLES LIKE '$usage_table'") === $usage_table;
            if ($table_exists) {
                echo '<div class="notice notice-success is-dismissible"><p>' . esc_html__('Usage tracking table created successfully!', 'twork-rewards') . '</p></div>';
            } else {
                echo '<div class="notice notice-error is-dismissible"><p>' . esc_html__('Failed to create usage tracking table. Please check database permissions.', 'twork-rewards') . '</p></div>';
            }
        }

        // Get filter parameters
        $user_id_filter = isset($_GET['user_id']) ? absint($_GET['user_id']) : 0;
        $date_from = isset($_GET['date_from']) ? sanitize_text_field($_GET['date_from']) : date('Y-m-d', strtotime('-30 days'));
        $date_to = isset($_GET['date_to']) ? sanitize_text_field($_GET['date_to']) : date('Y-m-d');

        // Get overall statistics
        $overall_stats = null;
        if ($table_exists) {
            $where_clauses = array('session_end IS NOT NULL');
            $where_values = array();

            if ($user_id_filter > 0) {
                $where_clauses[] = 'user_id = %d';
                $where_values[] = $user_id_filter;
            }

            if ($date_from) {
                $where_clauses[] = 'DATE(session_start) >= %s';
                $where_values[] = $date_from;
            }

            if ($date_to) {
                $where_clauses[] = 'DATE(session_start) <= %s';
                $where_values[] = $date_to;
            }

            $where_sql = implode(' AND ', $where_clauses);

            if (!empty($where_values)) {
                $overall_stats = $wpdb->get_row($wpdb->prepare(
                    "SELECT 
                        COUNT(DISTINCT user_id) as total_users,
                        COUNT(*) as total_sessions,
                        SUM(duration_seconds) as total_duration_seconds,
                        AVG(duration_seconds) as avg_duration_seconds,
                        MIN(session_start) as first_session,
                        MAX(session_start) as last_session
                    FROM $usage_table
                    WHERE $where_sql",
                    ...$where_values
                ));
            } else {
                $overall_stats = $wpdb->get_row(
                    "SELECT 
                        COUNT(DISTINCT user_id) as total_users,
                        COUNT(*) as total_sessions,
                        SUM(duration_seconds) as total_duration_seconds,
                        AVG(duration_seconds) as avg_duration_seconds,
                        MIN(session_start) as first_session,
                        MAX(session_start) as last_session
                    FROM $usage_table
                    WHERE session_end IS NOT NULL"
                );
            }
        }

        // Get user statistics
        $user_stats = array();
        if ($table_exists) {
            $user_stats_query = "SELECT 
                u.id,
                u.display_name,
                u.user_email,
                COUNT(us.id) as total_sessions,
                SUM(us.duration_seconds) as total_duration_seconds,
                AVG(us.duration_seconds) as avg_duration_seconds,
                MIN(us.session_start) as first_session,
                MAX(us.session_start) as last_session
            FROM {$wpdb->users} u
            INNER JOIN $usage_table us ON u.id = us.user_id
            WHERE us.session_end IS NOT NULL";

            $user_where_clauses = array();
            $user_where_values = array();

            if ($user_id_filter > 0) {
                $user_where_clauses[] = 'u.id = %d';
                $user_where_values[] = $user_id_filter;
            }

            if ($date_from) {
                $user_where_clauses[] = 'DATE(us.session_start) >= %s';
                $user_where_values[] = $date_from;
            }

            if ($date_to) {
                $user_where_clauses[] = 'DATE(us.session_start) <= %s';
                $user_where_values[] = $date_to;
            }

            if (!empty($user_where_clauses)) {
                $user_stats_query .= ' AND ' . implode(' AND ', $user_where_clauses);
            }

            $user_stats_query .= ' GROUP BY u.id, u.display_name, u.user_email ORDER BY total_duration_seconds DESC LIMIT 100';

            if (!empty($user_where_values)) {
                $user_stats = $wpdb->get_results($wpdb->prepare($user_stats_query, ...$user_where_values));
            } else {
                $user_stats = $wpdb->get_results($user_stats_query);
            }
        }

        // Get total sessions count for conditional display
        $total_sessions = 0;
        if ($table_exists) {
            $total_sessions = $wpdb->get_var("SELECT COUNT(*) FROM $usage_table WHERE session_end IS NOT NULL");
        }

        // Get advanced analytics data
        $advanced_analytics = null;
        $insights = array();
        if ($table_exists && $total_sessions > 0) {
            $advanced_analytics = $this->get_advanced_analytics($date_from, $date_to);
            $insights = $this->generate_insights($advanced_analytics);
        }

        ?>
        <style>
            .twork-usage-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 25px 30px;
                border-radius: 8px;
                margin-bottom: 25px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }
            .twork-usage-header h1 {
                color: white;
                margin: 0;
                font-size: 28px;
                font-weight: 600;
            }
            .twork-usage-card {
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                padding: 25px;
                margin-bottom: 25px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            .twork-usage-card h2 {
                margin-top: 0;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 2px solid #f0f0f0;
                font-size: 20px;
                color: #333;
                font-weight: 600;
            }
            .twork-stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            .twork-stat-card {
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                padding: 20px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                transition: all 0.3s;
                border-left: 4px solid #667eea;
            }
            .twork-stat-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }
            .twork-stat-card.blue { border-left-color: #2196F3; }
            .twork-stat-card.green { border-left-color: #4CAF50; }
            .twork-stat-card.orange { border-left-color: #FF9800; }
            .twork-stat-card.purple { border-left-color: #9C27B0; }
            .twork-stat-label {
                font-size: 12px;
                color: #666;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 8px;
                font-weight: 500;
            }
            .twork-stat-value {
                font-size: 28px;
                font-weight: 700;
                color: #333;
                margin: 0;
            }
            .twork-usage-table {
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            .twork-usage-table table {
                margin: 0;
                border: none;
            }
            .twork-usage-table thead th {
                background: #f9fafb;
                padding: 15px;
                font-weight: 600;
                color: #333;
                border-bottom: 2px solid #e0e0e0;
                text-transform: uppercase;
                font-size: 12px;
                letter-spacing: 0.5px;
            }
            .twork-usage-table tbody td {
                padding: 15px;
                border-bottom: 1px solid #f0f0f0;
                vertical-align: middle;
            }
            .twork-usage-table tbody tr:hover {
                background: #f9fafb;
            }
            .twork-filter-form {
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 25px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            .twork-filter-form .form-row {
                display: flex;
                gap: 15px;
                align-items: flex-end;
                flex-wrap: wrap;
            }
            .twork-filter-form .form-field {
                flex: 1;
                min-width: 200px;
            }
            .twork-filter-form label {
                display: block;
                margin-bottom: 5px;
                font-weight: 600;
                color: #333;
            }
            .twork-filter-form input,
            .twork-filter-form select {
                width: 100%;
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 6px;
            }
        </style>
        <div class="wrap">
            <div class="twork-usage-header">
                <h1><?php esc_html_e('Usage Analytics', 'twork-rewards'); ?></h1>
            </div>
            
            <?php if (!$table_exists): ?>
                <div class="twork-usage-card" style="border-left: 4px solid #f59e0b;">
                    <h2 style="color: #f59e0b; margin-top: 0;">âš ï¸ <?php esc_html_e('Usage Tracking Table Not Found', 'twork-rewards'); ?></h2>
                    <p style="font-size: 14px; line-height: 1.6; color: #666; margin-bottom: 20px;">
                        <?php esc_html_e('The usage tracking table has not been created yet. This table is required to track app usage duration.', 'twork-rewards'); ?>
                    </p>
                    <p style="font-size: 14px; line-height: 1.6; color: #666; margin-bottom: 20px;">
                        <strong><?php esc_html_e('When will data start appearing?', 'twork-rewards'); ?></strong><br>
                        <?php esc_html_e('Data will start being recorded when:', 'twork-rewards'); ?>
                    </p>
                    <ul style="font-size: 14px; line-height: 1.8; color: #666; margin-left: 20px; margin-bottom: 20px;">
                        <li><?php esc_html_e('1. The table is created (click button below)', 'twork-rewards'); ?></li>
                        <li><?php esc_html_e('2. Users open the app (triggers session start)', 'twork-rewards'); ?></li>
                        <li><?php esc_html_e('3. Users close the app or go to background (triggers session end with duration)', 'twork-rewards'); ?></li>
                    </ul>
                    <p style="font-size: 13px; line-height: 1.6; color: #999; margin-bottom: 20px; padding: 15px; background: #f9fafb; border-radius: 6px;">
                        <strong><?php esc_html_e('Note:', 'twork-rewards'); ?></strong> <?php esc_html_e('Only completed sessions (with session_end) will appear in statistics. Active sessions (app still open) will not show until the app is closed.', 'twork-rewards'); ?>
                    </p>
                    <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-usage', 'create_table' => '1'), admin_url('admin.php'))); ?>" 
                       class="button button-primary button-large" 
                       style="padding: 12px 24px; font-size: 14px; font-weight: 600;">
                        <?php esc_html_e('Create Usage Tracking Table', 'twork-rewards'); ?>
                    </a>
                </div>
            <?php else: ?>
                <?php
                // Check if there's any data (already calculated above)
                if ($total_sessions == 0):
                    ?>
                    <div class="twork-usage-card" style="border-left: 4px solid #2196F3;">
                        <h2 style="color: #2196F3; margin-top: 0;">ðŸ“Š <?php esc_html_e('No Usage Data Yet', 'twork-rewards'); ?></h2>
                        <p style="font-size: 14px; line-height: 1.6; color: #666; margin-bottom: 15px;">
                            <?php esc_html_e('The usage tracking table is ready, but no data has been recorded yet.', 'twork-rewards'); ?>
                        </p>
                        <p style="font-size: 14px; line-height: 1.6; color: #666; margin-bottom: 15px;">
                            <strong><?php esc_html_e('When will data start appearing?', 'twork-rewards'); ?></strong>
                        </p>
                        <ul style="font-size: 14px; line-height: 1.8; color: #666; margin-left: 20px; margin-bottom: 15px;">
                            <li><?php esc_html_e('âœ… Table is created and ready', 'twork-rewards'); ?></li>
                            <li><?php esc_html_e('â³ Waiting for users to open the app (triggers session start)', 'twork-rewards'); ?></li>
                            <li><?php esc_html_e('â³ Waiting for users to close the app (triggers session end with duration)', 'twork-rewards'); ?></li>
                        </ul>
                        <p style="font-size: 13px; line-height: 1.6; color: #999; padding: 15px; background: #f9fafb; border-radius: 6px; margin-bottom: 15px;">
                            <strong><?php esc_html_e('Important:', 'twork-rewards'); ?></strong> <?php esc_html_e('Data will only appear after users close the app or send it to background. Active sessions (app currently open) will not show until the session ends.', 'twork-rewards'); ?>
                        </p>
                        <p style="font-size: 13px; line-height: 1.6; color: #666;">
                            <strong><?php esc_html_e('API Endpoints:', 'twork-rewards'); ?></strong><br>
                            <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px; font-size: 12px;">POST /wp-json/twork/v1/usage/start</code> - <?php esc_html_e('Called when app opens', 'twork-rewards'); ?><br>
                            <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px; font-size: 12px;">POST /wp-json/twork/v1/usage/end</code> - <?php esc_html_e('Called when app closes/goes to background', 'twork-rewards'); ?>
                        </p>
                    </div>
                <?php endif; ?>
                
                <!-- Filters -->
                <div class="twork-filter-form">
                    <form method="get" action="">
                        <input type="hidden" name="page" value="twork-rewards-usage">
                        <div class="form-row">
                            <div class="form-field">
                                <label><?php esc_html_e('User ID', 'twork-rewards'); ?></label>
                                <input type="number" name="user_id" value="<?php echo esc_attr($user_id_filter); ?>" placeholder="All users">
                            </div>
                            <div class="form-field">
                                <label><?php esc_html_e('Date From', 'twork-rewards'); ?></label>
                                <input type="date" name="date_from" value="<?php echo esc_attr($date_from); ?>">
                            </div>
                            <div class="form-field">
                                <label><?php esc_html_e('Date To', 'twork-rewards'); ?></label>
                                <input type="date" name="date_to" value="<?php echo esc_attr($date_to); ?>">
                            </div>
                            <div class="form-field">
                                <label>&nbsp;</label>
                                <button type="submit" class="button button-primary"><?php esc_html_e('Filter', 'twork-rewards'); ?></button>
                                <a href="<?php echo esc_url(admin_url('admin.php?page=twork-rewards-usage')); ?>" class="button"><?php esc_html_e('Reset', 'twork-rewards'); ?></a>
                                <?php if ($table_exists && $total_sessions > 0): ?>
                                    <a href="<?php echo esc_url(add_query_arg(array('page' => 'twork-rewards-usage', 'export' => 'csv', 'date_from' => $date_from, 'date_to' => $date_to), admin_url('admin.php'))); ?>" 
                                       class="button" 
                                       style="background: #10b981; border-color: #10b981; color: white;">
                                        <?php esc_html_e('Export CSV', 'twork-rewards'); ?>
                                    </a>
                                <?php endif; ?>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Automated Insights & Recommendations -->
                <?php if (!empty($insights)): ?>
                    <div class="twork-usage-card">
                        <h2><?php esc_html_e('Insights & Recommendations', 'twork-rewards'); ?></h2>
                        <div style="display: grid; gap: 15px;">
                            <?php
                            foreach ($insights as $insight):
                                $bg_color = $insight['type'] === 'positive' ? '#f0fdf4' : ($insight['type'] === 'warning' ? '#fef2f2' : '#eff6ff');
                                $border_color = $insight['type'] === 'positive' ? '#46b450' : ($insight['type'] === 'warning' ? '#dc3232' : '#3b82f6');
                                ?>
                                <div style="padding: 15px; background: <?php echo $bg_color; ?>; border-left: 4px solid <?php echo $border_color; ?>; border-radius: 4px;">
                                    <div style="display: flex; align-items: start; gap: 10px;">
                                        <span style="font-size: 20px;"><?php echo esc_html($insight['icon']); ?></span>
                                        <div style="flex: 1;">
                                            <strong style="display: block; margin-bottom: 5px; color: #333;"><?php echo esc_html($insight['title']); ?></strong>
                                            <p style="margin: 0; color: #666; font-size: 14px; line-height: 1.5;"><?php echo esc_html($insight['message']); ?></p>
                                        </div>
                                    </div>
                                </div>
                            <?php endforeach; ?>
                        </div>
                    </div>
                <?php endif; ?>
                
                <!-- Key Performance Indicators (KPIs) -->
                <?php
                if ($table_exists):
                    // Show KPIs even if no usage data yet - use activity stats
                    if (!$advanced_analytics || empty($advanced_analytics)) {
                        // Get activity stats for fallback
                        $activity_stats_fallback = $this->get_activity_statistics();
                        // Create basic analytics from activity stats
                        $advanced_analytics = array(
                            'dau_avg' => round($activity_stats_fallback['active_count'] / 30, 2),  // Estimate DAU from active users
                            'mau' => $activity_stats_fallback['active_count'],
                            'retention_rate' => $activity_stats_fallback['active_rate'],
                            'churn_rate' => 100 - $activity_stats_fallback['active_rate'],
                            'growth_rate' => 0,
                            'new_users' => 0,
                            'returning_users' => $activity_stats_fallback['active_count'],
                            'highly_active_users' => 0,
                            'moderately_active_users' => 0,
                            'low_active_users' => 0,
                            'peak_hours' => array(),
                            'days_of_week' => array(),
                            'daily_trends' => array()
                        );
                    }
                    ?>
                    <div class="twork-usage-card">
                        <h2><?php esc_html_e('Key Performance Indicators', 'twork-rewards'); ?></h2>
                        <div class="twork-stats-grid">
                            <div class="twork-stat-card" style="border-left-color: #10b981; background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);">
                                <div class="twork-stat-label">Daily Active Users (Avg)</div>
                                <div class="twork-stat-value" style="color: #10b981;"><?php echo number_format($advanced_analytics['dau_avg'], 0); ?></div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                    <?php esc_html_e('Average daily active users', 'twork-rewards'); ?>
                                </div>
                            </div>
                            <div class="twork-stat-card" style="border-left-color: #3b82f6; background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%);">
                                <div class="twork-stat-label">Monthly Active Users</div>
                                <div class="twork-stat-value" style="color: #3b82f6;"><?php echo number_format($advanced_analytics['mau']); ?></div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                    <?php esc_html_e('Unique users in period', 'twork-rewards'); ?>
                                </div>
                            </div>
                            <div class="twork-stat-card" style="border-left-color: #8b5cf6; background: linear-gradient(135deg, #f5f3ff 0%, #ffffff 100%);">
                                <div class="twork-stat-label">Retention Rate</div>
                                <div class="twork-stat-value" style="color: #8b5cf6;"><?php echo number_format($advanced_analytics['retention_rate'], 1); ?>%</div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                    <?php esc_html_e('Users returning from previous period', 'twork-rewards'); ?>
                                </div>
                            </div>
                            <div class="twork-stat-card" style="border-left-color: <?php echo $advanced_analytics['churn_rate'] > 20 ? '#dc3232' : '#f59e0b'; ?>; background: linear-gradient(135deg, <?php echo $advanced_analytics['churn_rate'] > 20 ? '#fef2f2' : '#fffbeb'; ?> 0%, #ffffff 100%);">
                                <div class="twork-stat-label">Churn Rate</div>
                                <div class="twork-stat-value" style="color: <?php echo $advanced_analytics['churn_rate'] > 20 ? '#dc3232' : '#f59e0b'; ?>;"><?php echo number_format($advanced_analytics['churn_rate'], 1); ?>%</div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                    <?php esc_html_e('Users lost from previous period', 'twork-rewards'); ?>
                                </div>
                            </div>
                            <div class="twork-stat-card" style="border-left-color: <?php echo $advanced_analytics['growth_rate'] >= 0 ? '#10b981' : '#dc3232'; ?>; background: linear-gradient(135deg, <?php echo $advanced_analytics['growth_rate'] >= 0 ? '#f0fdf4' : '#fef2f2'; ?> 0%, #ffffff 100%);">
                                <div class="twork-stat-label">Growth Rate</div>
                                <div class="twork-stat-value" style="color: <?php echo $advanced_analytics['growth_rate'] >= 0 ? '#10b981' : '#dc3232'; ?>;">
                                    <?php echo $advanced_analytics['growth_rate'] >= 0 ? '+' : ''; ?><?php echo number_format($advanced_analytics['growth_rate'], 1); ?>%
                                </div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                    <?php esc_html_e('Period over period growth', 'twork-rewards'); ?>
                                </div>
                            </div>
                            <div class="twork-stat-card" style="border-left-color: #ec4899; background: linear-gradient(135deg, #fdf2f8 0%, #ffffff 100%);">
                                <div class="twork-stat-label">New Users</div>
                                <div class="twork-stat-value" style="color: #ec4899;"><?php echo number_format($advanced_analytics['new_users']); ?></div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                    <?php esc_html_e('Users registered in period', 'twork-rewards'); ?>
                                </div>
                            </div>
                            <div class="twork-stat-card" style="border-left-color: #06b6d4; background: linear-gradient(135deg, #ecfeff 0%, #ffffff 100%);">
                                <div class="twork-stat-label">Returning Users</div>
                                <div class="twork-stat-value" style="color: #06b6d4;"><?php echo number_format($advanced_analytics['returning_users']); ?></div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                    <?php esc_html_e('Existing users active in period', 'twork-rewards'); ?>
                                </div>
                            </div>
                            <?php
                            if ($advanced_analytics['mau'] > 0):
                                $dau_mau_ratio = ($advanced_analytics['dau_avg'] / $advanced_analytics['mau']) * 100;
                                ?>
                            <div class="twork-stat-card" style="border-left-color: #f59e0b; background: linear-gradient(135deg, #fffbeb 0%, #ffffff 100%);">
                                <div class="twork-stat-label">DAU/MAU Ratio</div>
                                <div class="twork-stat-value" style="color: #f59e0b;"><?php echo number_format($dau_mau_ratio, 1); ?>%</div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                    <?php esc_html_e('Daily engagement ratio', 'twork-rewards'); ?>
                                </div>
                            </div>
                            <?php endif; ?>
                        </div>
                    </div>
                    
                    <!-- User Segmentation -->
                    <div class="twork-usage-card">
                        <h2><?php esc_html_e('User Segmentation by Activity Level', 'twork-rewards'); ?></h2>
                        <div class="twork-stats-grid">
                            <div class="twork-stat-card" style="border-left-color: #10b981;">
                                <div class="twork-stat-label">Highly Active</div>
                                <div class="twork-stat-value" style="color: #10b981;"><?php echo number_format($advanced_analytics['highly_active_users']); ?></div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                    <?php esc_html_e('10+ sessions in period', 'twork-rewards'); ?>
                                </div>
                            </div>
                            <div class="twork-stat-card" style="border-left-color: #f59e0b;">
                                <div class="twork-stat-label">Moderately Active</div>
                                <div class="twork-stat-value" style="color: #f59e0b;"><?php echo number_format($advanced_analytics['moderately_active_users']); ?></div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                    <?php esc_html_e('3-9 sessions in period', 'twork-rewards'); ?>
                                </div>
                            </div>
                            <div class="twork-stat-card" style="border-left-color: #6b7280;">
                                <div class="twork-stat-label">Low Activity</div>
                                <div class="twork-stat-value" style="color: #6b7280;"><?php echo number_format($advanced_analytics['low_active_users']); ?></div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                    <?php esc_html_e('Less than 3 sessions', 'twork-rewards'); ?>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Peak Hours Analysis -->
                    <?php if (!empty($advanced_analytics['peak_hours'])): ?>
                        <div class="twork-usage-card">
                            <h2><?php esc_html_e('Peak Hours Analysis', 'twork-rewards'); ?></h2>
                            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                                <?php esc_html_e('Best times to show ads and send push notifications', 'twork-rewards'); ?>
                            </p>
                            <div class="twork-usage-table">
                                <table class="wp-list-table widefat fixed striped">
                                    <thead>
                                        <tr>
                                            <th><?php esc_html_e('Hour', 'twork-rewards'); ?></th>
                                            <th><?php esc_html_e('Sessions', 'twork-rewards'); ?></th>
                                            <th><?php esc_html_e('Unique Users', 'twork-rewards'); ?></th>
                                            <th><?php esc_html_e('Avg Duration', 'twork-rewards'); ?></th>
                                            <th><?php esc_html_e('Activity Level', 'twork-rewards'); ?></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <?php
                                        foreach (array_slice($advanced_analytics['peak_hours'], 0, 10) as $hour):
                                            $max_sessions = $advanced_analytics['peak_hours'][0]->session_count;
                                            $activity_percentage = ($hour->session_count / $max_sessions) * 100;
                                            $activity_level = $activity_percentage >= 80 ? 'High' : ($activity_percentage >= 50 ? 'Medium' : 'Low');
                                            $activity_color = $activity_percentage >= 80 ? '#10b981' : ($activity_percentage >= 50 ? '#f59e0b' : '#6b7280');
                                            $avg_minutes = floor($hour->avg_duration / 60);
                                            $avg_secs = $hour->avg_duration % 60;
                                            ?>
                                            <tr>
                                                <td><strong><?php echo sprintf('%02d:00', $hour->hour); ?></strong></td>
                                                <td><?php echo number_format($hour->session_count); ?></td>
                                                <td><?php echo number_format($hour->unique_users); ?></td>
                                                <td><?php echo sprintf('%d:%02d', $avg_minutes, $avg_secs); ?></td>
                                                <td>
                                                    <span style="display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: <?php echo $activity_color; ?>20; color: <?php echo $activity_color; ?>;">
                                                        <?php echo esc_html($activity_level); ?>
                                                    </span>
                                                </td>
                                            </tr>
                                        <?php endforeach; ?>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    <?php endif; ?>
                    
                    <!-- Days of Week Analysis -->
                    <?php if ($table_exists && !empty($advanced_analytics['days_of_week'])): ?>
                        <div class="twork-usage-card">
                            <h2><?php esc_html_e('Days of Week Analysis', 'twork-rewards'); ?></h2>
                            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                                <?php esc_html_e('Weekly activity patterns for strategic ad placement', 'twork-rewards'); ?>
                            </p>
                            <div class="twork-usage-table">
                                <table class="wp-list-table widefat fixed striped">
                                    <thead>
                                        <tr>
                                            <th><?php esc_html_e('Day', 'twork-rewards'); ?></th>
                                            <th><?php esc_html_e('Sessions', 'twork-rewards'); ?></th>
                                            <th><?php esc_html_e('Unique Users', 'twork-rewards'); ?></th>
                                            <th><?php esc_html_e('Avg Duration', 'twork-rewards'); ?></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <?php
                                        foreach ($advanced_analytics['days_of_week'] as $day):
                                            $avg_minutes = floor($day->avg_duration / 60);
                                            $avg_secs = $day->avg_duration % 60;
                                            ?>
                                            <tr>
                                                <td><strong><?php echo esc_html($day->day_name); ?></strong></td>
                                                <td><?php echo number_format($day->session_count); ?></td>
                                                <td><?php echo number_format($day->unique_users); ?></td>
                                                <td><?php echo sprintf('%d:%02d', $avg_minutes, $avg_secs); ?></td>
                                            </tr>
                                        <?php endforeach; ?>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    <?php endif; ?>
                    
                    <!-- Daily Trends Chart Data -->
                    <?php if ($table_exists && !empty($advanced_analytics['daily_trends'])): ?>
                        <div class="twork-usage-card">
                            <h2><?php esc_html_e('Daily Trends', 'twork-rewards'); ?></h2>
                            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                                <?php esc_html_e('Daily active users and sessions over time', 'twork-rewards'); ?>
                            </p>
                            <div class="twork-usage-table">
                                <table class="wp-list-table widefat fixed striped">
                                    <thead>
                                        <tr>
                                            <th><?php esc_html_e('Date', 'twork-rewards'); ?></th>
                                            <th><?php esc_html_e('Daily Active Users', 'twork-rewards'); ?></th>
                                            <th><?php esc_html_e('Sessions', 'twork-rewards'); ?></th>
                                            <th><?php esc_html_e('Total Duration', 'twork-rewards'); ?></th>
                                            <th><?php esc_html_e('Avg Session', 'twork-rewards'); ?></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <?php
                                        foreach (array_slice($advanced_analytics['daily_trends'], -14) as $trend):
                                            $total_hours = floor($trend->daily_duration / 3600);
                                            $total_minutes = floor(($trend->daily_duration % 3600) / 60);
                                            $avg_minutes = floor($trend->avg_session_duration / 60);
                                            $avg_secs = $trend->avg_session_duration % 60;
                                            ?>
                                            <tr>
                                                <td><strong><?php
                                            // Professional: Display usage trend date in Myanmar timezone
                                            $formatted_date = $this->format_myanmar_time($trend->date, get_option('date_format'));
                                            echo esc_html($formatted_date ?: $trend->date);
                                            ?></strong></td>
                                                <td><?php echo number_format($trend->daily_active_users); ?></td>
                                                <td><?php echo number_format($trend->daily_sessions); ?></td>
                                                <td><?php echo sprintf('%d:%02d', $total_hours, $total_minutes); ?></td>
                                                <td><?php echo sprintf('%d:%02d', $avg_minutes, $avg_secs); ?></td>
                                            </tr>
                                        <?php endforeach; ?>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    <?php endif; ?>
                <?php endif; ?>
                
                <!-- Activity Statistics -->
                <?php
                $activity_stats = $this->get_activity_statistics();
                if (!empty($activity_stats)):
                    $active_percentage = $activity_stats['total_count'] > 0 ? ($activity_stats['active_count'] / $activity_stats['total_count']) * 100 : 0;
                    $inactive_percentage = $activity_stats['total_count'] > 0 ? ($activity_stats['inactive_count'] / $activity_stats['total_count']) * 100 : 0;
                    ?>
                    <div class="twork-usage-card">
                        <h2><?php esc_html_e('User Activity Status', 'twork-rewards'); ?></h2>
                        <div class="twork-stats-grid">
                            <div class="twork-stat-card" style="border-left-color: #46b450; background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);">
                                <div class="twork-stat-label">Active Users</div>
                                <div class="twork-stat-value" style="color: #46b450;"><?php echo number_format($activity_stats['active_count']); ?></div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                    <?php printf(esc_html__('Active within last %d days', 'twork-rewards'), $activity_stats['threshold_days']); ?>
                                </div>
                                <div style="width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 10px; overflow: hidden;">
                                    <div style="width: <?php echo esc_attr($active_percentage); ?>%; height: 100%; background: #46b450; border-radius: 2px;"></div>
                                </div>
                            </div>
                            <div class="twork-stat-card" style="border-left-color: #dc3232; background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);">
                                <div class="twork-stat-label">Inactive Users</div>
                                <div class="twork-stat-value" style="color: #dc3232;"><?php echo number_format($activity_stats['inactive_count']); ?></div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                    <?php printf(esc_html__('Inactive for %d+ days', 'twork-rewards'), $activity_stats['threshold_days']); ?>
                                </div>
                                <div style="width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 10px; overflow: hidden;">
                                    <div style="width: <?php echo esc_attr($inactive_percentage); ?>%; height: 100%; background: #dc3232; border-radius: 2px;"></div>
                                </div>
                            </div>
                            <div class="twork-stat-card" style="border-left-color: #3b82f6; background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%);">
                                <div class="twork-stat-label">Total Users</div>
                                <div class="twork-stat-value" style="color: #3b82f6;"><?php echo number_format($activity_stats['total_count']); ?></div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                    <?php esc_html_e('All registered users', 'twork-rewards'); ?>
                                </div>
                            </div>
                            <div class="twork-stat-card" style="border-left-color: #f59e0b; background: linear-gradient(135deg, #fffbeb 0%, #ffffff 100%);">
                                <div class="twork-stat-label">Active Rate</div>
                                <div class="twork-stat-value" style="color: #f59e0b;"><?php echo number_format($activity_stats['active_rate'], 1); ?>%</div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                    <?php esc_html_e('Percentage of active users', 'twork-rewards'); ?>
                                </div>
                                <div style="width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px; margin-top: 10px; overflow: hidden;">
                                    <div style="width: <?php echo esc_attr($activity_stats['active_rate']); ?>%; height: 100%; background: #f59e0b; border-radius: 2px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                <?php endif; ?>
                
                <!-- Overall Statistics -->
                <?php if ($overall_stats): ?>
                    <div class="twork-usage-card">
                        <h2><?php esc_html_e('Usage Statistics', 'twork-rewards'); ?></h2>
                        <div class="twork-stats-grid">
                            <div class="twork-stat-card blue">
                                <div class="twork-stat-label">Total Users (Usage)</div>
                                <div class="twork-stat-value"><?php echo number_format((int) $overall_stats->total_users); ?></div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                    <?php esc_html_e('Users with app usage', 'twork-rewards'); ?>
                                </div>
                            </div>
                            <div class="twork-stat-card green">
                                <div class="twork-stat-label">Total Sessions</div>
                                <div class="twork-stat-value"><?php echo number_format((int) $overall_stats->total_sessions); ?></div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                    <?php esc_html_e('App sessions tracked', 'twork-rewards'); ?>
                                </div>
                            </div>
                            <div class="twork-stat-card orange">
                                <div class="twork-stat-label">Total Duration</div>
                                <div class="twork-stat-value">
                                    <?php
                                    $total_seconds = (int) $overall_stats->total_duration_seconds;
                                    $hours = floor($total_seconds / 3600);
                                    $minutes = floor(($total_seconds % 3600) / 60);
                                    echo sprintf('%d:%02d', $hours, $minutes);
                                    ?>
                                </div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                    <?php esc_html_e('Hours:Minutes', 'twork-rewards'); ?>
                                </div>
                            </div>
                            <div class="twork-stat-card purple">
                                <div class="twork-stat-label">Average Session</div>
                                <div class="twork-stat-value">
                                    <?php
                                    $avg_seconds = (int) $overall_stats->avg_duration_seconds;
                                    $avg_minutes = floor($avg_seconds / 60);
                                    $avg_secs = $avg_seconds % 60;
                                    echo sprintf('%d:%02d', $avg_minutes, $avg_secs);
                                    ?>
                                </div>
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                    <?php esc_html_e('Minutes:Seconds', 'twork-rewards'); ?>
                                </div>
                            </div>
                        </div>
                    </div>
                <?php endif; ?>
                
                <!-- User Statistics Table -->
                <div class="twork-usage-card">
                    <h2><?php esc_html_e('User Usage Statistics', 'twork-rewards'); ?></h2>
                    <div class="twork-usage-table">
                        <table class="wp-list-table widefat fixed striped">
                            <thead>
                                <tr>
                                    <th style="width: 120px;">Activity Status</th>
                                    <th>User ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Total Sessions</th>
                                    <th>Total Duration</th>
                                    <th>Average Session</th>
                                    <th>First Session</th>
                                    <th>Last Session</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php
                                if ($user_stats):
                                    foreach ($user_stats as $stat):
                                        $total_seconds = (int) $stat->total_duration_seconds;
                                        $total_hours = floor($total_seconds / 3600);
                                        $total_minutes = floor(($total_seconds % 3600) / 60);

                                        $avg_seconds = (int) $stat->avg_duration_seconds;
                                        $avg_minutes = floor($avg_seconds / 60);
                                        $avg_secs = $avg_seconds % 60;

                                        // Get activity status for this user
                                        $user_activity_status = $this->get_user_activity_status($stat->id);
                                        $is_active = $user_activity_status['is_active'];
                                        $activity = $this->get_formatted_user_activity($stat->id);
                                        ?>
                                    <tr>
                                        <td>
                                            <div class="twork-activity-status-badge <?php echo $is_active ? 'active' : 'inactive'; ?>" style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; border: 1px solid; <?php echo $is_active ? 'background: #f0fdf4; color: #166534; border-color: #46b450;' : 'background: #fef2f2; color: #991b1b; border-color: #dc3232;'; ?>">
                                                <?php echo esc_html($activity['status_label']); ?>
                                            </div>
                                        </td>
                                        <td><strong>#<?php echo $stat->id; ?></strong></td>
                                        <td><strong><?php echo esc_html($stat->display_name); ?></strong></td>
                                        <td><?php echo esc_html($stat->user_email); ?></td>
                                        <td><?php echo number_format((int) $stat->total_sessions); ?></td>
                                        <td><strong><?php echo sprintf('%d:%02d', $total_hours, $total_minutes); ?></strong></td>
                                        <td><?php echo sprintf('%d:%02d', $avg_minutes, $avg_secs); ?></td>
                                        <td><?php
                                        // Professional: Display first session date in Myanmar timezone
                                        if ($stat->first_session) {
                                            $formatted_date = $this->format_myanmar_time($stat->first_session, 'M d, Y');
                                            echo esc_html($formatted_date ?: $stat->first_session);
                                        } else {
                                            echo '-';
                                        }
                                        ?></td>
                                        <td><?php
                                        // Professional: Display last session date in Myanmar timezone
                                        if ($stat->last_session) {
                                            $formatted_date = $this->format_myanmar_time($stat->last_session, 'M d, Y');
                                            echo esc_html($formatted_date ?: $stat->last_session);
                                        } else {
                                            echo '-';
                                        }
                                        ?></td>
                                    </tr>
                                <?php endforeach;
                                else: ?>
                                    <tr><td colspan="9" style="text-align: center; padding: 40px; color: #999; font-style: italic;"><?php esc_html_e('No usage data found.', 'twork-rewards'); ?></td></tr>
                                <?php endif; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
                
            <?php endif; ?>
        </div>
        <?php
    }

    /**
     * Get advanced analytics data for professional insights
     * Comprehensive metrics for advertising and business intelligence
     *
     * @param string $date_from Start date (Y-m-d)
     * @param string $date_to End date (Y-m-d)
     * @return array Comprehensive analytics data
     */
    public function get_advanced_analytics($date_from = null, $date_to = null)
    {
        global $wpdb;
        $usage_table = $this->usage_tracking_table_name();

        if (!$date_from) {
            $date_from = date('Y-m-d', strtotime('-30 days'));
        }
        if (!$date_to) {
            $date_to = date('Y-m-d');
        }

        $analytics = array();

        // Daily trends
        $daily_trends = $wpdb->get_results($wpdb->prepare(
            "SELECT 
                DATE(session_start) as date,
                COUNT(DISTINCT user_id) as daily_active_users,
                COUNT(*) as daily_sessions,
                SUM(duration_seconds) as daily_duration,
                AVG(duration_seconds) as avg_session_duration
            FROM $usage_table
            WHERE session_end IS NOT NULL 
            AND DATE(session_start) >= %s 
            AND DATE(session_start) <= %s
            GROUP BY DATE(session_start)
            ORDER BY date ASC",
            $date_from,
            $date_to
        ));

        // Weekly trends
        $weekly_trends = $wpdb->get_results($wpdb->prepare(
            "SELECT 
                YEARWEEK(session_start, 1) as week,
                COUNT(DISTINCT user_id) as weekly_active_users,
                COUNT(*) as weekly_sessions,
                SUM(duration_seconds) as weekly_duration
            FROM $usage_table
            WHERE session_end IS NOT NULL 
            AND DATE(session_start) >= %s 
            AND DATE(session_start) <= %s
            GROUP BY YEARWEEK(session_start, 1)
            ORDER BY week ASC",
            $date_from,
            $date_to
        ));

        // Peak hours analysis
        $peak_hours = $wpdb->get_results($wpdb->prepare(
            "SELECT 
                HOUR(session_start) as hour,
                COUNT(*) as session_count,
                COUNT(DISTINCT user_id) as unique_users,
                AVG(duration_seconds) as avg_duration
            FROM $usage_table
            WHERE session_end IS NOT NULL 
            AND DATE(session_start) >= %s 
            AND DATE(session_start) <= %s
            GROUP BY HOUR(session_start)
            ORDER BY session_count DESC",
            $date_from,
            $date_to
        ));

        // Days of week analysis
        $days_of_week = $wpdb->get_results($wpdb->prepare(
            "SELECT 
                DAYOFWEEK(session_start) as day_of_week,
                DAYNAME(session_start) as day_name,
                COUNT(*) as session_count,
                COUNT(DISTINCT user_id) as unique_users,
                AVG(duration_seconds) as avg_duration
            FROM $usage_table
            WHERE session_end IS NOT NULL 
            AND DATE(session_start) >= %s 
            AND DATE(session_start) <= %s
            GROUP BY DAYOFWEEK(session_start), DAYNAME(session_start)
            ORDER BY day_of_week ASC",
            $date_from,
            $date_to
        ));

        // New vs Returning users
        $new_users = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(DISTINCT u.id)
            FROM {$wpdb->users} u
            INNER JOIN $usage_table us ON u.id = us.user_id
            WHERE us.session_end IS NOT NULL
            AND DATE(us.session_start) >= %s 
            AND DATE(us.session_start) <= %s
            AND DATE(u.user_registered) >= %s",
            $date_from,
            $date_to,
            $date_from
        ));

        $returning_users = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(DISTINCT u.id)
            FROM {$wpdb->users} u
            INNER JOIN $usage_table us ON u.id = us.user_id
            WHERE us.session_end IS NOT NULL
            AND DATE(us.session_start) >= %s 
            AND DATE(us.session_start) <= %s
            AND DATE(u.user_registered) < %s",
            $date_from,
            $date_to,
            $date_from
        ));

        // DAU (Daily Active Users) - Last 30 days average
        $dau_avg = $wpdb->get_var($wpdb->prepare(
            "SELECT AVG(daily_users) FROM (
                SELECT DATE(session_start) as date, COUNT(DISTINCT user_id) as daily_users
                FROM $usage_table
                WHERE session_end IS NOT NULL 
                AND DATE(session_start) >= %s 
                AND DATE(session_start) <= %s
                GROUP BY DATE(session_start)
            ) as daily_stats",
            $date_from,
            $date_to
        ));

        // MAU (Monthly Active Users)
        $mau = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(DISTINCT user_id)
            FROM $usage_table
            WHERE session_end IS NOT NULL 
            AND DATE(session_start) >= %s 
            AND DATE(session_start) <= %s",
            $date_from,
            $date_to
        ));

        // Retention rate calculation (users active in both periods)
        $previous_period_start = date('Y-m-d', strtotime($date_from . ' -' . (strtotime($date_to) - strtotime($date_from)) / 86400 . ' days'));
        $previous_period_end = date('Y-m-d', strtotime($date_from . ' -1 day'));

        $retained_users = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(DISTINCT u1.user_id)
            FROM (
                SELECT DISTINCT user_id 
                FROM $usage_table 
                WHERE session_end IS NOT NULL 
                AND DATE(session_start) >= %s 
                AND DATE(session_start) <= %s
            ) u1
            INNER JOIN (
                SELECT DISTINCT user_id 
                FROM $usage_table 
                WHERE session_end IS NOT NULL 
                AND DATE(session_start) >= %s 
                AND DATE(session_start) <= %s
            ) u2 ON u1.user_id = u2.user_id",
            $date_from,
            $date_to,
            $previous_period_start,
            $previous_period_end
        ));

        $previous_period_users = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(DISTINCT user_id)
            FROM $usage_table
            WHERE session_end IS NOT NULL 
            AND DATE(session_start) >= %s 
            AND DATE(session_start) <= %s",
            $previous_period_start,
            $previous_period_end
        ));

        $retention_rate = $previous_period_users > 0 ? ($retained_users / $previous_period_users) * 100 : 0;

        // Churn rate (users who were active before but not in current period)
        $churned_users = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(DISTINCT u1.user_id)
            FROM (
                SELECT DISTINCT user_id 
                FROM $usage_table 
                WHERE session_end IS NOT NULL 
                AND DATE(session_start) >= %s 
                AND DATE(session_start) <= %s
            ) u1
            LEFT JOIN (
                SELECT DISTINCT user_id 
                FROM $usage_table 
                WHERE session_end IS NOT NULL 
                AND DATE(session_start) >= %s 
                AND DATE(session_start) <= %s
            ) u2 ON u1.user_id = u2.user_id
            WHERE u2.user_id IS NULL",
            $previous_period_start,
            $previous_period_end,
            $date_from,
            $date_to
        ));

        $churn_rate = $previous_period_users > 0 ? ($churned_users / $previous_period_users) * 100 : 0;

        // User segmentation by activity level
        $highly_active = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(DISTINCT user_id)
            FROM (
                SELECT user_id, COUNT(*) as session_count
                FROM $usage_table
                WHERE session_end IS NOT NULL 
                AND DATE(session_start) >= %s 
                AND DATE(session_start) <= %s
                GROUP BY user_id
                HAVING session_count >= 10
            ) as active_users",
            $date_from,
            $date_to
        ));

        $moderately_active = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(DISTINCT user_id)
            FROM (
                SELECT user_id, COUNT(*) as session_count
                FROM $usage_table
                WHERE session_end IS NOT NULL 
                AND DATE(session_start) >= %s 
                AND DATE(session_start) <= %s
                GROUP BY user_id
                HAVING session_count >= 3 AND session_count < 10
            ) as active_users",
            $date_from,
            $date_to
        ));

        $low_active = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(DISTINCT user_id)
            FROM (
                SELECT user_id, COUNT(*) as session_count
                FROM $usage_table
                WHERE session_end IS NOT NULL 
                AND DATE(session_start) >= %s 
                AND DATE(session_start) <= %s
                GROUP BY user_id
                HAVING session_count < 3
            ) as active_users",
            $date_from,
            $date_to
        ));

        // Growth metrics
        $current_period_users = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(DISTINCT user_id)
            FROM $usage_table
            WHERE session_end IS NOT NULL 
            AND DATE(session_start) >= %s 
            AND DATE(session_start) <= %s",
            $date_from,
            $date_to
        ));

        $growth_rate = $previous_period_users > 0
            ? (($current_period_users - $previous_period_users) / $previous_period_users) * 100
            : 0;

        return array(
            'daily_trends' => $daily_trends,
            'weekly_trends' => $weekly_trends,
            'peak_hours' => $peak_hours,
            'days_of_week' => $days_of_week,
            'new_users' => (int) $new_users,
            'returning_users' => (int) $returning_users,
            'dau_avg' => round($dau_avg, 2),
            'mau' => (int) $mau,
            'retention_rate' => round($retention_rate, 2),
            'churn_rate' => round($churn_rate, 2),
            'highly_active_users' => (int) $highly_active,
            'moderately_active_users' => (int) $moderately_active,
            'low_active_users' => (int) $low_active,
            'growth_rate' => round($growth_rate, 2),
            'current_period_users' => (int) $current_period_users,
            'previous_period_users' => (int) $previous_period_users,
            'date_from' => $date_from,
            'date_to' => $date_to
        );
    }

    /**
     * Generate automated insights and recommendations
     * AI-like insights for business intelligence
     *
     * @param array $analytics Analytics data from get_advanced_analytics
     * @return array Insights and recommendations
     */
    public function generate_insights($analytics)
    {
        $insights = array();

        // Growth insights
        if ($analytics['growth_rate'] > 10) {
            $insights[] = array(
                'type' => 'positive',
                'title' => __('Strong Growth Detected', 'twork-rewards'),
                'message' => sprintf(__('User base grew by %.1f%% compared to previous period. Consider scaling infrastructure.', 'twork-rewards'), $analytics['growth_rate']),
                'icon' => 'ðŸ“ˆ'
            );
        } elseif ($analytics['growth_rate'] < -5) {
            $insights[] = array(
                'type' => 'warning',
                'title' => __('Declining User Base', 'twork-rewards'),
                'message' => sprintf(__('User base decreased by %.1f%%. Review engagement strategies and user acquisition channels.', 'twork-rewards'), abs($analytics['growth_rate'])),
                'icon' => 'âš ï¸'
            );
        }

        // Retention insights
        if ($analytics['retention_rate'] > 60) {
            $insights[] = array(
                'type' => 'positive',
                'title' => __('Excellent Retention', 'twork-rewards'),
                'message' => sprintf(__('Retention rate of %.1f%% indicates strong user loyalty. Ideal for premium features and advertising.', 'twork-rewards'), $analytics['retention_rate']),
                'icon' => 'âœ…'
            );
        } elseif ($analytics['retention_rate'] < 30) {
            $insights[] = array(
                'type' => 'warning',
                'title' => __('Low Retention Rate', 'twork-rewards'),
                'message' => sprintf(__('Retention rate of %.1f%% needs improvement. Focus on onboarding and value delivery.', 'twork-rewards'), $analytics['retention_rate']),
                'icon' => 'âš ï¸'
            );
        }

        // Churn insights
        if ($analytics['churn_rate'] > 20) {
            $insights[] = array(
                'type' => 'warning',
                'title' => __('High Churn Rate', 'twork-rewards'),
                'message' => sprintf(__('Churn rate of %.1f%% is concerning. Implement re-engagement campaigns.', 'twork-rewards'), $analytics['churn_rate']),
                'icon' => 'âš ï¸'
            );
        }

        // Activity segmentation insights
        $total_segmented = $analytics['highly_active_users'] + $analytics['moderately_active_users'] + $analytics['low_active_users'];
        if ($total_segmented > 0) {
            $highly_active_pct = ($analytics['highly_active_users'] / $total_segmented) * 100;
            if ($highly_active_pct > 30) {
                $insights[] = array(
                    'type' => 'positive',
                    'title' => __('Strong User Engagement', 'twork-rewards'),
                    'message' => sprintf(__('%.1f%% of users are highly active (10+ sessions). Premium features and targeted ads would perform well.', 'twork-rewards'), $highly_active_pct),
                    'icon' => 'ðŸ’Ž'
                );
            }
        }

        // Peak hours insights
        if (!empty($analytics['peak_hours'])) {
            $peak_hour = $analytics['peak_hours'][0];
            $insights[] = array(
                'type' => 'info',
                'title' => __('Peak Usage Time', 'twork-rewards'),
                'message' => sprintf(__('Peak activity occurs at %d:00 with %d sessions. Schedule push notifications and ads during this time.', 'twork-rewards'), $peak_hour->hour, $peak_hour->session_count),
                'icon' => 'â°'
            );
        }

        // DAU/MAU ratio insights
        if ($analytics['mau'] > 0) {
            $dau_mau_ratio = ($analytics['dau_avg'] / $analytics['mau']) * 100;
            if ($dau_mau_ratio > 20) {
                $insights[] = array(
                    'type' => 'positive',
                    'title' => __('High Daily Engagement', 'twork-rewards'),
                    'message' => sprintf(__('DAU/MAU ratio of %.1f%% indicates strong daily engagement. Users are highly engaged with the platform.', 'twork-rewards'), $dau_mau_ratio),
                    'icon' => 'ðŸ”¥'
                );
            }
        }

        return $insights;
    }

    /**
     * Export analytics data to CSV
     * Professional export for advertising and business intelligence
     */
    public function export_analytics_csv()
    {
        if (!current_user_can('manage_woocommerce') && !current_user_can('manage_options')) {
            wp_die(__('You do not have permission to perform this action.', 'twork-rewards'));
        }

        global $wpdb;
        $usage_table = $this->usage_tracking_table_name();

        $date_from = isset($_GET['date_from']) ? sanitize_text_field($_GET['date_from']) : date('Y-m-d', strtotime('-30 days'));
        $date_to = isset($_GET['date_to']) ? sanitize_text_field($_GET['date_to']) : date('Y-m-d');

        // Get advanced analytics
        $analytics = $this->get_advanced_analytics($date_from, $date_to);
        $activity_stats = $this->get_activity_statistics();

        // Set headers for CSV download
        header('Content-Type: text/csv; charset=utf-8');
        header('Content-Disposition: attachment; filename=twork-analytics-' . date('Y-m-d') . '.csv');
        header('Pragma: no-cache');
        header('Expires: 0');

        $output = fopen('php://output', 'w');

        // Add BOM for UTF-8
        fprintf($output, chr(0xEF) . chr(0xBB) . chr(0xBF));

        // Summary Section
        fputcsv($output, array('T-Work Analytics Export'));
        // Professional: Display generated timestamp in Myanmar timezone
        $generated_timestamp = time();
        $generated_time = $this->format_myanmar_time($generated_timestamp, 'Y-m-d H:i:s');
        fputcsv($output, array('Generated:', $generated_time ?: date('Y-m-d H:i:s', $generated_timestamp)));
        fputcsv($output, array('Period:', $date_from . ' to ' . $date_to));
        fputcsv($output, array(''));

        // Key Metrics
        fputcsv($output, array('KEY PERFORMANCE INDICATORS'));
        fputcsv($output, array('Metric', 'Value'));
        fputcsv($output, array('Total Users', $activity_stats['total_count']));
        fputcsv($output, array('Active Users', $activity_stats['active_count']));
        fputcsv($output, array('Inactive Users', $activity_stats['inactive_count']));
        fputcsv($output, array('Active Rate', $activity_stats['active_rate'] . '%'));
        fputcsv($output, array('Daily Active Users (Avg)', number_format($analytics['dau_avg'], 2)));
        fputcsv($output, array('Monthly Active Users', $analytics['mau']));
        fputcsv($output, array('Retention Rate', $analytics['retention_rate'] . '%'));
        fputcsv($output, array('Churn Rate', $analytics['churn_rate'] . '%'));
        fputcsv($output, array('Growth Rate', $analytics['growth_rate'] . '%'));
        fputcsv($output, array('New Users', $analytics['new_users']));
        fputcsv($output, array('Returning Users', $analytics['returning_users']));
        fputcsv($output, array(''));

        // User Segmentation
        fputcsv($output, array('USER SEGMENTATION'));
        fputcsv($output, array('Segment', 'Count'));
        fputcsv($output, array('Highly Active (10+ sessions)', $analytics['highly_active_users']));
        fputcsv($output, array('Moderately Active (3-9 sessions)', $analytics['moderately_active_users']));
        fputcsv($output, array('Low Activity (<3 sessions)', $analytics['low_active_users']));
        fputcsv($output, array(''));

        // Daily Trends
        if (!empty($analytics['daily_trends'])) {
            fputcsv($output, array('DAILY TRENDS'));
            fputcsv($output, array('Date', 'Daily Active Users', 'Sessions', 'Total Duration (seconds)', 'Avg Session Duration (seconds)'));
            foreach ($analytics['daily_trends'] as $trend) {
                fputcsv($output, array(
                    $trend->date,
                    $trend->daily_active_users,
                    $trend->daily_sessions,
                    $trend->daily_duration,
                    round($trend->avg_session_duration, 2)
                ));
            }
            fputcsv($output, array(''));
        }

        // Peak Hours
        if (!empty($analytics['peak_hours'])) {
            fputcsv($output, array('PEAK HOURS ANALYSIS'));
            fputcsv($output, array('Hour', 'Sessions', 'Unique Users', 'Avg Duration (seconds)'));
            foreach ($analytics['peak_hours'] as $hour) {
                fputcsv($output, array(
                    $hour->hour . ':00',
                    $hour->session_count,
                    $hour->unique_users,
                    round($hour->avg_duration, 2)
                ));
            }
            fputcsv($output, array(''));
        }

        // Days of Week
        if (!empty($analytics['days_of_week'])) {
            fputcsv($output, array('DAYS OF WEEK ANALYSIS'));
            fputcsv($output, array('Day', 'Sessions', 'Unique Users', 'Avg Duration (seconds)'));
            foreach ($analytics['days_of_week'] as $day) {
                fputcsv($output, array(
                    $day->day_name,
                    $day->session_count,
                    $day->unique_users,
                    round($day->avg_duration, 2)
                ));
            }
        }

        fclose($output);
        exit;
    }

    /**
     * Handle manual usage table creation
     */
    public function handle_create_usage_table()
    {
        if (!current_user_can('manage_woocommerce') && !current_user_can('manage_options')) {
            wp_die(__('You do not have permission to perform this action.', 'twork-rewards'));
        }

        check_admin_referer('twork_rewards_create_usage_table');

        $this->create_usage_tracking_table();

        wp_safe_redirect(add_query_arg(array(
            'page' => 'twork-rewards-usage',
            'table_created' => '1',
        ), admin_url('admin.php')));
        exit;
    }
}

TWork_Rewards_System::get_instance();
